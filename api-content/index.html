{"posts":[{"title":"ç®€å•èŠèŠæŒ‡ä»¤é‡æ’","content":"ä»£ç åœ¨ç¼–è¯‘é˜¶æ®µï¼Œç¼–è¯‘å™¨å¯èƒ½ä¼šè¿›è¡Œé‡æ’åºï¼ˆJava åœ¨ç¼–è¯‘æœŸå­—èŠ‚ç æ˜¯æŒ‰ä»£ç é¡ºåºç”Ÿæˆçš„ï¼Œä½† JIT æ‰§è¡Œæ—¶å°±ä¸ä¿è¯é¡ºåºäº†ï¼‰ ä»£ç åœ¨æ‰§è¡Œé˜¶æ®µï¼ŒCPU ä¹Ÿå¯èƒ½ä¼šé‡æ’æŒ‡ä»¤ï¼ˆCPU çš„ä¹±åºæ‰§è¡Œï¼Œå¿½ç•¥ä¸çœ‹ï¼‰ æ¯”å¦‚ä¸‹é¢è¿™æ®µä»£ç  int a = a1; // a1 = 1; double b = b1; // b1 = 0.1; Java çš„ JIT åœ¨æ‰§è¡Œæ—¶ï¼Œå¹¶ä¸ä¼šä¿è¯ï¼šå¯¹ &quot;a&quot; å†…å­˜çš„å†™å…¥ä¸€å®šåœ¨å¯¹ &quot;b1&quot; å†…å­˜çš„è¯»å–ä¹‹å‰å‘ç”Ÿ å¹¶ä¸”ï¼Œå› ä¸º &quot;æ•´å½¢&quot; å’Œ &quot;æµ®ç‚¹å‹&quot; ç”¨çš„è¿ç®—å™¨ä¸åŒï¼Œè¿˜æ˜¯å¯èƒ½è¢«é‡æ’çš„ as-if-serial è§„åˆ™ as-if-seriaæŒ‡ä»¤é‡æ’l çš„æ„æ€æ˜¯ï¼Œç¼–è¯‘å™¨ã€å¤„ç†å™¨ã€JIT ç­‰ä¸ºäº†æé«˜å¹¶è¡Œåº¦ï¼Œæ‰€æœ‰çš„åŠ¨ä½œ(Action)éƒ½å¯ä»¥ä¸ºäº†ä¼˜åŒ–ï¼Œè€Œè¢«é‡æ’åº ä½†æ˜¯ï¼Œä¸ç®¡æ€ä¹ˆé‡æ’åºï¼Œå•ä¸ªçº¿ç¨‹çš„æ‰§è¡Œç»“æœä¸èƒ½è¢«æ”¹å˜ã€‚ ä¸ºäº†éµå®ˆ &quot;as-if-serial&quot; è¯­ä¹‰ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¸ä¼šå¯¹å­˜åœ¨ &quot;æ•°æ®ä¾èµ–å…³ç³»&quot; çš„æ“ä½œåšé‡æ’åº ä¸€ä¸ªç¡¬æ€§è§„å®šï¼Œå¿½ç•¥ Java çš„ happens-before è§„åˆ™ å‡†ç¡®æ¥è¯´æ˜¯ Java å†…å­˜æ¨¡å‹ä¸­çš„è§„åˆ™ï¼ŒJSR-133 ä½¿ç”¨ happens-before çš„æ¦‚å¿µæ¥æŒ‡å®šä¸¤ä¸ªæ“ä½œä¹‹é—´çš„æ‰§è¡Œé¡ºåº å¦‚æœ A happens-before Bï¼Œé‚£ä¹ˆ Java å†…å­˜æ¨¡å‹å°†å‘ç¨‹åºå‘˜ä¿è¯ï¼šA æ“ä½œçš„ç»“æœå°†å¯¹ B å¯è§ï¼Œä¸” A çš„æ‰§è¡Œé¡ºåºæ’åœ¨ B ä¹‹å‰ è‡³äºç½‘ä¸Šç½—åˆ—çš„å‡ æ¡è§„åˆ™ï¼Œéƒ½æ˜¯æ ¹æ® Java å†…å­˜æ¨¡å‹æ€»ç»“å‡ºæ¥çš„ï¼Œä¸ç”¨åˆ»æ„å»è®°ã€‚é‡ç‚¹ç†è§£ volatile å…³é”®å­—çš„ä½œç”¨å³å¯ è¯¦æƒ…å¯ä»¥æŸ¥çœ‹ Doug Lea å†™ç»™ç¼–è¾‘å™¨å¼€å‘è€…çš„æ–‡ç« ï¼šThe JSR-133 Cookbook for Compiler Writers å‚è€ƒèµ„æ–™ Doug Lea çš„ä¸­æ–‡åšå®¢ Doug Lea çš„è‹±æ–‡åšå®¢ å…³äºæŒ‡ä»¤é‡æ’åº - V2EX Javaå†…å­˜è®¿é—®é‡æ’åºçš„ç ”ç©¶ - ç¾å›¢æŠ€æœ¯å›¢é˜Ÿ 4ä¸ªä½ æœªå¿…çŸ¥é“çš„å†…å­˜å°çŸ¥è¯† MESIåè®®&amp;NUMAæ¶æ„ ","link":"https://yibaoshan.github.io/post/concurrency-program-order/"},{"title":"Androidå›¾å½¢ç³»ç»Ÿï¼ˆäº”ï¼‰ç•ªå¤–ç¯‡ï¼šè§¦æ‘¸äº‹ä»¶è¯¦è§£","content":" ç‚¹å‡»è·³è½¬åˆ°æ˜é‡‘é˜…è¯» Android æ˜¯ä¸€ä¸ªæœ‰ç”¨æˆ·ç•Œé¢ï¼ˆGUIï¼‰çš„æ“ä½œç³»ç»Ÿï¼Œåœ¨å®ƒè¯ç”Ÿä¹‹åˆï¼Œå°±æ˜¯ä¸ºå¸¦æœ‰è§¦æ‘¸å±çš„æ‰‹æŒè®¾å¤‡å‡†å¤‡çš„ã€‚ä½œä¸ºæä¾›ç»™ç”¨æˆ·æœ€é‡è¦çš„äº¤äº’æ–¹å¼ä¹‹ä¸€ï¼Œäº†è§£è§¦æ‘¸ç³»ç»Ÿæ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼Œå¯¹äºå®é™…çš„é¡¹ç›®å¼€å‘æœ‰ç€éå¸¸å¤§çš„å¸®åŠ© æœ¬ç¯‡æ˜¯å›¾å½¢ç³»åˆ—çš„ç¬¬äº”ç¯‡æ–‡ç« ï¼Œåœ¨ä¹‹å‰çš„å‡ ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬åˆ†åˆ«äº†è§£äº† Android ç³»ç»Ÿ[æ¸²æŸ“/åˆæˆçš„åº•å±‚åŸç†]å’Œ[è‡ªå®šä¹‰ View / ViewGroup çš„æµç¨‹] ä»Šå¤©æˆ‘ä»¬æ¥èŠèŠå›¾å½¢ç³»ç»Ÿä¸­ï¼Œå¦ä¸€ä¸ªè€ç”Ÿå¸¸è°ˆçš„è¯é¢˜ï¼šäº‹ä»¶åˆ†å‘ å’Œä»¥å¾€ç›¸æ¯”ï¼Œä»Šå¤©çš„æ–‡ç« ä¼šç¨å¾®æœ‰é‚£ä¹ˆä¸€ç‚¹ç‚¹ä¸ä¸€æ · æˆ‘ä»¬ä¼šä»è®¤è¯†ç¡¬ä»¶é©±åŠ¨å¼€å§‹ï¼Œè‡ªåº•å‘ä¸Šï¼Œä¸€æ­¥æ­¥çš„æ¥äº†è§£ï¼Œäº‹ä»¶æ˜¯æ€ä¹ˆåˆ°è¾¾çš„ç³»ç»Ÿå†…æ ¸ï¼Œå†…æ ¸åˆæ˜¯æ€ä¹ˆä¼ é€’åˆ°åº”ç”¨ï¼Œä»¥åŠåº”ç”¨æœ€ç»ˆæ˜¯å¦‚ä½•æ¶ˆè´¹æ‰äº‹ä»¶çš„ åºŸè¯ä¸å¤šè¯´ï¼Œæˆ‘ä»¬ç›´æ¥è¿›å…¥æ­£é¢˜ï¼Œlet's go å‰æ’æé†’ï¼šå…¨æ–‡ 1.5w å­—ï¼Œå»ºè®®é˜…è¯»æ—¶é•¿ 30 åˆ†é’Ÿ ä¸€ã€è§¦æ‘¸äº‹ä»¶çš„èµ·æºï¼ˆLinux Kernelï¼‰ Android è¾“å…¥äº‹ä»¶çš„ç±»å‹ï¼Œå’Œåˆ†å‘çš„æµç¨‹éƒ½æ¯”è¾ƒå¤æ‚ï¼Œé™¤äº†è§¦æ‘¸äº‹ä»¶å¤–ï¼Œç³»ç»Ÿè¿˜æœ‰æ¥è‡ªé¼ æ ‡ã€é”®ç›˜ã€éŸ³é‡é”®ã€ç”µæºé”®ç­‰å…¶ä»– Input è®¾å¤‡çš„äº‹ä»¶éœ€è¦å¤„ç† æˆ‘ä»¬æ—¥å¸¸å¼€å‘æ¥è§¦æ¯”è¾ƒå¤šçš„æ˜¯ â€˜è§¦æ‘¸äº‹ä»¶â€™ï¼Œå› æ­¤ï¼Œæœ¬æ–‡ä¸»è¦è®¨è®ºçš„æ˜¯ â€˜è§¦æ‘¸äº‹ä»¶â€™ çš„åˆ†å‘æµç¨‹ï¼Œå…¶ä»–ç±»å‹çš„è¾“å…¥äº‹ä»¶é¡ºå¸¦ä¼šæä¸€å˜´ï¼Œä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹ æœ¬æ–‡ä¸€å…±åˆ†ä¸ºä¸‰å¤§éƒ¨åˆ†ï¼š ç¬¬ä¸€éƒ¨åˆ†ä»‹ç» â€˜è§¦æ‘¸äº‹ä»¶çš„èµ·æºâ€™ ï¼Œä¸»è¦è®²çš„æ˜¯é©±åŠ¨ä¸ŠæŠ¥åŸå§‹äº‹ä»¶ï¼Œå†…æ ¸è§£æåŸå§‹äº‹ä»¶å¹¶ä¿å­˜åˆ°è®¾å¤‡æ–‡ä»¶ä¸­ï¼Œä»¥ä¾› Framework è¯»å–åˆ†å‘ ç¬¬äºŒéƒ¨åˆ†ä»‹ç» â€˜è§¦æ‘¸äº‹ä»¶çš„ä¼ é€’â€™ ï¼Œä¸»è¦è®²çš„æ˜¯ InputManagerService æ€ä¹ˆæŠŠäº‹ä»¶ä¼ é€’åˆ°åº”ç”¨è¿›ç¨‹ï¼Œå¹¶åˆ†å‘ç»™ç›®æ ‡ Window ç¬¬ä¸‰éƒ¨åˆ†ä»‹ç» â€˜è§¦æ‘¸äº‹ä»¶çš„æ¶ˆè´¹â€™ ï¼Œè¿™æ˜¯æˆ‘ä»¬åº”ç”¨å¼€å‘è€…æœ€ç†Ÿæ‚‰çš„äº‹ä»¶åˆ†å‘/æ‹¦æˆªçš„è¿‡ç¨‹ï¼Œä¸»è¦è®²çš„æ˜¯ ViewGroup / View çš„å‡ ä¸ªå…³é”®æ–¹æ³•ä»¥åŠä½¿ç”¨åœºæ™¯ åœ¨æ–‡ç« çš„å¼€å¤´ï¼Œæˆ‘ä»¬å…ˆæ¥èŠèŠç¬¬ä¸€éƒ¨åˆ†çš„å†…å®¹ï¼Œè§¦æ‘¸äº‹ä»¶çš„èµ·æº ä»ç¡¬ä»¶åˆ°å†…æ ¸ åœ¨ã€Šå½“æˆ‘ä»¬ç‚¹å‡»â€œå¾®ä¿¡â€åº”ç”¨åï¼Œå®ƒæ˜¯æ€ä¹ˆæ˜¾ç¤ºå‡ºæ¥çš„ï¼Ÿã€‹è¿™ç¯‡æ–‡ç« ä¸­ï¼Œä¸ºäº†ææ¸…æ¥š Android è®¾å¤‡çš„ç»˜å›¾ç¡¬ä»¶æ˜¯ä»€ä¹ˆï¼Œæˆ‘ä»¬æ‹†äº†ä¸€å° å°ç±³11 æ‰‹æœº ä»Šå¤©ï¼Œæˆ‘ä»¬ç»§ç»­æ¥æ‹†å°ç±³ å›¾ç‰‡æ¥æºï¼šã€é›†å¾®æ‹†è¯„ã€‘å°ç±³10æ‹†è§£ï¼šå†…éƒ¨å¸ƒå±€ä¸iPhoneç›¸ä¼¼ï¼Œ1äº¿åƒç´ ä¸»æ‘„å¸ç› å¦‚ä¸Šå›¾ï¼Œè¿™æ˜¯æ‹†è§£å å°ç±³10 çš„å†…éƒ¨å¸ƒå±€ï¼Œå›¾ä¸­å·¦è¾¹é»„è‰²ç®­å¤´æ‰€æŒ‡çš„éƒ¨åˆ†ï¼Œæ˜¯è§¦æ‘¸å±çš„è§¦æ§èŠ¯ç‰‡ ç±³10 è§¦æ§èŠ¯ç‰‡ä½¿ç”¨çš„æ˜¯ï¼Œæ¥è‡ªæ„æ³•åŠå¯¼ä½“çš„ &quot;FJABH&quot;ï¼Œè¿™å—èŠ¯ç‰‡æ˜¯ç”¨æ¥å¹²å˜›çš„å‘¢ï¼Ÿ ç”¨æ¥å’Œ CPU è¿›è¡Œé€šä¿¡çš„ å›¾ç‰‡æ˜¯é‡ç»˜ç‰ˆï¼Œå‚è€ƒè‡ªï¼šhttps://blog.csdn.net/qq_39797956/article/details/118863217 æˆ‘ä»¬çŸ¥é“ï¼Œå½“æˆ‘ä»¬æŒ‰ä¸‹è§¦æ‘¸å±åï¼Œå±å¹•çš„ç”µå‹/ç”µæµå¤§å°ä¼šå‘ç”Ÿå˜åŒ–ï¼ˆä¸å±•å¼€è®¨è®ºè§¦æ‘¸å±å·¥ä½œåŸç†ï¼‰ å˜åŒ–çš„ç”µå‹/ç”µæµä¼šè¢«å›¾ä¸­é—´çš„è§¦æ§ IC æ•è·ï¼Œæ¥ç€è®¡ç®—å‡ºè§¦æ‘¸ä½ç½®çš„åæ ‡å€¼ï¼Œé€šè¿‡IÂ²Cæ€»çº¿ï¼ˆå¦‚ä¸Šå›¾ï¼‰å‘é€åˆ°ä¸»æ¿ä¸Šçš„ CPU IÂ²C æ˜¯ç¡¬ä»¶ä¹‹é—´å¸¸ç”¨çš„ä¸€ç§é€šä¿¡åè®®ï¼Œå®ƒè§„å®šäº†ä»€ä¹ˆè¡¨ç¤ºèµ·å§‹ã€åœæ­¢ã€åº”ç­”å’Œéåº”ç­”ç­‰ä¸€ç³»åˆ—ä¿¡å· å½“ç„¶ï¼Œä½œä¸ºåº”ç”¨å¼€å‘ï¼Œæˆ‘ä»¬æ— éœ€å…³å¿ƒä»–ä»¬çš„é€šä¿¡ç»†èŠ‚ æˆ‘ä»¬åªéœ€è¦çŸ¥é“ï¼š &quot;ä¸€æ—¦è§¦æ‘¸å±çš„ä¿¡å·å‘ç”Ÿå˜åŒ–ï¼Œè§¦æ§èŠ¯ç‰‡å°±èƒ½é€šè¿‡ IÂ²C æ€»çº¿é€šçŸ¥åˆ° CPU &quot;ã€‚äº†è§£è¿™ä¸€ç‚¹å°±å¤Ÿäº† å¥½äº†ï¼Œç°åœ¨è§¦æ‘¸ä¿¡å·å·²ç»èƒ½è¢« CPU è¯»å–äº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ CPU ï¼Œä¹Ÿå°±æ˜¯æ“ä½œç³»ç»Ÿå¦‚ä½•å¤„ç†è§¦æ‘¸ä¿¡å· å†…æ ¸åˆ›å»ºè®¾å¤‡æ–‡ä»¶ æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒGoogle ä½¿ç”¨ Linux ä½œä¸º Android ç³»ç»Ÿçš„å†…æ ¸ï¼Œç®¡ç†ç€ä¸»æ¿ä¸Šçš„ å†…å­˜ã€ç½‘å¡ã€ç¡¬ç›˜ ç­‰ç¡¬ä»¶è®¾å¤‡ï¼Œå…¶ä¸­ä¹ŸåŒ…æ‹¬ CPU åœ¨ä¸Šä¸€å°èŠ‚ä¸­ï¼Œè§¦æ‘¸å±å·²ç»å’Œ CPU å»ºç«‹äº†é€šä¿¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ“ä½œç³»ç»Ÿå¯ä»¥è¯»å–è§¦æ‘¸å±å‘é€è¿‡æ¥çš„ä¿¡å·äº† æ¥ä¸‹æ¥çš„å·¥ä½œé‡ç‚¹åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€æ˜¯åˆ¶å®šè§¦æ‘¸å±å…·ä½“çš„ä¸ŠæŠ¥è§„åˆ™ï¼›äºŒæ˜¯æƒ³åŠæ³•æŠŠè®¾å¤‡å‘ç”Ÿçš„äº‹ä»¶æŠ¥å‘Šç»™åº”ç”¨ç¨‹åº å…ˆæ¥çœ‹è®¾å¤‡çš„ä¸ŠæŠ¥è§„åˆ™ï¼Œæˆ‘ä»¬ä»¥é”®ç›˜äº‹ä»¶ä¸¾ä¾‹ï¼ŒåŒæ ·éƒ½æ˜¯æŒ‰ä¸‹ 'A' æŒ‰é”® è¾¾å°”ä¼˜ é”®ç›˜ä¸ŠæŠ¥çš„æ˜¯ï¼š0010 ç½—æŠ€ é”®ç›˜ä¸ŠæŠ¥çš„æ˜¯ï¼š0001 åŒä¸€ä¸ªæŒ‰é”®äº‹ä»¶ï¼Œä¸¤ä¸ªé”®ç›˜å‚å•†ä¸ŠæŠ¥çš„æŒ‰é”®å€¼å´ä¸ç›¸åŒï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸è¡Œçš„ã€‚ æ‰€ä»¥ï¼Œåªæœ‰ä¸Šä¸€å°èŠ‚çš„é€šä¿¡è§„åˆ™ï¼ˆIÂ²Cï¼‰è¿˜ä¸å¤Ÿï¼Œæˆ‘ä»¬è¿˜éœ€è¦åˆ¶å®šä¸€ä¸ªå†…å®¹è§„åˆ™ï¼Œæ¥è§„èŒƒå„ä¸ªå‚å®¶å‘é€çš„æ•°æ®å†…å®¹ è¯´åˆ°è¾“å…¥è§„èŒƒï¼Œè¿™å°±ä¸èƒ½ä¸æ Linux çš„ Input å­ç³»ç»Ÿäº† åœ¨ 2001 å¹´å‘å¸ƒçš„ [2.4.0] ç‰ˆæœ¬ï¼ŒLinux é¦–æ¬¡åŠ å…¥äº† Input å­ç³»ç»Ÿçš„ä»£ç ï¼Œä¸ºçš„å°±æ˜¯å°†è¾“å…¥è®¾å¤‡çš„å…±æ€§æŠ½è±¡å‡ºæ¥ï¼Œåˆ¶å®šç»Ÿä¸€çš„è¾“å…¥è§„åˆ™ é¦–å‘ç‰ˆæœ¬åªæ”¯æŒ æ‰‹æŸ„ã€é¼ æ ‡ å’Œ é”®ç›˜ è¿™ä¸‰ç§ç¡¬ä»¶ï¼Œåœ¨éšå 2002 å¹´å‘å¸ƒçš„ [2.5.25] ç‰ˆæœ¬ä¸­ï¼ŒåŠ å…¥äº†å¯¹ è§¦æ‘¸å± çš„æ”¯æŒ è¿™æ ·ä¸€æ¥ï¼Œå‚å•†åªéœ€è¦æŒ‰ç…§ Linux åˆ¶å®šçš„è§„èŒƒï¼Œæ¥ä¸ŠæŠ¥æŒ‰é”®å€¼ã€å±å¹•åæ ‡ç­‰ä¿¡æ¯å³å¯ï¼Œä¸ŠæŠ¥è§„åˆ™çš„é—®é¢˜å°±è§£å†³äº† é™¤äº†è§„èŒƒè¾“å…¥å†…å®¹ï¼ŒInput å­ç³»ç»Ÿè¿˜ä¸ºåº”ç”¨ç¨‹åºæä¾›äº† æ“ä½œ/è¯»å– è¾“å…¥è®¾å¤‡çš„æ¥å£ï¼Œæ¥çœ‹æ¡†æ¶å›¾ï¼š å›¾ç‰‡æ¥æºï¼šè‡ªå·±ç”»çš„ å¦‚å›¾ï¼ŒInput å­ç³»ç»Ÿåˆ†ä¸ºä¸‰å±‚ï¼š æœ€ä¸‹å±‚ï¼šè¾“å…¥è®¾å¤‡é©±åŠ¨å±‚ï¼Œdrivers/input/xxxï¼Œè¿™é‡Œå°±æ˜¯å„å¤§å‚å•†éœ€è¦éµå¾ªçš„åè®®è§„èŒƒï¼Œå‘å†…æ ¸å±‚æŠ¥å‘Šè¾“å…¥çš„å†…å®¹ ä¸­é—´å±‚ï¼šè¾“å…¥æ ¸å¿ƒå±‚ï¼Œinput.c å±äºè¿™ä¸€å±‚ã€‚è¿™æ˜¯ Linux æ ¸å¿ƒé€»è¾‘ï¼Œç”¨æ¥ç®¡ç†è®¾å¤‡æ·»åŠ ã€å¸è½½ç­‰æ“ä½œï¼Œäº‹ä»¶æä¾›ç»™åº”ç”¨å‰çš„å‡†å¤‡å·¥ä½œ æœ€ä¸Šå±‚ï¼šè¾“å…¥äº‹ä»¶é©±åŠ¨å±‚ï¼Œåˆ°è¿™é‡Œç¡¬ä»¶é©±åŠ¨å·²ç»æŠ½è±¡ä¸ºè®¾å¤‡æ–‡ä»¶äº†ï¼Œå¯¹åº” /dev/input/xxx ï¼Œç¡¬ä»¶é©±åŠ¨å‘é€çš„æ•°æ®å°±ä¿å­˜åœ¨è¯¥è·¯å¾„ä¸‹çš„å„ä¸ªè®¾å¤‡æ–‡ä»¶ä¸­ï¼Œç­‰å¾…åº”ç”¨è¯»å– æœ€ä¸‹é¢çš„ Drivers å±‚ï¼Œæ˜¯ Linux å¹³å°å¯¹å„ç§è¾“å…¥è®¾å¤‡çš„è§„èŒƒï¼Œå„å¤§å‚å•†éƒ½éœ€è¦å»éµå¾ªè¯¥åè®®ï¼Œå¦åˆ™ Linux å†…æ ¸æ— æ³•è¯†åˆ«ï¼Œè®¾å¤‡ä¹Ÿå°±æ— æ³•æ­£å¸¸å·¥ä½œ ç„¶åæ˜¯ä¸­é—´çš„æ ¸å¿ƒå±‚ï¼Œå®ƒæ˜¯è¾“å…¥è®¾å¤‡é©±åŠ¨çš„ç®¡ç†å±‚ï¼Œåœ¨è¾“å…¥æ¡†æ¶ä¸­èµ·ç€æ‰¿ä¸Šå¯ä¸‹çš„ä½œç”¨ï¼šå‘ä¸‹æä¾›é©±åŠ¨å±‚çš„æ¥å£ï¼Œå‘ä¸Šæä¾›äº‹ä»¶å¤„ç†å±‚çš„æ¥å£ æˆ‘ä»¬æ¥çœ‹ä¸€çœ¼ input.c ä¸­çš„å‡ ä¸ªå…³é”®æ–¹æ³•ï¼Œä¹Ÿå°±å¤§æ¦‚çŸ¥é“å®ƒæä¾›äº†å“ªäº›åŠŸèƒ½ /drivers/input/input.c class input { //Linux input æ¡†æ¶çš„æ ¸å¿ƒå±‚ï¼Œä¸ºé©±åŠ¨å±‚æä¾›è®¾å¤‡æ³¨å†Œå’Œæ“ä½œæ¥å£ /* è®¾å¤‡æ³¨å†Œ */ int input_register_device(input_dev *dev); // æ³¨å†Œä¸€ä¸ª input è®¾å¤‡åˆ°å†…æ ¸ void input_unregister_device(input_dev *dev); // ä»å†…æ ¸æ³¨é”€æ‰ä¸€ä¸ª input è®¾å¤‡ /* è®¾å¤‡è¿æ¥ */ int input_attach_handler(input_dev *dev, input_handler *handler); void input_disconnect_device(input_dev *dev); /* äº‹ä»¶ä¸ŠæŠ¥ */ void input_handle_event(input_dev *dev, type, code, value); /* åº”ç”¨ç¨‹åºæ•°æ®è¯»å– */ int input_event_to_user(input_dev *dev, type, code, value); } ä»ä»£ç æ¥çœ‹ï¼Œæ ¸å¿ƒå±‚è´Ÿè´£ è®¾å¤‡çš„æ³¨å†Œã€è®¾å¤‡çš„è¿æ¥ã€äº‹ä»¶ä¸ŠæŠ¥ å’Œ æ•°æ®è¯»å– è¿™å‡ ä»¶äº‹ï¼Œå…·ä½“çš„å®ç°é€»è¾‘æˆ‘ä»¬è¿™é‡Œä¸å±•å¼€è®¨è®ºï¼Œå¤ªé•¿äº†ã€‚ åœ¨ Input å­ç³»ç»Ÿçš„æœ€ä¸Šå±‚ï¼ˆHandlersï¼‰ï¼Œäº‹ä»¶é©±åŠ¨å±‚è´Ÿè´£çš„æ˜¯ï¼Œä¸ºç”¨æˆ·è®¿é—®æä¾›æ¥å£ï¼Œå°†ç¡¬ä»¶é©±åŠ¨å±‚å‘é€çš„æ¶ˆæ¯æŠ¥å‘Šç»™ç”¨æˆ· æˆ‘ä»¬å¯ä»¥åœ¨ /dev/input/xxx æ‰¾åˆ°æ‰€æœ‰å·²åŠ è½½æˆåŠŸçš„è¾“å…¥è®¾å¤‡ï¼Œå®ƒä»¬å°±æ˜¯äº‹ä»¶é©±åŠ¨å±‚åˆ›å»ºçš„è®¾å¤‡æ–‡ä»¶ å›¾ç‰‡æ¥æºï¼šè‡ªå·±æˆªçš„ å¦‚å›¾æ‰€ç¤ºï¼Œæˆ‘æ‰‹é‡Œçš„ Pixel 3 åœ¨ /dev/input/ è¿™ä¸ªè·¯å¾„ä¸‹ï¼Œå‘ç°äº†4ä¸ªè¾“å…¥è®¾å¤‡ï¼Œä» event0 åˆ° event3 æˆ‘ä»¬å¯ä»¥ç”¨ ' cat /proc/bus/input/devices ' å‘½ä»¤ï¼ŒæŸ¥çœ‹æ¯ä¸ªè¾“å…¥è®¾å¤‡çš„ä¿¡æ¯ï¼Œæˆ‘è¿™å°æ‰‹æœº event2 èŠ‚ç‚¹æ˜¯è§¦æ‘¸å±çš„è®¾å¤‡æ–‡ä»¶ï¼ˆ' name = fts ' è¡¨ç¤ºçš„è§¦æ§é©±åŠ¨å‚å•†æ˜¯ 'æ•¦æ³°'ï¼‰ æ¥ç€ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ç”¨ 'getevent' å‘½ä»¤æ‰“å¼€è¿™ä¸ªè®¾å¤‡æ–‡ä»¶ï¼Œè·å–å®ƒå‘é€çš„åŸå§‹æ•°æ® å›¾ç‰‡æ¥æºï¼šè‡ªå·±å½•çš„ ä½ çœ‹ï¼Œå½“æˆ‘ä»¬æ»‘åŠ¨å±å¹•æ—¶ï¼Œç»ˆç«¯çª—å£ä¼šä¸åœçš„æ‰“å°æ¥è‡ª event2 çš„è§¦æ‘¸äº‹ä»¶æ¶ˆæ¯ å¥½ï¼Œç°åœ¨è§¦æ‘¸äº‹ä»¶å·²ç»èƒ½è¢«åº”ç”¨ç¨‹åºè¯»å–äº†ï¼Œæˆ‘ä»¬æ¥ç®€å•æ€»ç»“ä¸‹ç¬¬ä¸€éƒ¨åˆ† â€˜è§¦æ‘¸äº‹ä»¶çš„èµ·æºâ€™ çš„å†…å®¹ï¼š é¦–å…ˆï¼ŒæŒ‰ä¸‹è§¦æ‘¸å±åï¼Œè§¦æ§èŠ¯ç‰‡æ•è·åˆ°ç”µå‹/ç”µæµçš„å˜åŒ–ï¼Œè®¡ç®—å‡ºä½ç½®åæ ‡åï¼Œé€šè¿‡ IÂ²C æ€»çº¿æ±‡æŠ¥ç»™ CPU æ¥ç€ï¼Œæˆ‘ä»¬éœ€è¦ç»Ÿä¸€é€šä¿¡å†…å®¹çš„è§„åˆ™ï¼Œåœ¨ Linux å¹³å°ä¸‹ï¼Œè§¦æ§èŠ¯ç‰‡éœ€è¦å®ç° input.c åè®®ï¼Œäº‹ä»¶æŒ‰ç…§è§„å®šçš„åè®®ä¸ŠæŠ¥ç»™å†…æ ¸ç³»ç»Ÿ æœ€åï¼Œç­‰åˆ°è®¾å¤‡å¼€æœºï¼Œå†…æ ¸åŠ è½½è§¦æ‘¸å±é©±åŠ¨ï¼Œå†ç„¶åæ˜¯è®¾å¤‡çš„æ³¨å†Œ/è¿æ¥/ä¸ŠæŠ¥çš„è¿‡ç¨‹ åˆ°è¿™é‡Œï¼Œå†…æ ¸å·²ç»ä¸ºæˆ‘ä»¬æ”¶é›†å¥½è§¦æ‘¸å±çš„è¾“å…¥äº‹ä»¶ï¼Œå¹¶å­˜æ”¾åœ¨äº† eventX è®¾å¤‡æ–‡ä»¶ä¸­ï¼ŒLinux Input å­ç³»ç»Ÿçš„ä»»åŠ¡å·²ç»å®Œæˆ æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ Android ç³»ç»Ÿçš„æ¡†æ¶å±‚ï¼ˆFrameworkï¼‰æ˜¯å¦‚ä½•å¤„ç†è§¦æ‘¸äº‹ä»¶çš„ äºŒã€è§¦æ‘¸äº‹ä»¶çš„ä¼ é€’ï¼ˆAndroid Frameworkï¼‰ ä¸Šå›ä¹¦è¯´åˆ°ï¼Œè§¦æ‘¸å±ä¸ŠæŠ¥çš„äº‹ä»¶å·²ç»ä¿å­˜åˆ° /dev/input/xxx è®¾å¤‡æ–‡ä»¶ä¸­ï¼Œé‚£ä¹ˆç³»ç»Ÿæ¥ä¸‹æ¥çš„ä»»åŠ¡æ˜¯ï¼š è¯»å–è§¦æ‘¸äº‹ä»¶ï¼Œå¹¶å°è£…æˆ MotionEvent / KeyEvent å¯¹è±¡ï¼Œæœ€ååˆ†å‘ç»™æ­£åœ¨è¿è¡Œçš„ APP ä½¿ç”¨ â€è¯»å–â€œ å’Œ â€œåˆ†å‘â€ ï¼Œæ˜¯ Android Framework çš„ä¸»çº¿ä»»åŠ¡ åœ¨æ¥ä¸‹æ¥çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ä¸»è¦å›´ç»•ç€è¿™ä¸¤ä»¶äº‹å±•å¼€ psï¼šæœ¬ç« èŠ‚çš„ 'äº‹ä»¶åˆ†å‘' æ¢è®¨çš„æ˜¯ï¼Œå¦‚ä½•å°†è§¦æ‘¸äº‹ä»¶ä»è®¾å¤‡æ–‡ä»¶ä¼ é€’åˆ° APP è¿›ç¨‹ï¼Œå’Œ View çš„äº‹ä»¶åˆ†å‘ä¸æ˜¯ä¸€å›äº‹å„¿ï¼Œæ³¨æ„åˆ«ææ··äº† åˆè¯† InputManagerService æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œåœ¨ Framework ä¸­ï¼Œè¾“å…¥äº‹ä»¶æ˜¯ç”± InputManagerServiceï¼ˆåç»­ç®€ç§°IMSï¼‰ æ¥ç®¡ç† æˆ‘ä»¬åˆçŸ¥é“ï¼ŒInputManagerService æ˜¯ Java å±‚ä»£ç ï¼Œä¸å¯èƒ½ç›´æ¥è°ƒç”¨åˆ° Linux å†…æ ¸å±‚çš„ Input æ¡†æ¶æ¥è·å–è¾“å…¥äº‹ä»¶ å› æ­¤ï¼ŒIMS å¿…ç„¶éœ€è¦ native å±‚çš„æ”¯æŒï¼Œæ‰èƒ½å®ç°å¯¹äº‹ä»¶çš„è¯»å–ä¸åˆ†å‘ å®é™…çš„ InputManagerService å®ç°ä¸€å…±åˆ†ä¸ºä¸‰å±‚ native å±‚ï¼Œè¿™æ˜¯ IMS çš„æ ¸å¿ƒå±‚ï¼Œè´Ÿè´£ è¯»å–/åˆ†å‘ äº‹ä»¶ï¼ŒEventHub.cppã€InputReader.cppã€InputDispatcher.cpp ä¸‰å‘˜å¤§å°†éƒ½åœ¨è¿™ jni å±‚ï¼Œä¸»è¦æ˜¯å¯¹ natvie åšè½¬å‘ï¼Œå¦å¤–è´Ÿè´£åˆ›å»ºå¯¹è±¡å•¥çš„ï¼Œä¸æ€ä¹ˆéœ€è¦å…³æ³¨ Java å±‚ï¼Œä¸»è¦è´Ÿè´£é€šä¿¡éƒ¨åˆ†ï¼Œå’Œ WMS åŒæ­¥çª—å£æ•°æ®å•¦ï¼Œå’Œ APP è·¨è¿›ç¨‹é€šä¿¡å•¦ç­‰ç­‰ åœ¨è¿™å…¶ä¸­ï¼Œåªæœ‰ native å±‚ç¨å¾®æœ‰é‚£ä¹ˆä¸€ç‚¹ç‚¹å¤æ‚ï¼Œå› ä¸ºæ•°æ®çš„è¯»å–å’Œåˆ†å‘éƒ½å‘ç”Ÿåœ¨ native å±‚ å¥½ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥è®¤è¯† native å±‚çš„ä¸»åŠ›äººå‘˜ æ³¨æ„ï¼Œæˆ‘ä»¬æœ¬å°èŠ‚åªå…³æ³¨ native ä¸­å„ä¸ªè§’è‰²æœ‰å“ªäº›æ–¹æ³•åŠŸèƒ½ï¼Œåšäº†å“ªäº›äº‹æƒ… è‡³äºå¯¹è±¡ä»€ä¹ˆæ—¶å€™åˆ›å»ºï¼Œè¿è¡Œåœ¨å“ªä¸ªè¿›ç¨‹ï¼Œå“ªä¸ªçº¿ç¨‹ï¼Œè¿™ä¸ªåé¢ä¼šè®²åˆ°ï¼Œä¸æ˜¯æœ¬å°èŠ‚å…³æ³¨çš„é‡ç‚¹ 1ã€EventHub EventHub çš„ä½œç”¨æ˜¯ç›‘å¬ã€è¯»å– /dev/input ç›®å½•ä¸‹äº§ç”Ÿçš„æ–°äº‹ä»¶ï¼Œå¹¶å°è£…æˆ RawEvent ç»“æ„ä½“ä¾›å…¶ä»–äººä½¿ç”¨ æ–‡ä»¶åœ¨ frameworks/native/services/inputflinger/EventHub.cpp æˆ‘ä»¬æ¥çœ‹ EventHub ä¸­çš„å…³é”®æ–¹æ³• //frameworks/native/services/inputflinger/EventHub.cpp class EventHub { EventHub::EventHub(void) { mEpollFd = epoll_create(EPOLL_SIZE_HINT); // åˆ›å»º epollï¼Œç”¨äºç›‘å¬è®¾å¤‡æ–‡ä»¶æ˜¯å¦æœ‰å¯è¯»äº‹ä»¶ mINotifyFd = inotify_init(); // åˆ›å»º inotify ï¼Œç”¨äºç›‘å¬æ–‡ä»¶ç³»ç»Ÿæ˜¯å¦å˜åŒ–ï¼Œæœ‰å˜åŒ–è¯´æ˜å‘ç”Ÿè®¾å¤‡æ’æ‹” } size_t EventHub::getEvents( timeoutMillis, buffer, bufferSize) { //getEvents() æ˜¯ IMS çš„æ ¸å¿ƒï¼Œè¯¥æ–¹æ³•ä¸€å…±åšäº†ä¸¤ä»¶äº‹ // 1. ç›‘å¬è®¾å¤‡æ’æ‹”åŠ¨ä½œï¼Œæ‰§è¡Œå¯¹åº”çš„è®¾å¤‡çš„æ‰“å¼€/å¸è½½æ“ä½œï¼Œå¹¶ç”Ÿæˆ RawEvent ç»“æ„é€šçŸ¥è°ƒç”¨è€… // 2. ç›‘å¬è¾“å…¥è®¾å¤‡æ–‡ä»¶çš„äº‹ä»¶å˜åŒ– //å¦‚æœæ²¡æœ‰ä»»ä½•äº‹ä»¶å‘ç”Ÿï¼Œè°ƒç”¨ epoll_wait() å‡½æ•°æ‰§è¡Œç­‰å¾… return event - buffer; // è¿”å›è¯»å–åˆ°çš„äº‹ä»¶æ•°é‡ } } EventHub åœ¨åˆå§‹åŒ–æ—¶ï¼Œä¼šåˆ›å»º mEpollFd å’Œ mINotifyFd ä¸¤ä¸ª Fdï¼Œåˆ©ç”¨ INotify æœºåˆ¶ç›‘å¬è®¾å¤‡å¢åˆ äº‹ä»¶ï¼Œåˆ©ç”¨ Epoll ç›‘å¬è®¾å¤‡æ–‡ä»¶è¯»å†™çŠ¶æ€å˜åŒ– ç„¶åæ˜¯ getEvents() æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ç”¨æ¥è·å–å½“å‰çš„è®¾å¤‡äº‹ä»¶ï¼ŒåŒ…æ‹¬è®¾å¤‡æ•°é‡å˜åŒ–ï¼Œå’Œè®¾å¤‡ä¸ŠæŠ¥çš„äº‹ä»¶ï¼Œæ˜¯ IMS è·å–æ¶ˆæ¯çš„ â€œæ ¸å¿ƒæ–¹æ³•â€ å¦‚æœæ²¡æœ‰ä»»ä½•äº‹ä»¶å‘ç”Ÿï¼ŒgetEvents() ä¼šå‘ç”Ÿé˜»å¡ï¼Œç›´åˆ°æœ‰äº‹ä»¶å‘ç”Ÿæ‰è¿”å› EventHub æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹å›¾ å›¾ç‰‡æ¥æºï¼šè‡ªå·±ç”»çš„ 2ã€InputReader ä»ç±»çš„å‘½åå°±èƒ½çœ‹å‡ºæ¥ï¼ŒInputReader çš„èŒè´£æ˜¯è¯»å–è¾“å…¥æ¶ˆæ¯ ä¸è¿‡ï¼Œå®ƒå¯ä¸æ˜¯åªä¼šè¯»å–äº‹ä»¶ï¼Œæ‹¿åˆ°åŸå§‹äº‹ä»¶ä»¥åï¼Œè¿˜éœ€è¦è§£æäº‹ä»¶ï¼Œæ‹†è§£ä¸ºæŒ‰é”®ã€è§¦æ‘¸å±ã€é¼ æ ‡ç­‰ï¼Œæ ¹æ®ä¸åŒçš„è¾“å…¥ï¼Œå°è£…æˆä¸åŒçš„å¯¹è±¡ï¼Œæäº¤åˆ°æ¶ˆæ¯é˜Ÿåˆ—ç­‰å¾…åˆ†å‘ æ‰€ä»¥ï¼ŒåŸå§‹äº‹ä»¶çš„è§£æã€è½¬æ¢ï¼Œæœ€åç”Ÿæˆ KeyEventã€MotionEvent å¯¹è±¡ï¼Œæ‰æ˜¯ InputReader çš„ä¸»è¦å·¥ä½œ /frameworks/native/services/inputflinger/InputReader.cpp class InputReader { class InputReaderThread : Thread { //å†…éƒ¨ç±» /*InputReaderThread çº¿ç¨‹å¯åŠ¨åï¼Œå¾ªç¯å°†ä¸æ–­åœ°æ‰§è¡Œ InputReader#loopOnce()å‡½æ•°*/ bool InputReaderThread::threadLoop() { mReader-&gt;loopOnce(); return true; } } void InputReader::loopOnce(); // æ ¸å¿ƒæ–¹æ³•ï¼Œè´Ÿè´£è¯»å–äº‹ä»¶ï¼Œè§£æäº‹ä»¶ } InputReader ç±»çš„æ ¸å¿ƒæ–¹æ³•æ˜¯ InputReader#loopOnce() ï¼Œå®ƒè´Ÿè´£è¯»å–äº‹ä»¶å’Œè§£æäº‹ä»¶ loopOnce() æ–¹æ³•è¢« InputReaderThread çº¿ç¨‹çš„ threadLoop() æ‰€è°ƒç”¨ï¼ŒInputReaderThread æ˜¯ InputReader çš„å†…éƒ¨çº¿ç¨‹ç±» å’Œ Java ä¸åŒï¼Œåœ¨ C++ ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦å°† threadLoop() è¿”å›å€¼è®¾ç½®ä¸º trueï¼Œå½“ InputReaderThread çº¿ç¨‹å¯åŠ¨åï¼Œ è¯¥æ–¹æ³•å°±ä¼šè¢«å¾ªç¯è°ƒç”¨ï¼Œä¸ç”¨æ‰‹åŠ¨å†™ while(true) InputReaderThread çº¿ç¨‹å¯åŠ¨æ—¶æœºæˆ‘ä»¬åé¢ä¼šè®²åˆ°ï¼Œå…ˆå›è¿‡å¤´æ¥çœ‹ InputReader#loopOnce() çš„å·¥ä½œ /frameworks/native/services/inputflinger/InputReader.cpp class InputReader { // è¯»å–äº‹ä»¶ï¼Œè§£æäº‹ä»¶ void InputReader::loopOnce() { int count = mEventHub-&gt;getEvents(); // è¯»æ¶ˆæ¯ï¼Œæœ‰æ¶ˆæ¯è¿”å›ï¼Œæ²¡æ¶ˆæ¯é˜»å¡åˆ° epoll()ã€‚ç”±äºäº‹ä»¶åˆ†å‘éœ€è¦æ—¶é—´ï¼Œæ‰€ä»¥å•æ¬¡è¯»å–çš„äº‹ä»¶å¯èƒ½æ˜¯å¤šä¸ª if(count) processEventsLocked();//è§£æåŸå§‹äº‹ä»¶ã€æäº¤åˆ°é˜Ÿåˆ—ç­‰å¾…åˆ†å‘ } } å…³é”®ä»£ç åªæœ‰ä¸¤è¡Œ ç¬¬ä¸€è¡Œæ˜¯è°ƒç”¨äº† EventHub#getEvents() è·å–äº‹ä»¶ï¼Œæˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚å·²ç»ä»‹ç»è¿‡è¿™ä¸ªæ–¹æ³•äº†ï¼Œæœ‰æ¶ˆæ¯è¿”å›ï¼Œæ²¡æ¶ˆæ¯é˜»å¡åˆ° epoll() å¹¶ä¸”ï¼Œå› ä¸ºæ‰§è¡Œäº‹ä»¶åˆ†å‘éœ€è¦æ—¶é—´ï¼Œåœ¨ä¸Šä¸€æ¬¡åˆ†å‘è¿˜æ²¡æœ‰æ‰§è¡Œç»“æŸä¹‹å‰ï¼Œå¦‚æœå¤šä¸ªè®¾å¤‡éƒ½å‘ç”Ÿäº†äº‹ä»¶ï¼Œæˆ–è€…ä¸€ä¸ªè®¾å¤‡å‘é€äº†å¤šæ¬¡äº‹ä»¶ï¼Œéƒ½ä¼šé€ æˆæ•°æ®çš„ç§¯å‹ï¼ŒgetEvents() è¿”å›çš„äº‹ä»¶æ•°é‡å¯èƒ½æ˜¯å¤šæ¡ ç¬¬äºŒè¡Œä»£ç  processEventsLocked() æ˜¯è·å–åˆ°äº‹ä»¶ä»¥åï¼Œå¯¹åŸå§‹äº‹ä»¶è¿›è¡Œè§£æï¼Œç„¶åæäº¤åˆ°é˜Ÿåˆ—ç­‰å¾…åˆ†å‘ /frameworks/native/services/inputflinger/InputReader.cpp class InputReader { void InputReader::processEventsLocked(rawEvents, count) { // éå†æ‰€æœ‰äº‹ä»¶ï¼Œè§£æã€åˆ†å‘ for (const RawEvent* rawEvent = rawEvents; count;) { int32_t type = rawEvent-&gt;type; // è·å–äº‹ä»¶ç±»å‹ switch (type){ // æºç ä¸åŒ…å«æ­¤ switch é€»è¾‘ï¼Œè¿™æ˜¯ InputDevice ä¸­çš„å†…å®¹ï¼Œä¸ºäº†æ–¹ä¾¿ç†è§£æˆ‘æ‰æ¬äº†è¿‡æ¥ case EV_KEY; // æŒ‰é”®ç±»å‹çš„äº‹ä»¶ã€‚èƒ½å¤Ÿä¸ŠæŠ¥è¿™ç±»äº‹ä»¶çš„è®¾å¤‡æœ‰é”®ç›˜ã€é¼ æ ‡ã€æ‰‹æŸ„ã€æ‰‹å†™æ¿ç­‰ä¸€åˆ‡æ‹¥æœ‰æŒ‰é’®çš„è®¾å¤‡ï¼ˆåŒ…æ‹¬æ‰‹æœºä¸Šçš„å®ä½“æŒ‰é”®ï¼‰ case EV_ABS; // ç»å¯¹åæ ‡ç±»å‹çš„äº‹ä»¶ã€‚è¿™ç±»äº‹ä»¶æè¿°äº†åœ¨ç©ºé—´ä¸­çš„ä¸€ä¸ªç‚¹ï¼Œè§¦æ§æ¿ã€è§¦æ‘¸å±ç­‰ä½¿ç”¨ç»å¯¹åæ ‡çš„è¾“å…¥è®¾å¤‡å¯ä»¥ä¸ŠæŠ¥è¿™ç±»äº‹ä»¶ case EV_REL; // ç›¸å¯¹åæ ‡ç±»å‹çš„äº‹ä»¶ã€‚è¿™ç±»äº‹ä»¶æè¿°äº†äº‹ä»¶åœ¨ç©ºé—´ä¸­ç›¸å¯¹äºä¸Šæ¬¡äº‹ä»¶çš„åç§»é‡ã€‚é¼ æ ‡ã€è½¨è¿¹çƒç­‰åŸºäºæ¸¸æ ‡æŒ‡é’ˆçš„è®¾å¤‡å¯ä»¥ä¸ŠæŠ¥æ­¤ç±»äº‹ä»¶ case EV_SW; // å¼€å…³ç±»å‹çš„äº‹ä»¶ã€‚è¿™ç±»äº‹ä»¶æè¿°äº†è‹¥å¹²å›ºå®šçŠ¶æ€ä¹‹é—´çš„åˆ‡æ¢ã€‚æ‰‹æœºä¸Šçš„é™éŸ³æ¨¡å¼å¼€å…³æŒ‰é’®ã€æ¨¡å¼åˆ‡æ¢æ‹¨ç›˜ç­‰è®¾å¤‡å¯ä»¥ä¸ŠæŠ¥æ­¤ç±»äº‹ä»¶ ... } // æˆ‘ä»¬åªä¸“æ³¨ touch è§¦æ‘¸äº‹ä»¶ dispatchTouches(when, policyFlags); } } void dispatchTouches(){ // åˆ¤æ–­æ˜¯å¦åªæ˜¯å•æŒ‡äº‹ä»¶ï¼Œæˆ–æ˜¯å¤šæŒ‡è§¦æ‘¸ç­‰ç­‰ç­‰ // è§£æå®Œæˆåï¼Œè°ƒç”¨ dispatchMotion() åˆ†å‘ dispatchMotion(); } void dispatchMotion(){ // æœ€ç»ˆç”Ÿæˆ NotifyMotionArgs ç»“æ„ï¼Œäº¤ç»™ InputDispatcher æ‰§è¡Œæœ€åçš„åˆ†å‘ NotifyMotionArgs args; InputDispatcher::notifyMotion(args);//æäº¤åˆ° InputDispatcher } } psï¼šä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œæˆ‘æŠŠå…¶ä»–åˆ†æ”¯æ•´åˆåˆ°ä¸»æ–¹æ³•æ¥ï¼Œä¸­é—´è¿˜çœç•¥äº†è®¸å¤šä»£ç ã€‚æ‰€ä»¥å»ºè®®ä¸è¦å¯¹ç…§æºç çœ‹è¿™ç¯‡æ–‡ç« ï¼Œä¸ç„¶ä½ å¯èƒ½ä¼šå› ä¸ºæ‰¾ä¸åˆ°æŸä¸ªæ–¹æ³•å›æ¥éª‚æˆ‘çš„~ è§£æäº‹ä»¶çš„ä¸šåŠ¡é€»è¾‘å‡ ä¹éƒ½æ”¾åœ¨äº† processEventsLocked() æ–¹æ³• åœ¨ processEventsLocked() æ–¹æ³•ä¸­ï¼Œé¦–å…ˆéå†äº‹ä»¶é›†åˆï¼Œæ ¹æ®ä¸åŒçš„äº‹ä»¶ç±»å‹ï¼Œè°ƒç”¨ä¸åŒçš„è§£ææ–¹æ³• æˆ‘ä»¬åªä¸“æ³¨ touch è§¦æ‘¸äº‹ä»¶ï¼Œä¹Ÿå°±æ˜¯ dispatchTouches() åœ¨ dispatchTouches() æ–¹æ³•ä¸­ï¼Œæ ¹æ®è§¦æ‘¸ç‚¹ä¿¡æ¯æ¥å†³å®šï¼Œæ˜¯å•æŒ‡è¿˜æ˜¯å¤šæŒ‡äº‹ä»¶ è§£æå®Œæˆåï¼Œè°ƒç”¨ dispatchMotion() ç”Ÿæˆ NotifyMotionArgs å¯¹è±¡ï¼Œé€šçŸ¥ InputDispatcher#notifyMotion() æ–¹æ³• å½“ InputDispatcher#notifyMotion() æ–¹æ³•è¢«è°ƒç”¨ï¼Œä¹Ÿå°±ä»£è¡¨ç€ï¼Œä¸€æ¬¡è¯»å–äº‹ä»¶ï¼Œè§£æäº‹ä»¶çš„è¿‡ç¨‹å°±ç»“æŸäº† æ¥ä¸‹æ¥å°±çœ‹äº‹ä»¶æ˜¯æ€ä¹ˆåˆ†å‘çš„äº†ï¼ŒInputReader æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹å›¾ å›¾ç‰‡æ¥æºï¼šè‡ªå·±ç”»çš„ 3ã€InputDispatcher æ¥ä¸‹æ¥çš„ InputDispatcher åº”è¯¥ä¸ç”¨å†ä»‹ç»äº†ï¼Œå°±æ˜¯ç”¨æ¥åˆ†å‘è¾“å…¥äº‹ä»¶çš„ ä¸Šä¸€å°èŠ‚ç»“æŸæ—¶æ”¾çš„å›¾ç‰‡ï¼Œå·¦è¾¹çš„ InputReader å‘ä¸­é—´çš„ EventQueue é˜Ÿåˆ—æäº¤äº†äº‹ä»¶æ¶ˆæ¯ï¼Œæˆ‘å…ˆæ¥è§£é‡Šä¸€ä¸‹è¿™æ˜¯ä»€ä¹ˆæ—¶å€™å‘ç”Ÿçš„ /frameworks/native/services/inputflinger/InputDispatcher.cpp class InputDispatcher { void notifyMotion(const NotifyMotionArgs* args) { MotionEntry* newEntry = new MotionEntry(args);//å°è£…æˆentry enqueueInboundEventLocked(newEntry);//å…¥åˆ—ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç­‰å¾…åˆ†å‘è¢«æ‰§è¡Œï¼Œé€»è¾‘åœ¨ dispatchOnce() } } å‘ï¼Œçœ‹ä»£ç  ä¸Šä¸€å°èŠ‚æœ€åä¸€è¡Œè°ƒç”¨çš„ InputDispatcher#notifyMotion() æ–¹æ³•ï¼Œä½œç”¨å°±æ˜¯æŠŠäº‹ä»¶æ¶ˆæ¯æäº¤åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç­‰å¾…åˆ†å‘ å¥½ï¼Œå°¾æ”¶å®Œäº†æˆ‘ä»¬ç»§ç»­æ¥çœ‹ InputDispatcher ç±» åˆ°äº† InputDispatcher è¿™é‡Œï¼ŒåŸå§‹çš„è¾“å…¥äº‹ä»¶å·²ç»è¢«å°è£…æˆ Key ã€Motion ç­‰å¯¹è±¡ï¼ŒInputDispatcher çš„ä»»åŠ¡æ˜¯ï¼šæ‰¾åˆ°åˆé€‚çš„ Windowï¼Œå¹¶æŠŠæ•°æ®ä¼ é€’è¿‡å» /frameworks/native/services/inputflinger/InputDispatcher.cpp class InputDispatcher { class InputDispatcherThread : Thread { bool InputDispatcherThread::threadLoop() { mDispatcher-&gt;dispatchOnce(); return true; } } void dispatchOnce() { if(!queue.isEmpty()) dispatchOnceInnerLocked();//æœ‰æ¶ˆæ¯å°±æ‰§è¡Œåˆ†å‘ } } é¦–å…ˆæ¥çœ‹ InputDispatcher çš„ dispatchOnce() ä¸»æ–¹æ³•ï¼Œå’Œ InputReader è®¾è®¡æ€è·¯ç›¸åŒï¼ŒInputDispatcher ä¹Ÿæ˜¯å†…éƒ¨æœ‰ä¸ªçº¿ç¨‹ç±»ï¼Œç„¶åå¾ªç¯è°ƒç”¨ dispatchOnce() æ‰§è¡Œåˆ†å‘ å¦‚æœæ¶ˆæ¯é˜Ÿåˆ—ä¸­æœ‰æ¶ˆæ¯ï¼Œè°ƒç”¨ dispatchOnceInnerLocked() æ‰§è¡Œåˆ†å‘ /frameworks/native/services/inputflinger/InputDispatcher.cpp class InputDispatcher { void dispatchOnceInnerLocked() { mPendingEvent = queue.dequeue(); // ä»æ´¾å‘é˜Ÿåˆ—å–å‡ºä¸€ä¸ªäº‹ä»¶ï¼Œç®€ç•¥å†™æ³• switch (mPendingEvent-&gt;type) { // åˆ¤æ–­æ¶ˆæ¯çš„ç±»å‹ï¼šé…ç½®æ›´æ”¹ã€æ’æ‹”æ¶ˆæ¯ã€keyäº‹ä»¶ã€è§¦æ‘¸äº‹ä»¶ç­‰ç­‰ case EventEntry::TYPE_MOTION: dispatchMotionLocked(); // æˆ‘ä»¬åªä¸“æ³¨ è§¦æ‘¸äº‹ä»¶ } } void dispatchMotionLocked() { int32_t injectionResult = findTouchedWindowTargetsLocked(); // ä¸º Motion äº‹ä»¶å¯»æ‰¾åˆé€‚çš„ç›®æ ‡çª—å£ if (injectionResult) dispatchEventLocked(); // å¦‚æœæˆåŠŸåœ°æ‰¾åˆ°äº†å¯ä»¥æ¥æ”¶äº‹ä»¶çš„ç›®æ ‡çª—å£ï¼Œåˆ™é€šè¿‡dispatchEventLocked()å‡½æ•°å®Œæˆå®é™…çš„æ´¾å‘å·¥ä½œ } } è´Ÿè´£åˆ†å‘çš„ dispatchOnceInnerLocked() æ–¹æ³•éœ€è¦å¤„ç†ä¸åŒè¾“å…¥ç±»å‹çš„äº‹ä»¶ï¼Œæˆ‘ä»¬è¿™é‡Œè¿˜æ˜¯åªå…³æ³¨è§¦æ‘¸æ¶ˆæ¯ å¦‚æœæ˜¯è§¦æ‘¸äº‹ä»¶ï¼Œé‚£ä¹ˆè§¦æ‘¸æ¶ˆæ¯çš„åˆ†å‘æ˜¯ç”± dispatchMotionLocked() æ–¹æ³•æ¥å®Œæˆçš„ dispatchMotionLocked() è§¦æ‘¸æ¶ˆæ¯çš„åˆ†å‘ï¼Œåˆ†ä¸ºä¸¤æ­¥æ‰§è¡Œï¼š ç¬¬ä¸€æ­¥ï¼Œä¸º Motion äº‹ä»¶å¯»æ‰¾åˆé€‚çš„ç›®æ ‡çª—å£ï¼Œè¿™ä¸ªä»»åŠ¡äº¤ç»™ findTouchedWindowTargetsLocked() å‡½æ•°å»å®Œæˆ ç¬¬äºŒæ­¥ï¼Œå¦‚æœæˆåŠŸåœ°æ‰¾åˆ°äº†å¯ä»¥æ¥æ”¶äº‹ä»¶çš„ç›®æ ‡çª—å£ï¼Œäº¤ç»™ dispatchEventLocked() å‡½æ•°å®Œæˆå®é™…çš„æ´¾å‘å·¥ä½œ æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ï¼ŒfindTouchedWindowTargetsLocked() å’Œ dispatchEventLocked() è¿™ä¸¤ä¸ªæ–¹æ³•çš„å®ç° /frameworks/native/services/inputflinger/InputDispatcher.cpp class InputDispatcher { int findTouchedWindowTargetsLocked(){ size_t numWindows = mWindowHandles.size(); // è·å–çª—å£é›†åˆ for (size_t i = 0; i &lt; numWindows; i++);//ä»å‰å‘åéå†æ‰€æœ‰çš„windowä»¥æ‰¾å‡ºè§¦æ‘¸çš„windowï¼Œå°†æ»¡è¶³æ¡ä»¶çš„æ”¾å…¥inputTargetsï¼Œæ²¡æ‰¾åˆ°è¿”å›ç¬¬ä¸€ä¸ªå‰å°window } // åˆé€‚çš„ç›®æ ‡çª—å£è¢«ç¡®å®šä¸‹æ¥ä¹‹åï¼Œä¾¿å¯ä»¥å¼€å§‹å°†å®é™…çš„äº‹ä»¶å‘é€ç»™çª—å£äº† void dispatchEventLocked(Vector&lt;InputTarget&gt;&amp; inputTargets) { InputChannel channel = inputTarget.inputChannel;//åˆ å‡è¿‡çš„æµç¨‹ channel-&gt;sendMessage(&amp;msg);//ç»™èƒ½å¤Ÿè¢«è§¦æ‘¸çš„windowå‘é€è·¨è¿›ç¨‹æ¶ˆæ¯ } } findTouchedWindowTargetsLocked() æ–¹æ³•çš„ä¸»è¦é€»è¾‘ï¼Œæ˜¯æ ¹æ®çª—å£çš„ç‚¹å‡»åŒºåŸŸä¸äº‹ä»¶å‘ç”Ÿçš„åæ ‡ç‚¹é€‰å–åˆé€‚çš„ç›®æ ‡çª—å£ ä»£ç ç¨å¾®æœ‰ç‚¹é•¿ï¼Œè¿™é‡Œå°±ä¸å±•å¼€è®¨è®ºäº†ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥é˜…è¯»ã€ŠWindow Touchable Regionã€‹è¿™ç¯‡æ–‡ç«  å†æ¥çœ‹è´Ÿè´£åˆ†å‘çš„ dispatchEventLocked() æ–¹æ³•ï¼Œä»£ç å®ç°ä¹Ÿå¾ˆç®€å•ï¼Œæ ¹æ®çª—å£æŸ¥æ‰¾è¯¥çª—å£å¯¹åº”çš„ channel ï¼Œç„¶åé€šè¿‡ channel è·¨è¿›ç¨‹æŠŠäº‹ä»¶ä¼ é€’åˆ° APP åˆ°è¿™é‡Œï¼ŒInputDispatcher æ‰€æœ‰çš„åˆ†å‘å·¥ä½œå°±å…¨éƒ¨ç»“æŸäº†ï¼Œæ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹å›¾ å›¾ç‰‡æ¥æºï¼šè‡ªå·±ç”»çš„ å“ï¼Œ è¿˜æ²¡å®Œï¼Œå›å¤´æ¥çœ‹è´Ÿè´£åˆ†å‘è§¦æ‘¸æ¶ˆæ¯çš„ InputDispatcher#dispatchMotionLocked() å‡½æ•° /frameworks/native/services/inputflinger/InputDispatcher.cpp class InputDispatcher { void dispatchMotionLocked() { int32_t injectionResult = findTouchedWindowTargetsLocked(); // ä¸º Motion äº‹ä»¶å¯»æ‰¾åˆé€‚çš„ç›®æ ‡çª—å£ if (injectionResult) dispatchEventLocked(); // å¦‚æœæˆåŠŸåœ°æ‰¾åˆ°äº†å¯ä»¥æ¥æ”¶äº‹ä»¶çš„ç›®æ ‡çª—å£ï¼Œåˆ™é€šè¿‡dispatchEventLocked()å‡½æ•°å®Œæˆå®é™…çš„æ´¾å‘å·¥ä½œ } int findTouchedWindowTargetsLocked(){ size_t numWindows = mWindowHandles.size(); // è·å–çª—å£é›†åˆ for (size_t i = 0; i &lt; numWindows; i++) ... } void dispatchEventLocked(Vector&lt;InputTarget&gt;&amp; inputTargets) { InputChannel channel = inputTarget.inputChannel; channel-&gt;sendMessage(&amp;msg);//ç»™èƒ½å¤Ÿè¢«è§¦æ‘¸çš„windowå‘é€è·¨è¿›ç¨‹æ¶ˆæ¯ } } å†çœ‹ä¸€éæºç ï¼Œæˆ‘ä»¬æ¥æ€è€ƒä¸¤ä¸ªé—®é¢˜ ğŸ¤” è´Ÿè´£æŸ¥æ‰¾çª—å£çš„ findTouchedWindowTargetsLocked() æ–¹æ³•ä¸­ï¼ŒmWindowHandles æ‰€æŒæœ‰çš„çª—å£é›†åˆï¼Œæ˜¯ä»å“ªé‡Œæ¥çš„ï¼Ÿ è´Ÿè´£é€šä¿¡çš„ dispatchEventLocked() æ–¹æ³•ä¸­ï¼ŒInputChannel æ˜¯ä»€ä¹ˆï¼ŸIMS æ˜¯ä»€ä¹ˆæ—¶å€™å’Œ APP å»ºç«‹é€šä¿¡çš„ï¼Ÿ å›æƒ³ä¸€ä¸‹ï¼Œåœ¨ InputDispatcher ä¹‹å‰ï¼Œä¸ç®¡æ˜¯ EventHub ï¼Œè¿˜æ˜¯ InputReader ï¼Œæˆ‘ä»¬ä¸€ç›´éƒ½æ˜¯åœ¨å’Œ Linux å†…æ ¸æ‰“äº¤é“ï¼Œè¯»å–äº‹ä»¶ã€è§£æäº‹ä»¶å•¥çš„ ä½†åˆ°äº† InputDispatcher è¿™é‡Œï¼Œçªç„¶å’Œåº”ç”¨ç¨‹åºäº§ç”Ÿäº†è”ç³» findTouchedWindowTargetsLocked() çš„çª—å£é›†åˆä»å“ªé‡Œæ¥çš„ï¼Ÿ dispatchEventLocked() åˆæ˜¯å¦‚ä½•æŠŠè§¦æ‘¸äº‹ä»¶é€šçŸ¥åˆ° APP è¿›ç¨‹çš„ï¼Ÿ å¸¦ç€è¿™ä¸¤ä¸ªç–‘é—®ï¼Œæˆ‘ä»¬å¼€å§‹è¿›å…¥ InputManagerService çš„å¯åŠ¨æµç¨‹ç¯èŠ‚ï¼Œè¿™é‡Œé¢ä¸€å®šæœ‰æˆ‘ä»¬è¦å¯»æ‰¾çš„ç­”æ¡ˆ å¯åŠ¨ InputManagerService æˆ‘ä»¬çŸ¥é“ï¼ŒInputManagerService ä½œä¸ºè¿è¡Œåœ¨ SystemServer è¿›ç¨‹ä¸­çš„æœåŠ¡ï¼Œå¯åŠ¨é¡ºåºæ˜¯æ’åœ¨ Zygote è¿›ç¨‹ä¹‹åçš„ Java è™šæ‹Ÿæœºåˆå§‹åŒ–å®Œæˆåï¼Œå†ç”± Zygote è¿›ç¨‹ fork è€Œæ¥ æœ¬å°èŠ‚æˆ‘ä»¬å°†è¦æ¥è·Ÿè¸ª InputManagerService çš„å¯åŠ¨æµç¨‹ï¼Œä¸­é—´ä¼šæ¶‰åŠåˆ°ä¸€äº›æ²¡é‚£ä¹ˆé‡è¦çš„ç±»ï¼ˆé‡è¦çš„éƒ½åœ¨ä¸Šé¢ä»‹ç»è¿‡äº†ï¼‰ æ¯”å¦‚ï¼ŒåŒä¸ºåœ¨ /frameworks/native/services/inputflinger åŒ…ä¸‹é¢çš„ InputManager ç±»ï¼Œæˆ‘ä»¬åœ¨ä»‹ç» native å±‚æˆå‘˜çš„æ—¶å€™å°±æ²¡æœ‰å¸¦ä¸Šå®ƒ å› ä¸º InputManager åªæ˜¯è´Ÿè´£ç®¡ç† reader å’Œ dispatcher çº¿ç¨‹ ï¼Œæ²¡æœ‰ä¸šåŠ¡é€»è¾‘ï¼Œä¸æ˜¯å¾ˆé‡è¦ åœ¨æ•´ä¸ª IMS çš„å¯åŠ¨æµç¨‹ä¸­ï¼Œæˆ‘ä»¬æ—¶åˆ»è¦è°¨è®°ï¼Œæœ¬èŠ‚çš„é‡ç‚¹æ˜¯ï¼š äº†è§£ InputManagerService å¤§è‡´çš„å¯åŠ¨æµç¨‹ äº†è§£ InputDispatcher çš„çª—å£é›†åˆä»å“ªé‡Œæ¥ï¼Œä»¥åŠ IMS å¦‚ä½•å»ºç«‹è·Ÿ APP é€šä¿¡çš„ï¼Ÿ ææ¸…æ¥šè¿™ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼Œ IMS å¯åŠ¨æµç¨‹è¿™ part å°±å¯ä»¥ç¿»ç¯‡äº†ï¼Œåƒä¸‡åˆ«è¢«é™·å…¥åˆ°æºç ä¸­ï¼Œå¾ˆéš¾å‡ºæ¥çš„~ 1ã€IMS çª—å£é›†åˆä»å“ªé‡Œæ¥ï¼Ÿ åœ¨å‰ä¸¤èŠ‚æˆ‘ä»¬äº†è§£åˆ°ï¼ŒInputManagerService å¯ä»¥åˆ†ä¸º nativeã€jniã€Java ä¸‰å±‚ è¿™ä¸‰å±‚å¤§è‡´çš„å¯åŠ¨é¡ºåºæ˜¯ï¼šå…ˆä» Java å±‚çš„åˆå§‹åŒ–å¼€å§‹ï¼Œå†è°ƒç”¨åˆ° jni å±‚ï¼Œç”± jni æ‹‰èµ· native çš„å„ä¸ªç±»ï¼Œè¿›è€Œå®Œæˆ native éƒ¨åˆ†çš„åˆå§‹åŒ–ï¼Œæœ€åè¿”å›åˆ° Java å±‚ï¼ŒIMS å¼€å§‹ä¸ºå„ä¸ª APP æä¾›æœåŠ¡ æˆ‘ä»¬å…ˆæ¥çœ‹ Java å±‚çš„åˆå§‹åŒ–å·¥ä½œ /frameworks/base/services/java/com/android/server/SystemServer.java class SystemServer { private void startOtherServices() { inputManager = new InputManagerService(context); // åˆ›å»º IMS å¯¹è±¡ ... //å°† InputMonitor å¯¹è±¡ä¿å­˜åˆ° IMS å¯¹è±¡ inputManager.setWindowManagerCallbacks(wm.getInputMonitor()); inputManager.start(); } } åœ¨ SystemServer#startOtherServices() å¯åŠ¨æœåŠ¡çš„æ–¹æ³•ä¸­ï¼Œé¦–å…ˆåˆ›å»ºäº† InputManagerService å¯¹è±¡ ç„¶åï¼Œå°† WindowManagerService ä¸­çš„ InputMonitor å¯¹è±¡ä¿å­˜åˆ° IMS ä¸­ è¿™æ˜¯ InputMonitor ç±»æ˜¯å¹²å˜›çš„ï¼Ÿä¹‹å‰å¥½åƒæ²¡è§è¿‡ ç®€å•æ¥è¯´ï¼Œå®ƒæ˜¯è¿æ¥ WMS å’Œ IMS çš„æ¢çº½ã€‚WMS é€šè¿‡ InputMonitor.java æŒæœ‰äº† IMS çš„å¼•ç”¨ï¼Œå½“çª—å£ä¿¡æ¯å‘ç”Ÿå˜åŒ–åï¼Œé€šè¿‡ InputMonitor#updateInputWindowsLw() æ–¹æ³•ï¼Œå°†æ–°çš„çª—å£é›†åˆæ›´æ–°åˆ° IMS ä¸­ï¼ŒIMS åˆå°†çª—å£é›†åˆåŒæ­¥åˆ° InputDispatcher æˆ‘ä»¬æœ¬å°èŠ‚çš„ç›®æ ‡ä¹‹ä¸€ï¼Œæ˜¯ä¸ºäº†ææ¸…æ¥š InputDispatcher æŒæœ‰çš„çª—å£é›†åˆä»å“ªé‡Œæ¥ï¼Ÿ ç°åœ¨ï¼Œç­”æ¡ˆæœ‰äº†ï¼Œæ˜¯ WMS é€šè¿‡è°ƒç”¨ InputMonitor#updateInputWindowsLw() å‡½æ•°ï¼Œæœ€ç»ˆåŒæ­¥åˆ° InputDispatcher ç±»ä¸­ ç®€å•è¯´ä¸€ä¸‹æŸ¥æ‰¾è¿‡ç¨‹ å…ˆå›åˆ° InputDispatcher æºç ï¼Œæœç´¢ mWindowHandles å…³é”®å­—ï¼Œå¾ˆå®¹æ˜“å°±èƒ½å‘ç°äº† mWindowHandles é›†åˆæ˜¯åœ¨ setInputWindows() å‡½æ•°ä¸­è¢«èµ‹å€¼ /frameworks/native/services/inputflinger/InputDispatcher.cpp class InputDispatcher { void InputDispatcher::setInputWindows(inputWindowHandles) { mWindowHandles = inputWindowHandles; } } é‚£ä¹ˆ setInputWindows() æ˜¯è°è°ƒç”¨çš„ï¼Ÿæ¥ç€æœç´¢ Framework ï¼Œç»“æœå¦‚å›¾ å›¾ç‰‡æ¥æºï¼šaospxref.com/android-7.1.2 æˆ‘ä»¬å‘ç°ï¼ŒJava å±‚çš„ IMS ä¹Ÿæœ‰ä¸€ä¸ª setInputWindows() æ–¹æ³•ï¼Œå¹¶é€šè¿‡ JNI æŒ‡å‘äº† native ä¸­çš„ InputDispatcher#setInputWindows() æœ€ç»ˆçš„è°ƒç”¨åŠ¨ä½œå°±å‘ç”Ÿåœ¨ InputMonitor ç±»çš„ updateInputWindowsLw() æ–¹æ³•ä¸­ï¼ å¥½äº†ï¼ŒInputDispatcher æŒæœ‰çš„çª—å£é›†åˆæ¥æºï¼Œè¿™ä¸ªç–‘é—®å·²ç»è§£å†³äº†ã€‚æˆ‘ä»¬ç»§ç»­æ¥è·Ÿå¯åŠ¨æµç¨‹ /frameworks/base/services/java/com/android/server/SystemServer.java class SystemServer { private void startOtherServices() { inputManager = new InputManagerService(context); inputManager.start(); } } /frameworks/base/services/core/java/com/android/server/input/InputManagerService.java class InputManagerService { // ã€step 1.0ã€‘åˆå§‹åŒ–æµç¨‹ public InputManagerService(Context context) { mPtr = nativeInit(this, mContext, mHandler.getLooper().getQueue()); LocalServices.addService(InputManagerInternal.class, new LocalService()); } // ã€step 2.0ã€‘ å¯åŠ¨æµç¨‹ public void start() { nativeStart(mPtr); // è¯¦è§ ã€2.1ã€‘ Watchdog.getInstance().addMonitor(this); } } åœ¨ SystemServer åˆ›å»ºå®Œ InputManagerService å¯¹è±¡åï¼Œç´§æ¥ç€å°±è°ƒç”¨äº† inputManager#start() å¯åŠ¨äº†æœåŠ¡ æ‰€ä»¥æˆ‘ä»¬éœ€è¦æŠŠå¯åŠ¨æµç¨‹åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤æ¥çœ‹ï¼Œä¸€ä¸ªæ˜¯åˆå§‹åŒ–æµç¨‹åšäº†ä»€ä¹ˆï¼Œç¬¬äºŒä¸ªæ‰æ˜¯å¯åŠ¨æµç¨‹ åœ¨ InputManagerService çš„æ„é€ å‡½æ•°ä¸­ï¼Œè°ƒç”¨äº† nativeInit() æ‰§è¡Œäº†åˆå§‹åŒ–å·¥ä½œï¼Œè¿™æ˜¯ä¸ª jni æ–¹æ³•ï¼Œæˆ‘ä»¬ä¸€èµ·å»çœ‹çœ‹æºç å®ç° 2ã€IMS çš„åˆå§‹åŒ–å·¥ä½œ /frameworks/base/services/core/jni/com_android_server_input_InputManagerService.cpp class NativeInputManager { static jlong nativeInit(env, jclass, serviceObj, contextObj, messageQueueObj) { NativeInputManager* im = new NativeInputManager(contextObj, serviceObj,messageQueue-&gt;getLooper()); } NativeInputManager::NativeInputManager(contextObj, serviceObj, looper) { sp&lt;EventHub&gt; eventHub = new EventHub(); // åˆ›å»º EventHub å¯¹è±¡ mInputManager = new InputManager(eventHub, this, this); // åˆ›å»º InputManager å¯¹è±¡ } } nativeInit() æ–¹æ³•ä¸­åˆ›å»ºäº† NativeInputManager å¯¹è±¡ åœ¨ NativeInputManager çš„æ„é€ å‡½æ•°ä¸­ï¼Œåˆåˆ›å»ºäº†ä¸¤ä¸ªæˆ‘ä»¬ç†Ÿæ‚‰çš„å¯¹è±¡ï¼ŒEventHub å’Œ InputManager EventHub åœ¨å‰é¢å·²ç»ä»‹ç»è¿‡äº†ï¼Œè´Ÿè´£ç›‘å¬äº‹ä»¶å˜åŒ–ï¼Œå¹¶å¯¹å¤–æä¾›è·å–äº‹ä»¶å˜åŒ–çš„æ¥å£ InputManager ä¹Ÿæåˆ°è¿‡ï¼Œè´Ÿè´£åˆ›å»º Reader å’Œ Dispatcher ä¸¤çº¿ç¨‹ï¼Œæ²¡ä»€ä¹ˆé€»è¾‘ /frameworks/native/services/inputflinger/EventHub.cpp class EventHub { EventHub::EventHub(void) { mEpollFd = epoll_create(EPOLL_SIZE_HINT); // åˆ›å»º epollï¼Œç”¨äºç›‘å¬è®¾å¤‡æ–‡ä»¶æ˜¯å¦æœ‰å¯è¯»äº‹ä»¶ mINotifyFd = inotify_init(); // åˆ›å»º inotify ï¼Œç”¨äºç›‘å¬æ–‡ä»¶ç³»ç»Ÿæ˜¯å¦å˜åŒ–ï¼Œæœ‰å˜åŒ–è¯´æ˜å‘ç”Ÿè®¾å¤‡æ’æ‹” } } /frameworks/native/services/inputflinger/InputManager.cpp class InputManager { InputManager::InputManager(eventHub, readerPolicy, dispatcherPolicy) { mDispatcher = new InputDispatcher(dispatcherPolicy); mReader = new InputReader(eventHub, readerPolicy, mDispatcher); initialize(); } void InputManager::initialize() { mReaderThread = new InputReaderThread(mReader); //åˆ›å»ºçº¿ç¨‹ â€œInputReaderâ€ mDispatcherThread = new InputDispatcherThread(mDispatcher); //åˆ›å»ºçº¿ç¨‹ â€InputDispatcherâ€œ } } å‘ï¼Œä½ çœ‹ EventHub åªæ˜¯åˆ›å»ºäº† mEpollFd å’Œ mINotifyFd ä¸¤ä¸ª Fd å¯¹è±¡ InputManager ä¹Ÿåªæ˜¯åˆ›å»ºäº† InputReader å’Œ InputDispatcher ä¸¤ä¸ªå¯¹è±¡ï¼Œç„¶ååˆ›å»ºäº† InputReaderThread å’Œ InputDispatcherThread ä¸¤ä¸ªçº¿ç¨‹ å¥½äº†ï¼Œç°åœ¨ IMS åº•å±‚çš„ä¸‰å‘˜å¤§å°†ï¼šEventHubã€InputReaderã€InputDispatcher å…¨éƒ¨æˆåŠŸåˆ›å»ºï¼ŒIMS ç±»çš„åˆå§‹åŒ–å·¥ä½œå°±å…¨éƒ¨ç»“æŸäº† 3ã€IMS çš„å¯åŠ¨æµç¨‹ æˆ‘ä»¬æŠŠ SystemServer çš„ä»£ç å†æ‹¿å‡ºæ¥çœ‹çœ‹ï¼Œçœ‹çœ‹æ¥ä¸‹æ¥åº”è¯¥åšä»€ä¹ˆ /frameworks/base/services/java/com/android/server/SystemServer.java class SystemServer { private void startOtherServices() { inputManager.start(); } } /frameworks/base/services/core/java/com/android/server/input/InputManagerService.java class InputManagerService { public InputManagerService(Context context); // åˆå§‹åŒ–å·¥ä½œå·²å®Œæˆ public void start() { nativeStart(mPtr); // å¯åŠ¨æœåŠ¡ Watchdog.getInstance().addMonitor(this); } } åˆå§‹åŒ–å·¥ä½œå®Œæˆä»¥åï¼Œç´§æ¥ç€è°ƒç”¨äº† start() æ–¹æ³•å¯åŠ¨äº†æœåŠ¡ start() å†…éƒ¨è°ƒç”¨äº† nativeStart() æ–¹æ³•ï¼Œè¿™åˆæ˜¯ä¸ª jni å‡½æ•°ï¼Œæˆ‘ä»¬ç»§ç»­å‘ä¸‹è·Ÿ /frameworks/base/services/core/jni/com_android_server_input_InputManagerService.cpp class NativeInputManager { static void nativeStart(env, jclass , ptr) { getInputManager()-&gt;start(); // è°ƒç”¨ InputManager çš„ start() æ–¹æ³• } } /frameworks/native/services/inputflinger/InputManager.cpp class InputManager { status_t InputManager::start() { result = mDispatcherThread-&gt;run(&quot;InputDispatcher&quot;, PRIORITY_URGENT_DISPLAY); // å¯åŠ¨çº¿ç¨‹â€œInputReaderâ€ result = mReaderThread-&gt;run(&quot;InputReader&quot;, PRIORITY_URGENT_DISPLAY); // å¯åŠ¨çº¿ç¨‹â€InputDispatcherâ€œ ... return OK; } } nativeStart() å†…éƒ¨è°ƒç”¨äº† InputManager#start() ï¼Œå¯åŠ¨äº† InputReaderThread å’Œ InputDispatcher çº¿ç¨‹ è¿™ä¿©çº¿ç¨‹æˆ‘ä»¬å·²ç»è§è¿‡äº†ï¼Œå¯åŠ¨åï¼ŒInputReaderThread å¾ªç¯è¯»æ¶ˆæ¯ï¼Œè¯»åˆ°æ¶ˆæ¯è§£æï¼Œç”Ÿæˆ Event å¯¹è±¡ï¼Œæäº¤åˆ°äº‹ä»¶é˜Ÿåˆ—ï¼Œç­‰å¾…åˆ†å‘ InputDispatcher å¾ªç¯æ´¾å‘æ¶ˆæ¯ï¼Œä¸€ç›´ä»äº‹ä»¶é˜Ÿåˆ—ä¸­å– Event æ¶ˆæ¯ï¼Œæ´¾å‘ç»™åˆé€‚çš„çª—å£ åˆ°è¿™é‡Œï¼Œ IMS çš„å¯åŠ¨å·¥ä½œå°±å…¨éƒ¨ç»“æŸäº†ï¼Œæ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹å›¾ å›¾ç‰‡æ¥æºï¼šè‡ªå·±ç”»çš„ IMS å¯åŠ¨æµç¨‹ç¨å¾®æœ‰é‚£ä¹ˆä¸€ç‚¹ç‚¹é•¿ï¼Œå®Œæ•´çš„å¯åŠ¨åˆ†ææˆ‘æ”¾åœ¨äº† GitHub ï¼Œç‚¹å‡»[è¿™é‡Œ]è·³è½¬æŸ¥çœ‹ å¯åŠ¨ APP è¿›ç¨‹ åœ¨ä¸Šä¸€å°èŠ‚ InputManagerService çš„å¯åŠ¨æµç¨‹ä¸­ï¼Œæˆ‘ä»¬è§£å†³äº†â€œ InputDispatcher çš„çª—å£é›†åˆä»å“ªé‡Œæ¥â€ çš„é—®é¢˜ ç°åœ¨è¿˜å‰©ä¸‹ â€œ APP æ˜¯å¦‚ä½•å’Œ IMS å»ºç«‹é€šä¿¡çš„ â€ è¿™ä¸ªé—®é¢˜è¿˜æ²¡æœ‰è§£å†³ ç³»ç»ŸæœåŠ¡å…¨éƒ¨å‡†å¤‡å°±ç»ªåï¼Œæ¥ä¸‹æ¥æ˜¯ APP åº”ç”¨çš„å¯åŠ¨æµç¨‹ï¼Œåœ¨è·Ÿè¸ªå¯åŠ¨åº”ç”¨è¿›ç¨‹çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¼šæ‰¾åˆ° â€œ APP æ˜¯å¦‚ä½•å’Œ IMS å»ºç«‹é€šä¿¡çš„ â€ è¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆ 1ã€ä¸º Activity åˆ†é…çª—å£ APP çš„å¯åŠ¨è¿‡ç¨‹æˆ‘ä»¬åº”è¯¥éƒ½å¤šå°‘æœ‰ç‚¹äº†è§£ï¼Œå’Œ AMS é€šä¿¡æ€ä¹ˆåˆ›å»ºè¿›ç¨‹è¿™éƒ¨åˆ†æˆ‘ä»¬å°±è·³è¿‡äº†ï¼Œæœ¬ç¯‡é‡ç‚¹æ˜¯è§¦æ‘¸äº‹ä»¶ï¼Œæˆ‘ä»¬ç›´æ¥å¿«è¿›åˆ°ä¸º Activity è®¾ç½®è§†å›¾ï¼Œåˆ†é…çª—å£è¿™éƒ¨åˆ†å†…å®¹ /frameworks/base/core/java/android/view/ViewRootImpl.java class ViewRootImpl { InputChannel mInputChannel; // ä¿å­˜çš„æ˜¯ client ç«¯çš„ socket void setView(View view){ mInputChannel = new InputChannel(); // åˆ›å»ºäº†ç©ºçš„ InputChannel ï¼Œä¸‹é¢ä»£ç å°†ä¼šç”ŸæˆçœŸå®çš„ InputChannel Session.addToDisplay(view,mInputChannel);//å‘wmsæ·»åŠ çª—å£ if(mInputChannel!=null) mInputEventReceiver = new WindowInputEventReceiver(mInputChannel, Looper.myLooper()); } } æˆ‘ä»¬åœ¨ Activity è®¾ç½®çš„è§†å›¾æ–‡ä»¶ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ° ViewRootImpl#setView() æ–¹æ³• åœ¨ setView() æ–¹æ³•ä¸­ï¼Œä¸€å…±æœ‰ä¸‰è¡Œå…³é”®ä»£ç  åˆ›å»ºäº†å±äºè¯¥è§†å›¾çš„ InputChannel ç©ºå¯¹è±¡ï¼Œå…ˆä¸ç”¨ç®¡ å‘ WMS æ·»åŠ çª—å£ï¼Œå¹¶å°†åˆšåˆšåˆ›å»ºçš„ InputChannel å¯¹è±¡ä¸€å¹¶ä¼ é€’è¿‡å»ï¼Œé‡è¦é€»è¾‘ åˆ›å»ºäº† WindowInputEventReceiver ï¼Œå°†è¯¥è§†å›¾çš„ InputChannel ä¿å­˜èµ·æ¥ï¼Œä¹Ÿä¸ç”¨ç®¡ åœ¨è¿™ä¸‰è¡Œä»£ç ä¸­ï¼Œç¬¬2è¡Œæ˜¯å…³é”®ä»£ç ï¼Œç¬¬1è¡Œå’Œç¬¬3è¡Œï¼Œä»¥ç°æœ‰çš„ä¿¡æ¯æ²¡åŠæ³•è§£é‡Šå®ƒä»¬å†…éƒ¨åšäº†ä»€ä¹ˆï¼Œç­‰åˆ°åé¢æœ‰æœºä¼šåœ¨ä»‹ç» å¥½ï¼Œæˆ‘ä»¬æ¥çœ‹ç¬¬2è¡Œä»£ç å‘ç”Ÿäº†ä»€ä¹ˆ /frameworks/base/services/core/java/com/android/server/wm/Session.java class Session { void addToDisplay(InputChannel inputChannel){ WindowManagerService.addWindow(inputChannel); } } /frameworks/base/services/core/java/com/android/server/wm/WindowManagerService.java class WindowManagerService { int addWindow(InputChannel outInputChannel){ WindowState win = new WindowState(); // é¦–æ¬¡æ·»åŠ è§†å›¾æ—¶åˆ›å»ºï¼Œç”¨äºæè¿°ä¸€ä¸ªwindow win.openInputChannel(outInputChannel); // åˆ›å»ºé€šä¿¡çš„å…³é”®ä»£ç ï¼Œæ‰“å¼€ä¸€å¯¹å·²è¿æ¥çš„ socket } } Session#addToDisplay() æ–¹æ³•åªæ˜¯åšäº†è½¬å‘ï¼Œå®é™…åˆ›å»ºçª—å£çš„å·¥ä½œè¿˜æ˜¯ç”± WindowManagerService#addWindow() æ¥å®Œæˆçš„ åœ¨ addWindow() æ–¹æ³•ä¸­ï¼Œé¦–å…ˆåˆ›å»ºäº† WindowState å¯¹è±¡ï¼Œç”¨äºæè¿°è¯¥çª—å£ä¿¡æ¯ éšåè°ƒç”¨äº† WindowState å¯¹è±¡ä¸­çš„ openInputChannel() æ–¹æ³•ï¼Œå®ƒæ˜¯åˆ›å»ºé€šä¿¡çš„å…³é”®ä»£ç ï¼Œå†…éƒ¨æ˜¯åˆ›å»ºäº†ä¸€å¯¹å·²è¿æ¥çš„ socket æˆ‘ä»¬æ¥é‡ç‚¹å…³æ³¨ WindowState#openInputChannel() æ–¹æ³• /frameworks/base/services/core/java/com/android/server/wm/WindowState.java class WindowState { InputChannel mInputChannel; InputChannel mClientChannel; void openInputChannel(InputChannel outInputChannel) { InputChannel[] inputChannels = InputChannel.openInputChannelPair(); // è¿”å›ä¸€å¯¹å·²è¿æ¥çš„ socket // è¿™æ˜¯ä¸€å¯¹å·²è¿æ¥çš„ç®¡é“ï¼Œå°† socket ä¸¤ç«¯åˆ†åˆ«ä¿å­˜åˆ°æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å³å¯è¿›è¡Œé€šä¿¡ mInputChannel = inputChannels[0]; // ä¸‹æ ‡ä¸º0çš„ä¼ é€’ç»™ IMS æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯å¯é€šè¿‡è¯¥ socket å‘çª—å£å‘é€æ¶ˆæ¯ mClientChannel = inputChannels[1]; // ä¸‹æ ‡ä¸º1çš„å›ä¼ ç»™ client ç«¯ // 1. Client ç«¯ InputChanenl è°ƒç”¨ transforTo() æ–¹æ³•ä¼ ç»™ ViewRootImpl çš„ mInputChannel mClientChannel.transferTo(outInputChannel); // 2. Server ç«¯ InputChannel å­˜åœ¨ WindowState çš„ mInputChannel å˜é‡ InputManagerService.registerInputChannel(mInputChannel); } } /frameworks/native/libs/input/InputTransport.cpp status_t InputChannel::openInputChannelPair(name,outServerChannel,outClientChannel) { int sockets[2] = socketpair(sockets); serverChannelName.append(&quot; (server)&quot;); outServerChannel = new InputChannel(serverChannelName, sockets[0]); clientChannelName.append(&quot; (client)&quot;); outClientChannel = new InputChannel(clientChannelName, sockets[1]); return OK; } WindowState#openInputChannel() ä¸­ï¼Œé¦–å…ˆè°ƒç”¨äº† InputChannel#openInputChannelPair() å‡½æ•°åˆ›å»ºä¸¤ä¸ª InputChannelï¼Œå…¶å†…éƒ¨è°ƒç”¨ Linux çš„ socketpair() å‡½æ•° socketpair() æ˜¯ Linux æä¾›çš„ä¸€ç§è¿›ç¨‹é—´é€šä¿¡çš„æ–¹å¼ï¼Œè·Ÿ pipe() å‡½æ•°æ˜¯ç±»ä¼¼çš„ã€‚ä½† pipe() åˆ›å»ºçš„åŒ¿åç®¡é“æ˜¯åŠåŒå·¥çš„ï¼Œè€Œ socketpair() å¯ä»¥è®¤ä¸ºæ˜¯åˆ›å»ºä¸€ä¸ªå…¨åŒå·¥çš„ç®¡é“ï¼š æˆ‘å‘æˆ‘æŒæœ‰çš„ socket ä¸­å†™æ•°æ®ï¼Œä½ åœ¨ä½ æŒæœ‰çš„ socket ä¸­èƒ½å¤Ÿè¯»åˆ°æ•°æ®ï¼Œåè¿‡æ¥ä¹Ÿä¸€æ ·ï¼Œå³ä¸¤ç«¯éƒ½å¯ä»¥å¯¹è‡ªå·±æŒæœ‰çš„ socket è¿›è¡Œè¯»å†™ åœ¨è§¦æ‘¸äº‹ä»¶çš„ä¼ é€’ä¸­ï¼ŒGoogle å›¢é˜Ÿä½¿ç”¨äº† socketpair() åˆ›å»ºä¸€å¯¹å·²è¿æ¥çš„ socket ï¼Œç”¨äº IMS å’Œ APP é—´è·¨è¿›ç¨‹é€šä¿¡ å…¶ä¸­ï¼ŒIMS ä¼šæŒæœ‰åä¸º server çš„ä¸€ç«¯ï¼ˆsockets[0]ï¼‰è¿›è¡Œè¯»å†™ï¼› APP æŒæœ‰åä¸º client çš„ä¸€ç«¯ï¼ˆsockets[1]ï¼‰è¿›è¡Œè¯»å†™ æä¸ªé†’ï¼Œæˆ‘ä»¬ç°åœ¨çœ‹çš„ä»£ç æ˜¯ï¼šè®¾ç½® Activity è§†å›¾æ—¶ï¼Œç»è¿‡ binder é€šä¿¡åï¼Œè·‘åœ¨äº† system_server è¿›ç¨‹ä¸­çš„ WMS æœåŠ¡é‡Œ å› æ­¤ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥çš„ä»»åŠ¡ï¼Œæ˜¯æŠŠ sockets[0] çš„ server ç«¯ï¼Œä¼ é€’ç»™ IMS ï¼Œè®©è§¦æ‘¸äº‹ä»¶å‘ç”Ÿåï¼Œ IMS èƒ½å¤Ÿé€šçŸ¥åˆ° APP ç„¶åï¼ŒæŠŠ sockets[1] çš„ client ç«¯é€šè¿‡ binder è·¨è¿›ç¨‹å›ä¼ ç»™ APP è¿›ç¨‹ä¿å­˜ï¼Œè®© APP èƒ½å¤Ÿæ¥æ”¶åˆ°æ¥è‡ª IMS çš„æ¶ˆæ¯ å¥½ï¼Œå¼€å§‹å¹²æ´» 2ã€sockets[1] å›ä¼ ç»™ APP æºç é‡Œæ˜¯å…ˆå°† Client çš„å›ä¼ ç»™ APP è¿›ç¨‹ï¼Œé‚£æˆ‘ä»¬å°±æŒ‰ç…§æºç çš„é¡ºåºæ¥çœ‹ï¼Œå…ˆæŠŠå±äº APP è¿›ç¨‹çš„ socket / InputChannel å›ä¼ è¿‡å» /frameworks/base/services/core/java/com/android/server/wm/WindowState.java class WindowState { void openInputChannel(InputChannel outInputChannel) { // 1. Client ç«¯ InputChanenl è°ƒç”¨ transforTo() æ–¹æ³•ä¼ ç»™ ViewRootImpl çš„ mInputChannel mClientChannel.transferTo(outInputChannel); // 2. Server ç«¯ InputChannel å­˜åœ¨ WindowState çš„ mInputChannel å˜é‡ InputManagerService.registerInputChannel(mInputChannel); } } /frameworks/base/core/java/android/view/ViewRootImpl.java class ViewRootImpl { InputChannel mInputChannel; // ä¿å­˜çš„æ˜¯ client ç«¯çš„ socket void setView(View view){ mInputChannel = new InputChannel(); // åˆ›å»ºäº†ç©ºçš„ InputChannel try { Session.addToDisplay(view,mInputChannel); } catch (RemoteException e) { mInputChannel = null; } ... if(mInputChannel != null ) mInputEventReceiver = new InputEventReceiver(mInputChannel, Looper.myLooper()); } } çœ‹ä»£ç ï¼ŒSession#addToDisplay() æ˜¯å°†æˆ‘ä»¬è®¾ç½®çš„è§†å›¾ï¼Œå’Œåˆšåˆšåˆ›å»ºçš„ç©ºçš„ mInputChannel ä¼ é€’åˆ° WindowManagerService å¦‚æœ WMS æˆåŠŸæ·»åŠ äº†è§†å›¾ï¼Œæ²¡æœ‰å‘ç”Ÿå¼‚å¸¸ï¼Œè¡¨ç¤ºå±äº APP ç«¯çš„ socket / InputChannel å·²ç»åˆ›å»ºæˆåŠŸå¹¶é€šè¿‡ binder è·¨è¿›ç¨‹ä¼ é€’å›æ¥äº†ï¼Œæ­¤æ—¶ mInputChannel å˜é‡å°±ä¸æ˜¯åˆšåˆšåˆ›å»ºçš„ç©ºå¯¹è±¡äº†ï¼Œé‡Œé¢å·²ç»åŒ…å«äº† APP ç«¯çš„ socket ç›‘å¬è¿™ä¸ª socket ï¼Œæˆ‘ä»¬å¯ä»¥æ”¶åˆ°æ¥è‡ª IMS çš„æ¶ˆæ¯ï¼›å¾€è¿™ä¸ª socket å†™æ•°æ®ï¼ŒIMS ä¹Ÿå¯ä»¥æ”¶åˆ°æˆ‘ä»¬å‘é€çš„æ¶ˆæ¯ï¼Œç¾æ»‹æ»‹ å¦‚æœ WMS æ·»åŠ è§†å›¾å¤±è´¥äº†ï¼Œä¼šæŠ›å‡º RemoteException è¿œç¨‹è¿æ¥å¼‚å¸¸ï¼ŒmInputChannel å˜é‡å°†è¢«æ¸…ç©ºã€‚ æ€»ä¹‹ï¼Œåªè¦ mInputChannel å˜é‡ä¸ä¸ºç©ºï¼Œå°±è¡¨ç¤ºå±äº APP ç«¯çš„ socket å·²ç»ä¼ å›æ¥äº†ï¼Œ WMS å’Œ APP ä¸­é—´çš„ä¼ é€’è¿‡ç¨‹æˆ‘ä»¬å…ˆä¸ç®¡ å¥½ï¼Œç°åœ¨ APP ç«¯çš„ InputChannel å·²ç»å›ä¼ æˆåŠŸï¼Œä¸‹ä¸€æ­¥çš„ä»£ç æ˜¯åˆ›å»ºäº† InputEventReceiver å¯¹è±¡ï¼Œå¹¶å°† APP ç«¯çš„ InputChannel å’Œ APP ç«¯çš„ Looper ä¸€åŒä¼ é€’è¿‡å» ä¸€èµ·æ¥çœ‹ InputEventReceiver çš„ä»£ç  /frameworks/base/core/java/android/view/InputEventReceiver.java class InputEventReceiver { public InputEventReceiver(InputChannel inputChannel, Looper looper) { mReceiverPtr = nativeInit(new WeakReference&lt;InputEventReceiver&gt;(this),inputChannel, looper.getQueue()); } } java å±‚çš„ InputEventReceiver åªæ˜¯ä¸ªç©ºå£³å­ï¼Œå®é™…çš„å®ç°åœ¨ native å±‚ï¼Œç»§ç»­å‘ä¸‹è·Ÿ /frameworks/base/core/jni/android_view_InputEventReceiver.cpp class NativeInputEventReceiver { static jlong nativeInit(env, clazz, receiverWeak, inputChannelObj, messageQueueObj) { // ç®€ç•¥å†™æ³• int fd = inputChannelObj-&gt;getFd(); messageQueueObj-&gt;getLooper()-&gt;addFd(fd, 0, events, this, NULL); ... } } ä»£ç æˆ‘åˆåˆå¹¶è¿‡ï¼Œå…³é”®ä»£ç å°±ä¸¤è¡Œ ç¬¬ä¸€è¡Œæ˜¯åˆ©ç”¨ inputChannelObj å¯¹è±¡è·å–é‡Œé¢çš„ socketfd ç¬¬äºŒè¡Œæ˜¯åˆ©ç”¨ messageQueueObj å¯¹è±¡è·å–é‡Œé¢çš„ Looper ï¼ŒæŠŠä¸Šä¸€æ­¥æ‹¿åˆ°çš„ socketfd ä¸¢è¿›å»ç›‘å¬ ä»£ç è™½ç„¶ä¸å¤šï¼Œä½†ç†è§£è¿™ä¸¤è¡Œä»£ç ï¼Œéœ€è¦å¯¹ Handler æœºåˆ¶æ¯”è¾ƒç†Ÿæ‚‰ï¼ŒåŒ…æ‹¬ native å±‚ æˆ‘æ¥ç®€å•è§£é‡Šä¸€ä¸‹ï¼š åœ¨ã€ŠAndroidç»„ä»¶ç³»åˆ—ï¼šå†è°ˆHandleræœºåˆ¶ï¼ˆNativeç¯‡ï¼‰ã€‹è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬äº†è§£åˆ°ï¼šåœ¨ native å±‚åŒæ ·æ‹¥æœ‰ä¸€å¥— Looper æœºåˆ¶ã€‚è¿™å¥— Looper ä¸ä½†å¯ä»¥å¤„ç† native å±‚æ¶ˆæ¯ï¼Œè¿˜æ”¯æŒç›‘å¬ è‡ªå®šä¹‰ fdï¼Œè¿™æ˜¯æœ¬å°èŠ‚çš„é‡ç‚¹ Java å±‚çš„ MessageQueue åœ¨åˆå§‹åŒ–æ—¶ï¼Œä¼šè°ƒç”¨ nativeInit() æ–¹æ³•ï¼ŒåŒæ­¥åˆ›å»º naive å±‚çš„ NativeMessageQueue å¯¹è±¡ï¼Œå¹¶å°†è¿”å›çš„ native å¼•ç”¨ä¿å­˜åˆ° mPtr å˜é‡ä¸­ æ³¨æ„çœ‹ï¼Œæˆ‘ä»¬ç°åœ¨è·Ÿè¸ªçš„ NativeInputEventReceiver æ„é€ å‡½æ•°çš„å…¥å‚ï¼Œä¼ é€’è¿‡æ¥çš„å‚æ•°ä¸€ä¸ªæ˜¯ InputChannel ï¼Œé‡Œé¢åŒ…å«äº†å±äº APP ç«¯çš„ socketï¼Œè¿˜æœ‰ä¸€ä¸ªå‚æ•°æ˜¯æ¥è‡ª Java å±‚çš„ MessageQueue å¯¹è±¡ é‚£ä¹ˆï¼ŒNativeInputEventReceiver#nativeInit() æ–¹æ³•é‡Œå®Œæˆçš„äº‹æƒ…æ˜¯ï¼šåˆ©ç”¨ Java MessageQueue çš„ mPtr å˜é‡æŒæœ‰çš„ NativeMessageQueue å¯¹è±¡ï¼Œæ‰¾åˆ° native Looper ç„¶åï¼Œåˆ©ç”¨ native å±‚çš„ Looper å¯¹è±¡æ¥ç›‘å¬ä¸€åŒä¼ é€’è¿‡æ¥çš„ InputChannel ä¸­çš„ socketfd ã€‚ è¿™ä¸€æ®µå¬èµ·æ¥å¯èƒ½ä¼šæœ‰ç‚¹ç»•ï¼Œæš‚æ—¶æ²¡ç†è§£æŸä¸ªç‚¹é—®é¢˜ä¹Ÿä¸å¤§ï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“ï¼Œåœ¨è®¾ç½®è§†å›¾çš„æ—¶å€™ï¼Œé¡ºä¾¿åˆ›å»ºäº†å’Œ IMS é€šä¿¡çš„é€šé“å°±è¡Œäº† å¥½äº†ï¼ŒAPP ç«¯çš„ socketï¼ˆsockets[1]ï¼‰ å›ä¼ å·¥ä½œç®—æ˜¯ç»“æŸäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹æ€ä¹ˆæŠŠ sockets[0] ä¼ é€’ç»™ IMS 3ã€sockets[0] ä¼ é€’åˆ° IMS IMS ç«¯çš„ socket æœ€ç»ˆæ˜¯ç”± InputDispatcher æ¥ä¿ç®¡ï¼Œå› ä¸ºåˆ†å‘äº‹ä»¶æ—¶ï¼Œæ˜¯ InputDispatcher ç›´æ¥ä½¿ç”¨ socket é€šçŸ¥ APP çš„ æ‰€ä»¥ï¼Œæˆ‘ä»¬æœ¬å°èŠ‚çš„ç›®æ ‡æ˜¯ï¼šææ¸…æ¥š IMS ç«¯çš„ socket æ˜¯å¦‚ä½•ä¼ é€’åˆ° InputDispatcher ç±»ä¸­çš„ï¼Ÿ IMS ä¼ é€’çš„èµ·ç‚¹ï¼Œä¾æ—§æ˜¯åœ¨ WindowState#openInputChannel() æ–¹æ³•ä¸­ï¼š /frameworks/base/services/core/java/com/android/server/wm/WindowState.java class WindowState { void openInputChannel(InputChannel outInputChannel) { // 1. Client ç«¯ InputChanenl è°ƒç”¨ transforTo() æ–¹æ³•ä¼ ç»™ ViewRootImpl çš„ mInputChannel mClientChannel.transferTo(outInputChannel); // 2. Server ç«¯ InputChannel å­˜åœ¨ WindowState çš„ mInputChannel å˜é‡ InputManagerService.registerInputChannel(mInputChannel); } } /frameworks/base/services/core/java/com/android/server/input/InputManagerService.java class InputManagerService { void registerInputChannel(){ nativeRegisterInputChannel(mPtr, inputChannel, inputWindowHandle, false); } } InputManagerService#registerInputChannel() åˆæ˜¯ä¸€ä¸ªç©ºå£³ï¼Œå…·ä½“å®ç°åœ¨ native ï¼Œç»§ç»­å‘ä¸‹è·Ÿ /frameworks/base/services/core/jni/com_android_server_input_InputManagerService.cpp class NativeInputManager { void nativeRegisterInputChannel(){ InputManager-&gt;getDispatcher()-&gt;registerInputChannel(inputChannel, inputWindowHandle, monitor); } } /frameworks/native/services/inputflinger/InputDispatcher.cpp class InputDispatcher { status_t InputDispatcher::registerInputChannel(inputChannel,inputWindowHandle,monitor){ // å°†ä»£è¡¨çª—å£é€šä¿¡çš„ inputChannel ï¼Œä»¥åŠä»£è¡¨çª—å£ä¿¡æ¯çš„ inputWindowHandle å°è£…æˆ Connection å¯¹è±¡ sp&lt;Connection&gt; connection = new Connection(inputChannel, inputWindowHandle, monitor); mConnectionsByFd.add(fd, connection); ... // çœç•¥ IMS ç›‘å¬æ¥è‡ª client çš„ä»£ç ï¼Œè¿™éƒ¨åˆ†æ˜¯å¤„ç† ANR çš„é€»è¾‘ } } NativeInputManager#nativeRegisterInputChannel() éšæ‰‹åˆæ˜¯ä¸€ä¸ªè½¬å‘ åœ¨ InputDispatcher#registerInputChannel() æ–¹æ³•ä¸­ï¼Œç»è¿‡ä¸€ç•ªé•¿é€”è·‹æ¶‰ï¼Œæœ€ç»ˆå°† socket æ³¨å†Œåˆ° InputDispatcherï¼Œä¸€èµ·è¢«æ³¨å†Œè¿‡æ¥çš„è¿˜æœ‰ä»£è¡¨è¯¥çª—å£ä¿¡æ¯çš„ inputWindowHandle ä»£è¡¨çª—å£é€šä¿¡çš„ inputChannel ï¼Œä»¥åŠä»£è¡¨çª—å£ä¿¡æ¯çš„ inputWindowHandle è¢«å°è£…æˆ Connection å¯¹è±¡ï¼Œä¿å­˜åˆ° mConnectionsByFd é›†åˆä¸­ è‡³æ­¤ï¼ŒIMS ç«¯çš„ socket ä¼ é€’å·¥ä½œç»“æŸï¼ŒAPP å’Œ IMS å¯ä»¥æ„‰å¿«çš„é€šä¿¡äº† æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹ å›¾ç‰‡æ¥æºï¼šè‡ªå·±ç”»çš„ è§¦æ‘¸äº‹ä»¶åˆ°è¾¾ ViewRootImpl å¥½äº†ï¼Œä¸‡äº‹ä¿±å¤‡ï¼Œåªæ¬ ä¸œé£ ç°åœ¨ APP è¿›ç¨‹èµ·æ¥äº†ï¼ŒAPP å’Œ IMS ä¹ŸæˆåŠŸå»ºç«‹äº†é€šä¿¡ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æŒ‰ä¸‹å±å¹•ï¼Œçœ‹çœ‹è§¦æ‘¸äº‹ä»¶æ˜¯æ€ä¹ˆåˆ°è¾¾æˆ‘ä»¬ç†Ÿæ‚‰çš„ View çš„ /frameworks/base/core/jni/android_view_InputEventReceiver.cpp class NativeInputEventReceiver { static jlong nativeInit(env, clazz, receiverWeak, inputChannelObj, messageQueueObj) { // ç®€ç•¥å†™æ³• int fd = inputChannelObj-&gt;getFd(); messageQueueObj-&gt;getLooper()-&gt;addFd(fd, 0, events, this, NULL); ... } } åœ¨ä»‹ç» APP ç«¯çš„ socket å›ä¼ ä¸€èŠ‚ä¸­ï¼Œæœ€åä¸€æ­¥åœåœ¨äº† NativeInputEventReceiver#nativeInit() æ–¹æ³•ï¼Œåˆ©ç”¨ Looper ç›‘å¬äº† socketfd ç°åœ¨æˆ‘ä»¬æ¥èŠèŠï¼šå½“ socketfd æœ‰æ¶ˆæ¯æ—¶ï¼ŒAPP ç«¯ä¼šæ€ä¹ˆå¤„ç†ï¼Œäº‹ä»¶æ˜¯æ€ä¹ˆåˆ†å‘åˆ°æ ¹ View çš„ï¼Ÿ /frameworks/base/core/jni/android_view_InputEventReceiver.cpp class NativeInputEventReceiver { int NativeInputEventReceiver::handleEvent( receiveFd, events, data) { switch (type) { // ç®€ç•¥å†™æ³•ï¼Œè¿™æ˜¯ consumeEvents() æ–¹æ³•ä¸­çš„é€»è¾‘ case AINPUT_EVENT_TYPE_KEY: { inputEventObj = factory-&gt;createKeyEvent(); // è½¬æ¢ä¸ºæŒ‰é”®ç±»å‹äº‹ä»¶ KeyEvent } case AINPUT_EVENT_TYPE_MOTION: { inputEventObj = factory-&gt;createMotionEvent(); // è½¬è½¬ä¸ºè§¦æ‘¸ç±»å‹äº‹ä»¶ MotionEvent } } env-&gt;CallVoidMethod(receiverObj.get(),dispatchInputEvent, seq, inputEventObj); // å›è°ƒåˆ° Java } } APP ç«¯çš„ socketfd å‘ç”Ÿäº‹ä»¶å˜åŒ–æ—¶ï¼ŒLooper æ ¹æ®æŒ‡å®šçš„å›è°ƒåœ°å€ï¼Œè°ƒç”¨åˆ° NativeInputEventReceiver#handleEvent() æ–¹æ³• åœ¨ NativeInputEventReceiver#handleEvent() æ–¹æ³•ä¸­ï¼Œæ ¹æ®äº‹ä»¶ç±»å‹ï¼Œåˆ›å»ºä¸åŒçš„äº‹ä»¶å¯¹è±¡ æœ€åï¼Œåˆ©ç”¨ CallVoidMethod å›è°ƒ Java æ–¹æ³•ï¼Œå°†äº‹ä»¶ä¼ é€’åˆ° Java å±‚çš„ InputEventReceiver#dispatchInputEvent() æ–¹æ³• /frameworks/base/core/java/android/view/InputEventReceiver.java abstract class InputEventReceiver { // Called from native code. private void dispatchInputEvent(int seq, InputEvent event) { onInputEvent(event); } } /frameworks/base/core/java/android/view/ViewRootImpl.java class ViewRootImpl extends InputEventReceiver { class WindowInputEventReceiver extends InputEventReceiver { @Override public void onInputEvent(InputEvent event) { enqueueInputEvent(event, this, 0, true); } } void enqueueInputEvent(InputEvent event,InputEventReceiver receiver, int flags, boolean processImmediately) { ... // æ‰§è¡Œæ¶ˆæ¯å…¥åˆ—ä»¥åï¼Œæ¥ç€è¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„æµæ°´çº¿è¿‡ç¨‹ï¼Œæˆ‘ä»¬è¿™é‡Œå…ˆä¸å…³å¿ƒï¼Œç›´æ¥æ¥çœ‹ processPointerEvent() æ–¹æ³• // input æ¶ˆæ¯åˆ°è¾¾ ViewRootImpl åï¼ŒGoogle ä½¿ç”¨è´£ä»»é“¾çš„æ¨¡å¼ï¼Œå°†è¾“å…¥äº‹ä»¶æ‹†åˆ†ä¸º KeyEvent å’Œ MotionEvent ä¸¤ç§ç±»å‹ï¼Œåšè¿›ä¸€æ­¥çš„å¤„ç† // if(event.getType == input) processPointerEvent(event); if(event.getType == key) processKeyEvent(event); } // è´£ä»»é“¾æ¨¡å¼ï¼Œæ¯ä¸ª InputStage è´Ÿè´£ä¸åŒçš„åŠŸèƒ½ï¼Œé“¾ä¸­çš„æŸä¸ª InputStage çš„ç»“æœä¼šå½±å“å¯¹ä¸‹ä¸€èŠ‚ç‚¹çš„æ‰§è¡Œï¼Œæˆ–åœæ­¢ç»§ç»­åˆ†å‘ç­‰ // åœ¨ ViewRootImpl#setView() å‡½æ•°ä¸­æŒ‡å®šè´£ä»»é“¾çš„å‰åé¡ºåºï¼Œè¿™é‡Œä¸å±•å¼€è®¨è®ºï¼Œè¯·æŸ¥çœ‹å‚è€ƒèµ„æ–™åˆ—è¡¨ä¸­ã€Šè¿™ä¸€æ¬¡ï¼Œå¸¦ä½ å½»åº•å¼„æ‡‚ Android äº‹ä»¶åˆ†å‘æœºåˆ¶(å¤–/å†…å±‚è´£ä»»é“¾)ã€‹ class InputStage { // åœ¨ ViewRootImpl ä¸­æœ‰å¥½å‡ ä¸ªåŒå processPointerEvent() æ–¹æ³•ï¼Œ eventTarget é€šå¸¸æ˜¯ ViewRootImpl ä¿å­˜çš„ DecorView å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ä¼šè°ƒç”¨åˆ° View#dispatchPointerEvent() æ–¹æ³• private int processPointerEvent(QueuedInputEvent q) { MotionEvent event = (MotionEvent)q.mEvent; final View eventTarget = mView; // é€šå¸¸æ˜¯ DecorView boolean handled = eventTarget.dispatchPointerEvent(event); ... return handled ? FINISH_HANDLED : FORWARD; } private int processKeyEvent(QueuedInputEvent q) { KeyEvent event = (KeyEvent)q.mEvent; mView.dispatchKeyEvent(event) final View eventTarget = mView; // é€šå¸¸æ˜¯ DecorView boolean handled = eventTarget.dispatchPointerEvent(event); ... return handled ? FINISH_HANDLED : FORWARD; } } } InputEventReceiver æ˜¯æŠ½è±¡ç±»ï¼Œåœ¨ dispatchInputEvent() æ–¹æ³•ä¸­å›è°ƒ onInputEvent() æ–¹æ³•ã€‚ è€Œ ViewRootImpl çš„å†…éƒ¨ç±» WindowInputEventReceiver å®ç°äº† InputEventReceiver ç±»ï¼Œå¹¶ä¸”åœ¨ onInputEvent() å†…éƒ¨åˆè°ƒç”¨äº† enqueueInputEvent() å…¥åˆ—è¾“å…¥æ¶ˆæ¯ æ‰€ä»¥ï¼Œæ¥ä¸‹æ¥çš„åˆ†å‘é€»è¾‘å…¨éƒ¨éƒ½å‘ç”Ÿåœ¨ ViewRootImpl#enqueueInputEvent() æ–¹æ³•ä¸­ èƒœåˆ©çš„æ›™å…‰å°±åœ¨å‰æ–¹ï¼Œç»§ç»­å†² /frameworks/base/core/java/android/view/ViewRootImpl.java class ViewRootImpl extends InputEventReceiver { void enqueueInputEvent(InputEvent event,InputEventReceiver receiver, int flags, boolean processImmediately) { if(event.getType == input) processPointerEvent(event); if(event.getType == key) processKeyEvent(event); } class InputStage { private int processPointerEvent(QueuedInputEvent q) { MotionEvent event = (MotionEvent)q.mEvent; final View eventTarget = mView; // é€šå¸¸æ˜¯ DecorView boolean handled = eventTarget.dispatchPointerEvent(event); ... return handled ? FINISH_HANDLED : FORWARD; } private int processKeyEvent(QueuedInputEvent q);// å¤„ç† key äº‹ä»¶ï¼Œå¿½ç•¥ } } input æ¶ˆæ¯åˆ°è¾¾ ViewRootImpl åï¼Œå°†è¾“å…¥äº‹ä»¶æ‹†åˆ†ä¸º KeyEvent å’Œ MotionEvent ä¸¤ç§ç±»å‹ï¼Œåšè¿›ä¸€æ­¥çš„å¤„ç† Google å›¢é˜Ÿä½¿ç”¨äº†è´£ä»»é“¾æ¨¡å¼æ¥å¤„ç†äº‹ä»¶æ¶ˆæ¯ï¼Œæ¯ä¸ª InputStage è´Ÿè´£ä¸åŒçš„åŠŸèƒ½ï¼Œé“¾ä¸­çš„æŸä¸ª InputStage çš„ç»“æœä¼šå½±å“å¯¹ä¸‹ä¸€èŠ‚ç‚¹çš„æ‰§è¡Œï¼Œæˆ–åœæ­¢åˆ†å‘ç­‰ ViewRootImpl#setView() å‡½æ•°ä¸­æŒ‡å®šäº†è´£ä»»é“¾æ‰§è¡Œçš„å‰åé¡ºåºï¼Œæˆ‘ä»¬è¿™é‡Œä¸å±•å¼€è®¨è®ºï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥æŸ¥çœ‹å‚è€ƒèµ„æ–™åˆ—è¡¨ä¸­ã€Šè¿™ä¸€æ¬¡ï¼Œå¸¦ä½ å½»åº•å¼„æ‡‚ Android äº‹ä»¶åˆ†å‘æœºåˆ¶(å¤–/å†…å±‚è´£ä»»é“¾)ã€‹ ä¸ºäº†çœäº‹ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹ processPointerEvent() å¤„ç†è§¦æ‘¸äº‹ä»¶çš„æ–¹æ³• åœ¨ processPointerEvent() æ–¹æ³•ä¸­ï¼Œå…ˆæ˜¯å°† InputEvent å¼ºè½¬ä¸º MotionEvent ï¼Œç„¶åï¼Œè°ƒç”¨ mView çš„ dispatchPointerEvent() æ–¹æ³•æ‰§è¡Œåˆ†å‘ è§¦æ‘¸äº‹ä»¶åˆ°è¾¾ DecorView äº†è§£ Window åˆ›å»ºæµç¨‹çš„æœ‹å‹è‚¯å®šçŸ¥é“ï¼ŒmView å°±æ˜¯ DecorView ï¼Œé‚£è¿™é‡Œå…¶å®è°ƒç”¨çš„æ˜¯ DecorView#dispatchPointerEvent() æ‰§è¡Œåˆ†å‘ï¼Œæ¥ç€æ¥è·Ÿè¸ª /frameworks/base/core/java/android/view/View.java class View { public final boolean dispatchPointerEvent(MotionEvent event) { if (event.isTouchEvent()) { return dispatchTouchEvent(event); } else { return dispatchGenericMotionEvent(event); } } } DecorView ç»§æ‰¿è‡ª FrameLayout ï¼ŒFrameLayout ç»§æ‰¿è‡ª ViewGroup ï¼ŒViewGroup ç»§æ‰¿è‡ª View View çš„ dispatchPointerEvent() æ˜¯ final å…³é”®å­—ä¿®é¥°çš„ï¼Œä¸å…è®¸å­ç±»é‡å†™ æ‰€ä»¥ï¼Œè°ƒç”¨ DecorView#dispatchPointerEvent() å®é™…çš„æ‰§è¡Œè€…æ˜¯ View åœ¨ View#dispatchPointerEvent() æ–¹æ³•ä¸­ï¼Œé¦–å…ˆåˆ¤æ–­æ˜¯ä¸æ˜¯è§¦æ‘¸äº‹ä»¶ï¼Œé‚£è‚¯å®šæ˜¯å•Š æ¥ç€è°ƒç”¨ dispatchTouchEvent() æ–¹æ³•æ‰§è¡Œåˆ†å‘ dispatchTouchEvent() æ²¡æœ‰è¢« final ä¿®é¥°ï¼Œå¯ä»¥è¢«é‡å†™ï¼Œæ‰€ä»¥æˆ‘ä»¬ç°åœ¨å›åˆ° DecorView çš„ dispatchTouchEvent() æ–¹æ³•ä¸­ /frameworks/base/core/java/com/android/internal/policy/DecorView.java class DecorView extends FrameLayout { @Override public boolean dispatchTouchEvent(MotionEvent ev) { Window.Callback cb = mWindow.getCallback(); // ç»™ Activity å’Œ Dialog æ‹¦æˆªäº‹ä»¶çš„æœºä¼š return cb != null ? cb.dispatchTouchEvent(ev) : super.dispatchTouchEvent(ev); } } åœ¨ DecorView#dispatchTouchEvent() æ–¹æ³•ä¸­ï¼Œå…ˆæ˜¯åˆ¤æ–­äº† mWindow æŒæœ‰çš„ Callback æ˜¯å¦ä¸ºç©º è¿™é‡Œä¸´æ—¶è¡¥å……ä¸¤ä¸ªå°ç»†èŠ‚ Window.Callback æ˜¯ä¸ªæ¥å£ï¼Œè€Œ Activity å’Œ Dialog éƒ½å®ç°äº†è¿™ä¸ªæ¥å£ DecorView æŒæœ‰çš„ mWindow çš„èµ‹å€¼è·¯å¾„æ˜¯è¿™æ ·çš„ï¼šPhoneWindow#setContentView() -&gt; installDecor() -&gt; generateDecor() -&gt; DecorView#setWindow()ï¼Œä¸å±•å¼€è®¨è®ºäº† æ¥ç€çœ‹ä»£ç ï¼Œå¦‚æœ mWindow çš„ Callback ä¸ä¸ºç©ºï¼Œåˆ™ä¼˜å…ˆè°ƒç”¨ Callback çš„ dispatchTouchEvent() å‡½æ•°æ‰§è¡Œåˆ†å‘ æˆ‘ä»¬ä»¥ Activity æ¥ä¸¾ä¾‹ /frameworks/base/core/java/android/app/Activity.java class Activity { public boolean dispatchTouchEvent(MotionEvent ev) { if (getWindow().superDispatchTouchEvent(ev)) { return true; } return onTouchEvent(ev); } public boolean onTouchEvent(MotionEvent event) { ... } } /frameworks/base/core/java/com/android/internal/policy/PhoneWindow.java class PhoneWindow { public boolean superDispatchTouchEvent(MotionEvent event) { return mDecor.superDispatchTouchEvent(event); } } /frameworks/base/core/java/com/android/internal/policy/DecorView.java class DecorView extends FrameLayout { public boolean superDispatchTouchEvent(MotionEvent event) { return super.dispatchTouchEvent(event); } } Activity çš„ dispatchTouchEvent() æ–¹æ³•è¢«è°ƒç”¨åï¼Œå…ˆè°ƒç”¨äº† getWindow().superDispatchTouchEvent(ev) æ‰§è¡Œåˆ†å‘ï¼Œæ²¡äººå¤„ç†å†è°ƒç”¨è‡ªèº«çš„ onTouchEvent() æ–¹æ³• è€Œ getWindow().superDispatchTouchEvent() æ–¹æ³•å…œå…œè½¬è½¬ä¸€åœˆï¼Œè¿˜æ˜¯è°ƒç”¨åˆ° DecorView#superDispatchTouchEvent() ä¸­ å‰é¢è¯´è¿‡äº†ï¼ŒDecorView ç»§æ‰¿è‡ª FrameLayout ï¼ŒFrameLayout æ˜¯æ²¡æœ‰é‡å†™ dispatchTouchEvent() æ–¹æ³•çš„ï¼ŒFrameLayout ç»§æ‰¿è‡ª ViewGroup ï¼ŒViewGroup é‡å†™äº† dispatchTouchEvent() æ‰€ä»¥ï¼Œæœ€ç»ˆæ‰§è¡Œåˆ†å‘çš„è¿˜æ˜¯ ViewGroup#dispatchTouchEvent() æ–¹æ³• åˆç€ç»•äº†ä¸€åœˆï¼ŒActivity æ˜¯å•¥ä¹Ÿæ²¡åšæ˜¯å§ï¼Ÿ ummmm~ æ˜¯çš„ ä¸è¿‡ï¼Œæˆ‘è§‰å¾—è¿™æ ·çš„è®¾è®¡æ˜¯åœ¨ç»™ Activity / Dialog æ‹¦æˆªäº‹ä»¶çš„æœºä¼šï¼Œæ¯•ç«Ÿå¦‚æœæˆ‘ä»¬åœ¨ Activity ä¸­é‡å†™äº† dispatchTouchEvent() æ–¹æ³•ï¼Œæ˜¯å¯ä»¥è®©æ•´æ£µ View æ ‘éƒ½æ¥æ”¶ä¸åˆ°è§¦æ‘¸äº‹ä»¶çš„ å¥½ï¼Œç°åœ¨è§¦æ‘¸äº‹ä»¶åˆ†å‘çš„èµ·ç‚¹åˆ°äº†æˆ‘ä»¬éå¸¸ç†Ÿæ‚‰çš„ ViewGroup#dispatchTouchEvent() è¿™é‡Œ æ¥ä¸‹æ¥çš„ä¸€æ•´ç« ï¼Œæˆ‘ä»¬æ¥å¤ä¹  View / ViewGroup äº‹ä»¶åˆ†å‘çš„æµç¨‹ ä¸‰ã€è§¦æ‘¸äº‹ä»¶çš„æ¶ˆè´¹ï¼ˆApplicationï¼‰ åœ¨ä¹‹å‰çš„ä¸¤èŠ‚å†…å®¹ä¸­ï¼Œä¸€ä¸ª input äº‹ä»¶ä¸€è·¯ä»ç¡¬ä»¶é©±åŠ¨ï¼ŒæˆåŠŸçš„åˆ°è¾¾åº”ç”¨çš„ DecorView æˆ‘ä»¬æ¥ä¸‹æ¥çš„ä»»åŠ¡æ˜¯ï¼ŒæŠŠè¿™ä¸ªäº‹ä»¶åˆ†å‘ç»™æŸä¸ªå…·ä½“çš„ View æˆ–è€…æ˜¯ ViewGroup æ­£æ–‡å¼€å§‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥èŠèŠè§¦æ‘¸äº‹ä»¶çš„æœ¬ä½“ï¼šMotionEvent MotionEvent è¡¨ç¤ºä¸€ä¸ªè§¦æ‘¸äº‹ä»¶ï¼Œé‡Œé¢åŒ…å«äº†äº‹ä»¶çš„ç±»å‹ï¼Œè§¦æ‘¸çš„ä½ç½®ä¿¡æ¯ç­‰ï¼Œå¯¹åˆ†å‘è€…æ¥è¯´ï¼Œäº‹ä»¶çš„ç±»å‹éå¸¸é‡è¦ï¼Œæ¥ç®€å•è®¤è¯†ä¸€ä¸‹ ACTION_DOWNï¼š æŒ‰ä¸‹å±å¹• ACTION_MOVEï¼šæ‰‹æŒ‡æ»‘åŠ¨ ACTION_UPï¼šæŠ¬èµ·æ‰‹æŒ‡ï¼Œç¦»å¼€å±å¹• ACTION_CANCELï¼šéæ­£å¸¸æŠ¬èµ·ï¼Œå‡ ä¹ç­‰åŒäº ACTION_UP ï¼Œé€šå¸¸æ˜¯çˆ¶è§†å›¾æ‹¦æˆª ACTION_POINTER_DOWNï¼šå¤šæŒ‡è§¦æ‘¸ï¼Œè¡¨ç¤ºå·²ç»æœ‰ä¸€åªæ‰‹æŒ‡æŒ‰ä¸‹æ—¶ï¼Œå¦æœ‰ä¸€åªæ‰‹æŒ‡å†æ¬¡æŒ‰ä¸‹ ACTION_POINTER_UPï¼šå¤šæŒ‡è§¦æ‘¸ï¼Œè¡¨ç¤ºå±å¹•ä¸Šå·²ç»æœ‰å¤šä¸ªæ‰‹æŒ‡ï¼ŒæŠ¬èµ·å…¶ä¸­ä¸€åªæ‰‹æŒ‡åè§¦å‘çš„äº‹ä»¶ å‡ ç§å¸¸ç”¨è§¦æ‘¸çš„ç±»å‹å°±è¿™ä¹ˆå¤šï¼Œæœ€åä¸¤ç§æ˜¯å¤šæŒ‡è§¦æ‘¸çš„æƒ…å†µä¸‹æ‰ä¼šæ”¶åˆ°çš„äº‹ä»¶ç±»å‹ï¼Œæœ¬æ–‡æˆ‘ä»¬ä¸æ‰“ç®—è®¨è®ºå¤šæŒ‡è§¦æ‘¸ï¼ˆåŒ…æ‹¬ TouchTargetï¼‰ï¼Œæ‰€ä»¥åé¢ä¼šå¿½ç•¥æ‰ åœ¨ä¸€æ¬¡äº‹ä»¶åˆ†å‘ä¸­ï¼Œä»¥æ¯ä¸ª DOWN äº‹ä»¶ä¸ºå¼€å§‹ï¼Œ UP / CANCEL äº‹ä»¶ä¸ºåœæ­¢ï¼Œåœ¨ DOWN -&gt; MOVE -&gt; MOVE -&gt; UP / CANCEL æ•´ä¸ªè¿‡ç¨‹çœ‹åšæ˜¯ä¸€ä¸ªäº‹ä»¶åºåˆ— ViewGroup çš„æ¶ˆè´¹ã€åˆ†å‘ã€æ‹¦æˆªä¸æ”¾è¡Œ åœ¨è¿›å…¥ ViewGroup çš„æºç ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼šä»€ä¹ˆæ˜¯äº‹ä»¶åˆ†å‘ï¼Ÿ æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œåœ¨ Android å›¾å½¢ç³»ç»Ÿä¸­ï¼Œä¸»è¦ç»˜å›¾çš„ä»»åŠ¡æ˜¯äº¤ç»™ View å»å®Œæˆçš„ï¼ŒViewGroup æ˜¯ä½œä¸ºç®¡ç†è§†å›¾çš„å®¹å™¨ï¼Œå®ƒçš„ä»»åŠ¡æ˜¯æŒ‰ç…§ä¸€å®šçš„è§„åˆ™æ‘†æ”¾å­ Viewï¼Œè‡ªèº«åˆ™åŸºæœ¬ä¸å‚ä¸ç»˜å›¾æ“ä½œ ä½†æ˜¯åœ¨è§¦æ‘¸äº‹ä»¶çš„åˆ†å‘ä¸­ï¼ŒViewGroup å¯¹è§¦æ‘¸äº‹ä»¶çš„æ€åº¦å°±å˜äº†ï¼Œå› ä¸ºå®ƒå’Œå­ View ä¸€æ ·ï¼Œéƒ½å¯èƒ½éœ€è¦å“åº”è§¦æ‘¸äº‹ä»¶ 1ã€ViewGroup å››ç§åœºæ™¯ ä¸¾ä¸ªä¾‹å­ï¼Œæœ‰ä¸€ä¸ªå¯ä»¥çºµå‘æ»‘åŠ¨çš„ ViewGroup ï¼Œé‡Œé¢æ‘†æ»¡äº† TextView ï¼Œç”¨æˆ·åœ¨æ»‘åŠ¨å±å¹•æ—¶ï¼Œè‚¯å®šæ˜¯æœŸæœ›å±•ç¤ºæ›´å¤šå†…å®¹çš„ã€‚é‚£ä¹ˆè¿™æ—¶å€™ï¼Œå°±éœ€è¦ ViewGroup å¯¹å­ View é‡æ–°å¸ƒå±€æ‘†æ”¾ï¼Œå°†éšè—åœ¨å±å¹•åº•éƒ¨çš„å­ View æ˜¾ç¤ºå‡ºæ¥ å›¾ç‰‡æ¥æºï¼šè‡ªå·±å½•çš„ ä¸Šé¢çš„åœºæ™¯ä¸­ï¼ŒViewGroup å¿…é¡»è¦æ‹¿åˆ°ç”¨æˆ·æ»‘åŠ¨å±å¹•çš„æ•°æ®ï¼Œæ‰èƒ½è®¡ç®—å±•ç¤ºå¤šå°‘è§†å›¾æ‰ç®—åˆé€‚ å³ï¼ŒViewGroup éœ€è¦æ¶ˆè´¹è§¦æ‘¸äº‹ä»¶ å†ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨ä¸€ä¸ªä¸æ”¯æŒæ»‘åŠ¨çš„ ViewGroup ä¸­ï¼Œæœ‰ä¸ªå±…ä¸­æ˜¾ç¤ºçš„ Button æŒ‰é’® å›¾ç‰‡æ¥æºï¼šè‡ªå·±å½•çš„ ç”¨æˆ·æŒ‰ä¸‹å±å¹•åï¼ŒViewGroup è‚¯å®šæ¯”è‡ªå·±çš„å­ View è¦ä¼˜å…ˆæ‹¿åˆ°è§¦æ‘¸äº‹ä»¶ è€Œ ViewGroup è‡ªèº«åˆä¸éœ€è¦è¿™ä¸ªäº‹ä»¶ï¼Œé‚£ä¹ˆï¼Œå®ƒå°±éœ€è¦æ ¹æ®è§¦æ‘¸ä½ç½®å»æŸ¥æ‰¾ï¼Œæœ‰æ²¡æœ‰å­ View éœ€è¦è¯¥äº‹ä»¶ ç»è¿‡è®¡ç®—ï¼Œå¦‚æœå‘ç°ç”¨æˆ·æŒ‰åäº†ï¼Œæ²¡ç‚¹åˆ° Button ï¼Œé‚£å°±ä¸ç®¡äº†ï¼ŒdispatchTouchEvent() è¿”å› false ï¼Œçˆ±è°æ¶ˆè´¹è°æ¶ˆè´¹ï¼Œåæ­£æˆ‘ä¸è¦ å¦‚æœå‘ç°ç”¨æˆ·æŒ‰åˆ°äº†ä¸­é—´çš„ Button ï¼Œè¿™æ—¶å€™ ViewGroup å°±éœ€è¦æŠŠè¿™ä¸ªäº‹ä»¶äº¤ç»™ Button ï¼Œè¯¢é—®å­ View è¦ä¸è¦æ¶ˆè´¹ å³ï¼Œ ViewGroup éœ€è¦åˆ†å‘äº‹ä»¶ å†å†ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨ä¸€ä¸ªæ”¯æŒçºµå‘æ»‘åŠ¨çš„ ViewGroup ä¸­ï¼Œæœ‰ä¸ªå±…ä¸­æ˜¾ç¤ºçš„ Button æŒ‰é’® ç°åœ¨ï¼Œç”¨æˆ·æŒ‰ä¸‹äº†å±å¹•ä¸­çš„ Button ï¼ŒViewGroup è§‰å¾—ä¸æ˜¯æ»‘åŠ¨äº‹ä»¶ï¼Œå°±æŠŠè¿™ä¸ªäº‹ä»¶åˆ†å‘ç»™äº† Button ä½†æ˜¯ç”¨æˆ·åœ¨æŒ‰ä¸‹ Button åï¼Œæ¥ç€åˆå¼€å§‹æ»‘åŠ¨å±å¹•äº† å›¾ç‰‡æ¥æºï¼šè‡ªå·±å½•çš„ æ­¤æ—¶çš„ ViewGroup éœ€è¦è®¡ç®—æ»‘åŠ¨è·ç¦»ï¼Œæ‰€ä»¥æ˜¯éœ€è¦è¿™ä¸ªè§¦æ‘¸äº‹ä»¶çš„ï¼Œé‚£åªèƒ½å¯¹ä¸èµ· Button äº†ï¼ŒViewGroup ä¼šæŠŠæœ¬æ¥å‡†å¤‡åˆ†å‘ç»™ Button çš„äº‹ä»¶æ‹¦æˆªæ¶ˆè´¹æ‰ å³ï¼ŒViewGroup éœ€è¦æ‹¦æˆªäº‹ä»¶ å¦å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è€ƒè™‘ä¸€ç§æç«¯æƒ…å†µï¼šå¦‚æœå­ View å’Œ ViewGroup éƒ½éœ€è¦è§¦æ‘¸äº‹ä»¶ï¼Œåº”è¯¥æ€ä¹ˆå¤„ç†ï¼Ÿ æŒ‰æ­£å¸¸çš„æ‹¦æˆªé€»è¾‘ï¼ŒViewGroup å…ˆæ‹¿åˆ°äº‹ä»¶ï¼Œè‡ªå·±åˆæœ‰æ¶ˆè´¹çš„éœ€æ±‚ï¼Œè‚¯å®šæ˜¯ç´§ç€è‡ªå·±ç”¨ ä½†æ˜¯ï¼Œæ€»ä¼šæœ‰åœºæ™¯éœ€è¦å°†äº‹ä»¶ä¼˜å…ˆåˆ†å‘ç»™å­è§†å›¾ï¼Œæ¯”å¦‚ï¼š åœ¨ä¸€ä¸ªæ”¯æŒçºµå‘æ»šåŠ¨çš„ ViewGroup ï¼Œå®ƒçš„ä¸¤ä¸ªå­ View åŒæ ·æ˜¯æ”¯æŒçºµå‘æ»šåŠ¨çš„ ViewGroup ï¼Œä¸¤ä¸ªå­ View åˆ†åˆ«éƒ½åŒ…å«è‹¥å¹² TextView ç°åœ¨çš„éœ€æ±‚æ˜¯ï¼šé•¿æŒ‰æŸä¸€ä¸ª TextView æ—¶ï¼Œå…è®¸è¯¥ TextView ä¸Šä¸‹è‡ªç”±æ‹–åŠ¨ å›¾ç‰‡æ¥æºï¼šè‡ªå·±å½•çš„ å½“ç”¨æˆ·é•¿æŒ‰ TextView ç§»åŠ¨æ—¶ï¼Œé¢„æœŸæ˜¯ç§»åŠ¨è¿™ä¸ª TextViewï¼Œç†è®ºä¸Šè¿™ä¸ªç§»åŠ¨äº‹ä»¶åº”è¯¥è¢« TextView çš„çˆ¸çˆ¸æ¶ˆè´¹æ‰ï¼Œå› ä¸ºéœ€è¦é‡æ–°å¸ƒå±€ç»˜åˆ¶ï¼› ä½†å®é™…ä¸Šæ˜¯ TextView çš„çˆ·çˆ·æ¶ˆè´¹æ‰çš„ï¼Œå› ä¸ºçˆ·çˆ·è§‰å¾—ç”¨æˆ·æ˜¯åœ¨æ»‘åŠ¨å±å¹•ï¼Œè¦æŠŠå±å¹•ä¸‹æ–¹æ›´å¤šçš„è§†å›¾æ˜¾ç¤ºå‡ºæ¥ ViewGroup å’Œ ViewGroup ä¸­çš„å­ View éƒ½æƒ³è¦æ¶ˆè´¹äº‹ä»¶ï¼ˆæ»‘åŠ¨å†²çªï¼‰ï¼Œè¿™æ—¶å€™è¯¥æ€ä¹ˆåŠï¼Ÿ å¾ˆç®€å•ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ç§æœºåˆ¶ï¼Œè®© ViewGroup çŸ¥é“å­ View ä¹Ÿéœ€è¦è¿™ä¸ªäº‹ä»¶ æˆ‘ä»¬æš‚ä¸”æŠŠè¿™å¥—æœºåˆ¶ç§°ä¹‹ä¸º â€œè¯·æ±‚æ”¾è¡Œâ€ å¥½äº† ViewGroup ä¸ºå­ View å¼€æ”¾ä¸€ä¸ªè¯·æ±‚æ”¾è¡Œçš„æ¥å£ï¼Œå½“ ViewGroup æ”¶åˆ°æ¥è‡ªå­ View çš„æ”¾è¡Œè¯·æ±‚æ—¶ï¼Œä¼˜å…ˆå°†äº‹ä»¶åˆ†å‘ç»™å­ Viewï¼Œè¿™æ ·ï¼Œé—®é¢˜å°±è§£å†³äº† è§¦æ‘¸äº‹ä»¶çš„æ¶ˆè´¹ã€æ‹¦æˆªã€æ”¾è¡Œä¸åˆ†å‘ï¼Œè¿™å››ç§æƒ…å†µå‡ ä¹è¦†ç›–äº† ViewGroup å¯¹è§¦æ‘¸äº‹ä»¶å¤„ç†ï¼ˆå•æŒ‡ï¼‰çš„æ‰€æœ‰åœºæ™¯ å¥½ï¼Œç°åœ¨ ViewGroup çš„éœ€æ±‚åŸºæœ¬ä¸Šäº†è§£æ¸…æ¥šäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹æºç ä¸­ï¼Œ Google æ˜¯æ€ä¹ˆè¿›è¡Œä»£ç è®¾è®¡çš„ 2ã€äº‹ä»¶çš„æ”¾è¡Œå’Œæ‹¦æˆª ç¬¬äºŒç« ç»“æŸæ—¶ï¼Œæœ€ç»ˆè°ƒç”¨åœåœ¨äº† ViewGroup#dispatchTouchEvent() æ–¹æ³•ï¼Œè¿™ä¹Ÿæ˜¯æ•´ä¸ª View / ViewGroup äº‹ä»¶åˆ†å‘çš„èµ·æº /frameworks/base/core/java/android/view/ViewGroup.java class ViewGroup extends View { public boolean dispatchTouchEvent(MotionEvent ev) { int actionMasked = ev.getAction() &amp; MotionEvent.ACTION_MASK; TouchTarget newTouchTarget = null; boolean intercepted; boolean handled = false; if (actionMasked == MotionEvent.ACTION_DOWN|| mFirstTouchTarget != null) { // æ£€æŸ¥å­è§†å›¾æ˜¯å¦è°ƒç”¨äº† requestDisallowInterceptTouchEvent(true) è¯·æ±‚æ”¾è¡Œ boolean disallowIntercept = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != 0; if (!disallowIntercept) { intercepted = onInterceptTouchEvent(ev); // å­è§†å›¾æœªè¯·æ±‚æ”¾è¡Œï¼Œè¯¢é—® ViewGroup è‡ªèº«æ˜¯å¦éœ€è¦æ¶ˆè´¹ } else { intercepted = false; } } else { intercepted = true; // å¦‚æœ mFirstTouchTarget ä¸ºç©ºï¼Œå¹¶ä¸”äº‹ä»¶ç±»å‹ä¸ä¸º DOWN ï¼Œè¡¨ç¤ºå…ˆå‰çš„äº‹ä»¶ä¹Ÿæ˜¯ ViewGroup è‡ªå·±æ¶ˆè´¹çš„ï¼Œæ— éœ€æ‰§è¡Œåˆ†å‘ï¼Œå†æ¬¡äº¤ç»™è‡ªå·±æ‰§è¡Œå³å¯ } return handled; } public boolean onInterceptTouchEvent(MotionEvent ev) { //è¯¢é—® ViewGroup è‡ªèº«æ˜¯å¦éœ€è¦å¤„ç†äº‹ä»¶ return false; } public void requestDisallowInterceptTouchEvent(boolean disallowIntercept) { if (disallowIntercept) { mGroupFlags |= FLAG_DISALLOW_INTERCEPT; } else { mGroupFlags &amp;= ~FLAG_DISALLOW_INTERCEPT; } } } ViewGroup çš„å‡ ç§åœºæ™¯æˆ‘ä»¬å·²ç»åœ¨ä¸Šé¢ä»‹ç»è¿‡äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å¯¹ç…§æºç è§£é‡Šçš„è¿‡ç¨‹ï¼Œæ¯”è¾ƒè½»æ¾ åœ¨äº‹ä»¶åˆ†å‘çš„å¼€å§‹ï¼Œå…ˆæ˜¯åˆ¤æ–­äº†äº‹ä»¶æ˜¯å¦æ˜¯ DOWN ç±»å‹ï¼Œæˆ–è€… mFirstTouchTarget å˜é‡æ˜¯å¦ä¸ä¸ºç©ºï¼ˆmFirstTouchTarget è®°å½•çš„æ˜¯æ¶ˆè´¹ä¸Šä¸€æ¬¡ DOWN äº‹ä»¶çš„æ˜¯è°ï¼‰ æ»¡è¶³æ¡ä»¶åˆ™è¿›å…¥ â€œæ£€æŸ¥æ”¾è¡Œâ€ å’Œ â€œæ£€æŸ¥æ˜¯å¦è¦æ‹¦æˆªâ€ çš„é€»è¾‘ disallowIntercept ä¸º true ï¼Œè¡¨ç¤ºå­è§†å›¾æ˜¯å¦è°ƒç”¨äº† requestDisallowInterceptTouchEvent(true) æ–¹æ³•è¯·æ±‚æ”¾è¡Œï¼Œå°† intercepted æ ‡è¯†ç½®ä¸ºfalse ï¼Œå¹¶ä¸”ï¼Œæœ¬æ¬¡äº‹ä»¶å°†ä¸è¯¢é—® ViewGroup è‡ªèº«æ˜¯å¦è¦æ¶ˆè´¹ ViewGroup#requestDisallowInterceptTouchEvent() æ–¹æ³•å°±æ˜¯ä¹‹å‰ä»‹ç»è¿‡çš„ï¼Œå¼€æ”¾ç»™å­ View è¯·æ±‚æ”¾è¡Œçš„ä¸€å¥—æœºåˆ¶ å¦‚æœå­è§†å›¾æ²¡æœ‰è¯·æ±‚æ”¾è¡Œï¼Œé‚£ä¹ˆè°ƒç”¨ onInterceptTouchEvent() è¯¢é—®è‡ªå·±è¦ä¸è¦æ‹¦æˆªæ¶ˆè´¹ï¼Œä¸éœ€è¦æ¶ˆè´¹äº‹ä»¶ä¼šç»§ç»­åˆ†å‘ï¼Œæˆ‘ä»¬åé¢ä¼šè®²åˆ° å¦‚æœ mFirstTouchTarget ä¸ºç©ºï¼Œå¹¶ä¸”äº‹ä»¶ç±»å‹ä¸ä¸º DOWN ï¼Œè¡¨ç¤ºå…ˆå‰çš„äº‹ä»¶ä¹Ÿæ˜¯ ViewGroup è‡ªå·±æ¶ˆè´¹çš„ï¼Œæ— éœ€æ‰§è¡Œåˆ†å‘ï¼Œå†æ¬¡äº¤ç»™è‡ªå·±æ‰§è¡Œå³å¯ï¼Œå°† intercepted å˜é‡ç½®ä¸º true ä¸Šé¢è¿™æ®µä»£ç è§£é‡Šå®Œäº†ï¼Œæˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹å¾—åˆ°çš„ä¿¡æ¯ï¼š åªè¦å­ View æ²¡æœ‰è°ƒç”¨ requestDisallowInterceptTouchEvent() æ–¹æ³•è¯·æ±‚æ”¾è¡Œï¼ŒViewGroup æœ‰æƒåœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œé€šè¿‡è°ƒç”¨ onInterceptTouchEvent() è¿”å› true çš„æ–¹å¼ï¼Œæ‹¦æˆªä»»ä¸€è§¦æ‘¸äº‹ä»¶ æˆ‘ä»¬åœ¨ç»§æ‰¿ ViewGroup ä»¥åï¼Œé¦–å…ˆè¦é‡å†™ onInterceptTouchEvent() æ–¹æ³•ï¼Œç„¶åæˆ‘ä»¬æ ¹æ®è‡ªå·±çš„éœ€æ±‚ï¼Œåˆ¤æ–­è¦ä¸è¦æ¶ˆè´¹æŸä¸ªäº‹ä»¶ true è¡¨ç¤ºè‡ªèº«éœ€è¦æ¶ˆè´¹ï¼Œè¯¥äº‹ä»¶å°†ä¼šè¢«æ‹¦æˆªï¼Œå¹¶ä¼šåœ¨ä¸‹ä¸€æ­¥å‘é€åˆ° ViewGroup è‡ªèº«çš„ onTouchEvent() æ–¹æ³•ä¸­ï¼Œä¸ä¼šç»§ç»­å‘ä¸‹åˆ†å‘ false è¡¨ç¤ºä¸æ¶ˆè´¹ï¼Œç»§ç»­å‘ä¸‹åˆ†å‘äº‹ä»¶ ViewGroup çš„æ”¾è¡Œæœºåˆ¶å’Œæ‹¦æˆªå°±ç»“æŸäº†ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹ä»£ç ï¼Œä¸‹ä¸€æ­¥è¯¥æ‰§è¡Œäº‹ä»¶çš„åˆ†å‘äº† 3ã€äº‹ä»¶çš„åˆ†å‘ å¦‚æœå­è§†å›¾æ²¡æœ‰è¯·æ±‚æ”¾è¡Œï¼ŒViewGroup è‡ªèº«ä¹Ÿä¸æ¶ˆè´¹ï¼Œé‚£ä¹ˆ intercepted æ ‡è¯†ä¸º false ï¼Œè¿›å…¥åˆ†å‘æµç¨‹ /frameworks/base/core/java/android/view/ViewGroup.java class ViewGroup extends View { public boolean dispatchTouchEvent(MotionEvent ev) { ... // å­è§†å›¾æœªè¯·æ±‚æ”¾è¡Œï¼ŒViewGroup è‡ªèº«ä¹Ÿä¸æ¶ˆè´¹ï¼Œè¿›å…¥åˆ†å‘æµç¨‹ if (!intercepted) { if (actionMasked == MotionEvent.ACTION_DOWN) { for (int i = mChildrenCount - 1; i &gt;= 0; i--) { ...// æ£€æŸ¥å­ View æ˜¯å¦å¯è§¦æ‘¸ï¼Œæ˜¯å¦åœ¨è§¦æ‘¸åŒºåŸŸå†…ç­‰ç­‰ï¼Œè¿‡ç¨‹ç•¥ // æ‰¾åˆ°åˆé€‚çš„å­ View åï¼Œè°ƒç”¨ dispatchTransformedTouchEvent() æ‰§è¡Œäº‹ä»¶åˆ†å‘ï¼Œå¦‚æœè¿”å› trueï¼Œè®°å½•æœ¬æ¬¡åˆ†å‘ if (dispatchTransformedTouchEvent(ev, false, child, idBitsToAssign)) { newTouchTarget = addTouchTarget(child, idBitsToAssign); // ç”Ÿæˆä¸€ä¸ªæ–°çš„ TouchTarget å¯¹è±¡ï¼Œç”¨äºè®°å½•æ¶ˆè´¹çš„ View break; } } // æ²¡æœ‰æ–°çš„éœ€è¦è§¦æ‘¸äº‹ä»¶çš„è§†å›¾ï¼Œé‚£ä¹ˆï¼ŒæŠŠé“¾è¡¨å°¾éƒ¨çš„ TouchTarget æ‹¿å‡ºæ¥ï¼Œåœ¨ä¸‹ä¸€æ­¥æŠŠäº‹ä»¶åˆ†å‘ç»™å®ƒ if (newTouchTarget == null &amp;&amp; mFirstTouchTarget != null) { newTouchTarget = mFirstTouchTarget; while (newTouchTarget.next != null) { newTouchTarget = newTouchTarget.next; } } } } return handled; } private boolean dispatchTransformedTouchEvent(MotionEvent event, boolean cancel,View child, int desiredPointerIdBits) { boolean handled; if (child == null) { handled = super.dispatchTouchEvent(event); // ViewGroup ç»§æ‰¿è‡ª View ï¼Œè¿™é‡Œè°ƒç”¨çš„æ˜¯ View#dispatchTouchEvent() } else { handled = child.dispatchTouchEvent(event); } return handled; } } åˆ†å‘çš„è¿‡ç¨‹æ˜¯å°†æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„å­ View éƒ½è¯¢é—®ä¸€é åœ¨ä¸Šé¢è¿™æ®µä»£ç ä¸­ï¼Œä½¿ç”¨ for å¾ªç¯éå†æ‰€æœ‰çš„å­ View ï¼Œæ£€æŸ¥æ¯ä¸ªå­ View æ˜¯å¦åœ¨è§¦æ‘¸åŒºåŸŸï¼Œæ˜¯å¦å¯ä»¥è¢«è§¦æ‘¸ç­‰ç­‰ å¦‚æœæ‰¾åˆ°åˆé€‚çš„å­ View ï¼Œè°ƒç”¨ dispatchTransformedTouchEvent() æ‰§è¡Œåˆ†å‘ï¼Œå¹¶è®°å½•æ¶ˆè´¹çš„ç»“æœ æ‰€æœ‰çš„å­ View éå†ä¸€éåï¼Œå¦‚æœå‘ç°æ²¡æœ‰æ¶ˆè´¹çš„è§†å›¾ï¼Œå¹¶ä¸”ï¼Œå½“å‰ mFirstTouchTarget ä¸ä¸ºç©ºï¼Œé‚£ç›´æ¥å°†ä¿ç•™ç€ä¸Šä¸€æ¬¡æ¶ˆè´¹çš„ View æœ€è¿‘çš„ä¸€ä¸ª TouchTarget æ‹¿å‡ºæ¥ï¼Œç­‰å¾…ä¸‹ä¸€æ­¥æ‰§è¡Œ 4ã€äº‹ä»¶çš„æ¶ˆè´¹ äº‹ä»¶çš„æ¶ˆè´¹ä»£ç æ¯”è¾ƒç®€å•ï¼š /frameworks/base/core/java/android/view/ViewGroup.java class ViewGroup extends View { public boolean dispatchTouchEvent(MotionEvent ev) { ... // è·‘åˆ°è¿™ï¼Œå¦‚æœ mFirstTouchTarget è¿˜æ˜¯ä¸ºç©º ï¼Œè¡¨ç¤ºè¿™ä¸ªäº‹ä»¶ ViewGroup è‡ªèº«è¦æ¶ˆè´¹ if (mFirstTouchTarget == null) { handled = dispatchTransformedTouchEvent(ev,canceled,null,TouchTarget.ALL_POINTER_IDS); } else { TouchTarget target = mFirstTouchTarget; // éå† TouchTarget é“¾è¡¨ï¼Œæ‰§è¡Œäº‹ä»¶åˆ†å‘ï¼Œä»£ç æœ‰å»é‡æ“ä½œï¼Œè¢«æˆ‘åˆ äº†ï¼Œå³ä¹‹å‰åˆ†å‘è¿‡çš„æ–°æ·»åŠ çš„èŠ‚ç‚¹ï¼Œä¸å†æ‰§è¡Œåˆ†å‘ while (target != null) { final TouchTarget next = target.next; if (dispatchTransformedTouchEvent(ev, cancelChild,target.child, target.pointerIdBits)) { handled = true; } target = next; } } return handled; } private boolean dispatchTransformedTouchEvent(MotionEvent event, boolean cancel,View child, int desiredPointerIdBits) { boolean handled; if (child == null) { handled = super.dispatchTouchEvent(event); // ViewGroup ç»§æ‰¿è‡ª View ï¼Œè¿™é‡Œè°ƒç”¨çš„æ˜¯ View#dispatchTouchEvent() } else { handled = child.dispatchTouchEvent(event); } return handled; } } å¦‚æœ mFirstTouchTarget ä¸ºç©º ï¼Œè¡¨ç¤ºè¿™ä¸ªäº‹ä»¶ ViewGroup è‡ªèº«è¦æ¶ˆè´¹ï¼Œè°ƒç”¨ dispatchTransformedTouchEvent() æ–¹æ³• åœ¨ dispatchTransformedTouchEvent() æ–¹æ³•ä¸­ï¼Œå¦‚æœ child å‚æ•°ä¸ºç©ºï¼Œè¡¨ç¤ºæ˜¯ ViewGroup è¦æ¶ˆè´¹ï¼Œé‚£ä¹ˆè°ƒç”¨ ViewGroup çš„çˆ¶ç±»ï¼š View#dispatchTouchEvent() dispatchTouchEvent() æ–¹æ³•æœ€ç»ˆæŠŠäº‹ä»¶ä¼ é€’ç»™ onTouchEvent() ï¼Œæˆ‘ä»¬é©¬ä¸Šå°±èƒ½çœ‹åˆ° View çš„æ¶ˆè´¹æµç¨‹äº† å¦‚æœ mFirstTouchTarget å¯¹è±¡ä¸ä¸ºç©ºï¼Œè¯´æ˜æœ‰å…¶ä»–å­ View æ¶ˆè´¹äº†äº‹ä»¶ï¼ˆå¯èƒ½æœ‰å¤šä¸ªï¼‰ï¼Œä¾æ—§è°ƒç”¨ dispatchTransformedTouchEvent() æ‰§è¡Œåˆ†å‘ å¥½äº†ï¼ŒViewGroup çš„ æ¶ˆè´¹ã€åˆ†å‘ã€æ‹¦æˆªä¸æ”¾è¡Œï¼Œåˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ View#dispatchTouchEvent() çš„æµç¨‹ View çš„æ¶ˆè´¹ èŠå®Œäº† ViewGroup å¯¹è§¦æ‘¸äº‹ä»¶çš„å¤„ç†ï¼Œæˆ‘ä»¬æ¥ç€æ¥èŠ View è¿™è¾¹æ˜¯æ€ä¹ˆå¤„ç†è§¦æ‘¸äº‹ä»¶çš„ åœ¨ä¸Šä¸€èŠ‚çš„ dispatchTransformedTouchEvent() æ–¹æ³•ä¸­ï¼Œæ— è®ºæ‰§è¡Œçš„æ˜¯ super.dispatchTouchEvent(event) æ–¹æ³•ï¼Œè¿˜æ˜¯ child.dispatchTouchEvent(event) æ–¹æ³•ï¼Œæœ€ç»ˆéƒ½æ˜¯è°ƒç”¨åˆ° View#dispatchTouchEvent() ä¸­ View#dispatchTouchEvent() é€»è¾‘æ¯”è¾ƒå°‘ï¼Œé‡è¦ä»£ç åªæœ‰ä¸€å¥ï¼Œè°ƒç”¨äº† onTouchEvent() æ¶ˆè´¹äº‹ä»¶ï¼Œé™¤æ­¤ä¹‹å¤– View çš„äº‹ä»¶åˆ†å‘å°±æ²¡ä»€ä¹ˆå¥½èŠçš„äº† //frameworks/base/core/java/android/view/View.java class View { public boolean dispatchTouchEvent(MotionEvent event) { boolean result = onTouchEvent(event); return result; } public boolean onTouchEvent(MotionEvent event) { return false; } } å¥½äº†ï¼ŒView / ViewGroup çš„äº‹ä»¶åˆ†å‘åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œå½“ç„¶æˆ‘ä»¬çœ‹åˆ°çš„æ˜¯éå¸¸ç²¾ç®€çš„ç‰ˆæœ¬äº†ï¼Œåªæœ‰ä¸‰ä¸¤ä¸ªå…³é”®å‡½æ•°ï¼Œå¹¶ä¸”å‡ ä¹æ²¡æœ‰ä»»ä½•ç»†èŠ‚ å› ä¸º View / ViewGroup çš„äº‹ä»¶åˆ†å‘æ¯”è¾ƒç®€å•ï¼Œä¸åƒ Framework çš„é€»è¾‘ï¼Œç»•æ¥ç»•å»çš„ï¼Œäº‹ä»¶åˆ†å‘çš„é€»è¾‘å¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨å†…éƒ¨åšè·³è½¬ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹è‡ªå·±å»è·Ÿä¸€éæºç å¾ˆå¿«å°±äº†è§£æ¸…æ¥šäº† å››ã€ç»“è¯­ æœ¬ç¯‡æ–‡ç« ç¨å¾®æœ‰ç‚¹é•¿ï¼Œä»ç¡¬ä»¶é©±åŠ¨ï¼Œç³»ç»Ÿå†…æ ¸ï¼Œåˆ° Framework éƒ½æœ‰æ¶‰åŠã€‚å…¶ä¸­ï¼Œäº†è§£ IMS çš„å®ç°åŸç†ï¼ŒAPP å’Œ IMS é€šä¿¡çš„å»ºç«‹ï¼Œä»¥åŠ ViewGroup çš„ dispatchTouchEvent() æ–¹æ³•çš„äº‹ä»¶æ´¾å‘é€»è¾‘ï¼Œæ˜¯æœ¬ç¯‡æ–‡ç« æ¯”è¾ƒé‡è¦çš„å†…å®¹ åœ¨æ–‡ç« çš„æœ€åï¼Œæˆ‘ä»¬ç”¨å¼ å¤§ä¼Ÿè€å¸ˆã€Šæ·±å…¥ç†è§£Android å·IIIã€‹ä¹¦ä¸­çš„ä¸€æ®µè¯ä½œä¸ºæœ¬æ–‡æ€»ç»“ï¼š ç®€å•æ¥è¯´ï¼Œå†…æ ¸å°†åŸå§‹äº‹ä»¶å†™å…¥åˆ°è®¾å¤‡æ–‡ä»¶ä¸­ï¼ŒInputReader ä¸æ–­åœ°é€šè¿‡ EventHub å°†åŸå§‹äº‹ä»¶å–å‡ºæ¥ï¼Œè§£æåŠ å·¥æˆ KeyEventã€MotionEvent äº‹ä»¶ï¼Œç„¶åäº¤ç»™ InputDispatcher InputDispatcher æ ¹æ® WMS æä¾›çš„çª—å£ä¿¡æ¯å°†äº‹ä»¶äº¤ç»™åˆé€‚çš„çª—å£ æ¥ç€ï¼Œçª—å£çš„ ViewRootImpl å¯¹è±¡å†æ²¿ç€æ§ä»¶æ ‘å°†äº‹ä»¶æ´¾å‘ç»™æ„Ÿå…´è¶£çš„æ§ä»¶ï¼Œæ§ä»¶å¯¹å…¶æ”¶åˆ°çš„äº‹ä»¶ä½œå‡ºå“åº”ï¼Œæ›´æ–°è‡ªå·±çš„ç”»é¢ã€æ‰§è¡Œç‰¹å®šçš„åŠ¨ä½œ æ‰€æœ‰è¿™äº›å‚ä¸è€…ä»¥ IMS ä¸ºæ ¸å¿ƒï¼Œæ„å»ºäº† Android åºå¤§è€Œå¤æ‚çš„è¾“å…¥ä½“ç³»ã€‚ å¥½äº†ï¼Œæœ¬ç¯‡æ–‡ç« åˆ°è¿™é‡Œå°±å…¨éƒ¨ç»“æŸäº†ã€‚æ–‡ä¸­æåˆ°çš„ç¡¬ä»¶é©±åŠ¨å’Œç³»ç»Ÿå†…æ ¸è¿™ä¸¤å—æš‚æ—¶è¿˜ä¸æ˜¯æˆ‘æ“…é•¿çš„é¢†åŸŸï¼Œæ‰€ä»¥å¦‚æœå„ä½å¤§ä½¬å‘ç°æœ¬æ–‡æœ‰å†™çš„ä¸å¯¹çš„åœ°æ–¹ï¼Œè¿˜æœ›åŠæ—¶æŒ‡å‡ºï¼Œæˆ‘ä¼šç¬¬ä¸€æ—¶é—´æ”¹æ­£ï¼Œæ„Ÿè°¢ å¦å¤–ï¼Œæ¬¢è¿å„ä½å¤§ä½¬ç»™æˆ‘ç•™è¨€ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥æ¢è®¨æŠ€æœ¯é—®é¢˜ å…¨æ–‡å®Œ äº”ã€å‚è€ƒèµ„æ–™ ã€Šæ·±å…¥ç†è§£Android å·III - å¼ å¤§ä¼Ÿã€‹ ç”µé˜»å±å·²ç»è¢«æ™ºèƒ½æ‰‹æœºæŠ›å¼ƒï¼Œè¿˜æœ‰å“ªäº›åº”ç”¨åœºæ™¯ï¼Ÿ æ‰‹æœºå…¨è´´åˆå±å¹•æŠ€æœ¯è§£æ ã€Linuxé©±åŠ¨ã€‘I2Cå­ç³»ç»Ÿä¸è§¦æ‘¸å±é©±åŠ¨ - @hongZ ã€Linuxé©±åŠ¨ã€‘inputå­ç³»ç»Ÿä¸æŒ‰é”®é©±åŠ¨ - @hongZ Linuxé©±åŠ¨å¼€å‘|inputå­ç³»ç»Ÿ - å®‰è¿ªè¥¿ ä» 0 å¼€å§‹å­¦ Linux é©±åŠ¨å¼€å‘ - Hcamael Android(Linux) è¾“å…¥å­ç³»ç»Ÿè§£æ - Andy Lee Android å¦‚ä½•ä¸ŠæŠ¥ Touchevent ç»™åº”ç”¨å±‚ - è‘£åˆš è¿™ä¸€æ¬¡ï¼Œå¸¦ä½ å½»åº•å¼„æ‡‚ Android äº‹ä»¶åˆ†å‘æœºåˆ¶(å¤–/å†…å±‚è´£ä»»é“¾) - ä¼¤å¿ƒçš„çŒªå¤§è‚  Android è§¦æ‘¸äº‹ä»¶åˆ†å‘æœºåˆ¶ï¼ˆä¸€ï¼‰ä»å†…æ ¸åˆ°åº”ç”¨ ä¸€åˆ‡çš„å¼€å§‹ - å´è¿ª Android è§¦æ‘¸äº‹ä»¶åˆ†å‘æœºåˆ¶ï¼ˆäºŒï¼‰åŸå§‹äº‹ä»¶æ¶ˆæ¯ä¼ é€’ä¸åˆ†å‘çš„å¼€å§‹ - å´è¿ª Androidäº‹ä»¶åˆ†å‘æœºåˆ¶äºŒï¼šæ ¸å¿ƒåˆ†å‘é€»è¾‘æºç è§£æ - ä¸€åªä¿®ä»™çš„çŒ¿ InputChannel and InputDispatcher in Android ","link":"https://yibaoshan.github.io/post/android-graphics-input/"},{"title":"è¯»ä¹¦ç¬”è®°ï¼šåå¤©å­¦ä¼š51å•ç‰‡æœº","content":" ç‚¹å‡»è·³è½¬åˆ°æ˜é‡‘é˜…è¯» &quot;å¥½è®°æ€§ä¸å¦‚çƒ‚ç¬”å¤´&quot;ï¼Œè¯»ä¹¦ç¬”è®°ç³»åˆ—æ˜¯ä¸ºäº†è®°å½•è‡ªå·±çš„è¯»ä¹¦å¿ƒå¾—ï¼Œæ–‡ç« å†…å®¹ä¸€éƒ¨åˆ†æ˜¯æ‘˜æŠ„åŸæ–‡ï¼Œä¸€éƒ¨åˆ†æ˜¯è‡ªå·±çš„ç†è§£å’Œæ€»ç»“ æœ¬ç¯‡æ–‡ç« è®°å½•çš„æ˜¯ï¼Œæ¥è‡ªéƒ­å¤©ç¥¥è€å¸ˆçš„ã€Šåå¤©å­¦ä¼š51å•ç‰‡æœºã€‹è§†é¢‘è¯¾ ä¸€ã€å†™åœ¨å‰é¢ å‰æ®µæ—¶é—´æˆ‘åœ¨ç½‘ä¸Šä¹°äº†å— 51 å•ç‰‡æœºå¼€å‘æ¿ æ¥ä¸‹æ¥çš„ä¸¤å‘¨ï¼Œæˆ‘æ¯å¤©ä¸‹ç­å›åˆ°å®¶çš„ç¬¬ä¸€ä»¶äº‹å°±æ˜¯ï¼Œè·Ÿç€éƒ­å¤©ç¥¥è€å¸ˆçš„ã€Šåå¤©å­¦ä¼š51å•ç‰‡æœºã€‹è§†é¢‘é¼“æ£ä¸€ä¼šå„¿ï¼Œé‚£é˜µå­åœ¨æˆ‘ä»¬å®¶å¤©å¤©éƒ½èƒ½å¬åˆ°èœ‚é¸£å™¨æ»´æ»´æ»´~æ»´æ»´æ»´çš„å£°éŸ³ æˆ‘å½“æ—¶ä¹°å¼€å‘ç‰ˆçš„åˆè¡·æ˜¯æƒ³äº†è§£ï¼šå•ç‰‡æœºæ˜¯å¦‚ä½•æ‰§è¡Œä»£ç çš„ï¼Ÿ äº†è§£å•ç‰‡æœºçš„æ‰§è¡Œè¿‡ç¨‹ï¼Œå¯¹ä¸‹ä¸€é˜¶æ®µï¼ˆæ“ä½œç³»ç»Ÿï¼‰çš„å­¦ä¹ æœ‰å¾ˆå¤§çš„å¸®åŠ©ã€‚å› ä¸ºæ“ä½œç³»ç»Ÿæœ€é‡è¦çš„ä»»åŠ¡ä¹‹ä¸€ï¼Œå°±æ˜¯ç®¡ç† CPU æ‰§è¡Œå¤šä»»åŠ¡ ä½†æ˜¯ï¼Œç›´åˆ°æˆ‘èƒ½æ§åˆ¶8ä½æ•°ç ç®¡æ˜¾ç¤ºæ•°å­—ä»¥åï¼Œæˆ‘æ‰æ„è¯†åˆ°ï¼Œå“¦~ åŸæ¥è¿™æ˜¯åå®è·µç±»çš„è¯¾ç¨‹ï¼Œç†è®ºçŸ¥è¯†è®²çš„æ¯”è¾ƒå°‘ï¼Œè¿™å’Œæˆ‘åŸå®šçš„ç›®æ ‡ç›¸å·®ç”šè¿œã€‚ äºæ˜¯ï¼Œåç»­è¯¾ç¨‹çš„ä¸²å£ã€æ¶²æ™¶å±å•¥çš„æˆ‘å°±æ²¡æœ‰ç»§ç»­å­¦äº†ï¼Œåœ¨ç½‘ä¸ŠæŸ¥äº†å•ç‰‡æœºåŸç†ä½œä¸ºæœ¬èŠ‚è¯¾çš„è¡¥å……ã€‚ æœ¬ç¯‡æ–‡ç« å…±åŒ…å«ä¸¤éƒ¨åˆ†å†…å®¹ï¼š ä¸€æ˜¯è¯¾ç¨‹ç®€ä»‹ï¼Œä»‹ç»éƒ­å¤©ç¥¥è€å¸ˆçš„ã€Šåå¤©å­¦ä¼š51å•ç‰‡æœºã€‹æ¯å°è®²çš„è¯¾ç¨‹å†…å®¹ äºŒæ˜¯è¯¾ç¨‹æ€»ç»“ï¼Œä¸»è¦æ˜¯æƒ³èŠèŠæˆ‘ä¸ªäººéå¸¸ç–‘æƒ‘çš„ä¸€ä¸ªé—®é¢˜ï¼Œå•ç‰‡æœºæ˜¯å¦‚ä½•æ‰§è¡Œä»£ç çš„ï¼Ÿ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å…ˆè·Ÿéšéƒ­å¤©ç¥¥è€å¸ˆçš„è„šæ­¥ï¼Œä¸€èµ·æ¥å­¦ä¹ æ€ä¹ˆæ§åˆ¶å•ç‰‡æœºä¸Šçš„ç¡¬ä»¶ äºŒã€åå¤©å­¦ä¼š51å•ç‰‡æœº éƒ­å¤©ç¥¥è€å¸ˆçš„ã€Šåå¤©å­¦ä¼š51å•ç‰‡æœºã€‹è¯¾ç¨‹ä¸€å…±æœ‰13è®²ï¼Œæ¯ä¸€è®²çš„å†…å®¹éƒ½æ˜¯åŸºäºé…å¥—çš„ TX-1C å¼€å‘æ¿å±•å¼€ å› æ­¤ï¼Œåœ¨ä»‹ç»è¯¾ç¨‹å†…å®¹ä¹‹å‰ï¼Œæˆ‘ä»¬æœ‰å¿…è¦å…ˆæ¥äº†è§£ TX-1C å¼€å‘æ¿çš„æ„æˆ å›¾ç‰‡æ¥æºï¼šæ‹¼å¤•å¤•å–å®¶è¯¦æƒ…é¡µ å¦‚å›¾ï¼Œä»å·¦åˆ°å³åˆ†åˆ«æ˜¯å‘å…‰äºŒæç®¡ã€1602æ¶²æ™¶å±æ¥å£å’Œå…­ä½æ•°ç ç®¡ï¼Œæ•´å—å¼€å‘ç‰ˆçš„å­¦ä¹ è¦ç‚¹å¦‚ä¸‹ï¼š äº†è§£æœ€å°ç³»ç»Ÿå¿…è¦æ¡ä»¶ï¼šç”µæºã€æ™¶æŒ¯ã€å¤ä½ç”µè·¯ æ§åˆ¶ä»»æ„I/Oå£ï¼šè¾“å‡ºæ§åˆ¶ç”µå¹³é«˜ä½ã€è¾“å…¥æ£€æµ‹ç”µå¹³é«˜ä½ æŒæ¡å®šæ—¶å™¨çš„ç”¨æ³• æŒæ¡å¤–éƒ¨ä¸­æ–­ã€å®šæ—¶å™¨ä¸­æ–­ã€ä¸²å£ä¸­æ–­ ä¸²å£é€šä¿¡ï¼šå•ç‰‡æœºä¸å•ç‰‡æœºã€å•ç‰‡æœºä¸è®¡ç®—æœºé€šä¿¡ è¯¾ç¨‹å†…å®¹å¤§è‡´æ˜¯è¿™äº›ï¼Œä»ç›®å½•æ¥çœ‹è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ã€‚å½“æˆ‘ä»¬å…·å¤‡æ§åˆ¶è¿™äº›ç®€å•è®¾å¤‡çš„èƒ½åŠ›ä»¥åï¼Œå…¶ä»–å¤æ‚çš„åŠŸèƒ½åŸç†ä¸Šä¹Ÿéƒ½å·®ä¸å¤š å¥½ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹ä¸Šè¯¾ ç‚¹äº®ä¸€ä¸ªå‘å…‰ç®¡ è¯¾ç¨‹ç¬¬ä¸€è®²ï¼Œè€å¸ˆå…ˆè¿›è¡Œä¸ªäººä»‹ç»ï¼Œç„¶åè®²äº†å•ç‰‡æœºçš„å‘å±•å²ï¼Œä»¥åŠä»‹ç»å•ç‰‡æœºèƒ½åšä»€ä¹ˆï¼Ÿ åœ¨è¯¾ç¨‹ç»“å°¾ï¼Œè€å¸ˆå¸¦é¢†æˆ‘ä»¬ç‚¹äº®äº†ä¸€ä¸ªå‘å…‰äºŒæç®¡ ç‚¹äº®ä»£ç è¿‡äºç®€å•ï¼Œæˆ‘å½“æ—¶é¡ºæ‰‹æŠŠå‰©ä¸‹çš„7ä¸ªå‘å…‰äºŒæç®¡ä¸€èµ·ç‚¹äº®äº†ï¼Œè¿˜åšäº†ä¸€ä¸ªæµæ°´ç¯çš„æ•ˆæœå‡ºæ¥ï¼Œä»£ç å¦‚ä¸‹ï¼š #include &lt;reg52.h&gt; sbit led1 = P1^0; ...// ä¸­é—´è¿˜æœ‰ 6 ä¸ªç¯ï¼Œå¿½ç•¥é‡å¤ä»£ç  sbit led8 = P1^7; unsigned int index = 0; //è½®åˆ°ç¬¬å‡ ä¸ª LED ç¯ unsigned int toggle = 1; // 1 è¡¨ç¤ºå¼€ç¯ 0 è¡¨ç¤ºå…³ç¯ void main(){ while(1){ perform_once();// æ§åˆ¶å‘å…‰äºŒæç®¡äº®ç­ delay();// ä¼‘çœ ä¸€æ®µæ—¶é—´ï¼Œä»£ç å®ç°çœç•¥ } } void perform_once(){ if(index&gt;=8){ // è®©æ¯ä¸ªå‘å…‰äºŒæç®¡ï¼Œä¸€è½®äº®ï¼Œä¸€è½®ç­ index = 0; toggle = toggle == 1 ? 0 : 1; } switch(index){ case 0:led1 = toggle; ... case 8:led8 = toggle; } index++; // æ§åˆ¶ä¸‹ä¸€ä¸ªå‘å…‰äºŒæç®¡ } ç¼–å†™å®Œä¸Šè¿°ä»£ç ä»¥åï¼Œæˆ‘ä»¬åœ¨ Kiel ä¸­å°† c æ–‡ä»¶ç¼–è¯‘æ‰“åŒ…æˆ .hex æ–‡ä»¶ å†é€šè¿‡ STC_ISP è½¯ä»¶çƒ§å½•åˆ°å¼€å‘æ¿ä¸­ï¼Œå°†æ¿å­é‡æ–°ä¸Šç”µå°±å¯ä»¥çœ‹åˆ°ä»£ç è¿è¡Œæ•ˆæœäº† å›¾ç‰‡æ¥æºï¼šè‡ªå·±æ‹çš„ æ§åˆ¶èœ‚é¸£å™¨å‘å£° ç¬¬äºŒè®²è€å¸ˆæ•™äº†æˆ‘ä»¬æ€ä¹ˆæ§åˆ¶èœ‚é¸£å™¨å‘å£° ä¸è¿‡ï¼Œåœ¨å­¦ä¹ èœ‚é¸£å™¨ä¹‹å‰ï¼Œè€å¸ˆå…ˆæ¥ç€ä¸ŠèŠ‚è¯¾çš„å†…å®¹ï¼Œå¸¦æˆ‘ä»¬ä¸€èµ·å®ç°äº†å‘å…‰äºŒæç®¡çš„æµæ°´ç¯æ•ˆæœ å”‰å˜¿ï¼Œæµæ°´ç¯æ•ˆæœæˆ‘åœ¨ä¸ŠèŠ‚è¯¾å°±æå®šäº†ï¼Œæˆ‘å¯çœŸæ˜¯ä¸ªæ‡‚å¾—æœªé›¨ç»¸ç¼ªæŒ–åœ°é“çš„å¥½å­©å­ï¼Œéª„å‚² è®²å®Œæµæ°´ç¯çš„å®ç°ï¼Œè€å¸ˆæ‰æ•™äº†æˆ‘ä»¬æ€ä¹ˆå»æ§åˆ¶èœ‚é¸£å™¨ï¼Œå†å¾€åå°±æ˜¯èœ‚é¸£å™¨å‘å£°å®æˆ˜äº†ï¼Œä»£ç ä¹Ÿå¾ˆç®€å• #include &lt;reg52.h&gt; sbit beep = P2^3; //èœ‚é¸£å™¨ void main(){ while(1){ perform_once();// è®©èœ‚é¸£å™¨é…åˆå‘å…‰äºŒæç®¡ï¼Œæ»´æ»´æ»´~ delay();// ä¼‘çœ ä¸€æ®µæ—¶é—´ } } void perform_once(){ if(index&gt;=8){ index = 0; toggle = toggle == 1 ? 0 : 1; } beep = toggle; } æˆ‘è¿™å„¿å·äº†ä¸ªæ‡’ï¼Œç›´æ¥åœ¨åŸå…ˆæ§åˆ¶å‘å…‰äºŒæç®¡çš„åŸºç¡€ä¸Šï¼Œå¢åŠ äº†æ§åˆ¶èœ‚é¸£å™¨çš„é€»è¾‘ã€‚è®©èœ‚é¸£å™¨å½“èƒŒæ™¯éŸ³ä¹ï¼Œé…åˆå‘å…‰äºŒæç®¡æµæ°´ç¯ä¸€èµ·å‘å£° ç¼–å†™å®Œä¸Šè¿°ä»£ç ä»¥åï¼Œæˆ‘ä»¬åœ¨ Kiel ä¸­å°† c æ–‡ä»¶ç¼–è¯‘æ‰“åŒ…æˆ .hex æ–‡ä»¶ å†é€šè¿‡ STC_ISP è½¯ä»¶çƒ§å½•åˆ°å¼€å‘æ¿ä¸­ï¼Œå°†æ¿å­é‡æ–°ä¸Šç”µå°±å¯ä»¥çœ‹åˆ°ä»£ç è¿è¡Œæ•ˆæœäº† å›¾ç‰‡æ¥æºï¼šè‡ªå·±æ‹çš„ æ•°ç ç®¡ã€ä¸­æ–­åŸç†å’Œå®šæ—¶å™¨ ç¬¬ä¸‰è®²çš„å†…å®¹æ¯”è¾ƒå¤šï¼Œæœ‰ä¸­æ–­ã€å®šæ—¶å™¨çš„åŸç†ï¼Œè¿˜æœ‰æ•°ç ç®¡çš„æ§åˆ¶æ˜¾ç¤ºï¼Œå…¶ä¸­æ•°ç ç®¡çš„ â€˜æ®µé€‰â€™ å’Œ â€˜ä½é€‰â€™ è®©æˆ‘ååº”äº†å¥½ä¸€ä¼šæ‰ç†è§£ æ¥ä¸‹æ¥åˆæ˜¯åŠ¨æ‰‹å®è·µç¯èŠ‚ æˆ‘åœ¨ä¹‹å‰çš„ä»£ç åŸºç¡€ä¸ŠåŠ äº†æ•°ç ç®¡çš„æ˜¾ç¤ºé€»è¾‘ï¼Œå¦å¤–è¿˜å•ç‹¬å†™äº†ä¸€ä¸ªæ£€æµ‹å¤–éƒ¨ä¸­æ–­çš„ç¨‹åºï¼Œè¿™ä¸¤æ®µä»£ç éƒ½æ¯”è¾ƒé•¿æˆ‘å°±ä¸æ”¾å‡ºæ¥äº†ï¼Œç›´æ¥æ¥çœ‹æ•ˆæœ å›¾ç‰‡æ¥æºï¼šè‡ªå·±æ‹çš„ åœ¨åé¢çš„4 ~ 13è®²çš„è¯¾ç¨‹ä¸­ï¼Œè€å¸ˆè¿˜æ•™äº†ï¼šç‹¬ç«‹é”®ç›˜ã€çŸ©é˜µé”®ç›˜çš„æ§åˆ¶ï¼Œä¸²å£é€šä¿¡ï¼Œ1602æ¶²æ™¶å±æ˜¾ç¤ºï¼ŒI2Cæ€»çº¿ç­‰å†…å®¹ ä¸è¿‡è¿™å‡ èŠ‚è¯¾çš„è§†é¢‘æˆ‘å…¨éƒ¨å¼€2å€é€Ÿçœ‹å®Œçš„ï¼Œè§†é¢‘ä¸­çš„ä»£ç æˆ‘ä¹Ÿæ²¡æœ‰åŠ¨æ‰‹å®è·µ å¼€å€é€Ÿå’Œæ²¡æœ‰å†™ä»£ç æ˜¯å› ä¸ºï¼Œåœ¨ä¸Šå®Œ 1~3 è®²ä»¥åï¼Œæˆ‘å·²ç»å­¦ä¼šäº†ï¼š å¦‚ä½•æ§åˆ¶è¾“å‡ºç”µå¹³è¿›è€Œæ§åˆ¶å‘å…‰äºŒæç®¡ã€èœ‚é¸£å™¨ å¦‚ä½•æ£€æµ‹è¾“å…¥ç”µå¹³ å¦‚ä½•ä½¿ç”¨ä¸­æ–­ã€å®šæ—¶å™¨ è™½ç„¶ä¸œè¥¿ä¸å¤šï¼Œä½†å­¦ä¹ ç›®çš„å·²ç»è¾¾åˆ°äº†ï¼Œå†å­¦ä¼šæ§åˆ¶åé¢çš„å‡ ä¸ªå…ƒå™¨ä»¶ï¼Œå¯¹æˆ‘æ¥è¯´æ„ä¹‰ä¸æ˜¯å¾ˆå¤§ å¯¹å‰©ä¸‹è¯¾ç¨‹æ„Ÿå…´è¶£çš„æœ‹å‹ï¼Œå¯ä»¥æŸ¥çœ‹å‚è€ƒèµ„æ–™ä¸€æ ä¸­ â€œåå¤©å­¦ä¼š51å•ç‰‡æœºæ•™ç¨‹â€ å¥½äº†ï¼Œè¯¾ç¨‹ç®€ä»‹éƒ¨åˆ†åˆ°è¿™é‡Œå°±å…ˆç»“æŸäº† æ¥ä¸‹æ¥çš„æ—¶é—´ï¼Œæˆ‘ä»¬æ¥èŠèŠæœ¬ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘æœ€æ„Ÿå…´è¶£çš„è¯é¢˜ï¼šå•ç‰‡æœºæ˜¯å¦‚ä½•æ‰§è¡Œä»£ç çš„ï¼Ÿ ä¸‰ã€å•ç‰‡æœºæ˜¯å¦‚ä½•æ‰§è¡Œä»£ç çš„ï¼Ÿ åœ¨ä¹‹å‰å‡ èŠ‚è¯¾çš„å®è·µè¿‡ç¨‹ä¸­ï¼Œä¸çŸ¥é“å¤§å®¶æœ‰æ²¡æœ‰æ³¨æ„åˆ°ä¸€ä¸ªè§„å¾‹ æˆ‘ä»¬æ¯æ¬¡å†™å®Œä»£ç ï¼Œéƒ½éœ€è¦å…ˆç”¨ Kiel è½¯ä»¶ï¼Œå°† c æ–‡ä»¶ç¼–è¯‘æˆ .hex æ–‡ä»¶ å†é€šè¿‡ STC_ISP è½¯ä»¶çƒ§å½•åˆ°å¼€å‘æ¿ä¸­ï¼Œç„¶åæ¿å­é‡æ–°ä¸Šç”µï¼Œæˆ‘ä»¬å°±èƒ½çœ‹åˆ°æ–°ä»£ç è¿è¡Œçš„æ•ˆæœäº† ä¸ºä»€ä¹ˆç®€å•æ“ä½œå‡ æ­¥å°±å¯ä»¥è®©å•ç‰‡æœºè¿è¡Œæˆ‘ä»¬çš„æ–°ä»£ç å‘¢ï¼Ÿ æˆ‘ä»¬æŠŠå‰åæµç¨‹æ‹ä¸€ä¸‹ï¼Œå¯ä»¥å‘ç°ä¸Šè¿°çš„æ“ä½œæµç¨‹ï¼Œå¤§è‡´å¯ä»¥åˆ†ä¸ºï¼šç¼–ç ã€ç¼–è¯‘ã€çƒ§å½•ã€è¿è¡Œè¿™å››ä¸ªé˜¶æ®µ æƒ³è¦äº†è§£å•ç‰‡æœºæ˜¯æ€ä¹ˆè¿è¡Œçš„ï¼Œæˆ‘ä»¬å°±éœ€è¦çŸ¥é“ï¼Œè¿™å‡ ä¸ªé˜¶æ®µå„è‡ªéƒ½åšäº†å“ªäº›äº‹æƒ…ï¼Ÿ æˆ‘ä»¬å…ˆæ¥çœ‹ç¬¬ä¸€æ­¥ï¼Œç¼–ç é˜¶æ®µ ç¼–ç é˜¶æ®µ ç¼–ç é˜¶æ®µæŒ‡çš„æ˜¯æŠŠæˆ‘ä»¬äººç±»çš„æƒ³æ³•ï¼Œè½¬æ¢ä¸ºç¼–ç¨‹è¯­è¨€æ¥å®ç° æ¯”å¦‚æˆ‘æƒ³è®©æ¿å­ä¸Šçš„ç¬¬ä¸€ä¸ªå‘å…‰äºŒæç®¡äº®èµ·æ¥ï¼Œç”¨ä»£ç å®ç°çš„è¯å¯ä»¥è¿™æ ·å†™ï¼š #include &lt;reg52.h&gt; sbit led1 = P1^0; void main(){ led1 = 0; } æ ¸å¿ƒä»£ç å°±ä¸€å¥è¯ï¼š'led1 = 0' ï¼Œéå¸¸çš„ç®€å• ç¼–è¯‘é˜¶æ®µ å½“æˆ‘ä»¬çš„éœ€æ±‚ï¼ˆç‚¹äº®ç¬¬ä¸€ä¸ªäºŒæç®¡ï¼‰ç”¨ç¼–ç¨‹è¯­è¨€å®ç°äº†ä»¥åï¼Œæ¥ä¸‹æ¥å°±æ˜¯è¦æŠŠè¿™æ®µé€»è¾‘ä»£ç ï¼Œç¿»è¯‘ç»™å•ç‰‡æœºå»æ‰§è¡Œ æ€ä¹ˆç¿»è¯‘å‘¢ï¼Ÿ è¿™å°±æ˜¯ç¼–è¯‘å™¨åšçš„äº‹æƒ…ï¼Œå¤§è‡´æµç¨‹æ˜¯ï¼Œå…ˆæŠŠæºä»£ç è¿›è¡Œè¯­æ³•è§£æï¼Œç„¶åå†è½¬åŒ–ä¸ºå„ä¸ªå¹³å°çš„æœºå™¨ä»£ç  å…·ä½“åˆ° 51 å•ç‰‡æœºï¼ŒKiel é›†æˆäº†ç¼–è¯‘å™¨çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬å†™å®Œä»£ç åï¼Œå°†å·¥ç¨‹çš„ç›®æ ‡æŒ‡ä»¤é›†è®¾ç½®ä¸º MCS-51ï¼Œç„¶åå°±å¯ä»¥ä¸€é”®æ‰“åŒ…æˆ .hex å¯æ‰§è¡Œæ–‡ä»¶ï¼Œç­‰å¾…ä¸‹ä¸€é˜¶æ®µçƒ§å½•åˆ°å•ç‰‡æœº è¿™é‡Œæœ‰ä¸¤ä¸ªæ¯”è¾ƒå…³é”®çš„ç‚¹ï¼Œä»€ä¹ˆæ˜¯æŒ‡ä»¤é›†ï¼Œä»¥åŠä»€ä¹ˆæ˜¯ hex æ–‡ä»¶ï¼Ÿ æˆ‘ä»¬å…ˆæ¥çœ‹ç¬¬ä¸€ç‚¹ï¼Œä»€ä¹ˆæ˜¯æŒ‡ä»¤é›†ï¼Ÿ 1ã€ä»€ä¹ˆæ˜¯æŒ‡ä»¤é›† æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒèŠ¯ç‰‡æ˜¯ç”±æ— æ•°ä¸ªåŠŸèƒ½ä¸åŒçš„ç”µè·¯ç»„åˆè€Œæ¥ï¼Œè€Œç”µè·¯åˆåªèƒ½é€šè¿‡å¼€å…³æ¥æ§åˆ¶ é‚£ä¹ˆï¼ŒèŠ¯ç‰‡å‚å•†å°±éœ€è¦å‘Šè¯‰å…¶ä»–äººï¼Œåº”è¯¥é€šè¿‡ä»€ä¹ˆæ ·çš„å¼€å…³ç»„åˆè§„åˆ™ï¼Œæ‰æ¥æ§åˆ¶è¿™ä¸ªèŠ¯ç‰‡ä¸Šä¸åŒçš„ç”µè·¯ æ§åˆ¶èŠ¯ç‰‡çš„è§„åˆ™ï¼Œå°±è¢«ç§°ä¸ºæŒ‡ä»¤é›†ã€‚ æ¯”å¦‚ï¼Œ51å•ç‰‡æœºä½¿ç”¨çš„æ˜¯ MCS-51 æŒ‡ä»¤é›†ï¼Œè¿™å¥—æŒ‡ä»¤é›†åŒ…å«äº†ï¼šæ•°æ®ä¼ é€ã€ä½æ“ä½œã€é€»è¾‘è¿ç®—åŠè½¬ç§»ã€ç®—æœ¯è¿ç®—ã€æ§åˆ¶è½¬ç§»5ä¸ªå¤§ç±»ï¼Œå…±è®¡111æ¡æŒ‡ä»¤ æ¯æ¡æŒ‡ä»¤éƒ½æ˜¯ 0101010 è¿™æ ·çš„ 01 ç»„åˆï¼Œä¸€æ¡æŒ‡ä»¤æœ‰å¤šå°‘ä½0å’Œ1ï¼Œè¦çœ‹å…·ä½“ç”¨ä»€ä¹ˆæŒ‡ä»¤ åœ¨51å•ç‰‡æœºçš„111æ¡æŒ‡ä»¤ä¸­ï¼Œ1å­—èŠ‚æŒ‡ä»¤å…±æœ‰49æ¡ï¼Œ2å­—èŠ‚æŒ‡ä»¤å…±æœ‰45æ¡ï¼Œ3å­—èŠ‚æŒ‡ä»¤å…±æœ‰17æ¡ è¯¦ç»†çš„æŒ‡ä»¤é›†å¯ä»¥æŸ¥çœ‹å‚è€ƒèµ„æ–™ 2ã€ä»€ä¹ˆæ˜¯ hex æ–‡ä»¶ è‡³äº Kiel æ‰“åŒ…ç”Ÿæˆçš„ .hex æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€çœ‹çœ‹ å›¾ç‰‡æ¥æºï¼šè¯¾ç¨‹è§†é¢‘æˆªå›¾ å…¶å® hex æ–‡ä»¶å·²ç»æ˜¯ç¼–è¯‘è¿‡åå¾—åˆ°çš„äºŒè¿›åˆ¶ç»„åˆäº†ï¼Œé‡Œé¢çš„å†…å®¹å°±æ˜¯æˆ‘ä»¬ç”¨ C51 å†™çš„ä¸šåŠ¡ä»£ç ï¼Œä¸è¿‡æ˜¯è¢«è½¬æ¢ä¸ºä¸€è¡Œè¡Œ0å’Œ1ï¼Œæˆ‘ä»¬çœ‹ä¸æ‡‚ç½¢äº† è‡³äºä¸ºä»€ä¹ˆæ˜¾ç¤ºçš„æ˜¯åå…­è¿›åˆ¶ï¼Œè¿™æ˜¯å› ä¸ºæ–‡æœ¬ç¼–è¾‘å™¨æ˜¯ä»¥å››ä¸ªäºŒè¿›åˆ¶å½“ä½œä¸€ä¸ªå•ä½è¯»çš„ï¼Œçƒ§å½•åˆ°å•ç‰‡æœºè¿˜æ˜¯ä»¥äºŒè¿›åˆ¶æ¥æ‰§è¡Œçš„ çƒ§å½•é˜¶æ®µ åœ¨ä¸Šä¸€æ­¥çš„ç¼–è¯‘é˜¶æ®µï¼Œæ‰€æœ‰éœ€è¦æ‰§è¡Œçš„æŒ‡ä»¤éƒ½å·²ç»å‡†å¤‡å¥½ï¼Œä¿å­˜åœ¨ .hex æ–‡ä»¶ä¸­ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨ STC-ISP è½¯ä»¶ï¼ŒæŠŠè¿™äº›äºŒè¿›åˆ¶æ•°æ®ï¼Œä¼ è¾“ç»™å•ç‰‡æœºçš„å­˜å‚¨å•å…ƒï¼ˆEEPROMï¼‰å°±å®Œäº‹äº† çƒ§å½•çš„è¿‡ç¨‹å’ŒåŸç†æˆ‘ä¹Ÿä¸æ˜¯å¾ˆæ¸…æ¥šï¼Œæˆ‘ä¸ªäººæ˜¯è¿™æ ·ç†è§£çš„ï¼Œå•ç‰‡æœºå­˜å‚¨å•å…ƒæ˜¯ç”±è®¸å¤šç”µæ± ç»„æˆçš„ã€‚çƒ§å½•ç”µè·¯åœ¨ç¢°åˆ° 0 æ—¶ï¼Œå°±å¯¹ç”µæ± æ”¾ç”µï¼›ç¢°åˆ° 1 æ—¶ï¼Œå°±å¯¹ç”µæ± å……ç”µ å¯¹çƒ§å½•åŸç†æ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥æŸ¥çœ‹å‚è€ƒèµ„æ–™åˆ—å‡ºçš„ï¼ŒSTC 51å•ç‰‡æœºçƒ§å½•åè®®åˆ†æ å’Œ å•ç‰‡æœºä¸ºä»€ä¹ˆèƒ½ç›´æ¥çƒ§å½•ç¨‹åºï¼Ÿè¿™ä¸¤ç¯‡æ–‡ç«  è¿è¡Œé˜¶æ®µ å¥½ï¼Œç»è¿‡ä¸Šä¸€æ­¥çš„çƒ§å½•åï¼Œç°åœ¨å•ç‰‡æœºçš„ ROM å­˜å‚¨äº†æ˜¯æ— æ•°ä¸ªé«˜ä½ç”µå¹³ï¼Œç­‰å¾…è¢«æ‰§è¡Œ æ¥ç€ï¼Œæˆ‘ä»¬æŒ‰ä¸‹å¼€å‘æ¿çš„ç”µæºé”®ï¼Œæ¿å­ä¸Šç”µï¼Œ PC å¯„å­˜å™¨ç”µè·¯é»˜è®¤æŒ‡å‘ 0000H åœ°å€ï¼Œé€šè¿‡ä¼ è¾“ç”µè·¯ï¼Œå¯»å€å¯„å­˜å™¨å¾—åˆ°ç¬¬ä¸€æ¡æŒ‡ä»¤åœ°å€ ç„¶åï¼Œå¯»å€å¯„å­˜å™¨ä» ROM å–å‡ºç¬¬ä¸€æ¡æŒ‡ä»¤ï¼Œä¼ è¾“ç»™æŒ‡ä»¤ç¼–ç å™¨è§£æ 51çš„æŒ‡ä»¤ç±»å‹å‰é¢æè¿‡äº†ï¼Œä¸€å…±åˆ†ä¸º5å¤§ç±»ï¼š æ•°æ®ä¼ é€ï¼šå†…éƒ¨ RAM æˆ–å¯„å­˜å™¨ä¹‹é—´çš„æ•°æ®ä¼ é€ã€ç´¯åŠ å™¨Aä¸å¤–éƒ¨ RAM é—´çš„æ•°æ®ä¼ é€ç­‰ç­‰ ä½æ“ä½œï¼šä½çŠ¶æ€æ§åˆ¶ã€ä½æ¡ä»¶è½¬ç§»ç­‰ç­‰ é€»è¾‘é¢„ç®—åŠè½¬ç§»ï¼šä¸ã€æˆ–ã€äº¦æˆ–ã€å¾ªç¯ç§»ä½ã€ç´¯åŠ å™¨æ¸…é›¶ç­‰ç­‰ ç®—æœ¯è¿ç®—ï¼šå¸¦/ä¸å¸¦è¿›ä½çš„åŠ æ³•ã€å¸¦å€Ÿä½çš„åŠ æ³•ã€åŠ 1å‰ª1ã€ä¹˜é™¤ç­‰ç­‰ æ§åˆ¶è½¬ç§»ï¼šå­ç¨‹åºè°ƒç”¨ä¸è¿”å›ã€ç©ºæ“ä½œã€æ¡ä»¶è½¬ç§»ç­‰ç­‰ æŒ‡ä»¤ç¼–ç å™¨æ ¹æ®æŒ‡ä»¤ç±»å‹ï¼Œè°ƒç”¨ä¸åŒçš„ç”µè·¯æ¥æ‰§è¡Œä»»åŠ¡ã€‚ä¸€æ¡æŒ‡ä»¤æ‰§è¡Œç»“æŸåï¼Œå†æ¬¡é‡å¤ä¸Šè¿°æµç¨‹ï¼Œæ ¹æ® PC å¯„å­˜å™¨æŒ‡å‘çš„ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€ï¼Œç»§ç»­å–æŒ‡æ‰§è¡Œï¼Œæ°¸ä¸åœæ­‡.. è‡³æ­¤ï¼Œç¼–ç ã€ç¼–è¯‘ã€çƒ§å½•ã€è¿è¡Œè¿™å››ä¸ªé˜¶æ®µæˆ‘ä»¬éƒ½å·²ç»åˆ†æå®Œæˆï¼Œå•ç‰‡æœºçš„è¿è¡Œæµç¨‹åˆ°è¿™é‡Œå°±è®²å®Œäº†ã€‚ å››ã€ç»“è¯­ åœ¨æ–‡ç« çš„ç»“å°¾ï¼Œæˆ‘ä»¬æ¥å¯¹æœ¬æ–‡çš„ä¸¤éƒ¨åˆ†å†…å®¹åšä¸ªæ€»ç»“ å…ˆè¯´ã€Šåå¤©å­¦ä¼š51å•ç‰‡æœºã€‹è§†é¢‘è¯¾ç¨‹ å¯¹äºæˆ‘ä¸ç†Ÿæ‚‰çš„é¢†åŸŸï¼Œæˆ‘çš„æœŸæœ›é€šå¸¸æ˜¯è®²çš„è¶Šç®€å•ï¼Œè¶Šå…¥é—¨è¶Šå¥½ è¿™ä¸€ç‚¹æˆ‘è§‰å¾—ã€Šåå¤©å­¦ä¼š51å•ç‰‡æœºã€‹è¿™èŠ‚è¯¾åšåˆ°äº†ï¼Œè€å¸ˆè®²çš„éå¸¸å¥½ï¼Œç®€å•æ˜“æ‡‚ï¼Œå¹¶ä¸”åªéœ€è¦æœ‰ä¸€ç‚¹ç‚¹è¯­è¨€åŸºç¡€å°±å¯ä»¥ç›´æ¥ä¸Šæ‰‹ ä½†æ˜¯ï¼Œè¯¾ç¨‹å†…å®¹å¯¹å•ç‰‡æœºå†…éƒ¨ç”µè·¯ä»‹ç»çš„æ¯”è¾ƒå°‘ï¼Œå¦‚æœæ²¡æœ‰æ¨¡ç”µã€æ•°ç”µã€è®¡ç»„çš„åŸºç¡€ï¼Œå…¨éƒ¨è·Ÿä¸‹æ¥å¯èƒ½ä¼šè§‰å¾—æœ‰ç‚¹åƒåŠ› æ€»çš„æ¥è¯´ï¼Œéƒ­å¤©ç¥¥è€å¸ˆçš„ã€Šåå¤©å­¦ä¼š51å•ç‰‡æœºã€‹è¯¾ç¨‹ï¼Œæ›´é€‚åˆå·²ç»æœ‰ç†è®ºåŸºç¡€çš„ç§‘ç­å­¦ç”Ÿä¸Šæ‰‹å®è·µ å¦‚æœåƒæˆ‘ä¸€æ ·ï¼Œå¦„æƒ³é€šè¿‡è¿™é—¨è¯¾æ¥å­¦ä¹ ã€Šå¾®æœºåŸç†åŠæ¥å£æŠ€æœ¯ã€‹çš„åŒå­¦ï¼Œå¯ä»¥æ”¾å¼ƒäº†ï¼Œè€è€å®å®çœ‹ä¹¦å§ å†æ¥çœ‹ç¬¬äºŒä¸ªéƒ¨åˆ†ï¼Œå•ç‰‡æœºæ˜¯æ€ä¹ˆæ‰§è¡Œä»£ç çš„ï¼Ÿ æˆ‘ä»¬æŠŠå•ç‰‡æœºçš„è¿è¡Œæµç¨‹åˆ†ä¸ºç¼–ç ã€ç¼–è¯‘ã€çƒ§å½•ã€è¿è¡Œå››ä¸ªé˜¶æ®µï¼Œæ¯ä¸ªé˜¶æ®µåšçš„äº‹æƒ…åœ¨æ­£æ–‡é‡Œéƒ½å·²ç»åˆ†æè¿‡äº†ï¼Œæˆ‘ä»¬è¿™é‡Œå†ç®€å•æ€»ç»“ä¸€ä¸‹ï¼š ç¼–ç é˜¶æ®µï¼Œå°†ä¸šåŠ¡é€»è¾‘è§£é‡Šæˆä»£ç å®ç° ç¼–è¯‘é˜¶æ®µï¼Œå°†ä»£ç è§£é‡Šæˆç›®æ ‡å¹³å°çš„æœºå™¨è¯­è¨€ï¼Œä¹Ÿå°±æ˜¯ 01 ç»„åˆ çƒ§å½•é˜¶æ®µï¼ŒæŠŠç¼–è¯‘ç»“æœçš„ 01 ç»„åˆï¼Œä¼ è¾“åˆ°æœºå™¨çš„å­˜å‚¨å•å…ƒï¼Œæ¯ä¸ª 01 éƒ½è¢«å­˜å‚¨ä¸ºé«˜ä½ç”µå¹³ã€‚æ­¤é˜¶æ®µæ˜¯'è™šæ‹Ÿä¸–ç•Œ'è½¬å‘'ç‰©ç†ä¸–ç•Œ'çš„è½¬æŠ˜ç‚¹ è¿è¡Œé˜¶æ®µï¼Œæ¥ä¸‹æ¥çš„äº‹æƒ…å…¨éƒ¨å‘ç”Ÿåœ¨ç‰©ç†ç”µè·¯å±‚é¢ä¸Šã€‚åœ¨æŒ¯è¡å™¨ç”µè·¯çš„é©±åŠ¨ä¸‹ï¼ŒèŠ¯ç‰‡å¼€å§‹å–æŒ‡ã€è¯‘æŒ‡ã€æ‰§è¡Œï¼Œæ ¹æ®æ‰§è¡Œç»“æœï¼Œæˆ–ä¿®æ”¹å¯„å­˜å™¨æ”¹å˜æ—¶åºç”µè·¯é€»è¾‘ï¼Œæˆ–åˆ·æ–°ä¸»å­˜ç­‰å…¶ä»–æ“ä½œï¼Œç„¶åç»§ç»­å–æŒ‡ã€è¯‘æŒ‡ã€æ‰§è¡Œï¼Œæ— é™å¾ªç¯ï¼Œç›´åˆ°æ–­ç”µ å¥½äº†ï¼Œæœ¬ç¯‡æ–‡ç« åˆ°è¿™é‡Œå°±å…¨éƒ¨ç»“æŸäº†ã€‚å„ä½å¤§ä½¬å¦‚æœå‘ç°æœ¬æ–‡æœ‰å†™çš„ä¸å¯¹çš„åœ°æ–¹ï¼Œè¿˜æœ›åŠæ—¶æŒ‡å‡ºï¼Œæˆ‘ä¼šç¬¬ä¸€æ—¶é—´æ”¹æ­£ï¼Œæ„Ÿè°¢ å…¨æ–‡å®Œ äº”ã€å‚è€ƒèµ„æ–™ åå¤©å­¦ä¼š51å•ç‰‡æœºè§†é¢‘ï¼ˆéƒ­å¤©ç¥¥é«˜æ¸…å®Œæ•´ç‰ˆï¼‰- å°ç ´ç«™ MCS-51 æ±‡ç¼–è¯­è¨€æŒ‡ä»¤é›† 51å•ç‰‡æœºï¼ˆä¸€ï¼‰å•ç‰‡æœºå‘å±•æ¦‚è¿° - æœæœå°å¸ˆå¼Ÿ 51å•ç‰‡æœºï¼ˆäºŒï¼‰å•ç‰‡æœºç»“æ„å’ŒåŸç† - æœæœå°å¸ˆå¼Ÿ 51å•ç‰‡æœºï¼ˆä¸‰ï¼‰80C51çš„æŒ‡ä»¤ç³»ç»Ÿ - æœæœå°å¸ˆå¼Ÿ 51å•ç‰‡æœºï¼ˆå››ï¼‰80C51çš„ç¨‹åºè®¾è®¡ - æœæœå°å¸ˆå¼Ÿ å•ç‰‡æœºä¸ºä»€ä¹ˆèƒ½ç›´æ¥çƒ§å½•ç¨‹åºï¼Ÿ- çŸ¥ä¹ æ—¢ç”ŸBin ä½•ç”ŸHex ï¼Ÿ- å…‰è±†å„¿ STC 51å•ç‰‡æœºçƒ§å½•åè®®åˆ†æ - ç”µå‹é‡‘åˆš åŸºäº51å•ç‰‡æœºçš„å¤šçº¿ç¨‹æ“ä½œç³»ç»Ÿè®¾è®¡ - å–æ°´æœçš„ å®æ™¶ STC89C52RC å¾®æ§åˆ¶å™¨å®ç”¨ç¬”è®° - Hank 51å•ç‰‡æœºè¿è¡Œè¿‡ç¨‹ - æ¸…é…’ä¸æ°´ ","link":"https://yibaoshan.github.io/post/book-notes-computers-microcomputer-8051/"},{"title":"è¯»ä¹¦ç¬”è®°ï¼šç©¿è¶Šè®¡ç®—æœºçš„è¿·é›¾ï¼ˆä¸‹ï¼‰","content":"&quot;å¥½è®°æ€§æ¯”å¦‚çƒ‚ç¬”å¤´&quot;ï¼Œè¯»ä¹¦ç¬”è®°ç³»åˆ—æ˜¯ä¸ºäº†è®°å½•è‡ªå·±çš„è¯»ä¹¦å¿ƒå¾—ï¼Œæ–‡ç« å†…å®¹ä¸€éƒ¨åˆ†æ˜¯æ‘˜æŠ„åŸæ–‡ï¼Œä¸€éƒ¨åˆ†æ˜¯è‡ªå·±çš„ç†è§£å’Œæ€»ç»“ æœ¬ç¯‡æ–‡ç« è®°å½•çš„æ˜¯ï¼Œæ¥è‡ªæå¿ è€å¸ˆçš„ã€Šç©¿è¶Šè®¡ç®—æœºçš„è¿·é›¾ã€‹ç¬¬äºŒç‰ˆ ä¸€ã€å†™åœ¨å‰é¢ åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†äºŒè¿›åˆ¶æ€ä¹ˆåšåŠ æ³•ã€ä¸€ä¸ªç®€å•çš„å…¨åŠ å™¨ç”µè·¯ã€ç”µæŠ¥å’Œç»§ç”µå™¨çš„å‘æ˜ã€‚ å…¶ä¸­ï¼Œç»§ç”µå™¨æ˜¯æˆ‘ä»¬éœ€è¦å…³æ³¨çš„é‡ç‚¹ï¼Œè®¡ç®—æœºèƒ½å¤Ÿè¢«åˆ›é€ å‡ºæ¥ï¼Œç»§ç”µå™¨å¯ä»¥è¯´æ˜¯æœ€å¤§çš„åŠŸè‡£ æœ¬ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»é€»è¾‘é—¨ç”µè·¯ï¼Œä»¥åŠå„ç§è§¦å‘å™¨ï¼Œç›®æ ‡æ˜¯åšå‡ºä¸€ä¸ªç®€å•çš„ CPUï¼Œå¤§è‡´è·¯çº¿å¦‚ä¸‹ï¼š ç”¨ç»§ç”µå™¨åˆ¶ä½œé€»è¾‘é—¨ï¼ˆä¸æˆ–éï¼‰ç”µè·¯ ç”¨éé—¨ç”µè·¯åˆ¶ä½œæŒ¯è¡å™¨ ç”¨æˆ–éé—¨/ä¸éé—¨åˆ¶ä½œ RS è§¦å‘å™¨ã€D è§¦å‘å™¨ã€ä¸Šå‡æ²¿ D è§¦å‘å™¨ ç”¨ä¸Šå‡æ²¿ D è§¦å‘å™¨åˆ¶ä½œå¯„å­˜å™¨ åˆ¶ä½œä¼ è¾“é—¨ç”µè·¯ã€åŠ æ³•å™¨ç”µè·¯ã€æ§åˆ¶å™¨ç”µè·¯ çœ‹èµ·æ¥å†…å®¹å¾ˆå®¹ï¼Œå®é™…ä¸Šï¼Œä¹Ÿæ˜¯çœŸçš„å¾ˆå¤š~ å¤šçš„æˆ‘æ‡’ç™Œéƒ½çŠ¯äº†ï¼Œä¸æƒ³å†™æœ¬ç¯‡æ–‡ç« äº†ï¼Œå¦‚ä½•åˆ¶ä½œ CPU å¯ä»¥çœ‹ BITç¥å¨ å†™çš„æ–‡ç«  ç»§ç”µå™¨æ˜¯å¦‚ä½•æˆä¸ºCPUçš„ï¼ˆä¸€ï¼‰ - BITç¥å¨ ç»§ç”µå™¨æ˜¯å¦‚ä½•æˆä¸ºCPUçš„ï¼ˆäºŒï¼‰ - BITç¥å¨ å†ç»“åˆåŒ—äº¬å¤§å­¦ã€Šè®¡ç®—æœºç»„æˆã€‹å…¬å¼€è¯¾ä¸­çš„ç¬¬äº”ã€ä¸ƒã€å…«ç« è§†é¢‘ï¼Œè®¡ç»„éƒ¨åˆ†å·®ä¸å¤šå°±å¯ä»¥ç¿»ç¯‡äº† æå®šï¼Œæ”¶å·¥ ","link":"https://yibaoshan.github.io/post/book-notes-computers-lizhong-2/"},{"title":"è¯»ä¹¦ç¬”è®°ï¼šç©¿è¶Šè®¡ç®—æœºçš„è¿·é›¾ï¼ˆä¸Šï¼‰","content":" ç‚¹å‡»è·³è½¬åˆ°æ˜é‡‘é˜…è¯» &quot;å¥½è®°æ€§ä¸å¦‚çƒ‚ç¬”å¤´&quot;ï¼Œè¯»ä¹¦ç¬”è®°ç³»åˆ—æ˜¯ä¸ºäº†è®°å½•è‡ªå·±çš„è¯»ä¹¦å¿ƒå¾—ï¼Œæ–‡ç« å†…å®¹ä¸€éƒ¨åˆ†æ˜¯æ‘˜æŠ„åŸæ–‡ï¼Œä¸€éƒ¨åˆ†æ˜¯è‡ªå·±çš„ç†è§£å’Œæ€»ç»“ æœ¬ç¯‡æ–‡ç« è®°å½•çš„æ˜¯ï¼Œæ¥è‡ªæå¿ è€å¸ˆçš„ã€Šç©¿è¶Šè®¡ç®—æœºçš„è¿·é›¾ã€‹ç¬¬äºŒç‰ˆ ä¸€ã€å†™åœ¨å‰é¢ ä¸Šå‘¨æœ«ç»ˆäºçœ‹å®Œäº†æå¿ è€å¸ˆçš„ã€Šç©¿è¶Šè®¡ç®—æœºçš„è¿·é›¾ã€‹ï¼Œä»åä¸€å‡æœŸåˆ°ç°åœ¨ï¼Œç®—ç®—æ—¥å­ï¼Œè¯»å®Œè¿™æœ¬ä¹¦ç”¨äº†å°†è¿‘ä¸€ä¸ªæœˆæ—¶é—´ è¯»è¿™æœ¬ä¹¦çš„ç›®çš„æ˜¯æƒ³è¡¥è®¡ç®—æœºç»„æˆåŸç†çš„åŸºç¡€ã€‚æ—©åœ¨è¯»ã€Šç©¿è¶Šè®¡ç®—æœºçš„è¿·é›¾ã€‹ä¹‹å‰ï¼Œè®¡ç»„æ–¹é¢æˆ‘å·²ç»å­¦è¿‡äº†ï¼š åŒ—äº¬å¤§å­¦é™†ä¿Šæ—è€å¸ˆçš„ã€Šè®¡ç®—æœºç»„æˆã€‹è§†é¢‘å…¬å¼€è¯¾ï¼Œå’Œå¾æ–‡æµ©è€å¸ˆåœ¨æå®¢æ—¶é—´å‘å¸ƒçš„ã€Šæ·±å…¥æµ…å‡ºè®¡ç®—æœºç»„æˆåŸç†ã€‹ä¸“æ  è¯»å®Œã€Šç©¿è¶Šè®¡ç®—æœºçš„è¿·é›¾ã€‹ä»¥åï¼Œç»™æˆ‘æœ€å¤§çš„æ„Ÿå—æ˜¯ï¼šè¿™æ˜¯ä¸€æœ¬éå¸¸æ£’çš„ç§‘æ™®ä¹¦ç±ï¼ å’Œä¹‹å‰çš„ä¸¤ä¸ªè¯¾ç¨‹ç›¸æ¯”ï¼Œå®ƒä¸ä¼šä¸Šæ¥å°±è®²åŸç†ï¼Œä»€ä¹ˆæ˜¯å†¯Â·è¯ºä¾æ›¼ç»“æ„ã€è¿ç®—å™¨ã€æ§åˆ¶å™¨ã€å—æ¡¥åŒ—æ¡¥æ˜¯ä»€ä¹ˆã€æŒ‡ä»¤ä½“ç³»ç­‰ç­‰ è€Œæ˜¯ä»åˆä¸­ç”µå­¦å¼€å§‹è®²èµ·ï¼Œä»ç”µç”Ÿç£åˆ°ç»§ç”µå™¨çš„å‘æ˜ï¼Œä»ç£ç”Ÿç”µåˆ°ç”µè¯çš„å‘æ˜ï¼Œä¸€ç›´è®²åˆ°é€»è¾‘ç”µè·¯ã€è§¦å‘å™¨ã€å¸ƒå°”ä»£æ•°ã€å¯„å­˜å™¨ã€è¿ç®—å™¨ç­‰ç­‰ è¿™æœ¬ä¹¦è®©æˆ‘æ˜ç™½ï¼Œäººç±»å¹¶ä¸æ˜¯ä¸€å¼€å§‹å°±çŸ¥é“ï¼šåº”è¯¥æ€ä¹ˆå»åˆ¶é€ ä¸€å°è®¡ç®—æœºçš„ï¼Ÿ è®¡ç®—æœºçš„å‘æ˜ï¼Œæ˜¯ç”±æ— æ•°å‰äººæ™ºæ…§çš„ç»“æ™¶ä¸€æ­¥æ­¥æ¼”å˜è€Œæ¥ æ¥ä¸‹æ¥æˆ‘ä»¬è·Ÿéšæå¿ è€å¸ˆçš„è„šæ­¥ï¼Œä¸€èµ·æ¥æ¢ç©¶è®¡ç®—æœºå†…éƒ¨çš„ä¸–ç•Œ psï¼šé™äºç¯‡å¹…ï¼Œæœ¬ç¯‡æ–‡ç« åœ¨å†…å®¹ä¸Šæœ‰åˆ å‡ï¼Œå»ºè®®é˜…è¯»åŸè‘— äºŒã€ç©¿è¶Šè®¡ç®—æœºçš„è¿·é›¾ï¼ˆ1~4ï¼‰ ä¹¦æœ¬çš„ç¬¬ä¸€ç« ï¼Œä½œè€…èŠ±äº†ä¸€æ•´ç« çš„ç¯‡å¹…æ¥æ¸©ä¹ åˆä¸­çš„ç”µå­¦è¯¾ç¨‹ï¼Œè¿™é‡Œæˆ‘ä»¬ç®€å•è¿‡ä¸€éï¼š èƒ½å¤Ÿå¯¼ç”µçš„è¢«ç§°ä¸º â€œå¯¼ä½“â€ï¼Œé‡‘å±ã€ç”µè§£æ¶²ã€ç”µç¦»çš„æ°”ä½“ã€å¤§åœ°ç­‰éƒ½æ˜¯å¯¼ä½“ ä¸èƒ½å¯¼ç”µçš„è¢«ç§°ä¸º â€œç»ç¼˜ä½“â€ï¼Œå¹²ç‡¥çš„æœ¨å¤´ã€æ™ºéšœã€å¡‘æ–™ã€é™¶ç“·ç­‰éƒ½æ˜¯ç»ç¼˜ä½“ å¯¼ä½“èƒ½å¤Ÿå¯¼ç”µçš„åŸå› ï¼Œæ˜¯å®ƒå…·æœ‰å¤§é‡å¯ä»¥è‡ªç”±ç§»åŠ¨çš„å¸¦ç”µç²’å­ã€‚ç”µå‹æ¨åŠ¨ç”µå­å¾€ä¸€ä¸ªæ–¹å‘æµåŠ¨ï¼Œåˆ™è¢«ç§°ä¸ºç”µæµ åœ¨ç¬¬ä¸€ç« çš„ç»“å°¾ï¼Œä½œè€…ä»‹ç»äº†ç”µè·¯å›¾çš„èµ·æºï¼Œå¹¶æ•™æˆ‘ä»¬ç”»äº†ä¸€ä¸ªåŸºç¡€çš„ç”µè·¯å›¾ å›¾ 1.8 æ–‡ä¸­å›¾ç‰‡å‡æ¥è‡ªäºã€Šç©¿è¶Šè®¡ç®—æœºçš„è¿·é›¾ã€‹ï¼Œåç»­ä¸å†é‡å¤å£°æ˜ è¿™äº›ç¬¦å·æˆ‘ä»¬åº”è¯¥éƒ½è¿˜è®¤è¯†ï¼Œä»å·¦åˆ°å³åˆ†åˆ«æ˜¯ç”µæºã€å¼€å…³å’Œä¸¤ä¸ªç¯æ³¡ğŸ’¡ ç”¨ç”µæ¥è¡¨ç¤ºæ•° æœ‰äº†ç”µè·¯å›¾çš„åŸºç¡€ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥æƒ³è±¡ä¸€ä¸‹ï¼Œå‡­ç©ºå‡ºç°äº†ä¸€ä¸ªèƒ½è®¡ç®—åŠ æ³•çš„ â€œåŠ æ³•è¿ç®—éƒ¨ä»¶â€ è¿™ä¸ªåŠ æ³•è¿ç®—éƒ¨ä»¶æä¾›äº†aã€bä¸¤ä¸ªè¾“å…¥ç«¯ï¼Œå¥½è®©å®ƒçŸ¥é“è¦ç®—çš„æ•°æ˜¯ä»€ä¹ˆã€‚å½“è¿™ä¸ªåŠ æ³•è¿ç®—éƒ¨ä»¶å®Œæˆè®¡ç®—åï¼Œå®ƒæŠŠç»“æœä» o ç«¯é€å‡ºæ¥ï¼Œå¦‚ 2.1 å›¾æ‰€ç¤º å›¾ 2.1 ç°åœ¨ï¼Œæˆ‘è¦åˆ©ç”¨å®ƒæ¥è®¡ç®—åŠ æ³•ï¼Œå‡è®¾æˆ‘ä»¬è¦è®¡ç®— 1 + 2 ç­‰äºå‡ ï¼Ÿ æˆ‘ä»¬å¯ä»¥åœ¨ a ç«¯åŠ ä¸Š 1V çš„ç”µå‹ï¼Œåœ¨ b ç«¯åŠ ä¸Š 2V çš„ç”µå‹ï¼Œå½“è¿ç®—å®Œæˆåï¼Œç”¨ç”µå‹è¡¨æµ‹é‡ o ç«¯å°±ä¼šå¾—åˆ° 3V çš„ç”µå‹ï¼Œè¿™å°±è¡¨ç¤º 1 + 2 çš„ç»“æœç­‰äº 3ã€‚ å¦‚æœæˆ‘ä»¬è®¡ç®—çš„æ•°å€¼æ¯”è¾ƒå°ï¼Œæˆ–è€…éƒ½æ˜¯æ•´æ•°ï¼Œä¸Šé¢çš„æ–¹æ¡ˆä¹Ÿæœªå°ä¸å¯ã€‚ä½†æ˜¯ï¼Œå¦‚æœåªæ˜¯è¿™æ ·ï¼Œé‚£è¿™ä¸ªåŠ æ³•éƒ¨ä»¶ä¹Ÿæ²¡ä»€ä¹ˆæ„ä¹‰ï¼Œæˆ‘ä»¬å¿…é¡»æƒ³åŠæ³•è§£å†³æ•°å€¼è¿‡å¤§æˆ–è€…å°æ•°çš„æƒ…å†µ è¿™æ—¶å€™ï¼Œäººä»¬æƒ³èµ·äº†å¾·å›½ä½¬ï¼Œè±å¸ƒå°¼èŒ¨ã€‚ è±å¸ƒå°¼èŒ¨æ˜¯ä¼Ÿå¤§çš„å“²å­¦å®¶å’Œæ•°å­¦å®¶ï¼Œå¤§çº¦åœ¨1672â€”1676å¹´çš„æ—¶é—´ï¼Œä»–åˆ›å»ºäº†äºŒè¿›åˆ¶ã€‚äºŒè¿›åˆ¶åœ¨åˆ›å»ºä¹‹åˆï¼Œå¹¶éæ˜¯ä¸ºäº†ç”µå­¦æœåŠ¡çš„ï¼Œåªæ˜¯æ— æ„é—´è¢«åˆ›é€ äº†å‡ºæ¥ åœ¨éšåçš„å†å²è¿›ç¨‹ä¸­ï¼Œäººä»¬å‘ç°å¯ä»¥ç”¨å¼€å…³æ¥è¡¨ç¤ºäºŒè¿›åˆ¶ï¼Œå°±æŠŠäºŒè¿›åˆ¶æ‹¿è¿‡æ¥ä½œä¸ºè®¡ç®—æœºçš„ä¸€éƒ¨åˆ† å›¾ 2.16 å¦‚ä¸Šå›¾ 2.16ï¼Œå½“å¼€å…³æ–­å¼€æ—¶ï¼Œç”µæµè¢«åˆ‡æ–­ï¼Œè¿™ä»£è¡¨ 0ï¼›å½“å¼€å…³æ¥é€šæ—¶ï¼Œç”µè·¯ä¸­æœ‰ç”µæµé€šè¿‡ï¼Œè¿™ä»£è¡¨ 1 æœ‰äº†äºŒè¿›åˆ¶ä»¥åï¼Œä¹‹å‰çš„åŠ æ³•éƒ¨ä»¶æ•°å€¼è¿‡å¤§çš„é—®é¢˜å°±è¿åˆƒè€Œè§£äº† å›¾ 2.19 å¦‚å›¾ 2.19 æ‰€ç¤ºï¼Œå›¾ä¸­çš„ç°è‰²æ–¹æ¡†é€šå¸¸ä»£è¡¨ä¸€ä¸ªå…·æœ‰åŠ æ³•åŠŸèƒ½çš„ç”µè·¯ï¼Œç”±äºæˆ‘ä»¬ç°åœ¨è¿˜ä¸çŸ¥é“å®ƒçš„å†…éƒ¨æ„é€ ï¼Œæ‰€ä»¥è¿™é‡Œç”¨ä¸€ä¸ªæ–¹æ¡†æ¥è¡¨ç¤º è¿™ä¸ªè¿ç®—éƒ¨ä»¶çš„å·¦è¾¹å’Œä¸‹é¢å„æœ‰ 5 ä¸ªå¼€å…³ï¼Œåˆ†åˆ«ç”¨äºè¾“å…¥ä¸¤ä¸ªå‚ä¸è¿ç®—çš„äºŒè¿›åˆ¶æ•° å³è¾¹è¾“å‡ºçš„5æ ¹çº¿å„è‡ªè¿æ¥ä¸€ä¸ªç¯æ³¡ï¼Œå½“ç¯æ³¡äº®æ—¶ï¼Œè¡¨æ˜è¿™ä¸€æ¯”ç‰¹æ˜¯1ï¼Œå¦åˆ™ä¸º0ï¼Œé€šè¿‡è§‚å¯Ÿäº®ç¯çš„æƒ…å†µï¼Œå†è½¬ä¸ºåè¿›åˆ¶ï¼Œæˆ‘ä»¬å°±èƒ½çŸ¥é“ç»“æœæ˜¯å‡ äº† å¥½äº†ï¼Œç¬¬äºŒç« åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œæ¥ä¸‹æ¥çš„ç¬¬ä¸‰ç« ï¼Œæˆ‘ä»¬å°†å¼€å§‹æ¢ç©¶å­¦ä¼šäºŒè¿›åˆ¶æ€ä¹ˆåšåŠ æ³•ï¼Ÿå¹¶è®¾è®¡å‡ºä¸€ä¸ªå…¨åŠ å™¨ç”µè·¯ï¼Œå®ƒå¯æ˜¯å›¾ 2.19 ä¸­çš„ç°è‰²æ–¹æ¡†ä¸­çš„é‡è¦ç»„æˆéƒ¨åˆ† äºŒè¿›åˆ¶æ€ä¹ˆåšåŠ æ³•ï¼Ÿ ä¸€ä¸ªèƒ½å¤Ÿè®¡ç®— 5 bit ä»¥å†…çš„çš„ç”µè·¯å›¾åœ¨ä¸Šä¸€ç« èŠ‚ç»“æŸæ—¶å·²ç»ç”»å‡ºæ¥äº† ä¸¥æ ¼æ¥è¯´ï¼Œå› ä¸ºç»“æœç«¯åªæœ‰ 5 ä¸ªç¯æ³¡ï¼Œæ‰€ä»¥ä¸Šé¢çš„ç”µè·¯å›¾æœ€å¤§åªèƒ½å¾—åˆ°çš„ç»“æœæ˜¯ 11111 ï¼Œä¹Ÿå°±æ˜¯åªèƒ½è®¡ç®—ç»“æœåœ¨ 31 ä»¥å†…çš„åŠ æ³• ä¸ºäº†è®¾è®¡å‡ºèƒ½è®¡ç®—æ›´å¤§çš„æ•°çš„ç”µè·¯ï¼Œæˆ‘ä»¬æœ‰å¿…è¦æ¥å­¦ä¹ ï¼šäºŒè¿›åˆ¶çš„åŠ æ³• å›¾ 3.2 å¦‚å›¾ 3.2ï¼Œå’Œåè¿›åˆ¶çš„åŠ æ³•ä¸€æ ·ï¼ŒäºŒè¿›åˆ¶åšåŠ æ³•æ—¶ï¼Œä¹Ÿæ˜¯è¦å…ˆæŠŠä¸¤ä¸ªç›¸åŠ çš„æ•°å³å¯¹é½ï¼Œç„¶åä»æœ€å³è¾¹çš„åˆ—å¼€å§‹è®¡ç®— æ ¹æ®ä¸‹é¢çš„å£è¯€å¾—åˆ°ä¸€ä¸ªè®¡ç®—ç»“æœï¼š 0åŠ 0ç­‰äº0 0åŠ 1ç­‰äº1 1åŠ 0ç­‰äº1 1åŠ 1ç­‰äº0ï¼Œè¿›1 æ¯”å¦‚å›¾ 3.2 æ¼”ç¤ºçš„ï¼Œ110 + 11 = 1001 ï¼Œç¿»è¯‘æˆåè¿›åˆ¶å°±æ˜¯ï¼Œ6 + 3 = 9 1ã€ä»€ä¹ˆæ˜¯å…¨åŠ å™¨ åœ¨è®¡ç®—å‡ ä¸ªäºŒè¿›åˆ¶åŠ æ³•ä»¥åï¼Œæˆ‘ä»¬å‘ç°äº†ä¸€ä¸ªè§„å¾‹ï¼šæ—¢ç„¶åŠ æ³•éƒ½æ˜¯æŒ‰åˆ—è¿›è¡Œçš„ï¼Œè€Œä¸”æ¯ä¸€åˆ—çš„è®¡ç®—è¿‡ç¨‹éƒ½ä¸€æ · é‚£ä¹ˆå®Œå…¨å¯ä»¥è®¾è®¡ä¸€ä¸ªç”µè·¯æ¥å®Œæˆæ¯ä¸€åˆ—çš„ç›¸åŠ è¿‡ç¨‹ï¼Œå¦‚å›¾ 3.7 æ‰€ç¤º å›¾ 3.7 æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¦å¼€å§‹ä¸Šä¸€ç‚¹éš¾åº¦äº†ï¼Œæ³¨æ„å¬è®²ï¼ åœ¨å›¾ä¸­ï¼Œ A å’Œ B åˆ†åˆ«æ˜¯æ¥è‡ªâ€˜è¢«åŠ æ•°â€™å’Œâ€˜åŠ æ•°â€™çš„ä¸€ä¸ªæ¯”ç‰¹ï¼Œå®ƒä»¬æ­£å¥½åœ¨åŒä¸€åˆ—ä¸Šï¼› Ci æ˜¯æ¥è‡ªå³è¾¹ä¸€åˆ—çš„è¿›ä½ï¼› Co æ˜¯æœ¬åˆ—äº§ç”Ÿçš„è¿›ä½ï¼› S æ˜¯æœ¬åˆ—çš„â€œå’Œâ€ï¼› ä¸ºäº†è¡¨æ˜è¿™ä¸ªç”µè·¯çš„ç”¨é€”ï¼Œæˆ‘ä»¬åœ¨å›¾çš„ä¸­é—´åŠ äº†ä¸€ä¸ªç¬¦å· â€œâˆ‘â€ ã€‚åœ¨æ•°å­¦ä¸­ï¼Œè¿™ä¸ªç¬¦å·ç”¨æ¥è¡¨ç¤º â€œåŠ â€ æ—¢ç„¶æ˜¯ä¸€ä¸ªç”µè·¯ï¼Œå®ƒè‚¯å®šæœ‰ä¸€ä¸ªåå­—ã€‚æ˜¯çš„ï¼Œå®ƒå«å…¨åŠ å™¨ã€‚è¿™ä¸æ˜¯ä¸€ä¸ªå¾ˆå®¹æ˜“ç†è§£çš„åå­—ï¼Œç‰¹åˆ«æ˜¯è¿™ä¸ª â€œå…¨â€ å­— 2ã€ä»€ä¹ˆæ˜¯åŠåŠ å™¨ æ—¢ç„¶æœ‰å…¨åŠ å™¨ï¼Œæ˜¯ä¸æ˜¯è¿˜åº”è¯¥æœ‰â€œåŠåŠ å™¨â€ï¼Ÿ ä½ åˆ«è¯´ï¼Œè¿˜çœŸæœ‰åŠåŠ å™¨è¿™ä¸œè¥¿ã€‚ ä½†æ˜¯ï¼ŒåŠåŠ å™¨ä»…ä»…æ˜¯æŠŠæ¥è‡ªè¢«åŠ æ•°å’ŒåŠ æ•°çš„ä¸¤ä¸ªæ¯”ç‰¹åŠ èµ·æ¥ï¼Œäº§ç”Ÿä¸€ä¸ª â€œå’Œâ€ ä»¥åŠä¸€ä¸ªè¿›ä½ï¼Œå¹¶ä¸è€ƒè™‘ä»å…¶ä»–åˆ—æ¥çš„è¿›ä½ æ¢å¥è¯è¯´ï¼Œå®ƒåªæ˜¯ç”¨ç”µè·¯æ¥å®ç°äºŒè¿›åˆ¶åŠ æ³•å£è¯€ã€‚å…¨åŠ å™¨åˆ™ä¸ç„¶ï¼Œå®ƒçœŸæ­£å®ç°äº†äºŒè¿›åˆ¶åŠ æ³•ä¸­æ¯ä¸€åˆ—çš„åŠ æ³•è¿‡ç¨‹ï¼Œæ‰€ä»¥å®ƒæ‰å«åšâ€œå…¨åŠ å™¨â€ 3ã€å…¨åŠ å™¨çš„ç»„åˆ æœ‰äº†å…¨åŠ å™¨ï¼Œè§£å†³äº†äºŒè¿›åˆ¶åŠ æ³•è¿‡ç¨‹ä¸­æ¯ä¸€åˆ—çš„è®¡ç®—é—®é¢˜ï¼Œé‚£ä¹ˆï¼Œæˆ‘ä»¬å¯ä»¥æä¸€å¤§å †å…¨åŠ å™¨ï¼Œæ ¹æ®è¢«åŠ æ•°å’ŒåŠ æ•°çš„æ¯”ç‰¹æ•°ï¼ŒæŠŠå®ƒä»¬ä¸²è”èµ·æ¥ç»„æˆä¸€ä¸ªå®Œæ•´çš„åŠ æ³•ç”µè·¯ï¼Œå›¾ 3.8 æ˜¾ç¤ºäº†è¿™ä¸€è¿‡ç¨‹ å›¾ 3.8 å›¾ä¸­ï¼Œå‚ä¸ç›¸åŠ çš„ä¸¤ä¸ªäºŒè¿›åˆ¶æ•°åˆ†åˆ«æ˜¯ a2/a1/a0ï¼ˆå·¦ä¸Šä¸‰ä¸ªå¼€å…³ï¼‰ å’Œ b2/b1/b0ï¼ˆåº•éƒ¨ä¸‰ä¸ªå¼€å…³ï¼‰ï¼Œç»„æˆå®ƒä»¬çš„æ¯ä¸€ä¸ªæ¯”ç‰¹éƒ½å¯ä»¥ç”¨å¼€å…³çš„é—­åˆä¸æ–­å¼€æ¥å¾—åˆ° éšç€å¼€å…³çš„é—­åˆä¸æ–­å¼€ï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°ä¸€äº›äºŒè¿›åˆ¶æ•°ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥è®© a2/a1/a0 = 110 å› ä¸ºè¢«åŠ æ•°å’ŒåŠ æ•°å„è‡ªç”¨äº†3ä¸ªå¼€å…³ï¼Œæ‰€ä»¥æˆ‘ä»¬åªèƒ½è®¡ç®—3æ¯”ç‰¹çš„äºŒè¿›åˆ¶æ•°ï¼Œæ¯”å¦‚110 + 101 å¦‚æœæˆ‘ä»¬ä»”ç»†è§‚å¯Ÿçš„è¯ï¼Œä¼šå‘ç°å®ƒå¾ˆå®¹æ˜“è¿›è¡Œæ‰©å……ï¼Œä»¥è®¡ç®—æ›´å¤§çš„æ•°ï¼Œåªéœ€è¦ä¸²è”æ›´å¤šçš„å…¨åŠ å™¨å³å¯ å…¨æ–°çš„å¼€å§‹ï¼Œç”µä¸ç£ å…¨åŠ å™¨çš„äº‹æƒ…åˆ°è¿™é‡Œå…ˆå‘Šä¸€æ®µè½ï¼Œä»ç¬¬å››ç« å¼€å§‹ï¼Œä½œè€…å°†å¸¦é¢†æˆ‘ä»¬ä¸€èµ·æ¥å›é¡¾ç”µä¸ç£çš„å†å² å‰å‡ ç« ä»‹ç»çš„äºŒè¿›åˆ¶å•Šã€å…¨åŠ å™¨ç”µè·¯å•Šè¿™äº›éƒ½å…ˆæ”¾ä¸€è¾¹ï¼Œå¼€å§‹å…¨æ–°çš„æ—…ç¨‹ 1ã€ç”µèƒ½ç”Ÿç£ è€å®è¯´ï¼Œå°½ç®¡ä»è¡¨é¢ä¸Šçœ‹è®¡ç®—æœºæ˜¯ç¥å¥‡çš„ã€æ™ºæ…§çš„ï¼Œä½†æ©ç›–ä¸äº†å®ƒå®è´¨ä¸Šåªæ˜¯ä¸€ç§æ™®é€šç”µå™¨çš„äº‹å® è¿™ä¹Ÿæ„å‘³ç€ï¼Œè¦æƒ³ææ¸…æ¥šå®ƒå†…éƒ¨åˆ°åº•æ˜¯æ€ä¹ˆè¿ä½œçš„ï¼Œä»…ä»…é æŒæ¡ä¸€äº›ç®€å•çš„ç”µå­¦çŸ¥è¯†è¿˜ä¸å¤Ÿï¼Œè¿˜å¿…é¡»äº†è§£å¦å¤–ä¸€éƒ¨å«åšç”µç£å­¦çš„å†å²ã€‚ æ²¡æœ‰å®ƒæ‰€æä¾›çš„ç†è®ºçŸ¥è¯†å’Œç”µå­é›¶ä»¶ï¼Œè®¡ç®—æœºçš„å‘å±•ä¹Ÿå°±å¤±å»äº†æœ€åŸå§‹çš„åŸºç¡€ æˆ‘ä»¬å¼€å§‹å§ 1820å¹´çš„ä¸€å¤©ï¼Œä¸€ä¸ªå¶ç„¶çš„æœºä¼šï¼Œå¥¥æ–¯ç‰¹å‘ç°å½“ç”µè·¯æ¥é€šæ—¶ï¼Œç¦»ç”µçº¿å¾ˆè¿‘çš„ç£é’ˆä¼šå‘ç”Ÿåè½¬ å¥¥æ–¯ç‰¹çš„å¶ç„¶å‘ç°è¯´æ˜äº†ä¸€ä¸ªäº‹å®ï¼Œé‚£å°±æ˜¯ï¼Œç”µæµå¯ä»¥äº§ç”Ÿç£åœº å¦‚æœæˆ‘ä»¬åœ¨ä¸€é¢—é’‰å­ä¸Šç¼ ç»•ç”µçº¿ï¼Œé€šç”µä»¥åè¿™æ ¹é’‰å­å°±ä¼šå…·æœ‰ç£æ€§ï¼Œç»•çš„åœˆæ•°è¶Šå¤šï¼Œç£åŠ›ä¹Ÿå°±ä¼šè¶Šå¤§ï¼Œè¿™è¢«ç§°ä¸ºç”µç£é“ï¼Œå¦‚å›¾ 4.1 æ‰€ç¤º å›¾ 4.1 2ã€æ‘©å°”æ–¯ç”µç  ç”µå­¦å‘å±•çš„å†å²è¿˜åœ¨ç»§ç»­ ç”µç£é“è¢«å‘æ˜å‡ºæ¥ä»¥åï¼Œåœ¨1836å¹´å·¦å³ï¼Œç¾å›½å‘æ˜å®¶æ‘©å°”æ–¯åœ¨æ­¤åŸºç¡€ä¸Šå‘æ˜äº†ä¸€ç§å«åšç”µæŠ¥çš„ä¸œè¥¿ å®ƒç”±ä¸åœ¨ä¸€ä¸ªåœ°æ–¹çš„ä¸¤ä¸ªè£…ç½®ç»„æˆï¼Œç”¨å¾ˆé•¿çš„ç”µçº¿è¿æ¥èµ·æ¥ å›¾ 4.2 å¦‚å›¾ 4.2 æ‰€ç¤ºï¼Œä¸€æ—¦å¼€å…³é—­åˆï¼Œç”µç£é“ç”Ÿæ•ˆï¼Œè¡”é“è‡‚ï¼ˆå³ä¸Šéƒ¨åˆ†ï¼‰å°±ä¼šè¢«ç£æ€§å¸å¼•é è¿‘ç”µç£é“ï¼›å½“å¼€å…³æ¾å¼€ï¼Œç”µç£é“å¤±å»ç£æ€§ï¼Œè¡”é“è‡‚åˆåœ¨å¼¹ç°§çš„ç‰µå¼•ä¸‹å›åˆ°åŸæ¥çš„ä½ç½® æ‘©å°”æ–¯åœ¨è¡”é“è‡‚ç»‘ä¸Šäº†ä¸€æ”¯ç¬”ï¼Œå¹¶åœ¨ç¬”çš„ä¸‹é¢æ”¾ä¸€å·åŒ€é€Ÿå‰è¿›çš„çº¸ï¼Œå½“æˆ‘ä»¬é—­åˆå¼€å…³æ—¶ï¼Œåœ¨çº¸ä¸Šæ‰“å°å‡ºä¸€ä¸ªç‚¹ â€œÂ· â€ï¼Œé—­åˆçš„æ—¶é—´ç¨å¾®é•¿ä¸€äº›ï¼Œçº¸ä¸Šç•™ä¸‹ä¸€æ¡çº¿ â€œâ€”â€ ï¼Œè¿™ç§°ä¸ºâ€œåˆ’â€ æˆ‘ä»¬å¯ä»¥ä¸åœçš„å¼€åˆå¼€å…³ï¼Œåœ¨çº¸ä¸Šæ‰“å°å‡º &quot;Â·â€”Â·Â·â€”Â·â€”â€”Â·â€”Â·Â·Â·â€”â€”Â·Â·â€”Â·â€”&quot; å„ç§ç»„åˆå›¾æ¡ˆï¼Œå†é…ä¸Šè§£æè§„åˆ™ï¼Œæ¯”å¦‚ï¼Œå­—æ¯ â€œAâ€ æ˜¯ Â·â€”ï¼Œå­—æ¯ â€œVâ€ æ˜¯ Â·Â·Â·â€”ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è¿™æ ·çš„ç»„åˆå›¾æ¡ˆæ¥å‘é€ä¿¡æ¯äº† è¿™ï¼Œå°±æ˜¯æ‘©å°”æ–¯ç”µç çš„åŸç† 3ã€ç»§ç”µå™¨çš„å‘æ˜ å†å²ä¸Šç¬¬ä¸€ä»½é•¿é€”ç”µæŠ¥æ˜¯åœ¨1844å¹´5æœˆ24æ—¥å‘å‡ºçš„ï¼Œè¿™è¡¨æ˜è«å°”æ–¯çš„å‘æ˜å·²ç»å…·å¤‡äº†å®ç”¨æ€§ ä¸è¿‡ï¼Œå¦‚æœçº¿è·¯å¤ªé•¿ï¼Œç”µé˜»å°±ä¼šå˜å¤§ã€‚è¿™æ ·ï¼Œåœ¨ç”µæŠ¥çº¿è·¯çš„é‚£ä¸€å¤´ï¼Œå¾®å¼±çš„ç”µæµå°†ä¸èƒ½ä½¿ç”µç£é“æ­£å¸¸å¸åˆï¼Œç”µæŠ¥æ¥æ”¶æœºä¹Ÿå°±ä¸èƒ½æ­£å¸¸å·¥ä½œ å¥½åœ¨æˆ‘ä»¬æœ‰ç»§ç”µå™¨ï¼Œç»§ç”µå™¨çš„å‘æ˜å…¶å®æ¯”æ‘©å°”æ–¯ç”µç è¦æ›´æ—©ä¸€äº› 1831å¹´ï¼Œç¾å›½ç§‘å­¦å®¶çº¦ç‘Ÿå¤«Â·äº¨åˆ©ç”¨ç”µç£é“å‘æ˜äº†ç”µåŠ¨é—¨é“ƒï¼Œç‰¹åˆ«é€‚åˆä½¿ç”¨ç”µçº¿æ¥è¿›è¡Œé•¿è·ç¦»æ•²å“é—¨é“ƒ ç„¶åäº1835å¹´å‘æ˜ç”µå­ç»§ç”µå™¨ï¼Œå®ƒåˆ©ç”¨ç”µç£é“åœ¨é€šç”µå’Œæ–­ç”µä¸‹ç£åŠ›äº§ç”Ÿå’Œæ¶ˆå¤±çš„ç°è±¡ï¼Œæ¥æ§åˆ¶é«˜ç”µå‹é«˜ç”µæµçš„å¦ä¸€ç”µè·¯çš„å¼€åˆ æˆ‘ä»¬å¯ä»¥åœ¨å‘é€ç”µæŠ¥çš„ç”µçº¿åŠ è£… N å°ç»§ç”µå™¨ï¼Œè¿™æ ·å¯ä»¥è§£å†³é•¿è·ç¦»è¾“é€ï¼Œç”µæµä¼šå˜å°çš„é—®é¢˜ï¼Œå¦‚å›¾ 4.3 æ‰€ç¤ºã€‚ç»§ç”µå™¨çš„æ•°é‡ï¼Œå–å†³äºç”µæŠ¥çš„è¾“é€è·ç¦» å›¾ 4.3 ç»§ç”µå™¨çš„æœ¬è´¨æ˜¯â€œç»­â€ç”µ 4ã€ç£ä¹Ÿèƒ½ç”Ÿç”µ åœ¨å¥¥æ–¯ç‰¹å‘ç°ç”µæµèƒ½äº§ç”Ÿç£åœºä¹‹åï¼Œäººä»¬æƒ³åˆ°ï¼Œæ—¢ç„¶ç”µæµèƒ½å¤Ÿäº§ç”Ÿç£åœºï¼Œé‚£ä¹ˆåè¿‡æ¥ï¼Œç£åœºèƒ½ä¸èƒ½å˜æˆç”µæµå‘¢ï¼Ÿ 1831å¹´çš„ä¸€å¤©ï¼Œè‹±å›½çš„ç‰©ç†å­¦å®¶æ³•æ‹‰ç¬¬åšäº†ä¸€ä¸ªå®éªŒ å›¾ 4.6 æ³•æ‹‰ç¬¬ç”¨æ¥å°†ç£å˜æˆç”µçš„è£…ç½® å¦‚å›¾ 4.6 æ‰€ç¤ºï¼Œå·¦è¾¹çš„ç”µçº¿æ¥å¼€å…³å’Œç”µæºï¼Œè¿™å®é™…ä¸Šæ˜¯æŠŠæ•´ä¸ªå¤§é“åœˆå˜æˆäº†ä¸€ä¸ªç”µç£é“ã€‚ å½“é—­åˆå¼€å…³çš„æ—¶å€™ï¼Œçº¿åœˆä¸­æœ‰ç”µæµé€šè¿‡ï¼Œå¤§é“åœˆå°±äº§ç”Ÿäº†ç£åœºï¼Œå˜æˆäº†ä¸€ä¸ªç£é“ã€‚å³è¾¹çš„é‚£ä¸ªçº¿åœˆæ¥ç”µæµè®¡ï¼Œå½“ä»–åœ¨ç»™å·¦è¾¹çš„çº¿åœˆé€šç”µæ—¶ï¼Œåœ¨ç”µæºæ¥é€šçš„ä¸€ç¬é—´ï¼Œç”µæµè®¡æ‘†åŠ¨äº†ä¸€ä¸‹ å°±è¿™æ ·ï¼Œæ³•æ‹‰ç¬¬å‘ç°äº†ï¼Œå½“å¯¼ä½“åœ¨ç£åœºä¸­è¿åŠ¨çš„æ—¶å€™ï¼Œå°±èƒ½äº§ç”Ÿç”µæµï¼Œç£ç”Ÿç”µå°±æ­¤è¯ç”Ÿ ä¸‰ã€ç»“è¯­ ç”µä¸ç£çš„å†å²ç»ˆäºç»“æŸäº†ï¼Œä½†å…¶å®ï¼Œä¸ºäº†ä¸è®©æ–‡ç« çœ‹èµ·æ¥å¤ªé•¿ï¼Œæˆ‘æ•…æ„æ¼æ‰äº†åŸè‘—ä¸­4.4ã€4.5ã€4.6 è¿™ä¸‰ä¸ªå°èŠ‚çš„å†…å®¹ï¼Œå®ƒä»¬åˆ†åˆ«è®²çš„æ˜¯ï¼šç”µè¯çš„å‘æ˜ã€çˆ±è¿ªç”Ÿå¤§æˆ˜äº¤æµç”µä»¥åŠæ— çº¿ç”µé€šä¿¡çš„å¼€ç«¯ æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å¯„å‡ è´­ä¹°åŸè‘—ç¿»ä¸€ç¿» ä»ç¬¬äº”ç« å¼€å§‹ï¼Œä½œè€…å°†å¸¦é¢†æˆ‘ä»¬æ­£å¼å­¦ä¹ å’Œè®¡ç®—æœºæœ‰å…³çš„çŸ¥è¯†ï¼Œæˆ‘ä»¬ä¸‹ç¯‡æ–‡ç« è§ æœ€åï¼Œå¼•ç”¨ä½œè€…æå¿ çš„ä¸€å¥è¯ä½œä¸ºç»“å°¾ &quot;å­¦ä¹ è®¡ç®—æœºå°±åƒæ˜¯è€ƒå¤ï¼Œæˆ‘ä»¬å­¦ä¹ çŸ¥è¯†ä¸åº”è¯¥å’Œæ¸¸æˆè§„åˆ™ä¸€æ ·æ­»è®°ç¡¬èƒŒï¼Œæˆ‘æ›´å…³å¿ƒæ¯ä¸ªçŸ¥è¯†ç‚¹èƒŒåçš„æ•…äº‹ï¼ŒçŸ¥è¯†æ€ä¹ˆä¸€æ­¥æ­¥æ¥çš„&quot; å››ã€å‚è€ƒèµ„æ–™ ã€Šç©¿è¶Šè®¡ç®—æœºçš„è¿·é›¾ã€‹- æå¿  ç»§ç”µå™¨æ˜¯å¦‚ä½•æˆä¸ºCPUçš„ï¼ˆä¸€ï¼‰ - BITç¥å¨ ç»§ç”µå™¨æ˜¯å¦‚ä½•æˆä¸ºCPUçš„ï¼ˆäºŒï¼‰ - BITç¥å¨ çº¢çŸ³ç”µè·¯æ•™ç¨‹ - æˆ‘çš„ä¸–ç•Œå®˜ç½‘ ","link":"https://yibaoshan.github.io/post/book-notes-computers-lizhong-1/"},{"title":"ä¸ºä»€ä¹ˆä¼šå‘ç”Ÿ Fragment not attached to Activity å¼‚å¸¸ï¼Ÿ","content":" ç‚¹å‡»è·³è½¬åˆ°æ˜é‡‘é˜…è¯» äº‹æƒ…æ˜¯è¿™æ ·çš„ï¼Œå‰ä¸¤å¤©æœ‰ä½å¤§ä½¬åœ¨ç¾¤é‡Œæäº†ä¸ªé—®é¢˜ï¼ŒåŸæ–‡å¦‚ä¸‹ ä¸€ä¸ª Fragment åœ¨ç‚¹å‡»æŒ‰é’®è·³è½¬ä¸€ä¸ªæ–°çš„ Activity çš„æ—¶å€™ï¼ŒæŠ¥å´©æºƒå¼‚å¸¸ï¼šFragment not attached to Activity é—®ï¼šå¤ç°è·¯å¾„å¯èƒ½æ˜¯ä»€ä¹ˆæ ·çš„å‘¢ï¼Ÿ ä¸€ã€å›ç­”é—®é¢˜å‰å…ˆå®¡é¢˜ æˆ‘ä»¬æŠŠè¿™ä¸ªé—®é¢˜çš„å‡ ä¸ªå…³é”®è¯åœˆå‡ºæ¥ é¦–å…ˆï¼Œå¯ä»¥ç‚¹å‡» Fragment ä¸Šçš„æŒ‰é’®ï¼Œè¯æ˜è¿™ä¸ª Fragment æ˜¯å¯ä»¥è¢«çœ‹åˆ°çš„ï¼Œé‚£è‚¯å®šæ˜¯å¤„äºå­˜æ´»çš„çŠ¶æ€çš„ å…¶æ¬¡ï¼Œåœ¨è·³è½¬åˆ°æ–°çš„ Activity çš„æ—¶å€™å‘ç”Ÿå´©æºƒï¼Œè¯æ˜ Fragment è°ƒç”¨çš„æ˜¯ startActivity() æ–¹æ³• æœ€åï¼Œæ¥çœ‹å¼‚å¸¸ä¿¡æ¯ï¼šFragment not attached to Activity è¿™ä¸ªæŠ¥é”™æˆ‘ä»¬éƒ½å·²ç»å¾ˆç†Ÿæ‚‰äº†ï¼Œåœ¨ onAttach() ä¹‹å‰ï¼Œæˆ–è€… onDetach() ä¹‹åï¼Œè°ƒç”¨ä»»ä½•å’Œ Context ç›¸å…³çš„æ–¹æ³•ï¼Œéƒ½ä¼šæŠ›å‡º &quot; not attached to Activity &quot; å¼‚å¸¸ å‘ç”Ÿçš„åŸå› å¾€å¾€æ˜¯å› ä¸ºå¼‚æ­¥ä»»åŠ¡å¯¼è‡´çš„ï¼Œæ¯”å¦‚ä¸€ä¸ªç½‘ç»œè¯·æ±‚å›æ¥ä»¥åï¼Œå†è°ƒç”¨äº† startActivity() è¿›è¡Œé¡µé¢è·³è½¬ï¼Œæˆ–è€…è°ƒç”¨ getResources() è·å–èµ„æºæ–‡ä»¶ç­‰ç­‰ è§£å†³æ–¹æ¡ˆä¹Ÿéå¸¸ç®€å•ï¼šåœ¨ Fragment è°ƒç”¨äº† Context ç›¸å…³æ–¹æ³•å‰ï¼Œå…ˆé€šè¿‡ isAdded() æ–¹æ³•æ£€æŸ¥ Fragment çš„å­˜æ´»çŠ¶æ€å°±å®Œäº‹äº† åˆ°è¿™é‡Œï¼Œå´©æºƒäº§ç”Ÿçš„åŸå› æ‰¾åˆ°äº†ï¼Œè§£å†³æ–¹æ¡ˆä¹Ÿæœ‰äº†ï¼Œä¼¼ä¹æ•´ç¯‡æ–‡ç« å°±å¯ä»¥ç»“æŸäº† ä½†æ˜¯ï¼Œæ¥¼ä¸»é—®çš„æ˜¯ï¼šå¤ç°è·¯å¾„å¯èƒ½æ˜¯ä»€ä¹ˆæ ·çš„å‘¢ï¼Ÿ è¿™å‹¾èµ·äº†æˆ‘çš„å¥½å¥‡å¿ƒï¼Œæˆ‘ä¹Ÿæƒ³çŸ¥é“å¯èƒ½çš„è·¯å¾„æ˜¯æ€æ ·çš„ äºæ˜¯ï¼Œåœ¨æ¥ä¸‹æ¥çš„ä¸¤ä¸ªæ™šä¸Šï¼Œç¬”è€…å¼€å§‹äº†ä¸€åœºæºç ä¹‹æ—….. äºŒã€å¤§èƒ†å‡è®¾ï¼Œå°å¿ƒæ±‚è¯ å®¡é¢˜ç»“æŸæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹åŠ¨æ‰‹è§£ç­”äº†ï¼Œä»¥ä¸‹æ˜¯ç¾¤é‡Œçš„å®Œæ•´å¯¹è¯ å¤§ä½¬ï¼šä¸€ä¸ª Fragment åœ¨ç‚¹å‡»æŒ‰é’®è·³è½¬ä¸€ä¸ªæ–°çš„ Activity çš„æ—¶å€™ï¼ŒæŠ¥å´©æºƒå¼‚å¸¸ï¼šFragment not attached to Activity ã€‚å¤ç°è·¯å¾„å¯èƒ½æ˜¯ä»€ä¹ˆæ ·çš„å‘¢ï¼Ÿ æˆ‘ï¼šè¿™ä¸ªé—®é¢˜ä¹‹å‰åœ¨é¡¹ç›®ä¸­ä¹Ÿæœ‰ç¢°åˆ°è¿‡ï¼Œå½“æ—¶çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼Œé€šè¿‡è°ƒç”¨ isAdded() æ¥æ£€æŸ¥ Fragment æ˜¯å¦è¿˜æ´»ç€ï¼Œæ¥é¿å…å› ä¸ºä¸Šä¸‹æ–‡ä¸ºç©ºå¯¼è‡´çš„å´©æºƒ å½“æ—¶å¿™äºåšä¸šåŠ¡æ²¡æœ‰æ·±å…¥ç ”ç©¶ï¼Œç°åœ¨è¶ç€æ™šä¸Šæœ‰æ—¶é—´æ¥ç ”ç©¶ä¸€ä¸‹ä¸‹ é¦–å…ˆï¼Œæ‰“å¼€ Fragment æºç ï¼Œè·¯å¾„åœ¨ï¼šframeworks/base/core/java/android/app/Fragment.java ç”¨ â€œnot attached to Activityâ€ ä½œä¸ºå…³é”®å­—æœç´¢ï¼Œå¯ä»¥å‘ç° getResources() ã€getLoaderManager() ã€startActivity() ç­‰ç­‰å…±è®¡ 6 å¤„åœ°æ–¹ï¼Œéƒ½å¯èƒ½æŠ›å‡ºè¿™ä¸ªå¼‚å¸¸ é¢˜ç›®æ˜ç¡®æåˆ°ï¼Œæ˜¯è·³è½¬ Activity æ—¶å‘ç”Ÿçš„é”™è¯¯ï¼Œé‚£æˆ‘ä»¬ç›´æ¥æ¥çœ‹ startActivity() æ–¹æ³• class Fragment { void startActivity(){ if (mHost == null) throw new IllegalStateException(&quot;Fragment &quot; + this + &quot; not attached to Activity&quot;); } } ä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹å‡ºï¼Œå½“ mHost å¯¹è±¡ä¸ºç©ºæ—¶ï¼Œç¨‹åºæŠ›å‡º Fragment not attached to Activity å¼‚å¸¸ å¥½ï¼Œç°åœ¨æˆ‘ä»¬çš„é—®é¢˜è½¬å˜ä¸º: mHost å¯¹è±¡ä»€ä¹ˆæ—¶å€™ä¼šè¢«èµ‹å€¼ï¼Ÿ å¾ˆæ˜¾ç„¶ï¼Œå¦‚æœåœ¨èµ‹å€¼å‰è°ƒç”¨äº† startActivity() æ–¹æ³•ï¼Œé‚£ç¨‹åºå¿…ç„¶ä¼šå´©æºƒ mHost å¯¹è±¡èµ‹å€¼ä»¥åï¼Œå¯èƒ½ä¼šè¢«ç½®ç©ºå—ï¼Ÿå¦‚æœä¼šï¼Œä»€ä¹ˆæ—¶å€™å‘ç”Ÿï¼Ÿ æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒFragment ä¾èµ– Activity æ‰èƒ½ç”Ÿå­˜ï¼Œé‚£æˆ‘ä»¬æœ‰ç†ç”±æ€€ç–‘ï¼š å½“ Activity æ‰§è¡Œ stop / destroy ï¼Œæˆ–è€…ï¼Œé…ç½®å‘ç”Ÿå˜åŒ–ï¼ˆæ¯”å¦‚å±å¹•æ—‹è½¬ï¼‰å¯¼è‡´ Activity é‡å»ºï¼Œä¼šä¸ä¼šå°† mHost å¯¹è±¡ä¹Ÿç½®ç©ºå‘¢ï¼Ÿ mHost å¯¹è±¡ä»€ä¹ˆæ—¶å€™ä¼šè¢«èµ‹å€¼ï¼Ÿ å…ˆæ¥çœ‹ç¬¬ä¸€ä¸ªé—®é¢˜ï¼ŒmHost å¯¹è±¡ä»€ä¹ˆæ—¶å€™ä¼šè¢«èµ‹å€¼ï¼Ÿ å¹³æ—¶æˆ‘ä»¬ä½¿ç”¨ Fragment å¼€å‘æ—¶ï¼Œé€šå¸¸éƒ½æ˜¯ç›´æ¥ new ä¸€ä¸ªå¯¹è±¡å‡ºæ¥ï¼Œç„¶åå†æäº¤ç»™ FragmentManager å»æ˜¾ç¤º åˆ›å»º Fragment å¯¹è±¡çš„æ—¶å€™ï¼Œä¸è¦æ±‚ä¼ å…¥ mHost å‚æ•°ï¼Œé‚£ mHost å¯¹è±¡åªèƒ½æ˜¯ Android ç³»ç»Ÿå¸®æˆ‘ä»¬èµ‹å€¼çš„äº† å¾—ï¼Œåˆå¾—å»ç¿»æºç  æ‰“å¼€ FragmentManager.java ï¼Œè·¯å¾„åœ¨ï¼š/frameworks/base/core/java/android/app/FragmentManager.java class FragmentManager { FragmentHostCallback mHost; // å†…éƒ¨æŒæœ‰ Context å¯¹è±¡ï¼Œå…¶æœ¬è´¨æ˜¯å®¿ä¸» Activity void moveToState(f,newState){ switch(f.mState){ case Fragment.INITIALIZING: f.mHost = mHost; // èµ‹å€¼ Fragment çš„ mHost å¯¹è±¡ f.onAttach(mHost.getContext()); } f.mState = newState; } } æˆ‘ä»¬å‘ç°æºç é‡Œåªæœ‰ä¸€ä¸ªåœ°æ–¹ä¼šç»™ mHost å¯¹è±¡èµ‹å€¼ï¼Œåœ¨ FragmetnManager#moveToState() æ–¹æ³•ä¸­ å¦‚æœå½“å‰ Fragment çš„çŠ¶æ€æ˜¯ INITIALIZING ï¼Œé‚£ä¹ˆå°±æŠŠ FragmentManager è‡ªèº«çš„ mHost å¯¹è±¡ï¼Œèµ‹å€¼ç»™ Fragment çš„ mHost å¯¹è±¡ è¿™é‡Œå¤šè¯´ä¸€å¥ï¼Œåœ¨ Android ç³»ç»Ÿä¸­ï¼Œä¸€ä¸ª Activity åªä¼šå¯¹åº”ä¸€ä¸ª FragmentManager ç®¡ç†è€…ã€‚è€Œ FragmentManager ä¸­çš„ mHost ï¼Œå…¶æœ¬è´¨ä¸Šå°±æ˜¯ Activity å®¿ä¸»ã€‚ æ‰€ä»¥ï¼Œè¿™é‡ŒæŠŠ FragmentManager çš„ mHost å¯¹è±¡ï¼Œèµ‹å€¼ç»™äº† Fragment ï¼Œå°±ç›¸å½“äº Fragment ä¹ŸæŒæœ‰äº†å®¿ä¸» Activity è¿™ä¹Ÿè§£é‡Šäº†æˆ‘ä»¬ä¹‹æ‰€ä»¥èƒ½åœ¨ Fragment ä¸­è°ƒç”¨ getResource() ã€startActivity() ç­‰éœ€è¦ context çš„æ‰èƒ½è®¿é—®æ–¹æ³•ï¼Œå®é™…ä½¿ç”¨çš„å°±æ˜¯ Activity çš„ä¸Šä¸‹æ–‡ åºŸè¯è¯´å®Œäº†ï¼Œæˆ‘ä»¬æ¥èŠæ­£äº‹ FragmentManager#moveToState() æ–¹æ³•ä¼šå…ˆå»åˆ¤æ–­ Fragment çš„çŠ¶æ€ï¼Œé‚£æˆ‘ä»¬é¦–å…ˆå¾—çŸ¥é“ Fragment æœ‰å“ªå‡ ç§çŠ¶æ€ class Fragment { int INITIALIZING = 0; // Not yet created. int CREATED = 1; // Created. int ACTIVITY_CREATED = 2; // The activity has finished its creation. ... // å…±6ç§æ ‡è¯† int mState = INITIALIZING; // é»˜è®¤ä¸º INITIALIZING } Google ä¸º Fragment å…±å£°æ˜äº†6ä¸ªçŠ¶æ€æ ‡è¯†ç¬¦ï¼Œå„ä¸ªæ ‡è¯†ç¬¦çš„å«ä¹‰çœ‹æ³¨é‡Šå³å¯ è¿™é‡Œé‡ç‚¹å…³æ³¨æ ‡è¯†ç¬¦ä¸‹é¢çš„ mState å˜é‡ï¼Œå®ƒè¡¨ç¤ºçš„æ˜¯ Fragment å½“å‰çš„çŠ¶æ€ï¼Œé»˜è®¤ä¸º INITIALIZING äº†è§£å®Œ Fragment çš„çŠ¶æ€æ ‡è¯†ï¼Œæˆ‘ä»¬å›è¿‡å¤´ç»§ç»­æ¥çœ‹ FragmentManager#moveToState() æ–¹æ³• class FragmentManager { void moveToState(f,newState){ switch(f.mState){ case Fragment.INITIALIZING: // å¿…èµ°é€»è¾‘ f.mHost = mHost; // èµ‹å€¼ Fragment çš„ mHost å¯¹è±¡ f.onAttach(mHost.getContext()); } f.mState = newState; } } åœ¨ moveToState() æ–¹æ³•ä¸­ï¼Œåªè¦å½“å‰ Fragment çŠ¶æ€ä¸º INITIALIZING ï¼Œå³æ‰§è¡Œ mHost çš„èµ‹å€¼æ“ä½œ å·§äº†ä¸æ˜¯ï¼Œå‰é¢åˆšè¯´å®Œï¼ŒmState é»˜è®¤å€¼å°±æ˜¯ INITIALIZING ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨ moveToState() æ–¹æ³•æ—¶ï¼Œä¸ç®¡æ¥ä¸‹æ¥ Fragment è¦è½¬å˜æˆä»€ä¹ˆçŠ¶æ€ï¼ˆæ ¹æ® newState çš„å€¼æ¥åˆ¤æ–­ï¼‰ é¦–å…ˆï¼Œå®ƒéƒ½å¾—ä» INITIALIZING çŠ¶æ€å˜è¿‡å»ï¼é‚£ä¹ˆï¼Œcase = Fragment.INITIALIZING è¿™ä¸ªåˆ†æ”¯å¿…ç„¶ä¼šè¢«æ‰§è¡Œï¼ï¼è¿™æ—¶å€™ï¼ŒmHost ä¹Ÿå¿…ç„¶ä¼šè¢«èµ‹å€¼ï¼ï¼ï¼ å†ç„¶åï¼Œæ‰ä¼šæœ‰ onAttach() / onCreate() / onStart() ç­‰ç­‰è¿™äº›ç”Ÿå‘½å‘¨æœŸçš„å›è°ƒï¼ å› æ­¤ï¼Œæˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªçŒœæƒ³ï¼šåœ¨ mHost å¯¹è±¡èµ‹å€¼å‰ï¼Œæœ‰æ²¡æœ‰å¯èƒ½è°ƒç”¨ startActivity() æ–¹æ³•ï¼Ÿ ç­”æ¡ˆæ˜¾ç„¶æ˜¯å¦å®šçš„ å› ä¸ºï¼Œæ ¹æ®æ¥¼ä¸»æè¿°ï¼Œç‚¹å‡»æŒ‰é’®ä»¥åæ‰å‘ç”Ÿçš„å´©æºƒï¼Œè§†å›¾èƒ½æ˜¾ç¤ºå‡ºæ¥ï¼Œè¯´æ˜ mHost å·²ç»èµ‹å€¼è¿‡å¹¶ä¸”ç”Ÿå‘½å‘¨æœŸéƒ½æ­£å¸¸èµ° é‚£å°±åªå¯èƒ½æ˜¯ç‚¹å‡»æŒ‰é’®åï¼Œå‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…ï¼Œå°† mHost åˆç½®ä¸º null äº† mHost å¯¹è±¡ä»€ä¹ˆæ—¶å€™ä¼šè¢«ç½®ç©ºï¼Ÿ ç»§ç»­ï¼Œæ¥çœ‹ç¬¬äºŒä¸ªé—®é¢˜ï¼šmHost å¯¹è±¡èµ‹å€¼ä»¥åï¼Œå¯èƒ½ä¼šè¢«ç½®ç©ºå—ï¼Ÿå¦‚æœä¼šï¼Œä»€ä¹ˆæ—¶å€™å‘ç”Ÿï¼Ÿ æˆ‘ä»¬å°±ä¸ç»•å¼¯äº†ï¼Œç›´æ¥è¯´ç­”æ¡ˆï¼Œä¼šï¼ ç½®ç©º mHost çš„é€»è¾‘ï¼ŒåŒæ ·è—åœ¨ FragmentManager çš„æºç é‡Œï¼š class FragmentManager { void moveToState(f,newState){ if (f.mState &lt; newState) { switch(f.mState){ case Fragment.INITIALIZING: f.mHost = mHost; // mHost å¯¹è±¡èµ‹å€¼ } } else if (f.mState &gt; newState) { switch (f.mState) { case Fragment.CREATED: if (newState &lt; Fragment.CREATED) { f.performDetach(); // è°ƒç”¨ Fragment çš„ onDetach() if (!f.mRetaining) { makeInactive(f); // é‡ç‚¹1å·ï¼Œè¿™é‡Œä¼šæ¸…ç©º mHost } else { f.mHost = null; // é‡ç‚¹2å·ï¼Œè¿™é‡Œä¹Ÿä¼šæ¸…ç©º mHost å¯¹è±¡ } } } } f.mState = newState; } void makeInactive(f) { f.initState(); // æ­¤è°ƒç”¨ä¼šæ¸…ç©º Fragment å…¨éƒ¨çŠ¶æ€ï¼ŒåŒ…æ‹¬ mHost } } çœ‹ä¸Šé¢çš„ä»£ç ï¼Œåˆ†å‘ Fragment çš„ performDetach() æ–¹æ³•åï¼Œç´§æ¥ç€å°±ä¼šæŠŠ mHost å¯¹è±¡ç½®ç©ºï¼ æ ‡è®°ä¸º &quot;é‡ç‚¹1å·&quot; å’Œ &quot;é‡ç‚¹2å·&quot; çš„ä»£ç éƒ½ä¼šæ‰§è¡Œäº†ç½®ç©º mHost å¯¹è±¡çš„é€»è¾‘ï¼Œä¸¤è€…çš„åŒºåˆ«æ˜¯ï¼š Fragment æœ‰ä¸€ä¸ªä¿ç•™å®ä¾‹çš„æ¥å£ setRetainInstance(bool) ï¼Œå¦‚æœè®¾ç½®ä¸º true ï¼Œé‚£ä¹ˆåœ¨é”€æ¯é‡å»º Activity æ—¶ï¼Œä¸ä¼šé”€æ¯è¯¥ Fragment çš„å®ä¾‹å¯¹è±¡ å½“ç„¶è¿™ä¸æ˜¯æœ¬èŠ‚çš„é‡ç‚¹ï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“ï¼šæ‰§è¡Œå®Œ performDetach() æ–¹æ³•åï¼Œæ— è®ºå¦‚ä½•ï¼ŒmHost ä¹Ÿéƒ½æ´»ä¸äº†äº† é‚£ï¼Œä»€ä¹ˆåŠ¨ä½œä¼šè§¦å‘ performDetach() æ–¹æ³•ï¼Ÿ 1ã€Activity é”€æ¯é‡å»º ä¸ç®¡å› ä¸ºä»€ä¹ˆåŸå› ï¼Œåªè¦ Activity è¢«é”€æ¯ï¼ŒFragment ä¹Ÿä¸èƒ½ç‹¬å–„å…¶èº«ï¼Œæ‰€æœ‰çš„ Fragment éƒ½ä¼šè¢«ä¸€èµ·é”€æ¯ï¼Œå¯¹åº”çš„ç”Ÿå‘½å‘¨æœŸå¦‚ä¸‹ï¼š Activity#onDestroy() -&gt; Fragment#onDestroyView() - &gt; Fragment#onDestroy() - &gt;Fragment#onDetach() 2ã€è°ƒç”¨ FragmentTransaction#remove() æ–¹æ³•ç§»é™¤ Fragment remove() æ–¹æ³•ä¼šç§»é™¤å½“å‰çš„ Fragment å®ä¾‹ï¼Œå¦‚æœè¿™ä¸ª Fragment æ­£åœ¨å±å¹•ä¸Šæ˜¾ç¤ºï¼Œé‚£ä¹ˆ Android ä¼šå…ˆç§»é™¤è§†å›¾ï¼Œå¯¹åº”çš„ç”Ÿå‘½å‘¨æœŸå¦‚ä¸‹ï¼š Fragment#onPause() -&gt; onStop() -&gt; onDestroyView() - &gt; onDestroy() - &gt;onDetach() 3ã€è°ƒç”¨ FragmentTransaction#replace() æ–¹æ³•æ˜¾ç¤ºæ–°çš„ Fragment replace() æ–¹æ³•ä¼šå°†æ‰€æœ‰çš„ Fragment å®ä¾‹å¯¹è±¡éƒ½ç§»é™¤æ‰ï¼Œåªä¼šä¿ç•™å½“å‰æäº¤çš„ Fragment å¯¹è±¡ï¼Œç”Ÿå‘½å‘¨æœŸå‚è€ƒ remove() æ–¹æ³• ä»¥ä¸Šä¸‰ç§åœºæ™¯ï¼Œæ˜¯æˆ‘è‡ªå·±åšæµ‹è¯•å¾—å‡ºæ¥çš„ç»“æœï¼Œåº”è¯¥è¿˜æœ‰å…¶ä»–æ²¡æµ‹å‡ºæ¥çš„åœºæ™¯ï¼Œæ¬¢è¿å¤§ä½¬è¡¥å…… å¦å¤–ï¼ŒFragmentTransaction ä¸­è¿˜æœ‰ä¸¤ä¸ªå¸¸ç”¨çš„ detach() / hide() æ–¹æ³•ï¼Œå®ƒä¿©åªä¼šå°†è§†å›¾ç§»é™¤æˆ–éšè—ï¼Œè€Œä¸ä¼šè§¦å‘ performDetach() æ–¹æ³• çœŸç›¸æ°¸è¿œåªæœ‰ä¸€ä¸ª å¥½äº†ï¼Œç°åœ¨æˆ‘ä»¬çŸ¥é“äº† mHost å¯¹è±¡ç½®ç©ºçš„æ—¶æœºï¼Œç­”æ¡ˆå·²ç»è¶Šæ¥è¶Šè¿‘äº† æˆ‘ä»¬å…ˆæ¥æ±‡æ€»ä¸‹å·²æœ‰çš„çº¿ç´¢ ä» FragmentManager æºç æ¥çœ‹ï¼Œåªè¦æˆ‘ä»¬çš„ startActivity() é¡µé¢è·³è½¬é€»è¾‘å†™åœ¨ï¼š onAttach() æ–¹æ³•æ‰§è¡Œä¹‹å ï¼ŒonDetach() æ–¹æ³•æ‰§è¡Œä¹‹å‰ é‚£ç»“æœä¸€å®šæ€»æ˜¯èƒ½å¤Ÿè·³è½¬æˆåŠŸï¼Œä¸ä¼šæŠ¥é”™ï¼ é‚£ä¹ˆé—®é¢˜å°±æ¥äº† onAttach() ä¹‹å‰ï¼Œè§†å›¾ä¸å­˜åœ¨ï¼ŒonDetach() ä¹‹åï¼Œè§†å›¾éƒ½å·²ç»é”€æ¯äº†ï¼Œè¿˜ç‚¹å‡»å“ªé—¨å­æŒ‰é’®ï¼Ÿ è¿™å¥è¯ç¿»è¯‘ä¸€ä¸‹å°±æ˜¯ï¼š è§†å›¾åœ¨ï¼ŒActivity åœ¨ï¼Œç‚¹å‡»äº‹ä»¶æ­£å¸¸å“åº” è§†å›¾ä¸åœ¨ï¼ŒæŒ‰é’®ä¹Ÿä¸åœ¨äº†å‘€ï¼Œä¹Ÿå°±ä¸å­˜åœ¨é¡µé¢è·³è½¬äº† è¿™æ ·çœ‹èµ·æ¥ï¼Œä¼¼ä¹æ°¸è¿œä¸ä¼šå‡ºç°æ¥¼ä¸»è¯´çš„é”™è¯¯å˜› é™¤éã€‚ã€‚ã€‚ æ‰§è¡Œ startActivity() æ–¹æ³•çš„æ—¶å€™ï¼Œè§†å›¾å·²ç»ä¸åœ¨äº†ï¼ï¼ï¼ è¿™å¬èµ·æ¥å¾ˆç†Ÿæ‚‰ï¼Œummmmmmã€‚ã€‚è¿™ä¸å°±æ˜¯å¼‚æ­¥è°ƒç”¨å—ï¼Ÿ class Fragment { void onClick(){ //do something Handler().postDelayed(startActivity(),1000); } } ä¸Šé¢æ˜¯ä¸€æ®µå¼‚æ­¥è°ƒç”¨çš„æ¼”ç¤ºä»£ç ï¼Œä¸ºäº†çœäº‹æˆ‘ç›´æ¥ç”¨ Handler æäº¤äº†å»¶è¿Ÿæ¶ˆæ¯ å½“ç”¨æˆ·ç‚¹å‡»è·³è½¬æŒ‰é’®åï¼Œä¸€æ—¦å‘ç”Ÿ Activity é”€æ¯é‡å»ºï¼Œæˆ–è€… Fragment è¢«ç§»é™¤çš„æƒ…å†µ ç­‰å¾… 1s æ‰§è¡Œ startActivity() æ–¹æ³•æ—¶ï¼Œç¨‹åºå°±ä¼šå‘ç”Ÿå´©æºƒï¼Œè¿™æ—¶å€™ç»ˆäºå¯ä»¥çœ‹åˆ°æˆ‘ä»¬æœŸå¾…å·²ä¹…çš„å¼‚å¸¸ï¼šFragment not attached to Activity ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿç†Ÿæ‚‰ Java çš„å°ä¼™ä¼´è¿™é‡Œè‚¯å®šè¦è¯´äº†ï¼Œå› ä¸ºæäº¤åˆ° Handler çš„ Runnable ä¼šæŒæœ‰å¤–éƒ¨ç±»å‘€ï¼Œä¹Ÿå°±æ˜¯å®¿ä¸» Fragment çš„å¼•ç”¨ã€‚å¦‚æœåœ¨æ‰§è¡Œ Runnable#run() æ–¹æ³•ä¹‹å‰ï¼Œ Fragment çš„ mHost è¢«æ¸…ç©ºï¼Œé‚£ç¨‹åºè‚¯å®šä¼šå‘ç”Ÿå´©æºƒçš„ é‚£æˆ‘ä»¬æ€ä¹ˆæ ·æ‰èƒ½é˜²æ­¢ç¨‹åºå´©æºƒå‘¢ï¼Ÿ è¦ä¹ˆï¼ŒåŒæ­¥æ‰§è¡Œ Context ç›¸å…³æ–¹æ³• è¦ä¹ˆï¼Œå¼‚æ­¥åˆ¤ç©ºï¼Œç”¨åˆ° Context å‰è°ƒç”¨ isAdded() æ–¹æ³•æ£€æŸ¥ Fragment å­˜æ´»çŠ¶æ€ ä¸‰ã€ç»“è¯­ å‘¼~ è¿™ä¸‹æ€»ç®—æ˜¯ç†æ¸…äº†ï¼Œæˆ‘ä»¬æ¥å°è¯•å›ç­”æ¥¼ä¸»çš„é—®é¢˜ï¼šå‘ç”Ÿ not attached to Activityï¼Œå¯èƒ½è·¯å¾„æ˜¯æ€æ ·çš„ï¼Ÿ é¦–å…ˆï¼Œå¿…ç„¶å­˜åœ¨ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡æŒæœ‰ Fragment å¼•ç”¨ï¼Œå¹¶ä¸”å†…éƒ¨è°ƒç”¨äº† startActivity() æ–¹æ³•ã€‚ åœ¨è¿™ä¸ªå¼‚æ­¥ä»»åŠ¡æäº¤ä¹‹åï¼Œæ‰§è¡Œä¹‹å‰ï¼Œä¸€æ—¦å‘ç”Ÿäº†ä¸‹é¢åˆ—è¡¨ä¸­ï¼Œä¸€ä¸ªæˆ–å¤šä¸ªçš„æƒ…å†µæ—¶ï¼Œç¨‹åºå°±ä¼šæŠ›å‡º not attached to Activity å¼‚å¸¸ï¼š è°ƒç”¨ finishXXX() ç»“æŸäº† Activityï¼Œå¯¼è‡´ Activity ä¸ºç©º æ‰‹åŠ¨è°ƒç”¨ Activity#recreate() æ–¹æ³•ï¼Œå¯¼è‡´ Activity é‡å»º æ—‹è½¬å±å¹•ã€é”®ç›˜å¯ç”¨æ€§æ”¹å˜ã€æ›´æ”¹è¯­è¨€ç­‰é…ç½®æ›´æ”¹ï¼Œå¯¼è‡´ Activity é‡å»º å‘ FragmentManager æäº¤ remove() / replace() è¯·æ±‚ï¼Œå¯¼è‡´ Fragment å®ä¾‹è¢«é”€æ¯ ... æœ€åï¼Œå‘ç”Ÿè¿™ä¸ªé”™è¯¯ä¿¡æ¯çš„æœ¬è´¨ï¼Œæ˜¯åœ¨ Activity ã€Fragment é”€æ¯æ—¶ï¼Œæ²¡æœ‰åŒæ­¥å–æ¶ˆå¼‚æ­¥ä»»åŠ¡ï¼Œè¿™æ˜¯å†…å­˜æ³„æ¼å•Š æ‰€ä»¥ï¼Œé™¤äº†ä½¿ç”¨ isAdded() æ–¹æ³•åˆ¤ç©ºï¼Œé¿å…ç¨‹åºå´©æºƒå¤–ï¼Œæ›´åº”è¯¥æ’æŸ¥å“ªé‡Œå¯èƒ½ä¼šé•¿æ—¶é—´å¼•ç”¨è¯¥ Fragment å¦‚æœå¯èƒ½ï¼Œåœ¨ Fragment çš„ onDestroy() æ–¹æ³•ä¸­ï¼Œå–æ¶ˆå¼‚æ­¥ä»»åŠ¡ï¼Œæˆ–è€…ï¼ŒæŠŠ Fragment æ”¹ä¸ºå¼±å¼•ç”¨ å››ã€å‚è€ƒèµ„æ–™ android-7.1 - Fragment android-7.1 - FragmentManager ","link":"https://yibaoshan.github.io/post/fragment-not-attached-to-activity-exception/"},{"title":"Androidç»„ä»¶ç³»åˆ—ï¼šå†è°ˆHandleræœºåˆ¶ï¼ˆNativeç¯‡ï¼‰","content":" ç‚¹å‡»è·³è½¬åˆ°æ˜é‡‘é˜…è¯» ç¬”è€…ä¹‹å‰å·²ç»å†™è¿‡ä¸€ç¯‡å…³äº Java å±‚ Handler æœºåˆ¶çš„æ–‡ç« ï¼Œä»åº”ç”¨å¼€å‘çš„è§’åº¦å‡ºå‘ï¼Œè¯¦ç»†ä»‹ç»äº† Handler æœºåˆ¶çš„è®¾è®¡èƒŒæ™¯ï¼Œä»¥åŠå¦‚ä½•è‡ªå·±å¦‚ä½•æ‰‹å†™ä¸€å¥— Handler æœ¬ç¯‡æ–‡ç« æˆ‘ä»¬å°†æ·±å…¥ Native å±‚ï¼Œä¸€èµ·æ¥æ¢ç©¶ Looper#loop() ä¸ºä»€ä¹ˆä¸ä¼šå¡æ­»ä¸»çº¿ç¨‹èƒŒåçš„åŸå›  ä»¥ä¸‹ï¼Œenjoyï¼š ä¸€ã€å¼€ç¯‡ ä» Android 2.3 å¼€å§‹ï¼ŒGoogle æŠŠ Handler çš„é˜»å¡/å”¤é†’æ–¹æ¡ˆä» Object#wait() / notify()ï¼Œæ”¹æˆäº†ç”¨ Linux epoll æ¥å®ç° åŸå› æ˜¯ Native å±‚ä¹Ÿå¼•å…¥äº†ä¸€å¥—æ¶ˆæ¯ç®¡ç†æœºåˆ¶ï¼Œç”¨äºæä¾›ç»™ C/C++ å¼€å‘è€…ä½¿ç”¨ï¼Œè€Œç°æœ‰çš„é˜»å¡/å”¤é†’æ–¹æ¡ˆæ˜¯ä¸º Java å±‚å‡†å¤‡çš„ï¼Œåªæ”¯æŒ Javaï¼Œç°åœ¨ Native å¸Œæœ›èƒ½å¤Ÿåƒ Java ä¸€æ ·ï¼š main çº¿ç¨‹åœ¨æ²¡æœ‰æ¶ˆæ¯æ—¶è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œæœ‰åˆ°æœŸæ¶ˆæ¯éœ€è¦æ‰§è¡Œæ—¶ï¼Œmain çº¿ç¨‹èƒ½åŠæ—¶é†’è¿‡æ¥å¤„ç†ï¼Œæ€ä¹ˆåŠï¼Ÿæœ‰ä¸¤ç§é€‰æ‹© è¦ä¹ˆï¼Œç»§ç»­ä½¿ç”¨ Object#wait() / notify( )ï¼ŒNative å‘æ¶ˆæ¯é˜Ÿåˆ—æ·»åŠ æ–°æ¶ˆæ¯æ—¶ï¼Œé€šçŸ¥ Java å±‚è‡ªå·±éœ€è¦ä»€ä¹ˆæ—¶å€™è¢«å”¤é†’ è¦ä¹ˆï¼Œåœ¨ Native å±‚é‡æ–°å®ç°ä¸€å¥—é˜»å¡/å”¤é†’æ–¹æ¡ˆï¼Œå¼ƒç”¨ Object#wait() / notify() ï¼ŒJava é€šè¿‡ jni è°ƒç”¨ Native è¿›å…¥é˜»å¡æ€ ç»“å±€æˆ‘ä»¬éƒ½çŸ¥é“äº†ï¼ŒGoogle é€‰æ‹©äº†åè€… å…¶å®å¦‚æœåªæ˜¯å°† Java å±‚çš„é˜»å¡/å”¤é†’ç§»æ¤åˆ° Native å±‚ï¼Œå€’ä¹Ÿä¸ç”¨ç¥­å‡º epoll è¿™ä¸ªå¤§æ€å™¨ ï¼ŒNative è°ƒç”¨ pthread_cond_wait ä¹Ÿèƒ½è¾¾åˆ°ç›¸åŒçš„æ•ˆæœ é€‰æ‹© epoll çš„å¦ä¸€ä¸ªåŸå› æ˜¯ï¼Œ Native å±‚æ”¯æŒç›‘å¬ è‡ªå®šä¹‰ Fd ï¼ˆæ¯”å¦‚ Input äº‹ä»¶å°±æ˜¯é€šè¿‡ epoll ç›‘å¬ socketfd æ¥å®ç°å°†äº‹ä»¶è½¬å‘åˆ° APP è¿›ç¨‹çš„ï¼‰ï¼Œè€Œä¸€æ—¦æœ‰ç›‘å¬å¤šä¸ªæµäº‹ä»¶çš„éœ€æ±‚ï¼Œé‚£å°±åªèƒ½ä½¿ç”¨ Linux I/O å¤šè·¯å¤ç”¨ï¼Œepoll å°±æ˜¯ Linux I/O å¤šè·¯å¤ç”¨çš„å…¶ä¸­ä¸€ä¸ªå®ç° ç†è§£ I/Oå¤šè·¯å¤ç”¨ä¹‹epoll è¯´äº†è¿™ä¹ˆå¤šï¼Œé‚£åˆ°åº•ä»€ä¹ˆæ˜¯ epoll ï¼Ÿ epoll å…¨ç§° eventpollï¼Œæ˜¯ Linux ä¸­çš„ä¸€ç§ I/O å¤šè·¯å¤ç”¨æŠ€æœ¯ï¼Œé™¤äº† epoll å¤–ï¼Œè¿˜æœ‰ select å’Œ poll ä¸¤ç§ä¸åŒçš„å®ç°æ–¹å¼ï¼Œæˆ‘ä»¬è¿™åªè®¨è®º epoll è¦ç†è§£ epoll ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦ç†è§£ä»€ä¹ˆæ˜¯ &quot;æµ&quot; åœ¨ Linux ä¸­ï¼Œä»»ä½•å¯ä»¥è¿›è¡Œ I/O æ“ä½œçš„å¯¹è±¡éƒ½å¯ä»¥çœ‹åšæ˜¯æµï¼Œä¸€ä¸ª æ–‡ä»¶ï¼Œ socketï¼Œ pipeï¼Œæˆ‘ä»¬éƒ½å¯ä»¥æŠŠä»–ä»¬çœ‹ä½œæµ æ¥ç€æˆ‘ä»¬æ¥è®¨è®ºæµçš„ I/O æ“ä½œï¼Œé€šè¿‡è°ƒç”¨ read() ï¼Œæˆ‘ä»¬å¯ä»¥ä»æµä¸­è¯»å‡ºæ•°æ®ï¼›é€šè¿‡ write() ï¼Œæˆ‘ä»¬å¯ä»¥å¾€æµ å†™å…¥æ•°æ® ç°åœ¨å‡å®šä¸€ä¸ªæƒ…å½¢ï¼Œæˆ‘ä»¬éœ€è¦ä»æµä¸­è¯»æ•°æ®ï¼Œä½†æ˜¯æµä¸­è¿˜æ²¡æœ‰æ•°æ® int socketfd = socket(); connect(socketfd,serverAddr); int n = send(socketfd,'åœ¨å—'); n = recv(socketfd); //ç­‰å¾…æ¥å—æœåŠ¡å™¨ç«¯ å‘è¿‡æ¥çš„ä¿¡æ¯ ...//å¤„ç†æœåŠ¡å™¨è¿”å›çš„æ•°æ® ä¸€ä¸ªå…¸å‹çš„ä¾‹å­ä¸ºï¼Œå®¢æˆ·ç«¯è¦ä» socket ä¸­è¯»æ•°æ®ï¼Œä½†æ˜¯æœåŠ¡å™¨è¿˜æ²¡æœ‰æŠŠæ•°æ®ä¼ å›æ¥ï¼Œè¿™æ—¶å€™è¯¥æ€ä¹ˆåŠï¼Ÿ é˜»å¡ï¼šçº¿ç¨‹é˜»å¡åˆ° recv() æ–¹æ³•ï¼Œç›´åˆ°è¯»åˆ°æ•°æ®åå†ç»§ç»­å‘ä¸‹æ‰§è¡Œ éé˜»å¡ï¼šrecv() æ–¹æ³•æ²¡è¯»åˆ°æ•°æ®ç«‹åˆ»è¿”å› -1 ï¼Œç”¨æˆ·çº¿ç¨‹æŒ‰ç…§å›ºå®šé—´éš”è½®è¯¢ recv() æ–¹æ³•ï¼Œç›´åˆ°æœ‰æ•°æ®è¿”å› å¥½ï¼Œç°åœ¨æˆ‘ä»¬æœ‰äº†é˜»å¡å’Œéé˜»å¡ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼Œæ¥ç€æˆ‘ä»¬åŒæ—¶å‘èµ·100ä¸ªç½‘ç»œè¯·æ±‚ï¼Œçœ‹çœ‹è¿™ä¸¤ç§æ–¹æ¡ˆå„è‡ªä¼šæ€ä¹ˆå¤„ç† å…ˆè¯´é˜»å¡æ¨¡å¼ï¼Œåœ¨é˜»å¡æ¨¡å¼ä¸‹ï¼Œä¸€ä¸ªçº¿ç¨‹ä¸€æ¬¡åªèƒ½å¤„ç†ä¸€ä¸ªæµçš„ I/O äº‹ä»¶ï¼Œæƒ³è¦åŒæ—¶å¤„ç†å¤šä¸ªæµï¼Œåªèƒ½ä½¿ç”¨å¤šçº¿ç¨‹ + é˜»å¡ I/O çš„æ–¹æ¡ˆã€‚ä½†æ˜¯ï¼Œæ¯ä¸ª socket å¯¹åº”ä¸€ä¸ªçº¿ç¨‹ä¼šé€ æˆå¾ˆå¤§çš„èµ„æºå ç”¨ï¼Œå°¤å…¶æ˜¯å¯¹äºé•¿è¿æ¥æ¥è¯´ï¼Œçº¿ç¨‹èµ„æºä¸€ç›´ä¸ä¼šé‡Šæ”¾ï¼Œå¦‚æœåé¢é™†ç»­æœ‰å¾ˆå¤šè¿æ¥çš„è¯ï¼Œå¾ˆå¿«å°±ä¼šæŠŠæœºå™¨çš„å†…å­˜è·‘å®Œ åœ¨éé˜»å¡æ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬å‘ç°å•çº¿ç¨‹å¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªæµäº†ï¼Œåªè¦ä¸åœçš„æŠŠæ‰€æœ‰æµä»å¤´åˆ°å°¾çš„é—®ä¸€éæ˜¯å¦æœ‰è¿”å›ï¼ˆè¿”å›å€¼å¤§äº-1 ï¼‰å°±å¯ä»¥å¾—çŸ¥å“ªäº›æµæœ‰æ•°æ®ï¼Œä½†è¿™æ ·çš„åšæ³•æ•ˆç‡ä¹Ÿä¸é«˜ï¼Œå› ä¸ºå¦‚æœæ‰€æœ‰çš„æµéƒ½æ²¡æœ‰æ•°æ®ï¼Œé‚£ä¹ˆåªä¼šç™½ç™½æµªè´¹ CPU å‘ç°é—®é¢˜äº†å—ï¼Ÿåªæœ‰é˜»å¡å’Œéé˜»å¡è¿™ä¸¤ç§æ–¹æ¡ˆæ—¶ï¼Œä¸€æ—¦æœ‰ç›‘å¬å¤šä¸ªæµäº‹ä»¶çš„éœ€æ±‚ï¼Œç”¨æˆ·ç¨‹åºåªèƒ½é€‰æ‹©ï¼Œè¦ä¹ˆæµªè´¹çº¿ç¨‹èµ„æºï¼ˆé˜»å¡å‹ I/Oï¼‰ï¼Œè¦ä¹ˆæµªè´¹ CPU èµ„æºï¼ˆéé˜»å¡å‹ I/Oï¼‰ï¼Œæ²¡æœ‰å…¶ä»–æ›´é«˜æ•ˆçš„æ–¹æ¡ˆ å¹¶ä¸”åœ¨ç”¨æˆ·ç¨‹åºç«¯è¿™ä¸ªé—®é¢˜æ˜¯æ— è§£çš„ï¼Œå¿…é¡»è®©å†…æ ¸åˆ›å»ºæŸç§æœºåˆ¶ï¼ŒæŠŠè¿™äº›æµçš„ç›‘å¬äº‹ä»¶æ¥ç®¡è¿‡å»ï¼Œå› ä¸ºä»»ä½•äº‹ä»¶éƒ½å¿…é¡»é€šè¿‡å†…æ ¸è¯»å–è½¬å‘ï¼Œå†…æ ¸æ€»æ˜¯èƒ½åœ¨ç¬¬ä¸€æ—¶é—´çŸ¥æ™“äº‹ä»¶å‘ç”Ÿ è¿™ç§èƒ½å¤Ÿè®©ç”¨æˆ·ç¨‹åºæ‹¥æœ‰åŒæ—¶ç›‘å¬å¤šä¸ªæµè¯»å†™äº‹ä»¶çš„æœºåˆ¶ï¼Œå°±è¢«ç§°ä¸º I/O å¤šè·¯å¤ç”¨ï¼ ç„¶åæˆ‘ä»¬æ¥çœ‹ epoll æä¾›çš„å‡½æ•°ï¼š int epoll_create(int size); int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event); int epoll_wait(int epfd, struct epoll_event *events, int maxevents, int timeout); ä¸€å…±æœ‰ä¸‰ä¸ªå‡½æ•°ï¼Œepoll_create() ç”¨äºåˆ›å»ºä¸€ä¸ª epoll æ±  epoll_ctl() ç”¨æ¥æ§åˆ¶éœ€è¦ç›‘å¬çš„ fd çš„å¢åˆ æ”¹æ“ä½œï¼Œæœ€åä¸€ä¸ªå‚æ•° event æ˜¯å‘Šè¯‰å†…æ ¸éœ€è¦ç›‘å¬ä»€ä¹ˆäº‹ä»¶ï¼Œæ¯”å¦‚ä¸Šé¢çš„ socketfd ç›‘å¬çš„å°±æ˜¯ å¯è¯»äº‹ä»¶ï¼Œä¸€æ—¦æ¥æ”¶åˆ°æœåŠ¡å™¨è¿”å›çš„æ•°æ®ï¼Œç›‘å¬ socketfd çš„å¯¹è±¡å°†ä¼šæ”¶åˆ°å›è°ƒé€šçŸ¥ï¼Œè¡¨ç¤º socket ä¸­æœ‰æ•°æ®å¯ä»¥è¯»äº† æœ€åä¸€ä¸ª epoll_wait() æ–¹æ³•æ˜¯ä½¿ç”¨æˆ·çº¿ç¨‹é˜»å¡çš„æ–¹æ³•ï¼Œå®ƒçš„ç¬¬äºŒä¸ªå‚æ•° events æ¥å—çš„æ˜¯ä¸€ä¸ªé›†åˆå¯¹è±¡ï¼Œå¦‚æœæœ‰å¤šä¸ªäº‹ä»¶åŒæ—¶å‘ç”Ÿï¼Œevents å¯ä»¥ä»å†…æ ¸å¾—åˆ°å‘ç”Ÿçš„äº‹ä»¶çš„é›†åˆ ç†è§£ Linux eventfd ç†è§£äº† epoll åæˆ‘ä»¬å†æ¥çœ‹ eventfd ï¼Œeventfd æ˜¯ä¸“é—¨ç”¨æ¥ä¼ é€’äº‹ä»¶çš„ fd ï¼Œå®ƒæä¾›çš„åŠŸèƒ½ä¹Ÿéå¸¸ç®€å•ï¼šç´¯è®¡è®¡æ•° int efd = eventfd(); write(efd, 1);//å†™å…¥æ•°å­—1 write(efd, 2);//å†å†™å…¥æ•°å­—2 int res = read(efd); printf(res);//è¾“å‡ºå€¼ä¸º 3 é€šè¿‡ write() å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å‘ eventfd ä¸­å†™å…¥ä¸€ä¸ª int ç±»å‹çš„å€¼ï¼Œåªè¦æ²¡æœ‰å‘ç”Ÿ read() äº‹ä»¶ï¼Œ eventfd ä¸­çš„å€¼å°†ä¼šä¸€ç›´ç´¯åŠ  è€Œä¸€æ—¦æˆ‘ä»¬è°ƒç”¨ read() å‡½æ•°å°† eventfd ä¿å­˜çš„å€¼è¯»äº†å‡ºæ¥ï¼Œåœ¨æ²¡æœ‰æ–°çš„å€¼åŠ å…¥ä¹‹å‰ï¼Œå†æ¬¡è°ƒç”¨ read() æ–¹æ³•æ—¶ä¼šå‘ç”Ÿé˜»å¡ï¼Œç›´åˆ°æœ‰äººé‡æ–°å‘ eventfd å†™å…¥å€¼ eventfd å®ç°çš„æ˜¯è®¡æ•°çš„åŠŸèƒ½ï¼Œåªè¦ eventfd è®¡æ•°ä¸ä¸º 0 ï¼Œé‚£ä¹ˆè¡¨ç¤º fd æ˜¯å¯è¯»çš„ã€‚ç»“åˆ epoll çš„ç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨éå¸¸è½»æ¾çš„åˆ›å»ºä¸€ä¸ªç”Ÿäº§è€…/æ¶ˆè´¹è€…æ¨¡å‹ï¼Œæ¶ˆè´¹è€…å¤§éƒ¨åˆ†æ—¶å€™å¤„äºé˜»å¡ä¼‘çœ çŠ¶æ€ï¼Œè€Œä¸€æ—¦æœ‰è¯·æ±‚å…¥é˜Ÿï¼Œæ¶ˆè´¹è€…å°±ç«‹é©¬å”¤é†’å¤„ç† Handler æœºåˆ¶çš„åº•å±‚é€»è¾‘å°±æ˜¯ epoll + eventfdï¼Œå¥½ï¼Œæœ‰äº† epoll ã€ eventfd åŸºç¡€ï¼Œæˆ‘ä»¬å¼€å§‹æ­£å¼è¿›å…¥ Handler çš„ Native ä¸–ç•Œ äºŒã€è¿›å…¥Native Handler ç»å¤§å¤šæ•° Android å·¥ç¨‹å¸ˆéƒ½æˆ–å¤šæˆ–å°‘çš„äº†è§£è¿‡ Handler æœºåˆ¶ï¼Œæ‰€ä»¥å…³äº Handler çš„åŸºæœ¬ä½¿ç”¨å’Œå®ç°çš„åŸç†æˆ‘ä»¬å°±ä¸è¿‡å¤šèµ˜è¿°äº†ï¼Œç›´å¥”ä¸»é¢˜ æˆ‘ä»¬æ¥é‡ç‚¹å…³æ³¨ MessageQueue ç±»ä¸­çš„å‡ ä¸ª jni æ–¹æ³•ï¼šnativeInit()ã€nativePollOnce() å’Œ nativeWake()ï¼Œå®ƒä»¬åˆ†åˆ«å¯¹åº”äº† Native æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„ åˆå§‹åŒ–æ¶ˆæ¯é˜Ÿåˆ—ã€ æ¶ˆæ¯çš„å¾ªç¯ä¸é˜»å¡ ä»¥åŠ æ¶ˆæ¯çš„åˆ†é€ä¸å”¤é†’ è¿™ä¸‰å¤§ç¯èŠ‚ /frameworks/base/core/java/android/os/MessageQueue.java class MessageQueue { private native static long nativeInit(); private native void nativePollOnce(long ptr, int timeoutMillis); /*non-static for callbacks*/ private native static void nativeWake(long ptr); } æ¶ˆæ¯é˜Ÿåˆ—çš„åˆå§‹åŒ– å…ˆæ¥çœ‹ç¬¬ä¸€æ­¥ï¼Œæ¶ˆæ¯é˜Ÿåˆ—çš„åˆå§‹åŒ–æµç¨‹ Java MessageQueue æ„é€ å‡½æ•°ä¸­ä¼šè°ƒç”¨ nativeInit() æ–¹æ³•ï¼ŒåŒæ­¥åœ¨ Native å±‚ä¹Ÿä¼šåˆ›å»ºä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ— NativeMessageQueue å¯¹è±¡ï¼Œç”¨äºä¿å­˜ Native å¼€å‘è€…å‘é€çš„æ¶ˆæ¯ /frameworks/base/core/java/android/os/MessageQueue.java MessageQueue(boolean quitAllowed) { mQuitAllowed = quitAllowed; mPtr = nativeInit(); } åœ¨åˆ›å»º NativeMessageQueue å¯¹è±¡æ—¶åˆä¼šè§¦å‘åˆ›å»º Looper å¯¹è±¡ /frameworks/base/core/jni/android_os_MessageQueue.cpp class android_os_MessageQueue { void android_os_MessageQueue_nativeInit() { NativeMessageQueue* nativeMessageQueue = new NativeMessageQueue(); } NativeMessageQueue() { mLooper = Looper::getForThread(); if (mLooper == NULL) { mLooper = new Looper(false); Looper::setForThread(mLooper); } } } è¿™é‡Œåˆ›å»º Looper å¯¹è±¡çš„å¤„ç†é€»è¾‘å’Œ Java ä¸€æ ·ï¼Œå…ˆå»çº¿ç¨‹å±€éƒ¨å­˜å‚¨åŒºè·å– Looper å¯¹è±¡ï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ Looper å¯¹è±¡å¹¶ä¿å­˜åˆ°çº¿ç¨‹å±€éƒ¨å­˜å‚¨åŒº æˆ‘ä»¬ç»§ç»­ï¼Œæ¥ç€æ¥çœ‹ Native Looper åˆå§‹åŒ–æµç¨‹ /system/core/libutils/Looper.cpp class looper { Looper::Looper() { int mWakeEventFd = eventfd(); rebuildEpollLocked(); } void rebuildEpollLocked(){ int mEpollFd = epoll_create();//å“ï¼Œè¿™å„¿éå¸¸é‡è¦ï¼Œåœ¨ Looper åˆå§‹åŒ–æ—¶åˆ›å»ºäº† epoll å¯¹è±¡ epoll_ctl(mEpollFd, EPOLL_CTL_ADD, mWakeEventFd, &amp; eventItem);//æŠŠç”¨äºå”¤é†’æ¶ˆæ¯é˜Ÿåˆ—çš„eventfd æ·»åŠ åˆ° epoll æ±  } } å…³é”®çš„åœ°æ–¹æ¥äº†ï¼ Looper çš„æ„é€ å‡½æ•°é¦–å…ˆåˆ›å»ºäº† eventfd ç±»å‹çš„ fd ï¼šmWakeEventFdï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯ç”¨æ¥ç›‘å¬ MessageQueue æ˜¯å¦æœ‰æ–°æ¶ˆæ¯åŠ å…¥ï¼Œè¿™ä¸ªå¯¹è±¡éå¸¸é‡è¦ï¼Œä¸€å®šè¦è®°ä½å®ƒï¼ éšåè°ƒç”¨çš„ rebuildEpollLocked() æ–¹æ³•ä¸­ï¼Œåˆåˆ›å»ºäº† epoll å¯¹è±¡ï¼šmEpollFdï¼Œå¹¶å°†ç”¨æ¥ç›‘å¬æ¶ˆæ¯é˜Ÿåˆ—çš„ mWakeEventFd æ·»åŠ åˆ° epoll æ±  è¿™ä¸¤æ­¥æ‰§è¡Œå®Œæˆä»¥åï¼Œä»»ä¸€ç”Ÿäº§è€…å‘ mWakeEventFd å†™å…¥å€¼æ—¶ï¼Œä½œä¸ºæ¶ˆè´¹è€…ï¼ŒAPP è¿›ç¨‹çš„ main çº¿ç¨‹éƒ½å°†ä¼šè¢«å”¤é†’ å¥½äº†ï¼ŒHandler ä¸¤å¤§æ ¸å¿ƒå¯¹è±¡ mEpollFd å’Œ mWakeEventFd åˆ›å»ºæˆåŠŸï¼Œæˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹æ¶ˆæ¯é˜Ÿåˆ—çš„åˆå§‹åŒ–æµç¨‹ï¼š Java å±‚åˆå§‹åŒ–æ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼ŒåŒæ­¥è°ƒç”¨ nativeInit() æ–¹æ³•ï¼Œåœ¨ native å±‚åˆ›å»ºäº†ä¸€ä¸ª NativeMessageQueue å¯¹è±¡ Native å±‚æ¶ˆæ¯é˜Ÿåˆ—è¢«åˆ›å»ºçš„åŒæ—¶ï¼Œä¹Ÿä¼šåˆ›å»ºä¸€ä¸ª Native Looper ï¼Œå®ƒç”¨äºå¤„ç†ä¸‰ä»¶äº‹ï¼š native æ³¨å†Œçš„è‡ªå®šä¹‰ Fd å¼•èµ·çš„äº‹ä»¶æ¶ˆæ¯ã€æ¶ˆæ¯é˜Ÿåˆ—è¢«å”¤é†’å’Œè¶…æ—¶ä»¥åŠåˆ†å‘ Native æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„åˆ°æœŸæ¶ˆæ¯ åœ¨åˆ›å»º Native Looper çš„è¿‡ç¨‹ä¸­ï¼Œè°ƒç”¨ eventfd() ç”Ÿæˆ mWakeEventFdï¼Œå®ƒæ˜¯åç»­ç”¨äºå”¤é†’æ¶ˆæ¯é˜Ÿåˆ—çš„æ ¸å¿ƒ åˆå§‹åŒ– Native Looper çš„æœ€åä¸€æ­¥è°ƒç”¨äº† rebuildEpollLocked() æ–¹æ³•ï¼Œåœ¨å…¶ä¸­è°ƒç”¨ epoll_create() åˆå§‹åŒ–äº†ä¸€ä¸ª epoll å®ä¾‹ mEpollFd ï¼Œç„¶åä½¿ç”¨ epoll_ctl() æ–¹æ³•å°† mEpollFd æ³¨å†Œåˆ° epoll æ±  è‡³æ­¤ï¼ŒNative å±‚çš„æ¶ˆæ¯é˜Ÿåˆ—åˆå§‹åŒ–å®Œæˆ æ¶ˆæ¯çš„å¾ªç¯ä¸é˜»å¡ æ¶ˆæ¯é˜Ÿåˆ—åˆ›å»ºå®Œä»¥åï¼Œæ•´ä¸ªçº¿ç¨‹å°±ä¼šé˜»å¡åˆ° Looper#loop() æ–¹æ³•ä¸­ï¼Œåœ¨ Java å±‚çš„çš„è°ƒç”¨é“¾å¤§è‡´æ˜¯è¿™æ ·çš„ï¼š Looper#loop() -&gt; MessageQueue#next() -&gt; MessageQueue#nativePollOnce() } æœ€åä¸€æ­¥è°ƒç”¨çš„ nativePollOnce() åˆæ˜¯ä¸€ä¸ª jni æ–¹æ³•ï¼Œæˆ‘ä»¬æ¥ç€å¾€ä¸‹è·Ÿï¼Œçœ‹çœ‹ Native ä¸­åšäº†äº›ä»€ä¹ˆ /frameworks/base/core/jni/android_os_MessageQueue.cpp class android_os_MessageQueue { //jniæ–¹æ³•ï¼Œè½¬åˆ° NativeMessageQueue#pollOnce() void android_os_MessageQueue_nativePollOnce(){ nativeMessageQueue-&gt;pollOnce(env, obj, timeoutMillis); } class NativeMessageQueue : MessageQueue { /è½¬åˆ° Looper#pollOnce() æ–¹æ³• void pollOnce(){ mLooper-&gt;pollOnce(timeoutMillis); } } } å¯ä»¥çœ‹åˆ° NativeMessageQueue ä¸­ä»€ä¹ˆéƒ½æ²¡åšï¼Œåªæ˜¯æŠŠ nativePollOnce() æ–¹æ³•è¯·æ±‚è½¬å‘ç»™äº† Looper ä¸»è¦çš„é€»è¾‘éƒ½åœ¨ Looper ä¸­ï¼Œæˆ‘ä»¬ä» Looper#pollOnce() æ–¹æ³•æ¥ç€å¾€ä¸‹çœ‹ //system/core/libutils/Looper.cpp class looper { int pollOnce(int timeoutMillis){ int result = 0; for (;;) { if (result != 0) { return result; } result = pollInner(timeoutMillis);//è¶…æ—¶ } } int pollInner(int timeoutMillis){ int eventCount = epoll_wait(mEpollFd, eventItems, EPOLL_MAX_EVENTS, timeoutMillis);//è°ƒç”¨ epoll_wait() ç­‰å¾…äº‹ä»¶çš„äº§ç”Ÿ } } çœ‹åˆ°äº†å—ï¼Ÿ pollOnce() æ–¹æ³•ä¸­ä¼šä¸åœçš„è½®è¯¢æ£€æŸ¥ pollInner() çš„è¿”å›å€¼ï¼Œä¸ç­‰äº 0 å°±è¿”å›ç»™ä¸Šå±‚ï¼Œè¿™é‡Œçš„ result ç±»å‹æ˜¯åœ¨ Looper.h æ–‡ä»¶ä¸­å£°æ˜çš„æšä¸¾ç±»ï¼Œä¸€å…±æœ‰4ç§ç»“æœï¼š -1 è¡¨ç¤ºåœ¨è¶…æ—¶æ—¶é—´åˆ°æœŸä¹‹å‰ä½¿ç”¨ wake() å”¤é†’äº†è½®è¯¢ï¼Œé€šå¸¸æ˜¯æœ‰éœ€è¦ç«‹åˆ»æ‰§è¡Œçš„æ–°æ¶ˆæ¯åŠ å…¥äº†é˜Ÿåˆ— -2 è¡¨ç¤ºå¤šä¸ªäº‹ä»¶åŒæ—¶å‘ç”Ÿï¼Œæœ‰å¯èƒ½æ˜¯æ–°æ¶ˆæ¯åŠ å…¥ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯ç›‘å¬çš„ è‡ªå®šä¹‰ fd å‘ç”Ÿäº† I/O äº‹ä»¶ -3 è¡¨ç¤ºè®¾å®šçš„è¶…æ—¶æ—¶é—´åˆ°æœŸäº† -4 è¡¨ç¤ºé”™è¯¯ï¼Œä¸çŸ¥é“å“ªé‡Œä¼šç”¨åˆ° è€Œå¦‚æœæ¶ˆæ¯é˜Ÿåˆ—ä¸­æ²¡æ¶ˆæ¯ï¼Œæˆ–è€…è®¾å®šçš„è¶…æ—¶æ—¶é—´æ²¡åˆ°æœŸï¼Œå†æˆ–è€…ç”¨æˆ·è‡ªå®šä¹‰ fd æ²¡æœ‰äº‹ä»¶å‘ç”Ÿï¼Œéƒ½ä¼šå¯¼è‡´çº¿ç¨‹æœ€ç»ˆä¼šé˜»å¡åˆ° pollInner() æ–¹æ³•ä¸­ï¼Œ pollInner() ä¸­åˆ™æ˜¯ä½¿ç”¨äº† epoll_wait() æ–¹æ³•ç­‰å¾…äº‹ä»¶çš„äº§ç”Ÿ æ€»ç»“ä¸€ä¸‹ï¼Œæ¶ˆæ¯é˜Ÿåˆ—åœ¨åˆå§‹åŒ–æˆåŠŸä»¥åï¼ŒJava å±‚çš„ Looper#loop() ä¼šå¼€å§‹æ— é™è½®è¯¢ï¼Œä¸åœçš„è·å–ä¸‹ä¸€æ¡æ¶ˆæ¯ã€‚å¦‚æœæ¶ˆæ¯é˜Ÿåˆ—ä¸ºç©ºï¼Œè°ƒç”¨ epoll_wait ä½¿çº¿ç¨‹è¿›å…¥åˆ°é˜»å¡æ€ï¼Œè®©å‡º CPU è°ƒåº¦ ä» Java åˆ° Native æ•´ä¸ªè°ƒç”¨æµç¨‹å¤§è‡´æ˜¯è¿™æ ·çš„ï¼š Looper#loop() -&gt; MessageQueue#next() -&gt; MessageQueue#nativePollOnce() -&gt; NativeMessageQueue#pollOnce() //æ³¨æ„ï¼Œè¿›å…¥ Native å±‚ -&gt; Looper#pollOnce() -&gt; Looper#pollInner() -&gt; epoll_wait() æ¶ˆæ¯çš„å‘é€/å”¤é†’æœºåˆ¶ å¥½ï¼Œç°åœ¨çš„æ¶ˆæ¯é˜Ÿåˆ—é‡Œé¢æ˜¯ç©ºçš„ï¼Œç»è¿‡ä¸Šä¸€å°èŠ‚çš„åˆ†æï¼Œæˆ‘ä»¬å‘ç°ç”¨æˆ·çº¿ç¨‹é˜»å¡åˆ°äº† native å±‚çš„ Looper#pollInner() æ–¹æ³•è°ƒç”¨ä¸­ï¼Œæˆ‘ä»¬æ¥å‘æ¶ˆæ¯é˜Ÿåˆ—å‘é€ä¸€æ¡æ¶ˆæ¯å”¤é†’å®ƒ å‰é¢æˆ‘ä»¬è¯´äº†ï¼ŒJava å’Œ Native éƒ½å„è‡ªç»´æŠ¤äº†ä¸€å¥—æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ‰€ä»¥ä»–ä»¬å‘é€æ¶ˆæ¯çš„å…¥å£ä¹Ÿä¸ä¸€æ · Java å¼€å‘ä½¿ç”¨ Handler#sendMessage() / post()ï¼ŒC/C++ å¼€å‘ä½¿ç”¨ Looper#sendMessage() æˆ‘ä»¬å…ˆæ¥çœ‹ Java /frameworks/base/core/java/android/os/Handler.java class Handler { boolean enqueueMessage(MessageQueue queue, Message msg, long uptimeMillis) { msg.target = this; return queue.enqueueMessage(msg, uptimeMillis); } } /frameworks/base/core/java/android/os/MessageQueue.java class MessageQueue { boolean enqueueMessage(Message msg, long when) { //...æŒ‰ç…§åˆ°æœŸæ—¶é—´å°†æ¶ˆæ¯æ’å…¥æ¶ˆæ¯é˜Ÿåˆ— if (needWake) { nativeWake(mPtr); } } } åœ¨ä½¿ç”¨ Handler å‘é€æ¶ˆæ¯æ—¶ï¼Œä¸ç®¡è°ƒç”¨çš„æ˜¯ sendMessage è¿˜æ˜¯ postï¼Œæœ€åéƒ½æ˜¯è°ƒç”¨åˆ° MessageQueue#enqueueMessage() æ–¹æ³•å°†æ¶ˆæ¯å…¥åˆ—ï¼Œå…¥åˆ—çš„é¡ºåºæ˜¯æŒ‰ç…§æ‰§è¡Œæ—¶é—´å…ˆåæ’åº å¦‚æœæˆ‘ä»¬å‘é€çš„æ¶ˆæ¯éœ€è¦é©¬ä¸Šè¢«æ‰§è¡Œï¼Œé‚£ä¹ˆå°† needWake å˜é‡ç½®ä¸º trueï¼Œæ¥ç€ä½¿ç”¨ nativeWake() å”¤é†’çº¿ç¨‹ nativeWake() æ–¹æ³•ä¹Ÿæ˜¯ jni è°ƒç”¨ï¼Œè¯·æ±‚ç»è¿‡å±‚å±‚è½¬å‘ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ° Native Looper ä¸­çš„ wake() æ–¹æ³•ï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­çš„è°ƒç”¨é“¾æ¯”è¾ƒæ¸…æ™°è€Œä¸”éå¸¸ç®€å•ï¼Œè¿™é‡Œå°±ä¸å±•ç¤ºäº† Java å‘é€æ¶ˆæ¯çš„æ–¹å¼èŠå®Œäº†ï¼Œç„¶åæˆ‘ä»¬çœ‹ Native å±‚å¦‚ä½•å‘é€æ¶ˆæ¯ /system/core/libutils/Looper.cpp class looper { void Looper::sendMessageAtTime(uptime, handler,message) { int i = 0; int messageCount = mMessageEnvelopes.size(); while (i &lt; messageCount &amp;&amp; uptime &gt;= mMessageEnvelopes.itemAt(i).uptime) { i += 1; } mMessageEnvelopes.insertAt(messageEnvelope(uptime, handler, message), i, 1); // Wake the poll loop only when we enqueue a new message at the head. if (i == 0) { wake(); } } } Native å±‚é€šè¿‡ sendMessageAtTime() æ–¹æ³•å‘æ¶ˆæ¯é˜Ÿåˆ—å‘é€æ¶ˆæ¯ï¼Œæ·»åŠ æ¶ˆæ¯çš„å¤„ç†é€»è¾‘å’Œ Java å¤„ç†é€»è¾‘æ˜¯ç±»ä¼¼çš„ï¼Œå”¯ä¸€æœ‰åŒºåˆ«çš„ä¸€ç‚¹æ˜¯ Java æ¶ˆæ¯é˜Ÿåˆ—ä½¿ç”¨çš„é“¾è¡¨ç»“æ„ï¼Œè€Œ Native å±‚ä½¿ç”¨çš„æ˜¯é›†åˆ æŒ‰ç…§æ—¶é—´çš„å…ˆåé¡ºåºæ·»åŠ åˆ° mMessageEnvelopes é›†åˆä¸­ï¼Œæ‰§è¡Œæ—¶é—´ç¦»å¾—æœ€è¿‘çš„æ¶ˆæ¯è¢«æ”¾åœ¨å‰é¢ï¼Œå¦‚æœå‘ç°éœ€è¦å”¤é†’çº¿ç¨‹ï¼Œåˆ™è°ƒç”¨ wake() æ–¹æ³• æˆ‘ä»¬å‘ç°ï¼Œå½“éœ€è¦å”¤é†’çº¿ç¨‹æ—¶ï¼ŒJava å’Œ Native éƒ½ä¼šæ‰§è¡Œåˆ° Looper#wake() æ–¹æ³• ä¹‹å‰æˆ‘ä»¬è¯´Handler æœºåˆ¶çš„åº•å±‚é€»è¾‘å°±æ˜¯ epoll + eventfdï¼Œè¯»è€…æœ‹å‹ä¸å¦¨å¤§èƒ†çŒœä¸€ä¸‹ï¼Œè¿™é‡Œçš„çº¿ç¨‹æ˜¯æ€ä¹ˆè¢«å”¤é†’çš„ï¼Ÿ /system/core/libutils/Looper.cpp class looper { void Looper::wake() { int inc = 1; write(mWakeEventFd, &amp;inc); } } ç­”æ¡ˆéå¸¸ç®€å•ï¼Œwrite() ä¸€è¡Œæ–¹æ³•è°ƒç”¨ï¼Œå‘ mWakeEventFd å†™å…¥äº†ä¸€ä¸ª 1ï¼ˆæé†’ä¸€ä¸‹ï¼ŒmWakeEventFd çš„ç±»å‹æ˜¯ eventfd ï¼‰ eventfd è¢«å†™å…¥å€¼åï¼ŒçŠ¶æ€ä¼šä» ä¸å¯è¯» å˜æˆ å¯è¯»ï¼Œè€Œ epoll ç›‘å¬åˆ° fd çŠ¶æ€å‘ç”Ÿå˜åŒ–åï¼Œå°†äº‹ä»¶ä»å†…æ ¸è¿”å›ç»™ epoll_wait() è°ƒç”¨ï¼Œçº¿ç¨‹çš„é˜»å¡æ€å°†ä¼šè¢«å–æ¶ˆï¼Œç»§ç»­å‘ä¸‹æ‰§è¡Œ å¥½ï¼Œæˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹æ¶ˆæ¯çš„å‘é€ä¸å”¤é†’ä¸­å‡ ä¸ªå…³é”®çš„æ­¥éª¤ï¼š Java å±‚çš„ Handler å‘é€æ¶ˆæ¯ï¼Œä¼šè°ƒç”¨åˆ°æ¶ˆæ¯é˜Ÿåˆ—çš„ enqueueMessage() æ–¹æ³•ï¼Œå¦‚æœæ¶ˆæ¯éœ€è¦é©¬ä¸Šæ‰§è¡Œï¼Œé‚£ä¹ˆè°ƒç”¨ nativeWake() æ‰§è¡Œå”¤é†’ï¼Œç”± Native å±‚çš„ Looper#wake() å“åº”æœ€ç»ˆçš„å”¤é†’è¯·æ±‚ Native å±‚é€šè¿‡ Looper#sentMessageAtTime() æ¥å‘é€æ¶ˆæ¯ï¼Œå¤„ç†é€»è¾‘ä¸ Java ç±»ä¼¼ï¼Œå¦‚æœéœ€è¦å”¤é†’çº¿ç¨‹ï¼Œè°ƒç”¨ Looper#wake() Looper#wake() å”¤é†’æ–¹æ³•ä¸­ï¼Œè°ƒç”¨ write() æ–¹æ³•å‘ mWakeEventFd å†™å…¥ 1 åˆå§‹åŒ–é˜Ÿåˆ—æ—¶ä¸º mWakeEventFd æ³¨å†Œäº† epoll ç›‘å¬ï¼Œæ‰€ä»¥ä¸€æ—¦æœ‰æ¥è‡ªäº mWakeEventFd çš„æ–°å†…å®¹ï¼Œ epoll_wait() é˜»å¡è°ƒç”¨å°±ä¼šè¿”å›ï¼Œè¿™é‡Œå°±å·²ç»èµ·åˆ°äº†å”¤é†’é˜Ÿåˆ—çš„ä½œç”¨ æ¶ˆæ¯çš„å‘é€ä¸å”¤é†’çš„æµç¨‹åŸºæœ¬ä¸Šç»“æŸäº†ï¼Œæ¥ä¸‹æ¥æ˜¯ Handler æœºåˆ¶çš„é‡å¤´æˆï¼šçº¿ç¨‹å”¤é†’åçš„æ¶ˆæ¯åˆ†å‘å¤„ç† å”¤é†’åæ¶ˆæ¯çš„åˆ†å‘å¤„ç† çº¿ç¨‹åœ¨æ²¡æœ‰æ¶ˆæ¯éœ€è¦å¤„ç†æ—¶ä¼šé˜»å¡åœ¨ Looper#pollInner() æ–¹æ³•è°ƒç”¨ï¼Œå”¤é†’åŒæ ·ä¹Ÿæ˜¯åœ¨ pollInner() æ–¹æ³•ä¸­æ‰§è¡Œ çº¿ç¨‹é†’æ¥ä»¥åï¼Œå…ˆåˆ¤æ–­è‡ªå·±ä¸ºä»€ä¹ˆé†’è¿‡æ¥ï¼Œå†æ ¹æ®å”¤é†’ç±»å‹æ‰§è¡Œä¸åŒçš„é€»è¾‘ pollInner() æ–¹æ³•ç¨å¾®æœ‰ç‚¹é•¿ï¼Œå…³é”®æ­¥éª¤æˆ‘ä½œäº†æ ‡è®°ï¼Œæˆ‘ä»¬ä¸€ç‚¹ç‚¹æ¥æ‹ /system/core/libutils/Looper.cpp class looper { int pollInner(int timeoutMillis){ int result = POLL_WAKE; // step 1ï¼Œepoll_wait æ–¹æ³•è¿”å› int eventCount = epoll_wait(mEpollFd, eventItems, timeoutMillis); if (eventCount == 0) { // äº‹ä»¶æ•°é‡ä¸º0è¡¨ç¤ºï¼Œè¾¾åˆ°è®¾å®šçš„è¶…æ—¶æ—¶é—´ result = POLL_TIMEOUT; } for (int i = 0; i &lt; eventCount; i++) { if (eventItems[i] == mWakeEventFd) { // step 2 ï¼Œæ¸…ç©º eventfdï¼Œä½¿ä¹‹é‡æ–°å˜ä¸ºå¯è¯»ç›‘å¬çš„ fd awoken(); } else { // step 3 ï¼Œä¿å­˜è‡ªå®šä¹‰fdè§¦å‘çš„äº‹ä»¶é›†åˆ mResponses.push(eventItems[i]); } } // step 4 ï¼Œæ‰§è¡Œ native æ¶ˆæ¯åˆ†å‘ while (mMessageEnvelopes.size() != 0) { if (messageEnvelope.uptime &lt;= now) { // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦åˆ°æœŸ messageEnvelope.handler-&gt;handleMessage(message); } } // step 5 ï¼Œæ‰§è¡Œ è‡ªå®šä¹‰ fd å›è°ƒ for (size_t i = 0; i &lt; mResponses.size(); i++) { response.request.callback-&gt;handleEvent(fd, events, data); } return result; } void awoken() { read(mWakeEventFd) ;// é‡æ–°å˜æˆå¯è¯»äº‹ä»¶ } } step 1 ï¼š epoll_wait æ–¹æ³•è¿”å›è¯´æ˜æœ‰äº‹ä»¶å‘ç”Ÿï¼Œè¿”å›å€¼ eventCount æ˜¯å‘ç”Ÿäº‹ä»¶çš„æ•°é‡ã€‚å¦‚æœä¸º0ï¼Œè¡¨ç¤ºè¾¾åˆ°è®¾å®šçš„è¶…æ—¶æ—¶é—´ï¼Œä¸‹é¢çš„åˆ¤æ–­é€»è¾‘éƒ½ä¸ä¼šèµ°ï¼Œä¸ä¸º0ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¼€å§‹éå†å†…æ ¸è¿”å›çš„äº‹ä»¶é›†åˆ eventItemsï¼Œæ ¹æ®ç±»å‹æ‰§è¡Œä¸åŒçš„é€»è¾‘ step 2 ï¼š å¦‚æœäº‹ä»¶ç±»å‹æ˜¯æ¶ˆæ¯é˜Ÿåˆ—çš„ eventfd ï¼Œè¯´æ˜æœ‰äººå‘æ¶ˆæ¯é˜Ÿåˆ—æäº¤äº†éœ€è¦é©¬ä¸Šæ‰§è¡Œçš„æ¶ˆæ¯ï¼Œæˆ‘ä»¬åªéœ€æŠŠæ¶ˆæ¯é˜Ÿåˆ—çš„ eventfd æ•°æ®è¯»å‡ºæ¥ï¼Œä½¿ä»–é‡æ–°å˜æˆå¯ä»¥è§¦å‘ å¯è¯»äº‹ä»¶ çš„ fdï¼Œç„¶åç­‰å¾…æ–¹æ³•ç»“æŸå°±è¡Œäº† step 3 ï¼š äº‹ä»¶ä¸æ˜¯æ¶ˆæ¯é˜Ÿåˆ—çš„ eventfd ï¼Œè¯´æ˜æœ‰å…¶ä»–åœ°æ–¹æ³¨å†Œäº†ç›‘å¬ fdï¼Œé‚£ä¹ˆï¼Œæˆ‘ä»¬å°†å‘ç”Ÿçš„äº‹ä»¶ä¿å­˜åˆ° mResponses é›†åˆä¸­ï¼Œå¾…ä¼šéœ€è¦å¯¹è¿™ä¸ªäº‹ä»¶åšå‡ºå“åº”ï¼Œé€šçŸ¥æ³¨å†Œå¯¹è±¡ step 4 ï¼š éå† Native çš„æ¶ˆæ¯é›†åˆ mMessageEnvelopesï¼Œæ£€æŸ¥æ¯ä¸ªæ¶ˆæ¯çš„åˆ°æœŸæ—¶é—´ï¼Œå¦‚æœæ¶ˆæ¯åˆ°æœŸäº†ï¼Œäº¤ç»™ handler æ‰§è¡Œåˆ†å‘ï¼Œåˆ†å‘é€»è¾‘å‚è€ƒ Java Handler step 5 ï¼š éå† mResponses é›†åˆï¼ŒæŠŠå…¶ä»–åœ°æ–¹æ³¨å†Œçš„ è‡ªå®šä¹‰ fd æ¶ˆè´¹æ‰ï¼Œå“åº”å®ƒä»¬çš„å›è°ƒæ–¹æ³• å”¤é†’ä»¥åæ‰§è¡Œçš„æ­¥éª¤ç¨å¾®æœ‰ç‚¹å¤šå“ˆï¼Œæˆ‘ä»¬æŠŠå…³é”®æµç¨‹æ€»ç»“ä¸€ä¸‹ï¼š ç”¨æˆ·çº¿ç¨‹è¢«å”¤é†’åï¼Œä¼˜å…ˆæ‰§è¡Œ Native å±‚çš„æ¶ˆæ¯åˆ†å‘ï¼Œç´§æ¥ç€ï¼Œå›è°ƒé€šçŸ¥è‡ªå®šä¹‰ fd å‘ç”Ÿçš„äº‹ä»¶ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ï¼Œç„¶å pollInner() æ–¹æ³•ç»“æŸï¼Œè¿”å›åˆ° Java å±‚ Looper#loop() æ–¹æ³•ã€‚åœ¨ Looper ä¸­æœ€åæ‰§è¡Œåˆ° Java å±‚çš„æ¶ˆæ¯åˆ†å‘ï¼Œåªæœ‰å½“ Java Handler æ‰§è¡Œå®Œæ¶ˆæ¯åˆ†å‘ï¼Œä¸€æ¬¡ loop() å¾ªç¯æ‰ç®—æ˜¯å®Œæˆ å†ä¹‹åï¼Œ Looper#loop() ä¼šå†ä¸€æ¬¡è¿›å…¥å¾ªç¯ï¼Œç»§ç»­è°ƒç”¨ next() æ–¹æ³•è·å–æ¶ˆæ¯ã€é˜»å¡åˆ° pollInner() ã€ä» pollInner() å”¤é†’æ‰§è¡Œåˆ†å‘ï¼Œæ‰§è¡Œç»“æŸæ¥ç€è¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯ï¼Œæ— å°½çš„è½®å› main çº¿ç¨‹çš„ä¸€ç”Ÿéƒ½å°†é‡å¤è¿™ä¸€æµç¨‹ï¼Œç›´åˆ° APP è¿›ç¨‹ç»“æŸè¿è¡Œ.. ä¸‰ã€ç»“è¯­ ä»¥ä¸Šå°±æ˜¯ Handler Native ä¸–ç•Œçš„å…¨éƒ¨å†…å®¹ï¼Œä¸»è¦ä»‹ç»äº† Java MessageQueue ä¸­å‡ ä¸ªå…³é”®çš„ jni æ–¹æ³•åœ¨åº•å±‚æ˜¯å¦‚ä½•å®ç°çš„ å°†å…¨éƒ¨çš„ä»£ç é€»è¾‘åˆ†æå®Œä»¥åï¼Œæˆ‘ä»¬ä¼šå‘ç° Native Handler çš„å®ç°ä¸ç®—å¤æ‚ï¼Œå…³é”®çš„é˜»å¡ä¸å”¤é†’éƒ¨åˆ†æ˜¯å€ŸåŠ©äº† Linux ç³»ç»Ÿ epoll æœºåˆ¶æ¥å®ç°çš„ æ‰€ä»¥ï¼Œæˆ‘ä»¬åªè¦ç†è§£äº† epoll æœºåˆ¶ï¼Œå†æ‰“å¼€æºç çœ‹çœ‹ Looper#pollInner() ä¸­çš„å†…éƒ¨é€»è¾‘ï¼Œå°±èƒ½æ˜ç™½æ•´ä¸ª Handler æœºåˆ¶æ˜¯æ€ä¹ˆä¸€å›äº‹äº† æœ¬ç¯‡æ–‡ç« åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œå¸Œæœ›èƒ½å¯¹å¤§å®¶æœ‰å¸®åŠ© å…¨æ–‡å®Œ å››ã€å‚è€ƒèµ„æ–™ Scalable Event Multiplexing: epoll vs. kqueue epoll æˆ–è€… kqueue çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ- çŸ¥ä¹ - è“å½¢å‚çš„å›ç­” Android æ¶ˆæ¯æœºåˆ¶Nativeå±‚æ¶ˆæ¯æœºåˆ¶ - å´è¿ª Linux ç½‘ç»œç¼–ç¨‹çš„5ç§IOæ¨¡å‹ï¼šé˜»å¡IOä¸éé˜»å¡IO ","link":"https://yibaoshan.github.io/post/android-components-handler-native/"},{"title":"Androidå›¾å½¢ç³»ç»Ÿï¼ˆå››ï¼‰åº”ç”¨ç¯‡ï¼šè‡ªå®šä¹‰View/ViewGroupè¯¦è§£","content":" ç‚¹å‡»è·³è½¬åˆ°æ˜é‡‘é˜…è¯» ç›¸ä¿¡å¤§å¤šæ•°çš„ Android å¼€å‘è€…éƒ½æœ‰è¿‡å¼€å‘è‡ªå®šä¹‰ View çš„ç»å†ï¼Œä»¥æˆ‘ä¸ªäººçš„å·¥ç¨‹ç»éªŒæ¥çœ‹ï¼Œè‡ªå®šä¹‰ View å¤§ä½“å¯ä»¥åˆ†ä¸ºä¸‰ç§ï¼šæ”¹è£…ã€ç»„åˆå’Œè‡ªå®šä¹‰ æ”¹è£…æŒ‡çš„æ˜¯ç»§æ‰¿è‡ªæŸä¸ªæ§ä»¶ï¼Œåœ¨åŸæœ‰åŠŸèƒ½çš„åŸºç¡€ä¸Šè¿›è¡Œå¢åˆ æ”¹ï¼Œæ¯”å¦‚ï¼šåŸºäº ViewPager æ‰“é€ ä¸€ä¸ªæ— é™å¾ªç¯çš„è½®æ’­å›¾æ§ä»¶ ç»„åˆæŒ‡çš„æ˜¯å°†2ä¸ªä»¥ä¸Šçš„æ§ä»¶ç»„åˆæˆä¸€ä¸ªæ§ä»¶ï¼Œæ¯”å¦‚ï¼šåŸºäº RelativeLayout + å¤šä¸ª EditText ç»„åˆæˆä¸€ä¸ªå¯†ç è¾“å…¥æ§ä»¶ è‡ªå®šä¹‰æŒ‡çš„æ˜¯å½“ Android å®˜æ–¹æ§ä»¶ä¸è¶³ä»¥æ»¡è¶³ä¸šåŠ¡éœ€æ±‚ï¼ˆæ¯”å¦‚ç»Ÿè®¡å›¾è¡¨ä¸­çš„é¥¼çŠ¶å›¾/æŠ˜çº¿å›¾ï¼‰æ—¶ï¼Œç»§æ‰¿ View / ViewGroup ç±»ï¼Œé‡å†™ onMeasure()ã€onLayout()ã€onDraw() ä¸‰å¤§æ–¹æ³•ï¼Œä» 0 åˆ° 1 åˆ›é€ ä¸€ä¸ªæ–°çš„æ§ä»¶ æœ¬ç¯‡æ˜¯å›¾å½¢ç³»åˆ—çš„ç¬¬å››ç¯‡æ–‡ç« ï¼Œä»Šå¤©æˆ‘ä»¬æ¥èŠèŠåœ¨è‡ªå®šä¹‰ View / ViewGroup è¿‡ç¨‹ä¸­å„ä¸ªé˜¶æ®µå‘ç”Ÿçš„äº‹æƒ… ä¸€ã€æµ‹é‡é˜¶æ®µ åœ¨ Android ç³»ç»Ÿä¸­ï¼Œä¸€ä¸ª View çš„ç»˜åˆ¶æ˜¾ç¤ºå¿…é¡»è¦ç»è¿‡æµ‹é‡ã€å¸ƒå±€å’Œç»˜åˆ¶è¿™ä¸‰ä¸ªæ­¥éª¤ æµ‹é‡æ˜¯ä¸ºäº†è®¡ç®—æ¯ä¸€ä¸ª View éœ€è¦çš„å¤§å°ï¼ŒView å’Œ ViewGroup éƒ½éœ€è¦é‡å†™ onMeasure() æ–¹æ³•æ¥ç¡®å®šè‡ªå·±çš„å°ºå¯¸ å¸ƒå±€æ˜¯ä¸ºäº†è®¡ç®—æ¯ä¸€ä¸ª View çš„ä½ç½®ï¼Œé€šå¸¸åªéœ€è¦ ViewGroup é‡å†™ onLayout() æ–¹æ³•ï¼Œæ ¹æ®å®¹å™¨çš„å±æ€§åˆç†çš„æ‘†æ”¾å­ View ç»˜åˆ¶æ˜¯æœ€ç»ˆç»˜å›¾çš„é˜¶æ®µï¼Œæ‰€æœ‰çš„ç»˜å›¾æ“ä½œéƒ½åœ¨ draw é˜¶æ®µå¾—åˆ°æ‰§è¡Œï¼Œé€šå¸¸éœ€è¦ View é‡å†™ onDraw() æ–¹æ³• æˆ‘ä»¬å…ˆæ¥çœ‹ç¬¬ä¸€æ­¥çš„æµ‹é‡æµç¨‹ å›¾ç‰‡æ¥æºï¼šè‡ªå·±ç”»çš„ åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†æµ‹é‡æµç¨‹æ˜¯ç”± ViewRootImpl ç±»ä¸­çš„ performTraversals() æ–¹æ³•å‘èµ·çš„ï¼Œç»è¿‡å±‚å±‚è½¬å‘ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ°æ¯ä¸ª View çš„ onMeasure() æ–¹æ³• View çœŸæ­£çš„å°ºå¯¸ä¿¡æ¯å°±æ˜¯åœ¨ onMeasure() æ–¹æ³•ä¸­è¢«ç¡®å®šçš„ é‚£ä¹ˆ View æ˜¯æ ¹æ®ä»€ä¹ˆæ¥ç¡®å®šè‡ªå·±åº”å½“å…·æœ‰å¤šå¤§çš„å°ºå¯¸å‘¢ï¼Ÿä¸å¯èƒ½è®©å­ View è‡ªç”±åœ°å†³å®šè‡ªå·±çš„å¤§å°å§ï¼Œçˆ¶ View å¿…ç„¶éœ€è¦å‘å­ View ä¼ é€’ä¿¡æ¯æ¥å¸®åŠ©å­ View æ¥ç¡®å®šå°ºå¯¸ ä»€ä¹ˆæ˜¯ MeasureSpec æŸ¥çœ‹ measure() çš„æ–¹æ³•ç­¾åï¼š void measure(int widthMeasureSpec, int heightMeasureSpec) widthMeasureSpec å’Œ heightMeasureSpec å°±æ˜¯å¸®åŠ©å­ View ç¡®å®šå¤§å°çš„å‚æ•° å®ƒä»¬çš„ç±»å‹æ˜¯ intï¼Œå†…éƒ¨ä»¥é«˜ä¸¤ä½æ¥å­˜å‚¨æµ‹é‡çš„æ¨¡å¼ï¼Œä½ä¸‰åä½ä¸ºæµ‹é‡çš„å¤§å°ï¼Œè®¡ç®—ä¸­ä½¿ç”¨äº†ä½è¿ç®—æ¥æé«˜å¹¶ä¼˜åŒ–æ•ˆç‡ å½“ç„¶ï¼Œæˆ‘ä»¬ä¸å¿…ä½¿ç”¨ä½è¿ç®—æ¥è·å¾—å¯¹åº”çš„æ•°å€¼ï¼ŒMeasureSpec ç±»ä¸ºæˆ‘ä»¬æä¾›äº†å¯¹åº”çš„æ–¹æ³• class MeasureSpec { int UNSPECIFIED;//æœªæŒ‡å®šï¼Œä¸é™åˆ¶å¤§å° int EXACTLY;//ç²¾ç¡®æ¨¡å¼ int AT_MOST;//æœ€å¤§æ¨¡å¼ int getMode(int measureSpec) return (measureSpec &amp; MODE_MASK); int getSize(int measureSpec) return (measureSpec &amp; ~MODE_MASK); } MeasureSpec å£°æ˜äº†ä¸‰ç§æµ‹é‡æ¨¡å¼ï¼š UNSPECIFIED ï¼šæœªæŒ‡å®šæ¨¡å¼ï¼Œä¹Ÿå¯ä»¥ç§°ä¸ºæ— é™åˆ¶æ¨¡å¼ã€‚å½“ä½ æ”¶åˆ°æ­¤æ¨¡å¼æ—¶ï¼Œè¡¨æ˜çˆ¶è§†å›¾ä¸å…³å¿ƒä½ çš„å°ºå¯¸å¤§å°ï¼Œä½ å¯ä»¥éšæ„è®¾ç½®è‡ªå·±çš„å°ºå¯¸ä¿¡æ¯ã€‚ä»€ä¹ˆæƒ…å†µä¸‹å¯èƒ½æ”¶åˆ° UNSPECIFIED å‘¢ï¼Ÿæ¯”å¦‚å½“ä½ çš„çˆ¶è§†å›¾æ˜¯å¯ä»¥çºµå‘æ»šåŠ¨çš„ ScrollView ï¼Œé‚£å­è§†å›¾çš„é«˜åº¦å¤§å°å¯¹äºçˆ¶è§†å›¾æ¥è¯´æ²¡æœ‰æ„ä¹‰ã€‚æ— è®ºä½ å¤šé«˜ï¼ˆå³ä½¿è¶…å‡ºå±å¹•ï¼‰ï¼Œéƒ½å¯ä»¥é€šè¿‡æ»‘åŠ¨å±å¹•æ¥æŸ¥çœ‹ï¼ˆåŒç†ï¼Œå¦‚æœæ˜¯æ¨ªå‘æ»šåŠ¨é‚£ä¹ˆå®½åº¦å°±æ²¡æœ‰æ„ä¹‰ï¼‰ EXACTLY ï¼šç²¾ç¡®æ¨¡å¼ã€‚å½“ä½ æ”¶åˆ°æ­¤æ¨¡å¼æ—¶ï¼Œè¡¨ç¤ºçˆ¶è§†å›¾å¸Œæœ›ä½ å°±è¿™ä¹ˆå¤§ï¼ˆä¸è¦å°äºæˆ–å¤§äºç»™å®šçš„å¤§å°ï¼‰ï¼Œé€šå¸¸åœ¨ xml ä¸­æŒ‡å®šå¤§å°æˆ–è€…è®¾ä¸º match_parent æ—¶ä¼šæ”¶åˆ° EXACTLY æ¨¡å¼ AT_MOST ï¼šæœ€å¤§æ¨¡å¼ã€‚å½“ä½ æ”¶åˆ°æ­¤æ¨¡å¼æ—¶ï¼Œè¡¨ç¤ºä½ å¯ä»¥åœ¨çˆ¶è§†å›¾ç»™å®šçš„èŒƒå›´å†…éšæ„å‘æŒ¥ï¼Œä½†æœ€å¥½ä¸è¦è¶…è¿‡çˆ¶è§†å›¾ç»™ä½ çš„å¤§å°ï¼Œé€šå¸¸åœ¨ xml ä¸­è®¾ä¸º wrap_content æ—¶ä¼šæ”¶åˆ° AT_MOST æ¨¡å¼ çœ‹åˆ°è¿™é‡Œæˆ–è®¸å·²ç»æœ‰åŒå­¦å‘ç°äº†ï¼ŒView çš„æµ‹é‡æ¨¡å¼å¥½åƒå’Œæˆ‘ä»¬åœ¨ xml ä¸­æŒ‡å®šçš„å®½é«˜æœ‰å…³ï¼š View è®¾ç½®ä¸º match_parent æˆ–å›ºå®šå€¼æ—¶ï¼Œå°†ä¼šæ”¶åˆ° EXACTLY ç²¾ç¡®æ¨¡å¼ View è®¾ç½®ä¸º wrap_content æ—¶ï¼Œå°†ä¼šæ”¶åˆ° AT_MOST æœ€å¤§æ¨¡å¼ äº‹å®çœŸçš„å¦‚æ­¤å—ï¼Ÿæˆ‘ä»¬æ¥ç€å¾€ä¸‹çœ‹ MeasureSpec æ˜¯ç”±ä»€ä¹ˆå†³å®šçš„ å…³äº View æµ‹é‡æ¨¡å¼çš„åˆ›å»ºè§„åˆ™ï¼Œç½‘ä¸Šæœ‰å¼ å›¾æµä¼ çš„æ¯”è¾ƒå¹¿ å›¾ç‰‡æ¥æºï¼šè‡ªå·±æ‹çš„ ä¸Šå›¾æ˜¯ä»»ä¸»å¸­åœ¨2015å¹´å‡ºç‰ˆçš„ ã€ŠAndroidå¼€å‘è‰ºæœ¯æ¢ç´¢ã€‹ ç¬¬å››ç« çš„æ‹æ‘„å›¾ï¼Œå›¾ä¸­çš„è¡¨æ ¼éå¸¸è¯¦ç»†äº†å±•ç¤ºäº†ä¸€ä¸ª â€œæ™®é€š Viewâ€ çš„ MeasureSpec çš„åˆ›å»ºè§„åˆ™ å¦‚æœä½ çš„è‡ªå®šä¹‰ View çš„çˆ¶è§†å›¾æ˜¯ FrameLayout ã€LinearLayout ã€RelativeLayoutï¼Œæ­å–œä½ ï¼Œè¿™äº›è§„åˆ™é€‚ç”¨äºä½  ä½†å¦‚æœä½ çš„çˆ¶è§†å›¾æ˜¯ ScrollViewã€RecyclerView ç­‰æ”¯æŒæ»šåŠ¨çš„ ViewGroupï¼Œé‚£ä¹ˆä½ æ”¶åˆ°çš„æµ‹é‡æ¨¡å¼å¤šåŠå’Œä¸Šå›¾æè¿°çš„ä¸ç¬¦ æ¥ä¸‹æ¥é€šè¿‡å‡ ç»„æµ‹è¯•æ¥éªŒè¯ä¸€ä¸‹æˆ‘ä»¬çš„æƒ³æ³•ï¼š æˆ‘ä»¬ç”¨ FrameLayout å’Œ ScrollView ä½œä¸ºæµ‹è¯•çš„çˆ¶è§†å›¾ï¼ŒTextView ä½œä¸ºæµ‹è¯•çš„å­ View ç„¶åå¯¹çˆ¶è§†å›¾å’Œå­ View åˆ†åˆ«è®¾ç½®ä¸åŒçš„ LayoutParams å±æ€§ï¼Œè§‚å¯Ÿå®ƒä»¬åœ¨ä¸åŒå®½é«˜æ¨¡å¼ä¸‹çš„è¡¨ç°ï¼š å›¾ç‰‡æ¥æºï¼šè‡ªå·±æˆªå›¾ æµ‹è¯•çš„ä»£ç å¯ä»¥ç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹ï¼Œæµ‹è¯•çš„è¯¦ç»†æ•°æ®å¯ä»¥ç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹ ä»æµ‹è¯•çš„ç»“æœæ¥çœ‹ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºå‡ ä¸ªæ¯”è¾ƒæœ‰è¶£çš„ç»“è®ºï¼š FrameLayout + TextView çš„ç»„åˆï¼Œå­ View å¾—åˆ°çš„æµ‹é‡æ¨¡å¼å’Œé¢„æœŸè¡¨ç°ç›¸åŒ FrameLayout ä¸º wrap_content æ—¶ï¼ˆç¬¬äºŒè½®ç¬¬1ç»„ï¼‰ï¼Œå¦‚æœå­ View è®¾ç½®ä¸º match_parentï¼Œé‚£å­ View å°†ä¼šæ”¶åˆ°ä¸¤æ¬¡æµ‹é‡ï¼Œæœ€ç»ˆçš„ MeasureSpec å›ºå®šä¸º EXACTLY åœ¨ FrameLayout ä¸­ï¼Œå¦‚æœå­ View å®½é«˜è®¾ç½®ä¸ºå›ºå®šå€¼ï¼Œä¸”æœŸæœ›å¤§å°è¶…è¿‡äº†çˆ¶è§†å›¾ï¼ˆç¬¬ä¸‰è½®ç¬¬3ç»„æµ‹è¯•ï¼‰æ—¶ï¼Œçˆ¶è§†å›¾è¿”å›çš„å®½é«˜æ˜¯æˆ‘ä»¬è®¾å®šçš„å€¼ã€‚åŒç†ï¼Œå¦‚æœå­ View çš„è®¾ç½®çš„å¤§å°è¶…è¿‡å±å¹•å®é™…å®½é«˜ç³»ç»Ÿï¼Œçˆ¶è§†å›¾è¿”å›çš„ä¾æ—§æ˜¯è®¾å®šçš„å€¼ï¼Œå³ä½¿å®ƒéå¸¸ä¸åˆç† åœ¨ ScrollView ä¸­ï¼Œæ— è®ºå­ View æ˜¯ math_parent ã€wrap_content è¿˜æ˜¯å›ºå®šå€¼ï¼Œæˆ–è€…è¯´ä¸ç®¡å­ View ç”³è¯·çš„é«˜åº¦æ˜¯å¤§äºçˆ¶è§†å›¾è¿˜æ˜¯å°äºçˆ¶è§†å›¾çš„é«˜åº¦ï¼ŒScrollView ç»Ÿç»ŸæŒ‡å®šä¸ºè‡ªèº«é«˜åº¦ï¼ŒMode ä¸º UNSPECIFIED æˆ‘ä»¬å‘ç°ä¸€æ—¦ä½¿ç”¨ ScrollView ä½œä¸ºçˆ¶è§†å›¾ï¼Œé‚£ä¹ˆ â€œmatch_parent / wrap_conent å¯¹åº” EXACTLY/ AT_MOSTâ€ è¿™å¥—è§„åˆ™å°†ä¸å†é€‚ç”¨ ä¸ºä»€ä¹ˆ ScrollView ä¼šå¦‚æ­¤ç‰¹æ®Šå‘¢ï¼Ÿ åŸå› ä¹Ÿå¾ˆç®€å•ï¼Œå› ä¸ºå®ƒä¸æ˜¯è°ƒç”¨ getChildMeasureSpec() æ–¹æ³•ä¸ºå­ View ç”Ÿæˆçš„æµ‹é‡ç»“æœï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨ makeMeasureSpec() æ–¹æ³•ä¸ºå­ View æŒ‡å®šäº†æµ‹é‡æ¨¡å¼ä¸å¤§å° void measureChild() { ViewGroup.LayoutParams lp = child.getLayoutParams(); int childWidthMeasureSpec = getChildMeasureSpec(parentWidthMeasureSpec,lp.width); int childHeightMeasureSpec = MeasureSpec.makeMeasureSpec(parentSize,MeasureSpec.UNSPECIFIED);//é«˜åº¦æŒ‡å®šä¸ºparentSize child.measure(childWidthMeasureSpec, childHeightMeasureSpec); } åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¥å°è¯•å›ç­”å°æ ‡é¢˜çš„é—®é¢˜ï¼šMeasureSpec æ˜¯ç”±ä»€ä¹ˆå†³å®šçš„ï¼Ÿ å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œçˆ¶è§†å›¾é€šè¿‡è°ƒç”¨ getChildMeasureSpec() æ–¹æ³•ä¸ºå­ View ç”Ÿæˆæµ‹é‡ç»“æœï¼Œé‚£ä¹ˆå­ View çš„MeasureSpec æ˜¯ç”±çˆ¶è§†å›¾çš„ SpecMode å’Œ å­ View è‡ªèº«çš„ LayoutParams å…±åŒå†³å®šçš„ å½“çˆ¶è§†å›¾æ˜¯è°ƒç”¨ makeMeasureSpec() æ–¹æ³•ä¸ºå­ View æŒ‡å®šæµ‹é‡ç»“æœæ—¶ï¼ˆæ¯”å¦‚ç¤ºä¾‹ä¸­çš„ ScrollViewï¼‰ï¼Œå­ View çš„MeasureSpec æ˜¯ç”±çˆ¶è§†å›¾çš„ä¸šåŠ¡å±æ€§å†³å®šçš„ï¼ å…³äº MeasureSpec çš„ä»‹ç»æš‚æ—¶å‘Šä¸€æ®µè½ï¼Œæ¥ä¸‹æ¥è¿›å…¥æœ¬å°èŠ‚æ­£é¢˜ï¼šView çš„æµ‹é‡ View çš„æµ‹é‡è¿‡ç¨‹ View çš„æµ‹é‡è¿‡ç¨‹æ˜¯è‡ªé¡¶å‘ä¸‹çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ View å½“åšä¸€æ£µä»¥ DecorView ä½œä¸º root èŠ‚ç‚¹çš„å¤šå‰æ ‘ï¼Œæµ‹é‡äº‹ä»¶ä¼šä»¥æ·±åº¦ä¼˜å…ˆçš„é¡ºåºéå†æ•´æ£µæ ‘ View çš„æµ‹é‡å·¥ä½œæ˜¯åœ¨ onMeasure() æ–¹æ³•ä¸­è¿›è¡Œçš„ï¼Œæˆ‘ä»¬åœ¨è‡ªå®šä¹‰ View æ—¶éœ€è¦é‡å†™ onMeasure() æ–¹æ³•å¹¶æ‰§è¡Œæµ‹é‡å·¥ä½œï¼Œæ¥ç€å†è°ƒç”¨ setMeasuredDimension() æ–¹æ³•å°†æµ‹é‡çš„ç»“æœä¿å­˜èµ·æ¥ æˆ‘ä»¬ä¹Ÿå¯ä»¥é€‰æ‹©ä¸é‡å†™ onMeasure() æ–¹æ³•ï¼Œå› ä¸º Android ç³»ç»Ÿä¸ºæˆ‘ä»¬æä¾›äº†é»˜è®¤å®ç° /frameworks/base/core/java/android/view/View.java class View { void onMeasure(int widthMeasureSpec, int heightMeasureSpec) { int width = getDefaultSize(widthMeasureSpec); int height = getDefaultSize(heightMeasureSpec); setMeasuredDimension(width,height);//ä¿å­˜å®½é«˜å€¼ } int getDefaultSize(int size, int measureSpec) { switch (specMode) { case MeasureSpec.UNSPECIFIED://æ³¨æ„ï¼Œå¦‚æœæ¥æ”¶åˆ°æœªæŒ‡å®šæ¨¡å¼ï¼Œä¸€å®šè¦ä¸ºViewè®¾ç½®èƒŒæ™¯æˆ–è€…è®¾ç½®æœ€å°é«˜åº¦ result = size; break; case MeasureSpec.AT_MOST: case MeasureSpec.EXACTLY: result = specSize; break; } return result; } } åœ¨é»˜è®¤å®ç°çš„ onMeasure() æ–¹æ³•ä¸­ï¼Œä¼šå…ˆè°ƒç”¨ getDefaultSize() æ–¹æ³•ä¸ºè‡ªå·±ç”Ÿæˆå®½é«˜ä¿¡æ¯ï¼Œæ¥ç€ä¼šè°ƒç”¨ setMeasuredDimension() æ–¹æ³•å°†åˆšåˆšè·å–çš„å®½é«˜å€¼ä¿å­˜èµ·æ¥ getDefaultSize() æ–¹æ³•ä¸­æ˜¯é»˜è®¤ç”Ÿæˆè§†å›¾å°ºå¯¸çš„è§„åˆ™ï¼š å¦‚æœä½ çš„ MeasureSpec æ˜¯ AT_MOST æˆ–è€… EXACTLYï¼Œé‚£ä¹ˆä½ å¾—åˆ°çš„ size å’Œçˆ¶è§†å›¾ç›¸åŒ å¦‚æœä½ çš„ MeasureSpec æ˜¯ UNSPECIFIEDï¼Œé‚£ä¹ˆä½ çš„å°ºå¯¸å°†ä¼šå–èƒŒæ™¯å°ºå¯¸æˆ–è€…æœ€å°å®½é«˜ä¸­æœ€å¤§çš„é‚£ä¸ªå€¼ ä» getDefaultSize() æ–¹æ³•ä»£ç é€»è¾‘æ¥çœ‹ï¼Œå»ºè®®å¤§å®¶åœ¨è‡ªå®šä¹‰ View æ—¶æœ€å¥½é‡å†™ onMeasure() æ–¹æ³•ï¼Œæœ€èµ·ç è¦å¤„ç† MeasureSpec ä¸º UNSPECIFIED çš„æƒ…å†µï¼Œå¦åˆ™ï¼Œä¸€æ—¦ä½ çš„ MeasureSpec è¢«æŒ‡å®šä¸º UNSPECIFIEDï¼Œä¸” View æ²¡æœ‰è®¾ç½®æœ€å°å®½é«˜ï¼Œé‚£ä¹ˆä½ å°†æ— æ³•åœ¨å±å¹•ä¸Šçœ‹åˆ°å®ƒï¼Œå› ä¸ºå®ƒçš„é«˜åº¦æˆ–è€…å®½åº¦ä¸º 0 ï¼ æ€»ç»“ä¸€ä¸‹ View åœ¨æµ‹é‡æµç¨‹å®Œæˆçš„äº‹æƒ…ï¼š æ ¹æ®çˆ¶è§†å›¾ä¼ é€’çš„ MeasureSpecï¼Œåˆç†çš„è®¡ç®—è‡ªå·±æ‰€éœ€çš„å°ºå¯¸å¤§å° åœ¨ç¡®å®šäº†è‡ªèº«å°ºå¯¸åï¼Œè°ƒç”¨ setMeasuredDimension() æ–¹æ³•ä¿å­˜å°ºå¯¸ä¿¡æ¯ ViewGroup çš„æµ‹é‡è¿‡ç¨‹ å½“ ViewGroup ä¸­çš„æ‰€æœ‰å­ View å…¨éƒ¨æµ‹é‡å®Œä»¥åï¼Œæ¥ä¸‹æ¥å°±è¯¥è½®åˆ° ViewGroup ä¸ºè‡ªå·±è®¡ç®—é«˜åº¦äº† å’Œ View çš„æµ‹é‡è¿‡ç¨‹ç›¸æ¯”ï¼ŒAndroid å¹¶æ²¡æœ‰ä¸º ViewGroup çš„ onMeasure() æ–¹æ³•æä¾›é»˜è®¤å®ç° è¿™æ˜¯å› ä¸ºä¸åŒçš„å®¹å™¨çš„ä¸šåŠ¡é€»è¾‘éƒ½ä¸ä¸€æ ·ï¼Œå³ä½¿åŒä¸€ä¸ªå®¹å™¨ï¼Œä¹Ÿå¯èƒ½å› ä¸ºé€‚ç”¨åœºæ™¯çš„å·®åˆ«è€Œä½¿ç”¨ä¸åŒçš„æµ‹é‡ç­–ç•¥ æ‹¿ LinearLayout æ¥ä¸¾ä¾‹ï¼Œåœ¨é«˜åº¦è®¾ç½®ä¸º wrap_content çš„æƒ…å†µä¸‹ï¼š å¦‚æœæ˜¯æ¨ªå‘å¸ƒå±€ï¼ŒLinearLayout çš„é«˜åº¦åº”è¯¥æ˜¯æœ€å¤§å­ View çš„é«˜åº¦ å¦‚æœæ˜¯çºµå‘å¸ƒå±€ï¼ŒLinearLayout çš„é«˜åº¦åº”è¯¥ä¸ºæ‰€æœ‰å­Viewçš„é«˜åº¦æ€»å’Œ è™½ç„¶ ViewGroup çš„ onMeasure() æ–¹æ³•æ²¡æœ‰é»˜è®¤å®ç°ï¼Œä½†æ˜¯ï¼Œ Android ä¸º ViewGroup å‡†å¤‡äº†å‡ ä¸ªæµ‹é‡å­ View çš„æ–¹æ³•ï¼Œå› ä¸ºåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹å„ä¸ªå­ View çš„æµ‹é‡æ–¹å¼éƒ½æ˜¯ä¸€æ ·çš„ï¼Œä¸€èµ·æ¥çœ‹çœ‹ /frameworks/base/core/java/android/view/ViewGroup.java class ViewGroup extends View { //æµ‹é‡å­è§†å›¾ void measureChild() { LayoutParams lp = child.getLayoutParams(); int childWidthMeasureSpec = getChildMeasureSpec(); int childHeightMeasureSpec = getChildMeasureSpec(); child.measure(childWidthMeasureSpec, childHeightMeasureSpec); } //æµ‹é‡å­è§†å›¾å¹¶è®¡ç®—å…¶Margin void measureChildWithMargins() { MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams(); int childWidthMeasureSpec = getChildMeasureSpec(); int childHeightMeasureSpec = getChildMeasureSpec(); child.measure(childWidthMeasureSpec, childHeightMeasureSpec); } //è·å–å­Viewçš„MeasureSpecï¼Œå¯¹äºViewGroupæ¥è¯´ï¼Œè¿™æ˜¯éå¸¸é‡è¦çš„ä¸€ä¸ªæ–¹æ³•ï¼ï¼ï¼ int getChildMeasureSpec(int spec, int padding, int childDimension) { ... } } ViewGroup ç±»ä¸­é»˜è®¤æä¾›äº†3ä¸ªæµ‹é‡å­ View çš„æ–¹æ³•ï¼š measureChild()ï¼šè°ƒç”¨ getChildMeasureSpec() æ–¹æ³•ç”Ÿæˆå­è§†å›¾çš„ MeasureSpec ï¼ŒæˆåŠŸåé€šçŸ¥å­è§†å›¾æ‰§è¡Œ measure() æ–¹æ³• measureChildWithMargins() ï¼šè°ƒç”¨ getChildMeasureSpec() æ–¹æ³•ç”Ÿæˆå­è§†å›¾çš„ MeasureSpec ï¼ŒæˆåŠŸåé€šçŸ¥å­è§†å›¾æ‰§è¡Œ measure() æ–¹æ³• getChildMeasureSpec()ï¼šæ ¹æ®çˆ¶è§†å›¾çš„ MeasureSpec å’Œ å­è§†å›¾çš„ LayoutParams å±æ€§æ¥ç”Ÿæˆ å­è§†å›¾çš„ MeasureSpec measureChild() å’Œ measureChildWithMargins() éƒ½è°ƒç”¨äº† getChildMeasureSpec() æ–¹æ³•æ¥ä¸ºå­ View ç”Ÿæˆ MeasureSpecï¼Œä¸¤ä¸ªæ–¹æ³•å”¯ä¸€åŒºåˆ«æ˜¯åè€…ä½¿ç”¨äº† MarginLayoutParamsï¼Œåœ¨è®¡ç®—å­è§†å›¾å¯ç”¨ç©ºé—´æ—¶ä¼šè€ƒè™‘åˆ° Margin çš„éƒ¨åˆ† ä»€ä¹ˆæ˜¯ MarginLayoutParams å‘¢ï¼Ÿ 1ã€åˆè¯† LayoutParams View æœ‰ top ã€bottom ã€left ã€right å’Œ padding è¿™å‡ ä¸ªå±æ€§ï¼Œè®°å½•çš„æ˜¯è¿™ä¸ª View åœ¨å±å¹•åæ ‡ç³»ä¸­çš„ç»å¯¹ä½ç½®ï¼Œä½†å®ƒè¿™å‡ ä¸ªå±æ€§åªæœ‰åœ¨ layout é˜¶æ®µä»¥åæ‰ä¼šæœ‰å…·ä½“çš„å€¼ åœ¨æ²¡æœ‰ç¡®å®š View çš„ç»å¯¹ä½ç½®ä¹‹å‰ï¼ŒAndroid ç”¨ LayoutParams æ¥æè¿°ä¸€ä¸ª View / ViewGroup çš„å®½é«˜å€¼ //æè¿°View/ViewGroupçš„å®½é«˜å€¼ class LayoutParams { int MATCH_PARENT = -1; int WRAP_CONTENT = -2; //è§†å›¾çš„å®½é«˜å±æ€§ï¼Œå°äº0è¡¨ç¤ºä¸ºWRAP_CONTENT/MATCH_PARENTï¼Œå¤§äº0è¡¨ç¤ºä¸ºå…·ä½“çš„å°ºå¯¸ int width; int height; } LayoutParams ä½¿ç”¨ width å’Œ height å±æ€§æ¥æè¿°å®½é«˜ï¼Œå¦‚æœå°äº0è¡¨ç¤ºä¸º WRAP_CONTENT / MATCH_PARENTï¼Œå¤§äº0åˆ™è¡¨ç¤ºä¸ºå…·ä½“çš„å°ºå¯¸ ViewGroup ä¸­è¿˜æœ‰ä¸€ä¸ªå« MarginLayoutParams çš„é™æ€å†…éƒ¨ç±»ï¼Œå®ƒç»§æ‰¿è‡ª LayoutParams å¹¶åœ¨å…¶åŸºç¡€ä¸Šå¢åŠ äº†ä¸Šä¸‹å·¦å³é—´è·å€¼ æˆ‘ä»¬æ—¥å¸¸ä½¿ç”¨çš„ ViewGroup ä¸­å‡¡æ˜¯æ”¯æŒè®¾ç½® margin å±æ€§çš„éƒ½æ˜¯ç»§æ‰¿è‡ª MarginLayoutParamsï¼Œå¦‚æœä½ æƒ³è¦åœ¨ä»£ç ä¸­åŠ¨æ€çš„ä¿®æ”¹ View çš„ margin å±æ€§ï¼Œè®°å¾—å¼ºè½¬ä¸º MarginLayoutParams ç±»å‹å†è¿›è¡Œæ“ä½œ //åœ¨å®½é«˜å€¼çš„åŸºç¡€ä¸Šå¢åŠ äº†ä¸Šä¸‹å·¦å³é—´è·å€¼ï¼Œå‡¡æ˜¯æ”¯æŒè®¾ç½®marginçš„å®¹å™¨éƒ½æ˜¯ç»§æ‰¿è‡ªMarginLayoutParams class MarginLayoutParams extends ViewGroup.LayoutParams { leftMargin; topMargin; rightMargin; bottomMargin; ... } MarginLayoutParams è™½ç„¶æ˜¯ View çš„å±æ€§ä¹‹ä¸€ï¼Œä½†å®ƒæè¿°çš„é—´è·å€¼å¹¶ä¸ç®—åœ¨ View çš„å¯ç”¨ç©ºé—´ï¼Œåœ¨è®¡ç®—è§†å›¾å¤§å°æ—¶ï¼Œmargin æ˜¯ç®—åˆ°çˆ¶è§†å›¾çš„å¯ç”¨ç©ºé—´é‡Œï¼Œåªæœ‰ padding æ‰æ˜¯ç®—åˆ°è‡ªå·±çš„å¯ç”¨ç©ºé—´ 2ã€ç”Ÿæˆ ChildView MeasureSpec å…³äº LayoutParams æš‚æ—¶å…ˆå‘Šä¸€æ®µè½ï¼Œåœ¨åé¢ layout é˜¶æ®µä¼šå†æ¬¡ä»‹ç»ï¼Œå®ƒæ˜¯ ViewGroup èƒ½å¤Ÿæ­£ç¡®æ‘†æ”¾å­è§†å›¾çš„é‡è¦ä¾æ® æ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹ ViewGroup æœ€æ ¸å¿ƒçš„é€»è¾‘ï¼Œå¦‚ä½•ä¸ºå­ View ç”Ÿæˆ MeasureSpec ï¼Ÿ å‰é¢è¯´äº† Android è™½ç„¶æ²¡æœ‰ä¸º ViewGroup æä¾› onMeasure() æ–¹æ³•çš„é»˜è®¤å®ç°ï¼Œä½† Android ä¸º ViewGroup å‡†å¤‡äº†å‡ ä¸ªæµ‹é‡å­ View çš„æ–¹æ³• åœ¨è¿™å‡ ä¸ªæµ‹é‡å­ View çš„æ–¹æ³•ä¸­ï¼Œæœ€é‡è¦çš„å½“å± getChildMeasureSpec() æ–¹æ³• /frameworks/base/core/java/android/view/ViewGroup.java class ViewGroup extends View { int getChildMeasureSpec(int spec, int padding, int childDimension) { int specMode = MeasureSpec.getMode(spec);//çˆ¶è§†å›¾çš„ SpecMode int specSize = MeasureSpec.getSize(spec);//çˆ¶è§†å›¾çš„å¤§å° int size = Math.max(0, specSize - padding);//å­è§†å›¾å¯ç”¨ç©ºé—´å¤§å°ä¸ºï¼šçˆ¶è§†å›¾å¤§å° - çˆ¶è§†å›¾ padding - å­è§†å›¾ margin int resultSize = 0; int resultMode = 0; switch (specMode) { case MeasureSpec.EXACTLY: // çˆ¶è§†å›¾ä¸º EXACTLY æ—¶ if (childDimension &gt;= 0) resultSize = childDimension;// å­è§†å›¾è®¾ç½®çš„å¤§å°ä¸ºå›ºå®šå€¼æ—¶ï¼Œå¬å­è§†å›¾çš„ï¼Œæˆ‘ä¸ç®¡ä½ ï¼Œçˆ±å¤šå¤§å°±å¤šå¤§ï¼Œæ¨¡å¼ä¹Ÿç»™ä½ ç²¾ç¡®æ¨¡å¼ EXACTLY resultMode = MeasureSpec.EXACTLY;/ if (childDimension == LayoutParams.MATCH_PARENT) { resultSize = size;// å­è§†å›¾ä¸º MATCH_PARENT ï¼ŒæŠŠä½ çš„å¤§å°è®¾ç½®å’Œçˆ¶è§†å›¾ç›¸åŒï¼Œå€¼å›ºå®šäº†ï¼Œæ¨¡å¼ç»™ä½ ç²¾ç¡®æ¨¡å¼ EXACTLY resultMode = MeasureSpec.EXACTLY; if (childDimension == LayoutParams.WRAP_CONTENT) { resultSize = size;// å­è§†å›¾ä¸º WRAP_CONTENTï¼Œçˆ¸çˆ¸ä¹Ÿä¸çŸ¥é“ä½ è¦å¤šå¤§ï¼ŒæŠŠæˆ‘çš„å…¨éƒ¨éƒ½ç»™ä½ ï¼Œæ¨¡å¼æŒ‡å®šä¸ºæœ€å¤§æ¨¡å¼ï¼Œä½ åœ¨è¿™ä¸ªèŒƒå›´å†…éšæ„å‘æŒ¥ resultMode = MeasureSpec.AT_MOST; case MeasureSpec.AT_MOST: // çˆ¶è§†å›¾ä¸º AT_MOST æ—¶ if (childDimension &gt;= 0) { resultSize = childDimension;// åŒä¸Šï¼Œå­è§†å›¾è®¾ç½®çš„å¤§å°ä¸ºå›ºå®šå€¼æ—¶ï¼Œå¬å­è§†å›¾çš„ï¼Œæˆ‘ä¸ç®¡ä½ ï¼Œçˆ±å¤šå¤§å°±å¤šå¤§ï¼Œæ¨¡å¼ä¹Ÿç»™ä½ ç²¾ç¡®æ¨¡å¼ EXACTLY resultMode = MeasureSpec.EXACTLY; if (childDimension == LayoutParams.MATCH_PARENT) { resultSize = size;// è™½ç„¶å­è§†å›¾æ˜¯ MATCH_PARENT ä½†çˆ¶è§†å›¾æˆ‘è‡ªä¸ªæ˜¯ AT_MOSTï¼Œé‚£æ€ä¹ˆåŠï¼Ÿæˆ‘å¤šå¤§ä½ å¤šå¤§å‘—ï¼Œå°†æ¨¡å¼æŒ‡å®šä¸ºæœ€å¤§æ¨¡å¼ï¼Œåœ¨æˆ‘ç»™ä½ è¿™ä¸ªèŒƒå›´å†…éšæ„å‘æŒ¥å¥½äº† resultMode = MeasureSpec.AT_MOST; if (childDimension == LayoutParams.WRAP_CONTENT) { resultSize = size;// åŒä¸Šï¼ŒæŠŠçˆ¶è§†å›¾çš„å…¨éƒ¨éƒ½ç»™ä½ ï¼Œæ¨¡å¼æŒ‡å®šä¸ºæœ€å¤§æ¨¡å¼ï¼Œä½ åœ¨è¿™ä¸ªèŒƒå›´å†…éšæ„å‘æŒ¥ resultMode = MeasureSpec.AT_MOST; case MeasureSpec.UNSPECIFIED: // çˆ¶è§†å›¾ä¸º UNSPECIFIED æ—¶ if (childDimension &gt;= 0) { resultSize = childDimension;// ä¸ç®¡çˆ¶è§†å›¾æˆ‘æ˜¯ä»€ä¹ˆæ¨¡å¼ï¼Œåªè¦ä½ è®¾ç½®äº†å…·ä½“å€¼ï¼Œä½ çˆ±å¤šå¤§å¤šå¤§ resultMode = MeasureSpec.EXACTLY; if (childDimension == LayoutParams.MATCH_PARENT) { resultSize = sUseZeroUnspecifiedMeasureSpec ? 0 : size;// å­è§†å›¾æƒ³å’Œæˆ‘ä¸€æ ·å¤§ï¼Ÿ æ»¡è¶³ä½ ï¼Œæ¨¡å¼ç»™ä½  UNSPECIFIEDï¼Œpsï¼šsUseZeroUnspecifiedMeasureSpec é»˜è®¤ä¸ºfalse resultMode = MeasureSpec.UNSPECIFIED; //modeä¸º if (childDimension == LayoutParams.WRAP_CONTENT) { resultSize = sUseZeroUnspecifiedMeasureSpec ? 0 : size;// ä½ ä¹Ÿä¸çŸ¥é“è‡ªå·±å¤šå¤§ï¼Œé‚£æˆ‘å°±æŠŠè‡ªå·±çš„å°ºå¯¸ç»™ä½ ï¼Œæ¨¡å¼ä¹Ÿç»™ä½ æˆ‘çš„æ¨¡å¼ UNSPECIFIED resultMode = MeasureSpec.UNSPECIFIED; } return MeasureSpec.makeMeasureSpec(resultSize, resultMode); } } getChildMeasureSpec() ä¸­çš„é€»è¾‘æ˜¯æ ¹æ®çˆ¶è§†å›¾çš„ MeasureSpec å’Œ å­ View çš„ LayoutParams æ¥ç”Ÿæˆ MeasureSpecï¼Œè§„åˆ™å¦‚ä¸‹ï¼š çˆ¶è§†å›¾ä¸º EXACTLY æ—¶ å­è§†å›¾è®¾ç½®çš„å¤§å°ä¸ºå›ºå®šå€¼ï¼Œå¬å­è§†å›¾çš„ï¼Œæˆ‘ä¸ç®¡ä½ ï¼Œçˆ±å¤šå¤§å°±å¤šå¤§ï¼Œæ¨¡å¼ä¹Ÿç»™ä½ ç²¾ç¡®æ¨¡å¼ EXACTLY å­è§†å›¾ä¸º MATCH_PARENT ï¼ŒæŠŠä½ çš„å¤§å°è®¾ç½®å’Œçˆ¶è§†å›¾ç›¸åŒï¼Œå€¼å›ºå®šäº†ï¼Œæ¨¡å¼ç»™ä½ ç²¾ç¡®æ¨¡å¼ EXACTLY å­è§†å›¾ä¸º WRAP_CONTENTï¼Œçˆ¸çˆ¸ä¹Ÿä¸çŸ¥é“ä½ è¦å¤šå¤§ï¼ŒæŠŠæˆ‘çš„å…¨éƒ¨éƒ½ç»™ä½ ï¼Œæ¨¡å¼æŒ‡å®šä¸ºæœ€å¤§æ¨¡å¼ï¼Œä½ åœ¨è¿™ä¸ªèŒƒå›´å†…éšæ„å‘æŒ¥ çˆ¶è§†å›¾ä¸º AT_MOST æ—¶ å­è§†å›¾è®¾ç½®çš„å¤§å°ä¸ºå›ºå®šå€¼ï¼Œå¬å­è§†å›¾çš„ï¼Œæˆ‘ä¸ç®¡ä½ ï¼Œçˆ±å¤šå¤§å°±å¤šå¤§ï¼Œæ¨¡å¼ä¹Ÿç»™ä½ ç²¾ç¡®æ¨¡å¼ EXACTLY å­è§†å›¾ä¸º MATCH_PARENTï¼Œè™½ç„¶å­è§†å›¾æ˜¯ MATCH_PARENT ä½†çˆ¶è§†å›¾æˆ‘è‡ªä¸ªæ˜¯ AT_MOSTï¼Œé‚£æ€ä¹ˆåŠï¼Ÿæˆ‘å¤šå¤§ä½ å¤šå¤§å‘—ï¼Œå°†æ¨¡å¼æŒ‡å®šä¸ºæœ€å¤§æ¨¡å¼ï¼Œåœ¨æˆ‘ç»™ä½ è¿™ä¸ªèŒƒå›´å†…éšæ„å‘æŒ¥å¥½äº† å­è§†å›¾ä¸º WRAP_CONTENTï¼ŒæŠŠçˆ¶è§†å›¾çš„å…¨éƒ¨éƒ½ç»™ä½ ï¼Œæ¨¡å¼æŒ‡å®šä¸ºæœ€å¤§æ¨¡å¼ï¼Œä½ åœ¨è¿™ä¸ªèŒƒå›´å†…éšæ„å‘æŒ¥ çˆ¶è§†å›¾ä¸º UNSPECIFIED æ—¶ å­è§†å›¾è®¾ç½®çš„å¤§å°ä¸ºå›ºå®šå€¼ï¼Œä¸ç®¡çˆ¶è§†å›¾æˆ‘æ˜¯ä»€ä¹ˆæ¨¡å¼ï¼Œåªè¦ä½ è®¾ç½®äº†å…·ä½“å€¼ï¼Œä½ çˆ±å¤šå¤§å¤šå¤§ å­è§†å›¾ä¸º MATCH_PARENTï¼Œå­è§†å›¾æƒ³å’Œæˆ‘ä¸€æ ·å¤§ï¼Ÿ æ»¡è¶³ä½ ï¼Œæ¨¡å¼ç»™ä½  UNSPECIFIED å­è§†å›¾ä¸º WRAP_CONTENTï¼Œä½ ä¹Ÿä¸çŸ¥é“è‡ªå·±å¤šå¤§ï¼Œé‚£æˆ‘å°±æŠŠè‡ªå·±çš„å°ºå¯¸ç»™ä½ ï¼Œæ¨¡å¼ä¹Ÿç»™ä½ æˆ‘çš„æ¨¡å¼ UNSPECIFIED æˆ‘ä»¬å°† getChildMeasureSpec() æ–¹æ³•ä¸­ ChildView MeasureSpec çš„ç”Ÿæˆè§„åˆ™ç»Ÿè®¡èµ·æ¥ï¼ˆè§ä¸‹å›¾ï¼‰å°±æ˜¯ ã€ŠAndroidå¼€å‘è‰ºæœ¯æ¢ç´¢ã€‹ ä¸­è¡¨æ ¼çš„å†…å®¹ å›¾ç‰‡æ¥æºï¼šhttps://www.yuque.com/docs/share/c2296195-b016-49d3-a7d4-30775b2c0f3f æ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡ä¸€æ®µç¤ºä¾‹ä»£ç æ¥æ¼”ç¤ºä¸€ä¸‹ getChildMeasureSpec() æ–¹æ³•åœ¨ LinearLayout ä¸­çš„å®æˆ˜ä½¿ç”¨ /frameworks/base/core/java/android/widget/LinearLayout.java class LinearLayout extends ViewGroup { int mTotalLength = 0; void onMeasure(int widthMeasureSpec, int heightMeasureSpec) { int maxWidth =0; for (int i = 0; i &lt; count; ++i) { measureChildWithMargins(child);//ä¸ºæ¯ä¸ªå­ View åˆ›å»º MeasureSpecå¹¶é€šçŸ¥æ‰§è¡Œ measure maxWidth = Math.max(maxWidth,child.getWidth());// æ›´æ–° LinearLayout çš„æœ€å¤§å®½åº¦ mTotalLength += child.getHeight();// è·å–æ¯ä¸ªViewé«˜åº¦ï¼Œç´¯åŠ ç»“æœ LinearLayout çš„é«˜åº¦ } setMeasuredDimension(maxWidth,mTotalLength);//è®¾ç½®è‡ªèº«å°ºå¯¸ } void measureChildWithMargins(View child) { int width = getChildMeasureSpec(); int height = getChildMeasureSpec(); child.measure(width, height);// é€šçŸ¥å­ View æ‰§è¡Œ measure } void getChildMeasureSpec();//ä¸ºå­ View ç”Ÿæˆ MeasureSpec } ç¤ºä¾‹ä»£ç æ¼”ç¤ºçš„æ˜¯ä¸€ä¸ªçºµå‘çš„ LinearLayout æµ‹é‡è¿‡ç¨‹ï¼š è°ƒç”¨äº† measureChildWithMargins() æ–¹æ³•ä¸ºæ¯ä¸ªå­ View åˆ›å»º MeasureSpec å¹¶é€šçŸ¥å…¶æ‰§è¡Œ measure å­ View æµ‹é‡å®Œæˆåï¼Œè·å–æ¯ä¸ªå­ View çš„é«˜åº¦ç´¯åŠ åˆ°æˆå‘˜å˜é‡ mTotalLength ï¼ŒåŒæ—¶ä¸æ–­æ›´æ–°æœ€å¤§å®½åº¦çš„å­ Viewï¼Œå®ƒçš„å®½åº¦å°±æ˜¯ LinearLayout å°†æ¥çš„å®½åº¦ å¾ªç¯ç»“æŸè¡¨ç¤ºæ‰€æœ‰å­ View å…¨éƒ½æµ‹é‡å®Œæˆï¼Œè°ƒç”¨ setMeasuredDimension() æ–¹æ³•ä¿å­˜è‡ªèº«å°ºå¯¸ä¿¡æ¯ å½“ LinearLayout çš„æµ‹é‡å·¥ä½œç»“æŸåï¼Œä¼šå¼€å§‹æ‰§è¡Œå®ƒçš„çˆ¶è§†å›¾çš„æµ‹é‡æµç¨‹ï¼Œç›´åˆ°æœ€é¡¶éƒ¨çš„ DecorView çš„ measure æ–¹æ³•æ‰§è¡Œç»“æŸï¼Œåˆ°é‚£æ—¶ï¼Œæ•´ä¸ªè§†å›¾æ‰€ä¾é™„çš„ Window çš„å¤§å°æ‰å¯ä»¥ç¡®å®šä¸‹æ¥ onMeasure() æ‰§è¡Œå¤šæ¬¡çš„åŸå›  æœ‰è¿‡è‡ªå®šä¹‰ View / ViewGroup å¼€å‘ç»éªŒçš„å°ä¼™ä¼´è‚¯å®šçŸ¥é“ï¼ŒView çš„ onMeasure() æ–¹æ³•å¯èƒ½ä¼šå­˜åœ¨è¢«å¤šæ¬¡è°ƒç”¨çš„æƒ…å†µ å°¤å…¶åœ¨é¦–æ¬¡åŠ è½½ Activity æ—¶ï¼Œæ¯ä¸ª View æœ€å°‘ä¹Ÿä¼šæ‰§è¡Œ2æ¬¡ onMeasure() æ–¹æ³• è¿™2æ¬¡è°ƒç”¨éƒ½å‘ç”Ÿåœ¨ ViewRootImpl ç±»çš„ performTraversals() æ–¹æ³•ä¸­ï¼Œå…¶ä»–çš„å‡ æ¬¡è°ƒç”¨æœ‰çš„ä¹Ÿè¿˜æ˜¯å‘ç”Ÿåœ¨ ViewRootImpl ä¸­ï¼Œæœ‰çš„åˆ™æ˜¯ ViewGroup çš„ä¸ªäººè¡Œä¸ºï¼Œæˆ‘ä»¬æ¥ç€å¾€ä¸‹çœ‹ 1ã€åˆ›å»º Surface å¼•èµ·çš„äºŒæ¬¡è°ƒç”¨ ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬çŸ¥é“äº† ViewRootImpl é‡Œé¢ç®¡ç†ç€ä¸€ä¸ª Surface å¯¹è±¡ View å¿…é¡»ä¾æ‰˜ Surface å¯¹è±¡æ‰èƒ½å¤Ÿæ˜¾ç¤ºç»˜åˆ¶ï¼Œæ‰€ä»¥ï¼Œåœ¨ View æ‰§è¡Œæµ‹é‡å·¥ä½œä¹‹å‰ï¼ŒSurface çš„å¤§å°å¿…é¡»å…ˆç¡®å®šä¸‹æ¥ Surface çš„å¤§å°ä»€ä¹ˆæ—¶å€™ç¡®å®šçš„å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹ ViewRootImpl#performTraversals() æ–¹æ³•ä¸­çš„é€»è¾‘ /frameworks/base/core/java/android/view/ViewRootImpl.java class ViewRootImpl { void performTraversals() { if(layoutRequested){//APPå‘èµ·requestLayoutè¯·æ±‚ boolean è§†å›¾å°ºå¯¸å‘ç”Ÿå˜åŒ– = measureHierarchy();//â‘  æ‰§è¡Œæ—¥å¸¸æµ‹é‡å·¥ä½œ } if(é¦–æ¬¡æ·»åŠ è§†å›¾/è§†å›¾å°ºå¯¸å‘ç”Ÿå˜åŒ–ç­‰){ relayoutWindow();//Windowå¤§å°ç¡®å®šä¸‹æ¥ä»¥åï¼Œå»sfç”³è¯·å¯¹åº”å¤§å°çš„surface performMeasure();//â‘¡ ç”³è¯·åˆ°surfaceåå†æ¬¡æµ‹é‡ï¼Œæ­¤æ–¹æ³•ç»“æŸåï¼Œè¯¥windowçš„å¤§å°å°†ä¼šè¢«ç¡®å®šï¼Œé™¤éwindowçš„å°ºå¯¸å‘ç”Ÿæ”¹å˜ï¼Œå¦åˆ™ä¸ä¼šå†æ¬¡æ‰§è¡Œè¯¥æ–¹æ³• } } boolean measureHierarchy(){//æ‰§è¡Œæµ‹é‡ï¼Œå¹¶è¿”å›å’Œç¼“å­˜çš„çª—å£å¤§å°æ¯”ï¼Œæ–°çš„æµ‹é‡å°ºå¯¸æ˜¯å¦å‘ç”Ÿå˜åŒ– performMeasure(); } void performMeasure() { mView.measure(); } } åœ¨ performTraversals() æ–¹æ³•ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå½“æˆ‘ä»¬å‘èµ· requestLayout è¯·æ±‚æ—¶ï¼Œæœ€ç»ˆæ˜¯ç”± measureHierarchy() æ–¹æ³•æ¥æ‰§è¡Œæµ‹é‡å·¥ä½œ æµ‹é‡å·¥ä½œç»“æŸåï¼Œæ¥ç€åˆ¤æ–­æ˜¯ä¸æ˜¯é¦–æ¬¡æ·»åŠ è§†å›¾æˆ–è€…æµ‹é‡å¾—åˆ°çš„ç»“æœä¸ç¼“å­˜çª—å£å°ºå¯¸ä¸ç¬¦ å¦‚æœæ˜¯é¦–æ¬¡æ·»åŠ è§†å›¾ï¼Œè¯´æ˜ Surface ä¹‹å‰ä¸å­˜åœ¨ï¼Œéœ€è¦é‡æ–°åˆ›å»º å¦‚æœè°ƒç”¨ measureHierarchy() æ–¹æ³•å¾—åˆ°çš„æµ‹é‡ç»“æœä¸ç¼“å­˜ä¸ç¬¦ï¼Œè¯´æ˜ Window çš„å¤§å°å‘ç”Ÿå˜åŒ–ï¼Œéœ€è¦é‡æ–°ç”³è¯·Surface åªè¦æ»¡è¶³ä»¥ä¸Šæ¡ä»¶ï¼ŒViewRootImpl ä¾¿ä¼šæºå¸¦æµ‹é‡å¾—åˆ°çš„å®½é«˜å€¼å»è°ƒç”¨ relayoutWindow() æ–¹æ³•ï¼Œè¯·æ±‚ SF è¿›ç¨‹åˆ›å»ºä¸€ä¸ªç¬¦åˆå°ºå¯¸è¦æ±‚çš„ Surface ç­‰åˆ° relayoutWindow() æ–¹æ³•è¿”å›ï¼Œä¸€ä¸ªå’Œ DecorView å¤§å°ç›¸åŒçš„ Surface ä¾¿åˆ›å»ºæˆåŠŸã€‚ åœ¨åˆ›å»º Surface çš„è¿‡ç¨‹ä¸­ï¼Œä¸€å…±æ‰§è¡Œäº†ä¸¤æ¬¡æµ‹é‡ï¼ˆä»£ç ä¸­æ ‡è®°ä¸º1/2å·ï¼‰ï¼š ç¬¬ä¸€æ¬¡æ˜¯åœ¨ measureHierarchy() æ–¹æ³•ä¸­è°ƒç”¨äº† performMeasure() æ‰§è¡Œæµ‹é‡å·¥ä½œ ç¬¬äºŒæ¬¡æ˜¯åœ¨ relayoutWindow() æ–¹æ³•ç”³è¯·åˆ° Surface ä»¥åï¼Œå†æ¬¡è°ƒç”¨ performMeasure() å‘èµ·çš„æµ‹é‡ è¿™ä¸¤æ¬¡æµ‹é‡å°±æ˜¯é¦–æ¬¡åŠ è½½ Activity æ—¶ï¼ŒView éƒ½ä¼šæ‰§è¡Œ2æ¬¡ onMeasure() æ–¹æ³•çš„åŸå› ï¼ 2ã€Dialog å¯èƒ½ä¼šå¼•å‘å¤šæ¬¡è°ƒç”¨ åœ¨äº†è§£åˆ›å»º Surface ä¼šå¯¼è‡´äºŒæ¬¡è°ƒç”¨ onMeasure() æ–¹æ³•çš„åŸå› åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹é¢çš„è¿™å¼ è¡¨æ ¼ï¼š å›¾ç‰‡æ¥æºï¼šè‡ªå·±æˆªå›¾ æµ‹è¯•ä»£ç ç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹ï¼Œè¯¦ç»†æ•°æ®ç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹ è¿™å¼ è¡¨æ ¼çš„æ•°æ®æ¥è‡ªæˆ‘è‡ªå·±åšçš„ä¸€ä¸ªå°æµ‹è¯•ï¼Œæµ‹è¯•çš„æ­¥éª¤å¾ˆç®€å•ï¼šè‡ªå®šä¹‰ä¸€ä¸ª ViewGroup ç»§æ‰¿è‡ª FrameLayoutï¼Œåœ¨ä¸åŒçš„ Activity ä¸»é¢˜ä¸‹ï¼Œè®°å½• onMeasure() æ–¹æ³•çš„æ‰§è¡Œæ¬¡æ•° ä»æµ‹è¯•çš„ç»“æœæ¥çœ‹ï¼Œæ™®é€šçš„ Activity + FrameLayout çš„ç»„åˆï¼Œåœ¨é¦–æ¬¡åŠ è½½ Activity æ—¶ onMeasure() æ–¹æ³•è¢«è°ƒç”¨äº†2æ¬¡ï¼Œåœ¨æˆ‘ä»¬æ‰‹åŠ¨è¯·æ±‚ requestLayout() ä»¥å onMeasure() æ–¹æ³•æ‰§è¡Œäº†ä¸€æ¬¡ï¼Œæµ‹è¯•ç»“æœç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸ ä½†æ˜¯ï¼Œå½“æˆ‘ä»¬æŠŠ Activity çš„ä¸»é¢˜ä¸º Dialog ä»¥åï¼ŒonMeasure() æ–¹æ³•çš„è°ƒç”¨æ¬¡æ•°ç«Ÿç„¶è¾¾åˆ°äº†6æ¬¡ï¼ å†æ¬¡ä¿®æ”¹æµ‹è¯•æ¡ä»¶ï¼Œæˆ‘ä»¬æŠŠæ ¹è§†å›¾çš„å®½åº¦æ”¹ä¸ºå’Œå±å¹•å®é™…å®½åº¦ç›¸åŒä»¥åï¼Œå‘ç° onMeasure() æ–¹æ³•çš„è°ƒç”¨æ¬¡æ•°æ›´æ˜¯è¾¾åˆ°äº†æƒŠäººçš„12æ¬¡ï¼ï¼ ä¸ºä»€ä¹ˆä¼šå‘ç”Ÿè¿™ä¹ˆå¤šæ¬¡çš„è°ƒç”¨ï¼Ÿè·Ÿè¸ª performMeasure() æ–¹æ³•çš„è°ƒç”¨é“¾å¯ä»¥å‘ç°ï¼Œå¤šå‡ºæ¥çš„å‡ æ¬¡è°ƒç”¨éƒ½æ˜¯åœ¨ measureHierarchy() æ–¹æ³•å†…å‘èµ·ï¼Œé‚£æ¥ä¸‹æ¥æˆ‘ä»¬å°±ä¸€èµ·æ¥çœ‹çœ‹ measureHierarchy() æ–¹æ³•é‡Œé¢éƒ½åšäº†äº›ä»€ä¹ˆ /frameworks/base/core/java/android/view/ViewRootImpl.java class ViewRootImpl { boolean measureHierarchy(int desiredWindowWidth, int desiredWindowHeight){ //å®½åº¦ä¸º WRAP_CONTENTï¼Œé€šå¸¸è¡¨ç¤ºæ˜¯ Dialog æˆ–è€…æ˜¯ Dialog ä¸»é¢˜çš„ Activity if (width == ViewGroup.LayoutParams.WRAP_CONTENT) { int baseSize = è¯»å–ç³»ç»Ÿé¢„ç½®çš„Dialogå®½åº¦; //æ—¢ç„¶æ˜¯Dialogï¼ŒAndroidä¸å¸Œæœ›å®ƒå……æ»¡å±å¹•ï¼Œæ‰€ä»¥è¿™é‡Œçš„å®½åº¦è¢«è®¾ç½®ä¸ºäº†é¢„è®¾å®½åº¦ childWidthMeasureSpec = getRootMeasureSpec(baseSize, lp.width); childHeightMeasureSpec = getRootMeasureSpec(desiredWindowHeight, lp.height);//é«˜åº¦ä¾æ—§ä¸ºå±å¹•é«˜åº¦ï¼Œä½ æƒ³è¦å¤šé«˜è‡ªå·±å®š //â‘ è¿›è¡Œé¦–æ¬¡æµ‹é‡ performMeasure(childWidthMeasureSpec, childHeightMeasureSpec); //æµ‹é‡ç»“æŸåï¼Œå‘ç°è§†å›¾æœŸæœ›çš„å®½åº¦æ²¡æœ‰è¶…è¿‡é¢„è®¾å®½åº¦ï¼ŒgoodMeasureè®¾ä¸ºtrueï¼Œåœ¨åç»­æµç¨‹ä¸­ä¸å†æ‰§è¡Œæµ‹é‡å·¥ä½œï¼ŒMEASURED_STATE_TOO_SMALLè¿™ä¸ªflagè¡¨ç¤ºæµ‹é‡å°ºå¯¸å°äºè§†å›¾æƒ³è¦çš„ç©ºé—´ if ((host.getMeasuredWidthAndState() &amp; View.MEASURED_STATE_TOO_SMALL) == 0) { goodMeasure = true; } else { //è§†å›¾æœŸæœ›çš„å®½åº¦è¶…è¿‡äº†é¢„ç½®å®½åº¦ï¼Œæ¯”å¦‚æˆ‘åœ¨xmlå†™æ­»&quot;layout_width=10086px&quot;ï¼Œé‚£ä¹ˆæŠŠbaseSizeæ”¹å¤§ä¸€äº›å†æ¬¡æµ‹é‡è¯•ä¸€è¯• baseSize = (baseSize + desiredWindowWidth) / 2; //â‘¡å†æ¬¡æ‰§è¡Œæµ‹é‡ performMeasure(childWidthMeasureSpec, childHeightMeasureSpec); //åŒæ ·çš„ï¼Œåœ¨æµ‹é‡æ‰§è¡Œç»“æŸåæŸ¥çœ‹å®½åº¦æ˜¯å¦æ»¡è¶³é¢„æœŸï¼Œæ»¡è¶³åˆ™å°†goodMeasureè®¾ä¸ºtrueï¼Œåœ¨åç»­æµç¨‹ä¸­ä¸å†æ‰§è¡Œæµ‹é‡å·¥ä½œ if ((host.getMeasuredWidthAndState() &amp; View.MEASURED_STATE_TOO_SMALL) == 0) { goodMeasure = true; } } } //æ–¹æ³•èƒ½èµ°åˆ°è¿™æœ‰ä¸¤ç§æƒ…å†µï¼š //1. è¯¥è§†å›¾æ˜¯æ™®é€šçš„Activityï¼ŒDecorViewå®½é«˜ä¸æ˜¯ WRAP_CONTENT //2. è¯¥è§†å›¾æ˜¯Dialogç±»å‹ï¼Œä¸”Dialogæƒ³è¦çš„å®½åº¦å¾ˆå¤§ï¼Œç³»ç»Ÿé¢„è®¾çš„å®½åº¦ä¸æ»¡è¶³ï¼Œå†æ¬¡æ‰©å®¹ä»¥ååŒæ ·ä¸æ»¡è¶³ï¼Œæ²¡åŠæ³•ï¼Œç´¢æ€§ç›´æ¥ç»™å®ƒå±å¹•çš„å®é™…å®½é«˜è®©å®ƒè‡ªå·±æŠ˜è…¾å» if (!goodMeasure) { //â‘¢è¿™é‡Œçš„æµ‹é‡æ–¹æ³•å¦‚æœå¾—åˆ°æ‰§è¡Œï¼Œè¦ä¹ˆæ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼Œè¦ä¹ˆæ˜¯ç¬¬ä¸‰æ¬¡è°ƒç”¨ performMeasure(childWidthMeasureSpec,childHeightMeasureSpec); } return windowSizeMayChange;//è¿”å›å’Œç¼“å­˜çš„windowç›¸æ¯”ï¼Œæµ‹é‡ä¸‹æ¥çš„è§†å›¾å¤§å°æ˜¯å¦å‘ç”Ÿå˜åŒ– } } åœ¨ measureHierarchy() æ–¹æ³•ä¸­ï¼Œé¦–å…ˆä¼šåˆ¤æ–­ DecorView çš„å®½åº¦æ˜¯ä¸æ˜¯ WRAP_CONTENTï¼Œæ˜¯çš„è¯è¡¨ç¤ºè¯¥è§†å›¾å¯èƒ½æ˜¯ä¸ª Dialog æˆ–è€…æ˜¯ Dialog ä¸»é¢˜çš„ Activity å¦‚æœæ˜¯ Dialog ç±»å‹çš„è§†å›¾ï¼ŒAndroid ä¸å¸Œæœ›å®ƒå……æ»¡å±å¹•ï¼Œå› æ­¤ï¼Œè§†å›¾çš„å®½åº¦å°†ä¼šä» å±å¹•å®é™…å®½åº¦ æ›´æ”¹ä¸º Dialog çš„ ç³»ç»Ÿé¢„è®¾å®½åº¦ ï¼Œç„¶åæ‰§è¡Œè§†å›¾çš„æµ‹é‡å·¥ä½œ ç¬¬ä¸€æ¬¡æµ‹é‡å®Œæˆåï¼Œå¦‚æœè¯¥è§†å›¾æœŸæœ›çš„å®½åº¦æ¯”ç³»ç»Ÿé¢„è®¾å®½åº¦å¤§ï¼Œé‚£å°±ç”¨ç³»ç»Ÿé¢„è®¾å®½åº¦ + å±å¹•å®é™…å®½åº¦ / 2ç®—å‡ºæ¥çš„å€¼å½“åšæ–°çš„å®½åº¦è¦æ±‚ï¼Œå†æ¬¡æ‰§è¡Œæµ‹é‡å·¥ä½œï¼ˆæ¯”å¦‚å±å¹•å®é™…å®½åº¦ä¸º100ï¼Œç³»ç»Ÿé¢„è®¾å®½åº¦ä¸º60ï¼Œæ–°çš„å®½åº¦ä¸º(100 + 60) / 2 = 80ï¼‰ ç¬¬äºŒæ¬¡æµ‹é‡å®Œæˆåï¼Œå¦‚æœæ‰©å®¹åçš„å®½åº¦å¤§å°ä»ç„¶ä¸æ»¡è¶³è¯¥è§†å›¾æœŸæœ›å€¼ï¼ŒAndroid ç³»ç»Ÿå°†ä¸å†å°è¯•å†æ¬¡æµ‹é‡ï¼Œç­‰å¾…ç¬¬ä¸‰æ¬¡çš„æœ€ç»ˆæµ‹é‡ ç¬¬ä¸‰æ¬¡æµ‹é‡æ‰§è¡Œä¹‹å‰ä¼šå…ˆåˆ¤æ–­ goodMeasure å˜é‡çš„å€¼ï¼Œåªæœ‰å½“ goodMeasure ä¸º false çš„æƒ…å†µä¸‹æ‰ä¼šæ‰§è¡Œæµ‹é‡ï¼Œä»€ä¹ˆæ—¶å€™å€¼ä¼šä¸º false å‘¢ï¼Ÿä¸¤ç§æƒ…å†µï¼ˆçœ‹ä»£ç æ³¨é‡Šå•Šå–‚ï¼‰ï¼š è§†å›¾æ˜¯æ™®é€šçš„ Activityï¼ŒDecorView å®½ä¸ä¸º WRAP_CONTENT çš„æƒ…å†µï¼Œé‚£ä¹ˆæ ‡è®°ä¸º3å·çš„ performMeasure() æ–¹æ³•å°†ä¼šè¢«æ‰§è¡Œï¼ˆç¬¬ä¸€æ¬¡è°ƒç”¨ï¼‰ è§†å›¾æ˜¯ Dialog ç±»å‹ï¼Œä¸” Dialog æƒ³è¦çš„å®½åº¦å¾ˆå¤§ï¼Œç³»ç»Ÿé¢„è®¾å®½åº¦ä¸æ»¡è¶³ï¼Œå†æ¬¡æ‰©å®¹ä»¥ååŒæ ·ä¸æ»¡è¶³ï¼Œé‚£ä¹ˆæ ‡è®°ä¸º3å·çš„ performMeasure() æ–¹æ³•å°†ä¼šè¢«æ‰§è¡Œï¼ˆç¬¬ä¸‰æ¬¡è°ƒç”¨ï¼‰ åœ¨æµ‹è¯•ä¸­æˆ‘å‘ç°å¦‚æœæŠŠ Activity è®¾ç½®ä¸º Dialog ä¸»é¢˜åï¼Œæ¯æ¬¡ requestLayout() éƒ½ä¼šæ‰§è¡Œ3æ¬¡ performTraversals() æ–¹æ³•ï¼Œå¯¼è‡´åŒä¸€ä¸ªè°ƒç”¨é“¾ä¹Ÿä¼šé‡å¤3éï¼Œå‘ç”Ÿè¿™ç§æƒ…å†µçš„åŸå› æˆ‘æš‚æ—¶ä¸æ¸…æ¥šï¼Œæœ‰äº†è§£è¿™å—çš„è€å“¥å¯ä»¥åœ¨è¯„è®ºåŒºç•™è¨€ æˆ‘ä»¬æŠŠæ•°æ®æ‰‹åŠ¨å»é‡ä»¥åï¼Œä¼šå‘ç°å»é‡åçš„è°ƒç”¨é“¾ä¼šå®Œå…¨ç¬¦åˆ measureHierarchy() æ–¹æ³•ä¸­çš„ä»£ç é€»è¾‘ 3ã€Window æƒé‡å¯¼è‡´å¤šæ¬¡è°ƒç”¨ åœ¨ ViewRootImpl çš„ performTraversals() æ–¹æ³•ä¸­ï¼Œè¿˜æœ‰ä¸€ç§ä¸æ€ä¹ˆå¸¸è§çš„åœºæ™¯åŒæ ·ä¼šè§¦å‘æ‰§è¡Œ onMeasure() æ–¹æ³•ï¼Œç›´æ¥æ¥çœ‹ä»£ç  /frameworks/base/core/java/android/view/ViewRootImpl.java class ViewRootImpl { void performTraversals() { if (lp.horizontalWeight/lp.verticalWeight &gt; 0.0f){///WindowManager.LayoutParamsä¸­çš„å‚ç›´/æ°´å¹³æ–¹å‘çš„æƒé‡æ˜¯å¦å¤§äº0ï¼Œè¿™ç©æ„ä¸çŸ¥é“åœ¨å“ªå¯ä»¥è®¾ç½® measureAgain = true; } if(measureAgain)performMeasure(); } } åœ¨ performTraversals() æ–¹æ³•ä¸­ï¼Œä¼šæ£€æŸ¥ WindowManager.LayoutParams æ˜¯å¦è®¾ç½®æƒé‡ï¼Œå¦‚æœè®¾ç½®äº†åˆ™ä¼šé‡æ–°æ‰§è¡Œä¸€æ¬¡æµ‹é‡ æˆ‘åœ¨æºç ä¸­å…¨å±€æœç´¢åï¼Œå‘ç°åªæœ‰ Toast ç±»ä¸­ä¼šè®¾ç½® horizontalWeight / verticalWeight å±æ€§ï¼Œå…·ä½“ä»£ç é€»è¾‘æˆ‘æ²¡æœ‰æ·±ç©¶ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·±ç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹æºç  åˆ°è¿™é‡Œï¼ŒViewRootImpl ç±»ä¸­æ‰€æœ‰å‘èµ·æµ‹é‡çš„åœ°æ–¹æˆ‘ä»¬éƒ½åˆ†æå®Œäº†ï¼ŒperformMeasure() æ–¹æ³•åœ¨æºç ä¸­ä¸€å…±æœ‰5å¤„è°ƒç”¨ å›¾ç‰‡æ¥æºï¼šè‡ªå·±æˆªå›¾ åœ¨ ViewRootImpl#measureHierarchy() æ–¹æ³•ä¸­è¢«è°ƒç”¨3æ¬¡ï¼š åœ¨1331è¡Œï¼Œè§†å›¾ä¸ºDialog ç±»å‹æ—¶ï¼Œå°†è§†å›¾å®½åº¦è®¾ç½®ä¸º Dialog é¢„ç½®å®½åº¦ï¼Œå‘èµ·é¦–æ¬¡æµ‹é‡ åœ¨1344è¡Œï¼Œè§†å›¾ä¸º Dialog ç±»å‹æ—¶ï¼Œé¢„ç½®å®½åº¦ä¸æ»¡è¶³è§†å›¾æœŸæœ›å€¼ï¼Œæ‰©å®¹å®½åº¦åå†æ¬¡å‘èµ·æµ‹é‡ åœ¨1358è¡Œï¼ŒgoodMeasure å˜é‡ä¸º false çš„æƒ…å†µä¸‹ï¼Œä¸¤ç§æƒ…å†µï¼š è¯¥è§†å›¾æ˜¯æ™®é€šçš„ Activityï¼Œå‘èµ·ç¬¬ä¸€æ¬¡æµ‹é‡ è¯¥è§†å›¾æ˜¯ Dialogï¼Œä¸” Dialog æƒ³è¦çš„å®½åº¦å¾ˆå¤§ï¼Œé¢„è®¾å®½åº¦å’Œæ‰©å®¹å®½åº¦å‡ä¸æ»¡è¶³ï¼Œç»™å®ƒå±å¹•å®é™…å°ºå¯¸å‘èµ·ç¬¬ä¸‰æ¬¡æµ‹é‡ åœ¨ ViewRootImpl#performTraversals() æ–¹æ³•ä¸­è¢«è°ƒç”¨äº†2æ¬¡ï¼š åœ¨2024è¡Œï¼Œæ¯æ¬¡ç”³è¯·åˆ° Surface ä»¥åï¼Œå‘èµ·ä¸€æ¬¡æµ‹é‡ åœ¨2050è¡Œï¼Œä¸º Window è®¾ç½®æƒé‡æ—¶ï¼Œå†æ¬¡å‘èµ·ä¸€æ¬¡æµ‹é‡ æ³¨ï¼šAndroid ä¸åŒç‰ˆæœ¬ä»£ç è¡Œæ•°ä¹Ÿä¸åŒï¼Œç¬”è€…æºç ç¯å¢ƒæ˜¯ï¼šAndroid 7.0 4ã€ç”± ViewGroup è‡ªèº«å‘èµ·è°ƒç”¨ é™¤äº† ViewRootImpl å…¥å£å¤„ä¼šå‘èµ·å¤šæ¬¡è°ƒç”¨å¤–ï¼Œå„ä¸ª ViewGroup è‡ªèº«çš„ä¸šåŠ¡é€»è¾‘åŒæ ·ä¼šå¯¼è‡´ View çš„ onMeasure() æ–¹æ³•è¢«å¤šæ¬¡è°ƒç”¨ è¿™éƒ¨åˆ†å†…å®¹æˆ‘ä»¬å¯ä»¥å»çœ‹ç¼˜ä½¬åœ¨ ç© Android æ¯æ—¥ä¸€é—® onMeasure()å¤šæ¬¡æ‰§è¡ŒåŸå› ï¼Ÿè¿™ä¸ªé—®é¢˜ä¸‹çš„å›ç­” æ¬ä¸€éƒ¨åˆ†ç¼˜ä½¬çš„å›ç­”ï¼šonMeasure æ–¹æ³•çš„å›è°ƒæ¬¡æ•°ï¼Œä¸»è¦å–å†³äºå®ƒæ‰€åœ¨çš„å®¹å™¨çš„ onMeasure é€»è¾‘ï¼Œæ­é…ä¸åŒ ViewGroup å’Œè®¾ç½®ä¸åŒå±æ€§éƒ½ä¼šæœ‰å½±å“ æ¯”å¦‚ LinearLayout åœ¨è®¾ç½®æƒé‡å±æ€§åå°±ä¼šå¤šæ‰§è¡Œä¸€æ¬¡æµ‹é‡æµç¨‹ï¼Œåœ¨æ•´ä¸ªæµ‹é‡è¿‡ç¨‹ä¸­ï¼ŒLinearLayout æœ€å°‘ä¼šç»å†1æ¬¡æµ‹é‡ï¼Œæœ€å¤šä¼šç»å†3æ¬¡ æ‰€ä»¥ç”± ViewGroup è‡ªèº«å‘èµ·è°ƒç”¨æ¬¡æ•°å¾ˆéš¾æœ‰ä¸€ä¸ªæ ‡å‡†ã€ç»Ÿä¸€çš„ç­”æ¡ˆï¼Œæˆ‘ä»¬è¿™é‡Œå°±ä¸å±•å¼€è®¨è®ºäº† äºŒã€å¸ƒå±€é˜¶æ®µ æœ€éš¾çš„æµ‹é‡ä»»åŠ¡åœ¨ä¸Šä¸€ç« èŠ‚å·²ç»ç»“æŸäº†ï¼Œæ¥ä¸‹æ¥çš„å†…å®¹ä¼šè½»æ¾å¾ˆå¤š å¦‚æœè¯´æµ‹é‡é˜¶æ®µçš„å­¦ä¹ éš¾åº¦æ˜¯100åˆ†çš„è¯ï¼Œé‚£å¸ƒå±€é˜¶æ®µå¯ä»¥ç›´æ¥é™ä¸€ä¸ªæ•°é‡çº§ï¼Œé™åˆ°10åˆ†ï¼ˆ10åˆ†æˆ‘éƒ½è§‰å¾—é«˜äº†ï¼‰ å¸ƒå±€é˜¶æ®µçš„ä»»åŠ¡é‡ä¸»è¦æ˜¯åœ¨ ViewGroup ä¸€ä¾§ï¼Œå­ View ä¸å‚ä¸å¸ƒå±€è¿‡ç¨‹ï¼Œçˆ¶è§†å›¾è´Ÿè´£æŠŠå­ View ä»¬æŒ‰ç…§LayoutParams è§„åˆ™æ‘†æ”¾å¥½ å›¾ç‰‡æ¥æºï¼šè‡ªå·±ç”»çš„ å†è°ˆ LayoutParams åœ¨ ViewGroup çš„æµ‹é‡é˜¶æ®µæˆ‘ä»¬è®¤è¯†äº† LayoutParams å’Œ MarginLayoutParamsï¼Œè¿™é‡Œå†æ¥ç®€å•å¤ä¹ ä¸€ä¸‹ï¼š LayoutParams æ˜¯ ViewGroup çš„å†…éƒ¨ç±»ï¼Œé‡Œé¢æœ‰ width / height ä¸¤ä¸ªå±æ€§ï¼Œç”¨æ¥æè¿°ä¸€ä¸ª View çš„å®½é«˜ MarginLayoutParams åŒæ ·æ˜¯ ViewGroup çš„å†…éƒ¨ç±»ï¼Œç»§æ‰¿è‡ªLayoutParamsï¼Œå¢åŠ äº†ä¸Šä¸‹å·¦å³å››ä¸ªæ–¹å‘çš„ margin å±æ€§ LayoutParams æ˜¯æ¯ä¸ª ViewGroup èƒ½å¤Ÿæ­£ç¡®æ‘†æ”¾å­è§†å›¾çš„é‡è¦ä¾æ®ï¼Œé™¤äº†Android ä¸º ViewGroup æä¾›çš„è¿™ä¸¤ä¸ªé»˜è®¤çš„ LayoutParams å¤–ï¼Œæ¯ä¸ª ViewGroup ä¹Ÿéƒ½ä¼šé‡å†™ä¸€ä¸ªå±äºè‡ªå·±çš„ LayoutParamsï¼š FrameLayout.LayoutParams ç»§æ‰¿è‡ª MarginLayoutParamsï¼Œåœ¨æ­¤åŸºç¡€ä¸Šå¢åŠ äº† gravity å±æ€§ LinearLayout.LayoutParams ç»§æ‰¿è‡ª MarginLayoutParamsï¼Œåœ¨æ­¤åŸºç¡€ä¸Šå¢åŠ äº† weightã€gravity ç­‰å±æ€§ RelativeLayout.LayoutParams ç»§æ‰¿è‡ª MarginLayoutParamsï¼Œåœ¨æ­¤åŸºç¡€ä¸Šå¢åŠ äº† aboveã€belowã€alignXxxã€toXxxOf ç­‰å±æ€§ GridLayout.LayoutParams ç»§æ‰¿è‡ª MarginLayoutParamsï¼Œåœ¨æ­¤åŸºç¡€ä¸Šå¢åŠ äº† rowã€columnã€gravity ç­‰å±æ€§ ä»å‡ ä¸ªå¸¸ç”¨å¸ƒå±€çš„ LayoutParams å¯ä»¥çœ‹åˆ°ï¼Œå‡¡æ˜¯æ”¯æŒè®¾ç½® margin å±æ€§çš„éƒ½ä¼šé€‰æ‹©ç»§æ‰¿è‡ª MarginLayoutParams æƒ³è¦äº†è§£æŸä¸ª ViewGroup æ”¯æŒå“ªäº›å±æ€§ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ xml å¸ƒå±€æ–‡ä»¶ä¸­ç›´æ¥ç‚¹å‡» layot_xx å±æ€§è·³è½¬åˆ° attrs.xml æ–‡ä»¶ï¼Œåœ¨ attrs.xml æ–‡ä»¶ä¸­ï¼Œä¿å­˜ç€æ‰€æœ‰ Android å®˜æ–¹æ§ä»¶æ”¯æŒçš„å±æ€§åˆ—è¡¨ ViewGroup çš„å¸ƒå±€è¿‡ç¨‹ layout() äº‹ä»¶çš„èµ·ç‚¹å’Œæµ‹é‡äº‹ä»¶ä¸€æ ·ï¼Œéƒ½åœ¨ ViewRootImpl ç±»ä¸­è§¦å‘ï¼Œå¸ƒå±€æµç¨‹æ‰§è¡Œçš„é¡ºåºä¹Ÿå’Œæµ‹é‡æµç¨‹ç›¸åŒï¼Œä»¥ DecorView ä½œä¸º View å¤šå‰æ ‘çš„æ ¹èŠ‚ç‚¹ï¼Œæ·±åº¦ä¼˜å…ˆéå†æ•´æ£µæ ‘ æ¥çœ‹å…¥å£å‡½æ•° /frameworks/base/core/java/android/view/ViewRootImpl.java class ViewRootImpl { void performTraversals() { if(å‘èµ·requestLayoutè¯·æ±‚){ performLayout(); } } void performLayout(){ mView.layout(mView.getMeasuredWidth(), mView.getMeasuredHeight());//ä»¥DecorViewçš„å®½é«˜ä½œä¸ºèµ·å§‹åæ ‡ } } ViewRootImpl ä¸­åˆ¤æ–­æ˜¯å¦æœ‰ä»»ä¸€ View å‘èµ·è¿‡ requestLayout() è¯·æ±‚ï¼Œæœ‰çš„è¯æ‰§è¡Œ performLayout() æ–¹æ³•ï¼Œä» DecorView å¼€å§‹å‘ä¸‹åˆ†å‘ layout() äº‹ä»¶ æ¥ç€çœ‹ ViewGroup ç±»æ”¶åˆ° layout() äº‹ä»¶åçš„å¤„ç†é€»è¾‘ /frameworks/base/core/java/android/view/ViewGroup.java class ViewGroup extends View { //View.javaä¸­çš„é€»è¾‘ï¼Œè¢«æˆ‘æŒªåˆ°è¿™äº† void layout(int l, int t, int r, int b){ setFrame(); if(è¯¥è§†å›¾æ‰§è¡Œäº†requestLayout()è¯·æ±‚ï¼Œæˆ–è€…è§†å›¾çš„ä½ç½®å‘ç”Ÿå˜åŒ–){ onLayout(); } } boolean setFrame(int left, int top, int right, int bottom) { //å¦‚æœè§†å›¾ä½ç½®å‘ç”Ÿå˜åŒ–ï¼Œä¿å­˜æ–°çš„ä¸Šä¸‹å·¦å³åæ ‡ç‚¹ä½ç½® } abstract void onLayout(boolean changed,int l, int t, int r, int b); } ViewRootImpl åœ¨å‘ä¸‹åˆ†å‘å¸ƒå±€äº‹ä»¶çš„è¿‡ç¨‹ä¸­ï¼Œä¼šé€šçŸ¥åˆ°æ¯ä¸ª View çš„ layout() æ–¹æ³•ï¼Œæ‰€ä»¥åœ¨ layout() æ–¹æ³•ä¸­ï¼Œä¼šå…ˆåˆ¤æ–­è‡ªå·±æœ‰æ²¡æœ‰å‘èµ·è¿‡ requestLayout() è¯·æ±‚ï¼Œæ²¡æœ‰å‘èµ·è¯·æ±‚è¯´æ˜ä¸éœ€è¦æ›´æ–°ï¼Œå°±ä¸æ‰§è¡Œ onLayout() æ–¹æ³•äº† å¦‚æœè‡ªå·±è°ƒç”¨è¿‡ requestLayout() è¯·æ±‚ï¼Œæˆ–è€…è§†å›¾çš„ä½ç½®å‘ç”Ÿå˜åŒ–ï¼Œä¼šå°†æ–°çš„ä½ç½®ä¿¡æ¯ä¿å­˜ä¸‹æ¥ï¼Œç„¶åè°ƒç”¨è‡ªèº«çš„ onLayout() æ–¹æ³•æ‰§è¡Œå¸ƒå±€ åœ¨ ViewGroup ä¸­ï¼ŒonLayout() æ–¹æ³•æ˜¯ç”± abstract å…³é”®å­—ä¿®é¥°çš„ç©ºæ–¹æ³•ï¼Œè¿™è¡¨ç¤º Android è¦æ±‚æ‰€æœ‰ç»§æ‰¿ ViewGroup çš„ç±»å¿…é¡»è‡ªè¡Œå®ç° onLayout() æ–¹æ³• åˆ°è¿™é‡Œï¼Œå¯¹äº Android ç³»ç»Ÿæ¥è¯´ï¼Œæ•´ä¸ªå¸ƒå±€æµç¨‹å·²ç»æ‰§è¡Œå®Œæˆäº†ï¼ˆå¼€å¤´è¯´çš„å¸ƒå±€å¾ˆç®€å•æ²¡éª—ä½ å§ï¼‰ï¼Œæ¥ä¸‹æ¥è°ƒç”¨çš„ onLayout() æ–¹æ³•æ˜¯å„ä¸ª ViewGroup è‡ªèº«çš„ä¸šåŠ¡é€»è¾‘ æ‰‹å†™ä¸€ä¸ªæ–œç€çš„çº¿æ€§å¸ƒå±€ å¸ƒå±€æµç¨‹è¿‡äºç®€å•ï¼Œæ¥ä¸‹æ¥æˆ‘å‡†å¤‡æ‰‹å†™ä¸€ä¸ªå¯ä»¥æ–œç€æ‘†æ”¾å­ View çš„ çº¿æ€§å¸ƒå±€ ï¼Œåœ¨ä¸€æ­¥æ­¥å®ç°åŠŸèƒ½çš„è¿‡ç¨‹ä¸­ç†è§£å¸ƒå±€é˜¶æ®µåœ¨ä¸‰éƒ¨æ›²ä¸­çš„æ„ä¹‰ å…ˆçœ‹æ•ˆæœ å›¾ç‰‡æ¥æºï¼šè‡ªå·±å½•çš„ åŠ¨å›¾æ¼”ç¤ºçš„æ˜¯ä¸€ä¸ªçºµå‘å±…ä¸­æ’åˆ—çš„ çº¿æ€§å¸ƒå±€ ï¼Œå®¹å™¨å†…åŒ…å«5ä¸ª TextView å’Œ 1ä¸ª ImageViewï¼Œç‚¹å‡»â€œ å¯ç”¨å€¾æ–œå±æ€§ â€æŒ‰é’®åï¼ŒViewGroup ä¼šæŒ‰ç…§ä¸€å®šçš„åç§»é‡é‡æ–°å¸ƒå±€ï¼ŒæŠŠå®¹å™¨å†…æ‰€æœ‰çš„å­ View ä»¥å·¦ä¸Šåˆ°å³ä¸‹å¯¹è§’çº¿çš„æ–¹å¼æ–œç€æ‘†æ”¾ SlantLinearLayout å®ç°çš„åŠŸèƒ½éå¸¸ç®€å•ï¼Œä»£ç é‡ä¹Ÿä¸å¤šï¼Œå…³é”®ä»£ç åªæœ‰3è¡Œï¼š class SlantLinearLayout extends LinearLayout { void onLayout(boolean changed, int l, int t, int r, int b) { for (int i = 0; i &lt; getChildCount(); i++) { int childLeft = (childSpace - childWidth) / 2;//æ ¹æ®çˆ¶è§†å›¾çš„paddingå’Œå­Viewçš„marginã€è‡ªèº«æµ‹é‡çš„å®½é«˜ï¼Œè®¡ç®—æ¯ä¸ªå­Viewèµ·å§‹ä½ç½® int childTop += lp.topMargin;//èµ·å§‹ä½ç½®åŠ ä¸Šå­Viewè®¾å®šçš„é¡¶éƒ¨è·ç¦» int childOffset = offset * i - (count - i - 1) * offset;//å¦‚æœç”¨æˆ·å¯ç”¨å€¾æ–œå±æ€§ï¼Œé‚£ä¹ˆè®¡ç®—æ¯ä¸ªå­Viewåœ¨åŸå…ˆçš„åŸºç¡€ä¸Šçš„åç§»é‡ child.layout(left, top, left + width, top + height);//é€šçŸ¥å­Viewæ‰§è¡Œå¸ƒå±€ } } } SlantLinearLayout çš„è‡ªèº«å®½é«˜å’Œå­ View ä»¬çš„å®½é«˜éƒ½åœ¨æµ‹é‡é˜¶æ®µå°±å·²ç»ç¡®å®šä¸‹æ¥äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥æ ¹æ®æµ‹é‡çš„ç»“æœæ¥è®¡ç®—æ¯ä¸ªå­ View æ‰€åœ¨çš„ä½ç½® childTop è¡¨ç¤ºæ¯ä¸ª View è·ç¦»é¡¶éƒ¨çš„å€¼ï¼Œç”±äºå®¹å™¨æ˜¯çºµå‘çš„çº¿æ€§æ’åˆ—ï¼Œæ‰€ä»¥åœ¨ç¡®å®šäº†ç¬¬ä¸€ä¸ªè·ç¦»é¡¶éƒ¨çš„é«˜åº¦åï¼Œæ¥ä¸‹æ¥æ¯æ¬¡ç´¯åŠ å­ View è‡ªèº«çš„é«˜åº¦ä½œä¸ºä¸‹ä¸€ä¸ªå­ View çš„èµ·å§‹é«˜åº¦å°±è¡Œäº† childLeft è¡¨ç¤ºæ¯ä¸ª View è·ç¦»å·¦è¾¹çš„å€¼ï¼Œç”±äºæ¯ä¸ª View å®½åº¦éƒ½ä¸ä¸€æ ·ï¼Œæ‰€ä»¥ childLeft è¦åŠ¨æ€è®¡ç®— childOffset è¡¨ç¤ºæ¯ä¸ª View è·ç¦»å·¦è¾¹çš„åç§»é‡ï¼Œå¦‚æœç”¨æˆ·å¯ç”¨å€¾æ–œå±æ€§ï¼Œé‚£ä¹ˆè®¡ç®—æ¯ä¸ªå­ View æ—¶éœ€è¦åœ¨åŸå…ˆçš„åŸºç¡€ä¸Šçš„åŠ ä¸Šè®¾å®šçš„åç§»é‡ SlantLinearLayout çš„å¸ƒå±€è¿‡ç¨‹å°±æ˜¯åœ¨ä¸åœçš„è®¡ç®—è¿™3ä¸ªå˜é‡çš„å€¼ï¼Œç„¶åè°ƒç”¨å­ View çš„ layout() æ–¹æ³•ï¼Œå°†è®¡ç®—å¾—åˆ°çš„ä¸Šä¸‹å·¦å³ä½ç½®ä¿¡æ¯ï¼ˆå±å¹•åæ ‡ç³»çš„ç»å¯¹å€¼ï¼‰ä¼ é€’ç»™å­ Viewï¼Œç‚¹å‡»[è¿™é‡Œ]æŸ¥çœ‹æºç  å¸ƒå±€é˜¶æ®µç»“æŸåï¼Œå¼€å‘è€…å¯ä»¥è°ƒç”¨ getWidth() / getHeight() æ–¹æ³•æ¥è·å–è§†å›¾çš„å®½é«˜ ä¸‰ã€ç»˜åˆ¶é˜¶æ®µ ç»˜åˆ¶æµç¨‹å’Œä¹‹å‰çš„æµ‹é‡/å¸ƒå±€ç›¸æ¯”ä¼šæ˜¾å¾—æœ‰äº›ç‰¹æ®Šï¼Œä½“ç°åœ¨ä¸¤ä¸ªæ–¹é¢ ä¸€æ˜¯ç»˜åˆ¶æµç¨‹æ‰§è¡Œçš„é¡ºåºï¼Œæµ‹é‡å’Œå¸ƒå±€é˜¶æ®µéƒ½æ˜¯å…ˆæ‰§è¡Œå­ View å†æ‰§è¡Œ ViewGroup è‡ªèº«ï¼Œè€Œç»˜åˆ¶æ˜¯å…ˆæ‰§è¡Œ ViewGroup ç»˜åˆ¶æµç¨‹ï¼Œå†æ‰§è¡Œå­ View çš„ç»˜åˆ¶æµç¨‹ äºŒæ˜¯ç»˜åˆ¶æµç¨‹æ¶‰åŠåˆ°å…¶ä»–ç¡¬ä»¶ï¼ˆGPUï¼‰ï¼Œå¯ç”¨ç¡¬ä»¶åŠ é€Ÿå’Œå…³é—­ç¡¬ä»¶åŠ é€Ÿæ–¹æ³•èµ°çš„æ˜¯ä¸¤æ¡å®Œå…¨ä¸åŒçš„è·¯çº¿ï¼Œè¿™å°±ä¼šå¯¼è‡´ç»˜åˆ¶é˜¶æ®µçš„è°ƒç”¨é“¾è¦æ›´å¤æ‚ä¸€äº›ï¼Œåœ¨åç»­åˆ†ææ–¹æ³•è°ƒç”¨çš„æ—¶å€™è¦æœ‰å¿ƒç†å‡†å¤‡ æŒ‰ç…§æƒ¯ä¾‹ï¼Œå…ˆæ¥çœ‹ç»˜åˆ¶æµç¨‹çš„å…¥å£ï¼š /frameworks/base/core/java/android/view/ViewRootImpl.java class ViewRootImpl { void performTraversals() { performDraw(); } void performDraw(){ draw(); } void draw() { if(æ˜¯å¦å¯ç”¨ç¡¬ä»¶ç»˜åˆ¶) ThreadedRenderer.draw(mView); else drawSoftware(); } } ä¾æ—§æ˜¯ ViewRootImpl ä½œä¸ºç»˜åˆ¶äº‹ä»¶çš„æœ€åˆå‘èµ·è€…ï¼Œç»è¿‡ performDraw() è½¬å‘åï¼Œæœ€ç»ˆç”± draw() æ¥æ‰§è¡Œç»˜åˆ¶äº‹ä»¶çš„åˆ†å‘ åœ¨ draw() æ–¹æ³•ä¸­ï¼Œå…ˆåˆ¤æ–­åº”ç”¨æ˜¯å¦äº†å¯ç”¨ç¡¬ä»¶åŠ é€Ÿï¼Œå¦‚æœå¯ç”¨ç¡¬ä»¶åŠ é€Ÿçš„è¯å°±èµ° ThreadedRenderer#draw() æ–¹æ³• å¦‚æœæ²¡æœ‰å¯ç”¨ç¡¬ä»¶åŠ é€Ÿï¼Œè°ƒç”¨ drawSoftware() æ–¹æ³•æ‰§è¡Œç»˜åˆ¶äº‹ä»¶åˆ†å‘ æˆ‘ä»¬å…ˆæ¥çœ‹æ²¡æœ‰å¯ç”¨ç¡¬ä»¶åŠ é€Ÿçš„æƒ…å†µ ViewGroup çš„ç»˜åˆ¶è¿‡ç¨‹ æœ¬ç« èŠ‚çš„å¼€å¤´å°±æåˆ°äº†ç»˜åˆ¶æµç¨‹çš„æ‰§è¡Œé¡ºåºé—®é¢˜ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±ä¸€èµ·æ¥çœ‹çœ‹ ViewGroup#draw() æ–¹æ³•çš„å®ç°ï¼Œä»æºç ä¸­æ‰¾ç­”æ¡ˆ /frameworks/base/core/java/android/view/ViewGroup.java class ViewGroup extends View { void draw(Canvas canvas) { drawBackground();//å…ˆç”»èƒŒæ™¯ onDraw(canvas);//ä¸ç®¡æ˜¯Viewè¿˜æ˜¯ViewGroupï¼Œå…ˆæŠŠè‡ªå·±ç”»å‡ºæ¥ dispatchDraw(canvas);//é€šçŸ¥å­è§†å›¾æ‰§è¡Œç»˜åˆ¶ï¼Œå¦‚æœæ˜¯è§†å›¾æ˜¯Viewï¼Œè¿™ä¸ªæ–¹æ³•é»˜è®¤ä¸ºç©ºï¼Œåªæœ‰ViewGroupæœ‰å®ç° onDrawForeground(canvas);//æœ€åç”»å‰æ™¯ } void dispatchDraw(){ for (int i = 0; i &lt; childrenCount; i++) { draw();//ç®€åŒ–è¿‡çš„è·¯å¾„ } } } ViewGroup ç»§æ‰¿è‡ª View ï¼Œæ‰€ä»¥æˆ‘æŠŠ View#draw() æ–¹æ³•ä¸­çš„é€»è¾‘æŒªåˆ°äº†åœ¨ ViewGroup ä¸­ï¼Œåœ¨ ViewGroup#draw() æ–¹æ³•ä¸­ä¸€å…±å®Œæˆäº†4ä»¶äº‹ï¼š è°ƒç”¨ drawBackground() æ–¹æ³•ç”» ViewGroup çš„èƒŒæ™¯ è°ƒç”¨è‡ªèº«çš„ onDraw() æ–¹æ³•æ‰§è¡Œ Canvas ç»˜å›¾é€»è¾‘ è°ƒç”¨ dispatchDraw() é€šçŸ¥å­ View æ‰§è¡Œ draw() è°ƒç”¨ onDrawForeground() æ–¹æ³•ç”»è§†å›¾çš„å‰æ™¯ ç¬¬1æ­¥å’Œç¬¬4æ­¥çš„ç”»èƒŒæ™¯/å‰æ™¯çš„æ–¹æ³•å®ç°æˆ‘ä»¬è¿™é‡Œå°±ä¸å±•å¼€äº†ï¼ˆä½†æ˜¯æ–¹æ³•æ‰§è¡Œé¡ºåºæˆ‘ä»¬ä¸€å®šè¦è®°ä½ï¼‰ï¼Œé‡ç‚¹å…³æ³¨ç¬¬2æ­¥å’Œç¬¬3æ­¥ åœ¨ç¬¬2æ­¥ä¸­ï¼ŒViewGroup ä¼šå…ˆæ‰§è¡Œè‡ªå·±çš„ onDraw() æ–¹æ³•æ‰§è¡Œç»˜å›¾ï¼Œä¹‹åæ‰ä¼šæ‰§è¡Œç¬¬3æ­¥è°ƒç”¨ dispatchDraw() æ–¹æ³•é€šçŸ¥å­ View æ‰§è¡Œç»˜åˆ¶æµç¨‹ åœ¨ Android ç³»ç»Ÿä¸­ï¼Œå…ˆç»˜åˆ¶çš„å†…å®¹ä¼šè¢«åç»˜åˆ¶çš„å†…å®¹è¦†ç›–æ‰ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è‡ªå®šä¹‰ View / ViewGroup çš„æ—¶ï¼Œäº†è§£ç»˜åˆ¶çš„å‰åè°ƒç”¨é¡ºåºéå¸¸é‡è¦ï¼ View çš„ç»˜åˆ¶è¿‡ç¨‹ View çš„ç»˜åˆ¶æµç¨‹å’Œ ViewGroup çš„ç»˜åˆ¶æµç¨‹å‡ ä¹ä¸€æ¨¡ä¸€æ ·ï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯ View ä¸­çš„ dispatchDraw() æ˜¯ç©ºå®ç°ï¼Œå› ä¸ºå®ƒæ²¡æœ‰å­è§†å›¾ /frameworks/base/core/java/android/view/View.java class View { void draw(Canvas canvas) { drawBackground();//å…ˆç”»èƒŒæ™¯ onDraw(canvas);//ä¸ç®¡æ˜¯Viewè¿˜æ˜¯ViewGroupï¼Œå…ˆæŠŠè‡ªå·±ç”»å‡ºæ¥ dispatchDraw(canvas);//ç©ºæ–¹æ³• onDrawForeground(canvas);//æœ€åç”»å‰æ™¯ } void dispatchDraw();//ç©ºæ–¹æ³• } View çš„ç»˜åˆ¶æµç¨‹å…¶å®ä¹Ÿæ˜¯è¿™4ä¸ªæ­¥éª¤ï¼Œåªä¸è¿‡ dispatchDraw() æ˜¯æ–¹æ³•ç½¢äº†ï¼Œæ²¡æœ‰å®é™…ä½œç”¨ åˆ°è¿™é‡Œï¼Œæ•´ä¸ªç»˜åˆ¶æµç¨‹å·²ç»æ‰§è¡Œå®Œæˆäº†ï¼Œæ¥ä¸‹æ¥è°ƒç”¨çš„ onDraw() æ–¹æ³•æ˜¯å„ä¸ª View è‡ªèº«çš„ä¸šåŠ¡é€»è¾‘ Android é€šå¸¸åœ¨ onDraw() æ–¹æ³•ä¸­ä¼šæ‰§è¡Œç»˜å›¾æ“ä½œï¼Œä½†å½“æˆ‘ä»¬é€‰æ‹©å¼€å¯ç¡¬ä»¶åŠ é€Ÿä¹‹åï¼Œå®é™…çš„ç»˜åˆ¶æ“ä½œå°±ä¸åœ¨ onDraw() æ–¹æ³•ä¸­æ‰§è¡Œäº†ï¼Œæ¥ç€å¾€ä¸‹çœ‹ å¯ç”¨ç¡¬ä»¶åŠ é€Ÿ Android 4.0 ä»¥åå¯¹æ‰€æœ‰åº”ç”¨ç¨‹åºéƒ½é»˜è®¤å¼€å¯ç¡¬ä»¶åŠ é€Ÿï¼Œå†åŠ ä¸Šç°åœ¨çš„ GPU é©±åŠ¨å¯¹ç»˜å›¾æŒ‡ä»¤æ”¯æŒçš„éå¸¸å…¨é¢ï¼Œæ‰€ä»¥ï¼Œåœ¨ç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œåº”ç”¨éƒ½æ˜¯èµ°ç¡¬ä»¶ç»˜åˆ¶è¿™æ¡è·¯çº¿çš„ å¯ç”¨ç¡¬ä»¶åŠ é€Ÿåï¼Œç»˜åˆ¶çš„å…¥å£å°±ä¼šå‘ç”Ÿå˜åŒ–ï¼Œä¸»è¦é€»è¾‘åœ¨ ThreadedRenderer ç±»ï¼Œå®ƒçš„ä»»åŠ¡æ˜¯æ”¶é›†å¼€å‘è€…åœ¨ onDraw() æ–¹æ³•ä¸­è°ƒç”¨çš„ç»˜åˆ¶æŒ‡ä»¤ï¼Œç„¶åå¯ç”¨ RenderThread çº¿ç¨‹ï¼Œåœ¨æ¸²æŸ“çº¿ç¨‹ä¸­å†è°ƒç”¨ GPU æ‰§è¡ŒçœŸæ­£çš„ç»˜å›¾æ“ä½œ /frameworks/base/core/java/android/view/ThreadedRenderer.java class ThreadedRenderer { void draw(DecorView view){ view.updateDisplayListIfDirty();//ç»è¿‡ç²¾ç®€åçš„æ–¹æ³•è°ƒç”¨ï¼Œç›´æ¥è°ƒç”¨Viewè®°å½•ç»˜å›¾æŒ‡ä»¤ int syncResult = nSyncAndDrawFrame();//åˆ‡æ¢åˆ°render thread æ‰§è¡ŒçœŸæ­£çš„ç»˜å›¾æŒ‡ä»¤ï¼ } } ThreadedRenderer ç±»ä¸­çš„ draw() æ–¹æ³•ä¸€å…±å®Œæˆäº†ä¸¤ä»¶äº‹ï¼š è°ƒç”¨ View çš„ updateDisplayListIfDirty() æ–¹æ³•ï¼Œæ”¶é›†ç»˜åˆ¶æŒ‡ä»¤ è°ƒç”¨ nSyncAndDrawFrame() æ–¹æ³•ï¼Œå°†ç»˜å›¾æŒ‡ä»¤åŒæ­¥ç»™ RenderThread çº¿ç¨‹å»æ‰§è¡Œ æ¸²æŸ“çº¿ç¨‹çš„ç»˜å›¾å·¥ä½œæˆ‘ä»¬æš‚æ—¶ä¸å…³å¿ƒï¼Œæœ¬å°èŠ‚æˆ‘ä»¬éœ€è¦äº†è§£çš„æ˜¯ View#updateDisplayListIfDirty() æ–¹æ³•æ˜¯å¦‚ä½•æ”¶é›†ç»˜åˆ¶æŒ‡ä»¤çš„ï¼Œæ¥çœ‹ View çš„æºç ï¼š /frameworks/base/core/java/android/view/View.java class View { RenderNode updateDisplayListIfDirty(){ RenderNode renderNode; DisplayListCanvas canvas = renderNode.start();//å¼€å§‹è®°å½•ç»˜åˆ¶èŠ‚ç‚¹ draw(canvas);//æ‰§è¡Œå¸¸è§„çš„drawé˜¶æ®µï¼Œæ³¨æ„è¿™é‡Œä½¿ç”¨çš„canvasç±»å‹æ˜¯DisplayListCanvas renderNode.end();//View æ ‘éå†å®Œæˆï¼Œç»“æŸè®°å½• return renderNode;//å°†è®°å½•çš„èŠ‚ç‚¹è¿”å›ç»™ ThreadedRenderer.java } } åœ¨ View çš„ updateDisplayListIfDirty() æ–¹æ³•ä¸­ï¼Œé¦–å…ˆè°ƒç”¨äº† RenderNode#start() æ–¹æ³•è·å–ä¸€ä¸ª DisplayListCanvas å¯¹è±¡ï¼Œå¹¶åŒæ—¶å¼€å§‹è®°å½•ç»˜åˆ¶æŒ‡ä»¤ æ¥ç€è°ƒç”¨ View è‡ªèº«çš„ draw() æ–¹æ³•æ‰§è¡Œå¸¸è§„çš„ç»˜åˆ¶æµç¨‹ï¼ˆæ³¨æ„è¿™é‡Œä½¿ç”¨çš„ Canvas ç±»å‹æ˜¯ DisplayListCanvasï¼‰ï¼Œdraw() æ–¹æ³•ç»“æŸä»¥åï¼Œå°†æ”¶é›†åˆ°çš„ç»˜å›¾æŒ‡ä»¤è¿”å›ç»™ ThreadedRenderer æ‰§è¡Œå®é™…çš„ç»˜å›¾æ“ä½œ å…¶ä¸­ï¼ŒDisplayListCanvas å¯¹è±¡æ˜¯ç¡¬ä»¶ç»˜åˆ¶ä¸­æœ€é‡è¦çš„çŸ¥è¯†ç‚¹ï¼ï¼ï¼æ³¨æ„çœ‹æ¥ä¸‹æ¥çš„åˆ†æ /frameworks/base/libs/hwui/DisplayListCanvas.cpp class DisplayListCanvas { //ä»¥ç”»åœˆæŒ‡ä»¤ä¸ºä¾‹ï¼Œå½“å¼€å‘è€…è°ƒç”¨Canvas.drawCircle()æ–¹æ³•ç»˜å›¾æ—¶ï¼Œè¿™ä¸ªæŒ‡ä»¤å®é™…ä¸Šè¢«è½¬å‘åˆ°addDrawOp()ä¿å­˜äº†èµ·æ¥ void DisplayListCanvas::drawCircle(float x, float y, float radius, const SkPaint&amp; paint) { addDrawOp(new (alloc()) DrawCircleOp(x, y, radius, refPaint(&amp;paint))); } size_t DisplayListCanvas::addDrawOp(DrawOp* op) { //ä¿å­˜æŒ‡ä»¤ï¼Œç­‰å¾…åˆ‡æ¢åˆ° RenderThread æ¸²æŸ“çº¿ç¨‹æ—¶å†å–å‡ºæ‰§è¡Œ } } DisplayListCanvas ç»§æ‰¿è‡ª Canvas ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ DisplayListCanvas è¿›è¡Œä¸€ç³»åˆ—ç»˜å›¾æ“ä½œæ—¶ï¼Œè¿™äº›ç»˜å›¾æŒ‡ä»¤ä¼šé€šè¿‡é‡å®šå‘çš„æ–¹å¼ä¿å­˜åˆ° DisplayList é›†åˆä¸­ï¼Œå¹¶ä¸ä¼šå®é™…æ‰§è¡Œ æ¯”å¦‚ä¸Šé¢çš„ä»£ç å—æ¼”ç¤ºäº†æ™®é€šçš„ç”»åœˆæŒ‡ä»¤ï¼Œå½“æˆ‘ä»¬è°ƒç”¨ Canvas#drawCircle() æ–¹æ³•ç”»åœˆæ—¶ï¼Œè¿™ä¸ªæŒ‡ä»¤å®é™…ä¸Šè¢«è½¬å‘åˆ° addDrawOp() æ–¹æ³•ä¿å­˜äº†èµ·æ¥ï¼Œç›´åˆ° ThreadedRenderer å¯¹è±¡è°ƒç”¨äº† nSyncAndDrawFrame() æ–¹æ³•åæ‰çœŸæ­£å¾—åˆ°æ‰§è¡Œ æ€»ç»“ä¸€ä¸‹ï¼Œåº”ç”¨å¯ç”¨ç¡¬ä»¶åŠ é€Ÿä»¥åï¼ŒonDraw() æ–¹æ³•ä¸­çš„æŒ‡ä»¤å°†ä¸å†è¢«æ‰§è¡Œï¼Œè€Œæ˜¯è¢«æ”¶é›†åˆ° DisplayList é›†åˆä¸­ï¼Œç­‰åˆ°æ‰€æœ‰éœ€è¦ç»˜åˆ¶çš„ View çš„ draw() æ–¹æ³•æ‰§è¡Œç»“æŸåï¼Œè¿™äº›æŒ‡ä»¤å°†ä¼šè¢«åŒæ­¥åˆ° RenderThread æ¸²æŸ“çº¿ç¨‹æ‰§è¡ŒçœŸæ­£çš„ç»˜å›¾å·¥ä½œ psï¼šå¯ç”¨ç¡¬ä»¶åŠ é€Ÿå’Œå…³é—­ç¡¬ä»¶åŠ é€Ÿå¯¹äºå¼€å‘è€…æ¥è¯´æ˜¯æ— æ„Ÿçš„ï¼ŒonDraw() æ–¹æ³•çš„æ”¶é›†å·¥ä½œä¾æ—§æ˜¯åœ¨ UI çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œä»£ç å†™çš„åƒè¯¥å¡è¿˜æ˜¯ä¼šå¡ å››ã€ç»“è¯­ æœ¬ç¯‡æ–‡ç« ä»‹ç»äº†è‡ªå®šä¹‰ View / ViewGroup æœ€é‡è¦çš„ä¸‰ä¸ªæµç¨‹ï¼šæµ‹é‡ã€å¸ƒå±€ã€ç»˜åˆ¶ å¯¹äºæµ‹é‡é˜¶æ®µï¼Œæˆ‘ä»¬éœ€è¦ç†è§£ä¸‰ç§ MeasureSpec çš„å«ä¹‰ã€ChildView MeasureSpec çš„é»˜è®¤ç”Ÿæˆè§„åˆ™ï¼Œä»¥åŠäº†è§£ onMeasure() æ–¹æ³•ä¼šæ‰§è¡Œå¤šæ¬¡çš„åŸå›  å¯¹äºå¸ƒå±€é˜¶æ®µï¼Œæˆ‘ä»¬éœ€è¦äº†è§£å¸ƒå±€é˜¶æ®µåœ¨æ•´ä¸ªç»˜åˆ¶æµç¨‹ä¸­çš„ä½œç”¨ä»¥åŠ LayoutParams å¯¹äº ViewGroup çš„æ„ä¹‰ å¯¹äºç»˜åˆ¶é˜¶æ®µï¼Œæˆ‘ä»¬éœ€è¦äº†è§£ View / ViewGroup çš„ç»˜åˆ¶é¡ºåºï¼Œä»¥åŠå½“åº”ç”¨å¯ç”¨ç¡¬ä»¶åŠ é€Ÿå Android ç³»ç»Ÿéƒ½åšäº†äº›ä»€ä¹ˆ æœ€åï¼Œè‡ªå®šä¹‰ View éœ€è¦æŒæ¡ä¸€äº›åŸºç¡€çš„ Canvas APIï¼Œå‡ºäºç¯‡å¹…è€ƒè™‘è¿™éƒ¨åˆ†å†…å®¹ä¸å†å±•å¼€è®¨è®ºï¼Œæœ‰éœ€è¦çš„åŒå­¦å¯ä»¥æŸ¥çœ‹ GcsSloop çš„[Androidè‡ªå®šä¹‰Viewç³»åˆ—]æ–‡ç«  æœ¬ç¯‡æ–‡ç« åˆ°è¿™é‡Œå°±å…¨éƒ¨ç»“æŸäº†ï¼Œå¸Œæœ›èƒ½å¯¹å¤§å®¶æœ‰å¸®åŠ© å…¨æ–‡å®Œ äº”ã€å‚è€ƒèµ„æ–™ ã€ŠAndroidå¼€å‘è‰ºæœ¯æ¢ç´¢ã€‹- ä»»ç‰åˆš Android measureè¿‡ç¨‹ - å´è¿ª Android Viewçš„ç»˜åˆ¶æµç¨‹ - Kelin Viewçš„æµ‹é‡å¸ƒå±€ç»˜åˆ¶è¿‡ç¨‹ - å¥”æ³¢å„¿çå–ç» ç©Android æ¯æ—¥ä¸€é—® | onMeasure()å¤šæ¬¡æ‰§è¡ŒåŸå› ï¼Ÿ ç©Android æ¯æ—¥ä¸€é—® è¯¦ç»†çš„æè¿°ä¸‹è‡ªå®šä¹‰ View æµ‹é‡æ—¶ MesureSpec.UNSPECIFIED ç©Android æ¯æ—¥ä¸€é—® | è‡ªå®šä¹‰æ§ä»¶æµ‹é‡æ¨¡å¼çœŸçš„å’Œ match_parentï¼Œwrap_content ä¸€ä¸€å¯¹åº”å—ï¼Ÿ ","link":"https://yibaoshan.github.io/post/android-graphics-application/"},{"title":"Androidå›¾å½¢ç³»ç»Ÿï¼ˆä¸‰ï¼‰ç³»ç»Ÿç¯‡ï¼šæ¸²æŸ“/åˆæˆçš„åº•å±‚åŸç†æµ…æ","content":" ç‚¹å‡»è·³è½¬åˆ°æ˜é‡‘é˜…è¯» å¯¹äºåº”ç”¨å¼€å‘å·¥ç¨‹å¸ˆæ¥è¯´ï¼Œè™½ç„¶æˆ‘ä»¬ä¸éœ€è¦å†™æ“ä½œç³»ç»Ÿä»£ç ï¼Œä½†æ˜¯äº†è§£Viewæœ€ç»ˆæ˜¯å¦‚ä½•æ˜¾ç¤ºåˆ°å±å¹•ä¸Šè¿˜æ˜¯éå¸¸æœ‰å¿…è¦çš„ æœ¬ç¯‡æ˜¯Androidå›¾å½¢ç³»åˆ—çš„ç¬¬ä¸‰ç¯‡æ–‡ç« ï¼Œåœ¨ä¹‹å‰çš„ä¸¤ç¯‡æ–‡ç« ä¸­åˆ†åˆ«ä»‹ç»äº†å±å¹•çš„â€œæ˜¾ç¤ºåŸç†â€å’Œå±å¹•çš„â€œåˆ·æ–°åŸç†â€ï¼Œä»Šå¤©æˆ‘ä»¬æ¥ä¸€èµ·å­¦ä¹ Androidç³»ç»Ÿçš„å›¾å½¢æ¶æ„è®¾è®¡ï¼ŒèŠä¸€èŠè¾“é€åˆ°å±å¹•çš„ç”»é¢æ•°æ®æ˜¯å¦‚ä½•äº§ç”Ÿçš„ æœ¬æ–‡çš„ç›®æ ‡æ˜¯å¸Œæœ›è¯»è€…æœ‹å‹å»ºç«‹ä¸€ä¸ªAndroidå›¾å½¢å­ç³»ç»Ÿçš„æ¡†æ¶ï¼Œå› æ­¤ï¼Œæ–‡ä¸­ä¸ä¼šåŒ…å«å¤ªå¤šçš„æ–¹æ³•è°ƒç”¨é“¾ä»¥åŠä»£ç é€»è¾‘ï¼ŒéAndroidå¼€å‘å·¥ç¨‹å¸ˆä¹Ÿå¯ä»¥æ”¾å¿ƒé£Ÿç”¨ å‰æ’æé†’ï¼šå…¨æ–‡è¿‘2ä¸‡å­—ï¼Œå»ºè®®é˜…è¯»æ—¶é•¿30åˆ†é’Ÿ ä¸€ã€å¼€ç¯‡ â€œå½“æˆ‘ä»¬ç‚¹å¼€â€˜å¾®ä¿¡â€™è¿™ä¸ªåº”ç”¨åï¼Œå®ƒæ˜¯æ€ä¹ˆåœ¨å±å¹•ä¸Šæ˜¾ç¤ºå‡ºæ¥çš„ï¼Ÿâ€ è¿™æ˜¯ä¸€ä¸ªéå¸¸å¤æ‚çš„é—®é¢˜ï¼Œå®ƒçš„èƒŒååŒ…å«äº†ç”±å‚å•†é©±åŠ¨ã€Linuxæ“ä½œç³»ç»Ÿã€HALç¡¬ä»¶æŠ½è±¡å±‚å’ŒAndroid Frameworkæ¡†æ¶å±‚å…±åŒç»„å»ºçš„ä¸€å¥—éå¸¸åºå¤§çš„Androidå›¾å½¢å­ç³»ç»Ÿ æƒ³è¦ç»™å‡ºè¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆï¼Œå°±å¿…é¡»å¯¹Androidå›¾å½¢å­ç³»ç»ŸèƒŒåçš„è¿è¡Œæµç¨‹æœ‰æ‰€äº†è§£ ä»Šå¤©ï¼Œæˆ‘ä»¬ä»è®¤è¯†Androidè®¾å¤‡ä¸­çš„ç¡¬ä»¶å¼€å§‹ï¼Œè‡ªä¸‹è€Œä¸Š ä¸€èµ·æ¥çœ‹çœ‹åºå¤§çš„Androidå›¾å½¢å­ç³»ç»Ÿæ˜¯å¦‚ä½•ç»„å»ºèµ·æ¥çš„ 1ã€ç¡¬ä»¶é©±åŠ¨ é›·æ€»æ›¾ç»è¯´è¿‡ï¼Œå†å¤æ‚çš„ç³»ç»Ÿè®¾è®¡ï¼Œä¹Ÿç¦»ä¸å¼€ç¡¬ä»¶çš„æ”¯æŒ åœ¨æ–‡ç« çš„å¼€å¤´ï¼Œæˆ‘ä»¬å°±å…ˆæ¥äº†è§£ä¸€ä¸‹ï¼šæ”¯æ’‘åº”ç”¨ç¨‹åºç»˜å›¾çš„ç¡¬ä»¶æœ‰å“ªäº›ï¼Ÿ å›¾ç‰‡æ¥æºï¼šhttps://www.ednchina.com/technews/12082_3.html ä¸Šå›¾æ˜¯ä¸€å¼ å°ç±³11çš„æ‹†è§£å›¾ ä»å·¦åˆ°å³åˆ†åˆ«æ˜¯ï¼šå±å¹•ã€ç›¸æœºæ¨¡ç»„ã€ä¸»æ¿ICä»¥åŠæ‰‹æœºå¤–å£³ å°ç±³11ä½¿ç”¨çš„æ˜¯é«˜é€šçš„â€éªé¾™888â€œå¤„ç†å™¨ï¼Œå†…å­˜ä½¿ç”¨çš„æ˜¯æ¥è‡ªé•å…‰çš„LPDDR5 8GBèŠ¯ç‰‡ï¼ˆä¸‹å›¾ä¸­1/2éƒ¨åˆ†ï¼Œå¤„ç†å™¨å’Œå†…å­˜ä½¿ç”¨å †å å°è£…ï¼Œä¿¯è§†å›¾å®ƒä¿©æ˜¯å åœ¨ä¸€èµ·çš„ï¼‰ å›¾ç‰‡æ¥æºï¼šhttps://www.laoyaoba.com/n/780219 å‰©ä¸‹æŒ‰åºå·åˆ†åˆ«æ˜¯ï¼šæµ·åŠ›å£«128GBé—ªå­˜èŠ¯ç‰‡ã€é«˜é€šçš„å°„é¢‘æ”¶å‘èŠ¯ç‰‡ã€é«˜é€šWiFi6/BTèŠ¯ç‰‡ã€ä¸¤é¢—é«˜é€šçš„å¿«å……èŠ¯ç‰‡ã€ä¼è¾¾çš„æ— çº¿å……ç”µèŠ¯ç‰‡ç­‰ç­‰ï¼Œå’Œæœ¬ç¯‡æ–‡ç« å…³ç³»ä¸å¤§ å›åˆ°å°ç±³11çš„SOCå¤„ç†å™¨éƒ¨åˆ†ï¼ˆå›¾1/2ï¼‰ é«˜é€šéªé¾™888ï¼ˆè§ä¸‹å›¾ï¼‰å†…éƒ¨é›†æˆäº†Kryo 680 CPUã€Adreno 660 GPUã€Spectra 580 ISPã€X60 5Gç­‰å¤šä¸ªå¤„ç†å™¨èŠ¯ç‰‡ å›¾ç‰‡æ¥æºï¼šhttps://www.dpreview.com/news/2969199244/qualcomm-snapdragon-888-soc åœ¨éªé¾™888å°è£…çš„ä¼—å¤šèŠ¯ç‰‡ä¸­ï¼ŒAdreno 660 GPUæ¨¡å—ï¼ˆè§ä¸‹å›¾ï¼‰æ˜¯æˆ‘ä»¬éœ€è¦å…³å¿ƒçš„é‡ç‚¹ å› ä¸ºå®ƒå°è£…äº†æˆ‘ä»¬åœ¨å›¾å½¢ç³»ç»Ÿä¸­ç»å¸¸ä½¿ç”¨åˆ°çš„ä¸¤å—èŠ¯ç‰‡ï¼š GPUï¼ˆGraphics Processing Unitï¼‰å’ŒDPUï¼ˆDisplay Processing Unitï¼‰ å›¾ç‰‡æ¥æºï¼šhttps://www.dpreview.com/news/2969199244/qualcomm-snapdragon-888-soc æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œä¸€å¹…å›¾åƒçš„æ˜¾ç¤ºå¿…é¡»è¦ç»è¿‡æ¸²æŸ“ã€åˆæˆã€é€æ˜¾è¿™ä¸‰ä¸ªé˜¶æ®µï¼Œæ‰èƒ½å±•ç°ç»™ç”¨æˆ· GPUå’ŒDPUå°±æ˜¯ç”¨äºæä¾›ç»™åº”ç”¨ç¨‹åºæ¸²æŸ“å’Œåˆæˆèƒ½åŠ›çš„ç¡¬ä»¶è®¾å¤‡ï¼Œå…¶ä¸­ï¼š GPUèŠ¯ç‰‡è´Ÿè´£æ‰§è¡Œå›¾å½¢æ˜¾ç¤ºæµç¨‹ä¸­çš„â€œæ¸²æŸ“â€å·¥ä½œ DPUèŠ¯ç‰‡è´Ÿè´£æ‰§è¡Œå›¾å½¢æ˜¾ç¤ºæµç¨‹ä¸­çš„â€œåˆæˆâ€å·¥ä½œ æ¥ä¸‹æ¥çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä»é©±åŠ¨ç¨‹åºçš„è§’åº¦æ¥èŠèŠä»€ä¹ˆæ˜¯æ¸²æŸ“ï¼Œä»¥åŠä»€ä¹ˆæ˜¯åˆæˆï¼Ÿ å›¾å½¢æ¸²æŸ“é©±åŠ¨ 1. ä»€ä¹ˆæ˜¯æ¸²æŸ“ ä¼—æ‰€å‘¨çŸ¥ï¼Œæ¸²æŸ“å·¥ä½œæ˜¯ç”±GPUè´Ÿè´£ï¼Œé‚£ä¹ˆåœ¨èŠGPUä¹‹å‰é¦–å…ˆå¾—çŸ¥é“ä»€ä¹ˆæ˜¯â€œæ¸²æŸ“â€ï¼Ÿæˆ‘ä»¬æ¥ä¸¾ä¸ªä¾‹å­æ„Ÿå—ä¸€ä¸‹ åœ¨ç³»ç»Ÿä¸­ç”³è¯·ä¸€å—10*10å¤§å°çš„å›¾å±‚å†…å­˜ï¼Œæ‰§è¡Œä¸‹åˆ—å‡ æ¡æŒ‡ä»¤ï¼š 1ã€æŠŠå›¾å±‚èƒŒæ™¯è¿™ç©æ„æŸ“æˆç»¿çš„ 2ã€ä»å·¦ä¸Šï¼ˆ0,0ï¼‰åˆ°å³ä¸‹ï¼ˆ10,10ï¼‰ç”»ä¸€æ¡å®½åº¦ä¸º1é¢œè‰²ä¸ºçº¢è‰²çš„ç›´çº¿ 3ã€ä»¥åæ ‡ç‚¹ï¼ˆ5,5ï¼‰ä¸ºä¸­å¿ƒï¼Œç”»ä¸€ä¸ªåŠå¾„ä¸º3çš„å®å¿ƒåœ†ï¼Œé¢œè‰²è¦è“è‰² å¥½äº†ï¼Œæ¥ä¸‹æ¥æ“ä½œç³»ç»Ÿä¼šæŠŠè¿™äº›â€œç»˜å›¾æŒ‡ä»¤â€åŒæ­¥ç»™GPUå»æ‰§è¡Œæ¸²æŸ“ä»»åŠ¡ å›¾ç‰‡æ¥æºï¼šè‡ªå·±ç”»çš„ GPUå®Œæˆæ¸²æŸ“å·¥ä½œåï¼Œæˆ‘ä»¬å°†ä¼šå¾—åˆ°ä¸€ä¸ªå¤§å°ä¸º10*10äºŒç»´æ•°ç»„ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½ä¿å­˜ç€åæ ‡ç‚¹çš„é¢œè‰²ä¿¡æ¯ã€æ·±åº¦ä¿¡æ¯ å¯¹åº”ç€å°†æ¥è¦æ˜¾ç¤ºåˆ°å±å¹•ä¸Šçš„ä¸€ä¸ªä¸ªåƒç´ ç‚¹ æŠŠç»˜å›¾æŒ‡ä»¤è½¬åŒ–ä¸ºäºŒç»´åƒç´ æ•°ç»„çš„è¿‡ç¨‹ï¼Œå°±å«åšâ€œæ¸²æŸ“â€ æœ¬ç« èŠ‚ä¸¾äº†ä¸€ä¸ªå¾ˆç®€å•çš„2Dç»˜å›¾çš„å°ä¾‹å­ï¼Œä¸»è¦ç›®çš„æ˜¯è®©æˆ‘ä»¬äº†è§£æ¸²æŸ“å·¥ä½œæ˜¯åšä»€ä¹ˆçš„ å›¾åƒæ¸²æŸ“æ˜¯ä¸€ä¸ªéå¸¸å¤æ‚çš„è¯é¢˜ï¼Œå…³äºæ¸²æŸ“å®ç°åŸç†å¯ä»¥ç‚¹å‡»[è¿™é‡Œ] 2. ä»€ä¹ˆæ˜¯GPU GPUå…¨ç§°æ˜¯GraphicProcessing Unitï¼Œä¸­æ–‡æ˜¯å›¾å½¢å¤„ç†å™¨ï¼Œå…¶æœ€å¤§çš„ä½œç”¨å°±æ˜¯è¿›è¡Œå„ç§ç»˜åˆ¶è®¡ç®—æœºå›¾å½¢æ‰€éœ€çš„è¿ç®—ï¼ŒåŒ…æ‹¬é¡¶ç‚¹è®¾ç½®ã€å…‰å½±ã€åƒç´ æ“ä½œç­‰ ä¹Ÿå°±æ˜¯ç”¨æ¥æ‰§è¡Œæˆ‘ä»¬å¼€å‘è€…è°ƒç”¨çš„ä¸€ä¸ªä¸ªçš„â€œç»˜å›¾æŒ‡ä»¤â€ æ‰€ä»¥ï¼ŒGPUå®é™…ä¸Šæ˜¯å¤šç»„å›¾å½¢å‡½æ•°APIçš„é›†åˆï¼Œè¿™äº›å‡½æ•°ç”±ç¡¬ä»¶é©±åŠ¨å®ç° ç¡¬ä»¶å‚å•†ä»¬éµå¾ªç€ä¸åŒåè®®çš„å¼€å‘è§„èŒƒï¼Œæ¯”å¦‚OpenGL ESã€Vulkanç­‰ç­‰ å›¾ç‰‡æ¥æºï¼šhttps://chiptechie.com/mobile-gpu/qualcomm-adreno-660/ ä¸Šå›¾æ˜¯Adreno 660 GPUçš„ä»‹ç»é¡µé¢ï¼Œå¯ä»¥çœ‹åˆ°å°ç±³11ä½¿ç”¨çš„è¿™å—èŠ¯ç‰‡æ”¯æŒOpenGL ES 3.2ç‰ˆæœ¬ã€OpenCL 2.0ç‰ˆæœ¬å’ŒVulkan 1.1ç‰ˆæœ¬ å¦å¤–ï¼Œ660è¿˜æ”¯æŒäº†å¾®è½¯å®¶çš„DirectXï¼Œè¿™å°±æ„å‘³ç€åœ¨å®‰è£…äº†Windows ARMç‰ˆçš„å°ç±³11ä¸­ï¼Œåº”ç”¨ç¨‹åºä¹Ÿå¯ä»¥ä½¿ç”¨éªé¾™GPUæ¥åŠ é€Ÿå›¾å½¢çš„æ¸²æŸ“ æ›´å¤šå…³äºGPUçš„ä»‹ç»è¯·ç‚¹å‡»[è¿™é‡Œ] å›¾å½¢åˆæˆé©±åŠ¨ å›¾å½¢æ¸²æŸ“é˜¶æ®µç»“æŸä»¥åï¼Œæ¥ä¸‹æ¥å°±åˆ°äº†å›¾å½¢çš„åˆæˆé˜¶æ®µ å›¾å½¢åˆæˆæˆ‘ä»¬å¯ä»¥ç®€å•ç†è§£ä¸ºPhotoshopä¸­çš„å›¾å±‚åˆæˆï¼š æ¯ä¸ªå›¾å±‚éƒ½æœ‰ä¸åŒçš„å†…å®¹ï¼Œç‚¹å‡»åˆå¹¶å›¾å±‚ä»¥åç”µè„‘ä¼šè®¡ç®—é‡å åŒºåŸŸçš„åƒç´ å˜åŒ–ï¼Œæœ€ç»ˆæŠŠå¤šä¸ªå›¾å±‚åˆå¹¶ä¸ºä¸€ä¸ªå›¾å±‚ è¿™ä¹ˆè¯´å¯èƒ½è¿˜æ˜¯æœ‰ç‚¹æŠ½è±¡ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥å¸®åŠ©ç†è§£ä»€ä¹ˆæ˜¯â€œåˆæˆâ€ï¼Ÿ 1. ä»€ä¹ˆæ˜¯åˆæˆ è¿™æ˜¯ä¸€å¼ launcheræ¡Œé¢çš„æˆªå±ï¼Œå®ƒæ˜¯ç”±â€œå£çº¸â€ã€â€œé¡¶éƒ¨çš„çŠ¶æ€æ â€ã€â€œæ¡Œé¢çš„åº”ç”¨åˆ—è¡¨â€ä»¥åŠâ€œåº•éƒ¨å¯¼èˆªæ â€è¿™4ä¸ªå›¾å±‚ç»„æˆ å›¾ç‰‡æ¥æºï¼šhttps://blog.zhoujinjian.cn/posts/20210810 1ã€å£çº¸å›¾å±‚ï¼š å›¾ç‰‡æ¥æºï¼šhttps://blog.zhoujinjian.cn/posts/20210810 2ã€é¡¶éƒ¨çŠ¶æ€æ å›¾å±‚ï¼ˆå¾ˆå°çš„ä¸€ä¸ªæ¨ªæ¡ï¼‰ï¼š å›¾ç‰‡æ¥æºï¼šhttps://blog.zhoujinjian.cn/posts/20210810 3ã€æ¡Œé¢åº”ç”¨åˆ—è¡¨ï¼š å›¾ç‰‡æ¥æºï¼šhttps://blog.zhoujinjian.cn/posts/20210810 4ã€åº•éƒ¨å¯¼èˆªæ ï¼š å›¾ç‰‡æ¥æºï¼šhttps://blog.zhoujinjian.cn/posts/20210810 è¿™å…¶ä¸­çš„æ¯ä¸ªå›¾å±‚ï¼Œéƒ½æ˜¯ç”±ä¸Šä¸€æ­¥çš„GPUæ¸²æŸ“å‡ºæ¥çš„çš„æˆæœ æ¯ä¸ªå›¾å±‚æ¸²æŸ“å®Œæˆä»¥åï¼Œç†è®ºä¸Šå¯ä»¥ç›´æ¥é€åˆ°å±å¹•ä¸Šå»æ˜¾ç¤ºäº†ï¼Œä½†æ˜¯ å¤§å¤šæ•°æƒ…å†µä¸‹å±å¹•ä¸Šéƒ½ä¸æ­¢ä¸€ä¸ªå›¾å±‚ ä¸€æ—¦å›¾å±‚ä¸å›¾å±‚ä¹‹é—´å‘ç”Ÿé‡å ï¼ˆæ¯”å¦‚launcherçš„çŠ¶æ€æ ã€åº”ç”¨åˆ—è¡¨å’Œå¯¼èˆªæ è¿™3ä¸ªå›¾å±‚éƒ½æ˜¯å åŠ åœ¨å£çº¸å›¾å±‚çš„ä¸Šé¢ï¼‰ï¼Œé‡å éƒ¨åˆ†çš„åƒç´ é¢œè‰²å°±éœ€è¦é‡æ–°è®¡ç®— å°†å¤šä¸ªå›¾å±‚åˆå¹¶æˆä¸€ä¸ªå›¾å±‚çš„è¿‡ç¨‹ï¼Œè¢«ç§°ä¸ºâ€œåˆæˆâ€ 2. ä»€ä¹ˆæ˜¯DPU åˆæˆå·¥ä½œçš„æœ¬è´¨æ˜¯æ‰§è¡Œè®¡ç®—â€œè„åŒºåŸŸâ€ã€æ ¼å¼è½¬æ¢ã€å¤„ç†ç¼©æ”¾ç­‰æ“ä½œï¼Œè¿™äº›ä»»åŠ¡æˆ‘ä»¬ä¹Ÿå¯ä»¥è°ƒç”¨GPUçš„æ¥å£æ¥å®Œæˆ å½“æˆ‘ä»¬è®¤çœŸè§‚å¯Ÿåˆæˆçš„æµç¨‹ä¼šå‘ç°ï¼Œåœ¨æ‰§è¡Œå›¾å±‚åˆæˆçš„è¿‡ç¨‹ä¸­æ˜¯ä¸éœ€è¦3Dæ“ä½œçš„ï¼Œå› ä¸ºæ—©åœ¨â€œå›¾å±‚æ¸²æŸ“â€é‚£ä¸€æ­¥GPUå°±å®Œæˆäº†æ‰€æœ‰çš„3Då¤„ç†çš„å·¥ä½œ è¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬åªéœ€è¦ä¸ºåˆæˆæµç¨‹å•ç‹¬é…ç½®ä¸€å—2Dæ¸²æŸ“å¼•æ“å°±OKäº† ç›®å‰åœ¨ç»å¤§å¤šæ•°Andoridè®¾å¤‡ä¸­ï¼Œæ‰¿æ‹…è¿™ä¸€è´£ä»»çš„å°±æ˜¯DPUèŠ¯ç‰‡äº† DPUä½œä¸ºå›¾å½¢ç¡¬ä»¶çš„ä¸€éƒ¨åˆ†ï¼Œé€šå¸¸è¢«å°è£…åœ¨GPUæ¨¡å—å½“ä¸­ï¼Œæœ€ä¸»è¦çš„åŠŸèƒ½æ˜¯å°†GPUæ¸²æŸ“å®Œæˆçš„å›¾å±‚è¾“å‡ºåˆ°å±å¹• å…¼ä»»äº†åˆæˆåŠŸèƒ½ä»¥åï¼Œå¯¹äºå›¾å±‚é‡å çš„éƒ¨åˆ†ï¼ŒDPUä¼šè‡ªåŠ¨è®¡ç®—å‡ºâ€œè„åŒºåŸŸâ€å¹¶æ›´æ–°åƒç´ é¢œè‰²å˜åŒ– ä¸è¿‡ï¼ŒDPUè™½ç„¶å¯ä»¥æ‰§è¡Œåˆæˆå·¥ä½œï¼Œä½†å®ƒæœ‰åˆæˆæ•°é‡çš„é™åˆ¶ å¦‚ä¸‹å›¾ï¼ŒArm Mali-DP550è¿™æ¬¾DPUæœ€å¤šèƒ½å¤Ÿæ”¯æŒ7å±‚çš„åˆæˆä»»åŠ¡ å›¾ç‰‡æ¥æºï¼šhttps://community.arm.com/cn/f/discussions/6104/arm-mali-gpu 3. ä»€ä¹ˆæ˜¯HWC ä¸Šä¸€èŠ‚èŠDPUçš„æ—¶å€™æˆ‘ä»¬æåˆ°äº†ï¼Œå¦‚æœæƒ³æŠŠåˆæˆæµç¨‹ç‹¬ç«‹å‡ºæ¥ï¼Œåªéœ€è¦å•ç‹¬é…ç½®ä¸€å—2Dæ¸²æŸ“èŠ¯ç‰‡å°±è¡Œäº† å‚å•†å¯ä»¥é€‰æ‹©å°†åˆæˆå·¥ä½œæ”¾åœ¨DPUä¸­ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©åœ¨æ¿å­ä¸ŠåŠ ä¸€å—2Dæ¸²æŸ“èŠ¯ç‰‡ï¼Œå°†åˆæˆå·¥ä½œæ”¾åœ¨è¿™å—èŠ¯ç‰‡ä¸­ æŠ é—¨ä¸€ç‚¹çš„å‚å•†ï¼Œå¯ä»¥é€‰æ‹©ä¸å•ç‹¬é…ç½®åˆæˆèŠ¯ç‰‡ï¼Œåªä½¿ç”¨GPUè¿›è¡Œåˆæˆ è¿™å°±éœ€è¦ä¸€ä¸ªè§„èŒƒæŠŠåˆæˆå·¥ä½œæŠ½è±¡æˆä¸€ä¸ªæ¥å£ï¼Œç”±å‚å•†è‡ªç”±é€‰æ‹©åˆæˆæ–¹æ¡ˆ Hardware Composerå°±æ˜¯ä¸“é—¨ç”¨æ¥å®šä¹‰åˆæˆå·¥ä½œçš„æŠ½è±¡æ¥å£ï¼Œå®ƒæ˜¯Android Hardware Abstraction Layerï¼ˆHALï¼‰ç¡¬ä»¶æŠ½è±¡å±‚çš„æˆå‘˜ä¹‹ä¸€ åœ¨HWCä¸­ï¼Œå‚å•†ä½¿ç”¨çš„æ˜¯DPUè¿˜æ˜¯å…¶ä»–çš„2Dæ¸²æŸ“èŠ¯ç‰‡ä¸é‡è¦ï¼Œåªéœ€è¦å®ç°HWCçš„æ¥å£å³å¯ æˆ‘ä»¬æ¥çœ‹Googleå®˜ç½‘å¯¹äºHWCçš„å®šä¹‰ï¼š å›¾ç‰‡æ¥æºï¼šhttps://source.android.com/devices/graphics/hwc ã€Šæ¯ä¸ªå­—éƒ½è®¤è¯†å°±æ˜¯ä¸çŸ¥é“åœ¨è¯´ä»€ä¹ˆã€‹ç³»åˆ—ï¼Œæˆ‘æŠŠè¿™æ®µè¯æŒ‰ç…§æ ‡å·ç¿»è¯‘ä¸€ä¸‹ï¼š ç”¨DPUåšåˆæˆæ¯”GPUè¦é«˜æ•ˆ ç¬¬äºŒç‚¹æ¯”è¾ƒé‡è¦ï¼Œé‡Œé¢åŒ…å«äº†hwcçš„æ‰§è¡Œé€»è¾‘ï¼Œå¤§è‡´æµç¨‹æ˜¯è¿™æ ·ï¼š sfè¿›ç¨‹ï¼šæœ‰6ä¸ªæ¸²æŸ“å¥½çš„å›¾å±‚è¿‡æ¥äº†ï¼Œæˆ‘å…¨éƒ¨å¡ç»™ä½ ï¼Œä½ è‡ªä¸ªå„¿å¤„ç†å®Œå»é€æ˜¾ï¼Ÿ hwcï¼šä¸è¡Œï¼Œæˆ‘æœ€å¤šåªèƒ½å¤„ç†4ä¸ªå›¾å±‚çš„åˆå¹¶å·¥ä½œï¼Œå‰©ä½™ä¸¤ä¸ªå›¾å±‚æˆ‘æ ‡è®°ä¸ºGPUåˆæˆäº†ï¼Œä½ å¤„ç†ä¸€ä¸‹ sfè¿›ç¨‹ï¼šè°ƒç”¨GPUå®Œæˆå¦å¤–2ä¸ªå›¾å±‚çš„åˆæˆå·¥ä½œï¼Œå¹¶å°†åˆå¹¶åçš„å›¾å±‚äº¤ç»™hwc ç¬¬ä¸‰ç‚¹æˆ‘ä¸æ˜¯å¾ˆç†è§£ä»€ä¹ˆæ„æ€ï¼Œå› ä¸ºç†è®ºä¸Šå¦‚æœå±å¹•å†…å®¹æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œsfä¸åº”è¯¥èµ°åˆæˆæµç¨‹ï¼Œ è¶…å‡ºhwcèƒ½åŠ›çš„å›¾å±‚ä¼šè°ƒç”¨GPUåˆæˆï¼Œå¦‚æœåº”ç”¨çš„å›¾å±‚å¤ªå¤šä¼šå¯¹æ€§èƒ½äº§ç”Ÿå½±å“ï¼Œæ¯”å¦‚APPå¼¹çª—è¿‡å¤šï¼Œæ¯ä¸ªDialogéƒ½ç®—ä¸€ä¸ªå›¾å±‚ å…³äºç¬¬äºŒç‚¹æˆ‘ä»¬å¯ä»¥ä½¿ç”¨adb shell dumpsys SurfaceFlingerå‘½ä»¤æŸ¥çœ‹å½“å‰å›¾å±‚çš„åˆæˆæ–¹å¼ï¼ŒDEVICEè¡¨ç¤ºHWCåˆæˆï¼ŒCLIENTè¡¨ç¤ºGPUåˆæˆ å›¾ç‰‡æ¥æºï¼šè‡ªå·±æˆªçš„ å¦å¤–ï¼Œå› ä¸ºç»å¤§å¤šæ•°æƒ…å†µä¸‹hwcçš„å®ç°è€…æ˜¯DPUï¼Œæ‰€ä»¥é™¤äº†åˆæˆå·¥ä½œå¤–ï¼Œhwcæ¨¡å—è¿˜è´Ÿè´£é€æ˜¾ä»¥åŠå‘é€VSyncä¿¡å· å¥½äº†ï¼Œhwcçš„éƒ¨åˆ†åˆ°è¿™é‡Œå…ˆå‘Šä¸€æ®µè½ï¼Œæˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹â€œç¡¬ä»¶é©±åŠ¨â€å°èŠ‚çš„å†…å®¹ æœ¬ç« èŠ‚çš„é‡ç‚¹æ˜¯äº†è§£ä»€ä¹ˆæ˜¯æ¸²æŸ“å’Œåˆæˆä»¥åŠæ¸²æŸ“/åˆæˆä½¿ç”¨çš„ç¡¬ä»¶è®¾å¤‡æ˜¯ä»€ä¹ˆï¼Œæ¸²æŸ“å’Œåˆæˆä¹‹é—´çš„åŒºåˆ«ï¼š æ¸²æŸ“ï¼Œå…³æ³¨çš„æ˜¯å•ä¸ªå›¾å±‚çš„å†…å®¹ï¼Œåœ¨å½“å‰å›¾å±‚çš„åæ ‡ç³»ä¸­ï¼Œæ¯ä¸ªåæ ‡ç‚¹åº”è¯¥æ˜¾ç¤ºä»€ä¹ˆé¢œè‰² åˆæˆï¼Œå…³æ³¨çš„æ˜¯å¤šä¸ªå›¾å±‚çš„å†…å®¹ï¼Œå°†å¤šä¸ªå›¾å±‚é‡æ–°è®¡ç®—åå¾—åˆ°ä¸€ä¸ªå›¾å±‚ï¼Œå‚è€ƒpsçš„åˆå¹¶å›¾å±‚åŠŸèƒ½ æ¸²æŸ“ã€åˆæˆè¿™ä¸¤ä¸ªé˜¶æ®µæ‰€éœ€çš„ç¡¬ä»¶éƒ¨åˆ†å·²ç»ä»‹ç»å®Œæˆï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¸€èµ·çœ‹çœ‹Googleä¸ºå›¾å½¢ç³»ç»Ÿå‡†å¤‡äº†å“ªäº›è½¯ä»¶ç»„ä»¶åº“ 2ã€Googleç»„ä»¶åº“ Andoridæä¾›çš„ä½çº§åˆ«ç»„ä»¶åº“æ›´å¤šæ˜¯æ§åˆ¶å›¾å½¢å†…å­˜çš„æµç¨‹ä»¥åŠå†…å­˜ç»“æ„çš„å°è£… æ¯”å¦‚CPUã€GPUå’ŒHWCè¦å…±äº«åŒä¸€å—å†…å­˜ï¼Œé‚£å°±éœ€è¦ä¸€ç§æ ¼å¼è®©å®ƒä»¬éƒ½èƒ½è¯†åˆ«è¿™å—å†…å­˜ å¦å¤–ï¼Œè¿˜éœ€è¦ä¸€ç§æœºåˆ¶ä¿è¯æ•°æ®çš„å®‰å…¨ï¼Œé˜²æ­¢å‘ç”ŸæŸä¸ªç¡¬ä»¶åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­æ•°æ®è¢«å…¶ä»–ç¡¬ä»¶ç¯¡æ”¹çš„æƒ…å†µ å›¾å½¢ç³»ç»Ÿä¸­åŒ…å«äº†[libui.so]å’Œ[libgui.so]ä¸¤ä¸ªä½çº§åˆ«ç»„ä»¶åº“ï¼Œæ¥ä¸‹æ¥ä¸€èµ·æ¥çœ‹çœ‹è¿™ä¸¤ä¸ªåº“é‡Œé¢åˆ†åˆ«æœ‰ä»€ä¹ˆ libuiç»„ä»¶åº“ 1. ä»€ä¹ˆæ˜¯GraphicBuffer GraphicBufferæ˜¯æ•´ä¸ªå›¾å½¢ç³»ç»Ÿçš„æ ¸å¿ƒï¼Œæ‰€ä»¥çš„æ¸²æŸ“æ“ä½œéƒ½å°†åœ¨æ­¤å¯¹è±¡ä¸Šè¿›è¡Œï¼ŒåŒ…æ‹¬åŒæ­¥ç»™GPUå’ŒHWC æ¯å½“åº”ç”¨æœ‰æ˜¾ç¤ºéœ€æ±‚æ—¶ï¼Œåº”ç”¨ä¼šå‘ç³»ç»Ÿç”³è¯·ä¸€å—GraphicBufferå†…å­˜ï¼Œè¿™å—å†…å­˜å°†ä¼šå…±äº«ç»™GPUç”¨äºæ‰§è¡Œæ¸²æŸ“å·¥ä½œï¼Œæ¥ç€ä¼šåŒæ­¥ç»™HWCç”¨äºåˆæˆå’Œæ˜¾ç¤º æˆ‘ä»¬å¯ä»¥æŠŠæ¯ä¸€ä¸ªGraphicBufferå¯¹è±¡çœ‹åšæ˜¯ä¸€ä¸ªä¸ªæ¸²æŸ“å®Œæˆçš„å›¾å±‚ï¼Œå¯¹åº”1.1.2.1å°èŠ‚ä¸­Launcherçš„å„ä¸ªå›¾å±‚ æ›´å¤šå…³äºGraphicBufferçš„ä»‹ç»è¯·ç‚¹å‡»[è¿™é‡Œ] 2. ä»€ä¹ˆæ˜¯Fenceæœºåˆ¶ ä¸€ä¸ªGraphicBufferå¯¹è±¡å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸå¤§æ¦‚æ˜¯è¿™æ ·ï¼š æ¸²æŸ“é˜¶æ®µï¼šåº”ç”¨æœ‰ç»˜å›¾éœ€æ±‚äº†ï¼Œç”±GPUåˆ†é…ä¸€å—å†…å­˜ç»™åº”ç”¨ï¼Œåº”ç”¨è°ƒç”¨GPUæ‰§è¡Œç»˜å›¾ï¼Œæ­¤æ—¶ä½¿ç”¨è€…æ˜¯GPU åˆæˆé˜¶æ®µï¼šGPUæ¸²æŸ“å®Œæˆåå°†å›¾å±‚ä¼ é€’ç»™sfè¿›ç¨‹ï¼Œsfè¿›ç¨‹å†³å®šç”±è°æ¥åˆæˆï¼Œhwcæˆ–è€…GPU å¦‚æœä½¿ç”¨GPUåˆæˆï¼Œé‚£ä¹ˆæ­¤æ—¶bufferçš„ä½¿ç”¨è€…ä¾æ—§æ˜¯GPU å¦‚æœä½¿ç”¨hwcåˆæˆï¼Œé‚£ä¹ˆæ­¤æ—¶bufferçš„ä½¿ç”¨è€…æ˜¯hwc æ˜¾ç¤ºé˜¶æ®µï¼šæ‰€æœ‰çš„bufferåœ¨æ­¤é˜¶æ®µçš„ä½¿ç”¨è€…éƒ½æ˜¯hwcï¼Œå› ä¸ºhwcæ§åˆ¶ç€æ˜¾ç¤ºèŠ¯ç‰‡ ä»ç”Ÿå‘½å‘¨æœŸå¯ä»¥çœ‹å‡ºGraphicBufferå¯¹è±¡åœ¨æµè½¬çš„è¿‡ç¨‹ä¸­ï¼Œä¼šè¢«GPUã€CPUã€DPUä¸‰ä¸ªä¸åŒçš„ç¡¬ä»¶è®¿é—® å¦‚æœåŒä¸€å—å†…å­˜èƒ½å¤Ÿè¢«å¤šä¸ªç¡¬ä»¶è®¾å¤‡è®¿é—®ï¼Œå°±éœ€è¦ä¸€ä¸ªåŒæ­¥æœºåˆ¶ åœ¨Androidå›¾å½¢ç³»ç»Ÿä¸­ï¼ŒFenceæœºåˆ¶å°±æ˜¯ç”¨æ¥ä¿è¯è·¨ç¡¬ä»¶è®¿é—®æ—¶çš„æ•°æ®å®‰å…¨ Fenceçš„åº•å±‚é€»è¾‘å¯ä»¥å‚è€ƒJavaçš„synchronizedäº’æ–¥é”æœºåˆ¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠFenceç†è§£ä¸ºä¸€æŠŠç¡¬ä»¶çš„äº’æ–¥é” æ¯ä¸ªéœ€è¦è®¿é—®GraphicBufferçš„è§’è‰²ï¼Œåœ¨ä½¿ç”¨å‰éƒ½è¦æ£€æŸ¥è¿™æŠŠé”æ˜¯å¦signaledäº†æ‰èƒ½è¿›è¡Œå®‰å…¨çš„æ“ä½œï¼Œå¦åˆ™å°±è¦ç­‰å¾… activeçŠ¶æ€ï¼Œè¯¥GraphicBufferæ­£åœ¨è¢«å ç”¨ signaledçŠ¶æ€ï¼Œè¡¨æ˜ä¸å†æ§åˆ¶buffer æ›´å¤šå…³äºFenceåŒæ­¥æœºåˆ¶çš„ä»‹ç»è¯·ç‚¹å‡»[è¿™é‡Œ] 3. ä»€ä¹ˆæ˜¯Gralloc ç§»åŠ¨è®¾å¤‡çš„å†…éƒ¨ç©ºé—´å¯¸åœŸå¯¸é‡‘ï¼Œä¸å¤ªå¯èƒ½åƒPCä¸€æ ·ç»™GPUå•ç‹¬é…ä¸ªæ˜¾å­˜ï¼Œå› æ­¤ç§»åŠ¨ç«¯çš„&quot;å›¾å½¢å†…å­˜&quot;éƒ½è¢«åˆ†é…åœ¨è¿è¡Œå†…å­˜ä¸­ ä¸ºäº†é˜²æ­¢å›¾å½¢å†…å­˜è¢«æ»¥ç”¨ï¼ŒAndroidæŠ½è±¡å‡ºGrallocæ¨¡å—ï¼Œè§„å®šäº†æ‰€æœ‰å›¾å½¢å†…å­˜çš„ç”³è¯·ä¸é‡Šæ”¾éƒ½éœ€è¦é€šè¿‡è¯¥æ¨¡å—æ¥æ“ä½œï¼Œä»¥æ­¤æ¥è§„èŒƒå›¾å½¢å†…å­˜çš„ä½¿ç”¨ æ›´å¤šå…³äºGrallocæœºåˆ¶çš„ä»‹ç»è¯·ç‚¹å‡»[è¿™é‡Œ] æ³¨æ„ï¼šFenceæœºåˆ¶å’ŒGrallocæœºåˆ¶å¹¶ä¸å±äºlibuiç»„ä»¶åº“ï¼ŒæŠŠå®ƒä¿©æ”¾åˆ°libuiåº“å±•ç¤ºæ˜¯å› ä¸ºGraphicBufferéœ€è¦å®ƒä»¬ libguiç»„ä»¶åº“ ä¿—è¯è¯´ï¼Œè¶Šæ¥è¿‘ä¸Šå±‚ä¸šåŠ¡è®¾è®¡ä¸Šå°±è¶Šå¤æ‚ libguiåº“è™½è¯´è¿˜æ²¡åˆ°ä¸šåŠ¡å±‚ï¼Œä½†å®ƒé‡Œé¢çš„ç»„ä»¶å¤§å¤šæ˜¯å¯¹GraphicBufferå¯¹è±¡çš„å°è£…ï¼Œä»¥æ»¡è¶³ä¸åŒçš„ä¸šåŠ¡éœ€æ±‚ 1. ä»€ä¹ˆæ˜¯BufferQueue åœ¨Android 4.1ï¼ˆProject Butterï¼‰ä¸­å¼•å…¥äº†BufferQueueï¼Œå®ƒæ˜¯é»„æ²¹è®¡åˆ’ä¸­â€œTriple Bufferâ€çš„æ‰§è¡Œè€… é»„æ²¹è®¡åˆ’çš„é‡ç‚¹æ˜¯â€œDrawing with VSyncâ€ï¼Œä¹Ÿå°±æ˜¯æŠŠVSyncä¿¡å·åŒæ­¥ç»™APPè¿›ç¨‹ è¿™æ ·åšçš„ç›®çš„æ˜¯å°†æ¸²æŸ“å’Œåˆæˆåˆ†æˆä¸¤æ­¥æ¥æ‰§è¡Œï¼Œå‡å°‘ä¸€ä¸ªVSyncå‘¨æœŸå†…çš„ä»»åŠ¡é‡ï¼Œä»¥é™ä½ä¸¢å¸§å‘ç”Ÿçš„æ¦‚ç‡ å›åˆ°æœ¬ç« èŠ‚çš„ä¸»é¢˜ï¼šBufferQueue ä»åç§°å°±å¯ä»¥çœ‹å‡ºæ¥ï¼Œå®ƒæ˜¯ä¸€ä¸ªå°è£…äº†GraphicBufferçš„é˜Ÿåˆ—ï¼ŒBufferQueueå¯¹å¤–æä¾›äº†GraphicBufferå¯¹è±¡å‡ºåˆ—/å…¥åˆ—çš„æ¥å£ å¦å¤–ï¼ŒBufferQueueè¿˜ä¸ºæ¯ä¸ªGraphicBufferå¯¹è±¡åŒ…è£…äº†å‡ ç§ä¸åŒçš„çŠ¶æ€ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ï¼š FREEï¼šé—²ç½®çŠ¶æ€ï¼Œä»»ä½•è¿›ç¨‹éƒ½å¯ä»¥è·å–è¯¥bufferè¿›è¡Œæ“ä½œï¼Œé€šå¸¸è¡¨ç¤ºä¸ºAPPè¿›ç¨‹å¯ä»¥ç”³è¯·ä½¿ç”¨çš„å†…å­˜ DEQUEUEDï¼šå‡ºåˆ—çŠ¶æ€ï¼Œé€šå¸¸æ˜¯APPè¿›ç¨‹åœ¨ç»˜å›¾ï¼Œä½¿ç”¨è€…æ˜¯GPU QUEUEDï¼šå…¥åˆ—çŠ¶æ€ï¼Œè¡¨ç¤ºAPPç»˜å›¾å·²ç»å®Œæˆï¼Œç­‰å¾…ä»é˜Ÿåˆ—å–å‡ºæ‰§è¡Œä¸‹ä¸€æ­¥åˆæˆï¼Œæ²¡æœ‰ä½¿ç”¨è€… ACQUIREDï¼šé”å®šçŠ¶æ€ï¼Œé€šå¸¸è¡¨ç¤ºsfè¿›ç¨‹ä»é˜Ÿåˆ—å–å‡ºï¼Œæ­£åœ¨åšåˆæˆå·¥ä½œï¼Œæ­¤æ—¶ä½¿ç”¨è€…å¯èƒ½æ˜¯hwcä¹Ÿæœ‰å¯èƒ½æ˜¯GPU SHAREDï¼šå…±äº«çŠ¶æ€ï¼Œ7.0ç‰ˆæœ¬åŠ å…¥çš„æ–°çŠ¶æ€ï¼Œæ²¡æ‰¾åˆ°ç›¸å…³ä»‹ç»èµ„æ–™ï¼Œåˆæˆå·¥ä½œå®Œæˆä»¥åå…±äº«ç»™å½•å±è½¯ä»¶ï¼Ÿ è®¾è®¡ä¸Šï¼ŒBufferQueueä½¿ç”¨äº†[ç”Ÿäº§è€…/æ¶ˆè´¹è€…æ¨¡å¼]ï¼Œç»å¤§å¤šæ•°çš„æƒ…å†µä¸‹ï¼ŒAPPä½œä¸ºGraphicBufferçš„ç”Ÿäº§è€…ï¼Œsfè¿›ç¨‹ä½œä¸ºGraphicBufferçš„æ¶ˆè´¹è€…ï¼Œå®ƒä»¬ä¿©å…±åŒæ“ä½œä¸€ä¸ªbufferé˜Ÿåˆ— ç®€å•æè¿°ä¸€ä¸‹ç”Ÿäº§è€…æ¶ˆè´¹è€…æ“ä½œé˜Ÿåˆ—æ—¶çŠ¶æ€è½¬æ¢çš„è¿‡ç¨‹ï¼š ç”Ÿäº§è€…ï¼šAPPè¿›ç¨‹ 1ã€producer-&gt;dequeueBuffer() â€‹ ä»é˜Ÿåˆ—å–å‡ºä¸€ä¸ªçŠ¶æ€ä¸ºâ€œFREEâ€çš„bufferï¼Œæ­¤æ—¶è¯¥bufferçŠ¶æ€å˜åŒ–ä¸ºï¼šFREE-&gt;DEQUEUED 2ã€producer-&gt;queueBuffer() â€‹ å°†æ¸²æŸ“å®Œæˆçš„bufferå…¥åˆ—ï¼Œæ­¤æ—¶è¯¥bufferçŠ¶æ€å˜åŒ–ä¸ºï¼šDEQUEUED-&gt;QUEUED æ¶ˆè´¹è€…ï¼šsfè¿›ç¨‹ 1ã€consumer-&gt;acquireBuffer() â€‹ ä»é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªçŠ¶æ€ä¸ºâ€œQUEUEDâ€çš„æ¸²æŸ“å®Œçš„bufferå‡†å¤‡å»åˆæˆé€æ˜¾ï¼Œæ­¤æ—¶è¯¥bufferçš„çŠ¶æ€å˜åŒ–ä¸ºï¼šQUEUED-&gt;ACQUIRED 2ã€consumer-&gt;releaseBuffer() â€‹ bufferå†…å®¹å·²ç»æ˜¾ç¤ºè¿‡äº†ï¼Œå¯ä»¥é‡æ–°å…¥åˆ—ç»™APPä½¿ç”¨äº†ï¼Œæ­¤æ—¶è¯¥bufferçš„çŠ¶æ€å˜åŒ–ä¸ºï¼šACQUIRED-&gt;FREE æ¯ä¸ªBufferçš„ä¸€ç”Ÿï¼Œå°±æ˜¯åœ¨ä¸æ–­åœ°å¾ªç¯FREE-&gt;DEQUEUED-&gt;QUEUED-&gt;ACQUIRED-&gt;FREEè¿™ä¸ªè¿‡ç¨‹ï¼Œè¿™ä¸­é—´æœ‰ä»»ä½•ä¸€ä¸ªç¯èŠ‚å‡ºç°å»¶è¿Ÿï¼Œååº”åˆ°å±å¹•ä¸Šå°±æ˜¯åº”ç”¨å‡ºç°äº†å¡é¡¿ æ›´å¤šå…³äºBufferQueueçš„ä»‹ç»è¯·ç‚¹å‡»[è¿™é‡Œ] è¯´æ˜ï¼šBufferQueueæ ¸å¿ƒä»£ç ç”±BufferQueueCoreã€BufferQueueProducerã€BufferQueueConsumerè¿™3ä¸ªç±»ç»„æˆ ä¸ºäº†é¿å…å¼•å…¥è¿‡å¤šçš„è§’è‰²å¯¼è‡´æ–‡ç« çš„é˜…è¯»ä½“éªŒä¸‹é™ï¼Œåœ¨åç»­çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä¼šå°†è¿™å‡ ä¸ªç±»ç»Ÿç§°ä¸ºBufferQueueï¼ŒåŒ…æ‹¬æ¥ä¸‹æ¥ä¼šå‡ºç°çš„Surfaceã€EventThreadéƒ½æ˜¯å¦‚æ­¤ï¼Œåªä¿ç•™ä¸»å¹² 2. ä»€ä¹ˆæ˜¯Surface åœ¨ä»‹ç»libuiåº“çš„æ—¶ï¼Œæˆ‘ä»¬æåˆ°äº†GraphicBufferæ˜¯æ•´ä¸ªå›¾å½¢ç³»ç»Ÿçš„æ ¸å¿ƒ ä½†å¯¹äºå¼€å‘è€…æ¥è¯´ï¼Œå°¤å…¶æ˜¯åº”ç”¨å¼€å‘è€…ï¼ŒSurfaceæ‰æ˜¯æˆ‘ä»¬çœ‹å¾—è§æ‘¸å¾—ç€çš„æ ¸å¿ƒç±»ï¼Œåº”ç”¨ä¸­æ‰€æœ‰çš„ç»˜å›¾æ“ä½œæœ€ç»ˆéƒ½æ˜¯åœ¨Surfaceä¸­æ‰§è¡Œçš„ Surfaceä½œä¸ºå›¾åƒçš„ç”Ÿäº§è€…ï¼ŒæŒæœ‰BufferQueueçš„å¼•ç”¨ï¼Œå¹¶ä¸”å°è£…äº†å‡ºåˆ—å’Œå…¥åˆ—ä¸¤ä¸ªæ–¹æ³• æ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥äº†è§£ä¸‹æ—¥å¸¸å¼€å‘ä¸­æ˜¯å¦‚ä½•è°ƒç”¨åˆ°BufferQueueçš„ï¼š æˆ‘ä»¬éƒ½çŸ¥é“Androidæ”¯æŒ2Dç»˜å›¾ï¼ŒAPIä½¿ç”¨çš„æ˜¯[Canvas]ï¼Œä¹Ÿæ”¯æŒ3Dç»˜å›¾ï¼ŒAPIä½¿ç”¨çš„æ˜¯[OpenGL ES] æˆ‘ä»¬ä»¥2Dç»˜å›¾çš„æµç¨‹æ¥ä¸¾ä¾‹ï¼š 1ã€éœ€è¦æ˜¾ç¤ºå›¾å½¢æ—¶ï¼Œé¦–å…ˆåˆ›å»ºä¸€ä¸ªSurfaceå¯¹è±¡ 2ã€è°ƒç”¨Surface#lockCanvas()è·å–Canvaså¯¹è±¡ 3ã€è°ƒç”¨Canvasçš„drawå¼€å¤´çš„å‡½æ•°æ‰§è¡Œä¸€ç³»åˆ—çš„ç»˜å›¾æ“ä½œ 4ã€è°ƒç”¨Surface#unlockCanvasAndPost()å°†ç»˜åˆ¶å®Œæˆçš„å›¾å±‚æäº¤ï¼Œç­‰å¾…ä¸‹ä¸€æ­¥åˆæˆæ˜¾ç¤º ç¬¬äºŒæ­¥çš„[lockCanvas()]æ–¹æ³•è¿”å›äº†Canvaså¯¹è±¡ä¾›å¼€å‘è€…ç»˜å›¾ä½¿ç”¨ï¼Œå…¶å†…éƒ¨å°±è°ƒç”¨äº†BufferQueue#dequeueBuffer()ç”³è¯·ä¸€å—å›¾å½¢bufferï¼Œåç»­æ‰€æœ‰çš„ç»˜å›¾ç»“æœéƒ½ä¼šå†™å…¥è¿™å—å†…å­˜ä¸­ ç¬¬å››æ­¥çš„[unlockCanvasAndPost()]æ–¹æ³•å†…éƒ¨è°ƒç”¨äº†BufferQueue#queueBuffer()æ–¹æ³•å°†ç»˜åˆ¶å®Œæˆçš„Bufferå…¥åˆ—ï¼Œç­‰å¾…sfè¿›ç¨‹åœ¨ä¸‹ä¸€æ¬¡åŒæ­¥ä¿¡å·å‘¨æœŸåˆæˆå¹¶å®Œæˆé€æ˜¾ ä¸Šé¢æ˜¯ä½¿ç”¨Javaå¼€å‘çš„ç»˜åˆ¶æµç¨‹ï¼ŒSurfaceé™¤äº†ç»™Javaå±‚æä¾›ç»˜å›¾æ¥å£å¤–ï¼Œå®ƒè¿˜æ˜¯ANativeWindowçš„å®ç°ç±» ANativeWindowæ˜¯ç”¨äºæä¾›ç»™C/C++å±‚å¼€å‘çš„æ¥å£ï¼Œå’Œåº”ç”¨å¼€å‘å…³ç³»ä¸å¤§ï¼Œç‚¹å‡»[è¿™é‡Œ]äº†è§£ä¸€ä¸‹å®ƒä»¬ä¹‹é—´çš„åŒºåˆ«å³å¯ ç®€å•æ¥è¯´ï¼ŒANativeWindowå’ŒSurfaceä¸€æ ·ï¼Œéƒ½å°è£…äº†Bufferçš„å‡ºåˆ—å’Œå…¥åˆ—æ–¹æ³• 3. ä»€ä¹ˆæ˜¯DisplayEventReceiver DisplayEventReceiverå¯¹è±¡çœ‹èµ·æ¥æœ‰ç‚¹é¢ç”Ÿï¼Œä½†æåˆ°Choreographeræˆ‘ç›¸ä¿¡å¤§éƒ¨åˆ†è¯»è€…åº”è¯¥éƒ½çŸ¥é“æ˜¯å¹²ä»€ä¹ˆçš„ DisplayEventReceiverå’ŒChoreographeréƒ½æ˜¯åœ¨é»„æ²¹è®¡åˆ’åŠ å…¥çš„æ–°æˆå‘˜ï¼Œå®ƒä¿©æ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»ï¼ˆDisplayEventReceiveræ˜¯Choreographerä¸­çš„ä¸€ä¸ªæˆå‘˜å˜é‡ï¼‰ ç®€å•æ¥è¯´ï¼ŒDisplayEventReceiverè®©Choreographerå¯¹è±¡æ‹¥æœ‰äº†æ„ŸçŸ¥VSyncä¿¡å·çš„èƒ½åŠ›ï¼Œäº†è§£å³å¯ å…³äºDisplayEventReceiveræ›´å¤šç»†èŠ‚è¯·ç‚¹å‡»è¿™é‡Œ 3ã€å°ç»“ å‘¼~ ç»ˆäºæŠŠç¡¬ä»¶é©±åŠ¨å’ŒGoogleç»„ä»¶åº“ä»‹ç»å®Œäº†ï¼Œç”¨ä¸€å¼ å›¾æ¥æ€»ç»“æœ¬ç« èŠ‚å†…å®¹ï¼š å›¾ç‰‡æ¥æºï¼šè‡ªå·±ç”»çš„ æœ€åº•å±‚çš„ç¡¬ä»¶é©±åŠ¨ç”±OEMå‚å•†æä¾›ï¼Œä¹Ÿå°±æ˜¯é«˜é€šã€ARMè¿™äº›SOCå‚å•† å¦‚æœè®¾å¤‡ä¸­æ²¡æœ‰GPU/DPUè¿™äº›ç¡¬ä»¶ä¹Ÿæ²¡å…³ç³»ï¼ŒGoogleä¸ºæ‰€æœ‰çš„é©±åŠ¨ï¼ˆåŒ…æ‹¬HALå±‚ï¼‰éƒ½æä¾›äº†é»˜è®¤å®ç°ï¼Œä¹Ÿå°±æ˜¯CPUå®ç°ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè™šæ‹Ÿæœºèƒ½è¿è¡Œçš„åŸå›  å†å¾€ä¸Šæ˜¯Googleæä¾›çš„ç»„ä»¶åº“ï¼Œé‡Œé¢éƒ½æ˜¯ä¸€äº›å¸¸ç”¨çš„ç±»ï¼Œå…¶ä¸­å¤§éƒ¨åˆ†æˆå‘˜æˆ‘ä»¬éƒ½è¿˜æ˜¯è¦äº†è§£å®ƒä»¬å„è‡ªæ˜¯åšä»€ä¹ˆçš„ï¼Œå› ä¸ºåªæœ‰æŠŠè¿™äº›åŸºç¡€æ¦‚å¿µç†è§£æ¸…æ¥šï¼Œæ‰èƒ½åœ¨åç»­é˜…è¯»æºç çš„è¿‡ç¨‹ä¸­åšåˆ°æœ‰çš„æ”¾çŸ¢ å¥½äº†ï¼ŒAndroidå›¾å½¢ç³»ç»Ÿçš„é™æ€éƒ¨åˆ†èŠå®Œäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¿›å…¥åŠ¨æ€éƒ¨åˆ†çš„å†…å®¹ äºŒã€è¯·æ±‚VSyncä¿¡å· å‚å•†é©±åŠ¨åº“å’ŒGoogleç»„ä»¶åº“ä½œä¸ºAndroidå›¾å½¢ç³»ç»Ÿçš„åŸºçŸ³ï¼Œä¸ºæ•´ä¸ªå›¾å½¢ç³»ç»Ÿæä¾›äº†å¼ºæœ‰åŠ›çš„æ”¯æ’‘ åœ¨Androidå›¾å½¢ç³»ç»Ÿçš„åŠ¨æ€éƒ¨åˆ†ï¼ŒSurfaceFlingerä½œä¸ºç³»ç»Ÿçš„æ ¸å¿ƒè¿›ç¨‹ï¼Œåœ¨æ•´ä¸ªå›¾å½¢ç³»ç»Ÿä¸­èµ·æ‰¿ä¸Šå¯ä¸‹çš„ä½œç”¨ ä¸ºå›¾å½¢ç³»ç»ŸæœåŠ¡çš„å¦å¤–è¿˜æœ‰SystemServerè¿›ç¨‹ï¼Œå®ƒå’ŒSurfaceFlingerè¿›ç¨‹ä¸€åŒæ”¯æ’‘ç€æ•´ä¸ªç³»ç»Ÿçš„è¿è½¬ï¼Œå…¶ä¸­ï¼š SurfaceFlingerè¿›ç¨‹è´Ÿè´£æ¥å—æ¥è‡ªAPPè¿›ç¨‹çš„å›¾å½¢æ•°æ®ï¼Œè°ƒç”¨hwcè¿›è¡Œåˆæˆå¹¶å®Œæˆæœ€ç»ˆçš„é€æ˜¾ SystemServerè¿›ç¨‹è´Ÿè´£ç®¡ç†æœ‰å“ªäº›APPè¿›ç¨‹å¯ä»¥è¿›è¡Œç»˜å›¾æ“ä½œä»¥åŠå„ä¸ªå›¾å±‚çš„ä¼˜å…ˆçº§ SurfaceFlingerè¿›ç¨‹å’ŒSystemServerè¿›ç¨‹éƒ½æ˜¯åœ¨VSyncä¿¡å·çš„é©±ä½¿ä¸‹è¿›è¡Œå·¥ä½œï¼Œåœ¨æ¥ä¸‹æ¥çš„ç« èŠ‚ä¸­æˆ‘ä»¬å°†ä¼šåˆ†æè¿™ä¸¤å¤§ç³»ç»Ÿè¿›ç¨‹åˆ†åˆ«åœ¨VSyncä¿¡å·åˆ°æ¥æ—¶åšäº†å“ªäº›äº‹æƒ… ä¸è¿‡ï¼Œåœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆçŸ¥é“å®ƒä»¬æ˜¯å¦‚ä½•è¯·æ±‚VSyncä¿¡å·çš„ï¼Ÿ å…¨æ–‡åŸºäºAndroid 7.1.2ç‰ˆæœ¬ 1ã€å¯åŠ¨surface_flingerè¿›ç¨‹ Android 7.0ä»¥åå¯¹init.rcè„šæœ¬è¿›è¡Œäº†é‡æ„ï¼Œsfè¿›ç¨‹çš„å¯åŠ¨ä»init.rcæ–‡ä»¶é…ç½®åˆ°äº†surfaceflinger.rcæ–‡ä»¶ï¼Œä¾æ—§ç”±initè¿›ç¨‹æ‹‰èµ· å…ˆæ¥çœ‹main_surfaceflinger.cppçš„å¯åŠ¨å‡½æ•°ï¼š /frameworks/native/services/surfaceflinger/main_surfaceflinger.cpp int main(int, char**) { //åˆ›å»ºsfå¯¹è±¡ sp&lt;SurfaceFlinger&gt; flinger = new SurfaceFlinger(); //è°ƒç”¨initæ–¹æ³•è¿›è¡Œåˆå§‹åŒ– flinger-&gt;init(); //æ³¨å†ŒsfæœåŠ¡åˆ°servicemanager sp&lt;IServiceManager&gt; sm(defaultServiceManager()); sm-&gt;addService(String16(SurfaceFlinger::getServiceName()), flinger, false); //æ³¨å†ŒgpuæœåŠ¡åˆ°servicemanager sp&lt;GpuService&gt; gpuservice = new GpuService(); sm-&gt;addService(String16(GpuService::SERVICE_NAME), gpuservice, false); //è°ƒç”¨runæ–¹æ³•ï¼Œè¿›å…¥ä¼‘çœ  flinger-&gt;run(); return 0; } main_surfaceflingerçš„å…¥å£å‡½æ•°çš„ä¸»è¦åšäº†3ä»¶äº‹ï¼š åˆ›å»ºflingerå¯¹è±¡å¹¶è°ƒç”¨init()æ–¹æ³•æ‰§è¡Œåˆå§‹åŒ–å·¥ä½œ æ³¨å†ŒsfæœåŠ¡å’ŒgpuæœåŠ¡åˆ°servicemanager è°ƒç”¨run()æ–¹æ³•è¿›å…¥ä¼‘çœ  ä¸»è¦çš„å·¥ä½œæ˜¯åœ¨flingerå¯¹è±¡ä¸­çš„init()å‡½æ•°ä¸­å®Œæˆçš„ æˆ‘ä»¬ç»§ç»­å‘ä¸‹è·ŸSurfaceFlinger#init()å‡½æ•°ï¼š /frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp //åˆ©ç”¨RefBaseé¦–æ¬¡å¼•ç”¨æœºåˆ¶æ¥åšä¸€äº›åˆå§‹åŒ–å·¥ä½œï¼Œè¿™é‡Œæ˜¯åˆå§‹åŒ–æ¶ˆæ¯æœºåˆ¶ //æ¶ˆæ¯é˜Ÿåˆ—åœ¨sfè¿›ç¨‹ä¸­ä¸€å…±æä¾›ä¸¤ä¸ªåŠŸèƒ½ //1. æ‰§è¡Œsfè¿›ç¨‹è¯·æ±‚VSyncçš„å·¥ä½œ //2. VSync-sfä¿¡å·åˆ°æ¥åï¼Œæ‰§è¡Œåˆæˆå·¥ä½œ void SurfaceFlinger::onFirstRef() { mEventQueue.init(this); } //åˆå§‹åŒ–-åªæˆªå–äº†å’ŒVSyncä¿¡å·å’Œå›¾å½¢åˆæˆæœ‰å…³çš„éƒ¨åˆ†ä»£ç  void SurfaceFlinger::init() { { // start the EventThread //å¯åŠ¨äº‹ä»¶åˆ†å‘çº¿ç¨‹ï¼Œæä¾›ç»™APPè¿›ç¨‹æ³¨å†Œäº‹ä»¶å›è°ƒ //mPrimaryDispSyncæ˜¯ç”¨æ¥æ§åˆ¶ sp&lt;VSyncSource&gt; VSyncSrc = new DispSyncSource(&amp;mPrimaryDispSync, VSyncPhaseOffsetNs, true, &quot;app&quot;); mEventThread = new EventThread(VSyncSrc, *this); //åˆå¯åŠ¨ä¸€ä¸ªäº‹ä»¶åˆ†å‘çº¿ç¨‹ï¼Œå¹¶å°†è‡ªå·±æ³¨å†Œåˆ°hwcä¸­ï¼Œç”¨äºsfè¿›ç¨‹ç›‘å¬VSyncä¿¡å· sp&lt;VSyncSource&gt; sfVSyncSrc = new DispSyncSource(&amp;mPrimaryDispSync, sfVSyncPhaseOffsetNs, true, &quot;sf&quot;); mSFEventThread = new EventThread(sfVSyncSrc, *this); mEventQueue.setEventThread(mSFEventThread); } // Drop the state lock while we initialize the hardware composer. We drop // the lock because on creation, it will call back into SurfaceFlinger to // initialize the primary display. //åˆå§‹åŒ–HWCå¯¹è±¡ï¼ŒåŠ è½½hwcomposer.soçš„åŠ¨ä½œåœ¨HWComposerçš„åˆå§‹åŒ–å‡½æ•°ä¸­ mHwc = new HWComposer(this); //å°†è‡ªå·±æ³¨å†Œåˆ°hwcçš„å›è°ƒå‡½æ•°ä¸­ï¼Œå…¶å†…éƒ¨åˆ†åˆ«è°ƒç”¨registerHotplugCallbackã€registerRefreshCallbackã€registerVSyncCallbackä¸‰ä¸ªå›è°ƒæ–¹æ³• mHwc-&gt;setEventHandler(static_cast&lt;HWComposer::EventHandler*&gt;(this)); mEventControlThread = new EventControlThread(this); mEventControlThread-&gt;run(&quot;EventControl&quot;, PRIORITY_URGENT_DISPLAY); } //è¿›å…¥æ¶ˆæ¯è½®è¯¢ void SurfaceFlinger::run() { do { waitForEvent(); } while (true); } //ç­‰å¾…æ¶ˆæ¯å”¤é†’ void SurfaceFlinger::waitForEvent() { do { IPCThreadState::self()-&gt;flushCommands(); int32_t ret = mLooper-&gt;pollOnce(-1); } while (true); } init()å‡½æ•°åˆå§‹åŒ–æµç¨‹ç¨å¾®æœ‰ç‚¹é•¿ï¼Œæˆ‘ä»¬ä¸€æ­¥æ­¥æ‹†å¼€æ¥çœ‹ åˆå§‹åŒ–æ¶ˆæ¯é˜Ÿåˆ— //åˆ©ç”¨RefBaseé¦–æ¬¡å¼•ç”¨æœºåˆ¶æ¥åšä¸€äº›åˆå§‹åŒ–å·¥ä½œï¼Œè¿™é‡Œæ˜¯åˆå§‹åŒ–æ¶ˆæ¯æœºåˆ¶ //æ¶ˆæ¯é˜Ÿåˆ—åœ¨sfè¿›ç¨‹ä¸­ä¸€å…±æä¾›ä¸¤ä¸ªåŠŸèƒ½ //1. æ‰§è¡Œsfè¿›ç¨‹è¯·æ±‚VSyncçš„å·¥ä½œ //2. VSync-sfä¿¡å·åˆ°æ¥åï¼Œæ‰§è¡Œåˆæˆå·¥ä½œ void SurfaceFlinger::onFirstRef() { mEventQueue.init(this); } åœ¨SurfaceFlingerä¸­ï¼Œåˆ©ç”¨äº†RefBaseé¦–æ¬¡å¼•ç”¨æœºåˆ¶æ¥åšä¸€äº›åˆå§‹åŒ–å·¥ä½œï¼Œè¿™é‡Œæ˜¯åˆå§‹åŒ–æ¶ˆæ¯é˜Ÿåˆ— sfè¿›ç¨‹ä¸­çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸€å…±è´Ÿè´£å¤„ç†ä¸¤ç§ç±»å‹çš„æ¶ˆæ¯ï¼š INVALIDATEï¼šå¤„ç†Layerå±æ€§å˜åŒ–ä»¥åŠbufferçš„æ›´æ–° REFRESHï¼šç›‘å¬åˆ°VSyncä¿¡å·ï¼Œæ‰§è¡Œåˆæˆå·¥ä½œ åœ¨æ¥ä¸‹æ¥çš„æ–‡ç« åˆ†æä¸­æˆ‘ä»¬ä¼šå‘ç°ï¼Œsfè¿›ç¨‹çš„ä¸€ç”Ÿéƒ½å°†å›´ç»•ç€è¿™ä¸¤ä»¶äº‹å±•å¼€ å¯åŠ¨äº‹ä»¶åˆ†å‘çº¿ç¨‹ /frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp //åˆå§‹åŒ–-åªæˆªå–äº†å’ŒVSyncä¿¡å·å’Œå›¾å½¢åˆæˆæœ‰å…³çš„éƒ¨åˆ†ä»£ç  void SurfaceFlinger::init() { { // start the EventThread //å¯åŠ¨äº‹ä»¶åˆ†å‘çº¿ç¨‹ï¼Œæä¾›ç»™APPè¿›ç¨‹æ³¨å†Œäº‹ä»¶å›è°ƒ //VSyncPhaseOffsetNsç”¨æ¥æ§åˆ¶APPè¿›ç¨‹çš„åç§»é‡ sp&lt;VSyncSource&gt; VSyncSrc = new DispSyncSource(&amp;mPrimaryDispSync, VSyncPhaseOffsetNs, true, &quot;app&quot;); mEventThread = new EventThread(VSyncSrc, *this); //åˆå¯åŠ¨äº‹ä»¶åˆ†å‘çº¿ç¨‹ï¼Œæä¾›ç»™sfè¿›ç¨‹æ³¨å†Œäº‹ä»¶å›è°ƒ //sfVSyncPhaseOffsetNsç”¨æ¥æ§åˆ¶sfè¿›ç¨‹çš„åç§»é‡ sp&lt;VSyncSource&gt; sfVSyncSrc = new DispSyncSource(&amp;mPrimaryDispSync, sfVSyncPhaseOffsetNs, true, &quot;sf&quot;); mSFEventThread = new EventThread(sfVSyncSrc, *this); mEventQueue.setEventThread(mSFEventThread); } //ç”¨äºæ§åˆ¶ç¡¬ä»¶VSyncå¼€å…³çŠ¶æ€ mEventControlThread = new EventControlThread(this); mEventControlThread-&gt;run(&quot;EventControl&quot;, PRIORITY_URGENT_DISPLAY); } init()å‡½æ•°ä¸­ç¬¬äºŒæ­¥æ˜¯å¯åŠ¨äº‹ä»¶åˆ†å‘çº¿ç¨‹ ä¸€å…±å¯åŠ¨äº†3ä¸ªçº¿ç¨‹ï¼Œå…¶ä¸­ï¼š mEventThreadç”¨äºç»™APPè¿›ç¨‹æä¾›VSyncä¿¡å·ç›‘å¬ï¼Œé€šå¸¸ç§°ä¸ºVSYNC-app mSFEventThreadç”¨äºç»™sfè¿›æä¾›VSyncä¿¡å·ç›‘å¬ï¼Œé€šå¸¸ç§°ä¸ºVSYNC-sf mEventControlThreadæ˜¯æ€»å¼€å…³ï¼Œç”¨äºæ§åˆ¶ç¡¬ä»¶VSyncä¿¡å·çš„å¼€å¯ä¸å…³é—­ 1ã€2çº¿ç¨‹åˆ†åˆ«æ˜¯â€œAPPè¿›ç¨‹â€å’Œâ€œsfè¿›ç¨‹çš„â€VSyncäº‹ä»¶åˆ†å‘çº¿ç¨‹ æŠŠAPPè¿›ç¨‹å’Œsfè¿›ç¨‹çš„VSyncåˆ†å¼€ç®¡ç†çš„å¥½å¤„æ˜¯ï¼šé™ä½æ“æ§å»¶æ—¶ ä»€ä¹ˆæ˜¯â€œé™ä½æ“æ§å»¶æ—¶â€ï¼Ÿæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹æ­£å¸¸çš„æ˜¾ç¤ºæµç¨‹ï¼š VSync1ï¼šAPPè¿›ç¨‹å¼€å§‹æ¸²æŸ“ï¼Œæ¸²æŸ“å®Œæˆåå…¥åˆ—ç­‰å¾…åˆæˆ VSync2ï¼šsfæŸ¥æ‰¾æ‰€æœ‰æ¸²æŸ“å®Œæˆçš„å›¾å±‚ï¼Œè°ƒç”¨hwcåˆæˆï¼Œåˆæˆå®Œæˆè°ƒç”¨drm/fbæ˜¾ç¤ºæ¡†æ¶é€æ˜¾ï¼Œç­‰å¾…æ˜¾ç¤º VSync3ï¼šä¸ºäº†é˜²æ­¢ç”»é¢æ’•è£‚ï¼Œæ˜¾ç¤ºæ¡†æ¶åŒæ ·ç­‰å¾…å‚ç›´åŒæ­¥ä¿¡å·åˆ°æ¥æ—¶æ‰åˆ‡æ¢framebufferï¼Œæ­¤æ—¶ç”¨æˆ·çœ‹åˆ°æ›´æ–°çš„ç”»é¢ ä¸€å¹…ç”»é¢æœ€èµ·ç è¦ç»è¿‡2ä¸ªVSyncå‘¨æœŸï¼ˆæ¸²æŸ“ã€åˆæˆï¼‰ï¼Œåœ¨ç¬¬3ä¸ªVSyncä¿¡å·åˆ°æ¥åæ‰èƒ½å±•ç¤ºç»™ç”¨æˆ· å¦‚æœæ˜¯60HZçš„å±å¹•ï¼Œç”¨æˆ·ä»æŒ‰ä¸‹æŒ‰é’®åˆ°åˆ°çœ‹åˆ°ç”»é¢æ›´æ–°ï¼Œæœ€å¿«è¦16.67ms*2 = 33.34ms ç°åœ¨å‡è®¾æœ‰è¿™ä¹ˆä¸ªæƒ…å†µï¼šæˆ‘è‡ªå·±é€ äº†ä¸ªç¡¬ä»¶éå¸¸éå¸¸ç‰›é€¼ï¼Œå†å¤æ‚çš„ç”»é¢æ¸²æŸ“ä¹Ÿåªè¦1msï¼Œåˆæˆä¹Ÿåªè¦1ms é‚£ç³»ç»Ÿå±‚é¢æœ‰æ²¡æœ‰ä¸€ç§æœºåˆ¶èƒ½è®©ç”¨æˆ·æ›´å¿«çš„çœ‹åˆ°ç”»é¢æ›´æ–°å‘¢ï¼Ÿ VSync offsetï¼šæœ‰ 1. VSync offset å›å¤´æ¥çœ‹init()å‡½æ•°ï¼Œåœ¨åˆ›å»ºâ€œAPPè¿›ç¨‹â€å’Œâ€œsfè¿›ç¨‹â€çš„DispSyncSourceå¯¹è±¡æ—¶ï¼Œåˆ†åˆ«ä¼ å…¥äº†VSyncPhaseOffsetNså’ŒsfVSyncPhaseOffsetNsä¸¤ä¸ªå˜é‡ void SurfaceFlinger::init() { //VSyncPhaseOffsetNs - i'm here sp&lt;VSyncSource&gt; VSyncSrc = new DispSyncSource(&amp;mPrimaryDispSync, VSyncPhaseOffsetNs, true, &quot;app&quot;); //sfVSyncPhaseOffsetNs sp&lt;VSyncSource&gt; sfVSyncSrc = new DispSyncSource(&amp;mPrimaryDispSync, sfVSyncPhaseOffsetNs, true, &quot;sf&quot;); } VSyncPhaseOffsetNsç”¨æ¥æ§åˆ¶APPè¿›ç¨‹çš„åç§»é‡ sfVSyncPhaseOffsetNsç”¨æ¥æ§åˆ¶sfè¿›ç¨‹çš„åç§»é‡ æˆ‘ä»¬çŸ¥é“ç¡¬ä»¶å‚ç›´åŒæ­¥ä¿¡å·çš„å‘é€å‘¨æœŸæ˜¯å›ºå®šçš„ æ—¢ç„¶å¤§å®¶éƒ½åœ¨è‡ªå·±çš„è¿›ç¨‹é‡Œç­‰å¾…ç€VSyncä¿¡å·çš„åˆ°æ¥ï¼Œç„¶åå„å¸å…¶èŒåšè‡ªå·±çš„å·¥ä½œ é‚£æˆ‘ä»¬é€šè¿‡æ›´æ”¹åç§»é‡çš„æ–¹å¼æŠŠâ€œAPPè¿›ç¨‹â€å’Œâ€œsfè¿›ç¨‹â€æ¥æ”¶åˆ°VSyncä¿¡å·çš„æ—¶é—´é”™å¼€ å°±å¯ä»¥å®ç°ï¼šåœ¨ä¸€ä¸ªç¡¬ä»¶VSyncä¿¡å·å‘¨æœŸå†…å®Œæˆâ€œæ¸²æŸ“â€å’Œâ€œåˆæˆâ€ä¸¤ä»¶äº‹ï¼Œå…·ä½“æ–¹æ¡ˆå¦‚ä¸‹ï¼š VSyncPhaseOffsetNs = 0ï¼Œç¡¬ä»¶VSyncå‘ç”Ÿåï¼Œç›´æ¥è½¬å‘ç»™appè¿›ç¨‹ï¼Œè®©å®ƒå¼€å§‹ç»˜åˆ¶ sfVSyncPhaseOffsetNs â‰¥1ï¼Œç¡¬ä»¶VSyncå‘ç”Ÿåï¼Œå»¶è¿Ÿå‡ æ¯«ç§’å†è½¬å‘ç»™sfè¿›ç¨‹ï¼Œå› ä¸ºappå·²ç»æ¸²æŸ“å®Œæˆï¼Œsfåˆæˆåˆšåˆšæ¸²æŸ“çš„å›¾å±‚ å¥½äº†ï¼Œåœ¨ä¸€ä¸ªç¡¬ä»¶VSyncå‘¨æœŸ16msï¼‰å†…â€œæ¸²æŸ“â€å’Œâ€œåˆæˆâ€çš„å·¥ä½œéƒ½å·²ç»å®Œæˆäº†ï¼Œå¹¶ä¸”ç”±äºGPUæ€§èƒ½è¿‡äºç‰›é€¼ï¼Œè·ç¦»ä¸‹æ¬¡ç¡¬ä»¶VSyncä¿¡å·å‘é€ç”šè‡³è¿˜æœ‰14ms~ ç­‰ä¸‹ä¸€æ¬¡ç¡¬ä»¶VSyncä¿¡å·åˆ°æ¥æ—¶ï¼Œæ˜¾ç¤ºæ¡†æ¶å®Œæˆç”»é¢åˆ‡æ¢ å’Œä¹‹å‰çš„æ–¹æ¡ˆæ¯”ï¼ŒåŒæ ·æ˜¯60HZçš„å±å¹• ç”¨æˆ·ä»æŒ‰ä¸‹æŒ‰é’®åˆ°åˆ°çœ‹åˆ°ç”»é¢æ›´æ–°ï¼Œåªéœ€è¦ç­‰å¾…1ä¸ªVSyncä¿¡å·å‘¨æœŸï¼Œä¹Ÿå°±æ˜¯16.67ms 2. DispSyncæ¨¡å‹ è¿˜è®°å¾—init()å‡½æ•°ä¸­å¯åŠ¨çš„ç¬¬3ä¸ªçº¿ç¨‹å—ï¼Ÿåç§°å«ï¼šmEventControlThread /frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp class SurfaceFlinger { void SurfaceFlinger::init() { //ç”¨äºæ§åˆ¶ç¡¬ä»¶VSyncå¼€å…³çŠ¶æ€ mEventControlThread = new EventControlThread(this); mEventControlThread-&gt;run(&quot;EventControl&quot;, PRIORITY_URGENT_DISPLAY); } //æ¥æ”¶æ¥è‡ªhwcçš„ç¡¬ä»¶VSyncä¿¡å· void SurfaceFlinger::onVSyncReceived(int32_t type, nsecs_t timestamp) { bool needsHwVSync = false; needsHwVSync = mPrimaryDispSync.addResyncSample(timestamp); if (needsHwVSync) { enableHardwareVSync(); } else { disableHardwareVSync(false); } } //å¯ç”¨ç¡¬ä»¶VSyncä¿¡å· void SurfaceFlinger::enableHardwareVSync() { mPrimaryDispSync.beginResync(); mEventControlThread-&gt;setVSyncEnabled(true); } //å…³é—­ç¡¬ä»¶VSyncä¿¡å· void SurfaceFlinger::disableHardwareVSync(bool makeUnavailable) { mEventControlThread-&gt;setVSyncEnabled(false); mPrimaryDispSync.endResync(); } } mEventControlThreadçº¿ç¨‹åˆå§‹åŒ–ä¹‹åè¢«DispSyncæŒæœ‰ï¼Œç”¨æ¥å¯ç”¨å’Œå…³é—­ç¡¬ä»¶VSyncçš„åŠŸèƒ½ åœ¨Androidå›¾å½¢ç³»ç»Ÿä¸­ï¼Œä¸ç®¡æ˜¯ç¡¬ä»¶äº§ç”Ÿè¿˜æ˜¯è½¯ä»¶æ¨¡æ‹Ÿçš„VSyncä¿¡å·ï¼Œæœ€ç»ˆéƒ½äº¤ç”±DispSyncæ¥ç®¡ç† VSync offsetèƒ½å¤Ÿæ§åˆ¶åç§»é‡çš„èƒŒåå°±æ˜¯DispSyncæ¨¡å‹ DispSyncæ§åˆ¶ç€è¿™ä¸ªç³»ç»Ÿçš„VSyncä¿¡å·å‡ºå£ï¼Œé™¤äº†è°ƒæ•´åç§»é‡å¤–ï¼Œå®ƒçš„å†…éƒ¨è¿˜æœ‰ä¸ªé¢„æµ‹æœºåˆ¶ å½“æ¥å—åˆ°çš„ç¡¬ä»¶VSyncä¿¡å·é‡è¶³å¤Ÿå¤§æ—¶ï¼ŒDispSyncä¼šé€šè¿‡mEventControlThreadå…³é—­ç¡¬ä»¶VSyncå¼€å…³ï¼Œé€šè¿‡é¢„æµ‹çš„ç»“æœæ¨¡æ‹ŸVSyncä¿¡å·çš„äº§ç”Ÿï¼Œå‘é€åˆ°appè¿›ç¨‹å’Œsfè¿›ç¨‹ psï¼šæˆ‘ä¸ªäººå¯¹DispSyncæ¨¡å‹ä»ç„¶æœ‰ç–‘é—®ï¼Œè¿™å—ç†è§£çš„å¯èƒ½ä¸å¤ªå¯¹ï¼Œæ‰€ä»¥ä¸æ•¢å¦„ä¸‹ç»“è®ºï¼Œå»ºè®®é˜…è¯»ä»¥ä¸‹å‡ ç¯‡æ–‡ç« è¿›è¡Œå­¦ä¹ ï¼š ã€ŠAnalyze AOSP VSync modelã€‹ã€ã€ŠDispSyncè§£æã€‹ã€ã€ŠAndroid DispSync è¯¦è§£ã€‹ã€ã€ŠAndroid R VSyncç›¸å…³æ¢³ç†ã€‹ã€ã€ŠAndroid SurfaceFlinger SW VSyncæ¨¡å‹ã€‹ åˆå§‹åŒ–HWComposer /frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp void SurfaceFlinger::init() { ... //åˆå§‹åŒ–HWCå¯¹è±¡ï¼ŒåŠ è½½hwcomposer.soçš„åŠ¨ä½œåœ¨HWComposerçš„åˆå§‹åŒ–å‡½æ•°ä¸­ mHwc = new HWComposer(this); //å°†è‡ªå·±æ³¨å†Œåˆ°hwcçš„å›è°ƒå‡½æ•°ä¸­ï¼Œå…¶å†…éƒ¨åˆ†åˆ«è°ƒç”¨registerHotplugCallbackã€registerRefreshCallbackã€registerVSyncCallbackä¸‰ä¸ªå›è°ƒæ–¹æ³• mHwc-&gt;setEventHandler(static_cast&lt;HWComposer::EventHandler*&gt;(this)); } å‰é¢æˆ‘ä»¬è¯´sfè¿›ç¨‹çš„ä¸€ç”Ÿï¼Œå°±æ˜¯åœ¨åšâ€œè¯·æ±‚VSyncâ€å’Œâ€œæ‰§è¡Œåˆæˆå·¥ä½œâ€è¿™ä¸¤ä»¶äº‹ è€ŒHWComposerå°±æ˜¯å®Œæˆè¿™ä¸¤ä»¶äº‹çš„å…³é”®ï¼Œä¸ç®¡æ˜¯æ¥å—ç¡¬ä»¶çš„VSyncä¿¡å·ï¼Œè¿˜æ˜¯å®Œæˆå›¾å±‚åˆæˆå·¥ä½œï¼Œéƒ½å’Œå®ƒæœ‰å…³ æ‰€ä»¥ï¼ŒHWComposerå¯¹è±¡å¯ä»¥è¯´æ˜¯sfè¿›ç¨‹ä¸­çš„å¤´å·æ ¸å¿ƒäººç‰© sfè¿›ç¨‹åœ¨åˆå§‹åŒ–HWComposeré˜¶æ®µä¸€å…±åšäº†ä¸¤ä»¶äº‹ï¼š åˆ›å»ºHWCå¯¹è±¡ï¼Œä¿å­˜åˆ°mHwcæˆå‘˜å˜é‡ æ³¨æ„ï¼Œè¿™é‡Œåˆ›å»ºçš„æ˜¯æ ‡å‡†çš„HWComposerå¯¹è±¡ï¼Œåœ¨HWComposeræ„é€ å‡½æ•°ä¸­ï¼Œè°ƒç”¨äº†å†…éƒ¨çš„[loadHwcModule()]æ–¹æ³•æ¥åŠ è½½å‚æµ‹æä¾›çš„soåº“ æ³¨å†ŒVSyncå›è°ƒ HWCå¯¹è±¡åˆ›å»ºå®Œä»¥åï¼Œç¬¬äºŒæ­¥å°±è°ƒç”¨äº†setEventHandlerå°†è‡ªå·±æ³¨å†Œåˆ°VSyncä¿¡å·ç›‘å¬ å¦‚æœVSyncä¿¡å·å‘ç”Ÿå˜åŒ–ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ°sfè¿›ç¨‹çš„[onVSyncReceived()]æ–¹æ³• è¿›å…¥ç¡çœ  ç­‰å¾…å”¤é†’ /frameworks/native/services/surfaceflinger/main_surfaceflinger.cpp int main(int, char**) { ... // run surface flinger in this thread flinger-&gt;run(); return 0; } /frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp void SurfaceFlinger::run() { do { waitForEvent(); } while (true); } åœ¨å®Œæˆæ‰€æœ‰åˆå§‹åŒ–å·¥ä½œåï¼Œsfè¿›ç¨‹è¿›å…¥ç¡çœ çŠ¶æ€ï¼Œç­‰å¾…æ¶ˆæ¯å”¤é†’ æ€»ç»“ä¸€ä¸‹ï¼Œsfè¿›ç¨‹åœ¨å›¾å½¢å¤„ç†ç›¸å…³æ–¹é¢ä¸€å…±åšäº†ä¸¤ä»¶äº‹ï¼š å¯åŠ¨äº‹ä»¶åˆ†å‘çº¿ç¨‹ï¼Œå†…éƒ¨ç”±DispSyncæ¨¡å‹å®ç° åˆå§‹åŒ–HWCå¯¹è±¡ï¼ŒåŠ è½½soåº“ï¼Œæ³¨å†ŒVSyncå›è°ƒ 2ã€å¯åŠ¨system_serverè¿›ç¨‹ [system_serverè¿›ç¨‹ä¸­è¿è¡Œç€AMSã€WMSç­‰å¸¸è§æœåŠ¡ï¼Œè¿™äº›æœåŠ¡éƒ½æ˜¯ç”±javaä»£ç å®ç°çš„ï¼Œéœ€è¦ä¸€ä¸ªJavaçš„è¿è¡Œç¯å¢ƒ æ‰€ä»¥SystemServerè¿›ç¨‹å¿…é¡»è¦ç­‰åˆ°Zygoteè¿›ç¨‹åˆ›å»ºå®ŒDVM/ARTè™šæ‹Ÿæœºä»¥åï¼Œå†ç”±Zygoteè¿›ç¨‹forkè€Œæ¥ï¼š /frameworks/base/services/java/com/android/server/SystemServer.java class SystemServer { /** * The main entry point from zygote. */ public static void main(String[] args) { new SystemServer().run(); } private void run() { Looper.prepareMainLooper(); startBootstrapServices(); startOtherServices(); // Loop forever. Looper.loop(); } //å¯åŠ¨AMS private void startBootstrapServices() { mActivityManagerService = mSystemServiceManager.startService(ActivityManagerService.Lifecycle.class).getService(); // Set up the Application instance for the system process and get started. mActivityManagerService.setSystemProcess(); } //å¯åŠ¨WMS private void startOtherServices() { WindowManagerService wm = WindowManagerService.main(); //å°†wmsæ³¨å†Œåˆ°servicemanager ServiceManager.addService(Context.WINDOW_SERVICE, wm); mActivityManagerService.systemReady();// } } /frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java class ActivityManagerService { //å°†è‡ªå·±æ³¨å†Œåˆ°servicemanagerä¸­å» public void setSystemProcess() { ServiceManager.addService(Context.ACTIVITY_SERVICE, this, true); } //å¯åŠ¨launcheræ¡Œé¢ public void systemReady() { //aospç‰ˆæœ¬ä¸åŒä»£ç ä¹Ÿä¸åŒï¼Œåœ¨7.0ä¸­æœ€ç»ˆè°ƒç”¨startHomeActivityLocked()æ–¹æ³•å”¤èµ·launcher } } /frameworks/base/services/core/java/com/android/server/wm/WindowManagerService.java class WindowManagerService { public static WindowManagerService main(){ return new WindowManagerService(); } } Zygoteè¿›ç¨‹æ˜¯å¦‚ä½•å¯åŠ¨å¹¶æ‹‰èµ·system_serverè¿›ç¨‹è¿™é‡Œä¸å±•å¼€ï¼Œæˆ‘ä»¬æ¥å…³æ³¨åœ¨SystemServerçš„run()å‡½æ•°ä¸­å¯åŠ¨äº†ä¸¤ä¸ªæœåŠ¡ï¼šAMSå’ŒWMS åˆå§‹åŒ–ActivityManagerService ActivityManagerServiceæ˜¯Androidç³»ç»Ÿæœ€ä¸ºæ ¸å¿ƒçš„æœåŠ¡ä¹‹ä¸€ï¼Œè´Ÿè´£ç»„ä»¶ï¼ˆä¸»è¦æ˜¯Activityï¼‰çš„å¯åŠ¨ã€åˆ‡æ¢ã€è°ƒåº¦å·¥ä½œï¼Œæ¥çœ‹AMSçš„å¯åŠ¨æµç¨‹ /frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java class ActivityManagerService { //å°†è‡ªå·±æ³¨å†Œåˆ°servicemanagerä¸­å» public void setSystemProcess() { ServiceManager.addService(Context.ACTIVITY_SERVICE, this, true); } //å¯åŠ¨launcheræ¡Œé¢ public void systemReady() { //aospç‰ˆæœ¬ä¸åŒä»£ç ä¹Ÿä¸åŒï¼Œåœ¨7.0ä¸­æœ€ç»ˆè°ƒç”¨startHomeActivityLocked()æ–¹æ³•å”¤èµ·launcher } } AMSåœ¨SystemServerè¿›ç¨‹å¯åŠ¨è¿‡ç¨‹ä¸­åšäº†ä¸¤ä»¶äº‹ï¼š å°†è‡ªå·±æ³¨å†Œåˆ°servicemanagerä¸­å» å¯åŠ¨launcheræ¡Œé¢ åœ¨Androidå›¾å½¢ç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªActivityé¡µé¢éƒ½å¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªWindowå¯¹è±¡ï¼Œæ‰€ä»¥Activityçš„ç”Ÿå‘½å‘¨æœŸä¹Ÿä¼šå½±å“Windowå¯¹è±¡çš„çŠ¶æ€ æˆ‘ä»¬æ¥æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼šå½“æˆ‘ä»¬å¯åŠ¨ä¸€ä¸ªé€æ˜èƒŒæ™¯çš„Activityé¡µé¢æˆ–è€…æ˜¯Dialogä¸»é¢˜çš„Activityé¡µé¢ï¼ŒåŸå…ˆçš„Activityä¼šä¸ä¼šæ‰§è¡ŒonStop()å›è°ƒï¼Ÿ ç­”æ¡ˆæ˜¯ï¼šä¸ä¼š å¦‚æœAMSè§¦å‘äº†Activityçš„onStop()å›è°ƒæ–¹æ³•ï¼ŒåŒæ—¶ä¹Ÿä¼šè°ƒç”¨WindowManagerGlobal#setStoppedState()æ¥é€šçŸ¥Windowå¯¹è±¡ï¼Œé‚£ä¹ˆæ­¤Windowä¼šåœæ­¢ç»˜åˆ¶ è¿™å¹¶ä¸æ˜¯ç”¨æˆ·å¸Œæœ›çœ‹åˆ°çš„ç»“æœ åˆå§‹åŒ–WindowManagerService WindowManagerServiceçš„å¯åŠ¨å‡½æ•°éå¸¸ç®€å•ï¼Œåœ¨SystemServerä¸­åˆ›å»ºå®Œæˆä»¥åå°±ç›´æ¥æ³¨å†Œåˆ°äº†servicemanager /frameworks/base/services/java/com/android/server/SystemServer.java class SystemServer { //å¯åŠ¨WMS private void startOtherServices() { WindowManagerService wm = WindowManagerService.main(); //å°†wmsæ³¨å†Œåˆ°servicemanager ServiceManager.addService(Context.WINDOW_SERVICE, wm); } } /frameworks/base/services/core/java/com/android/server/wm/WindowManagerService.java class WindowManagerService { public static WindowManagerService main(){ return new WindowManagerService(); } } WMSå¯åŠ¨å®Œæˆä»¥åï¼Œæœ€é‡è¦çš„ä»»åŠ¡å°±æ˜¯ç­‰å¾…å¤„ç†æ¥è‡ªå„ä¸ªè¿›ç¨‹åˆ›å»º/æ›´æ–°/é”€æ¯Windowçš„å·¥ä½œ åœ¨åº”ç”¨å¼€å‘ä¸­ï¼Œé™¤äº†Activityå¯¹åº”ä¸€ä¸ªWindowçª—å£å¤–ï¼Œæ¯ä¸ªToastã€Dialogä¹Ÿéƒ½æ˜¯ä¸€ä¸ªWindowçª—å£ Androidä¸­å°†çª—å£çš„ç±»å‹åˆ†ä¸ºä¸‰ç§ï¼š Application Windowï¼ˆåº”ç”¨çª—å£ï¼‰ï¼šå¯¹åº”çš„æ˜¯Activity Sub Windowï¼ˆå­çª—å£ï¼‰ï¼šå¯¹åº”Dialogï¼Œç‰¹ç‚¹æ˜¯å¿…é¡»è¦ä¾é™„çˆ¶çª—å£æ‰èƒ½æ˜¾ç¤º System Windowï¼ˆç³»ç»Ÿçª—å£ï¼‰ï¼šå¯¹åº”Toastã€å¾®ä¿¡çš„è§†é¢‘é€šè¯ã€è§†é¢‘å°çª—æ’­æ”¾ç­‰ Looper.loop() å°†ä¸€ç³»åˆ—æœåŠ¡å¯åŠ¨ç»“æŸä»¥åï¼ŒSystemServerè°ƒç”¨Looper#loop()æ–¹æ³•è¿›å…¥å¾ªç¯ï¼Œä¿è¯system_serverè¿›ç¨‹ä¸é€€å‡º /frameworks/base/services/java/com/android/server/SystemServer.java class SystemServer { private void run() { startBootstrapServices(); startOtherServices(); // Loop forever. Looper.loop(); } } 3ã€å¯åŠ¨appè¿›ç¨‹ APPè¿›ç¨‹å’ŒSystemServerè¿›ç¨‹ä¸€æ ·ï¼Œéƒ½æ˜¯ä»Zygoteè¿›ç¨‹forkè€Œæ¥ å¯åŠ¨APPè¿›ç¨‹çš„ä»£ç ç¨å¾®æœ‰äº›é•¿ï¼Œæœ‰æ—¶é—´çš„åŒå­¦å»ºè®®ç‚¹å‡»[è¿™é‡Œ]æ‰“å¼€æºç å¯¹ç…§ç€çœ‹æ•ˆæœæ›´ä½³ /* è§†å›¾åŠ è½½å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼šActivityå¯¹è±¡çš„åˆ›å»ºã€è§†å›¾å¯¹è±¡çš„åˆ›å»ºã€ViewRootImplçš„åˆ›å»º åœ¨ç¬¬ä¸€ä¸ªé˜¶æ®µï¼ŒActivityThread.main() ActivityThreadï¼Œå…¥å£å‡½æ•°ä¸­åˆå§‹åŒ–handleræœºåˆ¶ ApplicationThreadï¼Œamsä¼ è¯ç­’ Activityï¼Œå¼€å‘è€…çš„ä¸»æˆ˜åœº PhoneWindowï¼Œç©ºå£³å­ WindowManagerï¼Œwmsçš„ä»£ç†å¯¹è±¡ åœ¨ç¬¬äºŒä¸ªé˜¶æ®µï¼ŒActivity.setContentView è°ƒç”¨PhoneWindowè®¾ç½®è§†å›¾ æ ¹æ®ä¸åŒä¸»é¢˜ï¼Œä¸ºDecorViewè®¾ç½®ä¸åŒçš„å­Viewï¼ˆæ— è®ºä½¿ç”¨å“ªç§ä¸»é¢˜è§†å›¾ï¼Œå…¶ä¸­å¿…ç„¶åŒ…å«åä¸ºcontentçš„FrameLayoutï¼‰ å°†å¼€å‘è€…çš„å¸ƒå±€æ–‡ä»¶æ·»åŠ åˆ°å­Viewåä¸ºcontentçš„FrameLayoutå½“ä¸­ ä¸ºPhoneWindowè®¾ç½®DecorView åœ¨ç¬¬ä¸‰ä¸ªé˜¶æ®µï¼Œåˆ›å»ºViewRootImpl 1. Choreographerè®©å®ƒèƒ½å¤Ÿæ„ŸçŸ¥äº‹ä»¶ 2. ä¿å­˜DecorViewè®©å®ƒèƒ½å¤Ÿåœ¨äº‹ä»¶æ¥ä¸´æ—¶æ§åˆ¶è§†å›¾ 3. Surfaceè®©å®ƒæ‹¥æœ‰ç»˜å›¾çš„èƒ½åŠ› é€šè¿‡addToDisplay()æ–¹æ³•æ¨é€åˆ°wms **/ /frameworks/base/core/java/android/app/ActivityThread.java class ActivityThread { //zygoteè¿›ç¨‹forkæˆåŠŸåè°ƒç”¨å…¥å£å‡½æ•° void main(){ Looper.prepareMainLooper(); attach();//attachæ–¹æ³•å’Œamså»ºç«‹è¿æ¥ï¼Œæä¾›ç»™amsæ§åˆ¶å››å¤§ç»„ä»¶çš„å¥æŸ„ Looper.loop(); } //åˆ†ä¸¤æ­¥è§£é‡Šæ›´å®¹æ˜“ç†è§£ //1. ä¸ç®¡æ˜¯ä»æ¡Œé¢ç‚¹å‡»å›¾æ ‡è¿›å…¥è¿˜æ˜¯adbå‘½ä»¤å¯åŠ¨ï¼Œæœ€ç»ˆéƒ½äº¤ç”±amså‘é€å¯åŠ¨è¯·æ±‚ç»™zygoteè¿›ç¨‹ï¼Œæ¥ç€zygoteå­µåŒ–å‡ºè¯¥APPè¿›ç¨‹è°ƒç”¨mainæ–¹æ³• //2. APPè¿›ç¨‹å¯åŠ¨å°†åˆ›å»ºApplicationThreadå¯¹è±¡ï¼Œå¹¶å‘èµ·IPCæŠŠæ­¤å¯¹è±¡ä¼ é€’ç»™amsï¼Œæ­¤åå››å¤§ç»„ä»¶ç›¸å…³å›åˆ°éƒ½å°†æœ‰ApplicationThreadå¯¹è±¡è´Ÿè´£ï¼Œæœ€ç»ˆè½¬å‘ç»™Hç±»æ‰§è¡Œ void attach() { //è·å–amsä»£ç†å¹¶å°†ApplicationThreadå°†ç»™amsï¼Œè¿™ä¸ªå¯¹è±¡ä»¥åå°†æ˜¯amsçš„ä¼ å£°ç­’ IActivityManager mgr = ActivityManagerNative.getDefault(); mgr.attachApplication(new ApplicationThread()); } //ApplicationThreadNativeå°è£…ä¸€ç³»åˆ—çš„å…³äºå››å¤§ç»„ä»¶å›è°ƒæ–¹æ³•çš„è·¨è¿›ç¨‹é€šä¿¡å‘½ä»¤ //ApplicationThreadå¯¹è±¡æ‰€æœ‰æ“ä½œå‡ ä¹éƒ½ç”±AMSå‘èµ·è°ƒç”¨ class ApplicationThread extends ApplicationThreadNative { void scheduleLaunchActivity(){ handleMessage(LAUNCH_ACTIVITY); } } class H extends Handler { //è½¬å‘æ¥è‡ªApplicationThreadçš„æ¶ˆæ¯ void handleMessage(Message msg) { case LAUNCH_ACTIVITY::handleLaunchActivity(); case RESUME_ACTIVITY::handleResumeActivity(); } //è½¬å‘æ¥è‡ªhandleMessageçš„æ¶ˆæ¯ void handleLaunchActivity(){ performLaunchActivity(); handleResumeActivity(); } //è½¬å‘æ¥è‡ªhandleMessageçš„æ¶ˆæ¯ void handleResumeActivity(){ performResumeActivity() activity.makeVisible();//è°ƒç”¨æ­¤æ–¹æ³•è¯´æ˜ç¬¬äºŒé˜¶æ®µè§†å›¾åŠ è½½å·²ç»å®Œæˆï¼Œå‡†å¤‡æäº¤åˆ°wmsæœåŠ¡ } //æ‰§è¡Œåˆ›å»ºActivityå¯¹è±¡å¹¶å›è°ƒç”Ÿå‘½å‘¨æœŸ Activity performLaunchActivity(){ Activity activity = new Activity(); activity.attach();//å›è°ƒattach activity.onCreate();//å›è°ƒActivity return activity; } //æ‰§è¡Œå›è°ƒç”Ÿå‘½å‘¨æœŸ void performResumeActivity(){ activity.onResume(); } } } /frameworks/base/core/java/android/app/Activity.java class Activity { View mDecor;//ç”¨æˆ·è®¾ç½®çš„è·Ÿè§†å›¾ï¼Œé€šå¸¸ä¼šåœ¨ActivityThreadä¸­è¢«èµ‹å€¼ Window mWindow;//Activityé¦–æ¬¡è¢«åˆ›å»ºè°ƒç”¨attach()æ–¹æ³•æ—¶åŒæ­¥åˆ›å»ºï¼Œåˆ›å»ºåŠ¨ä½œåœ¨Activity WindowManager mWindowManager;//åœ¨attachæ–¹æ³•ä¸­è¢«åˆ›å»º //1. åˆ›å»ºPhoneWindowä¿å­˜åˆ°å˜é‡mWindowï¼Œæ­¤æ—¶çš„Windowè¿˜æ²¡æœ‰Viewè§†å›¾ //2. è·å–wmsä»£ç†å¯¹è±¡ï¼Œå¡åˆ°åˆšåˆšåˆ›å»ºçš„windowå¯¹è±¡å½“ä¸­ï¼ŒåŒæ—¶ä¿å­˜åˆ°æœ¬åœ°mWindowManagerå˜é‡ void attach(Window window){ mWindow = new PhoneWindow(this, window); mWindow.setWindowManager(getSystemService(Context.WINDOW_SERVICE)); mWindowManager = mWindow.getWindowManager();//è·å–WindowManageråŠ¨ä½œåœ¨Activityä¸­ï¼Œè·å–å®Œæˆæ¥ç€è®¾ç½®ç»™è‡ªå·±çš„å±€éƒ¨å˜é‡ï¼Œè¿™æˆ‘æ˜¯çœŸçš„æ²¡æƒ³åˆ°ï¼Œæ‰¾çš„å¥½è¾›è‹¦ } //è‡³æ­¤ï¼ŒAPPè¿›ç¨‹å¯åŠ¨æˆåŠŸï¼Œç¬¬ä¸€é˜¶æ®µç»“æŸï¼Œå‡†å¤‡è¿›å…¥ç¬¬äºŒé˜¶æ®µ void onCreate(){ setContentView(); } //ç¬¬äºŒé˜¶æ®µå¼€å§‹ï¼šåŠ è½½è§†å›¾æ–‡ä»¶å¹¶ç»‘å®šåˆ°DecorView void setContentView(View view) { mWindow.setContentView(view); } //ç¬¬äºŒé˜¶æ®µå·²ç»å®Œæˆï¼Œå‡†å¤‡è¿›å…¥ç¬¬ä¸‰é˜¶æ®µ void onContentChanged(){ } //ç¬¬ä¸‰é˜¶æ®µå¼€å§‹ï¼šå°†è§†å›¾ä¼ é€’ç»™wms //makeVisible()åœ¨ActivityThread.H.handleResumeActivity()æ–¹æ³•ä¸­è¢«è°ƒç”¨ //æ­¤é˜¶æ®µå®Œæˆåä¼šè¯·æ±‚VSyncä¿¡å·ï¼Œå¹¶åœ¨ä¸‹ä¸€æ¬¡VSyncåˆ°æ¥æ—¶ç»˜åˆ¶Viewæ ‘ï¼Œåœ¨ä¸‹ä¸‹æ¬¡sfè¿›ç¨‹åˆæˆï¼Œåœ¨ä¸‹ä¸‹ä¸‹æ¬¡å±•ç¤ºç»™ç”¨æˆ·ï¼Œæ•´ä¸ªæµç¨‹å¦‚ä¸‹ï¼š //VSync-&gt;view.draw() // vysnc-&gt;sf.compose() // VSync-&gt;drm.flip() ç”¨æˆ·å¯ä»¥çœ‹åˆ° void makeVisible() { mWindowManager.addView(mDecor); } } /frameworks/base/core/java/com/android/internal/policy/PhoneWindow.java class PhoneWindow extends Window { DecorView mDecor; ViewGroup mContentParent; //1. åˆ›å»ºDecorViewå¯¹è±¡ //2. å°†å¼€å‘è€…è®¾ç½®çš„è§†å›¾æ–‡ä»¶ä½œä¸ºå­Viewæ·»åŠ åˆ°mContentParent //3. é€šçŸ¥Activityä¸­onContentChangedæ–¹æ³• void setContentView(View view) { mDecor = generateDecor(); mContentParent = generateLayout();//çœ‹generateLayoutæ–¹æ³•çš„æ³¨é‡Š mContentParent.addView(view);//å°†å¼€å‘è€…è®¾ç½®çš„è§†å›¾æ·»åŠ ä¸ºå­View getCallback().onContentChanged();//å›è°ƒActivityä¸­onContentChanged()æ–¹æ³• } //åˆ›å»ºä¸€ä¸ªç©ºçš„DecorViewï¼Œä¹Ÿå°±æ˜¯FrameLayoutï¼Œé‡Œé¢å•¥ä¹Ÿæ²¡æœ‰ void generateDecor() { return new DecorView(this); } //1. æ ¹æ®ä¸åŒä¸»é¢˜è®¾ç½®ä¸åŒå¸ƒå±€æ–‡ä»¶ï¼ŒåŠ è½½è¯¥å¸ƒå±€æ–‡ä»¶å¹¶è®¾ç½®æˆDecorViewçš„å­View //2. è¿”å›å­Viewä¸­idä¸ºcontentçš„ViewGroupï¼Œé€šå¸¸è¿˜æ˜¯ä¸ªFrameLayout //ä»¥ä¸Šä¸¤æ­¥æ‰§è¡Œå®Œæˆä»¥åï¼ŒDecorViewçš„å¸ƒå±€å˜æˆï¼š //&lt;FrameLayout&gt;//DecorViewçš„æ ¹å¸ƒå±€ // &lt;LinearLayout&gt;//å¼€å‘è€…è®¾ç½®å¸¦æœ‰ActionBarçš„ä¸»é¢˜ï¼Œæ³¨æ„ï¼Œè¿™é‡Œçš„è§†å›¾å¯å˜çš„ï¼Œæ ¹æ®ä¸»é¢˜æ¥é€‰æ‹©ä¸åŒçš„è§†å›¾ // &lt;ActionBar/&gt; // &lt;FrameLayout // android:id=&quot;@android:id/content&quot;/&gt;//è¿™é‡Œçš„FrameLayoutæ‰æ˜¯æœ€ç»ˆåŒ…å«å¼€å‘è€…åœ¨setContentViewä¸­è®¾ç½®çš„å¸ƒå±€ // &lt;/LinearLayout&gt; //&lt;/FrameLayout&gt; void generateLayout() { //åŠ è½½ä¸åŒçš„themeä¸»é¢˜çš„å¸ƒå±€æ–‡ä»¶ï¼Œæ¯”å¦‚æˆ‘ä»¬åœ¨xmlä¸­æŒ‡å®šandroid:theme=@style/NoActionBar View root = inflater.inflate(layoutResource); //å°†ä¸Šä¸€æ­¥è§£æçš„è§†å›¾ä½œä¸ºæ ¹å¸ƒå±€æ·»åŠ åˆ°DecorViewï¼Œå¸¸è§çš„æ¯”å¦‚å‚ç›´æ–¹å‘çš„LinearLayoutï¼Œè¿™æ ·å¸ƒå±€DecorView mDecor.addView(root); //æ‰¾åˆ°ç”¨æ¥è£…ç”¨æˆ·è§†å›¾çš„ViewGroupï¼Œé€šå¸¸è¿˜æ˜¯ä¸ªFrameLayout ViewGroup contentParent = mDecor.findViewById(R.id.content); return contentParent; } } //è‡ªèº«æ— é€»è¾‘ï¼Œå¯ä»¥è·³è¿‡ /frameworks/base/core/java/com/android/internal/policy/DecorView.java class DecorView extends FrameLayout { //DecorViewå’ŒPhoneWindowäº’ç›¸æŒæœ‰ï¼Œè¿™ä»£ç å†™çš„ï¼Œå•§å•§å•§ PhoneWindow mWindow; DecorView(PhoneWindow window){ mWindow = window; } } //å®šä¹‰Viewæ“ä½œæ¥å£ï¼Œé¡¶çº§æ¥å£ /frameworks/base/core/java/android/view/ViewManager.java public interface ViewManager { public void addView(); public void updateViewLayout(); public void removeView(); } //å•¥ä¹Ÿä¸æ˜¯ /frameworks/base/core/java/android/view/WindowManager.java public interface WindowManager extends ViewManager { } //WindowManagerçš„æœ€ç»ˆå®ç° /frameworks/base/core/java/android/view/WindowManagerImpl.java public class WindowManagerImpl implements WindowManager { WindowManagerGlobal mGlobal = WindowManagerGlobal.getInstance(); void addView(View decorView) { mGlobal.addView(decorView); } } //å…¨å±€å•ä¾‹ï¼Œå’ŒWMSå»ºç«‹è¿æ¥é€šä¿¡ï¼Œä¹Ÿæ˜¯APPè¿›ç¨‹ä¸­ï¼Œæ‰€æœ‰çª—å£å®é™…çš„ç®¡ç†è€… //å†…éƒ¨mViewså’ŒmRootså˜é‡ä¿å­˜ç€æ‰€æœ‰åˆ›å»ºçš„Activityå¯¹åº”çš„Viewå’ŒViewRootImpl class WindowManagerGlobal { List&lt;View&gt; mViews; List&lt;ViewRootImpl&gt; mRoots; void addView(View decorView){ ViewRootImpl root = new ViewRootImpl(decorView); mViews.add(decorView); mRoots.add(root); // do this last because it fires off messages to start doing things root.setView(view); } } //å¯¹åº”ä¸€ä¸ªActivityï¼Œå…³äºè§†å›¾çš„äº‹ä»¶è§¦å‘éƒ½åœ¨æ­¤ //1. Choreographerè®©å®ƒèƒ½å¤Ÿæ„ŸçŸ¥äº‹ä»¶ //2. ä¿å­˜DecorViewè®©å®ƒèƒ½å¤Ÿåœ¨äº‹ä»¶æ¥ä¸´æ—¶æ§åˆ¶è§†å›¾ //3. Surfaceè®©å®ƒæ‹¥æœ‰ç»˜å›¾çš„èƒ½åŠ› class ViewRootImpl { Choreographer mChoreographer;//æ„é€ å‡½æ•°ä¸­è¢«åˆ›å»º View mView;//ä¿å­˜DecorView final Surface mSurface = new Surface(); public ViewRootImpl(){ //å¯ä»¥æ„ŸçŸ¥VSyncçš„åŸå› å¯ä»¥è¿½æº¯åˆ°libguiåº“ä¸­çš„DisplayEventReceiverç±» mChoreographer = Choreographer.getInstance(); } //1. è¯·æ±‚VSyncä¿¡å·ï¼Œç­‰å¾…VSyncæ¥ä¸´åç»˜å›¾ //2. åˆ›å»ºbinderä»£ç†å¯¹è±¡ä¼ é€’ç»™wmsï¼Œæ­¤åwmså°†é€šè¿‡æ­¤ä»£ç†å¯¹è±¡æ¥é€šçŸ¥APPè¿›ç¨‹åº”è¯¥åšä»€ä¹ˆäº‹ void setView(View decorView){ mView = decorView;//å°†DecorViewä¿å­˜åˆ°ViewRootImplçš„æˆå‘˜å˜é‡mViewä¸­ requestLayout();//è¯·æ±‚VSyncä¿¡å· //é€šè¿‡binderå‘wmsæ·»åŠ çª—å£ res = mWindowSession.addToDisplay(); } } APPæ•´ä¸ªå¯åŠ¨è¿‡ç¨‹å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸‰æ­¥ï¼š åˆ›å»ºActivityå¹¶è°ƒç”¨setContentView()ç»‘å®šè§†å›¾ è¯·æ±‚VSyncä¿¡å· è¿›å…¥ç¡çœ  ç­‰å¾…VSyncä¿¡å·å”¤é†’ æˆ‘ä»¬å…ˆæ¥çœ‹ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºActivityå¹¶è°ƒç”¨setContentView()ç»‘å®šè§†å›¾ åˆ›å»ºActivity åœ¨Androidå¼€å‘ä¸­ï¼Œç¬¬ä¸€æ­¥æ°¸è¿œéƒ½æ˜¯è®¾ç½®è§†å›¾ï¼Œè€Œè®¾ç½®è§†å›¾ä¸å¤–ä¹äºä¸¤ç§æ–¹å¼ï¼šxmlæ–‡ä»¶å’ŒJavaç¼–ç  ä¸ç®¡ä½¿ç”¨å“ªç§æ–¹å¼ï¼Œéƒ½éœ€è¦è°ƒç”¨setContentView()æ–¹æ³•å°†è§†å›¾ç»‘å®šåˆ°Activityå½“ä¸­ ç»è¿‡ä¸€ç³»åˆ—çš„æ–¹æ³•è°ƒç”¨ï¼Œæœ€ç»ˆä¼šæ‰§è¡Œåˆ°ViewRootImpl.setView()æ–¹æ³•å°†è§†å›¾åŒæ­¥ç»™WMS åˆ›å»ºActivityçš„è¿‡ç¨‹ä¸­è¦ä¾èµ–ä¸‰ä¸ªå…³é”®çš„å¯¹è±¡ï¼šWindowã€DecorViewã€ViewRootImplï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§è¿™ä¸‰ä¸ªå¯¹è±¡æŠŠåˆ›å»ºActivityä¹Ÿåˆ†æˆäº†ä¸‰ä¸ªé˜¶æ®µï¼š 1ã€Windowå¯¹è±¡çš„åˆ›å»º 2ã€DecorViewçš„åˆ›å»º 3ã€ViewRootImplçš„åˆ›å»º 1. Windowçš„åˆ›å»º /frameworks/base/core/java/android/app/ActivityThread.java class ActivityThread { //zygoteè¿›ç¨‹forkæˆåŠŸåè°ƒç”¨å…¥å£å‡½æ•° void main(){ Looper.prepareMainLooper(); attach();//attachæ–¹æ³•å’Œamså»ºç«‹è¿æ¥ï¼Œæä¾›ç»™amsæ§åˆ¶å››å¤§ç»„ä»¶çš„å¥æŸ„ Looper.loop(); } //åˆ†ä¸¤æ­¥è§£é‡Šæ›´å®¹æ˜“ç†è§£ //1. ä¸ç®¡æ˜¯ä»æ¡Œé¢ç‚¹å‡»å›¾æ ‡è¿›å…¥è¿˜æ˜¯adbå‘½ä»¤å¯åŠ¨ï¼Œæœ€ç»ˆéƒ½äº¤ç”±amså‘é€å¯åŠ¨è¯·æ±‚ç»™zygoteè¿›ç¨‹ï¼Œæ¥ç€zygoteå­µåŒ–å‡ºè¯¥APPè¿›ç¨‹è°ƒç”¨mainæ–¹æ³• //2. APPè¿›ç¨‹å¯åŠ¨å°†åˆ›å»ºApplicationThreadå¯¹è±¡ï¼Œå¹¶å‘èµ·IPCæŠŠæ­¤å¯¹è±¡ä¼ é€’ç»™amsï¼Œæ­¤åå››å¤§ç»„ä»¶ç›¸å…³å›åˆ°éƒ½å°†æœ‰ApplicationThreadå¯¹è±¡è´Ÿè´£ï¼Œæœ€ç»ˆè½¬å‘ç»™Hç±»æ‰§è¡Œ void attach() { //è·å–amsä»£ç†å¹¶å°†ApplicationThreadå°†ç»™amsï¼Œè¿™ä¸ªå¯¹è±¡ä»¥åå°†æ˜¯amsçš„ä¼ å£°ç­’ IActivityManager mgr = ActivityManagerNative.getDefault(); mgr.attachApplication(new ApplicationThread()); } //ApplicationThreadNativeå°è£…ä¸€ç³»åˆ—çš„å…³äºå››å¤§ç»„ä»¶å›è°ƒæ–¹æ³•çš„è·¨è¿›ç¨‹é€šä¿¡å‘½ä»¤ //ApplicationThreadå¯¹è±¡æ‰€æœ‰æ“ä½œå‡ ä¹éƒ½ç”±AMSå‘èµ·è°ƒç”¨ class ApplicationThread extends ApplicationThreadNative { void scheduleLaunchActivity(){ handleMessage(LAUNCH_ACTIVITY); } } class H extends Handler { //è½¬å‘æ¥è‡ªApplicationThreadçš„æ¶ˆæ¯ void handleMessage(Message msg) { case LAUNCH_ACTIVITY::handleLaunchActivity(); case RESUME_ACTIVITY::handleResumeActivity(); } //è½¬å‘æ¥è‡ªhandleMessageçš„æ¶ˆæ¯ void handleLaunchActivity(){ performLaunchActivity(); handleResumeActivity(); } //æ‰§è¡Œåˆ›å»ºActivityå¯¹è±¡å¹¶å›è°ƒç”Ÿå‘½å‘¨æœŸ Activity performLaunchActivity(){ Activity activity = new Activity(); activity.attach();//å›è°ƒattach activity.onCreate();//å›è°ƒActivity return activity; } } } /frameworks/base/core/java/android/app/Activity.java class Activity { Window mWindow;//Activityé¦–æ¬¡è¢«åˆ›å»ºè°ƒç”¨attach()æ–¹æ³•æ—¶åŒæ­¥åˆ›å»ºï¼Œåˆ›å»ºåŠ¨ä½œåœ¨Activity WindowManager mWindowManager;//åœ¨attachæ–¹æ³•ä¸­è¢«åˆ›å»º //1. åˆ›å»ºPhoneWindowä¿å­˜åˆ°å˜é‡mWindowï¼Œæ­¤æ—¶çš„Windowè¿˜æ²¡æœ‰Viewè§†å›¾ //2. è·å–wmsä»£ç†å¯¹è±¡ï¼Œå¡åˆ°åˆšåˆšåˆ›å»ºçš„windowå¯¹è±¡å½“ä¸­ï¼ŒåŒæ—¶ä¿å­˜åˆ°æœ¬åœ°mWindowManagerå˜é‡ void attach(Window window){ mWindow = new PhoneWindow(this, window); mWindow.setWindowManager(getSystemService(Context.WINDOW_SERVICE)); mWindowManager = mWindow.getWindowManager();//è·å–WindowManageråŠ¨ä½œåœ¨Activityä¸­ï¼Œè·å–å®Œæˆæ¥ç€è®¾ç½®ç»™è‡ªå·±çš„å±€éƒ¨å˜é‡ } //è‡³æ­¤ï¼ŒAPPè¿›ç¨‹å¯åŠ¨æˆåŠŸï¼Œç¬¬ä¸€é˜¶æ®µç»“æŸï¼Œå‡†å¤‡è¿›å…¥ç¬¬äºŒé˜¶æ®µ void onCreate(){ setContentView(); } } ApplicationThreadä½œä¸ºAMSæ§åˆ¶æ‰‹æŸ„ï¼Œæ¥å—åˆ°å¯åŠ¨Activityçš„æŒ‡ä»¤åä¼šè½¬å‘åˆ°H#handleMessage()æ–¹æ³•ï¼Œæœ€ç»ˆç”±ActivityThread#handleMessage()æ–¹æ³•æ‰§è¡Œæ¥åˆ›å»ºActivityå¯¹è±¡ Activityå¯¹è±¡åˆ›å»ºå®Œæˆä»¥åï¼Œç´§æ¥ç€å°±ä¼šè°ƒç”¨Activityçš„attach()æ–¹æ³• åœ¨Activityçš„attach()æ–¹æ³•å®Œæˆçš„å·¥ä½œä¸­ï¼Œæœ€é‡è¦çš„å°±æ˜¯ï¼šåˆ›å»ºäº†ç±»å‹ä¸ºPhoneWindowçš„Windowå®ä¾‹å¯¹è±¡ 2. DecorViewçš„åˆ›å»º åœ¨ActivityThreadä¸­ï¼Œè°ƒç”¨å®Œattach()æ–¹æ³•åç´§æ¥ç€å°±ä¼šè°ƒç”¨Activity#onCreate()æ–¹æ³• å¼€å‘è€…é€šå¸¸ä¼šåœ¨onCreate()æ–¹æ³•ä¸­è°ƒç”¨setContentView()æ¥è®¾ç½®è§†å›¾æ–‡ä»¶ è¿™å°±è¿›å…¥åˆ°ç¬¬äºŒä¸ªé˜¶æ®µï¼šDecorViewçš„åˆ›å»º /frameworks/base/core/java/android/app/ActivityThread.java class ActivityThread { //æ‰§è¡Œåˆ›å»ºActivityå¯¹è±¡å¹¶å›è°ƒç”Ÿå‘½å‘¨æœŸ Activity performLaunchActivity(){ Activity activity = new Activity(); activity.attach();//å›è°ƒattach activity.onCreate();//å›è°ƒActivity return activity; } } /frameworks/base/core/java/android/app/Activity.java class Activity { Window mWindow;//Activityé¦–æ¬¡è¢«åˆ›å»ºè°ƒç”¨attach()æ–¹æ³•æ—¶åŒæ­¥åˆ›å»ºï¼Œåˆ›å»ºåŠ¨ä½œåœ¨Activity WindowManager mWindowManager;//åœ¨attachæ–¹æ³•ä¸­è¢«åˆ›å»º //ç¬¬äºŒé˜¶æ®µå¼€å§‹ï¼šåŠ è½½è§†å›¾æ–‡ä»¶å¹¶ç»‘å®šåˆ°DecorView void setContentView(View view) { mWindow.setContentView(view); } //ç¬¬äºŒé˜¶æ®µå·²ç»å®Œæˆï¼Œå‡†å¤‡è¿›å…¥ç¬¬ä¸‰é˜¶æ®µ void onContentChanged(){ } } /frameworks/base/core/java/com/android/internal/policy/PhoneWindow.java class PhoneWindow extends Window { DecorView mDecor; ViewGroup mContentParent; //1. åˆ›å»ºDecorViewå¯¹è±¡ //2. å°†å¼€å‘è€…è®¾ç½®çš„è§†å›¾æ–‡ä»¶ä½œä¸ºå­Viewæ·»åŠ åˆ°mContentParent //3. é€šçŸ¥Activityä¸­onContentChangedæ–¹æ³• void setContentView(View view) { mDecor = generateDecor(); mContentParent = generateLayout();//çœ‹generateLayoutæ–¹æ³•çš„æ³¨é‡Š mContentParent.addView(view);//å°†å¼€å‘è€…è®¾ç½®çš„è§†å›¾æ·»åŠ ä¸ºå­View getCallback().onContentChanged();//å›è°ƒActivityä¸­onContentChanged()æ–¹æ³• } //åˆ›å»ºä¸€ä¸ªç©ºçš„DecorViewï¼Œä¹Ÿå°±æ˜¯FrameLayoutï¼Œé‡Œé¢å•¥ä¹Ÿæ²¡æœ‰ void generateDecor() { return new DecorView(this); } //1. æ ¹æ®ä¸åŒä¸»é¢˜è®¾ç½®ä¸åŒå¸ƒå±€æ–‡ä»¶ï¼ŒåŠ è½½è¯¥å¸ƒå±€æ–‡ä»¶å¹¶è®¾ç½®æˆDecorViewçš„å­View //2. è¿”å›å­Viewä¸­idä¸ºcontentçš„ViewGroupï¼Œé€šå¸¸è¿˜æ˜¯ä¸ªFrameLayout //ä»¥ä¸Šä¸¤æ­¥æ‰§è¡Œå®Œæˆä»¥åï¼ŒDecorViewçš„å¸ƒå±€å˜æˆï¼š //&lt;FrameLayout&gt;//DecorViewçš„æ ¹å¸ƒå±€ // &lt;LinearLayout&gt;//å¼€å‘è€…è®¾ç½®å¸¦æœ‰ActionBarçš„ä¸»é¢˜ï¼Œæ³¨æ„ï¼Œè¿™é‡Œçš„è§†å›¾å¯å˜çš„ï¼Œæ ¹æ®ä¸»é¢˜æ¥é€‰æ‹©ä¸åŒçš„è§†å›¾ // &lt;ActionBar/&gt; // &lt;FrameLayout // android:id=&quot;@android:id/content&quot;/&gt;//è¿™é‡Œçš„FrameLayoutæ‰æ˜¯æœ€ç»ˆåŒ…å«å¼€å‘è€…åœ¨setContentViewä¸­è®¾ç½®çš„å¸ƒå±€ // &lt;/LinearLayout&gt; //&lt;/FrameLayout&gt; void generateLayout() { //åŠ è½½ä¸åŒçš„themeä¸»é¢˜çš„å¸ƒå±€æ–‡ä»¶ï¼Œæ¯”å¦‚æˆ‘ä»¬åœ¨xmlä¸­æŒ‡å®šandroid:theme=@style/NoActionBar View root = inflater.inflate(layoutResource); //å°†ä¸Šä¸€æ­¥è§£æçš„è§†å›¾ä½œä¸ºæ ¹å¸ƒå±€æ·»åŠ åˆ°DecorViewï¼Œå¸¸è§çš„æ¯”å¦‚å‚ç›´æ–¹å‘çš„LinearLayoutï¼Œè¿™æ ·å¸ƒå±€DecorView mDecor.addView(root); //æ‰¾åˆ°ç”¨æ¥è£…ç”¨æˆ·è§†å›¾çš„ViewGroupï¼Œé€šå¸¸è¿˜æ˜¯ä¸ªFrameLayout ViewGroup contentParent = mDecor.findViewById(R.id.content); return contentParent; } } //è‡ªèº«æ— é€»è¾‘ï¼Œå¯ä»¥è·³è¿‡ /frameworks/base/core/java/com/android/internal/policy/DecorView.java class DecorView extends FrameLayout { //DecorViewå’ŒPhoneWindowäº’ç›¸æŒæœ‰ PhoneWindow mWindow; DecorView(PhoneWindow window){ mWindow = window; } } //å®šä¹‰Viewæ“ä½œæ¥å£ï¼Œé¡¶çº§æ¥å£ /frameworks/base/core/java/android/view/ViewManager.java public interface ViewManager { public void addView(); public void updateViewLayout(); public void removeView(); } //å•¥ä¹Ÿä¸æ˜¯ /frameworks/base/core/java/android/view/WindowManager.java public interface WindowManager extends ViewManager { } //WindowManagerçš„æœ€ç»ˆå®ç° /frameworks/base/core/java/android/view/WindowManagerImpl.java public class WindowManagerImpl implements WindowManager { WindowManagerGlobal mGlobal = WindowManagerGlobal.getInstance(); void addView(View decorView) { mGlobal.addView(decorView); } } //å…¨å±€å•ä¾‹ï¼Œå’ŒWMSå»ºç«‹è¿æ¥é€šä¿¡ï¼Œä¹Ÿæ˜¯APPè¿›ç¨‹ä¸­ï¼Œæ‰€æœ‰çª—å£å®é™…çš„ç®¡ç†è€… //å†…éƒ¨mViewså’ŒmRootså˜é‡ä¿å­˜ç€æ‰€æœ‰åˆ›å»ºçš„Activityå¯¹åº”çš„Viewå’ŒViewRootImpl class WindowManagerGlobal { List&lt;View&gt; mViews; List&lt;ViewRootImpl&gt; mRoots; void addView(View decorView){ ViewRootImpl root = new ViewRootImpl(decorView); mViews.add(decorView); mRoots.add(root); // do this last because it fires off messages to start doing things root.setView(view); } } æˆ‘ä»¬éƒ½çŸ¥é“DecorViewæ˜¯é¡¶çº§Viewï¼Œè€Œä¸”å®ƒè‡ªèº«æ˜¯ä¸ªFrameLayoutï¼Œæ‰€ä»¥åœ¨mWindow#setContentView()ä¸­ç¬¬ä¸€æ­¥å°±æ˜¯å°†DecorViewå¯¹è±¡åˆ›å»ºå‡ºæ¥ åˆ›å»ºå®ŒDecorViewåï¼Œæ¥ç€ä¼šåŠ è½½Activityä½¿ç”¨çš„ä¸»é¢˜æ–‡ä»¶ï¼Œå¹¶ä¸”å°†è¯¥ä¸»é¢˜ä½œä¸ºå­Viewæ·»åŠ åˆ°DecorViewï¼Œè¿™ä¸ªå­Viewå°±æ˜¯mContentParent æœ‰äº†mContentParentï¼Œæœ€åæ‰æ˜¯å°†æˆ‘ä»¬è®¾ç½®çš„è§†å›¾æ·»åŠ ä¸ºmContentParentçš„å­View ç¨å¾®æœ‰ç‚¹ç»•ï¼Œç®€å•æ¥è¯´DecorViewä½œä¸ºä¸€ä¸ªFrameLayoutï¼Œé€šå¸¸å†…éƒ¨ä¼šå†åŒ…å«ä¸€ä¸ªå­Viewï¼šmContentParent mContentParentä¸­ï¼Œä¼šæœ‰ä¸€ä¸ªåä¸ºR.id.contentçš„FrameLayoutï¼Œè¿™ä¸ªé‡Œé¢æ‰æ˜¯åŒ…å«æˆ‘ä»¬è®¾ç½®çš„è§†å›¾ void setContentView(View view) { //&lt;FrameLayout&gt;//DecorViewçš„æ ¹å¸ƒå±€ // &lt;LinearLayout&gt;//å¼€å‘è€…è®¾ç½®å¸¦æœ‰ActionBarçš„ä¸»é¢˜ï¼Œæ³¨æ„ï¼Œè¿™é‡Œçš„è§†å›¾å¯å˜çš„ï¼Œæ ¹æ®ä¸»é¢˜æ¥é€‰æ‹©ä¸åŒçš„è§†å›¾ // &lt;ActionBar/&gt; // &lt;FrameLayout // android:id=&quot;@android:id/content&quot;/&gt;//è¿™ä¸ªFrameLayoutæ‰æ˜¯æœ€ç»ˆåŒ…å«å¼€å‘è€…åœ¨setContentViewä¸­è®¾ç½®çš„å¸ƒå±€ // &lt;/LinearLayout&gt; //&lt;/FrameLayout&gt; mDecor = generateDecor(); mContentParent = generateLayout();//çœ‹generateLayoutæ–¹æ³•çš„æ³¨é‡Š mContentParent.addView(view);//å°†å¼€å‘è€…è®¾ç½®çš„è§†å›¾æ·»åŠ ä¸ºå­View getCallback().onContentChanged();//å›è°ƒActivityä¸­onContentChanged()æ–¹æ³• } æŠŠå¼€å‘è€…è®¾ç½®çš„è§†å›¾æ·»åŠ ä¸ºå­Viewçš„ä¸‹ä¸€æ­¥æ˜¯å›è°ƒActivityä¸­onContentChanged()æ–¹æ³• å½“æˆ‘ä»¬åœ¨Activityæ”¶åˆ°onContentChanged()å›è°ƒçš„è¿™ä¸€åˆ»ï¼Œè¯´æ˜DecorViewå·²ç»åˆ›å»ºå®Œæˆ 3. ViewRootImplçš„åˆ›å»º ç¬¬ä¸€é˜¶æ®µå’Œç¬¬äºŒé˜¶æ®µåˆ†åˆ«è®©æˆ‘ä»¬æ‹¥æœ‰äº†ä¸€ä¸ªWindowå¯¹è±¡å’Œä¸€ä¸ªDecorViewå¯¹è±¡ Windowå¯¹è±¡ä¸­åŒ…å«äº†DecorViewå¯¹è±¡ï¼ŒDecorViewåŒ…å«äº†æˆ‘ä»¬è®¾ç½®çš„è§†å›¾æ–‡ä»¶ æ¥ä¸‹æ¥çš„ä»»åŠ¡å°±æ˜¯æŠŠè¯¥Windowå¯¹è±¡ä¼ é€’ç»™WMS å’Œå‰ä¸¤ä¸ªé˜¶æ®µä¸åŒçš„æ˜¯ï¼Œç¬¬ä¸‰é˜¶æ®µæ˜¯åœ¨Activityçš„onResume()å›è°ƒä¸­è¢«è§¦å‘çš„ åœ¨ActivityThreadé€šçŸ¥å®ŒonResume()çš„ä¸‹ä¸€æ­¥è°ƒç”¨äº†makeVisible()æ–¹æ³• makeVisible()æ–¹æ³•ä¸­ï¼Œå°†ä¼šè°ƒç”¨WindowManager#addView(mDecor)å°†è§†å›¾ä¼ é€’ç»™WMS /frameworks/base/core/java/android/app/ActivityThread.java class ActivityThread { void handleResumeActivity(){ performResumeActivity() activity.makeVisible();//å¼€å§‹æ‰§è¡Œç¬¬ä¸‰ä¸ªé˜¶æ®µ } //æ‰§è¡Œå›è°ƒç”Ÿå‘½å‘¨æœŸ void performResumeActivity(){ activity.onResume(); } } /frameworks/base/core/java/android/app/Activity.java class Activity { //ç¬¬ä¸‰é˜¶æ®µå¼€å§‹ï¼šå°†è§†å›¾ä¼ é€’ç»™wms //makeVisible()åœ¨ActivityThread.H.handleResumeActivity()æ–¹æ³•ä¸­è¢«è°ƒç”¨ void makeVisible() { mWindowManager.addView(mDecor); } } //WindowManagerçš„æœ€ç»ˆå®ç° /frameworks/base/core/java/android/view/WindowManagerImpl.java public class WindowManagerImpl implements WindowManager { WindowManagerGlobal mGlobal = WindowManagerGlobal.getInstance(); void addView(View decorView) { mGlobal.addView(decorView); } } //å…¨å±€å•ä¾‹ï¼Œå’ŒWMSå»ºç«‹è¿æ¥é€šä¿¡ï¼Œä¹Ÿæ˜¯APPè¿›ç¨‹ä¸­ï¼Œæ‰€æœ‰çª—å£å®é™…çš„ç®¡ç†è€… //å†…éƒ¨mViewså’ŒmRootså˜é‡ä¿å­˜ç€æ‰€æœ‰åˆ›å»ºçš„Activityå¯¹åº”çš„Viewå’ŒViewRootImpl /frameworks/base/core/java/android/view/WindowManagerGlobal.java class WindowManagerGlobal { List&lt;View&gt; mViews; List&lt;ViewRootImpl&gt; mRoots; void addView(View decorView){ ViewRootImpl root = new ViewRootImpl(decorView); mViews.add(decorView); mRoots.add(root); // do this last because it fires off messages to start doing things root.setView(view); } } //å¯¹åº”ä¸€ä¸ªActivityï¼Œå…³äºè§†å›¾çš„äº‹ä»¶è§¦å‘éƒ½åœ¨æ­¤ //1. Choreographerè®©å®ƒèƒ½å¤Ÿæ„ŸçŸ¥äº‹ä»¶ //2. ä¿å­˜DecorViewè®©å®ƒèƒ½å¤Ÿåœ¨äº‹ä»¶æ¥ä¸´æ—¶æ§åˆ¶è§†å›¾ //3. Surfaceè®©å®ƒæ‹¥æœ‰ç»˜å›¾çš„èƒ½åŠ› /frameworks/base/core/java/android/view/ViewRootImpl.java class ViewRootImpl { Choreographer mChoreographer;//æ„é€ å‡½æ•°ä¸­è¢«åˆ›å»º View mView;//ä¿å­˜DecorView final Surface mSurface = new Surface(); public ViewRootImpl(){ //å¯ä»¥æ„ŸçŸ¥VSyncçš„åŸå› å¯ä»¥è¿½æº¯åˆ°libguiåº“ä¸­çš„DisplayEventReceiverç±» mChoreographer = Choreographer.getInstance(); } //1. è¯·æ±‚VSyncä¿¡å·ï¼Œç­‰å¾…VSyncæ¥ä¸´åç»˜å›¾ //2. åˆ›å»ºbinderä»£ç†å¯¹è±¡ä¼ é€’ç»™wmsï¼Œæ­¤åwmså°†é€šè¿‡æ­¤ä»£ç†å¯¹è±¡æ¥é€šçŸ¥APPè¿›ç¨‹åº”è¯¥åšä»€ä¹ˆäº‹ void setView(View decorView){ mView = decorView;//å°†DecorViewä¿å­˜åˆ°ViewRootImplçš„æˆå‘˜å˜é‡mViewä¸­ requestLayout();//è¯·æ±‚VSyncä¿¡å· //é€šè¿‡binderå‘wmsæ·»åŠ çª—å£ res = mWindowSession.addToDisplay(); } } WindowManagerImplæ˜¯WindowManagerçš„æœ€ç»ˆå®ç°ç±»ï¼Œå®ƒä¼šè°ƒç”¨åˆ°WindowManagerGlobal#addView()æ–¹æ³• è€ŒWindowManagerGlobalæ˜¯å…¨å±€å•ä¾‹ï¼Œæ¯ä¸ªè¿›ç¨‹æœ‰ä¸”åªæœ‰ä¸€ä¸ªï¼Œä¹Ÿå°±æ˜¯è¯´ æ‰€æœ‰çš„Activityå¯¹åº”çš„Windowéƒ½ç”±WindowManagerGlobalè¿›è¡Œç®¡ç† å› æ­¤ï¼ŒWindowManagerGlobalä¼šæœ‰ä¸¤ä¸ªå…³é”®é›†åˆï¼šmViewså’ŒmRoots mViewsæ˜¯ä¿ç®¡ç€çš„DecorViewçš„é›†åˆï¼ŒmRootsæ˜¯ä¿ç®¡ç€ViewRootImplçš„é›†åˆ ä¿ç®¡ç€ViewRootImplçš„é›†åˆï¼ŸDecorViewæ˜¯æ¯ä¸ªActivityçš„è·Ÿè§†å›¾ï¼ŒViewRootImplæ˜¯ä»€ä¹ˆï¼Ÿ //å¯¹åº”ä¸€ä¸ªActivityï¼Œå…³äºè§†å›¾çš„äº‹ä»¶è§¦å‘éƒ½åœ¨æ­¤ //1. Choreographerè®©å®ƒèƒ½å¤Ÿæ„ŸçŸ¥äº‹ä»¶ //2. ä¿å­˜DecorViewè®©å®ƒèƒ½å¤Ÿåœ¨äº‹ä»¶æ¥ä¸´æ—¶æ§åˆ¶è§†å›¾ //3. Surfaceè®©å®ƒæ‹¥æœ‰ç»˜å›¾çš„èƒ½åŠ› /frameworks/base/core/java/android/view/ViewRootImpl.java class ViewRootImpl { Choreographer mChoreographer;//æ„é€ å‡½æ•°ä¸­è¢«åˆ›å»º View mView;//ä¿å­˜DecorView final Surface mSurface = new Surface(); public ViewRootImpl(){ //å¯ä»¥æ„ŸçŸ¥VSyncçš„åŸå› å¯ä»¥è¿½æº¯åˆ°libguiåº“ä¸­çš„DisplayEventReceiverç±» mChoreographer = Choreographer.getInstance(); } } çœ‹çœ‹ViewRootImplç±»ä¸­çš„ä¸‰ä¸ªæˆå‘˜å˜é‡ï¼š mViewï¼šDecorViewè®©ViewRootImplèƒ½å¤Ÿåœ¨äº‹ä»¶æ¥ä¸´æ—¶æ§åˆ¶è§†å›¾ mSurfaceï¼šè®©Activityæ‹¥æœ‰ç»˜å›¾çš„èƒ½åŠ› mChoreographerï¼šè®©ViewRootImplèƒ½å¤Ÿç›‘å¬VSyncä¿¡å· ç‹ç‚¸ï¼ï¼ï¼ä¸€ä¸ªç±»å‡ ä¹é›†é½äº†æ‰€æœ‰ä¸è§†å›¾ç›¸å…³çš„æˆå‘˜ æˆ‘ä»¬æ¥ç€å¾€ä¸‹è·Ÿï¼š /frameworks/base/core/java/android/view/WindowManagerGlobal.java class WindowManagerGlobal { List&lt;ViewRootImpl&gt; mRoots; void addView(View decorView){ ViewRootImpl root = new ViewRootImpl(decorView); mRoots.add(root); root.setView(view); } } /frameworks/base/core/java/android/view/ViewRootImpl.java class ViewRootImpl { //1. è¯·æ±‚VSyncä¿¡å·ï¼Œç­‰å¾…VSyncæ¥ä¸´åç»˜å›¾ //2. åˆ›å»ºbinderä»£ç†å¯¹è±¡ä¼ é€’ç»™wmsï¼Œæ­¤åwmså°†é€šè¿‡æ­¤ä»£ç†å¯¹è±¡æ¥é€šçŸ¥APPè¿›ç¨‹åº”è¯¥åšä»€ä¹ˆäº‹ void setView(View decorView){ mView = decorView;//å°†DecorViewä¿å­˜åˆ°ViewRootImplçš„æˆå‘˜å˜é‡mViewä¸­ requestLayout();//è¯·æ±‚VSyncä¿¡å· //é€šè¿‡binderå‘wmsæ·»åŠ çª—å£ï¼Œè¿™ä¸ªæ–¹æ³•èƒŒååˆæ˜¯ä¸€å¤§å †æ–¹æ³•è°ƒç”¨ï¼Œè¿™é‡Œä¸å±•å¼€è®¨è®º res = mWindowSession.addToDisplay(); } } WindowManagerGlobalåˆ›å»ºäº†ViewRootImplå¯¹è±¡åï¼ŒæŠŠå®ƒä¿å­˜åˆ°æœ¬åœ°é›†åˆmRoots æ¥ç€è°ƒç”¨ViewRootImpl#setView()æ–¹æ³•æ·»åŠ è§†å›¾ï¼ŒsetView()ä¸­åˆè°ƒç”¨addToDisplay()æ–¹æ³•é€šè¿‡binderå‘WMSæ·»åŠ çª—å£ è‡³æ­¤ï¼ŒWindowå¯¹è±¡çš„åˆ›å»ºã€DecorViewçš„åˆ›å»ºå’ŒViewRootImplçš„åˆ›å»ºè¿™ä¸‰å¤§é˜¶æ®µå…¨éƒ¨å®Œæˆ æˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹åœ¨åˆ›å»ºActivityé˜¶æ®µå‘ç”Ÿçš„äº‹æƒ… å›¾ç‰‡æ¥æºï¼šè‡ªå·±ç”»çš„ Activityä¸­ï¼Œåˆ›å»ºPhoneWindowç±»å‹çš„Windowå¯¹è±¡ Windowä¸­ï¼Œåˆ›å»ºDecorViewå¯¹è±¡ï¼Œç»‘å®šsetContentViewä¼ å…¥çš„è§†å›¾æ–‡ä»¶ è°ƒç”¨WindowManageræ·»åŠ è§†å›¾ï¼Œå‡†å¤‡æŠŠè§†å›¾ç»‘å®šåˆ°WMS åˆ›å»ºViewRootImplä½œä¸ºæœ€ç»ˆçš„æ‰§è¡Œè€…ï¼Œå°†è§†å›¾æ·»åŠ WMS è¯·æ±‚VSyncä¿¡å· åœ¨è§†å›¾ç›¸å…³çš„å¯¹è±¡åˆ›å»ºå°±ç»ªåï¼ŒAPPå¼€å§‹æ­£å¼è¯·æ±‚VSyncä¿¡å· é¦–æ¬¡è¯·æ±‚VSyncä¿¡å·çš„åŠ¨ä½œæ˜¯åœ¨ViewRootImpl#setView()æ–¹æ³•ä¸­è§¦å‘çš„ /frameworks/base/core/java/android/view/ViewRootImpl.java class ViewRootImpl { void setView(View decorView){ requestLayout();//è¯·æ±‚VSyncä¿¡å· } void requestLayout() { scheduleTraversals(); } //è¯·æ±‚VSyncï¼Œç­‰å¾…åˆ·æ–° void scheduleTraversals() { //1. å‘é€åŒæ­¥å±éšœæ¶ˆæ¯çš„æ„ä¹‰åœ¨äºï¼Œä¿è¯VSyncä¿¡å·åˆ°æ¥æ—¶ï¼Œç¬¬ä¸€æ—¶é—´æ‰§è¡ŒViewRootImpl.doTraversal()æ–¹æ³• mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();//åˆ›å»ºä¸€ä¸ªåŒæ­¥å±éšœï¼ˆè¯¦è§Androidæ¶ˆæ¯æœºåˆ¶ï¼‰ //2. å‘é€ä¸€æ¡å¼‚æ­¥æ¶ˆæ¯ï¼ŒmTraversalRunnableæ˜¯å¤„ç†è¿™æ¡æ¶ˆæ¯çš„å›è°ƒ mChoreographer.postCallback(Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, null); } final TraversalRunnable mTraversalRunnable = new TraversalRunnable(); class TraversalRunnable implements Runnable { public void run() { //æ‰§è¡Œç»˜åˆ¶æµç¨‹ doTraversal(); } } } setView()æ–¹æ³•ä¸­è°ƒç”¨äº†requestLayout()æ–¹æ³•ï¼Œæ¥ç€è°ƒç”¨scheduleTraversals()æ–¹æ³•è¿›è¡ŒVSyncä¿¡å·çš„è¯·æ±‚ æˆ‘ä»¬åœ¨å¼€å‘è¿‡ç¨‹ä¸­è°ƒç”¨çš„View#invalidate()/requestLayout()è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œæœ€ç»ˆä¹Ÿéƒ½ä¼šè°ƒç”¨åˆ°ViewRootImpl#scheduleTraversals()æ–¹æ³•è¯·æ±‚VSyncä¿¡å· æˆ‘ä»¬æ¥çœ‹çœ‹scheduleTraversals()é‡Œé¢éƒ½åšäº†äº›ä»€ä¹ˆï¼Ÿ 1ã€å‘ä¸»çº¿ç¨‹å‘é€ä¸€ä¸ªåŒæ­¥å±éšœæ¶ˆæ¯ 2ã€é€šè¿‡Choreographeræäº¤ç±»å‹ä¸ºCALLBACK_TRAVERSALçš„Runnable ä¸€æ˜¯å‘ä¸»çº¿ç¨‹ä¸­çš„æ¶ˆæ¯é˜Ÿåˆ—å‘é€ä¸€æ¡åŒæ­¥æ¶ˆæ¯ï¼Œå‘é€åŒæ­¥å±éšœæ¶ˆæ¯çš„æ„ä¹‰åœ¨äºï¼Œä¿è¯VSyncä¿¡å·åˆ°æ¥æ—¶ï¼Œç¬¬ä¸€æ—¶é—´æ‰§è¡ŒViewRootImpl#doTraversal()æ–¹æ³• äºŒæ˜¯æäº¤äº†mTraversalRunnableï¼Œå¦‚æœVSyncä¿¡å·åˆ°æ¥åå°†ä¼šè¢«æ‰§è¡Œï¼ŒmTraversalRunnableå†…éƒ¨å°è£…çš„æ˜¯doTraversal()æ–¹æ³•ç”¨äºæ‰§è¡Œç»˜åˆ¶æµç¨‹ è¿›å…¥ç¡çœ  ç­‰å¾…å”¤é†’ å½“è¯·æ±‚ä¿¡å·å‘å‡ºä»¥åï¼ŒAPPè¿›ç¨‹å°±è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œç­‰å¾…VSyncå‘ç”Ÿ /frameworks/base/core/java/android/app/ActivityThread.java class ActivityThread { //zygoteè¿›ç¨‹forkæˆåŠŸåè°ƒç”¨å…¥å£å‡½æ•° void main(){ Looper.loop(); } } Choreographerè¿è¡Œåœ¨ä¸»çº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯ActivityThreadæ‰€åœ¨çš„çº¿ç¨‹ï¼Œå®ƒä»¬å…±ç”¨ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ— æ‰€ä»¥ï¼ŒVSyncè¯·æ±‚æœ€ç»ˆé˜»å¡åœ¨ActivityThread#main()æ–¹æ³•ä¸­ ä¸‰ã€å¤„ç†VSyncä¿¡å· ä¸‡äº‹ä¿±å¤‡ï¼Œåªæ¬ ä¸œé£ï¼ŒAPPè¿›ç¨‹ç­‰å¾…ç€VSyncä¿¡å·çš„åˆ°æ¥ï¼ŒSFè¿›ç¨‹åˆ™éœ€è¦å†ç­‰ä¸€æ®µæ—¶é—´ 1ã€APPè¿›ç¨‹ï¼šç»˜åˆ¶ä¸‰éƒ¨æ›² VSyncä»¥å¼‚æ­¥æ¶ˆæ¯çš„èº«ä»½è¢«å‘é€åˆ°ä¸»çº¿ç¨‹æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¯¥æ¶ˆæ¯å¤„ç†è€…ä¸ºChoreographerä¸­çš„mHandlerå¯¹è±¡ ç»è¿‡å¤„ç†ä»¥åï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ°ViewRootImpl#doTraversal()æ–¹æ³•æ‰§è¡Œç»˜åˆ¶ï¼Œä¹Ÿå°±æ˜¯Viewç»˜åˆ¶ä¸‰éƒ¨æ›²ï¼šmeasureã€layoutã€draw /frameworks/base/core/java/android/view/ViewRootImpl.java class ViewRootImpl { View mView;//ä¿å­˜DecorView //å¼€å§‹ç»˜åˆ¶ void doTraversal() { mHandler.getLooper().getQueue().removeSyncBarrier(mTraversalBarrier);//ç§»é™¤åŒæ­¥å±éšœ //ç”±äºåŒæ­¥å±éšœæ¶ˆæ¯è¢«ç§»é™¤ï¼Œæ‰€ä»¥viewçš„ç»˜åˆ¶å·¥ä½œå’Œä¸»çº¿ç¨‹çš„æ¶ˆæ¯å¤„ç†æ˜¯ä¸€èµ·åœ¨æ‰§è¡Œçš„ performTraversals();//Viewçš„ç»˜åˆ¶èµ·ç‚¹ } //ç»˜å›¾ä¸‰éƒ¨æ›² void performTraversals(){ relayoutWindow();//å‘sfæ­£å¼ç”³è¯·surfaceï¼Œåœ¨è¿›å…¥ç»˜å›¾ä¹‹å‰ä¸ºAPPè¿›ç¨‹å‡†å¤‡å¥½ä¸€å—surfaceå†…å­˜ mAttachInfo.mHardwareRenderer.initialize(mSurface); performMeasure();//Ask host how big it wants to be performLayout(); performDraw(); } void performMeasure(){ mView.measure(); } void performLayout(){ mView.layout(); } void performDraw(){ mView.draw(); mAttachInfo.mHardwareRenderer.draw(mView, mAttachInfo, this); } //åˆ›å»ºsurface //viewrootimplæŒæœ‰çš„surfaceæ˜¯Javaå¯¹è±¡ï¼Œå¹¶æ²¡æœ‰åœ¨nativeåˆ›å»ºå¯¹åº”çš„surface //ä¸è¿‡è¿™ä¸€äº›å¯¹äºAPPè¿›ç¨‹æ¥è¯´æ˜¯æ— æ„Ÿçš„ï¼ŒAPP-&gt;WMS-&gt;SF-&gt;WMS-&gt;APPï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­APP //åœ¨æ­¤æ–¹æ³•ä¸­ï¼Œè°ƒç”¨wmsä¸ºå…¶åˆ›å»ºnativeå±‚çš„surfaceå¯¹è±¡ï¼Œåœ¨surfaceåˆ›å»ºçš„è¿‡ç¨‹ä¸­ï¼Œä¼šé€šçŸ¥sfè¿›ç¨‹ï¼Œsfè¿›ç¨‹ä¸ºsurfaceåˆ›å»ºå¯¹åº”çš„layerï¼Œåˆ›å»ºlayerçš„è¿‡ç¨‹ä¸­ï¼Œåˆä¼šåˆå§‹åŒ–BufferQueueå¯¹è±¡ //surfaceä¸­åŒ…å«bufferqueueï¼Œæ‰€ä»¥sfè¿›ç¨‹é™¤äº†ä¸ºsurfaceåˆ›å»ºlayerï¼Œè¿˜ä¼šä¸ºsurfaceåˆ›å»ºé˜Ÿåˆ—ç›‘å¬ï¼Œå½“æœ‰æ–°çš„è§†å›¾å˜åŒ–ï¼Œsfè¿›ç¨‹å°†ä¼šæ”¶åˆ°onFrameAvaliable()å›è°ƒ int relayoutWindow(){ } } åœ¨å¼€å§‹ç»˜å›¾ä¹‹å‰ï¼ŒViewRootImplè¿˜åšäº†ä¸¤ä»¶äº‹ ä¸€æ˜¯ç§»é™¤åŒæ­¥å±éšœæ¶ˆæ¯ï¼ŒViewçš„ç»˜åˆ¶æµç¨‹æ‰§è¡Œç»“æŸåï¼Œè®©æˆ‘ä»¬å¼€å‘è€…postçš„æ¶ˆæ¯å¾—ä»¥æ‰§è¡Œ äºŒæ˜¯è°ƒç”¨äº†relayoutWindow()æ–¹æ³•ï¼Œå‘sfæ­£å¼ç”³è¯·Surfaceï¼Œåœ¨è¿›å…¥ç»˜å›¾ä¹‹å‰ä¸ºAPPè¿›ç¨‹å‡†å¤‡å¥½ä¸€å—Surfaceå†…å­˜ å¥½äº†ï¼Œæ¥ä¸‹æ¥æ­£å¼æ‰§è¡Œç»˜å›¾æµç¨‹ View#onMeasure() performMeasure()æ–¹æ³•ä¸­è°ƒç”¨äº†View#measure() ViewRootImplæˆå‘˜å˜é‡mViewä¿å­˜çš„æ˜¯DecorViewå¯¹è±¡ï¼Œæ‰€ä»¥ï¼Œmeasure()æ–¹æ³•å°†ä¼šä»è·Ÿè§†å›¾ä¸€å±‚å±‚å‘ä¸‹éå† /frameworks/base/core/java/android/view/ViewRootImpl.java class ViewRootImpl { View mView;//ä¿å­˜DecorView void performMeasure(){ mView.measure(); } } åœ¨éå†æ•´ä¸ªViewæ ‘çš„è¿‡ç¨‹ä¸­ï¼Œä¼šå‡ºç°å¤šæ¬¡éå†æ‰èƒ½ç¡®å®šViewå¤§å°çš„æƒ…å†µï¼Œå°¤å…¶å¯¹äºViewGoupæ¥è¯´ï¼Œå–å†³äºæµ‹é‡æ¨¡å¼å’ŒLayoutParamsé…ç½®ç­‰å‚æ•° åœ¨æœ¬ç« èŠ‚æˆ‘ä»¬éœ€è¦äº†è§£ï¼šmeasure()æ–¹æ³•æ˜¯ä¸ºäº†è®¡ç®—æ¯ä¸€ä¸ªViewéœ€è¦çš„å¤§å°ï¼Œmeasure()æ–¹æ³•æ‰§è¡Œå®Œæˆä»¥åï¼Œå„ä¸ªViewçš„å¤§å°ä¹Ÿéƒ½ç¡®å®šäº† Viewçš„ç»˜åˆ¶æˆ‘æ‰“ç®—å¦èµ·ä¸€ç¯‡æ–‡ç« ä»‹ç»ï¼Œæ‰€ä»¥å…³äºonMeasure()ç»†èŠ‚éƒ¨åˆ†ï¼Œæ¯”å¦‚æµ‹è¯•æ¨¡å¼touchModeä»¥åŠç„¦ç‚¹çš„å¤„ç†ç­‰ï¼Œè¿™é‡Œæš‚æ—¶ä¸å±•å¼€ï¼Œä¹‹åçš„layoutå’Œdrawä¹Ÿéƒ½ä¼šä¸€ç¬”å¸¦è¿‡ View#onLayout() performLayout()æ–¹æ³•ä¸­è°ƒç”¨äº†View#layout() /frameworks/base/core/java/android/view/ViewRootImpl.java class ViewRootImpl { View mView;//ä¿å­˜DecorView void performLayout(){ mView.layout(); } } ä¸Šä¸€å°èŠ‚measureæ‰§è¡Œå®Œä»¥åï¼Œç¡®å®šäº†å„ä¸ªViewçš„å¤§å° åœ¨æœ¬ç« èŠ‚ä¸­ï¼Œlayout()æ–¹æ³•æ˜¯ä¸ºäº†è®¡ç®—æ¯ä¸€ä¸ªViewçš„ä½ç½®ï¼Œlayout()æ–¹æ³•æ‰§è¡Œå®Œæˆä»¥åï¼Œå„ä¸ªViewçš„ä½ç½®ä¹Ÿéƒ½ç¡®å®šäº† View#onDraw() performDraw()æ–¹æ³•ä¸­è°ƒç”¨äº†View#draw() drawæ˜¯æœ€ç»ˆç»˜åˆ¶çš„é˜¶æ®µï¼Œåœ¨Viewä½“ç³»ä¸­ï¼Œæ‰€æœ‰çš„ç»˜å›¾æ“ä½œéƒ½åœ¨drawé˜¶æ®µå¾—åˆ°æ‰§è¡Œ /frameworks/base/core/java/android/view/ViewRootImpl.java class ViewRootImpl { View mView;//ä¿å­˜DecorView void performDraw(){ mView.draw(); } } åœ¨æ‰§è¡ŒView#draw()æ—¶ï¼Œé€»è¾‘ä¼šå’Œmeasureã€layoutè¿‡ç¨‹æœ‰ä¸€ç‚¹ç‚¹ä¸ä¸€æ · measureè¿‡ç¨‹å’Œlayoutè¿‡ç¨‹éƒ½æ˜¯å‘ç”Ÿåœ¨CPUï¼Œdrawä¸åŒï¼Œå¦‚æœå¼€å¯ç¡¬ä»¶åŠ é€Ÿï¼Œé‚£ä¹ˆdrawçš„è¿‡ç¨‹å‘ç”Ÿåœ¨GPU å¹¶ä¸”ï¼ŒAndroid 5.0ç‰ˆæœ¬åŠ å…¥äº†RenderThreadï¼Œå¼€å¯ç¡¬ä»¶åŠ é€Ÿåï¼Œåœ¨æ‰§è¡Œdrawçš„è¿‡ç¨‹ä¸­ï¼ŒAndroidå°†å•ç‹¬å¯åŠ¨ä¸€ä¸ªæ¸²æŸ“çº¿ç¨‹æ¥æ‰§è¡Œç»˜åˆ¶ä»»åŠ¡ ä¸è¿‡å¯¹äºå¼€å‘è€…æ¥è¯´ï¼Œè¿™ä¸€åˆ‡æ˜¯æ— æ„Ÿçš„ /frameworks/base/core/java/android/view/View.java class View { /** * This method is called by ViewGroup.drawChild() to have each child view draw itself. * * This is where the View specializes rendering behavior based on layer type, * and hardware acceleration. */ boolean draw(Canvas canvas, ViewGroup parent, long drawingTime) { final boolean hardwareAcceleratedCanvas = canvas.isHardwareAccelerated(); /* If an attached view draws to a HW canvas, it may use its RenderNode + DisplayList. * * If a view is dettached, its DisplayList shouldn't exist. If the canvas isn't * HW accelerated, it can't handle drawing RenderNodes. */ } } å…³äºRenderThreadèµ„æ–™å¹¶ä¸å¤šï¼Œæˆ‘ä»¬åªèƒ½ä»æºç æ³¨é‡Šä¸­çœ‹çœ‹èƒ½å¦å¾—åˆ°ä¸€äº›æœ‰ç”¨çš„ä¿¡æ¯ï¼Œå¦‚ä¸Šæ–‡ å¦‚æœå¯ç”¨ç¡¬ä»¶åŠ é€Ÿï¼Œæ­¤æ—¶æ¯ä¸€æ­¥ç»˜å›¾æ“ä½œéƒ½å°†ä»¥RenderNodeçš„å½¢å¼ä¿å­˜åˆ°DisplayList ç„¶ååŒæ­¥ç»™RenderThreadæ‰§è¡Œå®é™…çš„æ¸²æŸ“å·¥ä½œ å¦‚æœå…³é—­ç¡¬ä»¶åŠ é€Ÿï¼Œåœ¨onDraw()é˜¶æ®µViewå°†ä¼šç›´æ¥è°ƒç”¨Canvas APIç”»å›¾ï¼Œæ­¤æ—¶çš„æ¸²æŸ“å·¥ä½œæ‰§è¡Œåœ¨UIçº¿ç¨‹ å¯ç”¨æ¸²æŸ“çº¿ç¨‹çš„å¥½å¤„ç½‘ä¸Šå€’æ˜¯æœ‰ç°æˆçš„èµ„æ–™ï¼Œæˆ‘ç»™å¤§å®¶å¿µä¸€å¿µï¼š æ˜¾ç¤ºåˆ—è¡¨å¯ä»¥æ ¹æ®éœ€è¦ç»˜åˆ¶ä»»æ„å¤šæ¬¡ï¼Œæ— éœ€è¿›ä¸€æ­¥ä¸ä¸šåŠ¡é€»è¾‘äº¤äº’ å¯ä»¥å¯¹æ•´ä¸ªåˆ—è¡¨è¿›è¡ŒæŸäº›æ“ä½œï¼ˆå¦‚å¹³ç§»ã€ç¼©æ”¾ç­‰ï¼‰ï¼Œè€Œæ— éœ€é‡æ–°å‘å‡ºä»»ä½•ç»˜å›¾æ“ä½œ ä¸€æ—¦çŸ¥é“æ‰€æœ‰çš„ç»˜å›¾æ“ä½œï¼Œå°±å¯ä»¥å¯¹å…¶è¿›è¡Œä¼˜åŒ–ï¼šä¾‹å¦‚ï¼Œæ‰€æœ‰æ–‡æœ¬åœ¨å¯èƒ½çš„æƒ…å†µä¸‹ä¸€æ¬¡ç»˜åˆ¶åœ¨ä¸€èµ· æ˜¾ç¤ºåˆ—è¡¨çš„å¤„ç†å¯èƒ½ä¼šè¢«åˆ†å‘åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œ æ¥è‡ªäºï¼šã€ŠUnderstanding the RenderThreadã€‹ æˆ‘ä¸ªäººç†è§£ä¸‹æ¥å•ç‹¬å¯ç”¨æ¸²æŸ“çº¿ç¨‹æœ‰ä¸¤å¤§å¥½å¤„ï¼š ä¸€æ˜¯å»é™¤é‡å¤ç»˜å›¾æŒ‡ä»¤ï¼Œæ¯”å¦‚å¤šæ¬¡setTextåªä¿ç•™æœ€åä¸€æ¬¡ äºŒæ˜¯å‡è½»UIçº¿ç¨‹å‹åŠ›ï¼Œä¸€æ—¦ç»˜å›¾æŒ‡ä»¤æ”¶é›†å®Œæˆï¼Œå°±å¯ä»¥åŒæ­¥ç»™æ¸²æŸ“çº¿ç¨‹æ‰§è¡Œï¼Œè¿™æ ·ä¸»çº¿ç¨‹å‰©ä½™çš„æ—¶é—´å°±å¯ä»¥ç”¨æ¥æ‰§è¡Œå…¶ä»–çš„æ¶ˆæ¯ï¼Œæ¯”å¦‚æˆ‘ä»¬postçš„æ¶ˆæ¯ ä¸è¿‡ï¼Œä¸ç®¡æœ‰æ²¡æœ‰å¼€å¯ç¡¬ä»¶åŠ é€Ÿï¼Œç»˜åˆ¶å·¥ä½œæ‰§è¡Œåœ¨å“ªä¸ªçº¿ç¨‹ï¼Œæ•´ä¸ªæ¸²æŸ“æµç¨‹è¿˜æ˜¯è¦æ§åˆ¶åœ¨ä¸€ä¸ªVSyncä¿¡å·å‘¨æœŸå†…å®Œæˆï¼Œå¦åˆ™ï¼Œè¯¥ä¸¢å¸§è¿˜æ˜¯ä¼šä¸¢å¸§ ç‰¹æ®Šæƒ…å†µï¼šSurfaceView åœ¨æ¸¸æˆå¼€å‘æˆ–å…¶ä»–éœ€è¦å±•ç¤º3Då›¾å½¢æ—¶ï¼Œå¤šæ•°æƒ…å†µæ˜¯ä½¿ç”¨SurfaceViewæ¥ç»˜åˆ¶ SurfaceViewä½œä¸ºDecorViewè·Ÿè§†å›¾çš„æˆå‘˜ä¹‹ä¸€ï¼Œå’Œæ™®é€šViewä¸€æ ·èƒ½å¤Ÿæ¥å—åˆ°Inputäº‹ä»¶ï¼ˆè¦†å†™onTouchEventæ–¹æ³•ï¼‰ ä¸è¿‡ï¼ŒSurfaceViewæœ‰æ™®é€šViewæ²¡æœ‰çš„èƒ½åŠ›ï¼šâ€œè‡ªä¸»ä¸Šå¸§â€çš„æƒåˆ© ä»€ä¹ˆâ€œè‡ªä¸»ä¸Šå¸§â€å‘¢ï¼Ÿ æˆ‘ä»¬éƒ½çŸ¥é“SurfaceViewæ‹¥æœ‰å•ç‹¬çš„ä¸€å—Surfaceï¼Œæ— è®ºæ˜¯ä½¿ç”¨Canvasè¿›è¡Œ2Då¼€å‘è¿˜æ˜¯OpenGL ESè¿›è¡Œ3Då¼€å‘ï¼Œæœ€ç»ˆçš„ç»˜åˆ¶ç»“æœéƒ½æ˜¯ä¿å­˜åœ¨è¿™å—å•ç‹¬çš„Surfaceä¸Š ç»˜åˆ¶å®Œæˆä»¥åï¼ŒSurfaceViewå¯ä»¥è°ƒç”¨unlockCanvasAndPost()/eglSwapBuffers()å°†GraphicBufferå…¥åˆ—ï¼Œæäº¤ç»™sfè¿›ç¨‹ç­‰å¾…åˆæˆé€æ˜¾ SurfaceViewè®©åº”ç”¨æ— éœ€ç­‰å¾…VSyncä¿¡å·çš„åˆ°æ¥ä¾¿å¯ä»¥æ‰§è¡Œç»˜åˆ¶å·¥ä½œï¼Œè¿™æ˜¯å®ƒå’Œæ™®é€šViewæœ€å¤§çš„åŒºåˆ« 2ã€SFè¿›ç¨‹ï¼šåˆæˆäº”éƒ¨æ›² æ— è®ºåº”ç”¨ä½¿ç”¨å“ªç§APIè¿›è¡Œå›¾å½¢å¼€å‘ï¼Œåœ¨ç»˜åˆ¶æµç¨‹ç»“æŸåï¼ŒAPPä½œä¸ºå›¾å±‚çš„ç”Ÿäº§è€…æ€»æ˜¯ä¼šè°ƒç”¨BufferQueue#queueBuffer()æ–¹æ³•å°†GraphicBufferå…¥åˆ— ä¸€æ—¦æœ‰æ–°çš„å›¾å±‚åŠ å…¥é˜Ÿåˆ—ï¼Œå°±æ„å‘³ç€ä½œä¸ºå›¾å±‚æ¶ˆè´¹è€…çš„SFè¿›ç¨‹å¯ä»¥å¼€å§‹å·¥ä½œäº† sfè¿›ç¨‹è¯·æ±‚VSync ç”±äºVSyncæ˜¯æ³¨å†Œåˆ¶ï¼Œå› æ­¤ï¼Œsfè¿›ç¨‹åœ¨å·¥ä½œä¹‹å‰å¿…é¡»å…ˆè¯·æ±‚VSyncä¿¡å· /frameworks/native/services/surfaceflinger/Layer.cpp class Layer { //å½“Surfaceå‘ç”Ÿå˜åŒ–ä»¥åï¼Œæœ€ç»ˆä¼šè°ƒç”¨onFrameAvailable()æ–¹æ³•é€šçŸ¥sfï¼Œè®©sfè¯·æ±‚ä¸‹ä¸€æ¬¡VSync //è¿™é‡Œéœ€è¦æ³¨æ„ï¼ŒVSyncä¿¡å·æ˜¯EventThreadæ¥åˆ†å‘çš„ï¼ŒAPPå’Œsfå„è‡ªç®¡ç†è‡ªå·±æ˜¯å¦éœ€è¦è¯·æ±‚ä¸‹ä¸€æ¬¡VSyncä¿¡å· void Layer::onFrameAvailable() { mFlinger-&gt;signalLayerUpdate(); } } /frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp class SurfaceFlinger { //queueå†…éƒ¨è°ƒç”¨äº†è¯·æ±‚ä¸‹ä¸€æ¬¡VSync void SurfaceFlinger::signalLayerUpdate() { mEventQueue.invalidate(); } } /frameworks/native/services/surfaceflinger/MessageQueue.cpp class MessageQueue { //æœ€ç»ˆåœ¨MessageQueueç±»ä¸­æ‰§è¡Œäº†è¯·æ±‚VSyncä¿¡å·çš„æ“ä½œ void MessageQueue::invalidate() { mEvents-&gt;requestNextVSync(); } } å½“APPç«¯çš„Surfaceå‘ç”Ÿå˜åŒ–ä»¥åï¼ŒLayerçš„onFrameAvailable()æ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼Œç»è¿‡å±‚å±‚è½¬å‘ï¼Œæœ€ç»ˆç”±MessageQueue#requestNextVSync()æ‰§è¡ŒVSyncä¿¡å·çš„è¯·æ±‚ Layerè¿™ä¸ªç±»ä¹‹å‰å¥½åƒæ²¡æœ‰å‡ºç°è¿‡ï¼Œç®€å•ä»‹ç»ä¸€ä¸‹ï¼š APPè¿›ç¨‹ä¸­çš„æ¯ä¸€ä¸ªSurfaceå¯¹è±¡ï¼Œå¯¹åº”SFè¿›ç¨‹å½“ä¸­çš„ä¸€ä¸ªLayerå¯¹è±¡ï¼Œå®ƒä¿©å…±äº«ä¸€ä¸ªBufferQueue Surfaceä½œä¸ºå›¾å±‚çš„ç”Ÿäº§è€…ï¼Œå°è£…äº†å‡ºåˆ—å…¥åˆ—çš„æ“ä½œ Layerä½œä¸ºå›¾å±‚çš„æ¶ˆè´¹è€…ï¼Œå°è£…äº†è·å–æ¸²æŸ“å›¾å±‚å’Œé‡Šæ”¾å›¾å±‚çš„æ“ä½œ sfè¿›ç¨‹å¤„ç†VSync sfè¿›ç¨‹ä½¿ç”¨MessageQueueç±»æ‰§è¡Œäº†è¯·æ±‚VSyncä¿¡å·çš„åŠ¨ä½œï¼Œæ‰€ä»¥ï¼ŒVSyncä¿¡å·åˆ°æ¥åçš„å¤„ç†åŒæ ·ä¹Ÿæ˜¯åœ¨MessageQueueç±»ä¸­ /frameworks/native/services/surfaceflinger/MessageQueue.cpp class MessageQueue { //æ¥å—æ¥è‡ªDisplayEventReceiverçš„VSyncä¿¡å· int MessageQueue::eventReceiver(int /*fd*/, int /*events*/) { mHandler-&gt;dispatchInvalidate(); return 1; } //æ”¶åˆ°VSyncä¿¡å·åï¼Œå‘sfè¿›ç¨‹ä¸­å‘é€ç±»å‹ä¸º&quot;INVALIDATE&quot;çš„æ¶ˆæ¯ void MessageQueue::Handler::dispatchInvalidate() { mQueue.mLooper-&gt;sendMessage(this, Message(MessageQueue::INVALIDATE)); } //å¤–éƒ¨æ¥å£ï¼Œç”¨äºå‘sfå‘é€åˆæˆæ¶ˆæ¯ void MessageQueue::refresh() { mHandler-&gt;dispatchRefresh(); } //ç»™sfå‘é€ç±»å‹ä¸ºREFRESHçš„æ¶ˆæ¯ï¼Œsfæ”¶åˆ°ä»¥åå°†ä¼šæ‰§è¡Œåˆæˆæ“ä½œ void MessageQueue::Handler::dispatchRefresh() { mQueue.mLooper-&gt;sendMessage(this, Message(MessageQueue::REFRESH)); } } /frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp class SurfaceFlinger { void SurfaceFlinger::onMessageReceived(){ //æ¥æ”¶åˆ°VSyncä¿¡å·åï¼Œåˆ¤æ–­å›¾å±‚æ˜¯å¦éœ€è¦åˆæˆ case MessageQueue::INVALIDATE: { bool refreshNeeded = false; refreshNeeded = handleMessageTransaction(); refreshNeeded |= handleMessageInvalidate(); //å¦‚æœéœ€è¦åˆæˆï¼Œé€šçŸ¥MessageQueueå‘é€ä¸€æ¡REFRESHç±»å‹çš„æ¶ˆæ¯ if(refreshNeeded) signalRefresh(); } //å°†ä¼šæ‰§è¡Œæœ€ç»ˆçš„åˆæˆæ“ä½œ case MessageQueue::REFRESH: { handleMessageRefresh();//åˆæˆå¹¶è¾“å‡ºåˆ°å±å¹• } } //è°ƒç”¨mEventQueueç»™sfè‡ªå·±å‘é€ä¸€æ¡Refreshç±»å‹çš„æ¶ˆæ¯ void SurfaceFlinger::signalRefresh() { mEventQueue.refresh(); } } MessageQueue#eventReceiver()æ”¶åˆ°VSyncä¿¡å·åå‘é€INVALIDATEæ¶ˆæ¯ç»™sfè¿›ç¨‹ SurfaceFlinger##onMessageReceived()æ–¹æ³•è¢«è§¦å‘ åœ¨caseä¸ºINVALIDATEçš„æ–¹æ³•ä¸­ï¼Œè°ƒç”¨handleMessageTransaction()ã€handleMessageInvalidate()æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰§è¡Œä¸‹ä¸€æ­¥åˆæˆ å¦‚æœéœ€è¦æ‰§è¡Œåˆæˆï¼Œæœ€ç»ˆä¼šæ‰§è¡Œåˆ°SurfaceFlinger#handleMessageRefresh()æ–¹æ³• sfè¿›ç¨‹æ‰§è¡Œåˆæˆ ä¸€æ—¦è°ƒç”¨åˆ°handleMessageRefresh()æ–¹æ³•ï¼Œæ„å‘³ç€SFè¿›ç¨‹çš„åˆæˆå·¥ä½œæ­£å¼å¼€å§‹ æ•´ä¸ªåˆæˆæµç¨‹æœ‰äº”ä¸ªæ­¥éª¤ï¼Œæ‰€ä»¥å¯ä»¥å–åå«åšâ€œåˆæˆäº”éƒ¨æ›²â€ æ¥ä¸‹æ¥æˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹â€œåˆæˆäº”éƒ¨æ›²â€éƒ½åšäº†å“ªäº›äº‹æƒ…ï¼š /frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp class SurfaceFlinger { //åˆæˆäº”éƒ¨æ›² void SurfaceFlinger::handleMessageRefresh(){ //åˆæˆä¹‹å‰çš„ä¸å¤„ç†ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„å›¾å±‚å˜åŒ–ï¼Œå¦‚æœæœ‰ï¼Œæ‰§è¡Œè¯·æ±‚ä¸‹ä¸€æ¬¡VSyncä¿¡å· preComposition(); //è‹¥Layerçš„ä½ç½®/å…ˆåé¡ºåº/å¯è§æ€§å‘ç”Ÿå˜åŒ–ï¼Œé‡æ–°è®¡ç®—Layerçš„ç›®æ ‡åˆæˆåŒºåŸŸå’Œå…ˆåé¡ºåº rebuildLayerStacks(); //è°ƒç”¨hwcçš„prepareæ–¹æ³•è¯¢é—®æ¯ä¸ªå›¾å±‚æ˜¯å¦æ”¯æŒç¡¬ä»¶åˆæˆ setUpHWComposer(); //å½“æ‰“å¼€å¼€å‘è€…é€‰é¡¹ä¸­çš„â€œæ˜¾ç¤ºSurfaceåˆ·æ–°â€æ—¶ï¼Œé¢å¤–ä¸ºäº§ç”Ÿå˜åŒ–çš„å›¾å±‚ç»˜åˆ¶é—ªçƒåŠ¨ç”» doDebugFlashRegions(); //å¦‚æœä¸æ”¯æŒç¡¬ä»¶åˆæˆï¼Œåœ¨è¯¥æ–¹æ³•ä¸­ä¼šè°ƒç”¨GPUåˆæˆï¼Œæ¥ç€æäº¤buffer doComposition(); //è°ƒLayerçš„onPostCompositionæ–¹æ³•ï¼Œä¸»è¦ç”¨äºè°ƒè¯•ï¼Œå¯ä»¥å¿½ç•¥ postComposition(refreshStartTime); } void SurfaceFlinger::preComposition(){ bool needExtraInvalidate = false; const LayerVector&amp; layers(mDrawingState.layersSortedByZ); const size_t count = layers.size(); for (size_t i=0 ; i&lt;count ; i++) { //å› ä¸ºåœ¨è°ƒç”¨åˆæˆä¹‹å‰å·²ç»è®¡ç®—è¿‡è„åŒºåŸŸï¼Œå¦‚æœæœ‰å›¾å±‚åœ¨è®¡ç®—ä»¥ååŠ å…¥äº†é˜Ÿåˆ—ï¼Œé‚£ä¹ˆåœ¨é¢„å¤„ç†é˜¶æ®µè¦å†æ¬¡è¯·æ±‚VSyncä¿¡å· if (layers[i]-&gt;onPreComposition()) { needExtraInvalidate = true; } } //å­˜åœ¨æœªå¤„ç†çš„layerï¼Œæ‰§è¡Œè¯·æ±‚ä¸‹ä¸€æ¬¡VSyncä¿¡å·ï¼Œé¿å…è¿™æ®µæ—¶é—´å†…çš„å¸§æ•°æ®ä¸¢æ‰äº† if (needExtraInvalidate) { signalLayerUpdate(); } } void SurfaceFlinger::rebuildLayerStacks(){ //è·å–å½“å‰åº”ç”¨ç¨‹åºæ‰€æœ‰æŒ‰ç…§z-orderæ’åˆ—çš„layer const LayerVector&amp; layers(mDrawingState.layersSortedByZ); //éå†æ¯ä¸€ä¸ªæ˜¾ç¤ºå± for (size_t dpy=0 ; dpy&lt;mDisplays.size() ; dpy++) { //z-orderæ’åˆ—çš„layer hw-&gt;setVisibleLayersSortedByZ(layersSortedByZ); //æ˜¾ç¤ºå±å¤§å° hw-&gt;undefinedRegion.set(bounds); //å‡å»ä¸é€æ˜åŒºåŸŸ hw-&gt;undefinedRegion.subtractSelf(tr.transform(opaqueRegion)); //ç´¯åŠ è„åŒºåŸŸ hw-&gt;dirtyRegion.orSelf(dirtyRegion); } } void SurfaceFlinger::setUpHWComposer() { //prepareFrameæ–¹æ³•ä¸­è°ƒç”¨äº†HWComposer::prepareæ–¹æ³• for (size_t displayId = 0; displayId &lt; mDisplays.size(); ++displayId) { auto&amp; displayDevice = mDisplays[displayId]; if (!displayDevice-&gt;isDisplayOn()) { continue; } status_t result = displayDevice-&gt;prepareFrame(*mHwc); } } void SurfaceFlinger::doComposition(){ //éå†æ‰€æœ‰çš„DisplayDeviceç„¶åè°ƒç”¨doDisplayCompositionå‡½æ•° for (size_t dpy=0 ; dpy&lt;mDisplays.size() ; dpy++) { const sp&lt;DisplayDevice&gt;&amp; hw(mDisplays[dpy]); if (hw-&gt;isDisplayOn()) { //è·å¾—å±å¹•çš„è„åŒºåŸŸï¼Œå°†è„åŒºè½¬æ¢ä¸ºè¯¥å±å¹•çš„åº§æ ‡ç©ºé—´ const Region dirtyRegion(hw-&gt;getDirtyRegion(repaintEverything)); //åœ¨æ­¤æ–¹æ³•ä¸­å°†ä¼šè°ƒç”¨åˆ°doComposeSurfaces()æ–¹æ³• //åœ¨doComposeSurfacesæ–¹æ³•ä¸­ï¼Œå°†ä¼šä¸ºè¢«æ ‡è®°ä¸ºä¸æ”¯æŒç¡¬ä»¶åˆæˆçš„å›¾å±‚è°ƒç”¨Layer#draw()æ–¹æ³•ä½¿ç”¨OpenGL ESåˆæˆ doDisplayComposition(hw, dirtyRegion); } } postFramebuffer(); } //ç¬¬äº”æ­¥ï¼šæ›´æ–°DispSyncæœºåˆ¶ï¼Œè¯¦æƒ…å‚è§ void SurfaceFlinger::postComposition(){ //æ›´æ–°DispSyncæœºåˆ¶ï¼Œè¯¦æƒ…å‚è§ } } 1. preComposition() ç¬¬ä¸€æ­¥æ˜¯é¢„å¤„ç†é˜¶æ®µï¼Œè°ƒç”¨æ¯ä¸ªlayerçš„onPreComposition()æ–¹æ³•è¯¢é—®æ˜¯å¦éœ€è¦åˆæˆ /frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp class SurfaceFlinger { void SurfaceFlinger::preComposition(){ bool needExtraInvalidate = false; const LayerVector&amp; layers(mDrawingState.layersSortedByZ); const size_t count = layers.size(); for (size_t i=0 ; i&lt;count ; i++) { //å› ä¸ºåœ¨è°ƒç”¨åˆæˆä¹‹å‰å·²ç»è®¡ç®—è¿‡è„åŒºåŸŸï¼Œå¦‚æœæœ‰å›¾å±‚åœ¨è®¡ç®—ä»¥ååŠ å…¥äº†é˜Ÿåˆ—ï¼Œé‚£ä¹ˆåœ¨é¢„å¤„ç†é˜¶æ®µè¦å†æ¬¡è¯·æ±‚VSyncä¿¡å· if (layers[i]-&gt;onPreComposition()) { needExtraInvalidate = true; } } //å­˜åœ¨æœªå¤„ç†çš„layerï¼Œæ‰§è¡Œè¯·æ±‚ä¸‹ä¸€æ¬¡VSyncä¿¡å·ï¼Œé¿å…è¿™æ®µæ—¶é—´å†…çš„å¸§æ•°æ®ä¸¢æ‰äº† if (needExtraInvalidate) { signalLayerUpdate(); } } } ç¬¬ä¸€æ­¥æ‰§è¡Œå®Œä»¥åï¼Œæ ¹æ®needExtraInvalidateæ¥ç¡®å®šæ˜¯å¦æœ‰é—æ¼çš„å›¾å±‚ï¼Œå¦‚æœæœ‰å°±å†æ¬¡è¯·æ±‚VSyncä¿¡å·ï¼Œé¿å…ä¸¢å¤±å¸§æ•°æ® 2. rebuildLayerStacks() ç¬¬äºŒæ­¥ï¼šè®¡ç®—å„ä¸ªLayerçš„ç›®æ ‡åˆæˆåŒºåŸŸå’Œå…ˆåé¡ºåº /frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp class SurfaceFlinger { void SurfaceFlinger::rebuildLayerStacks(){ //è·å–å½“å‰åº”ç”¨ç¨‹åºæ‰€æœ‰æŒ‰ç…§z-orderæ’åˆ—çš„layer const LayerVector&amp; layers(mDrawingState.layersSortedByZ); //éå†æ¯ä¸€ä¸ªæ˜¾ç¤ºå± for (size_t dpy=0 ; dpy&lt;mDisplays.size() ; dpy++) { //z-orderæ’åˆ—çš„layer hw-&gt;setVisibleLayersSortedByZ(layersSortedByZ); //æ˜¾ç¤ºå±å¤§å° hw-&gt;undefinedRegion.set(bounds); //å‡å»ä¸é€æ˜åŒºåŸŸ hw-&gt;undefinedRegion.subtractSelf(tr.transform(opaqueRegion)); //ç´¯åŠ è„åŒºåŸŸ hw-&gt;dirtyRegion.orSelf(dirtyRegion); } } } ç¬¬äºŒæ­¥æ‰§è¡Œå®Œä»¥åï¼Œç¡®å®šäº†æ¯ä¸ªå›¾å±‚çš„å¯è§åŒºåŸŸå’Œè·Ÿå…¶ä»–å›¾å±‚å‘ç”Ÿé‡å éƒ¨åˆ†çš„è„åŒºåŸŸ 3. setUpHWComposer() ç¬¬ä¸‰æ­¥ï¼šæ›´æ–°HWComposerå¯¹è±¡ä¸­å›¾å±‚å¯¹è±¡åˆ—è¡¨ä»¥åŠå›¾å±‚å±æ€§ prepareFrame()æ–¹æ³•ä¸­è°ƒç”¨äº†HWComposer#prepareæ–¹æ³• åœ¨HWCçš„prepare()æ–¹æ³•ä¸­ï¼Œå°†ä¼šç¡®å®šæ¯ä¸€ä¸ªå›¾å±‚ä½¿ç”¨å“ªç§åˆæˆæ–¹å¼ /frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp class SurfaceFlinger { void SurfaceFlinger::setUpHWComposer() { //prepareFrameæ–¹æ³•ä¸­è°ƒç”¨äº†HWComposer::prepareæ–¹æ³• //åœ¨HWCçš„prepareæ–¹æ³•ä¸­ï¼Œå°†ä¼šç¡®å®šæ¯ä¸€ä¸ªå›¾å±‚ä½¿ç”¨å“ªç§åˆæˆæ–¹å¼ for (size_t displayId = 0; displayId &lt; mDisplays.size(); ++displayId) { auto&amp; displayDevice = mDisplays[displayId]; if (!displayDevice-&gt;isDisplayOn()) { continue; } status_t result = displayDevice-&gt;prepareFrame(*mHwc); } } } ç¬¬ä¸‰æ­¥æ‰§è¡Œå®Œä»¥åï¼Œç¡®å®šäº†æ¯ä¸ªå›¾å±‚çš„åˆæˆæ–¹å¼ 4. doComposition() ç¬¬å››æ­¥ï¼šæ‰§è¡ŒçœŸæ­£çš„åˆæˆå·¥ä½œ /frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp class SurfaceFlinger { void SurfaceFlinger::doComposition(){ //éå†æ‰€æœ‰çš„DisplayDeviceç„¶åè°ƒç”¨doDisplayCompositionå‡½æ•° for (size_t dpy=0 ; dpy&lt;mDisplays.size() ; dpy++) { const sp&lt;DisplayDevice&gt;&amp; hw(mDisplays[dpy]); if (hw-&gt;isDisplayOn()) { //è·å¾—å±å¹•çš„è„åŒºåŸŸï¼Œå°†è„åŒºè½¬æ¢ä¸ºè¯¥å±å¹•çš„åº§æ ‡ç©ºé—´ const Region dirtyRegion(hw-&gt;getDirtyRegion(repaintEverything)); //åœ¨æ­¤æ–¹æ³•ä¸­å°†ä¼šè°ƒç”¨åˆ°doComposeSurfaces()æ–¹æ³• //åœ¨doComposeSurfacesæ–¹æ³•ä¸­ï¼Œå°†ä¼šä¸ºè¢«æ ‡è®°ä¸ºä¸æ”¯æŒç¡¬ä»¶åˆæˆçš„å›¾å±‚è°ƒç”¨Layer#draw()æ–¹æ³•ä½¿ç”¨OpenGL ESåˆæˆ doDisplayComposition(hw, dirtyRegion); } } postFramebuffer(); } } ç¬¬å››æ­¥æ‰§è¡Œå®Œä»¥åï¼Œå®Œæˆäº†ä¸¤ä»¶äº‹ï¼š å°†ä¸æ”¯æŒç¡¬ä»¶åˆæˆçš„å›¾å±‚è¿›è¡ŒGPUåˆæˆ åœ¨doComposeSurfaces()æ–¹æ³•ä¸­ï¼Œå°†ä¼šä¸ºè¢«æ ‡è®°ä¸ºä¸æ”¯æŒç¡¬ä»¶åˆæˆçš„å›¾å±‚è°ƒç”¨Layer#draw()æ–¹æ³•ä½¿ç”¨OpenGL ESåˆæˆ è°ƒç”¨postFramebuffer()è¿›è¡Œé€æ˜¾ postFramebuffer()æ–¹æ³•ä¼šå°†GPUåˆæˆåçš„å›¾å±‚å’Œéœ€è¦HWCåˆæˆçš„å›¾å±‚ä¸€èµ·æ‰“åŒ…æäº¤ç»™HWC HWCæœ€ç»ˆä¼šè°ƒç”¨DRMæ¡†æ¶è¿›è¡Œé€æ˜¾ï¼Œå½“ä¸‹ä¸€æ¬¡ç¡¬ä»¶VSyncä¿¡å·å‘ç”Ÿæ—¶äº¤æ¢Framebuffer 5. postComposition() ç¬¬äº”æ­¥ï¼šé€æ˜¾ä¹‹åçš„å–„åå·¥ä½œ åœ¨Android 7.0ç‰ˆæœ¬ä¸­ï¼ŒpostComposition()æ–¹æ³•ç”¨æ¥æ‰§è¡Œæ›´æ­£DispSyncæ¨¡å‹ï¼Œå¯ä»¥å¿½ç•¥ /frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp class SurfaceFlinger { //ç¬¬äº”æ­¥ï¼šæ›´æ–°DispSyncæœºåˆ¶ï¼Œè¯¦æƒ…å‚è§ void SurfaceFlinger::postComposition(){ //æ›´æ–°DispSyncï¼Œè¯¦æƒ…å‚è§DispSyncæ¨¡å‹ä¸€èŠ‚ } } psï¼šå…³äºSFè¿›ç¨‹åˆæˆéƒ¨åˆ†çš„æºç ä¸æ–¹ä¾¿è°ƒè¯•ï¼Œæ‰€ä»¥è¿™é‡Œçš„ç»“è®ºæ²¡æœ‰å¾—åˆ°éªŒè¯ä¸ä¸€å®šå¯¹ å¦å¤–ï¼Œåˆæˆéƒ¨åˆ†å¤§å¤šæ•°å†…å®¹éƒ½æ¥è‡ªäº[è¿™é‡Œï¼Œè¯»è€…æœ‹å‹å¯ä»¥å»æŸ¥æ‰¾å…¶ä»–èµ„æ–™å­¦ä¹  3ã€å°ç»“ è‡³æ­¤ï¼ŒAPPç»˜åˆ¶å·¥ä½œå’ŒSFåˆæˆå·¥ä½œå·²ç»å…¨éƒ¨å®Œæˆï¼Œæˆ‘ä»¬æ¥ç”»å¼ å›¾æ€»ç»“ä¸€ä¸‹æœ¬ç« èŠ‚å†…å®¹ å›¾ç‰‡æ¥æºï¼šè‡ªå·±ç”»çš„ ä¸€ä¸ªAPPå®Œæ•´çš„æ˜¾ç¤ºæµç¨‹å¤§è‡´åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µ app-è¯·æ±‚ APPé¡µé¢å…ƒç´ ä¸€æ—¦å‘ç”Ÿå˜åŒ–ï¼Œè°ƒç”¨invalidate()/requestLayout()æ–¹æ³•è¯·æ±‚ä¸‹ä¸€æ¬¡VSyncä¿¡å·ï¼Œæ­¤æ—¶sfä»€ä¹ˆéƒ½ä¸åš app-VSync &amp; sf-è¯·æ±‚ app-VSyncä¿¡å·åˆ°æ¥åï¼ŒAPPè¿›ç¨‹æ‰§è¡Œç»˜å›¾ä¸‰éƒ¨æ›²ï¼Œ ç»˜å›¾æµç¨‹ç»“æŸåï¼Œsfæ”¶åˆ°onFrameAvailable()ï¼Œsfè¿›ç¨‹è¯·æ±‚VSync sf-VSync sf-VSyncä¿¡å·åˆ°æ¥ï¼Œsfè¿›ç¨‹æ‰§è¡Œåˆæˆäº”éƒ¨æ›²ï¼Œæ¥ç€å°†ç»“æœæäº¤ç»™hwc ç­‰å¾…ä¸‹æ¬¡ç¡¬ä»¶VSyncä¿¡å·å‘ç”Ÿï¼Œåˆ‡æ¢Framebufferå±•ç¤ºç»™ç”¨æˆ· å››ã€ç»“è¯­ æœ¬æ–‡æŠŠAndroidå›¾å½¢å­ç³»ç»Ÿåˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼šé™æ€éƒ¨åˆ†å’ŒåŠ¨æ€éƒ¨åˆ† åœ¨é™æ€éƒ¨åˆ†ä¸­ï¼Œç¡¬ä»¶é©±åŠ¨å’ŒGoogleç»„ä»¶åº“ä¸ºåº”ç”¨æä¾›äº†ç»˜å›¾çš„èƒ½åŠ› åœ¨åŠ¨æ€éƒ¨åˆ†ä¸­ï¼Œä»‹ç»äº†VSyncä¿¡å·æ˜¯å¦‚ä½•æŠŠç³»ç»Ÿæ‰“ç†çš„äº•äº•æœ‰æ¡çš„ï¼Œç€é‡åˆ†æäº†å„ä¸ªè¿›ç¨‹æ˜¯å¦‚ä½•è¯·æ±‚å’Œå¤„ç†VSyncä¿¡å· æœ‰äº†è¿™ä¸¤éƒ¨åˆ†çš„å†…å®¹ï¼Œæˆ‘ä»¬æ¥å°è¯•è§£ç­”ä¸€ä¸‹æ–‡ç« çš„æ ‡é¢˜ï¼šå½“æˆ‘ä»¬ç‚¹å‡»â€œå¾®ä¿¡â€è¿™ä¸ªåº”ç”¨åï¼Œå®ƒæ˜¯æ€ä¹ˆåœ¨å±å¹•ä¸Šæ˜¾ç¤ºå‡ºæ¥çš„ï¼Ÿ Launcherè¿›ç¨‹æ‹‰èµ·å¾®ä¿¡çš„é»˜è®¤å¯åŠ¨é¡µï¼šWeChatSplashActivity WeChatSplashActivityåŠ è½½è§†å›¾æ–‡ä»¶ï¼ŒAMSå’ŒWMSä¸ºActivityåˆ›å»ºDecorViewã€Windowã€ViewRoot è§†å›¾æ–‡ä»¶å‡†å¤‡å°±ç»ªï¼Œè¯·æ±‚VSyncä¿¡å· app-VSyncå¤„ç†ï¼Œæ‰§è¡Œç»˜åˆ¶ä¸‰éƒ¨æ›²ï¼Œç»˜åˆ¶ç»“æŸä»¥åï¼Œé€šçŸ¥sfè¿›ç¨‹ sfè¿›ç¨‹è¯·æ±‚VSyncä¿¡å· sf-VSyncå¤„ç†ï¼Œæ‰§è¡Œåˆæˆäº”éƒ¨æ›²ï¼Œæäº¤åˆ°hwc hw-VSyncåŸå§‹ä¿¡å·å¤„ç†ï¼Œæ˜¾ç¤ºæ¡†æ¶æ‰§è¡Œäº¤æ¢å›¾å±‚æ•°æ®ï¼Œç”¨æˆ·çœ‹åˆ°å¾®ä¿¡çš„å¯åŠ¨å›¾ æœ€åï¼Œæœ¬ç¯‡æ–‡ç« ä¹‹æ‰€ä»¥èƒ½å¤Ÿé¡ºåˆ©äº§ç”Ÿï¼Œå¾—ç›Šäºå„ä½å‰è¾ˆçš„æ— ç§åˆ†äº«ï¼ˆè§å‚è€ƒèµ„æ–™ï¼‰ å¸Œæœ›æœ¬æ–‡èƒ½å¤Ÿèµ·åˆ°æŠ›ç –å¼•ç‰çš„æ•ˆæœï¼Œç»™å„ä½è¯»è€…æœ‹å‹å¸¦æ¥ä¸€ç‚¹ç‚¹å¸®åŠ© å…¨æ–‡å®Œ äº”ã€å‚è€ƒèµ„æ–™ ã€Šæ·±å…¥ç†è§£Androidå†…æ ¸è®¾è®¡æ€æƒ³ã€‹- æ—å­¦æ£® ã€Šæ·±å…¥ç†è§£Android å·IIIã€‹- å¼ å¤§ä¼Ÿ ã€ŠWeishu's Notesã€‹- ç”°ç»´æœ¯ï¼ˆå¤ªæ/ä¸¤ä»ªä½œè€…ï¼‰ ã€ŠAndroidæ˜¾ç¤ºç³»åˆ—ã€‹- åŠªæ¯”äºšå›¢é˜Ÿ ã€ŠSystraceç³»åˆ—ã€‹- é«˜çˆ· ã€ŠAndroid 10 Display Systemæºç åˆ†æã€‹- ZHOUJINJIAN ã€ŠDRMä¸BufferQueueç³»åˆ—ã€‹- ä½•å°é¾™ ã€ŠAndroidå›¾å½¢æ˜¾ç¤ºç³»åˆ—ã€‹- å¤•é˜³å¹ ã€Šç‹å°äºŒçš„Androidç«™ã€‹- ç‹å°äºŒï¼ˆTCLç‹æ€»ï¼‰ ã€ŠSilence.Slow.Simpleä¸“æ ã€‹- simowce ã€ŠAndroid SurfaceFlinger å­¦ä¹ ä¹‹è·¯ã€‹- windrunnerlihuan ã€ŠAndroid 12(S) å›¾åƒæ˜¾ç¤ºç³»ç»Ÿã€‹- äºŒçš„æ¬¡æ–¹ æ·±å…¥ç†è§£Flutterçš„å›¾å½¢å›¾åƒç»˜åˆ¶åŸç† - OPPOæ•°æ™ºæŠ€æœ¯ Androidæ€§èƒ½ä¼˜åŒ–ï¼šå®šæ€§å’Œå®šä½Androidå›¾å½¢æ€§èƒ½é—®é¢˜ - é£èµ·æ¥_é£è¿‡æ¥ ","link":"https://yibaoshan.github.io/post/android-graphics-system/"},{"title":"Androidå›¾å½¢ç³»ç»Ÿï¼ˆäºŒï¼‰é©±åŠ¨ç¯‡ï¼šå‚ç›´åŒæ­¥åˆ°åº•è¦ä¸è¦å¼€ï¼Ÿ","content":" ç‚¹å‡»è·³è½¬åˆ°æ˜é‡‘é˜…è¯» å¯¹äºåº”ç”¨å¼€å‘å·¥ç¨‹å¸ˆæ¥è¯´ï¼Œè™½ç„¶æˆ‘ä»¬ä¸éœ€è¦å†™é©±åŠ¨ç¨‹åºï¼Œä½†æ˜¯äº†è§£Viewæœ€ç»ˆæ˜¯å¦‚ä½•æ˜¾ç¤ºåˆ°å±å¹•ä¸Šè¿˜æ˜¯éå¸¸æœ‰å¿…è¦çš„ æœ¬ç¯‡æ˜¯Androidå›¾å½¢ç³»åˆ—çš„ç¬¬äºŒç¯‡æ–‡ç« ï¼Œä¾æ—§æ˜¯ä¸€äº›å…³äºå±å¹•çš„åè¯è§£é‡Šï¼Œå’ŒAndroidç³»ç»Ÿæœ¬èº«æ²¡æœ‰å¤ªå¤§å…³ç³»ï¼Œç›¸è¾ƒäºç¬¬ä¸€ç¯‡æ–‡ç« ï¼Œæœ¬ç¯‡é‡ç‚¹åœ¨äºä»‹ç»â€œå±å¹•åˆ·æ–°â€å’Œâ€œå‚ç›´åŒæ­¥â€ç›¸å…³çš„çŸ¥è¯†ç‚¹ ä¸€ã€å¼€ç¯‡ å¹³æ—¶æ‰“æ¸¸æˆæ—¶ä¼šå‘ç°å±å¹•å¶å°”ä¼šå‡ºç°â€œç”»é¢æ’•è£‚â€çš„æƒ…å†µï¼Œå±å¹•çš„ä¸ŠåŠéƒ¨åˆ†å’Œä¸‹åŠéƒ¨åˆ†çš„ç”»é¢é”™å¼€äº† å›¾ç‰‡æ¥æºï¼šè‡ªå·±æ‹çš„ å»ç½‘ä¸Šæœç”»é¢æ’•è£‚æ€ä¹ˆåŠï¼Ÿæœ‰ç½‘å‹è¯´æ‰“å¼€æ¸¸æˆä¸­çš„â€œå‚ç›´åŒæ­¥â€é€‰é¡¹å¯ä»¥è§£å†³äº†ï¼Œä½†ä¹Ÿæœ‰ç½‘å‹è¯´ä¸è¦å¼€å‚ç›´åŒæ­¥ï¼Œå¼€äº†ä¹‹åæ˜¾å¡ä¼šè¢«â€œé”å¸§â€ï¼Œè¿˜ä¼šå¸¦æ¥å±å¹•ç”»é¢å»¶è¿Ÿï¼Œå¼Šå¤§äºåˆ© ä¸ºä»€ä¹ˆä¸¤è¾¹çš„å¯¹äºâ€œå‚ç›´åŒæ­¥â€çš„çœ‹æ³•ä¸ä¸€æ ·ï¼Ÿå‚ç›´åŒæ­¥åˆ°åº•æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼Ÿ æ›´åŠ è®©äººç–‘æƒ‘çš„æ˜¯ï¼šæ˜¾ç¤ºå™¨ä¸ºä»€ä¹ˆä¼šå‘ç”Ÿç”»é¢æ’•è£‚ï¼Ÿ è¿™ä¸€åˆ‡çš„ä¸€åˆ‡éƒ½å¾—ä»â€œåˆ·æ–°ç‡â€å’Œâ€œå¸§ç‡â€å¼€å§‹è®²èµ· 1ã€ä»€ä¹ˆæ˜¯åˆ·æ–°ç‡ åˆ·æ–°ç‡çš„æ¦‚å¿µè¯ç”Ÿè‡ªCRTæ˜¾ç¤ºå™¨ æ—©æœŸçš„CRTå±å¹•æ˜¾ç¤ºç”»é¢æ˜¯é ç”µå­æŸæ¿€å‘å±å¹•å†…è¡¨é¢çš„è§å…‰ç²‰æ¥æ˜¾ç¤ºå›¾åƒçš„ï¼Œç”±äºè§å…‰ç²‰è¢«ç‚¹äº®åå¾ˆå¿«ä¼šç†„ç­ï¼Œæ‰€ä»¥ç”µå­æªå¿…é¡»å¾ªç¯åœ°ä¸æ–­æ¿€å‘è¿™äº›ç‚¹ï¼Œç”µå­æŸä»å·¦åˆ°å³ã€ä»ä¸Šåˆ°ä¸‹ç‚¹äº®è§å…‰ç²‰çš„è¿‡ç¨‹ï¼Œè¢«ç§°ä¸ºâ€œé€è¡Œæ‰«æâ€æŠ€æœ¯ åœ¨ä¸€ç§’é’Ÿå†…ç”µå­æŸèƒ½å¤Ÿæ‰«æå‡ºä¸€å¹…å®Œæ•´ç”»é¢çš„é€Ÿåº¦ï¼Œè¢«ç§°ä¸ºå±å¹•çš„åˆ·æ–°ç‡ï¼Œè¡¨ç¤ºå•ä½ä¸ºHZ å›¾ç‰‡æ¥æºï¼šhttp://electronicsgurukulam.blogspot.com/2012/04/how-television-screen-works.html 60HZå±å¹•å°±æ˜¯æ˜¾ç¤ºå™¨ä¸€ç§’é’Ÿæ˜¾ç¤º60æ¬¡ç”»é¢ï¼Œå³1/60ç§’å†…å‡ºä¸€ä¸ªç”»é¢ LCDæ¶²æ™¶å±å’ŒOLEDå±åŒæ ·ä½¿ç”¨â€œé€è¡Œæ‰«æâ€æ¥åˆ·æ–°å±å¹•åƒç´  ä¸è¿‡ç”±äºæ˜¾ç¤ºåŸç†å‘ç”Ÿäº†å˜åŒ–ï¼Œå±å¹•çš„æ¯ä¸ªåƒç´ ç‚¹éƒ½å¯ä»¥å•ç‹¬æ§åˆ¶æ˜¯å¦å‘å…‰ æ‰€ä»¥LCD/OLEDå±å¹•çš„â€œé€è¡Œåˆ·æ–°â€å’ŒCRTæ˜¾ç¤ºå™¨ä¸Šçš„åŸç†æ˜¯ä¸ä¸€æ ·çš„ï¼Œåœ¨ç°åœ¨çš„æ˜¾ç¤ºå™¨ä¸­ï¼Œâ€œé€è¡Œåˆ·æ–°â€æŒ‡çš„æ˜¯æ§åˆ¶å™¨å•æ¬¡ä¼šä¸€è¡Œæˆ–è€…å¤šè¡Œæ›´æ–°åƒç´  è¿™ç§æŠ€æœ¯è¢«ç§°ä¸ºæœ‰æºçŸ©é˜µé©±åŠ¨ï¼Œä¹Ÿå°±æ˜¯å¸‚åœºä¸Šä¸»æµçš„TFT-LCDå±å’ŒAMOLEDå± å›¾ç‰‡æ¥æºï¼šhttps://tech.sina.cn/2020-06-07/detail-iircuyvi7202205.d.html å±å¹•è¶…é¢‘ï¼Ÿ ä¸€å—å®Œæ•´çš„æ˜¾ç¤ºè®¾å¤‡ä¸»è¦ç”±LCDæˆ–OLEDæ˜¾ç¤ºå™¨ä»¶ã€é©±åŠ¨ç”µè·¯ã€æ§åˆ¶å™¨è¿™ä¸‰éƒ¨åˆ†ç»„æˆï¼Œæ—¢ç„¶æœ‰é©±åŠ¨ç¨‹åºï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å°è¯•ä¿®æ”¹å±å¹•çš„åˆ·æ–°ç‡ï¼Œå³å±å¹•è¶…é¢‘ å›¾ç‰‡æ¥æºï¼šè‡ªå·±æˆªçš„ æˆ‘æ‰‹é‡ŒPixel 3å°±è¢«æˆ‘ç”¨é…·å®‰å¤§ä½¬åšçš„â€œRRå±å¹•åˆ·æ–°ç‡â€APPä»60HZè¶…é¢‘åˆ°äº†61HZ é™¤äº†ç”¨APPè¶…é¢‘å¤–ï¼ŒAndroidç«¯è¿˜å¯ä»¥é€šè¿‡adbå‘½ä»¤ä¿®æ”¹frame rateå€¼ã€åˆ·ç³»ç»Ÿå†…æ ¸çš„æ¥ä¿®æ”¹åˆ·æ–°ç‡ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥çœ‹è¿™ç¯‡å¸–å­ï¼šè¶…å±å¹•åˆ·æ–°ç‡æ‰€éœ€çš„å‚æ•°ï¼Ÿ Windowsç³»ç»Ÿä¸‹æ˜¾ç¤ºå™¨è¶…é¢‘æ›´å®¹æ˜“ï¼Œå¯ä»¥åœ¨æ˜¾å¡çš„æ§åˆ¶é¢æ¿ä¸­è‡ªå®šä¹‰å±å¹•åˆ·æ–°ç‡ï¼Œç¬”è®°æœ¬ç”¨æˆ·å¯ä»¥ä¸‹è½½Custom Resolution Utility(ç®€ç§°CRU)å†™å…¥EDIDä¿¡æ¯æ¥ä¿®æ”¹å±å¹•åˆ·æ–°ç‡ è¶…é¢‘çš„æ“ä½œæ­¥éª¤å¾ˆç®€å•ï¼Œä½†è€ƒè™‘åˆ°å±å¹•åˆ·æ–°ç‡éƒ½æ˜¯æœ‰ä¸Šé™çš„ï¼Œä¸å»ºè®®ä¸€æ¬¡æ€§è¶…å¤ªé«˜ å¯¹äºLCDæ¶²æ™¶å±å’ŒOLCDå±å¹•æ¥è¯´ï¼Œåˆ·æ–°ç‡çš„ä¸Šé™å–å†³äºä¸¤ç‚¹ï¼š ä¸€æ˜¯å±å¹•è‡ªèº«ç´ è´¨ï¼Œé€šå¸¸æ˜¯æŒ‡å±å¹•çš„â€œç°é˜¶å“åº”æ—¶é—´â€ï¼Œåˆ·æ–°ç‡è®¾ç½®è¿‡é«˜ä¼šåƒç´ é¢œè‰²ååº”ä¸è¿‡æ¥ï¼Œä¼šå¯¼è‡´å±å¹•åè‰²ã€æ‹–å½±ç­‰é—®é¢˜ äºŒæ˜¯é…å¥—çš„ç¡¬ä»¶ç´ è´¨ï¼Œæ¯”å¦‚å±å¹•ä¾›ç”µã€è´·æ¬¾æ€»çº¿ç­‰ï¼Œåˆ·æ–°ç‡è¿‡é«˜å¯èƒ½å¯¼è‡´å±å¹•æ— æ³•æ­£å¸¸å·¥ä½œï¼Œæ¯”å¦‚æ˜¾ç¤ºå™¨é»‘å±ã€è§¦æ‘¸å±å¤±çµ ç°åœ¨çš„æ˜¾ç¤ºå™¨ä¸€èˆ¬éƒ½æœ‰æ‰«æä¿æŠ¤ç”µè·¯ï¼Œä½†å¦‚æœä½ çš„å±å¹•æ²¡æœ‰è¿™ä¸€ç±»ä¿æŠ¤ç”µè·¯çš„è¯ï¼Œè¶…é¢‘å¯èƒ½ä¼šæŸåæ˜¾ç¤ºå™¨å†…éƒ¨ç”µè·¯ï¼Œæœ€ç»ˆå¯¼è‡´æ˜¾ç¤ºå™¨æŠ¥åºŸ æ€»ä¹‹ï¼Œè¶…é¢‘æœ‰é£é™©ï¼Œåˆ·æœºéœ€è°¨æ… 2ã€ä»€ä¹ˆæ˜¯å¸§ç‡ å¸§ç‡ä¸€ç›´æ˜¯è§†é¢‘é¢†åŸŸä¸­çš„æ¦‚å¿µï¼Œå®ƒçš„è¯ç”Ÿæœ€æ—©å¯ä»¥è¿½æº¯åˆ°1860å¹´æ— å£°ç”µå½±æ—¶ä»£ åœ¨è§†é¢‘é¢†åŸŸä¸­ï¼Œå¸§ç‡å¯ä»¥åˆ†ä¸ºæ‹æ‘„å’Œæ”¾æ˜ ä¸¤éƒ¨åˆ†ï¼š åœ¨æ‹æ‘„è§†é¢‘æ—¶ï¼Œå¸§ç‡æŒ‡çš„æ˜¯æ¯ç§’é’Ÿè®°å½•çš„ç”»é¢æ•°é‡ åœ¨æ’­æ”¾è§†é¢‘æ—¶ï¼Œå¸§ç‡æŒ‡çš„æ˜¯æ¯ç§’é’Ÿè¾“å‡ºçš„ç”»é¢æ•°é‡ 1973å¹´æ–½ä¹å…¬å¸å‘æ˜å‡ºç¬¬ä¸€å°å¸¦æœ‰å›¾å½¢ç”¨æˆ·ç•Œé¢ï¼ˆGUIï¼‰çš„è®¡ç®—æœºä¹‹åï¼Œå¸§ç‡ä¸€è¯ä¹Ÿæ²¿ç”¨åˆ°è®¡ç®—æœºé¢†åŸŸ åœ¨è®¡ç®—æœºä¸­ï¼Œå¸§ç‡æŒ‡çš„æ˜¯æ¯ç§’é’Ÿè®¡ç®—æœºèƒ½å¤Ÿæ¸²æŸ“å‡ºçš„ç”»é¢æ•°é‡ å¸§ç‡çš„æ¦‚ç‡å¾ˆå®¹æ˜“ç†è§£ï¼Œå®ƒçš„éš¾ç‚¹åœ¨äºå½“â€œå¸§ç‡â€å’Œâ€œåˆ·æ–°ç‡â€ç»„åˆåœ¨ä¸€èµ·æ—¶ï¼Œæƒ…å†µå°±å¯èƒ½ä¼šå˜çš„å¤æ‚äº†ä¸€äº›ï¼Œæˆ‘ä»¬æ¥çœ‹å‡ ä¸ªé—®é¢˜ï¼š æ˜¾å¡æ¯ç§’èƒ½ç”Ÿæˆ250å¸§ç”»é¢ï¼Œä½†æ˜¯æ˜¾ç¤ºå™¨åªæœ‰90HZï¼Œå¤šå‡ºæ¥çš„160å¸§ç”»é¢æœ‰æ²¡æœ‰æ„ä¹‰ï¼Ÿæ˜¯ä¸æ˜¯ç™½ç™½æµªè´¹äº†æ˜¾å¡æ€§èƒ½ï¼Ÿ æ–°ä¹°äº†ä¸€å°144HZçš„æ˜¾ç¤ºå™¨ï¼Œä½†æˆ‘çš„æ˜¾å¡æ€§èƒ½å¾ˆæ‹‰èƒ¯ï¼Œç©æ¸¸æˆçš„å¹³å‡å¸§ç‡åªæœ‰30FPSï¼Œæ˜¾ç¤ºå™¨ä¼šå¸®æˆ‘è¡¥å¸§å—ï¼Ÿ ç½‘å‹éƒ½è¯´å‡ºç°æ’•è£‚çš„æ ¹æœ¬åŸå› åœ¨äºæ˜¾å¡è¾“å‡ºå¸§çš„é€Ÿåº¦æ¯”æ˜¾ç¤ºå™¨å¿«ï¼Œä¹°ä¸€å°é«˜åˆ·æ˜¾ç¤ºå™¨å°±å¯ä»¥é¿å…ç”»é¢æ’•è£‚ï¼ŒçœŸçš„æ˜¯è¿™æ ·å—ï¼Ÿæ˜¯ä¸æ˜¯ä¸€ç¾¤å–æ˜¾ç¤ºå™¨çš„å•†å®¶æŒ–çš„æ¶ˆè´¹é™·é˜±ï¼Ÿ è¿™å‡ ä¸ªé—®é¢˜åˆ†åˆ«å¯¹åº”äº†â€œå¸§ç‡å¤§äºåˆ·æ–°ç‡â€ã€â€œåˆ·æ–°ç‡å¤§äºå¸§ç‡â€ä»¥åŠâ€œå¸§ç‡å’Œåˆ·æ–°é¢‘ç‡ä¸åŒ¹é…å¯¼è‡´çš„ç”»é¢æ’•è£‚â€è¿™ä¸‰ç§æƒ…å†µ æ¥ä¸‹æ¥æˆ‘ä»¬å°±ä»æ˜¾å¡å’Œæ˜¾ç¤ºå™¨å·¥ä½œåŸç†çš„è§’åº¦æ¥èŠèŠï¼šå½“åˆ·æ–°ç‡å’Œå¸§ç‡ä¸åŒ¹é…æ—¶ï¼Œè®¡ç®—æœºä¼šå¦‚ä½•å¤„ç†ï¼Ÿ æ˜¾å¡å’Œæ˜¾ç¤ºå™¨ä¹‹é—´æ˜¯å¦‚ä½•ååŒå·¥ä½œçš„ï¼Ÿ é¦–å…ˆæˆ‘ä»¬è¦çŸ¥é“ä¸€ç‚¹ï¼Œæ˜¾å¡å’Œæ˜¾ç¤ºå™¨è™½ç„¶åœ¨åŒä¸€å—ä¸»æ¿ä¸Šï¼Œä½†æ˜¯å®ƒä¿©äº’ç›¸æ˜¯ä¸çŸ¥é“å½¼æ­¤çš„å­˜åœ¨çš„ï¼Œæ˜¾å¡å’Œæ˜¾ç¤ºå™¨å®Œå…¨æœ‰å¯èƒ½æ¥è‡ªä¸åŒçš„å‚å®¶ æ“ä½œç³»ç»Ÿå¯åŠ¨åä¼šå¼€è¾Ÿå‡ºä¸€å—å†…å­˜ä¸“é—¨ç”¨äºç”»é¢æ˜¾ç¤ºï¼Œè¿™å—å…±äº«å†…å­˜è¢«ç§°ä¸ºâ€œå¸§ç¼“å­˜åŒºâ€ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ç»å¸¸å¬åˆ°çš„frame bufferï¼Œå®ƒå¯ä»¥ä½äºæ˜¾å­˜ï¼Œä¹Ÿå¯ä»¥ä½äºå†…å­˜ï¼Œç”±æ“ä½œç³»ç»Ÿå†³å®šå¦‚ä½•åˆ†é… åœ¨ä¸è¿›è¡Œä»»ä½•è®¾ç½®çš„å‰æä¸‹ï¼Œæ“ä½œç³»ç»Ÿé€šå¸¸ä½¿ç”¨çš„æ˜¯åŒç¼“å­˜ç­–ç•¥ï¼š æ˜¾ç¤ºæ§åˆ¶å™¨é©±åŠ¨æ­£åœ¨è¯»å–çš„æ˜¯ä¸€ä¸ªå¸§ç¼“å­˜ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºå‰ç¼“å­˜ æ˜¾å¡ç»˜åˆ¶åå†™å…¥çš„å¦ä¸€ä¸ªå¸§ç¼“å­˜ï¼Œç§°ä¹‹ä¸ºåç¼“å­˜ï¼Œæ˜¾å¡ç»˜åˆ¶å®Œä¸€å¸§åé€šçŸ¥CPUäº¤æ¢å‰åç¼“å­˜çš„é¡ºåº æ˜¾ç¤ºå™¨åˆ·æ–°çš„è¿‡ç¨‹ï¼Œå°±æ˜¯ä¸åœçš„åˆ‡æ¢ç”±å‰åç¼“å­˜ç»„æˆçš„ç¼“å­˜é˜Ÿåˆ— å›¾ç‰‡æ¥æºï¼šè‡ªå·±ç”»çš„ æ˜¾ç¤ºå™¨è´Ÿè´£ä»å‰ç¼“å­˜è¯»æ•°æ®ï¼Œç„¶åæ¯æ¬¡ä¸€è¡Œæˆ–å¤šè¡Œæ›´æ–°åƒç´ é¢œè‰²ï¼Œæ˜¾å¡è´Ÿè´£ç”»å›¾ï¼Œå‘åç¼“å­˜å†™æ•°æ®ï¼Œæ¸²æŸ“å®Œæˆåé€šçŸ¥CPUäº¤æ¢å¸§ç¼“å­˜ ä»”ç»†è§‚å¯Ÿæµç¨‹å›¾ä¼šå‘ç°ï¼Œåœ¨æ•´ä¸ªçš„å·¥ä½œæµç¨‹ä¸­ï¼Œæ˜¾å¡å’Œæ˜¾ç¤ºå™¨ä¹‹é—´æ˜¯æ²¡æœ‰ä»»ä½•è”ç³»çš„ï¼Œè¿™ä¹Ÿæ˜¯å¯¼è‡´ç”»é¢æ’•è£‚çš„åŸå›  ä¸ºä»€ä¹ˆä¼šå‘ç”Ÿç”»é¢æ’•è£‚ï¼Ÿ ä¸‹å›¾æ¨¡æ‹Ÿçš„æ˜¯æ˜¾ç¤ºå™¨æ­£åœ¨åˆ·æ–°å±å¹•åƒç´ ï¼Œå…¶ä¸­ä¸ŠåŠéƒ¨åˆ†çš„å›¾åƒå·²ç»åˆ·æ–°å®Œæˆ å›¾ç‰‡æ¥æºï¼šè‡ªå·±åšçš„ è€Œæ­¤æ—¶æ˜¾å¡ä¹Ÿåˆšå¥½å®Œæˆä¸‹ä¸€å¸§çš„æ¸²æŸ“å·¥ä½œï¼Œå¹¶è§¦å‘äº†äº¤æ¢å¸§ç¼“å­˜ æ˜¾ç¤ºå™¨ä¾æ—§æŒ‰ç…§å½“å‰çš„åç§»é‡è¯»å–æ•°æ®ï¼Œå±å¹•æœ€ç»ˆå¾—åˆ°çš„æ¥è‡ªä¸¤ä¸ªä¸åŒå¸§ç¼“å­˜æ‹¼æ¥çš„ç”»é¢ï¼Œä¹Ÿå°±æ˜¯ç”»é¢å‘ç”Ÿäº†æ’•è£‚ å›¾ç‰‡æ¥æºï¼šè‡ªå·±åšçš„ é‡ç‚¹æ¥äº†ï¼ï¼å±å¹•åƒç´ ç‚¹ä¸€æ—¦åˆ·æ–°å®Œæˆï¼Œä¸‹æ¬¡åˆ·æ–°è¦ç­‰åˆ°16msä»¥åï¼Œåˆ·æ–°ç‡è¶Šä½ç­‰å¾…çš„æ—¶é—´è¶Šé•¿ è¿™ä¹Ÿæ˜¯æˆ‘ä»¬äººçœ¼èƒ½å¤Ÿå¯Ÿè§‰åˆ°â€œç”»é¢æ’•è£‚â€çš„åŸå›  ç»¼ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºä»¥ä¸‹ç»“è®ºï¼š å‘ç”Ÿç”»é¢æ’•è£‚çš„åŸå› ï¼šå¸§ç¼“å­˜çš„äº¤æ¢éšæ—¶å¯èƒ½ä¼šå‘ç”Ÿï¼Œä¸€æ—¦æ˜¾å¡åœ¨ä¸æ°å½“çš„æ—¶æœºäº¤æ¢äº†å¸§ç¼“å­˜ï¼Œå±å¹•å°±ä¼šå‘ç”Ÿç”»é¢æ’•è£‚ ç”»é¢æ’•è£‚èƒ½è¢«äººçœ¼æ„ŸçŸ¥çš„åŸå› ï¼šæ’•è£‚çš„ç”»é¢å¸§ä¼šåœ¨å±å¹•ä¸Šåœç•™åå‡ æ¯«ç§’çš„æ—¶é—´ï¼Œå¦‚æœç”»é¢è¿ç»­å‘ç”Ÿæ’•è£‚ï¼Œå¯¹äºæ¯”è¾ƒæ•æ„Ÿçš„äººæ¥è¯´æ˜¯å¯ä»¥æ•æ‰åˆ°çš„ äºŒã€å‚ç›´åŒæ­¥ä¿¡å· æ—¢ç„¶ç”»é¢æ’•è£‚çš„åŸå› æ˜¯æ˜¾å¡åœ¨ä¸æ°å½“çš„æ—¶æœºäº¤æ¢äº†å¸§ç¼“å­˜ï¼Œé‚£æˆ‘ä»¬è®©æ˜¾å¡åœ¨æ˜¾ç¤ºå™¨åˆ·æ–°çš„è¿™æ®µæ—¶é—´å†…ï¼Œä¸è§¦å‘äº¤æ¢frame butterçš„åŠ¨ä½œä¸å°±è§£å†³é—®é¢˜äº† å‚ç›´åŒæ­¥å°±æ˜¯ç”¨æ¥åšè¿™æ ·çš„äº‹æƒ…çš„ 1ã€ä»€ä¹ˆæ˜¯å‚ç›´åŒæ­¥ å…·ä½“å®ç°ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥è®©æ˜¾ç¤ºæ§åˆ¶å™¨é©±åŠ¨åœ¨æ¯æ¬¡åˆ·æ–°å±å¹•ä¹‹åï¼Œä¸»åŠ¨å‘CPUå‘èµ·ä¸€ä¸ªä¸­æ–­ï¼Œä»£è¡¨æ˜¾ç¤ºå™¨åˆ·æ–°å®Œæˆ æ˜¾å¡ç”»é¢æ¸²æŸ“å®Œæˆä»¥åè¿›å…¥é˜»å¡çŠ¶æ€ï¼Œç­‰æ”¶åˆ°æ˜¾ç¤ºå™¨çš„å®Œæˆä¿¡å·åå†å»äº¤æ¢å¸§ç¼“å­˜ å›¾ç‰‡æ¥æºï¼šè‡ªå·±ç”»çš„ æ˜¾ç¤ºå™¨å‘é€çš„ä¸­æ–­ä¿¡å·ï¼Œå°±è¢«ç§°ä¸ºå‚ç›´åŒæ­¥ï¼ˆVSyncï¼‰ä¿¡å· é€šè¿‡å¢åŠ å‚ç›´åŒæ­¥ä¿¡å·çš„æ–¹å¼ï¼Œä½¿å¾—æ¯æ¬¡äº¤æ¢å¸§ç¼“å­˜çš„æ—¶æœºå˜å¾—å¯æ§ï¼Œå¤§å¤§é™ä½äº†ç”»é¢æ’•è£‚å‘ç”Ÿçš„æ¦‚ç‡ ä¸è¿‡ï¼Œå‚ç›´åŒæ­¥åœ¨â€œç”»é¢æ’•è£‚â€çš„åŒæ—¶ï¼Œä¹Ÿå¸¦æ¥äº†ä¸¤ä¸ªæ–°çš„é—®é¢˜.. å‚ç›´åŒæ­¥çš„å¼Šç«¯ å½“æ˜¾å¡çš„å‚ç›´åŒæ­¥åŠŸèƒ½è¢«ç½®ä¸ºTRUEä»¥åï¼Œæ¯ä¸€å¸§æ¸²æŸ“å®Œè°ƒç”¨SwapBufferså‡½æ•°æ—¶ï¼Œéƒ½è¦ç­‰å¾…ä¸‹ä¸€æ¬¡å±å¹•åˆ·æ–°çš„æ—¶åˆ»åˆ°æ¥ï¼Œæ‰èƒ½äº¤æ¢å‰åç¼“å­˜å¹¶å¼€å§‹æ‰§è¡Œä¸‹ä¸€å¸§â€¦ è¿™å°±äº§ç”Ÿäº†ä¸¤ä¸ªæ–°çš„é—®é¢˜ï¼š ä¸€æ˜¯æ˜¾å¡æ¥æ”¶åˆ°VSyncä¿¡å·åæ‰å»å·¥ä½œï¼Œä¼šå¯¼è‡´æ˜¾å¡è¾“å‡ºçš„å¸§ç‡æ°¸è¿œä¸å¯èƒ½å¤§äºå±å¹•çš„åˆ·æ–°ç‡ï¼Œå¯ä»¥ç®€å•ç†è§£ä¸ºæ˜¾å¡é”å¸§ äºŒæ˜¯åœ¨ç­‰å¾…å‚ç›´åŒæ­¥ä¿¡å·çš„è¿™æ®µæ—¶é—´å†…ï¼Œé¼ æ ‡ã€é”®ç›˜ç­‰äº‹ä»¶ä¸èƒ½åŠæ—¶çš„æ˜¾ç¤ºåˆ°å±å¹•ä¸Šï¼Œä¼šå¯¼è‡´ç”»é¢å»¶è¿Ÿ é—®é¢˜ä¸€å¯¹å¤§éƒ¨åˆ†äººæ¥è¯´è¿˜å¯ä»¥æ¥å—ï¼Œæ˜¾å¡æ€§èƒ½è¶³å¤Ÿçš„æƒ…å†µä¸‹å¯ä»¥ç¨³å®šè¾“å‡º60å¸§ï¼Œéç«æŠ€ç±»æ¸¸æˆçš„è¯å½±å“ä¸æ˜¯å¾ˆå¤§ ä½†æ˜¯é—®é¢˜äºŒçš„ç”»é¢å»¶è¿Ÿå°±å¾ˆéš¾æ¥å—äº†ï¼Œ60HZçš„æ˜¾ç¤ºå™¨æœ€å¤§å»¶è¿Ÿèƒ½è¾¾åˆ°åå‡ æ¯«ç§’ï¼Œå¦‚æœç©çš„æ˜¯CSGOã€PUBGã€ç©¿è¶Šç«çº¿ç­‰FPSæ¸¸æˆï¼Œåå‡ æ¯«ç§’çš„å»¶è¿Ÿè¿˜æ˜¯å¾ˆå®¢è§‚çš„ é‚£æœ‰æ²¡æœ‰ä»€ä¹ˆæ–¹æ³•èƒ½å¤Ÿè§£å†³å‚ç›´åŒæ­¥ä¿¡å·å¸¦æ¥çš„å¼Šç«¯å‘¢ï¼Ÿ æœ‰ï¼Œå°±æ˜¯ç»å¸¸è·Ÿå‚ç›´åŒæ­¥ä¸€èµ·å‡ºç°çš„å¦ä¸€ä¸ªè¯ï¼šä¸‰é‡ç¼“å­˜ 2ã€ä»€ä¹ˆæ˜¯ä¸‰é‡ç¼“å­˜ ä¸‰é‡ç¼“å­˜æ˜¯æŒ‡åœ¨å¼€å¯äº†å‚ç›´åŒæ­¥çš„åŸºç¡€ä¸Šï¼Œå†å¢åŠ ä¸€ä¸ªä¸­ç¼“å­˜ï¼Œå’ŒåŸæœ‰çš„å‰åç¼“å­˜ç»„æˆç¼“å­˜é˜Ÿåˆ— ä¸­ç¼“å­˜ä¿è¯ä»»ä½•æ—¶å€™éƒ½æœ‰ä¸€å¸§å®Œæ•´çš„ç”»ç”»æ•°æ®ç­‰å¾…ç€äº¤æ¢ï¼Œæ˜¾ç¤ºå™¨è¯»å–æ•°æ®çš„æ˜¯å‰ç¼“å­˜ï¼ŒVSyncä¿¡å·åˆ°æ¥åå‰ç¼“å†²å’Œä¸­ç¼“å­˜å‘ç”Ÿäº¤æ¢ æ˜¾å¡æ­£åœ¨å†™å…¥æ•°æ®çš„æ˜¯åç¼“å­˜ï¼Œæ˜¾å¡æ¸²æŸ“å®Œä¸€å¸§ç”»é¢åï¼Œåç¼“å­˜åªå’Œä¸­ç¼“å­˜å‘ç”Ÿäº¤æ¢ å›¾ç‰‡æ¥æºï¼šè‡ªå·±ç”»çš„ ä¸‰é‡ç¼“å­˜è®©æˆ‘ä»¬æœ‰å¼€å¯å‚ç›´åŒæ­¥æ—¶çš„æ‰€æœ‰å¥½å¤„ï¼Œæˆ‘ä»¬å¾—åˆ°äº†æµç•…ä¸”æ²¡æœ‰æ’•è£‚çš„ç”»é¢ï¼ŒåŒæ—¶ï¼Œæˆ‘ä»¬è¿˜æ‹¥æœ‰è¿‘ä¼¼å…³é—­å‚ç›´åŒæ­¥æ—¶é‚£æ ·ä½çš„è¾“å…¥æ˜¾ç¤ºå»¶è¿Ÿ é‚£æ˜¯ä¸æ˜¯åœ¨æ‰“æ¸¸æˆæ—¶æŠŠä¸‰é‡ç¼“å­˜é€‰é¡¹éƒ½æ‰“å¼€å°±å¯ä»¥è§£å†³ç”»é¢å»¶è¿Ÿäº†å‘¢ï¼Ÿ å¾—åˆ†æƒ…å†µï¼Œåœ¨Windowsç³»ç»Ÿä¸‹çš„æ¸¸æˆä¸å»ºè®®æ‰“å¼€ DirectXæ˜¯å¾®è½¯æä¾›çš„å¤šåª’ä½“ç¼–ç¨‹æ¥å£ï¼Œç»å¤§å¤šæ•°PCç«¯æ¸¸æˆéƒ½æ˜¯ä½¿ç”¨DirectXæ¡†æ¶è¿›è¡Œå¼€å‘ï¼ŒDXçš„â€œä¸‰é‡ç¼“å­˜â€å’Œè¿™é‡Œçš„ä¸‰é‡ç¼“å­˜ä¸æ˜¯ä¸€ä¸ªæ„æ€ï¼ŒDXä¸­çš„é‚£ä¸ªæ˜¯å…ˆè¿›å…ˆå‡ºçš„å¸§ç¼“å­˜é˜Ÿåˆ— æ˜¾å¡ç»˜åˆ¶å®Œä¹‹åä¸ä¼šå’Œå‰ç¼“å­˜å‘ç”Ÿäº¤æ¢ï¼Œè€Œæ˜¯å°†å¸§æ•°æ®å­˜å…¥å¸§ç¼“å­˜é˜Ÿåˆ—ï¼Œå½“æ˜¾å¡æ¥å—åˆ°å‚ç›´åŒæ­¥ä¿¡å·ä¹‹åæŠŠæœ€é¡¶ç«¯çš„å¸§æ•°æ®äº¤ç»™å±å¹•æ˜¾ç¤º æœ€æ–°çš„ç”»é¢å¸§æ°¸è¿œéƒ½åœ¨é˜Ÿåˆ—çš„æœ€åº•ç«¯ï¼Œé˜Ÿåˆ—çš„é•¿åº¦è¶Šé•¿ï¼Œç”»é¢çš„å»¶è¿Ÿå°±è¶Šæ˜æ˜¾ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆPCç«¯çš„æ¸¸æˆèƒ½å•ç‹¬å¯ç”¨â€œä¸‰é‡ç¼“å†²â€åŠŸèƒ½ï¼Œä»¥åŠä¸ºä»€ä¹ˆæ‰“å¼€â€œä¸‰é‡ç¼“å­˜â€é€‰é¡¹åä¼šæ„Ÿè§‰å»¶è¿Ÿå˜é«˜çš„åŸå›  è§£å†³æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼ŒNå¡é©±åŠ¨ç¨‹åºä¸­æœ‰ä¸ªè¶…ä½å»¶è¿Ÿæ¨¡å¼ï¼Œæ‰“å¼€ä¹‹åä¼šå°†Max_Prerendered_Frameè®¾ä¸º1ï¼Œå°±æ˜¯å°†ç¼“å­˜é˜Ÿåˆ—çš„æœ€å¤§é•¿åº¦è®¾ç½®ä¸º1ï¼Œå†æ­é…ä¸Šå‚ç›´åŒæ­¥æŠ€æœ¯ï¼Œå°±èƒ½å¤Ÿå¤§å¤§æ”¹å–„ç”»é¢æ’•è£‚ä»¥åŠç”»é¢å»¶è¿Ÿçš„æƒ…å†µ 3ã€ä»€ä¹ˆæ˜¯è‡ªé€‚åº”åˆ·æ–° è‡ªé€‚åº”åˆ·æ–°ä¹Ÿæ˜¯ä¸€ç§è§£å†³â€œç”»é¢æ’•è£‚â€çš„æ–¹æ¡ˆï¼Œç®—æ˜¯â€œå‚ç›´åŒæ­¥â€çš„æ”¹è‰¯ç‰ˆæœ¬ è‹±ä¼Ÿè¾¾çš„G-SYNCã€AMDçš„FreeSyncä»¥åŠè‹¹æœçš„ProMotionæŠ€æœ¯éƒ½å¯ä»¥ç†è§£ä¸ºæ˜¯è‡ªé€‚åº”åˆ·æ–°æŠ€æœ¯ è‡ªé€‚åº”åˆ·æ–°åœ¨ä¿ç•™å‚ç›´åŒæ­¥ä¿¡å·çš„åŸºç¡€ä¸Šåˆå¢åŠ äº†ä¸€ä¸ªä¸­æ–­ä¿¡å·ï¼Œè¿™ä¸ªä¸­æ–­ä¿¡å·æ˜¯ç”±æ˜¾å¡å‘èµ·çš„ï¼Œè¡¨ç¤ºæ˜¾å¡æ¸²æŸ“å®Œä¸€å¸§ç”»é¢ æ˜¾ç¤ºå™¨åœ¨æ²¡æœ‰æ¥å—åˆ°æ˜¾å¡å®Œæˆçš„ä¿¡å·ä¹‹å‰ï¼Œä¸åˆ·æ–°å±å¹•æˆ–è€…ä»¥æä½çš„é€Ÿç‡å»åˆ·æ–° å›¾ç‰‡æ¥æºï¼šè‡ªå·±ç”»çš„ ç”±äºåŠ å…¥äº†æ–°çš„åŒæ­¥ä¿¡å·ï¼Œæ‰€ä»¥æ˜¾ç¤ºå™¨åœ¨æ²¡æœ‰æ–°çš„ç”»é¢å¸§äº§ç”Ÿä¹‹å‰ï¼Œä¹Ÿå¯ä»¥è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œä¸å¿…æŒ‰ç…§å›ºå®šé€Ÿç‡å»åˆ·æ–°å±å¹• æˆ‘ä»¬å®é™…çœ‹åˆ°çš„å¸§ç‡å°±å˜æˆäº†ï¼Œè¶…è¿‡å±å¹•æœ€å¤§åˆ·æ–°ç‡ï¼ŒæŒ‰ç…§å±å¹•æœ€é«˜åˆ·æ–°ç‡æ¥æ˜¾ç¤ºï¼›å¦åˆ™ï¼ŒæŒ‰ç…§æ˜¾å¡è¾“å‡ºçš„å¸§ç‡æ¥æ˜¾ç¤ºï¼Œè¿™ä¹Ÿæ˜¯â€œè‡ªé€‚åº”åˆ·æ–°â€åç§°çš„ç”±æ¥ åœ¨æ¡Œé¢ç«¯ï¼Œè‡ªé€‚åº”åˆ·æ–°èƒ½å¤Ÿåœ¨æœ€å¤§é™åº¦çš„ä¿è¯ç”»é¢æ— æ’•è£‚çš„åŒæ—¶è¿˜å¯ä»¥åšåˆ°å‡ ä¹å¿½ç•¥ä¸è®¡çš„è¾“å…¥å»¶è¿Ÿï¼Œåœ¨ç§»åŠ¨ç«¯ï¼Œé™¤äº†ä»¥ä¸Šçš„æœ‰ç‚¹å¤–ï¼Œè‡ªé€‚åº”åˆ·æ–°è¿˜å¯ä»¥é™ä½èƒ½è€— æ‰€ä»¥ï¼Œåœ¨å¯é¢„è§çš„å°†æ¥ï¼Œè‡ªé€‚åº”åˆ·æ–°ä¸€å®šä¼šæˆä¸ºæ ‡å‡†æŠ€æœ¯ï¼Œåº”ç”¨åˆ°æ¯ä¸€å°è®¡ç®—æœºä¸Š ä¸‰ã€ç»“è¯­ å›é¡¾å‚ç›´åŒæ­¥å’Œè‡ªé€‚åº”åˆ·æ–°çš„å‘å±•å²ï¼Œä¼šå‘ç°æœ¬è´¨æ˜¯æ˜¾å¡å’Œæ˜¾ç¤ºå™¨ä¸€æ­¥æ­¥å»ºç«‹é€šä¿¡çš„å‘å±•å² æ˜¾å¡å’Œæ˜¾ç¤ºå™¨å¯¹äºCPUæ¥è¯´éƒ½å±äºæ˜¯I/Oå¤–è®¾ï¼Œåœ¨æ²¡æœ‰å»ºç«‹é€šä¿¡ä¹‹å‰ï¼Œå®ƒä¿©æ˜¯å„å¿™å„çš„ å› ä¸ºæ˜¾å¡éšæ—¶å¯èƒ½å»äº¤æ¢å¸§ç¼“å­˜å¯¼è‡´ç”»é¢å‘ç”Ÿæ’•è£‚ï¼Œäºæ˜¯åŠ å…¥äº†å‚ç›´åŒæ­¥ä¿¡å·ï¼Œè®©æ˜¾ç¤ºå™¨æ¯æ¬¡åˆ·æ–°å®Œé€šçŸ¥æ˜¾å¡ä¸€å£° è¿™å°±å»ºç«‹äº†å•å‘é€šä¿¡ï¼Œæ˜¾å¡å¯ä»¥ç›‘å¬æ˜¾ç¤ºå™¨çš„æ´»åŠ¨äº† åæ¥å‘ç°æ˜¾å¡å¶å°”æ¸²æŸ“ä¸€å¸§ç”»é¢è€—æ—¶æ¯”è¾ƒä¹…ï¼Œè€Œæ˜¾ç¤ºå™¨é‚£è¾¹è¿˜åœ¨æŒ‰ç…§å›ºå®šé€Ÿç‡ä¸åœçš„åœ¨åˆ·æ–°ï¼Œåœ¨æ²¡æœ‰äº§ç”Ÿæ–°çš„ç”»é¢å¸§çš„å‰æä¸‹ï¼Œæ˜¾ç¤ºå™¨çš„åˆ·æ–°åŠ¨ä½œæ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œäºæ˜¯è®©æ˜¾å¡ä¹Ÿå¯ä»¥å‘é€ä¿¡å·ï¼Œæ¯æ¬¡æ¸²æŸ“å®Œæˆé€šçŸ¥æ˜¾ç¤ºå™¨ä¸€å£°ï¼Œæ˜¾ç¤ºå™¨æ¥æ”¶åˆ°ä¿¡å·å†å»åˆ·æ–°å±å¹• è¿™å°±å»ºç«‹äº†åŒå‘é€šä¿¡ï¼Œæ˜¾å¡å¯ä»¥ç›‘å¬æ˜¾ç¤ºå™¨çš„æ´»åŠ¨ï¼Œæ˜¾ç¤ºå™¨ä¹Ÿå¯ä»¥ç›‘å¬æ˜¾å¡çš„æ´»åŠ¨ æœ€åï¼Œå›åˆ°æ–‡ç« çš„æ ‡é¢˜ï¼šå‚ç›´åŒæ­¥åˆ°åº•è¦ä¸è¦å¼€ï¼Ÿ å¦‚æœç©ä¸»æœºæ¸¸æˆï¼Œå»ºè®®æ‰“å¼€å‚ç›´åŒæ­¥ï¼Œæ¯•ç«Ÿéƒ½ç©3Aäº†è‚¯å®šæ²‰æµ¸å¼ä½“éªŒæ¸¸æˆå‰§æƒ…æœ€é‡è¦ï¼Œä½ ä¹Ÿä¸æƒ³åœ¨ç©æ¸¸æˆæ—¶ç”»é¢å‘ç”Ÿæ’•è£‚å§ å¦‚æœç©ç«æŠ€ç±»æ¸¸æˆï¼Œå°¤å…¶æ˜¯FPSæ¸¸æˆï¼Œå»ºè®®å…³é—­å‚ç›´åŒæ­¥ï¼Œç«æŠ€ç±»æ¸¸æˆç©çš„å°±æ˜¯æŠ¢æ—¶é—´ï¼Œè€Œå¼€å¯å‚ç›´åŒæ­¥å°±æ„å¤–ç€æœ‰å»¶è¿Ÿï¼Œå“ªæ€•å†å¼€å¯â€œä¸‰é‡ç¼“å­˜â€é€‰é¡¹ä¹Ÿåªèƒ½æ˜¯å‡ç¼“å»¶è¿Ÿ å¦‚æœä½ æœ‰ä¸€å°144HZé«˜åˆ·ç”µç«æ˜¾ç¤ºå™¨ï¼Œé‚£å¼€ä¸å¼€å‚ç›´åŒæ­¥å½±å“ä¸æ˜¯å¾ˆå¤§ï¼Œçœ‹ä½ å¿ƒæƒ… è™½ç„¶é«˜åˆ·å±ä¾æ—§ä¼šå‘ç”Ÿç”»é¢æ’•è£‚ï¼Œä½†ä¸‹ä¸€æ¬¡å±å¹•åˆ·æ–°ä¼šå¾ˆå¿«åˆ°æ¥ï¼Œå±å¹•ä¼šè¢«æ–°çš„ç”»é¢å¸§è¦†ç›–ï¼Œæ‰€ä»¥åªè¦ä¸æ˜¯è¿ç»­åœ¨åŒä¸€ä½ç½®å‘ç”Ÿæ’•è£‚ï¼Œäººçœ¼å¾ˆéš¾å¯Ÿè§‰åˆ°å±å¹•å‘ç”Ÿäº†æ’•è£‚ å…¨æ–‡å®Œ å››ã€å‚è€ƒèµ„æ–™ Triple Buffering: Why We Love It ã€Šè®¡ç®—æœºå›¾å½¢å­¦åŸºç¡€ï¼ˆç¬¬3ç‰ˆï¼‰ã€‹-é™†æ«, ä½•äº‘å³° ã€Šå½©è‰²æ¶²æ™¶æ˜¾ç¤ºã€‹-ï¼ˆæ—¥ï¼‰å € æµ©é›„ ã€ç¡¬æ ¸ç§‘æ™®ã€‘å¥‡å¦™çš„å¸§ç‡å¢åŠ äº†ï¼ ","link":"https://yibaoshan.github.io/post/android-graphics-driver/"},{"title":"Androidå›¾å½¢ç³»ç»Ÿï¼ˆä¸€ï¼‰ç¡¬ä»¶ç¯‡ï¼šLCDå’ŒOLEDæ€ä¹ˆé€‰ï¼Ÿ","content":" ç‚¹å‡»è·³è½¬åˆ°æ˜é‡‘é˜…è¯» å¯¹äºåº”ç”¨å¼€å‘å·¥ç¨‹å¸ˆæ¥è¯´ï¼Œè™½ç„¶æˆ‘ä»¬ä¸éœ€è¦å†™é©±åŠ¨ç¨‹åºï¼Œä½†æ˜¯äº†è§£Viewæ˜¯æœ€ç»ˆå¦‚ä½•æ˜¾ç¤ºåˆ°å±å¹•ä¸Šè¿˜æ˜¯éå¸¸æœ‰å¿…è¦çš„ æœ¬ç¯‡æ˜¯Viewç³»åˆ—çš„ç¬¬ä¸€ç¯‡æ–‡ç« ï¼Œä¸»è¦è®¨è®ºçš„æ˜¯Androidæ‰‹æœºå±å¹•çš„ç§ç±»ä»¥åŠå’Œå±å¹•ç›¸å…³çš„æŠ€æœ¯åè¯ ä¸€ã€å¼€ç¯‡ æ‰‹æœºå±å¹•å‘å±•è‡³ä»Šï¼Œå¸‚åœºä¸Šåœ¨å”®æ‰‹æœºçš„å±å¹•ç±»å‹åŸºæœ¬å¯ä»¥åˆ†ä¸ºä¸¤ç§ï¼šLCDå±å’ŒOLEDå± å…¶å®ä¸åªæ˜¯æ‰‹æœºå±å¹•ï¼Œç”µè„‘å’Œç”µè§†å±å¹•é¢æ¿åŸºæœ¬ä¹Ÿå°±è¿™ä¸¤ç§ æˆ‘ä»¬å¹³æ—¶åœ¨ä¹°å±å¹•æ—¶çœ‹åˆ°çš„IPSå±ï¼ŒTNå±ç­‰éƒ½å±äºLCDå±é˜µè¥ï¼Œä»–ä»¬çš„åŒºåˆ«åªæ˜¯æ¶²æ™¶å±‚ç»“æ„æˆ–è€…èƒŒå…‰æ¨¡ç»„ç»“æ„ä¸åŒ OLEDå±å¹•å› ä¸ºä»·æ ¼æ¯”è¾ƒè´µï¼Œå¯¿å‘½ä¹Ÿæ¯”ä¸è¿‡LCDå±ï¼Œæ‰€ä»¥OLEDåœ¨æ˜¾ç¤ºå™¨å’Œç”µè§†æœºé¢†åŸŸè¿˜æ²¡æœ‰å¤§é¢ç§¯åº”ç”¨ ä½†åœ¨æ‰‹æœºåœˆï¼Œå„å¤§å‚å•†è‡ª2020å¹´ä¹‹åç”Ÿäº§çš„æ——èˆ°æœºï¼Œå‡ ä¹éƒ½æ ‡é…OLEDå±å¹• ç›¸è¾ƒäºLCDå±å¹• OLEDå±å¹•æ”¯æŒæ›´é«˜çš„äº®åº¦ã€å¯¹æ¯”åº¦ä»¥åŠæ›´è‰³ä¸½çš„è‰²å½© æ›´å¿«çš„å“åº”é€Ÿåº¦ï¼Œé«˜åˆ·ä½“éªŒæ›´å¥½ ä¸éœ€è¦èƒŒå…‰æ¿ï¼Œé‡‡ç”¨COPæ–¹æ¡ˆå°è£…ï¼Œç†è®ºä¸Šå¯ä»¥å»æ‰å®½ä¸‹å·´ åœ¨æ‰‹æœºå±å¹•è¿½æ±‚è¶…é«˜å±å æ¯”çš„æ—¶ä»£ï¼ŒLCDè¢«å½»åº•çš„æŠ›ä¸‹è½¦ ä½†æ˜¯ï¼Œè™½ç„¶OLEDå±æœ‰è®¸å¤šLCDæ— æ³•æ¯”æ‹Ÿçš„ä¼˜åŠ¿ï¼Œä½†å®ƒåŒæ—¶ä¹Ÿå¸¦äº†ä¸¤ä¸ªæ–°çš„é—®é¢˜ï¼šçƒ§å±å’Œä½é¢‘PWMè°ƒå…‰ 1ã€OLEDå±ç¼ºé™·ï¼šçƒ§å± çƒ§å±æŒ‡çš„æ˜¯æ‰‹æœºå±å¹•é•¿æ—¶é—´åœç•™åœ¨æŸä¸ªé™æ­¢ç”»é¢ï¼Œç‰¹åˆ«æ˜¯æä¸ªåˆ«é«˜å¯¹æ¯”åº¦ç”»é¢ï¼Œå†åˆ‡æ¢åˆ°å…¶ä»–ç”»é¢æ—¶ä»ç„¶èƒ½çœ‹åˆ°åŸæ¥ç”»é¢çš„æ®‹å½±ï¼Œè€Œä¸”æ®‹å½±ä¸ä¼šæ¶ˆå¤± æ¯”å¦‚æˆ‘ä¹‹å‰åœ¨æ‹¼å¤šå¤šä¸Šä¹°çš„äºŒæ‰‹Pixel 3å°±å‘ç°è€åŒ–çƒ§å±çš„ç°è±¡ ä»”ç»†è§‚å¯Ÿ**â€œä½ç½®ä¿¡æ¯â€**ä¸€æ ä¼šå‘ç°ï¼Œåœ¨å±å¹•ä¸Šæ®‹ç•™çš„æœ‰è°·æ­Œé‚®ç®±çš„å›¾æ ‡icon å¦‚ä»Šå‚å•†ç”¨å„ç§æ–¹æ¡ˆä¸ºOLEDå»¶é•¿ä½¿ç”¨å¯¿å‘½ï¼Œä¾‹å¦‚å®šæœŸæ”¹å˜è™šæ‹Ÿå¯¼èˆªæ çš„ä½ç½®ã€å®šæœŸè°ƒèŠ‚è‰²æ¸©ç­‰ç­‰ï¼Œä½†æ˜¯ç°é˜¶æ®µçƒ§å±é—®é¢˜è¿˜æ˜¯ä¼šæ™®éå­˜åœ¨çš„OLEDå±å¹•ä¸Š çƒ§å±æ˜¯ä¸€ä¸ªä¸å¯é€†çš„è¿‡ç¨‹ï¼Œä¸€æ—¦æ‰‹æœºå‡ºç°çƒ§å±ï¼Œä¼šä¸¥é‡å½±å“æ—¥å¸¸çš„ä½¿ç”¨ä½“éªŒï¼Œä¸èƒ½å¿çš„è¯åªèƒ½æ¢å±å¹•æˆ–è€…æ¢æ‰‹æœº å›¾ç‰‡æ¥æºï¼šBç«™è¯„è®ºï¼šå…¨ç½‘æœ€ç®€æ´æ˜“æ‡‚çš„OLEDä¸LCDå±å¹•å·¥ä½œåŸç†ä¸ä¼˜åŠ£ç§‘æ™® ä¸ºä»€ä¹ˆOLEDä¼šçƒ§å±ï¼Ÿ è®¨è®ºè¿™ä¸ªé—®é¢˜ä¹‹å‰æˆ‘ä»¬å…ˆæ¥çœ‹LCDå±å’ŒOLEDå±çš„ç»“æ„ç»„æˆ LCDæ˜¯ç”±èƒŒå…‰æ¨¡ç»„ï¼Œä¸‹åå…‰ç‰‡ï¼Œæ¶²æ™¶å±‚ï¼Œæ»¤å…‰å±‚å’Œä¸Šåå…‰ç‰‡ç»„æˆï¼Œé€šè¿‡æ”¹å˜æ–½åŠ åœ¨æ¶²æ™¶å±‚ä¸Šçš„ç”µå‹å¤§å°æ¥æ§åˆ¶æ¯ä¸ªåƒç´ ç‚¹é¢œè‰² å›¾ç‰‡æ¥æºï¼šhttps://zhuanlan.zhihu.com/p/30201452 OLEDæ˜¯æœ‰æœºå‘å…‰ææ–™ä½œå‘å…‰å±‚ï¼Œå‘å…‰å±‚ä¸Šæ–¹æœ‰ä¸€å±‚ä½åŠŸå‡½æ•°çš„é‡‘å±ç”µæï¼Œæ„æˆå¦‚ä¸‰æ˜æ²»çš„ç»“æ„ï¼Œé€šè¿‡æ”¹å˜æ–½åŠ åœ¨è‡ªå‘å…‰äºŒæç®¡ä¸Šçš„ç”µå‹å¤§å°æ¥æ§åˆ¶æ¯ä¸ªçº¢é»„è“å­åƒç´ äº®åº¦ï¼Œè¿›è€Œæ”¹å˜æ¯ä¸ªåƒç´ ç‚¹çš„é¢œè‰² å›¾ç‰‡æ¥æºï¼šhttps://zhuanlan.zhihu.com/p/30201452 å¯¹OLEDå‘å…‰åŸç†æ„Ÿå…´è¶£çš„å¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« ã€ŠOLEDå‘å…‰åŸç†å’ŒOLEDé¢æ¿ç»“æ„åŠOLEDå…³é”®æŠ€æœ¯æ·±åº¦å›¾æ–‡è§£æã€‹ï¼Œæ–‡ä¸­ä»å‘å…‰åŸç†ä»‹ç»åˆ°å±å¹•é©±åŠ¨æŠ€æœ¯å†åˆ°åˆ¶é€ å’Œå°è£…ç­‰360åº¦æ— æ­»è§’è¦†ç›– LCDå±å¹•åŸºæ¿æ˜¯æ— æœºç»ç’ƒææ–™ï¼Œæ‰€ä»¥å‡ ä¹ä¸ä¼šå‘ç”Ÿè€åŒ–ï¼Œè€ŒOLEDåŸºæ¿æ˜¯æœ‰æœºå¡‘æ–™ææ–™ï¼Œå°±æ„å‘³ç€å®ƒä¼šæ¸æ¸è€åŒ– LCDè¦ä¹ˆå…¨äº®è¦ä¹ˆå…¨ç­ï¼Œæ‰€ä»¥å°±ç®—è€åŒ–ï¼Œä¹Ÿæ˜¯å…¨éƒ¨è€åŒ–ï¼Œä½ ä¹Ÿçœ‹ä¸å‡ºæ¥ OLEDç”±äºæ¯ä¸ªåƒç´ ç‚¹æ˜¯è‡ªå‘å…‰ï¼Œè€Œä¸æ˜¯LCDé‚£æ ·æ•´å—å…¨éƒ¨äº®ï¼Œè¿™å°±ä¼šå¯¼è‡´OLEDæ¯ä¸ªåƒç´ ç‚¹å·¥ä½œçš„æ—¶é—´ä¸ä¸€æ · æœ‰çš„åƒç´ ç‚¹æ˜¾ç¤ºè“è‰²çš„æ—¶é—´é•¿ï¼Œé‚£ä¹ˆä»–çš„è“è‰²è¡°å‡å°±ä¼šæ¯”å…¶ä»–åƒç´ ç‚¹å¤šï¼Œæ—¥åå†æ˜¾ç¤ºè“è‰²çš„æ—¶å€™è¿™ä¸€ä¸ªåƒç´ ç‚¹çš„è“è‰²å°±è¦æ¯”å…¶ä½™çš„æ·¡ä¸€ç‚¹ï¼ŒåŒæ ·çš„çº¢è‰²å’Œç»¿è‰²ä¹Ÿæ˜¯ä¸€æ · æ‰€ä»¥OLEDå±å¹•éå¸¸å®¹æ˜“å‘ç”Ÿä¸€ä¸ªç°è±¡å°±æ˜¯çƒ§å±ï¼Œå…¶æœ¬è´¨å°±æ˜¯å±å¹•è€åŒ–ä¸å‡åŒ€å¯¼è‡´çš„æ®‹ç•™ å¦‚ä½•å‡ç¼“çƒ§å±è¿‡ç¨‹ æ—¢ç„¶OLEDçƒ§å±ä¸å¯é¿å…ï¼Œä½œä¸ºæ¶ˆè´¹è€…æˆ‘ä»¬å¯ä»¥åšäº›ä»€ä¹ˆæ¥å‡ç¼“çƒ§å±ç°è±¡å‘¢ï¼Ÿ é™¤äº†å®šæœŸæ›´æ¢å£çº¸ã€è°ƒçŸ­å±å¹•è‡ªåŠ¨é”å®šçš„æ—¶é—´ç­‰æ‰‹æ®µå¤–ï¼Œæˆ‘ä¸ªäººå‘ç°äº†ä¸€ä¸ªæ›´å¥½çš„æ–¹æ¡ˆï¼Œèƒ½å¤Ÿä»æ ¹æœ¬ä¸Šè§£å†³çƒ§å±çš„å¯èƒ½æ€§ï¼š read more books, read more newspapers, eat less snacks and sleep more 2ã€OLEDå±ç¼ºé™·ï¼šä½é¢‘PWMè°ƒå…‰ ä½é¢‘PWMè°ƒå…‰æ˜¯OLEDå±ä¸Šå¦ä¸€ä¸ªç»å¸¸è¢«äººè¯Ÿç—…çš„é—®é¢˜ï¼Œæ‰€è°“çš„ä½é¢‘è°ƒå…‰è¯´å¾—é€šä¿—ç‚¹å°±æ˜¯**â€œé¢‘é—ªâ€** å›¾ç‰‡æ¥æºï¼šhttps://www.igao7.com/news/201807/oJMDaPCKHbeufGdI.html çœ¼ç›é•¿æœŸæš´éœ²åœ¨**â€œé¢‘é—ªâ€**ç¯å¢ƒä¸­ä¼šé€ æˆå¤´ç—›å’Œçœ¼ç–²åŠ³ã€å¯¼è‡´è§†åŠ›ä¸‹é™å’Œæ³¨æ„åŠ›åˆ†æ•£ç­‰é—®é¢˜ è§‚çœ‹ä½é¢‘çš„é¢‘é—ªç”»é¢è¿˜å¯èƒ½ä¼šå¼•å‘å…‰æ•æ€§ç™«ç—«ç—…ï¼Œè¿‘ä»£æœ€è‘—åçš„â€œé¢‘é—ªäº‹æ•…â€å½“å±1997å¹´æ—¥æœ¬ç”µè§†å°çš„â€œ3Dé¾™äº‹ä»¶â€ åœ¨å®å¯æ¢¦ç¬¬38è¯ä¸­ï¼Œä¸ºäº†æ¸²æŸ“ç”µè„‘ä¸–ç•Œä¸­çš„æˆ˜æ–—ï¼Œå¤§é‡ä½¿ç”¨12Hzçš„çº¢è“é—ªå…‰å±•ç¤ºçˆ†ç‚¸åœºé¢ï¼Œç›´æ¥å¯¼è‡´æ—¥æœ¬å…¨å›½å‡ºç°äº†700ä¾‹ç™«ç—«ç—‡(650ä¾‹æ˜¯å„¿ç«¥) å›¾ç‰‡æ¥æºï¼šhttps://www.igao7.com/news/201807/oJMDaPCKHbeufGdI.html æ— ç‹¬æœ‰å¶ï¼Œ2007å¹´çš„ä¼¦æ•¦2012å¹´å®£ä¼ é¢„å‘Šç‰‡ã€2011å¹´çš„ã€Šæš®å…‰ä¹‹åŸï¼šç ´æ™“ã€‹éƒ½æœ‰è¿‡â€œå› è‰²å—é—ªçƒï¼Œå¯¼è‡´è§‚ä¼—ç™«ç—«å‘ä½œâ€çš„äº‹ä»¶ æ³¨ï¼šä¸å»ºè®®è¯»è€…å°è¯•ï¼Œç¬”è€…åœ¨å†™è¿™ç¯‡æ–‡ç« æ—¶åªæ˜¯çœ‹GIFåŠ¨å›¾éƒ½è§‰å¾—å¤´æ™•æ¶å¿ƒï¼Œæ— æ³•æŒ‰æºå¥½å¥‡å¿ƒçš„åŒå­¦èº«è¾¹ä¸€å®šè¦æœ‰äººé™ªåŒå†å»è§‚çœ‹åŸç‰‡ï¼Œä¸å¼€ç©ç¬‘ PWMæ˜¯ä»€ä¹ˆï¼Ÿ å›åˆ°æˆ‘ä»¬çš„ä¸»è§’PWMè°ƒå…‰ã€‚PWMï¼Œå…¨ç§°Pulse Width Modulationï¼Œç¿»è¯‘è¿‡æ¥å°±æ˜¯è„‰å†²å®½åº¦è°ƒåˆ¶ï¼Œè¯´åˆ°åº•ï¼Œå°±æ˜¯ç§æŠŠæ¨¡æ‹Ÿä¿¡å·è°ƒåˆ¶æˆè„‰æ³¢çš„æŠ€æœ¯ï¼Œå®ƒå·²ç»æ˜¯åº”ç”¨éå¸¸å¹¿æ³›çš„æ˜¾ç¤ºå™¨/å…‰æºçš„äº®åº¦æ§åˆ¶æ–¹æ¡ˆ æ­¤å¤–ï¼Œè¿˜æœ‰æˆ‘ä»¬åé¢ä¼šæåˆ°çš„DCç›´æµè°ƒå…‰(LEDé¢†åŸŸçš„CCRæ’æµè°ƒå…‰ï¼Œä¸ºæ–¹ä¾¿è¡¨ç¤ºï¼Œåç»­ç”¨DCè°ƒå…‰ä»£ç§°) è¿›å…¥ä¸»é¢˜å‰æˆ‘ä»¬éœ€è¦äº†è§£ä»€ä¹ˆæ˜¯**â€œè§†è§‰æš‚ç•™â€**ç°è±¡ï¼š å½“äººçœ‹åˆ°ä¸€å¹…ç”»é¢å¿«é€Ÿé—ªè¿‡æ—¶ï¼Œè¿™å¹…ç”»é¢äº§ç”Ÿçš„è§†è§‰åˆºæ¿€ä¼šåœ¨å¤§è„‘ä¸­åœç•™å‡ ååˆ°å‡ ç™¾æ¯«ç§’æ—¶é—´ï¼Œäº®åº¦è¶Šäº®ï¼Œåœç•™çš„æ—¶é—´è¶Šé•¿ï¼Œè¿™ä¸€ç‰¹å¾æˆ‘ä»¬ç§°ä¸ºâ€œè§†è§‰æš‚ç•™â€ PWMå°±æ˜¯åˆ©ç”¨äººçœ¼çš„è§†è§‰æš‚åœç°è±¡æ¥å®ç°äº®åº¦è°ƒèŠ‚çš„ï¼Œå…·ä½“åŸç†å¯ä»¥å»Bç«™çœ‹â€œç¡¬ä»¶èŒ¶è°ˆâ€çš„ã€Šå…¨ç½‘æœ€ç®€æ´æ˜“æ‡‚çš„OLEDä¸LCDå±å¹•å·¥ä½œåŸç†ä¸ä¼˜åŠ£ç§‘æ™®ã€‹è¿™æœŸèŠ‚ç›® ç®€å•æ€»ç»“ä¸€ä¸‹å°±æ˜¯ï¼š åœ¨PWMè°ƒå…‰å±å¹•ä¸Šï¼Œè°ƒèŠ‚äº®åº¦å¹¶ä¸é æ”¹å˜åŠŸç‡ï¼Œè€Œæ˜¯é å±å¹•çš„äº®ã€ç­äº¤æ›¿æ˜¾ç¤ºæ¥æ”¹å˜äº®åº¦ å±å¹•äº®åº¦ä¸º100%æ—¶ï¼Œè‡ªå‘å…‰äºŒæç®¡ä¸€ç›´äº®ï¼Œäº®åº¦ä¸º80%æ—¶ï¼Œä¸€ä¸ªPWMå‘¨æœŸå†…äº®80%çš„æ—¶é—´åœ¨äº®ï¼Œå‰©ä¸‹çš„20%çš„æ—¶é—´æ˜¯ç­çš„ï¼Œå±å¹•ä¼šä¸åœåœ°ç‚¹äº®ã€ç†„ç­ï¼Œå½“äº¤æ›¿é€Ÿåº¦å¤Ÿå¿«æ—¶ï¼Œè‚‰çœ¼å°±ä¼šè®¤ä¸ºæ‰‹æœºä¸€ç›´åœ¨äº® PWMç›¸å…³å‚æ•° è¿™é‡Œå¤šå‡ºäº†ä¸€ä¸ªPWMå‘¨æœŸçš„æ¦‚å¿µï¼Œè§£é‡Šä¸€ä¸‹ ä½¿ç”¨PWMè°ƒå…‰çš„æ‰‹æœºé€šå¸¸éƒ½æ ‡æœ‰è°ƒå…‰é¢‘ç‡å‚æ•°ï¼Œä»¥æˆ‘æ‰‹é‡Œçš„Pixel 3ä¸¾ä¾‹ï¼Œè°ƒå…‰é¢‘ç‡ä¸º245HZ 1. PWMé¢‘ç‡ï¼š é¢‘ç‡æ˜¯æŒ‡1ç§’é’Ÿå†…ä¿¡å·ä»é«˜ç”µå¹³åˆ°ä½ç”µå¹³å†å›åˆ°é«˜ç”µå¹³çš„æ¬¡æ•°(ä¸€ä¸ªå‘¨æœŸ)ï¼Œè¡¨ç¤ºå•ä½ï¼šHZ 2. PWMå‘¨æœŸï¼š ä¸€æ¬¡è„‰å†²å‘¨æœŸçš„æ—¶é—´ï¼ŒPixel 3è°ƒå…‰é¢‘ç‡æœ€é«˜245HZï¼Œæ¢ç®—æˆä¸€ä¸ªPWMå‘¨æœŸä¸ºï¼š1s/245â‰ˆ4ms 3. å ç©ºæ¯” ä¸€æ¬¡PWMå‘¨æœŸä¸­ï¼Œé«˜ç”µå¹³ä¸æ•´ä¸ªå‘¨æœŸæ—¶é—´çš„æ¯”ä¾‹ã€‚ä¾æ—§ä»¥Pixel 3ä¸¾ä¾‹ï¼Œé«˜ç”µå¹³æ—¶é—´ä¸º2msæ—¶ï¼Œå ç©ºæ¯” = 2ms/4ms=50% ä»è¿™å‡ ä¸ªå…³äºPWMçš„å‚æ•°å¯ä»¥çœ‹å‡ºæ¥ï¼Œè°ƒå…‰é¢‘ç‡è¶Šé«˜ï¼Œäººçœ¼å‘è§‰é¢‘é—ªçš„æœºä¼šå°±è¶Šå°ï¼Œå¯¹çœ¼ç›çš„ä¼¤å®³ä¹Ÿå°±è¶Šå° æ‰€ä»¥æ‰‹æœºå‚å•†è¿‘äº›å¹´æ¨å‡ºçš„æœºå‹éƒ½å®£ä¼ è‡ªå·±ä½¿ç”¨é«˜é¢‘PWMè°ƒå…‰æŠ€æœ¯ï¼Œæ²¡é’±æ¢æ–°æ‰‹æœºçš„åŒå­¦ä¹Ÿä¸ç”¨æ‹…å¿ƒOLEDå±å¹•ä¼¤çœ¼ï¼Œå¹³æ—¥ä½¿ç”¨æ‰‹æœºæ—¶å°½é‡æŠŠäº®åº¦è°ƒé«˜ï¼Œè®©é«˜ç”µå¹³æŒç»­çš„æ—¶é—´å˜é•¿ï¼ŒåŒæ ·ä¹Ÿå¯ä»¥èµ·åˆ°é™ä½**â€œé¢‘é—ªâ€**ï¼Œä¿æŠ¤çœ¼ç›çš„æ•ˆæœ æ³¨ï¼šå¯¹è‡ªå·±æ‰‹æœºå±å¹•å‚æ•°æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å»è¿™ä¸ªç½‘ç«™æŸ¥è¯¢ï¼šwww.notebookcheck.net å¦‚ä½•åˆ†è¾¨æ˜¯DCè°ƒå…‰è¿˜æ˜¯PWMè°ƒå…‰ è®²å®Œäº†PWMè°ƒå…‰ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä»‹ç»ä¸€ä¸‹å¦‚ä½•åˆ†è¾¨æ‰‹æœºæ˜¯DCè°ƒå…‰è¿˜æ˜¯PWMè°ƒå…‰ 1.1å°èŠ‚ä»‹ç»äº†LCDå±å¹•çš„ç»“æ„ç»„æˆï¼ŒçŸ¥é“äº†LCDå±å¹•èƒŒåæ˜¯ä¸€æ•´å—çš„èƒŒå…‰æ¨¡ç»„ï¼Œæ‰€ä»¥è°ƒæ•´å±å¹•äº®åº¦åªéœ€è¦è°ƒæ•´**â€œèƒŒå…‰æ¨¡ç»„â€çš„äº®åº¦å³å¯ï¼Œè¿™å°±æ˜¯â€œDCè°ƒå…‰â€** PWMè°ƒå…‰åˆ™æ˜¯åˆ©ç”¨äººçœ¼çš„**â€œè§†è§‰æ®‹ç•™â€ç°è±¡ï¼Œé€šè¿‡è°ƒèŠ‚â€œå ç©ºæ¯”â€**æ¥æ§åˆ¶å±å¹•çš„äº®åº¦ å»åº”ç”¨å•†åº—ä¸‹è½½ä¸€ä¸ªå¯ä»¥è°ƒèŠ‚å¿«é—¨é€Ÿåº¦çš„ç¬¬ä¸‰æ–¹ç›¸æœºï¼Œè°ƒé«˜å¿«é—¨é€Ÿåº¦æ‹æ‰‹æœºå±å¹•ï¼Œè¢«æ‹æ‘„çš„æ‰‹æœºå±å¹•äº®åº¦åˆ«å¤ªé«˜ï¼Œè°ƒåˆ°50%å·¦å³ å¦‚ä¸‹å›¾ï¼Œæœ‰æ¡çº¹çš„å°±æ˜¯**â€œPWMè°ƒå…‰â€ï¼Œæ²¡æœ‰æ¡çº¹åˆ™æ˜¯â€œDCè°ƒå…‰â€** æˆ‘ä»¬çœ‹åˆ°çš„é»‘è‰²æ¡çº¹å…¶å®å°±æ˜¯PWMå‘¨æœŸä¸­ä½ç”µå¹³çš„æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯åƒç´ ç‚¹ç†„ç­çš„æ—¶é—´ äºŒã€ç»“è¯­ OLEDå±å¹•çƒ§å±å’Œä½é¢‘PWMè°ƒå…‰éƒ½å·²ç»ä»‹ç»å®Œäº†ï¼Œç›®å‰å¸‚é¢ä¸Šå¤§å¤šæ•°OLEDå±å¹•ä½¿ç”¨çš„éƒ½æ˜¯PWMè°ƒå…‰ï¼ŒLCDå±å¹•åˆ™å¤§éƒ¨åˆ†ä½¿ç”¨DCè°ƒå…‰ ä½†æˆ‘ä»¬è¿˜æ˜¯è¦æŠŠå±å¹•çš„æè´¨å’Œè°ƒå…‰æ–¹å¼åŒºåˆ†å¼€æ¥ï¼Œå› ä¸ºå¹¶éæ‰€æœ‰çš„OLEDå±å¹•éƒ½æ˜¯PWMè°ƒå…‰ï¼ŒåŒæ ·çš„ï¼Œä¹Ÿä¸æ˜¯æ‰€æœ‰çš„LCDå±å¹•éƒ½æ˜¯DCè°ƒå…‰ï¼Œä¾‹å¦‚é‡‡ç”¨LCDå±å¹•çš„è£è€€Playä½¿ç”¨çš„å°±æ˜¯PWMè°ƒå…‰ å›åˆ°æˆ‘ä»¬çš„æ ‡é¢˜ï¼ŒLCDå’ŒOLEDå±å¹•è¯¥æ€ä¹ˆé€‰ï¼Ÿ å°±æˆ‘ä¸ªäººç»éªŒæ¥çœ‹ï¼Œæˆ‘æ˜¯åå‘OLEDå±å¹•çš„ï¼Œä»iPhone Xåˆ°ç°åœ¨çš„iPhone 12Proï¼ŒOLEDçš„é¢‘é—ªå¯¹æˆ‘æ²¡ä»€ä¹ˆå½±å“ï¼Œåè€Œè¿˜æŒºå–œæ¬¢OLEDå±å¸¦æ¥çš„æ›´é«˜çš„äº®åº¦ï¼Œè‡³äºçƒ§å±ï¼Œæˆ‘çš„ä¸»åŠ›æœºè¿˜æ²¡æœ‰é‡åˆ°è¿‡ï¼ŒçœŸæ­£å‘ç”Ÿçš„æ—¶å€™å¤§ä¸äº†æ¢ä¸ªå±å¹• ä¸è¿‡äººçœ¼å¯¹é¢‘é—ªæ•æ„Ÿç¨‹åº¦ä¸åŒï¼Œçš„ç¡®æœ‰äº›å°ä¼™ä¼´ä½¿ç”¨OLEDå±å¹•åå‡ºç°çœ¼ç›å¹²æ¶©ã€çœ¼ç–²åŠ³ç­‰é—®é¢˜ï¼Œè¿™éƒ¨åˆ†äººç¾¤å»ºè®®è¿˜æ˜¯ä½¿ç”¨DCè°ƒå…‰çš„å±å¹• åœ¨æ–‡ç« çš„æœ€åï¼Œè¿˜æ˜¯å»ºè®®å¤§å®¶å°‘ç©æ‰‹æœºï¼Œå¤šå‡ºå»èµ°èµ°ï¼Œé—»ä¸€é—»è·¯è¾¹çš„é‡èŠ±ï¼Œè§ä¸€è§æƒ³å¿µçš„äººï¼Œæ‰èƒ½çœŸæ­£çš„ä¿æŠ¤çœ¼ç› ä¸‰ã€å‚è€ƒèµ„æ–™ CSDN-Zå°æ—‹-PWMé¢‘ç‡ä¸å ç©ºæ¯”è¯¦è§£ï¼šhttps://blog.csdn.net/as480133937/article/details/103439546 ç¡¬ä»¶èŒ¶è°ˆ-å…¨ç½‘æœ€ç®€æ´æ˜“æ‡‚çš„OLEDä¸LCDå±å¹•å·¥ä½œåŸç†ä¸ä¼˜åŠ£ç§‘æ™®ï¼šhttps://www.bilibili.com/video/BV1Wz411B7Tf PWMè°ƒå…‰ç§‘æ™®(ä¸Šç¯‡)-äººç±»æ˜¾ç¤ºå™¨çš„é»‘å†å²ï¼šhttps://www.igao7.com/news/201807/oJMDaPCKHbeufGdI.html èµ°è¿›è‡ªå¸¦å…‰èŠ’çš„æœ‰æœºå‘å…‰äºŒæç®¡ï¼ˆOLEDï¼‰ææ–™ç»šä¸½å¤šå½©ä¸–ç•Œï¼Œé¢†æ‚Ÿå‰æ²¿çš„ç ”ç©¶è¿›å±•ï¼šhttp://www.cailiaoniu.com/232822.html æœ‰æœºå‘å…‰äºŒæç®¡| 8ä¼˜ç‚¹å’Œç¼ºç‚¹ï¼šhttps://zh-cn.lambdageeks.com/organic-light-emitting-diodes/ OLEDå‘å…‰åŸç†å’ŒOLEDé¢æ¿ç»“æ„åŠOLEDå…³é”®æŠ€æœ¯æ·±åº¦å›¾æ–‡è§£æ ","link":"https://yibaoshan.github.io/post/android-graphics-first/"},{"title":"Androidç»„ä»¶ç³»åˆ—ï¼šHandleræœºåˆ¶è¯¦è§£","content":" ç‚¹å‡»è·³è½¬åˆ°æ˜é‡‘é˜…è¯» Overview æ¯ä¸ªAndroidå¼€å‘è€…éƒ½æˆ–å¤šæˆ–å°‘çš„äº†è§£è¿‡Android Handleræœºåˆ¶ï¼Œä¸ºäº†ä¸æµªè´¹å¤§å®¶æ—¶é—´ï¼Œåœ¨æ–‡ç« å¼€å§‹ä¹‹å‰ï¼Œæˆ‘è®¤ä¸ºæœ‰å¿…è¦è¯´æ˜ä¸€ä¸‹æœ¬æ–‡çš„ç›®æ ‡å—ä¼— é€‚åˆäººç¾¤ï¼š 1ã€Androidæ–°æ‰‹å¼€å‘ï¼Œå¯¹Handleræœºåˆ¶è¿˜ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œæƒ³è¦äº†è§£Handlerå†…éƒ¨æ˜¯å¦‚ä½•è¿è¡Œçš„ 2ã€å…¶ä»–å®¢æˆ·ç«¯å¼€å‘ï¼Œæ¯”å¦‚iOSã€Windowså¼€å‘ç­‰ï¼Œæƒ³è¦äº†è§£åœ¨Androidç³»ç»Ÿä¸­æ˜¯å¦‚ä½•åœ¨éUIçº¿ç¨‹æ›´æ–°ç•Œé¢çš„ ä¸é€‚åˆäººç¾¤ï¼š 1ã€ä¸­é«˜çº§å·¥ç¨‹å¸ˆï¼Œå¯¹Handleræœºåˆ¶äº†è§£çš„å¾ˆæ·±å…¥äº†ï¼Œè¿™ç¯‡æ–‡ç« çº¯å±æµªè´¹æ—¶é—´ 2ã€è§‰å¾—æºç è¿‡äºæ¯ç‡¥ï¼Œæƒ³è¦æ‰¾ä¸€ç¯‡æ–‡ç« å¯¹ç…§ç€çœ‹ï¼Œæœ¬æ–‡å¯èƒ½ä¸æ˜¯å¾ˆåˆé€‚ï¼Œå› ä¸ºæ–‡ç« ä¸­å¹¶ä¸ä¼šæ¶‰åŠå¤ªå¤šçš„æºç  ä¸€ã€å‰è¨€ Android Handleræœºåˆ¶æ˜¯æ¯ä¸ªAndroidå¼€å‘è€…æˆé•¿é“è·¯ä¸Šä¸€é“ç»•ä¸è¿‡å»çš„åï¼Œäº†è§£Handleræœºåˆ¶å¯¹äºè§£å†³å¼€å‘ä¸­çš„é‡åˆ°çš„å¡é¡¿æ£€æµ‹ã€ANRç›‘æ§ï¼Œä»¥åŠäº†è§£APPç»„ä»¶æ˜¯å¦‚ä½•è¿è¡Œçš„ç­‰é—®é¢˜æœ‰ç€éå¸¸å¤§çš„å¸®åŠ© å¸‚é¢ä¸Šå·²ç»æœ‰è®¸å¤šè®²è§£Handleræœºåˆ¶çš„æ–‡ç« ï¼Œå„ç§è§’åº¦çš„éƒ½æœ‰ï¼Œå…¶ä¸­ä¸ä¹æœ‰ä¸å°‘æ·±åº¦å¥½æ–‡ï¼›æœ¬æ–‡ä¸è®²è§£æºç (ä¸»è¦æ˜¯è®²ä¸è¿‡å…¶ä»–æ–‡ç« )ï¼Œä»Android Handleræœºåˆ¶çš„è®¾è®¡æ€æƒ³å¼€å§‹è®²èµ·ï¼Œç”±æµ…å…¥æ·±ï¼Œå¸¦ä½ ä¸€æ­¥æ­¥èµ°è¿›Handlerå†…éƒ¨çš„å®ç°åŸç† ä»¥ä¸‹ï¼Œenjoyï¼š äºŒã€Handlerè®¾è®¡èƒŒæ™¯ åœ¨Androidå¼€å‘è€…å®˜ç½‘å¯¹Viewçš„ä»‹ç»æœ‰è¿™æ ·ä¸€å¥è¯ï¼š å›¾ç‰‡æ¥æºï¼šAndroid Developer æ•´ä¸ªè§†å›¾æ ‘æ˜¯å•çº¿ç¨‹çš„ï¼Œ åœ¨ä»»ä½•è§†å›¾ä¸Šè°ƒç”¨ä»»ä½•æ–¹æ³•æ—¶ï¼Œå¿…é¡»å§‹ç»ˆåœ¨ UI çº¿ç¨‹ä¸Šã€‚å¦‚æœåœ¨å…¶ä»–çº¿ç¨‹ä¸Šå·¥ä½œå¹¶å¸Œæœ›ä»è¯¥çº¿ç¨‹æ›´æ–°è§†å›¾çš„çŠ¶æ€ï¼Œåˆ™åº”è¯¥ä½¿ç”¨Handler ä¸åªæ˜¯Androidï¼Œåœ¨iOSå¼€å‘è€…å®˜ç½‘å¯¹UIKitä»‹ç»ä¸­åŒæ ·æœ‰ç±»ä¼¼æç¤ºï¼š å›¾ç‰‡æ¥æºï¼šApple iOS Developer é™¤éå¦æœ‰è¯´æ˜ï¼Œå¦åˆ™åªèƒ½ä»åº”ç”¨ç¨‹åºçš„ä¸»çº¿ç¨‹æˆ–ä¸»è°ƒåº¦é˜Ÿåˆ—ä¸­ä½¿ç”¨ UIKit ç±»ã€‚ æ­¤é™åˆ¶ç‰¹åˆ«é€‚ç”¨äºä» UIResponder æ´¾ç”Ÿçš„ç±»æˆ–æ¶‰åŠä»¥ä»»ä½•æ–¹å¼æ“ä½œåº”ç”¨ç¨‹åºç”¨æˆ·ç•Œé¢çš„ç±»ã€‚ å¥‡äº†æ€ªäº†ï¼ŒAndroidå’ŒiOSä½œä¸ºä¸€ä¸ªæœ‰å›¾å½¢ç”¨æˆ·ç•Œé¢(Graphical User InterfaceI)çš„æ“ä½œç³»ç»Ÿï¼Œä¸ºä»€ä¹ˆéƒ½è¦æ±‚åœ¨ä¸»çº¿ç¨‹(UIçº¿ç¨‹)æ“ä½œé¡µé¢ï¼Ÿ 1ã€GUIä¸ºä»€ä¹ˆè¦è®¾è®¡æˆå•çº¿ç¨‹ï¼Ÿ å…³äºGUIä¸ºä»€ä¹ˆè¦è®¾è®¡æˆå•çº¿ç¨‹è¿™ä¸ªé—®é¢˜ï¼Œå‰Sunçš„å‰¯æ€»è£Graham Hamiltonåœ¨è®¾è®¡Java Swingæ—¶ï¼Œæ›¾ç»å†™è¿‡ä¸€ç¯‡æ–‡ç« ä¸“é—¨èŠè¿‡ï¼šMultithreaded toolkits: A failed dream? æœ€è¿‘æœ‰äººæå‡ºä¸€ä¸ªé—®é¢˜ï¼Œâ€œæˆ‘ä»¬æ˜¯å¦åº”è¯¥è®© Swing åº“çœŸæ­£å®ç°å¤šçº¿ç¨‹ï¼Ÿâ€ æˆ‘ä¸ªäººè§‰å¾—ä¸åº”è¯¥ï¼Œä¸‹é¢é˜è¿°ç†ç”±ã€‚ æ— æ³•å®ç°çš„æ¢¦æƒ³ï¼ˆFailed Dreamï¼‰ å€Ÿç”¨ Vernor Vinge çš„æœ¯è¯­ï¼Œåœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼ŒæŸäº›æƒ³æ³•æ˜¯â€œæ— æ³•å®ç°çš„æ¢¦æƒ³â€ã€‚è¿™ç§æƒ³æ³•åˆæ­¥çœ‹æ¥å¾ˆå¥½ï¼Œäººä»¬éš”ä¸€æ®µæ—¶é—´å°±ä¼šé‡æ–°å†’å‡ºè¿™ç§æƒ³æ³•ï¼Œå¹¶ä¸ºæ­¤èŠ±è´¹å¾ˆå¤šæ—¶é—´ã€‚é€šå¸¸åœ¨ç ”ç©¶é˜¶æ®µï¼Œäº‹æƒ…è¿›å±•é¡ºåˆ©ï¼Œæœ‰ä¸€äº›è®©äººæ„Ÿå…´è¶£çš„æˆæœï¼Œå·®ä¸å¤šå¯ä»¥åº”ç”¨åˆ°ç”Ÿäº§è§„æ¨¡ä¸Šäº†ã€‚åªæ˜¯æ€»æœ‰äº›é—®é¢˜è§£å†³ä¸äº†ï¼Œè§£å†³äº†è¿™è¾¹çš„é—®é¢˜ï¼Œé‚£è¾¹åˆæœ‰é—®é¢˜å†’å‡ºæ¥ã€‚ åœ¨æˆ‘çœ‹æ¥ï¼Œå¤šçº¿ç¨‹çš„ GUI å·¥å…·åŒ…ï¼Œå°±æ˜¯è¿™ç§æ— æ³•å®ç°çš„æ¢¦æƒ³ã€‚åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œä»»æ„ä¸€ä¸ªçº¿ç¨‹éƒ½å¯ä»¥å»æ›´æ–°æŒ‰é’®(Button)ã€æ–‡æœ¬å­—æ®µ(Text Field)ç­‰ GUI çŠ¶æ€ï¼Œè¿™ä¼¼ä¹æ˜¯ç†æ‰€å½“ç„¶ã€ç›´æˆªäº†å½“çš„åšæ³•ã€‚ä»»æ„çº¿ç¨‹å»æ›´æ–° GUI çŠ¶æ€ï¼Œæ— éæ˜¯åŠ ä¸€äº›é”ï¼Œåˆæœ‰ä»€ä¹ˆéš¾çš„å‘¢ï¼Ÿå®ç°è¿‡ç¨‹ä¸­å¯èƒ½ä¼šæœ‰ä¸€äº›é”™è¯¯ï¼Œä½†æˆ‘ä»¬å¯ä»¥ä¿®å¤è¿™äº›é”™è¯¯ï¼Œå¯¹å§ï¼Ÿå¯æƒœäº‹å®è¯æ˜æ²¡æœ‰è¿™æ ·ç®€å•ã€‚ å¤šçº¿ç¨‹çš„ GUI æœ‰ç§ä¸å¯æ€è®®çš„è¶‹åŠ¿ï¼Œä¼šä¸æ–­å‘ç”Ÿæ­»é”æˆ–è€…ç«äº‰æ¡ä»¶ã€‚æˆ‘ç¬¬ä¸€æ¬¡çŸ¥é“è¿™è¶‹åŠ¿ï¼Œæ˜¯åœ¨ 80 å¹´ä»£åˆæœŸï¼Œä» Xerox PARC çš„ Cedar GUI åº“ä¸­å·¥ä½œçš„é‚£äº›äººä¸­å¬æ¥çš„ã€‚è¿™æ‰¹äººéƒ½ååˆ†èªæ˜ï¼Œä¹ŸçœŸæ­£äº†è§£å¤šçº¿ç¨‹ç¼–ç¨‹ã€‚ä»–ä»¬çš„ GUI ä»£ç æ—¶ä¸æ—¶å°±æœ‰æ­»é”é—®é¢˜ï¼Œè¿™ä»¶äº‹æœ¬èº«å°±å¾ˆæœ‰è¶£ã€‚å•ç‹¬è¿™äº‹ä¸èƒ½è¯´æ˜ä»€ä¹ˆï¼Œæˆ–è€…åªæ˜¯ç‰¹æ®Šæƒ…å†µã€‚ åªæ˜¯è¿™äº›å¹´æ¥ä¸æ–­é‡å¤è¿™ä¸€æ¨¡å¼ã€‚äººä»¬æœ€å¼€å§‹é‡‡ç”¨å¤šçº¿ç¨‹ï¼Œæ…¢æ…¢åœ°ï¼Œä»–ä»¬è½¬æ¢åˆ°äº†äº‹ä»¶é˜Ÿåˆ—æ¨¡å‹ã€‚â€œæœ€å¥½è®©äº‹ä»¶çº¿ç¨‹åš GUI çš„å·¥ä½œã€‚&quot; ...ç•¥ ä¸ºä»€ä¹ˆè¿™ä¹ˆéš¾ æˆ‘ä»¬ä½¿ç”¨æŠ½è±¡æ¥ç¼–å†™ä»£ç ï¼Œå¾ˆè‡ªç„¶åœ°ä¼šåœ¨æ¯ä¸ªæŠ½è±¡å±‚ä¸­å•ç‹¬ä¸Šé”ã€‚äºæ˜¯å¾ˆä¸å¹¸åœ°ï¼Œæˆ‘ä»¬å°±é‡åˆ°ç»å…¸çš„é”å®šé¡ºåºå™©æ¢¦ï¼šæœ‰ä¸¤ç§ä¸åŒç±»å‹çš„æ´»åŠ¨ï¼ŒæŒ‰ç…§ç›¸åçš„é¡ºåºï¼Œè¯•å›¾è·å–é”ã€‚å› è€Œæ­»é”ä¸å¯é¿å…ã€‚ ...ç•¥ æ¥è‡ªï¼šMultithreaded toolkits: A failed dream?ï¼ŒåŸç½‘é¡µå·²ç»404ï¼ŒæŸ¥çœ‹åŸæ–‡å¯ä»¥ç‚¹å‡»ä¸‹é¢ä¸¤ä¸ªé“¾æ¥ CSDNåŸæ–‡å¤‡ä»½ çŸ¥ä¹ç¿»è¯‘ï¼šå¤šçº¿ç¨‹ GUI å·¥å…·åŒ…ï¼šæ— æ³•å®ç°çš„æ¢¦æƒ³ï¼Ÿ ç®€å•æ¥è¯´ï¼Œå¤šçº¿ç¨‹æ“ä½œä¸€ä¸ªUIï¼Œå¾ˆå®¹æ˜“å¯¼è‡´ï¼Œæˆ–è€…æå…¶å®¹æ˜“å¯¼è‡´åå‘åŠ é”å’Œæ­»é”é—®é¢˜ æˆ‘ä»¬é€šè¿‡ç”¨æˆ·çº§çš„ä»£ç å»æ”¹å˜ç•Œé¢ï¼Œå¦‚TextView.setTextèµ°çš„æ˜¯ä¸ªè‡ªé¡¶å‘ä¸‹çš„æµç¨‹ï¼š å›¾ç‰‡æ¥æºï¼šGUIä¸ºä»€ä¹ˆä¸è®¾è®¡ä¸ºå¤šçº¿ç¨‹ è€Œç³»ç»Ÿåº•å±‚å‘èµ·çš„å¦‚é”®ç›˜äº‹ä»¶ã€ç‚¹å‡»äº‹ä»¶èµ°çš„æ˜¯ä¸ªè‡ªåº•å‘ä¸Šçš„æµç¨‹ï¼š å›¾ç‰‡æ¥æºï¼šGUIä¸ºä»€ä¹ˆä¸è®¾è®¡ä¸ºå¤šçº¿ç¨‹ è¿™æ ·å°±éº»çƒ¦äº†ï¼Œå› ä¸ºä¸ºäº†é¿å…æ­»é”ï¼Œæ¯ä¸ªæµç¨‹éƒ½è¦èµ°ä¸€æ ·çš„åŠ é”é¡ºåºï¼Œè€ŒGUIä¸­çš„è¿™ä¸¤ä¸ªæµç¨‹å´æ˜¯å®Œå…¨ç›¸åçš„ï¼Œå¦‚æœæ¯ä¸€å±‚éƒ½æœ‰ä¸€ä¸ªé”çš„è¯åŠ é”å°±æ˜¯ä¸ªéš¾ä»¥å®Œæˆçš„ä»»åŠ¡äº†ï¼Œè€Œå¦‚æœæ¯ä¸€å±‚éƒ½å…±ç”¨ä¸€ä¸ªé”çš„è¯ï¼Œé‚£å°±è·Ÿå•çº¿ç¨‹æ²¡åŒºåˆ«äº†ã€‚ ç»¼ä¸Šï¼Œç›®å‰ä¸»æµçš„å¸¦æœ‰ç”¨æˆ·ç•Œé¢(GUI)çš„æ“ä½œç³»ç»Ÿï¼Œé™¤äº†DOSå¤–ï¼Œå‡ ä¹éƒ½æ˜¯ä½¿ç”¨UIå•çº¿ç¨‹æ¨¡å‹çš„æ–¹æ¡ˆï¼Œå³æ¶ˆæ¯é˜Ÿåˆ—æœºåˆ¶ 2ã€ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—æœºåˆ¶ï¼Ÿ æåˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè‡ªç„¶è€Œç„¶å°±ä¼šæƒ³åˆ°ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ï¼Œåœ¨ã€Šä»Androidæºç è§’åº¦è°ˆè®¾è®¡æ¨¡å¼ï¼ˆä¸‰ï¼‰ï¼šè¡Œä¸ºå‹æ¨¡å¼ã€‹ä¸€æ–‡ä¸­æˆ‘ä»¬å·²ç»ä»‹ç»è¿‡äº†ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ï¼Œè¿˜æ²¡æœ‰çœ‹è¿‡çš„åŒå­¦å¯ä»¥å…ˆçœ‹å®Œå†å›æ¥ï¼Œè¿™é‡Œæ¥ç®€å•å›é¡¾ä¸€ä¸‹ï¼š åœ¨ä¸€ä¸ªç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ä¸­ï¼Œé€šå¸¸ä¼šæœ‰ä¸‰ä¸ªè§’è‰² æ¶ˆæ¯é˜Ÿåˆ—(single) è´Ÿè´£ä¿å­˜æ¶ˆæ¯ï¼Œæä¾›å­˜å–æ¶ˆæ¯çš„åŠŸèƒ½ ç”Ÿäº§è€…(multiple) è´Ÿè´£ç”Ÿäº§æ¶ˆæ¯ï¼Œå¡åˆ°å…±äº«çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­ æ¶ˆè´¹è€…(multiple) è´Ÿè´£ä»å…±äº«æ¶ˆæ¯é˜Ÿåˆ—ä¸­å–å‡ºæ¶ˆæ¯ï¼Œæ‰§è¡Œæ¶ˆæ¯å¯¹åº”çš„ä»»åŠ¡ è¿™ä¸‰ä¸ªè§’è‰²ä¸­ï¼Œå› ä¸ºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…è¦ä»åŒä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—å–æ”¾æ¶ˆæ¯ï¼Œæ‰€ä»¥æ¶ˆæ¯é˜Ÿåˆ—çš„æ•°é‡è¦æ±‚æ˜¯å”¯ä¸€çš„ï¼Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„æ•°é‡å¯ä»¥ä»»æ„ æˆ‘ä»¬å›åˆ°Androidç³»ç»Ÿï¼ŒGUIæ¡†æ¶å¤šæ•°ä½¿ç”¨å•çº¿ç¨‹è®¾è®¡ï¼Œé‚£ä¹ˆå°±è¦æ±‚æ‰€æœ‰çš„UIæ“ä½œéƒ½åªèƒ½å‘ç”Ÿåœ¨ä¸€ä¸ªçº¿ç¨‹å½“ä¸­ï¼Œå³ï¼š æ¶ˆè´¹è€…çº¿ç¨‹åªæœ‰ä¸€ä¸ªï¼Œä¸”æ¶ˆè´¹è€…çº¿ç¨‹å°±æ˜¯UIçº¿ç¨‹ åˆ°äº†è¿™é‡Œï¼Œå…³äºæ¶ˆæ¯é˜Ÿåˆ—æœºåˆ¶åº”è¯¥æœ‰ä¸ªæ¸…æ™°çš„æ¦‚å¿µäº†ï¼Œæˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹ï¼š Androidã€Swingã€iOSç­‰çš„GUIåº“éƒ½ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—æœºåˆ¶æ¥å¤„ç†ç»˜åˆ¶ç•Œé¢ã€äº‹ä»¶å“åº”ç­‰æ¶ˆæ¯ åœ¨è¿™ç§è®¾è®¡ä¸­ï¼Œæ¯ä¸ªå¾…å¤„ç†çš„ä»»åŠ¡éƒ½è¢«å°è£…æˆä¸€ä¸ªæ¶ˆæ¯æ·»åŠ åˆ°æ¶ˆæ¯é˜Ÿåˆ—é‡Œ æ¶ˆæ¯é˜Ÿåˆ—æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ˆæ¶ˆæ¯é˜Ÿåˆ—è‡ªå·±é€šè¿‡åŠ é”ç­‰æœºåˆ¶ä¿è¯æ¶ˆæ¯ä¸ä¼šåœ¨å¤šçº¿ç¨‹ç«äº‰ä¸­ä¸¢å¤±ï¼‰ï¼Œä»»ä½•çº¿ç¨‹éƒ½å¯ä»¥æ·»åŠ æ¶ˆæ¯åˆ°è¿™ä¸ªé˜Ÿåˆ—ä¸­ ä½†æ˜¯ï¼Œåªæœ‰ä¸»çº¿ç¨‹ï¼ˆUIçº¿ç¨‹ï¼‰ä»ä¸­å–å‡ºæ¶ˆæ¯ï¼Œå¹¶æ‰§è¡Œæ¶ˆæ¯çš„å“åº”å‡½æ•°ï¼Œè¿™å°±ä¿è¯äº†åªæœ‰ä¸»çº¿ç¨‹æ‰å»æ‰§è¡Œè¿™äº›æ“ä½œ å°èŠ‚å®Œ 3ã€Androidä¸­çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼šHandler å‰ä¸¤å°èŠ‚æˆ‘ä»¬ä»‹ç»äº†Androidç³»ç»Ÿä¸­ä¸ºä»€ä¹ˆåªèƒ½åœ¨UIçº¿ç¨‹æ›´æ–°ç•Œé¢çš„åŸå› ï¼Œæœ€ç»ˆå‘ç°ä¸åªæ˜¯Androidç³»ç»Ÿï¼Œå…¶ä»–å¤§éƒ¨åˆ†æœ‰GUIæ¡†æ¶çš„æ“ä½œç³»ç»Ÿéƒ½æ˜¯é‡‡ç”¨å•çº¿ç¨‹æ¶ˆæ¯é˜Ÿåˆ—æœºåˆ¶çš„è®¾è®¡ã€‚æ—¢ç„¶éƒ½æ˜¯å•çº¿ç¨‹è®¾è®¡ï¼Œé‚£ä¹ˆæƒ³è¦åœ¨å­çº¿ç¨‹æ›´æ–°UIå°±å¿…é¡»è¦é€šçŸ¥ä¸»çº¿ç¨‹ åœ¨Androidç³»ç»Ÿä¸­ï¼ŒHandlerå°±æ˜¯è¿™ä¹ˆä¸€å¥—æä¾›åœ¨ä»»æ„çº¿ç¨‹éƒ½å¯ä»¥å‘æ¶ˆæ¯ç»™UIçº¿ç¨‹çš„çº¿ç¨‹é—´é€šä¿¡å·¥å…· ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒHandlerç›¸å½“äºæ¶ˆæ¯çš„ç”Ÿäº§è€…ï¼Œæ¯ä¸ªHandleréƒ½æŒæœ‰å…±äº«MessageQueueçš„å¼•ç”¨ å½“è°ƒç”¨Handler.sendMessage()æ–¹æ³•å‘é€æ¶ˆæ¯æ—¶ï¼ŒHandlerå°±ä¼šæŠŠæ¶ˆæ¯ä¿å­˜åˆ°å…±äº«æ¶ˆæ¯é˜Ÿåˆ—ä¸­ å’Œæ™®é€šæ¶ˆæ¯é˜Ÿåˆ—æœºåˆ¶ä¸åŒçš„æ—¶ï¼ŒAndroidä¸­çš„MessageQueueå¤§å°æ²¡æœ‰é˜ˆå€¼ä¸Šé™ï¼Œæ‰€ä»¥ç†è®ºä¸Šå¯ä»¥ä¸€ç›´å‘æ¶ˆæ¯åˆ°é˜Ÿåˆ—ï¼ŒæŠŠå†…å­˜æ’‘çˆ†~ åœ¨Handleræœºåˆ¶ä¸­ï¼Œæ¶ˆæ¯çš„æ¶ˆè´¹è€…æ˜¯Looperï¼Œä¸¥è°¨ç‚¹æ˜¯è°ƒç”¨Looper.loop()æ‰€åœ¨çš„çº¿ç¨‹ï¼Œå› ä¸ºLooperæœ¬è´¨ä¸Šåªæ˜¯å°è£…å¯¹æ¶ˆæ¯é˜Ÿåˆ—çš„æ“ä½œï¼ŒLooper.loop()æ–¹æ³•è´Ÿè´£å–å‡ºå…±äº«æ¶ˆæ¯é˜Ÿåˆ—é‡Œé¢çš„æ¶ˆæ¯ï¼Œç„¶åäº¤ç”±Handlerå»æ‰§è¡Œ è¿™é‡Œåˆæœ‰ä¸€ç‚¹å’Œæ™®é€šæ¶ˆæ¯é˜Ÿåˆ—æœºåˆ¶ä¸åŒï¼Œé€šå¸¸æ¶ˆæ¯çš„æ¶ˆè´¹è€…ä¼šå»æ‰§è¡Œæ¶ˆæ¯çš„å“åº”å‡½æ•°ï¼›ä½†åœ¨Android Handleræœºåˆ¶ä¸­ï¼Œæ¶ˆè´¹è€…æœ¬èº«å¹¶ä¸æ‰§è¡Œæ¶ˆæ¯ä»»åŠ¡ï¼Œè€Œæ˜¯å°†æ¶ˆæ¯å–å‡ºåï¼Œå†é‡æ–°åˆ†å‘ç»™æ¶ˆæ¯çš„å‘é€è€…æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯Handlerï¼Œæ‰€ä»¥æˆ‘ä»¬å¹³æ—¶æ‰è¯´ åœ¨æ•´ä¸ªHandlerçš„æœºåˆ¶ä¸­ï¼ŒHandleré¦–å…ˆæ˜¯æ¶ˆæ¯çš„ç”Ÿäº§è€…ï¼Œå…¶æ¬¡æ‰æ˜¯æ¶ˆæ¯çš„æ‰§è¡Œè€… é™¤äº†å‘æ¶ˆæ¯å¤–ï¼ŒAndroidè¿˜ä¸ºHandlerå¢åŠ äº†ä¸€äº›å…¶ä»–åŠŸèƒ½ï¼Œæ¯”å¦‚å­çº¿ç¨‹æäº¤åŒæ­¥ä»»åŠ¡ã€å¼‚æ­¥æ¶ˆæ¯å’ŒåŒæ­¥å±éšœç­‰ç­‰ æœ¬å°èŠ‚çš„ç›®çš„æ˜¯äº†è§£Handlerçš„è®¾è®¡èƒŒæ™¯ï¼Œå…³äºHandlerå…¶ä»–åŠŸèƒ½è¿™é‡Œå°±ä¸å±•å¼€ä»‹ç»ï¼Œåœ¨Handlerç³»åˆ—çš„ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ä¼šè¯¦ç»†å‰–æHandlerå†…éƒ¨æºç  å°ç»“å®Œ ä¸‰ã€å¦‚ä½•è‡ªå·±å®ç°ä¸€å¥—Handleræœºåˆ¶ï¼Ÿ åœ¨ä¸Šä¸€ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†Handlerçš„è®¾è®¡èƒŒæ™¯ï¼Œæœ¬ç« èŠ‚å°†ä¼šå°è¯•è‡ªå·±å®ç°ä¸€å¥—ç®€å•çš„Handleræœºåˆ¶ æˆ‘ä»¬å‡è®¾è¯»è€…å·²ç»æœ‰ä¸€å®šçš„å¼€å‘ç»éªŒï¼Œå¹¶ä¸”ä½¿ç”¨è¿‡Handlerï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±æ˜¯æ¯ç‡¥çš„ä»£ç æ—¶é—´ 1ã€Handleræˆå‘˜ä»‹ç» åœ¨å¼€æ’¸ä¹‹å‰ï¼ŒæŒ‰ç…§æƒ¯ä¾‹ï¼Œæˆ‘ä»¬å…ˆæ¥ä»‹ç»ä¸€ä¸‹ç»„æˆHandleræœºåˆ¶çš„å‡ ä½æˆå‘˜ï¼Œä»¥åŠå®ƒä»¬å¸¸ç”¨çš„æ–¹æ³• 1.1 Handlerç±» Handlerç±»æ˜¯åº”ç”¨ç¨‹åºå¼€å‘çš„å…¥å£ï¼Œåœ¨æ¶ˆæ¯é˜Ÿåˆ—æœºåˆ¶ä¸­ï¼Œæ‰®æ¼”ç€ç”Ÿäº§è€…çš„è§’è‰²ï¼ŒåŒæ—¶è¿˜è‚©è´Ÿç€æ¶ˆæ¯æ‰§è¡Œè€…çš„é‡æ‹…ï¼Œå¸¸ç”¨çš„æ–¹æ³•æœ‰ï¼š æ–¹æ³•åç§° è¯´æ˜ sendMessage()ç³»åˆ— å‘é€æ™®é€šæ¶ˆæ¯ã€å»¶è¿Ÿæ¶ˆæ¯ï¼Œæœ€ç»ˆè°ƒç”¨queue.enqueueMessage()æ–¹æ³•å°†æ¶ˆæ¯å­˜å…¥æ¶ˆæ¯é˜Ÿåˆ— post()ç³»åˆ— æäº¤æ™®é€š/å»¶è¿ŸRunnableï¼Œéšåå°è£…æˆMessageï¼Œè°ƒç”¨sendMessage()å­˜å…¥æ¶ˆæ¯é˜Ÿåˆ— dispatchMessage(Message msg) åˆ†å‘æ¶ˆæ¯ï¼Œä¼˜å…ˆæ‰§è¡Œmsg.callback(ä¹Ÿå°±æ˜¯runnable)ï¼Œå…¶æ¬¡mCallback.handleMessage()ï¼Œæœ€åhandleMessage() 1.2 Looperç±» Looperåœ¨æ¶ˆæ¯é˜Ÿåˆ—æœºåˆ¶ä¸­æ‰®æ¼”æ¶ˆè´¹è€…çš„è§’è‰²ï¼Œå†…éƒ¨æŒæœ‰å…±äº«çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå…¶æœ¬è´¨æ˜¯å°è£…å¯¹æ¶ˆæ¯é˜Ÿåˆ—çš„æ“ä½œï¼Œå¸¸ç”¨çš„æ–¹æ³•åªæœ‰ä¸¤ä¸ªï¼š æ–¹æ³•åç§° è¯´æ˜ prepare() åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ— loop() éå†æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¸åœåœ°ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­å–æ¶ˆæ¯ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä¸ºç©ºåˆ™ç­‰å¾… 1.3 MessageQueueç±» å®é™…çš„å…±äº«æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæä¾›ä¿å­˜å’Œå–å‡ºæ¶ˆæ¯çš„åŠŸèƒ½ï¼Œåº•å±‚ç”±é“¾è¡¨å®ç°ï¼Œå¸¸ç”¨æ–¹æ³•å°±ä¸€ä¸ªï¼š æ–¹æ³•åç§° è¯´æ˜ next() è·å–æ¶ˆæ¯ï¼Œä¸‰ç§æƒ…å†µ 1. æœ‰æ¶ˆæ¯ï¼Œä¸”æ¶ˆæ¯åˆ°æœŸå¯ä»¥æ‰§è¡Œï¼Œè¿”å›æ¶ˆæ¯ 2. æœ‰æ¶ˆæ¯ï¼Œæ¶ˆæ¯æœªåˆ°æœŸï¼Œè¿›å…¥é™æ—¶ç­‰å¾…çŠ¶æ€ 3. æ²¡æœ‰æ¶ˆæ¯ï¼Œè¿›å…¥æ— é™æœŸç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°è¢«å”¤é†’ 1.4 Messageç±» æ¶ˆæ¯çš„æ‰¿è½½ç±»ï¼Œä½¿ç”¨äº«å…ƒæ¨¡å¼è®¾è®¡ï¼Œæ ¹æ®APIä¸åŒç¼“å†²æ± å¤§å°ä¹Ÿä¸åŒï¼ŒAPI 4æ—¶ç¼“å†²æ± å¤§å°ä¸º10ï¼Œå¸¸ç”¨æ–¹æ³•ï¼š æ–¹æ³•åç§° è¯´æ˜ obtain()ç³»åˆ— è·å–ä¸€ä¸ªæ¶ˆæ¯å®ä¾‹ recycle() å›æ”¶æ¶ˆæ¯å®ä¾‹ 1.5 å°ç»“ è‡³æ­¤ï¼ŒHandlerçš„å‡ ä¸ªä¸»è¦æˆå‘˜ç±»éƒ½ä»‹ç»å®Œäº†ï¼Œæœ‰åŒå­¦å¯èƒ½å·²ç»å‘ç°äº†ï¼Œæˆå‘˜ä»‹ç»ä¸­æ²¡æœ‰åŒ…å«ThreadLocalç±»ï¼Ÿ æˆ‘ä¸ªäººè®¤ä¸ºThreadLocalæ˜¯å±äºJavaå¹¶å‘æ¨¡å—çš„å†…å®¹ï¼ŒHandleråªæ˜¯å€Ÿç”¨äº†ThreadLocalæ¥ä¿è¯MessageQueueåœ¨å½“å‰çº¿ç¨‹çº¿ç¨‹çš„å”¯ä¸€æ€§ï¼Œå°±ç®—ä¸é€‚ç”¨ThreadLocalå¯¹æ•´ä¸ªHandleræœºåˆ¶ä¹Ÿæ²¡å•¥å½±å“~ å°èŠ‚å®Œ 2ã€åŸºäºObject.wait()/notifiy()å®ç°Handleræœºåˆ¶ 3.1å°èŠ‚ä»‹ç»äº†Handlerçš„å‡ ä¸ªæˆå‘˜ç±»ï¼Œä»¥åŠæˆå‘˜ç±»ä¸­å¸¸ç”¨çš„æ–¹æ³•ï¼Œæœ¬ç« èŠ‚å°†ä¼šç”¨JavaåŒæ­¥æœºåˆ¶æ¥å®ç°Handler è¯ä¸å¤šè¯´ï¼Œç›´æ¥å¼€æ’¸ 2.1 æ‰‹å†™æ¶ˆæ¯é˜Ÿåˆ—æœºåˆ¶ å‰é¢çš„ç« èŠ‚æˆ‘ä»¬å·²ç»äº†è§£è¿‡æ¶ˆæ¯é˜Ÿåˆ—æœºåˆ¶çš„æ¦‚å¿µï¼Œè¿™é‡Œç›´æ¥æ¥çœ‹ä»£ç  é¦–å…ˆæˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ªç”Ÿäº§è€…ï¼Œç”Ÿäº§è€…çº¿ç¨‹ä¸­ï¼Œæˆ‘ä»¬å†™äº†ä¸ªæ­»å¾ªç¯ä¸€ç›´å‘é€æ¶ˆæ¯ï¼Œæ¥æ¨¡æ‹Ÿç”¨æˆ·æ“ä½œï¼›æ¯æ¬¡å‘å®Œæ¶ˆæ¯åï¼Œå”¤é†’å¯èƒ½åœ¨ç­‰å¾…çŠ¶æ€çš„æ¶ˆè´¹è€…çº¿ç¨‹ï¼Œç„¶åå°†è‡ªå·±ä¸ªå„¿ç½®å…¥é™æ—¶ç­‰å¾…çŠ¶æ€ ç„¶åå†åˆ›å»ºä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œåœ¨æ¶ˆè´¹è€…çº¿ç¨‹ä¸­ï¼ŒåŒæ ·æ˜¯æ­»å¾ªç¯ï¼Œä¸åœçš„è½®è¯¢æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæœ‰æ¶ˆæ¯å°±å¤„ç†ï¼Œæ²¡æ¶ˆæ¯å°±å°†è‡ªå·±ç½®å…¥æ— é™æœŸç­‰å¾…çš„çŠ¶æ€ï¼Œç›´åˆ°è¢«å”¤é†’ æ¥ç€å°±æ˜¯å…±äº«çš„æ¶ˆæ¯é˜Ÿåˆ—äº†ï¼Œå·ä¸ªæ‡’ï¼Œæ¶ˆæ¯é˜Ÿåˆ—å°±ä½¿ç”¨çš„æ˜¯Javaé›†åˆåŒ…ä¸­çš„Queueå¥½äº†ï¼Œæ¥çœ‹æœ€ç»ˆçš„æµ‹è¯•ä»£ç ï¼š æ‰“å°ç»“æœï¼š åœ¨æµ‹è¯•ä»£ç ä¸­ï¼Œä¸¤ä¸ªbosså¼ ä¸‰å’Œæå››æ—¶ä¸æ—¶å‘æŒ‡ä»¤ç»™ä¸‹å±ï¼Œä¸¤ä¸ªä¸‹å±å°æ˜å’Œå°çº¢åœ¨ä¸åœçš„è½®è¯¢ç­‰å¾…ä¸Šå¸çš„æŒ‡ä»¤ï¼Œä¸€ä¸ªç®€å•çš„æ¶ˆæ¯é˜Ÿåˆ—æœºåˆ¶å°±å®Œæˆäº†ï¼›åœ¨ä¸è€ƒè™‘å»¶è¿Ÿæ¶ˆæ¯çš„æƒ…å†µä¸‹ï¼ŒåŠ ä¸Šæµ‹è¯•ä»£ç ï¼Œæ•´ä¸ªæ¶ˆæ¯é˜Ÿåˆ—æœºåˆ¶ä¸åˆ°100è¡Œä»£ç å°±æå®šäº†ï¼Œè¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ 2.2 æ‰‹å†™Handleræœºåˆ¶ 2.1å°èŠ‚æˆ‘ä»¬å·²ç»ç”¨Object.wait()/notifiy()å®ç°äº†æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®ç°Handleræœºåˆ¶åªéœ€è¦åœ¨ä¸Šé¢çš„æ¶ˆæ¯é˜Ÿåˆ—çš„åŸºç¡€ä¸Šç¨å¾®æ”¹åŠ¨ä¸€ä¸‹å°±èƒ½å®Œæˆï¼š åŒå­¦ä»¬æ³¨æ„ï¼Œæˆ‘è¦å¼€å§‹å˜å½¢äº†ï¼ï¼ï¼ ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬æŠŠæ¶ˆè´¹è€…çº¿ç¨‹ä¸­çš„é€»è¾‘æŒªåˆ°Looperå½“ä¸­ï¼ŒæŠŠè½®è¯¢çš„ä»»åŠ¡æ”¾åˆ°loop()æ–¹æ³•ä¸­ï¼›è‹¥å–åˆ°äº†æ¶ˆæ¯ï¼Œæ¨¡æ‹ŸAndroid Handleræœºåˆ¶ï¼Œå°†æ¶ˆæ¯åˆ†å‘ç»™æ¶ˆæ¯æ‰€å±çš„ç”Ÿäº§è€…è€…(Handler)å»æ‰§è¡Œ æ¥ç€ï¼Œå°†æ¶ˆè´¹è€…çº¿ç¨‹ä¸­è·å–æ¶ˆæ¯çš„é€»è¾‘æŠ½ç¦»å‡ºæ¥ï¼Œæ”¾åˆ°MessageQueueçš„next()æ–¹æ³•ä¸­ å’Œä¸Šé¢çš„æ¶ˆè´¹è€…çº¿ç¨‹æ¯”è¾ƒï¼Œè¿™é‡ŒåŠ äº†ä¸€æ¡é€»è¾‘ï¼šå½“å‘é€çš„æ¶ˆæ¯æ—¶å»¶è¿Ÿæ¶ˆæ¯æ—¶ï¼Œåˆ¤æ–­æ¶ˆæ¯æ˜¯å¦åˆ°æœŸï¼Œåˆ°æœŸè¿”å›ç»™Looperå»åˆ†å‘(è¿™é‡Œå·æ‡’ä½¿ç”¨äº†Javaé›†åˆåŒ…ä¸­çš„ä¼˜å…ˆçº§é˜Ÿåˆ—PriorityQueueï¼Œæ¥ä¿è¯æ—¶é—´æœ€å°çš„æ¶ˆæ¯æ’åœ¨æœ€å‰é¢) ç„¶åï¼ŒæŠŠç”Ÿäº§è€…çº¿ç¨‹ä¸­ç›´æ¥å°†æ¶ˆæ¯å­˜å…¥æ¶ˆæ¯é˜Ÿåˆ—çš„æ“ä½œçš„é€»è¾‘ä¹ŸæŠ½å‡ºæ¥ï¼Œæ”¾åˆ°Handlerçš„sendMessage()æ–¹æ³•ä¸­ å†ç„¶åï¼Œæ¥çœ‹ä¸€çœ¼Messageç±»çš„è®¾è®¡ï¼ŒåŠ äº†ä¸ªHandleç±»å‹çš„æˆå‘˜å˜é‡target å¥½ï¼å¤§åŠŸå‘Šæˆï¼Œä¸€èµ·çœ‹çœ‹æµ‹è¯•ä»£ç ï¼š åœ¨main()æ–¹æ³•ä¸­åˆ›å»ºäº†handler1å’Œhandler2ï¼Œæ¨¡æ‹Ÿç”¨æˆ·åœ¨ä¸»çº¿ç¨‹ç”³è¯·Handlerçš„åœºæ™¯ï¼›éšåå¼€å¯ä¿©å­çº¿ç¨‹ï¼Œè®©å­çº¿ç¨‹ä»£ç ä½¿ç”¨åˆšåˆšåˆ›å»ºçš„Handlerå‘é€æ¶ˆæ¯ï¼Œè¿™æ ·ï¼Œå­çº¿ç¨‹ä½¿ç”¨è¯¥Handlerå‘é€çš„æ¶ˆæ¯å°±ä¼šæ·»åŠ åˆ°ä¸»çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç­‰å¾…ä¸»çº¿ç¨‹çš„Looperå»å¤„ç† æ‰“å°ç»“æœï¼š çœ‹ï¼Œå¦‚æœæ˜¯æ™®é€šä»»åŠ¡ï¼Œloop()æ–¹æ³•é‡Œé¢å°±ç›´æ¥åˆ†å‘æ‰äº†ï¼Œå»¶è¿Ÿä»»åŠ¡å› ä¸ºä½¿ç”¨çš„æ˜¯PriorityQueueçš„ç¼˜æ•…ï¼Œä¼šæ’åˆ°æœ€åæ‰æ”¾å‡ºæ¥ åˆ°è¿™é‡Œä¸€ä¸ªç®€å•çš„Handleræœºåˆ¶å°±å®Œæˆäº†ï¼Œæ²¡çœ‹æ‡‚çš„åŒå­¦è¯·åœ¨è¯„è®ºåŒºæ‰£1 å…³äºæ­¤å°èŠ‚è®¾è®¡åˆ°çš„ä»£ç åœ¨è¿™é‡Œ psï¼šæŠŠä»£ç è½¬å›¾ç‰‡æ˜¯å› ä¸ºæºç å¤ªé•¿äº†æˆ‘çŸ¥é“ä½ ä»¬ä¹Ÿæ‡’å¾—çœ‹~ 2.3 å°ç»“ å‰ä¸¤å°èŠ‚åˆ†åˆ«ä»‹ç»äº†å¦‚ä½•æ‰‹å†™æ¶ˆæ¯é˜Ÿåˆ—æœºåˆ¶å’Œæ‰‹å†™ä¸€ä¸ªç®€å•çš„Handleræœºåˆ¶ï¼Œæˆ‘å°†ä¸Šé¢çš„ä»£ç è°ƒç”¨æµç¨‹æ¢³ç†äº†ä¸€ä¸‹ï¼Œæ€»ç»“å‡ºä¸€å¼ ç®€ç‰ˆçš„æµç¨‹å›¾ï¼š å›¾ä¸­çš„æ¯ä¸ªæˆå‘˜ç±»éƒ½åªå†™äº†ä¸¤ä¸ªå…³é”®æ–¹æ³•ï¼ŒMessageç±»åªæ˜¯æ¶ˆæ¯è½½ä½“ï¼Œæ‰€ä»¥å°±æ²¡æ”¾å®ƒï¼Œæˆ‘è§‰å¾—ä»‹ç»Handlerå¤§è‡´æµç¨‹å·®ä¸å¤šè¿™å‡ ä¸ªæ–¹æ³•å¤Ÿäº†ï¼Œè§‰å¾—æµç¨‹ä¸å¤Ÿè¯¦ç»†çš„åŒå­¦å¯ä»¥ä¸‹è½½æºæ–‡ä»¶è‡ªè¡Œæ·»åŠ ï¼Œæµç¨‹å›¾æºæ–‡ä»¶å·²ä¸Šä¼ åˆ°GitHub å°èŠ‚å®Œ å››ã€Handleræœºåˆ¶è¯¦è§£ æ­¤å°èŠ‚è®¾è®¡ä¹‹åˆçš„æƒ³æ³•æ˜¯è¦è¯¦ç»†çš„å‰–æHandleræœºçš„å†…éƒ¨æºç ï¼Œåœ¨å†™å®Œäº†äºŒã€ä¸‰ç« èŠ‚åå›å¤´çœ‹æ‰å‘ç° é™¤äº†åŒæ­¥å±éšœä¸å¼‚æ­¥æ¶ˆæ¯ã€IdleHandlerã€Callbackç­‰æ²¡æœ‰è®²ä»¥å¤–ï¼Œæ•´ä¸ªHandleræœºåˆ¶å¥½åƒå·²ç»è®²çš„å·®ä¸å¤šäº†-.- æ—¢ç„¶æ²¡å¤ªå¤šå¯è®²çš„ï¼Œé‚£æœ¬èŠ‚ç´¢æ€§æ¢ä¸ªç›®æ ‡ï¼Œæ¥èŠä¸€èŠAndroid Handleré™¤äº†å®ç°æ¶ˆæ¯é˜Ÿåˆ—æœºåˆ¶å¤–ï¼Œè¿˜ç»™æˆ‘ä»¬æä¾›äº†ä»€ä¹ˆåŠŸèƒ½ï¼Œå®ƒä»¬æ˜¯å¦‚ä½•å®ç°çš„ï¼Œä»¥åŠåœ¨ä½¿ç”¨Handlerè¿‡ç¨‹ä¸­æˆ‘ä»¬æœ‰å“ªäº›éœ€è¦ç‰¹åˆ«æ³¨æ„çš„åœ°æ–¹ 1ã€é™¤äº†æäº¤æ¶ˆæ¯åˆ°é˜Ÿåˆ—ï¼ŒHandlerè¿˜æä¾›äº†å“ªäº›åŠŸèƒ½ï¼Ÿ 1.1 IdleHandler IdleHandleræ˜¯åœ¨Handleræœºåˆ¶è¯ç”Ÿä¹‹åˆå°±å®ç°çš„æœºåˆ¶ï¼Œå…¶å­˜åœ¨çš„æ„ä¹‰åœ¨äºï¼Œæäº¤ä¸€ä¸ªä¸é‡è¦çš„ä»»åŠ¡å•ç‹¬å­˜æ”¾åœ¨MessageQueuä¸­çš„mIdleHandlerså˜é‡ä¸­ï¼Œå½“æ¶ˆæ¯é˜Ÿåˆ—ç©ºé—²æ—¶ä¼šæ‰§è¡Œæ­¤ä»»åŠ¡ /** * Callback interface for discovering when a thread is going to block * waiting for more messages. */ public static interface IdleHandler { /** * Called when the message queue has run out of messages and will now * wait for more. Return true to keep your idle handler active, false * to have it removed. This may be called if there are still messages * pending in the queue, but they are all scheduled to be dispatched * after the current time. */ boolean queueIdle(); } IdleHandlerè¦æ±‚è¿”å›boolç±»å‹çš„å€¼ï¼Œè¿”å›falseè¡¨ç¤ºæ‰§è¡Œå®Œè¯¥ä»»åŠ¡åä¼šæŠŠå®ƒä»é›†åˆä¸­åˆ é™¤ï¼Œè¿”å›trueè¡¨ç¤ºè¯¥ä»»åŠ¡å¯ä»¥é‡å¤æ‰§è¡Œ IdleHandlerçš„å¤„ç†é€»è¾‘åœ¨MessageQueue.next()æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹Android 1.6ç‰ˆæœ¬ä¸­çš„å¤„ç†é€»è¾‘ï¼š // There was no message so we are going to wait... but first, // if there are any idle handlers let them know. boolean didIdle = false; if (idlers != null) { for (Object idler : idlers) { boolean keep = false; try { didIdle = true; keep = ((IdleHandler)idler).queueIdle(); } catch (Throwable t) { } if (!keep) {//å¤„ç†ç»“æœä¸ºfalseå°†å…¶ä»é›†åˆä¸­åˆ é™¤ synchronized (this) { mIdleHandlers.remove(idler); } } } } IdleHandlerä½¿ç”¨æ–¹æ³•å¤§å®¶éƒ½å·²ç»å¾ˆç†Ÿæ‚‰äº†ï¼Œå…³æ³¨æ¯”è¾ƒå¤šçš„é—®é¢˜æ˜¯ï¼šåœ¨ä»€ä¹ˆåœºæ™¯ä¸‹ä½¿ç”¨ï¼Ÿ è¿™é‡Œä¸¾å‡ ä¸ªä¸‰æ–¹åº“å’Œå®˜æ–¹ä½¿ç”¨IdleHandlerçš„ä¾‹å­ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½ä»ä»–ä»¬èº«ä¸Šå¾—åˆ°äº›å¯å‘ ActivityThread.GcIdler ç›´æ¥çœ‹ä»£ç  final class GcIdler implements MessageQueue.IdleHandler { @Override public final boolean queueIdle() { doGcIfNeeded(); return false; } } void doGcIfNeeded() { mGcIdlerScheduled = false; final long now = SystemClock.uptimeMillis(); //è·å–ä¸Šæ¬¡GCçš„æ—¶é—´ if ((BinderInternal.getLastGcTime()+MIN_TIME_BETWEEN_GCS) &lt; now) { //Slog.i(TAG, &quot;**** WE DO, WE DO WANT TO GC!&quot;); BinderInternal.forceGc(&quot;bg&quot;); } } doGcIfNeededæ–¹æ³•ç†è§£èµ·æ¥å¾ˆç®€å•ï¼Œå°±æ˜¯è·å–ä¸Šæ¬¡GCçš„æ—¶é—´ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦GCæ“ä½œ å¾®ä¿¡æ€§èƒ½ç›‘æ§æ¡†æ¶ï¼šMatrix Matrixæœ‰å¥½å‡ å¤„ä½¿ç”¨åˆ°IdleHandlerçš„åœ°æ–¹ï¼Œæ¯”å¦‚ï¼š IdleHandlerLagTracer.java WarmUpScheduler.java AndroidHeapDumper.java LooperMonitor.java ä»¥LooperMoitorä¸¾ä¾‹æ¥è¯´ï¼Œè¿™æ˜¯ç›‘å¬Looperæ¶ˆæ¯åˆ†å‘çš„ç±»ï¼Œå¾®ä¿¡è¿™é‡Œåˆ©ç”¨IdlerHandleråšäº†ä¸€ä¸ªæ£€æŸ¥çš„å·¥ä½œ @Override public boolean queueIdle() { if (SystemClock.uptimeMillis() - lastCheckPrinterTime &gt;= CHECK_TIME) { resetPrinter(); lastCheckPrinterTime = SystemClock.uptimeMillis(); } return true; } æˆ‘ä»¬çœ‹åˆ°åœ¨queueIdleæ–¹æ³•ä¸­è¿”å›äº†trueï¼Œè¯´æ˜è¿™ä¸ªIdleHandlerä¼šè¢«é‡å¤è°ƒç”¨ï¼Œæ¯æ¬¡è°ƒç”¨queueIdle()æ–¹æ³•æ—¶ï¼Œä¼šå»è°ƒç”¨resetPrinteræ–¹æ³•æ¥æ£€æŸ¥Looperä¸­çš„printerå¯¹è±¡æ˜¯ä¸æ˜¯å¾®ä¿¡è‡ªå®šä¹‰çš„LooperPrinter å†…å­˜æ³„æ¼æ£€æµ‹æ¡†æ¶ï¼šLeakCanary LeakCanaryåœ¨ReferenceCleanerä¸­ç”¨åˆ°äº†IdleHandlerï¼Œæºç çœ‹èµ·æ¥æ˜¯åœ¨onViewDetachedFromWindow()å‡½æ•°ä¸­æ³¨å†Œäº†IdleaHandlerï¼Œæ³¨å†Œè¿™ä¸ªIdleHandlerçš„ç›®çš„æ˜¯ä¸ºäº†æ¸…é™¤Android imsçš„bugï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·±ç‚¹è¿›å»çœ‹ 1.2 å¼‚æ­¥æ¶ˆæ¯ä¸åŒæ­¥å±éšœ Androidåœ¨API 16(4.1.1)å¢åŠ äº†å¯¹å¼‚æ­¥æ¶ˆæ¯å’ŒåŒæ­¥å±éšœæ¶ˆæ¯çš„æ”¯æŒ æ‰€è°“çš„åŒæ­¥å±éšœæœºåˆ¶å°±æ˜¯æ’å…¥ä¸€ä¸ªåŒæ­¥å±éšœæ¶ˆæ¯åˆ°Looperçš„é˜Ÿåˆ—å¤´éƒ¨ï¼Œå‡†ç¡®çš„è¯´æ˜¯æ‹†å…¥ä¸€ä¸ªå½“å‰æ—¶é—´çš„æ¶ˆæ¯åˆ°é˜Ÿåˆ—ï¼Œå¦‚æœé˜Ÿåˆ—ä¸­æœ‰æ¶ˆæ¯åˆ°æœŸäº†ä½†æ˜¯è¿˜æ²¡æ‰§è¡Œï¼Œé‚£ä¹ˆè¯¥åŒæ­¥å±éšœçš„æ¶ˆæ¯ä¼šæ’åœ¨å®ƒåé¢ï¼›å½“Looperè°ƒç”¨next()è·å–æ¶ˆæ¯æ—¶å€™ï¼Œå‘ç°é˜Ÿåˆ—å¤´éƒ¨æ˜¯ä¸€ä¸ªåŒæ­¥å±éšœä¿¡æ¯ï¼Œå°±ä¼šè·³è¿‡æ‰€æœ‰åŒæ­¥æ¶ˆæ¯ï¼Œå¯»æ‰¾æ‰€æœ‰çš„å¼‚æ­¥æ¶ˆæ¯æ‰§è¡Œï¼Œæ‰€ä»¥å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶å®è´¨ä¸Šæ˜¯ä¸€ä¸ªå¯¹æ¶ˆæ¯é˜Ÿåˆ—çš„ä¼˜å…ˆçº§é‡æ–°æ’åˆ—çš„æœºåˆ¶ psï¼šå…³äºå¼‚æ­¥æ¶ˆæ¯ä¸åŒæ­¥å±éšœåœ¨Handlerã€MessageQueueã€Looperä¸­å¤„ç†é€»è¾‘è¿™é‡Œæ²¡è®²ï¼Œå…¨éƒ¨åŠ è¿›æ¥å¤ªé•¿äº†ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å»ç½‘ä¸Šæ‰¾å…¶ä»–æ–‡ç«  1.3 Handler Callbackæœºåˆ¶ ç®€å•æ¥è¯´ï¼Œå°±æ˜¯Handleråœ¨åˆ†å‘æ¶ˆæ¯æ—¶ï¼Œæä¾›äº†æ¶ˆæ¯åˆ†å‘ä¼˜å…ˆçº§çš„é€‰é¡¹ç»™ä½¿ç”¨è€…ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ¶ˆæ¯çš„åˆ†å‘é€»è¾‘ï¼š /** * Handle system messages here. */ public void dispatchMessage(Message msg) { if (msg.callback != null) { handleCallback(msg); } else { if (mCallback != null) { if (mCallback.handleMessage(msg)) { return; } } handleMessage(msg); } } ä¼˜å…ˆæ‰§è¡Œmsg.callback(ä¹Ÿå°±æ˜¯runnable)ï¼Œå…¶æ¬¡mCallback.handleMessage()ï¼Œè‹¥callbackè¿”å›falseï¼Œæœ€åæ‰§è¡ŒhandleMessage()æ–¹æ³• 2ã€ä½¿ç”¨Handlerçš„æ³¨æ„äº‹é¡¹ 2.1 å†…å­˜æ³„æ¼ Handlerå¼•å‘çš„å†…å­˜æ³„æ¼æ˜¯è€ç”Ÿå¸¸è°ˆçš„è¯é¢˜ï¼Œè¿½æ ¹æº¯æºçš„è¯å…¶å®å’ŒHandleræœ¬èº«æ²¡å…³ç³»ï¼Œå…¶æœ¬è´¨æ˜¯ç”Ÿå‘½å‘¨æœŸé•¿çš„ç»„ä»¶å¼•ç”¨ç”Ÿå‘½å‘¨æœŸçŸ­çš„ç»„ä»¶ï¼Œå¯¼è‡´å£°æ˜å‘¨æœŸçŸ­çš„ç»„ä»¶æ˜æ˜å·²ç»ç»“æŸäº†ï¼Œå®ä¾‹å¯¹è±¡å´ä¸èƒ½è¢«å›æ”¶ åœ¨Activityä¸­ç›´æ¥åˆ›å»ºHandlerï¼Œå› ä¸ºæ˜¯å†…éƒ¨ç±»çš„å…³ç³»ï¼Œè¯¥Handlerä¼šæŒæœ‰Activityçš„å¼•ç”¨ï¼Œè‹¥ä½¿ç”¨è¯¥Handlerå‘é€å»¶æ—¶æ¶ˆæ¯åé”€æ¯Activityä¼šå‘ç°ï¼Œåœ¨å»¶æ—¶æ¶ˆæ¯æœªæ‰§è¡Œå‰ï¼ŒActivityåŒ…æ‹¬å…¶å¼•ç”¨çš„å¯¹è±¡éƒ½ä¸ä¼šè¢«é‡Šæ”¾çš„ è§£å†³æ–¹æ¡ˆä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå£°æ˜ä¸€ä¸ªé™æ€å†…éƒ¨ç±»å³å¯ï¼Œä»£ç å¦‚ä¸‹ï¼š public static class InternalHandler extends Handler { private WeakReference&lt;Context&gt; contextReference; public InternalHandler(WeakReference&lt;Context&gt; contextReference) { this.contextReference = contextReference; } } 2.2 äº«å…ƒæ¨¡å¼çš„å‘ Handlerä¸­çš„Messageç±»ä½¿ç”¨äº«å…ƒæ¨¡å¼è®¾è®¡ï¼Œåœ¨ã€Šä»Androidæºç è§’åº¦è°ˆè®¾è®¡æ¨¡å¼ï¼ˆäºŒï¼‰ï¼šç»“æ„å‹æ¨¡å¼ã€‹ä¸€æ–‡ä¸­å·²ç»è§£é‡Šäº†äº«å…ƒæ¨¡å¼æœ¬èº«ä¼šå¸¦æ¥æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ ç®€å•æ¥è¯´ï¼Œå½“ä½ å°†ä¸€ä¸ªäº«å…ƒå¯¹è±¡ä¼ é€’ç»™å­çº¿ç¨‹ï¼Œå› ä¸ºJavaæ˜¯å€¼ä¼ é€’ï¼Œæ‰€ä»¥å½“å­çº¿ç¨‹ä½¿ç”¨åˆ°ä¼ é€’è¿›æ¥çš„äº«å…ƒå¯¹è±¡æ—¶ï¼Œè¿™ä¸ªå¯¹è±¡å¯èƒ½æ­£åœ¨å›æ”¶æ± ä¸­ï¼Œä¹Ÿå¯èƒ½å·²ç»è¢«å–å‡ºä¾›å…¶ä»–æ–¹æ³•ä½¿ç”¨ ä½“ç°åœ¨Handleræœºåˆ¶ä¸­åˆ™æ˜¯ï¼ŒLooper.loop()æ‰§è¡Œå®Œæ¶ˆæ¯çš„åˆ†å‘åï¼Œä¼šè°ƒç”¨msg.recycle()å°†è¯¥æ¶ˆæ¯å®ä¾‹å¯¹è±¡å›æ”¶ï¼Œè¿™æ—¶å€™å°±ä¼šæœ‰ä¸ªé—®é¢˜ï¼Œæ¥çœ‹ä»£ç ï¼š public static class InternalHandler extends Handler{ @Override public void handleMessage(Message msg) { if (msg.what == 250){ //æ–°å»ºå¼‚æ­¥çº¿ç¨‹å¤„ç†é€»è¾‘ new Thread(() -&gt; { Thread.sleep(100*1000);//æ¨¡æ‹Ÿè€—æ—¶ System.out.println(msg.obj);//æ¨¡æ‹Ÿæ¶ˆæ¯ä½¿ç”¨ }).start(); } } } å¦‚ä¸Šï¼Œæˆ‘ä»¬åœ¨æ‹¿åˆ°msgåï¼Œæ–°èµ·äº†ä¸€ä¸ªçº¿ç¨‹å»å¤„ç†æ¶ˆæ¯ æ¥çœ‹Looperè¿™è¾¹çš„é€»è¾‘ï¼Œloop()æ–¹æ³•é‡Œé¢è°ƒç”¨å®Œmsg.target.dispatchMessage()æ–¹æ³•åç´§æ¥ç€å°±ä¼šå›æ”¶æ¶ˆæ¯å¯¹è±¡å®ä¾‹ é‚£ä¹ˆæˆ‘ä»¬åœ¨å­çº¿ç¨‹ä¸­æ‹¿åˆ°çš„å¯¹è±¡å¼•ç”¨ï¼Œé‡Œé¢å†…å®¹çš„å®é™…æ˜¯ç©ºçš„ï¼Œæˆ–è€…æ˜¯è¯¥å¯¹è±¡å¼•ç”¨åˆå·²ç»è¢«å…¶ä»–çº¿ç¨‹åœ¨ä½¿ç”¨äº†ï¼Œæ€»ä¹‹ï¼Œåœ¨å­çº¿ç¨‹ä¸­çš„æ¶ˆæ¯ä¸æ˜¯åŸæ¥çš„æ¶ˆæ¯äº† 3ã€Handleræœ‰å“ªäº›å¦™ç”¨ 3.1 æ°¸ä¸å´©æºƒçš„APP 1. ä½¿ç”¨æ–¹æ³• åˆ©ç”¨Handleræœºåˆ¶æ‹¦æˆªå¼‚å¸¸å‰ä¸¤å¹´åœ¨ç½‘ä¸Šè¿˜å°ç«äº†ä¸€æŠŠï¼Œç¬”è€…åˆšçŸ¥é“Handlerè¿˜å¯ä»¥è¿™æ ·ç”¨çš„æ—¶å€™å¾ˆå¼€å¿ƒï¼Œä¸ä¼šå› ä¸ºæœªæ•è·å¼‚å¸¸å¯¼è‡´APPå´©æºƒäº†ï¼Œæˆ‘çš„ç»©æ•ˆæœ‰æ•‘äº†~ å½“ç„¶ï¼Œè¯´æ°¸ä¸å´©æºƒè¨€è¿‡å…¶å®äº†ï¼Œå®ƒåªèƒ½æ‹¦æˆªJavaå±‚å¼‚å¸¸ï¼Œnativeå¼‚å¸¸æ˜¯æ²¡åŠæ³•æ•è·çš„ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹å¦‚ä½•å®ç°çš„ é¦–å…ˆï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹ä½¿ç”¨çš„æ–¹æ³•ï¼Œå¾ˆç®€å•ï¼Œæˆ‘ä»¬åœ¨Applicationéšä¾¿æ‰¾ä¸ªæ–¹æ³•åŠ å…¥ä»¥ä¸‹ä»£ç ï¼š new Handler(Looper.getMainLooper()).post(() -&gt; { while (true) { try { Looper.loop(); } catch (Exception e) { //ä¿å­˜æ—¥å¿—å¹¶ä¸ŠæŠ¥.. } // }catch (Throwable throwable){ }//æƒ³è¦è¿Error(å¦‚OOM)éƒ½ä¸€èµ·æ‹¦æˆªå°±ç”¨Throwable } }); å¦‚ä¸Šï¼Œåªéœ€çŸ­çŸ­å‡ è¡Œä»£ç ï¼Œå°±å¯ä»¥æ•è·Javaå±‚æ‰€æœ‰å¼‚å¸¸ï¼Œæ€ä¹ˆåšåˆ°çš„ï¼Ÿ 2. å®ç°åŸç† åœ¨ä»‹ç»å®ç°åŸç†ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥å¤ä¹ ä¸€ä¸‹Javaå¼‚å¸¸å¤„ç†æœºåˆ¶ï¼Œå½“ä¸€ä¸ªå¼‚å¸¸å‘ç”Ÿæ—¶ï¼š è™šæ‹Ÿæœºä¼šåœ¨å½“å‰å‡ºç°å¼‚å¸¸çš„æ–¹æ³•ä¸­ï¼ŒæŸ¥æ‰¾å¼‚å¸¸è¡¨ï¼Œæ˜¯å¦æœ‰åˆé€‚çš„å¤„ç†è€…æ¥å¤„ç† å¦‚æœå½“å‰æ–¹æ³•å¼‚å¸¸è¡¨ä¸ä¸ºç©ºï¼Œå¹¶ä¸”å¼‚å¸¸ç¬¦åˆå¤„ç†è€…çš„ from å’Œ to èŠ‚ç‚¹ï¼Œå¹¶ä¸” type ä¹ŸåŒ¹é…ï¼Œåˆ™è™šæ‹Ÿæœºè°ƒç”¨ä½äº targetçš„è°ƒç”¨è€…æ¥å¤„ç† å¦‚æœä¸Šä¸€æ¡æœªæ‰¾åˆ°åˆç†çš„å¤„ç†è€…ï¼Œåˆ™ç»§ç»­æŸ¥æ‰¾å¼‚å¸¸è¡¨ä¸­çš„å‰©ä½™æ¡ç›® å¦‚æœå½“å‰æ–¹æ³•çš„å¼‚å¸¸è¡¨æ— æ³•å¤„ç†ï¼Œåˆ™å‘ä¸ŠæŸ¥æ‰¾ï¼ˆå¼¹æ ˆå¤„ç†ï¼‰åˆšåˆšè°ƒç”¨è¯¥æ–¹æ³•çš„è°ƒç”¨å¤„ï¼Œå¹¶é‡å¤ä¸Šé¢çš„æ“ä½œ å¦‚æœæ‰€æœ‰çš„æ ˆå¸§è¢«å¼¹å‡ºï¼Œä»ç„¶æ²¡æœ‰å¤„ç†ï¼Œåˆ™æŠ›ç»™å½“å‰çš„ Threadï¼ŒThread åˆ™ä¼šç»ˆæ­¢ å¦‚æœå½“å‰ Thread ä¸ºæœ€åä¸€ä¸ªéå®ˆæŠ¤çº¿ç¨‹ï¼Œä¸”æœªå¤„ç†å¼‚å¸¸ï¼Œåˆ™ä¼šå¯¼è‡´è™šæ‹Ÿæœºç»ˆæ­¢è¿è¡Œ Exception table: from to target type 0 3 6 Class java/lang/Exception æˆ‘ä»¬æ¥åšä¸ªå®éªŒï¼Œåœ¨Activityä¸»åŠ¨æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œçœ‹ä¸€ä¸‹æ–¹æ³•è°ƒç”¨é“¾ï¼Œé‡ç‚¹å…³æ³¨æœ‰æ²¡æœ‰å¯ä»¥æ‰‹åŠ¨try catchçš„åœ°æ–¹ java.lang.RuntimeException: æˆ‘å´©æºƒäº† at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:3639) at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:3796) at android.app.servertransaction.LaunchActivityItem.execute(LaunchActivityItem.java:103) at android.app.servertransaction.TransactionExecutor.executeCallbacks(TransactionExecutor.java:135) at android.app.servertransaction.TransactionExecutor.execute(TransactionExecutor.java:95) at android.app.ActivityThread$H.handleMessage(ActivityThread.java:2214) at android.os.Handler.dispatchMessage(Handler.java:106) at android.os.Looper.loopOnce(Looper.java:201)//point 2 at android.os.Looper.loop(Looper.java:288)//point 1 at android.app.ActivityThread.main(ActivityThread.java:7842) at java.lang.reflect.Method.invoke(Native Method) at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:548) at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:1003) Caused by: java.lang.RuntimeException: æˆ‘å´©æºƒäº† ä»ä¸‹å¾€ä¸Šæ‰¾ï¼Œæœ€ä¸‹é¢å‡ ä¸ªï¼Œä»€ä¹ˆZygoteInitã€RuntimeInitè¿™äº›ç³»ç»Ÿçš„ç±»å¬èµ·æ¥å°±æ²¡æ³•æ“ä½œ ç›´åˆ°çœ‹åˆ°point 1ä½ç½®çš„Looper.loop()æ–¹æ³•ï¼Œå›é¡¾ä¸€ä¸‹ç¬¬ä¸‰ç« 2.3å°èŠ‚ä¸­æµç¨‹å›¾ï¼Œloop()æ–¹æ³•é‡Œé¢æ‰§è¡Œçš„æ˜¯æ­»å¾ªç¯ï¼Œä¸€ç›´åœ¨è½®è¯¢æ¶ˆæ¯é˜Ÿåˆ— é‚£ä¹ˆæˆ‘ä»¬å†ä¸¢ä¸€ä¸ªåŒæ ·æ‰§è¡Œæ­»å¾ªç¯ï¼Œå¹¶ä¸”è°ƒç”¨Looper.loop()æ–¹æ³•è½®è¯¢æ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆæ¯è¿›å»ï¼Œåªè¦ä¿è¯æäº¤çš„è¿™ä¸ªæ¶ˆæ¯ä¸å‡ºé”™ï¼Œå°±æ°¸è¿œä¸ä¼šå‡ºç°ä¸Šé¢çš„å¼‚å¸¸å †æ ˆä¿¡æ¯ å¹¶ä¸”ï¼Œç”±äºæˆ‘åœ¨æ¶ˆæ¯ä¸­è°ƒç”¨äº†Looper.loop()æ–¹æ³•ï¼Œç›¸å½“äºdispatchæ¶ˆæ¯çš„ä»£ç æ‰§è¡Œåœ¨æˆ‘æäº¤çš„è¿™ä¸ªæ¶ˆæ¯ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´åªè¦try catchä½è°ƒç”¨loop()çš„åœ°æ–¹ï¼Œåœ¨åº”ç”¨å†…ä»»åŠ¡Javaå¼‚å¸¸æˆ‘éƒ½å¯ä»¥æ•è·äº† å¥½äº†ï¼Œå¤§æ¦‚çš„å®ç°åŸç†å·²ç»è§£é‡Šæ¸…æ¥šäº†ï¼Œæ¥ä¸‹æ¥çœ‹ä¸€ä¸‹åœ¨msgä¸­é‡å¤è°ƒç”¨Looper.loop()æ–¹æ³•åçš„æ–¹æ³•æ ˆè°ƒç”¨é“¾ï¼š //åŸå…ˆçš„æ–¹æ³•è°ƒç”¨é“¾ ZygoteInit.main() -&gt; RuntimeInit.MethodAndArgsCaller.run() -&gt; ActivityThread.main() -&gt; Looper.loop() -&gt; MessageQueue.next() //å†æ¬¡è°ƒç”¨Looper.loop()æ–¹æ³•åï¼Œè°ƒç”¨é“¾å˜æˆï¼š ZygoteInit.main() -&gt; RuntimeInit.MethodAndArgsCaller.run() -&gt; Activity.main() -&gt; LooperThread.loop() { //å› ä¸ºæ˜¯åŒä¸€ä¸ªçº¿ç¨‹å†…è°ƒç”¨ï¼Œç›¸å½“äºåœ¨Looper.loopæ–¹æ³•ä¸ŠåŒ…äº†ä¸€å±‚ -&gt; Looper.loop() -&gt; MessageQueue.next() } 3. å°ç»“ æœ¬å°èŠ‚ä»‹ç»äº†è®©Javaä»£ç æ°¸ä¸å´©æºƒçš„å®ç°åŸç†ï¼Œè¿™å¥—æ–¹æ¡ˆçœ‹èµ·æ¥æ¯”è¾ƒç‰›é€¼ï¼Œä½†æ˜¯ ä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ï¼ï¼ï¼ åœ¨æˆ‘åˆšçŸ¥é“è¿™å¥—æ–¹æ¡ˆæ—¶ï¼Œç«‹é©¬å°±åœ¨é¡¹ç›®ä¸­è¿›è¡Œäº†æµ‹è¯•ï¼Œæµ‹è¯•ç»“æœå’Œä»‹ç»çš„æ•ˆæœæ˜¯ä¸€æ ·çš„ï¼Œå½“æ—¶çœŸçš„è§‰å¾—å¾ˆç‰›é€¼ï¼Œäºæ˜¯ä¾¿å…´é«˜é‡‡çƒˆçš„å‘åˆ°ç”Ÿäº§ç¯å¢ƒ å‘ç‰ˆæ²¡å‡ å¤©å°±é™†ç»­æ”¶åˆ°åé¦ˆï¼Œé¡µé¢ç™½å±æ²¡æ•°æ®ã€ç‚¹å‡»æ²¡ååº”ç­‰ç­‰é—®é¢˜ åæ¥æŸ¥çœ‹ä¸ŠæŠ¥æ—¥å¿—ï¼Œå‘ç°å‡ºé—®é¢˜çš„é¡µé¢çš„ç¡®å­˜åœ¨bugï¼Œä½†æ˜¯å› ä¸ºè¢«æ‹¦æˆªäº†å¯¼è‡´äº†åŠŸèƒ½ä¸èƒ½æ­£å¸¸æ‰§è¡Œï¼Œæ‰ä¼šå¯¼è‡´ç”¨æˆ·æ“ä½œæ²¡ååº”ç­‰ ç®€å•æ¥è¯´ï¼Œè‹¥æŸä¸ªç”Ÿäº§æ•°æ®çš„åŠŸèƒ½æ— æ³•æ­£å¸¸ä½¿ç”¨åï¼Œæ¥ä¸‹æ¥ä¾èµ–è¯¥æ•°æ®çš„é¡µé¢éƒ½ä¼šäº§ç”Ÿä¸€ç³»åˆ—çš„é—®é¢˜ è¿™åè€Œä¼šè®©åº”ç”¨ä¸­äº§ç”Ÿæ›´å¤šçš„ä¸å¯æ§å› ç´  æœ€åç»è¿‡å†…éƒ¨è®¨è®ºåè¿˜æ˜¯æŠŠè¿™å¥—æ–¹æ¡ˆæ”¾å¼ƒäº†ï¼Œä¸èƒ½ç”¨è¿™ç§è›®æ¨ªçš„æ–¹å¼å¯¹å¾…bug ä¸€åˆ€åˆ‡çš„æ–¹æ¡ˆè¿‡äºé‡è›®ï¼ŒGitHubæœ‰ä¸ªå¼€æºåº“æä¾›äº†æ›´å®Œå–„çš„è§£å†³æ–¹æ¡ˆï¼Œhttps://github.com/android-notes/Cockroach å°ç»“å®Œ 3.2 ANRç›‘æ§ è¯¦æƒ…å¯å‚è€ƒå¾®ä¿¡å®¢æˆ·ç«¯æŠ€æœ¯å›¢é˜Ÿçš„æ–‡ç« ï¼š å¾®ä¿¡Androidå®¢æˆ·ç«¯çš„ANRç›‘æ§æ–¹æ¡ˆ å¾®ä¿¡Androidå®¢æˆ·ç«¯çš„å¡é¡¿ç›‘æ§æ–¹æ¡ˆ äº”ã€Handlerå‘å±•å†ç¨‹ åœ¨æ–‡ç« çš„æœ€åï¼Œæˆ‘ä»¬æ¥è®¤è¯†ä¸€ä¸‹Handlerçš„å‘å±•å†å² ä¸‹é¢çš„è¡¨æ ¼è®°å½•äº†Handlerä»Android 1.6 (API 3) ä¸€ç›´åˆ°Android 12 (API 31)çš„æ¼”å˜è¿‡ç¨‹ï¼š Android 1.6(API 4) è¿™ä¹Ÿè®¸æ˜¯ä½ èƒ½æ‰¾åˆ°æœ€è€ç‰ˆæœ¬çš„Handleræºç ï¼Œæ­¤æ—¶Handlerçš„å®Œæˆåº¦å·²ç»å¾ˆé«˜äº†ï¼Œç‰¹ç‚¹æ˜¯ï¼š 1ã€é˜Ÿåˆ—ç©ºé—²æ—¶ç­‰å¾…ä»¥åŠå”¤é†’æ–¹æ¡ˆç”¨çš„æ˜¯Javaçš„Object.wait()/notfity() è°ƒç”¨MessageQueueçš„nextæ–¹æ³•è·å–æ¶ˆæ¯ï¼Œè¿™æ—¶å€™æ£€æŸ¥é˜Ÿåˆ—æœ‰æ²¡æœ‰æ¶ˆæ¯ æ²¡æœ‰æ¶ˆæ¯è°ƒç”¨this.wait()æ— é™æœŸç­‰å¾… æœ‰æ¶ˆæ¯ä½†æ¶ˆæ¯æœªåˆ°æœŸè°ƒç”¨this.wait()ä¼ å…¥åˆ°æœŸæ—¶é—´ è°ƒç”¨MessageQueue.enqueueMessage()æ·»åŠ æ¶ˆæ¯ï¼Œæ¶ˆæ¯åŠ å…¥é˜Ÿåˆ—åä¼šè°ƒç”¨this.notifity()å”¤é†’next()æ–¹æ³•ï¼Œè¿™é‡Œæœ‰ä¸ªbugæ˜¯æ²¡æœ‰åˆ¤æ–­æ·»åŠ çš„æ¶ˆæ¯è¦ä»€ä¹ˆæ—¶å€™æ‰§è¡Œï¼Œå»¶è¿Ÿæ¶ˆæ¯ä¹Ÿä¼šå”¤é†’ 2ã€MessageQueueæ”¯æŒIdleHandler IdleHandleræ˜¯MessageQueueçš„å†…éƒ¨ç±»ï¼Œè°ƒç”¨addIdleHandler(handler)æ–¹æ³•å°†ä¸€ä¸ªIdleHandleræ·»åŠ åˆ°mIdleHandlersé›†åˆä¸­ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ç©ºé—²æ—¶æ‰ä¼šæ‰§è¡Œ 3ã€ä¸æ”¯æŒå¼‚æ­¥æ¶ˆæ¯å’ŒåŒæ­¥å±éšœæ¶ˆæ¯ æ‰€æœ‰æ¶ˆæ¯ä¸€è§†åŒä»ï¼Œè¿™ä¹Ÿæ˜¯æ—©æœŸAndroidè®¾å¤‡ä½“éªŒä¸å¥½çš„åŸå› ä¹‹ä¸€ 4ã€Handleræ”¯æŒCallbackå›è°ƒ æåˆ°è¿™ä¸ªæ–¹æ³•æ˜¯å› ä¸ºå®ƒæ¯”è¾ƒé‡è¦ï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹æ¶ˆæ¯åˆ†å‘çš„å…ˆåé¡ºåºï¼š ä¼˜å…ˆæ‰§è¡Œmsg.callback(ä¹Ÿå°±æ˜¯runnable)ï¼Œå…¶æ¬¡mCallback.handleMessage()ï¼Œæœ€åhandleMessage() å…¶ä¸­ï¼Œè°ƒç”¨mCallback.handleMessage()æ–¹æ³•æ—¶ä¼šè¦æ±‚è¿”å›boolç±»å‹çš„å€¼ï¼Œè¿™ä¸ªå€¼ä¸ºtrueå°±ä¸ä¼šå‘ä¸‹åˆ†å‘ç»™Handlerçš„handleMessage()æ–¹æ³•ï¼Œä¸ºfalseä¼šç»§ç»­å‘ä¸‹åˆ†å‘ çŸ¥é“äº†åˆ†å‘é€»è¾‘ä¹‹åæˆ‘ä»¬å°±å¯ä»¥hookæ‰ActivityThreadä¸­çš„Hç±»ï¼Œä¼ å…¥callbackæ‹¦æˆªæˆ‘ä»¬æƒ³è¦çš„ä¿¡æ¯ï¼Œè¿›è€Œåšç»„ä»¶åŒ–æˆ–ç›‘æ§æ–¹é¢çš„å·¥ä½œ Android 2.3(API 9) 2.3æ¯”è¾ƒå¤§çš„å˜åŒ–æ˜¯å¢åŠ äº†nativeå±‚çš„Handleræ¶ˆæ¯æœºåˆ¶ 1ã€MessageQueueæ”¯æŒå¤„ç†nativeå±‚æ¶ˆæ¯ MessageQueueé€šè¿‡mPtrå˜é‡ä¿å­˜NativeMessageQueueå¯¹è±¡ï¼Œä»è€Œä½¿å¾—MessageQueueæˆä¸ºJavaå±‚å’ŒNativeå±‚çš„æ¢çº½ï¼Œæ—¢èƒ½å¤„ç†ä¸Šå±‚æ¶ˆæ¯ï¼Œä¹Ÿèƒ½å¤„ç†nativeå±‚æ¶ˆæ¯ å…³äºnativeå±‚çš„Handleræƒ³è¦äº†è§£æ›´å¤šçš„åŒå­¦çœ‹è¿™é‡Œï¼š è¢è¾‰è¾‰è€å¸ˆçš„æ–‡ç« ï¼šAndroidæ¶ˆæ¯æœºåˆ¶2-Handler(Nativeå±‚) nativeçš„MessageQueueæºç ï¼šandroid-2.3_r1/core/jni/android_os_MessageQueue 2ã€MessageQueue.next()æ–¹æ³•ä¸­ï¼Œç©ºé—²æ—¶ç­‰å¾…æ–¹æ¡ˆä»Object.wait()æ”¹ä¸ºnativePollOnce()å®ç° ç”±äºåŠ å…¥nativeå±‚Handlerï¼Œé˜Ÿåˆ—ç©ºé—²æ—¶ä¸èƒ½åªåˆ¤æ–­Javaå±‚çš„MessageQueueï¼ŒMessageQueueå°†åŸå…ˆçš„this.wait()æ–¹æ³•æ”¹æˆäº†è°ƒç”¨nativeçš„nativePollOnce()æ–¹æ³•ï¼Œè‹¥å¤§å®¶éƒ½ç©ºé—²ï¼Œæ–¹æ³•ä¼šé˜»å¡åˆ°nativeçš„epoll_wait()æ–¹æ³•ä¸­ï¼Œç­‰å¾…å”¤é†’ 3ã€MessageQueue.enqueueMessage()æ–¹æ³•ä¸­ï¼Œå”¤é†’æ–¹æ¡ˆä»Object.notify()æ”¹ä¸ºnativeWake()å®ç° å‚è€ƒä¸Šä¸€å°èŠ‚ï¼Œè¿™é‡Œè¿˜æœ‰ä¸ªå°ç»†èŠ‚ï¼ŒAndroid 2.3ä¹‹å‰åªè¦è°ƒç”¨enqueueMessage()æ–¹æ³•å°±ä¼šè°ƒç”¨this.notify()å”¤é†’çº¿ç¨‹ï¼Œå“ªæ€•åŠ å…¥çš„è¿™ä¸ªæ¶ˆæ¯æ˜¯ä¸ªå»¶è¿Ÿæ¶ˆæ¯è¦æ±‚ä¸€ä¸‡å¹´åæ‰æ‰§è¡Œï¼Œåœ¨2.3çš„ç‰ˆæœ¬ä¸­çš„enqueueMessage()æ–¹æ³•ä¸­ä¿®å¤äº†è¿™ä¸ªé—®é¢˜ Android 4.0(API 14) 1ã€Messageå¢åŠ flagså±æ€§ï¼Œç”¨äºæ ‡è¯†è¯¥æ¶ˆæ¯æ˜¯å¦å·²ç»æ¶ˆè´¹è¿‡äº†ï¼Œé˜²æ­¢åŒä¸€æ¶ˆæ¯æ— é™æ¬¡æäº¤ è°ƒç”¨isInUse()æ–¹æ³•å¯ä»¥æŸ¥è¯¢å½“å‰æ¶ˆæ¯æ˜¯å¦ä½¿ç”¨è¿‡ï¼Œè¿™ä¸ªflagsåç»­ä¹Ÿè¿˜ä¼šåŠ å…¥æ›´å¤šçš„å«ä¹‰ Android 4.1.1(API 16) 4.1.1ç‰ˆæœ¬å˜åŒ–ç•¥å¾®å¤§ä¸€äº›ï¼Œä¸»è¦æ˜¯å¢åŠ äº†å¯¹å¼‚æ­¥æ¶ˆæ¯å’ŒåŒæ­¥å±éšœæ¶ˆæ¯çš„æ”¯æŒ 1ã€Messageæ”¯æŒè®¾ç½®ä¸ºå¼‚æ­¥æ¶ˆæ¯ï¼Œ@hideä¿®é¥° è°ƒç”¨setAsynchronous(true)æ–¹æ³•å¯ä»¥å°†Messageè®¾ç½®ä¸ºå¼‚æ­¥æ¶ˆæ¯ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºå¼‚æ­¥æ¶ˆæ¯çš„æ ‡è¯†ä¿å­˜åœ¨Messageçš„æˆå‘˜å˜é‡flagsä¸­ 2ã€MessageQueueæ”¯æŒå¤„ç†å¼‚æ­¥æ¶ˆæ¯ ä¸»è¦æ˜¯åœ¨enqueueMessage()æ–¹æ³•å’Œnext()æ–¹æ³•ä¸­å¢åŠ å¼‚æ­¥æ¶ˆæ¯çš„å¤„ç†é€»è¾‘ 3ã€MessageQueueæ”¯æŒæ·»åŠ /åˆ é™¤åŒæ­¥å±éšœæ¶ˆæ¯ å¯¹åº”æ–¹æ³•ä¸ºï¼šenqueueSyncBarrier()å’ŒremoveSyncBarrier() åœ¨MessageQueueçš„next()æ–¹æ³•ä¸­ä¹Ÿå¢åŠ äº†å¯¹åŒæ­¥å±éšœæ¶ˆæ¯çš„å¤„ç†é€»è¾‘ 4ã€MessageQueueæ”¯æŒquit()æ–¹æ³• 4.1.1ç‰ˆæœ¬çš„é€€å‡ºé€»è¾‘æ˜¯å°†MessageQueueçš„æˆå‘˜å˜é‡mQuitingè®¾ç½®ä¸ºtrueï¼Œåœ¨è°ƒç”¨MessageQueue.next()æ–¹æ³•æ—¶æ£€æŸ¥mQuitingå˜é‡å€¼ï¼Œä¸ºtrueåˆ™è¿”å›nullç»™Lopperï¼ŒLooper.loop()æ–¹æ³•ä¸­åˆ¤æ–­æ—¶nullå€¼ç›´æ¥ç»“æŸå½“å‰å¾ªç¯ æ³¨æ„è¿™é‡Œå¹¶ä¸ä¼šæ¸…ç©ºMessageQueueä¸­çš„æ¶ˆæ¯ï¼Œä¹Ÿå°±æ˜¯è¯´è‹¥æ¶ˆæ¯æŒæœ‰å¤–éƒ¨çš„å¼ºå¼•ç”¨ï¼Œé‚£ä¹ˆä¼šé€ æˆå†…å­˜æ³„æ¼ 5ã€Lopperåˆ é™¤æˆå‘˜å˜é‡mRun è¿™è´§æœ¬æ¥å°±æ²¡å•¥ç”¨~ï¼Œæ—©æœŸæ‰“å°msgæ‰§è¡Œæ—¥å¿—çš„æ—¶å€™ä¼šå¸¦ä¸Šå®ƒ Android 4.2 (API 17) 1ã€Handleræ”¯æŒè®¾ç½®ä¸ºå¼‚æ­¥Handlerï¼Œ@hideä¿®é¥° å¦‚ä¸‹ï¼Œæ–°å¢Handler(boolean async)æ„é€ å‡½æ•°ï¼Œä½¿ç”¨è¯¥Handlerå‘é€çš„æ¶ˆæ¯å‡ä¸ºå¼‚æ­¥æ¶ˆæ¯ public Handler(boolean async) { mAsynchronous = async; } 2ã€Handleræ”¯æŒå­çº¿ç¨‹æäº¤åŒæ­¥ä»»åŠ¡ï¼Œæ–°å¢runWithScissors()æ–¹æ³•ï¼Œ@hideä¿®é¥° runWithScissors()æ–¹æ³•æ¥å—ä¸€ä¸ªRunnableå’Œè¶…æ—¶æ—¶é—´ï¼Œè°ƒç”¨æ­¤æ–¹æ³•æäº¤ä¸€ä¸ªä»»åŠ¡åï¼š 1ã€è‹¥æ¶ˆæ¯å‘é€çº¿ç¨‹å’ŒHandleråˆ›å»ºçº¿ç¨‹æ˜¯åŒä¸€çº¿ç¨‹ï¼Œé‚£ä¹ˆæ‰§è¡ŒRunnableçš„runæ–¹æ³• 2ã€è‹¥æ¶ˆæ¯å‘é€çº¿ç¨‹å’ŒHandleråˆ›å»ºçº¿ç¨‹ä¸åœ¨åŒä¸€çº¿ç¨‹ï¼Œå¯ä»¥ç†è§£ä¸ºå­çº¿ç¨‹å‘ä¸»çº¿ç¨‹æäº¤äº†ä¸€ä¸ªä»»åŠ¡ï¼Œä»»åŠ¡æäº¤åï¼Œå­çº¿ç¨‹ä¼šè¿›å…¥ä¼‘çœ çŠ¶æ€ç­‰å¾…å”¤é†’ï¼Œä¸€ç›´ç­‰åˆ°ä»»åŠ¡æ‰§è¡Œç»“æŸ æ³¨æ„ï¼ï¼ï¼è¯¥æ–¹æ³•ä¸ä½†è¢«@hideä¿®é¥°ï¼Œåœ¨ä»£ç æ³¨é‡Šä¹Ÿå‘å¼€å‘è€…å‘ŠçŸ¥è¿™æ˜¯ä¸ªå±é™©æ–¹æ³•ï¼Œä¸å»ºè®®ä½¿ç”¨ï¼Œå› ä¸ºrunWithScissors()æ–¹æ³•æœ‰ä¸¤ä¸ªä¸¥é‡ç¼ºé™·ï¼š 1ã€æ— æ³•å–æ¶ˆå·²æäº¤çš„ä»»åŠ¡ï¼Œå³ä½¿æ¶ˆæ¯çš„å‘é€çº¿ç¨‹å·²ç»æ­»äº¡ï¼Œä¸»çº¿ç¨‹ä»ç„¶ä¼šå–å‡ºæ¶ˆæ¯é˜Ÿåˆ—çš„ä»»åŠ¡æ‰§è¡Œï¼Œä½†è¿™æ—¶å€™è¿è¡Œçš„ç¨‹åºæ˜¯ä¸ç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸçš„ 2ã€å¯èƒ½ä¼šé€ æˆæ­»é”ï¼šå­çº¿ç¨‹å‘ä¸»çº¿ç¨‹(åˆ›å»ºHandlerçš„çº¿ç¨‹)æäº¤äº†å»¶è¿Ÿä»»åŠ¡åï¼Œå­çº¿ç¨‹æ˜¯å¤„äºç­‰å¾…è¢«å”¤é†’çš„çŠ¶æ€ï¼Œæ­¤æ—¶è‹¥ä¸»çº¿ç¨‹é€€å‡ºäº†loopå¾ªç¯å¹¶æ¸…ç©ºäº†æ¶ˆæ¯é˜Ÿåˆ—ï¼Œé‚£å­çº¿ç¨‹æäº¤çš„ä»»åŠ¡å°±æ°¸è¿œä¸ä¼šè¢«å”¤é†’æ‰§è¡Œï¼Œè¯¥ä»»åŠ¡æŒæœ‰çš„é”æ°¸è¿œä¸ä¼šè¢«é‡Šæ”¾ï¼Œé€ æˆæ­»é” Android 4.3 (API 18) 1ã€MessageQueueæ”¯æŒå®‰å…¨é€€å‡ºï¼Œquit(safe)æ–¹æ³• æ–°å¢ä»¥ä¸‹ä¸¤ä¸ªæ–¹æ³•ï¼Œsafeå‚æ•°ä¸ºtrueæ—¶è°ƒç”¨removeAllFutureMessagesLocked() removeAllMessagesLocked() ï¼šæ¸…ç©ºæ‰€æœ‰æ¶ˆæ¯ removeAllFutureMessagesLocked()ï¼šæ¸…ç©ºå»¶è¿Ÿæ¶ˆæ¯ï¼Œåˆ°æœŸæ¶ˆæ¯äº¤ç»™Handleråˆ†å‘ Android 6.0 (API 23) 1ã€MessageQueueæ”¯æŒç›‘å¬æ–‡ä»¶æè¿°ç¬¦ï¼Œå¯¹åº”æ–¹æ³•ï¼šaddOnFileDescriptorEventListener() è¿™éƒ¨åˆ†ä»£ç æˆ‘æ²¡æ‡‚ï¼Œç›®å‰çš„çŸ¥è¯†å‚¨å¤‡ä¸è¶³ä»¥è®©æˆ‘çœ‹æ‡‚~ /å“­å”§å”§.jpg 2ã€MessageQueueå‘é€åŒæ­¥å±éšœæ¶ˆæ¯æ–¹æ³•æ”¹åï¼Œä»enqueueSyncBarrier()æ”¹ä¸ºpostSyncBarrier() æˆ‘å¾ˆè®¤çœŸçš„ç¡®è®¤è¿‡ï¼Œä¸»è¦é€»è¾‘æ²¡åŠ¨è¿‡ï¼ŒçœŸçš„åªæ˜¯æ”¹ä¸ªå Android 8.0 (API 26) 1ã€Handlerå¢åŠ getMain()æ–¹æ³•ï¼Œç”¨äºè·å–è¿è¡Œåœ¨UIçº¿ç¨‹çš„Handlerå®ä¾‹ï¼Œ@hideä¿®é¥° getMain()æ£€æŸ¥æˆå‘˜å˜é‡MAIN_THREAD_HANDLERæ˜¯å¦å·²ç»ä¿å­˜äº†Handlerå®ä¾‹ï¼Œè‹¥MAIN_THREAD_HANDLERä¸ºç©ºï¼Œåˆ™ä½¿ç”¨Looper.getManLooper()åˆ›å»ºä¸€ä¸ªæ–°çš„Hnadlerå®ä¾‹ï¼Œèµ‹å€¼ç»™MAIN_THREAD_HANDLERå˜é‡ï¼Œæœ€åè¿”å›ç»“æœ æ³¨æ„ï¼Œè¯¥æ–¹æ³•åªæ˜¯è¿”å›ä¸€ä¸ªè¿è¡Œåœ¨UIçº¿ç¨‹çš„Handlerï¼Œå¹¶ä¸æ˜¯ActivityThreadä¸­çš„æˆå‘˜å˜é‡mHï¼ï¼ï¼ Android 9.0 (API 28) 1ã€Handlerå¢åŠ executeOrSendMessage()æ–¹æ³•ï¼Œ@hideä¿®é¥° è¿™ä¸ªæ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œæä¾›çš„åŠŸèƒ½å’Œå­—é¢æ„æ€ç›¸åŒ åˆ¤æ–­æ¶ˆæ¯å‘é€çº¿ç¨‹å’Œæ¶ˆæ¯æ¶ˆè´¹çº¿ç¨‹æ˜¯åŒä¸€çº¿ç¨‹ï¼Œæ˜¯çš„è¯è°ƒç”¨Handler.dispatchMessage()æ–¹æ³•åˆ†å‘æ¶ˆæ¯ï¼Œå¦åˆ™å¡è¿›æ¶ˆæ¯é˜Ÿåˆ—ç­‰å¾…è¢«åˆ†å‘ 2ã€Handlerå…è®¸APPåˆ›å»ºå¼‚æ­¥Handler å¢åŠ äº†é™æ€æ–¹æ³•createAsync()ï¼Œè°ƒç”¨è¯¥æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªHandlerå®ä¾‹ï¼Œè¿™ä¸ªHandlerå®ä¾‹å°±æ˜¯å¼‚æ­¥Handler Android 10.0 (API 29) 1ã€Looperå¢åŠ setObserver(observer)æ–¹æ³•ï¼Œç›‘å¬æ¶ˆæ¯åˆ†å‘è¿‡ç¨‹ï¼Œ@hideä¿®é¥° ä¸€å…±æœ‰3ä¸ªæ–¹æ³• Object messageDispatchStarting()ï¼šå‘é€æ¶ˆæ¯å‰è°ƒç”¨ messageDispatched(token, msg)ï¼šå½“æ¶ˆæ¯è¢« Handler å¤„ç†æ—¶è°ƒç”¨ dispatchingThrewException(token, msg, exception)ï¼šåœ¨å¤„ç†æ¶ˆæ¯æ—¶æŠ›å‡ºå¼‚å¸¸æ—¶è°ƒç”¨ è‡³æ­¤ï¼ŒHandlerå†ä»£æ›´æ–°çš„å†…å®¹éƒ½å·²æ¢³ç†å®Œæˆï¼Œæ¯ä¸ªæ–¹æ³•éƒ½è¿›è¡Œäº†æ ‡æ³¨ï¼Œæ ‡é¢˜ä¸­ä¹ŸåŠ å…¥äº†é“¾æ¥ï¼Œæœ‰é˜…è¯»æºç éœ€æ±‚çš„åŒå­¦å¯ä»¥ç‚¹å‡»æŸ¥çœ‹ psï¼šä¸ªäººæ•´ç†éš¾å…ä¼šæœ‰ç–æ¼ï¼Œæ¬¢è¿åœ¨ç•™è¨€åŒºè¡¥å…… å…­ã€æ€»ç»“ æœ¬æ–‡å°†Handleræœºåˆ¶æ‹†æˆäº†ä¸‰ä¸ªéƒ¨åˆ† ç¬¬ä¸€éƒ¨åˆ†æ˜¯ä»‹ç»Handlerè¯ç”Ÿçš„èƒŒæ™¯ï¼ŒAndroidä¸ºä»€ä¹ˆè¦è®¾è®¡å‡ºHandler ç¬¬äºŒéƒ¨åˆ†ä¸»è¦è®²å¦‚ä½•æ‰‹å†™ä¸€å¥—Handleræœºåˆ¶ï¼Œä½¿ç”¨çš„æ˜¯JavaåŒæ­¥æ–¹æ³•Object.wait()/notifiy() ç¬¬ä¸‰éƒ¨åˆ†ä»‹ç»çš„æ˜¯Handleré™¤äº†å®ç°æ¶ˆæ¯é˜Ÿåˆ—å¤–ï¼Œè¿˜æä¾›äº†å“ªäº›åŠŸèƒ½ï¼Ÿä»¥åŠå¼€å‘ä¸­ä½¿ç”¨Handleræœ‰å“ªäº›éœ€è¦æ³¨æ„çš„åœ°æ–¹ å¸Œæœ›æ¯ä½åŒå­¦åœ¨çœ‹å®Œæœ¬ç¯‡æ–‡ç« åéƒ½èƒ½å¤Ÿæœ‰æ‰€æ”¶è· -.- å…¨æ–‡å®Œ ä¸ƒã€å‚è€ƒèµ„æ–™ CSDN-liuqiaoyu080512ï¼šGUIä¸ºä»€ä¹ˆä¸è®¾è®¡ä¸ºå¤šçº¿ç¨‹ ","link":"https://yibaoshan.github.io/post/android-components-handler/"},{"title":"Androidç»„ä»¶ç³»åˆ—ï¼šLocalBroadcastManageræºç è§£æ","content":" ç‚¹å‡»è·³è½¬åˆ°æ˜é‡‘é˜…è¯» Overview ä¸€ã€LocalBroadcastManagerä»‹ç» 1ã€LocalBroadcastManageræ˜¯ä»€ä¹ˆ åœ¨Androidä¸­ï¼ŒBroadcastæ˜¯ä¸€ç§å¹¿æ³›è¿ç”¨çš„åœ¨åº”ç”¨ä¹‹é—´ä¼ è¾“ä¿¡æ¯çš„æ–¹å¼ Broadcastæœ¬èº«æ˜¯è¿›ç¨‹é—´é€šä¿¡ï¼Œå‘é€çš„æ¶ˆæ¯å…¶ä»–APPå¯ä»¥ç›‘å¬ï¼ŒåŒæ—¶å…¶ä»–åº”ç”¨ä¹Ÿå¯ä»¥é€šè¿‡ä¸æ–­çš„å‘é€å¹¿æ’­æ¥æ”»å‡»ä½ çš„APPï¼Œåº”ç”¨çš„å®‰å…¨æ€§æ— æ³•ä¿è¯ ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒLocalBroadcastManagerå°±åº”è¿è€Œç”Ÿäº† LocalBroadcastManageræ˜¯Android Xåº“ä¸­æä¾›çš„å·¥å…·åŒ…ï¼Œå’ŒBroadcastç›¸æ¯”è¾ƒï¼Œå®ƒçš„ä¼˜ç‚¹åœ¨äºï¼š 1ã€æ— éœ€è¿›è¡Œè¿›ç¨‹é—´é€šä¿¡ï¼Œæ•ˆç‡æ›´é«˜ 2ã€åªåœ¨åº”ç”¨å†…ä¼ æ’­ï¼Œæ— éœ€è€ƒè™‘å…¶ä»–åº”ç”¨åœ¨æ”¶å‘æˆ‘çš„å¹¿æ’­æ—¶å¸¦æ¥çš„ä»»ä½•å®‰å…¨é—®é¢˜ ç»¼ä¸Šï¼Œå¦‚æœåªæ˜¯æƒ³åœ¨åº”ç”¨å†…é€šä¿¡ï¼Œé‚£ä¹ˆå¯ä»¥é€‰æ‹©æœ¬åœ°å¹¿æ’­ä½œä¸ºåº”ç”¨çš„äº‹ä»¶æ€»çº¿ 2ã€LocalBroadcastManagerä½¿ç”¨æ–¹å¼ LocalBroadcastManagerå¯¹è±¡çš„åˆ›å»º LocalBroadcastManager localBroadcastManager = LocalBroadcastManager.getInstance( context ) ; æ³¨å†Œå¹¿æ’­æ¥æ”¶å™¨ LocalBroadcastManager.registerReceiver( broadcastReceiver , intentFilter ); å‘é€å¹¿æ’­ LocalBroadcastManager.sendBroadcast( intent ) ; å‘é€åŒæ­¥å¹¿æ’­ LocalBroadcastManager.sendBroadcastSync ( intent ) ; å–æ¶ˆæ³¨å†Œå¹¿æ’­æ¥æ”¶å™¨ LocalBroadcastManager.unregisterReceiver( broadcastReceiver ); äºŒã€LocalBroadcastManageræºç è§£æ LocalBroadcastManageræ˜¯åŸºäºå‘å¸ƒ/è®¢é˜…æ¨¡å¼æ¥è®¾è®¡çš„ï¼ŒLocalBroadcastManageræœ¬èº«æ˜¯å‘å¸ƒè®¢é˜…ä¸­å¿ƒï¼Œæä¾›è®¢é˜…ã€å–æ¶ˆè®¢é˜…ã€å‘å¸ƒæ¶ˆæ¯çš„åŠŸèƒ½ï¼Œåç»­çš„æ–‡ç« ä¸­æåˆ°çš„è®¢é˜…è€…å³è¡¨ç¤ºçš„æ˜¯å¹¿æ’­æ¥æ”¶å™¨ï¼Œæ¶ˆæ¯äº‹ä»¶æŒ‡çš„æ˜¯è¿‡æ»¤å™¨çš„Action åœ¨å¼€å§‹é˜…è¯»LocalBroadcastManageræºç ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆæ¥è®¤è¯†ä¸€ä¸‹LocalBroadcastManagerçš„æˆå‘˜å±æ€§ï¼Œç†è§£å„ä¸ªæˆå‘˜å±æ€§çš„å«ä¹‰ï¼Œå¯¹æ¥ä¸‹æ¥æºç çš„é˜…è¯»ä¼šæœ‰éå¸¸å¤§çš„å¸®åŠ© 1ã€LocalBroadcastManageræˆå‘˜å±æ€§ 1. LocalBroadcastManagerçš„æˆå‘˜å˜é‡ ç±»å‹ åç§° è¯´æ˜ Context mAppContext Applicationçš„Context HashMapBroadcastReceiver, ArrayList&gt; mReceivers å¹¿æ’­æ¥æ”¶è€…/è®¢é˜…è€…é›†åˆ HashMap&lt;String, ArrayList&lt;ReceiverRecord&gt;&gt; mActions è®¢é˜…äº‹ä»¶é›†åˆ ArrayList mPendingBroadcasts å¾…æ‰§è¡Œåˆ†å‘äº‹ä»¶çš„é›†åˆ Handler mHandler ä½¿ç”¨MainLoopåˆ›å»ºçš„Handler int MSG_EXEC_PENDING_BROADCASTS Messageçš„æ ‡è¯† åœ¨ä»¥ä¸Šçš„æˆå‘˜å˜é‡ä¸­ï¼Œæˆ‘ä»¬éœ€è¦é‡ç‚¹å…³æ³¨çš„æ˜¯mReceiverså’ŒmActions 1.1 mReceivers ä¸Šä¸€èŠ‚æˆ‘ä»¬ä»‹ç»äº†LocalBroadcastManageræ˜¯åŸºäºå‘å¸ƒ/è®¢é˜…æ¨¡å¼è®¾è®¡çš„ï¼Œäº‹ä»¶å‘ç”Ÿæ—¶éœ€è¦é€šçŸ¥æ‰€æœ‰çš„è®¢é˜…è€…ï¼Œé‚£ä¹ˆè¿™é‡Œå¿…ç„¶æœ‰ä¸€ä¸ªä¿å­˜æ‰€æœ‰è®¢é˜…è€…çš„é›†åˆï¼Œåœ¨LocalBroadcastManagerä¸­è¿™ä¸ªé›†åˆå°±æ˜¯mReceivers åˆ°è¿™é‡Œäº‹æƒ…æœ¬è¯¥ç»“æŸäº†ï¼Œä½†å½“æˆ‘ä»¬å°è¯•å‘é€ä¸€ä¸ªäº‹ä»¶æ—¶å°±ä¼šå‘ç°ï¼šä¸€ä¸ªè®¢é˜…è€…å¯ä»¥è®¢é˜…å¤šä¸ªäº‹ä»¶(Action)ï¼Œä¸åŒçš„è®¢é˜…è€…ä¹Ÿå¯ä»¥è®¢é˜…åŒä¸€ä¸ªäº‹ä»¶(Action)ã€‚ å½“ä¸€ä¸ªäº‹ä»¶å‘ç”Ÿåï¼Œæ¯æ¬¡éƒ½è¦å…ˆå»éå†è®¢é˜…è€…é›†åˆ(mReceivers)ï¼Œå†ä»æ¯ä¸ªè®¢é˜…è€…è®¢é˜…çš„äº‹ä»¶é›†åˆ(actions)ä¸­åŒ¹é…æ˜¯å¦è®¢é˜…äº†æ­£åœ¨å‘ç”Ÿçš„äº‹ä»¶ï¼Œä¼ªä»£ç ï¼š public void sendBroadcast(Intent intent){ //éå†è®¢é˜…è€…é›†åˆ for(Receiver receiver :mReceivers){ //éå†è®¢é˜…è€…è®¢é˜…çš„äº‹ä»¶é›†åˆ for(Action action : receiver.actions){ if(intent.action == action){ //do something } } } } æ˜¾ç„¶ï¼Œè¿™æ ·åšçš„æ—¶é—´æ•ˆç‡å¹¶ä¸é«˜ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒLocalBroadcastManageræ–°å¢äº†ä¸€ä¸ªäº‹ä»¶é›†åˆï¼šmActions 1.2 mActions åœ¨LocalBroadcastManagerä¸­ï¼ŒmActionsè¡¨ç¤ºçš„å°±æ˜¯äº‹ä»¶é›†åˆï¼›å…¶ä¸­ï¼Œäº‹ä»¶Actionä½œä¸ºé›†åˆçš„keyï¼Œå¯¹åº”çš„valueæ˜¯è®¢é˜…è¿™ä¸ªäº‹ä»¶çš„è®¢é˜…è€…ä»¬ï¼Œè¿™æ ·ï¼Œæ¯æ¬¡å‘é€äº‹ä»¶æ—¶ï¼Œåªéœ€è¦å»äº‹ä»¶é›†åˆæŸ¥æ‰¾å¯¹åº”çš„è®¢é˜…è€…ä»¬ï¼Œé€šçŸ¥å®ƒä»¬å³å¯ï¼Œè®¢é˜…è€…å’Œäº‹ä»¶(Action)çš„å…³ç³»å¦‚ä¸‹å›¾ï¼š 2. å†…éƒ¨ç±»ï¼šReceiverRecord ç±»å‹ åç§° è¯´æ˜ IntentFilter filter å¹¿æ’­æ¥æ”¶çš„è¿‡æ»¤å™¨ BroadcastReceiver receiver å¹¿æ’­æ¥æ”¶è€… boolean broadcasting æ— æ„ä¹‰æ ‡è¯† boolean dead æè¿°è®¢é˜…è€…çŠ¶æ€ï¼Œè¿™ä¸ªå¹¿æ’­æ¥æ”¶å™¨æ˜¯ä¸æ˜¯è§£é™¤æ³¨å†Œäº† ReceiverRecordæ˜¯LocalBroadcastManagerçš„å†…éƒ¨ç±»ï¼Œå­˜åœ¨çš„æ„ä¹‰æ˜¯åŒ…è£…å¹¿æ’­æ¥æ”¶å™¨ï¼Œç»™å¹¿æ’­æ¥æ”¶å™¨å¢åŠ ä¸€äº›å±æ€§ 3. å†…éƒ¨ç±»ï¼šBroadcastRecord ç±»å‹ åç§° è¯´æ˜ Intent intent å‘é€çš„å¹¿æ’­ ArrayList receivers å·²ç»åŒ¹é…ä¸Šçš„å¹¿æ’­æ¥æ”¶è€…é›†åˆ BroadcastRecordä¸­è®°å½•çš„æ˜¯å¾…åˆ†å‘çš„è®¢é˜…è€…å…ƒç´  2ã€LocalBroadcastManageræˆå‘˜æ–¹æ³• åœ¨2.1å°èŠ‚ä¸­æˆ‘ä»¬æŠŠLocalBroadcastManagerçš„æˆå‘˜å±æ€§éƒ½ä»‹ç»å®Œäº†ï¼Œè¿™é‡Œå†å” å¨ä¸€ä¸‹ï¼Œé‡ç‚¹å…³æ³¨mReceiverså’ŒmActionsè¿™ä¸¤ä¸ªé›†åˆï¼Œå¹¿æ’­çš„æ³¨å†Œå’Œè§£é™¤æ³¨å†Œéƒ½æ˜¯æ“ä½œè¿™ä¿©é›†åˆ åœ¨2.2å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ä¼šä»‹ç»LocalBroadcastManagerçš„å„ä¸ªæˆå‘˜æ–¹æ³•çš„åŠŸèƒ½ä»¥åŠå¦‚ä½•å®ç°çš„ï¼ŒLocalBroadcastManageræ–¹æ³•æ•°é‡ä¸å¤šï¼Œç®—ä¸Šæ„é€ å‡½æ•°ä¸€å…±ä¹Ÿæ‰7ä¸ªï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å…ˆä»æ„é€ å‡½æ•°å¼€å§‹è®²èµ·ï¼š 1. æ„é€ æ–¹æ³• private LocalBroadcastManager(Context context) { mAppContext = context; mHandler = new Handler(context.getMainLooper()) { @Override public void handleMessage(Message msg) { switch (msg.what) { case MSG_EXEC_PENDING_BROADCASTS: executePendingBroadcasts(); break; default: super.handleMessage(msg); } } }; } LocalBroadcastManagerè¢«è®¾è®¡æˆå…¨å±€å•ä¾‹ï¼Œæ‰€ä»¥å®ƒçš„æ„é€ å‡½æ•°æ˜¯privateä¿®é¥°çš„ï¼Œåœ¨LocalBroadcastManagerçš„æ„é€ å‡½æ•°ä¸­ä¸€å…±åšäº†ä¸¤ä»¶äº‹ï¼š ä¿å­˜Contextï¼Œæ³¨æ„è¿™é‡Œä¿å­˜çš„æ˜¯Applicationçš„ä¸Šä¸‹æ–‡ï¼Œæ¥ä¸‹æ¥çš„getInstanceæ–¹æ³•ä»‹ç»é‡Œä¹Ÿä¼šæåˆ°è¿™ä¸€ç‚¹ åˆ›å»ºHandler æ³¨æ„çœ‹åˆ›å»ºHandlerçš„æ—¶å€™ä½¿ç”¨çš„æ˜¯MainLooperï¼Œä¹Ÿå°±æ˜¯è¯´å°†æ¥é€šè¿‡è¿™ä¸ªHandleræäº¤çš„æ¶ˆæ¯éƒ½ä¼šæ·»åŠ åˆ°ä¸»æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç„¶åå†ç”±MainLooperåˆ†å‘ç»™å½“å‰Handlerï¼Œé‚£ä¹ˆåœ¨executePendingBroadcastsä¸­æ´¾å‘æ¶ˆæ¯çš„æ—¶å€™ï¼Œé‡Œé¢çš„ä»£ç éƒ½æ˜¯è¿è¡Œåœ¨Mainçº¿ç¨‹äº† Handleré‡Œé¢çš„é€»è¾‘ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œæ¥æ”¶åˆ°Messageåè°ƒç”¨executePendingBroadcasts()æ–¹æ³•æ¥åˆ†å‘æ¶ˆæ¯ï¼Œç”±äºä½¿ç”¨äº†MainLooperï¼Œæ‰€ä»¥åœ¨å¹¿æ’­æ¥æ”¶å™¨BroadcastReceiverçš„onReceiveå‡½æ•°ä¸­ï¼Œæ˜¯å¯ä»¥è¿›è¡ŒUIæ“ä½œçš„ï¼Œæ¯”å¦‚è¿™æ ·ï¼š new Thread(() -&gt; { LocalBroadcastManager.getInstance(null).registerReceiver(new BroadcastReceiver() { @Override public void onReceive(Context context, Intent intent) { //æ‰§è¡ŒUIæ“ä½œ } },new IntentFilter()); }).start(); ç¤ºä¾‹ä»£ç ä¸­åœ¨å­çº¿ç¨‹ä¸­æ³¨å†Œäº†ä¸€ä¸ªå¹¿æ’­æ¥æ”¶å™¨ï¼Œåœ¨é‡Œé¢åšæ‰§è¡ŒUIçš„æ“ä½œæ˜¯å®Œå…¨æ²¡é—®é¢˜çš„ï¼Œå› ä¸ºonReceive()æ–¹æ³•æœ€ç»ˆè¿è¡Œåœ¨Mainçº¿ç¨‹ 2. getInstance()ï¼šè·å–å®ä¾‹ public static LocalBroadcastManager getInstance(@NonNull Context context) { synchronized (mLock) { if (mInstance == null) { //ä½¿ç”¨Applicationçš„ä¸Šä¸‹æ–‡åˆ›å»ºå®ä¾‹ mInstance = new LocalBroadcastManager(context.getApplicationContext()); } return mInstance; } } getInstance()æ–¹æ³•åªåšä¸€ä»¶äº‹ï¼šæ£€æŸ¥mInstanceå®ä¾‹æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºçš„è¯åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡èµ‹å€¼ç»™mInstance è¿™é‡Œè°ƒç”¨contextçš„getApplicationContext()æ–¹æ³•ï¼Œè·å–çš„æ˜¯Applicationçš„ä¸Šä¸‹æ–‡ï¼Œè¿™æ ·å°±ä¸ç”¨æ‹…å¿ƒä¼ å…¥ç”Ÿå‘½å‘¨æœŸçŸ­çš„ç»„ä»¶é€ æˆå†…å­˜æ³„æ¼çš„é—®é¢˜äº† æˆ‘ä»¬ç»†çœ‹è¿™æ®µä»£ç ä¼šå‘ç°ï¼ŒLocalBroadcastManageråªè¦åˆå§‹åŒ–è¿‡ä¸€æ¬¡ä¹‹åï¼Œå†æ¬¡ä¼ è¿›æ¥çš„contextå…¶å®æ˜¯æ²¡æœ‰ç”¨åˆ°çš„ è¿™æ—¶å€™ä½ å¯èƒ½ä¼šæƒ³ï¼šæ—¢ç„¶ç”¨ä¸åˆ°ï¼Œé‚£æˆ‘æ˜¯ä¸æ˜¯å¯ä»¥åœ¨åº”ç”¨åˆ›å»ºä¹‹åˆè°ƒç”¨LocalBroadcastManager.getInstance()æ–¹æ³•åˆå§‹åŒ–å®ä¾‹ï¼Œä¹‹ååœ¨å…¶ä»–çš„åœ°æ–¹ä½¿ç”¨æ—¶ä¸ä¼ contextå‘¢ï¼Ÿ ç­”æ¡ˆæ˜¯å½“ç„¶å¯ä»¥ï¼Œä¸€æ—¦åˆ›å»ºLocalBroadcastManagerå®ä¾‹åï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä»»æ„çº¿ç¨‹è°ƒç”¨getInstance()ä¸”ä¸ä¼ å…¥contextæ¥è·å–å®ä¾‹å‘é€å¹¿æ’­å•¥çš„ å¦‚æœä½ ä½¿ç”¨Kotlinè¯­è¨€å¼€å‘ï¼Œå› ä¸ºcontextè¢«@NonNullæ³¨è§£ä¿®é¥°ï¼Œç›´æ¥ä¼ nullçš„è¯ç¼–è¯‘å™¨ä¼šä¸é€šè¿‡~ ä½¿ç”¨Javaè¯­è¨€å¼€å‘çš„åŒå­¦å¯ä»¥è¯•ä¸€è¯• 3. registerReceiver()ï¼šæ³¨å†Œå¹¿æ’­ public void registerReceiver(BroadcastReceiver receiver, IntentFilter filter) { synchronized (mReceivers) { //point 1 ReceiverRecord entry = new ReceiverRecord(filter, receiver); //1. è·å–è®¢é˜…è€…çš„è¿‡æ»¤å™¨é›†åˆï¼Œç›®çš„æ˜¯ç»™è¿™ä¸ªè®¢é˜…è€…æ–°å¢ä¸€ä¸ªè¿‡æ»¤å™¨ ArrayList&lt;ReceiverRecord&gt; filters = mReceivers.get(receiver); if (filters == null) { filters = new ArrayList&lt;&gt;(1); mReceivers.put(receiver, filters); } //point 2 filters.add(entry);//point 2 è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œå› ä¸ºentryæ˜¯é‡æ–°åˆ›å»ºçš„ï¼Œæ‰€ä»¥å¤šæ¬¡è°ƒç”¨æ—¶ï¼Œå“ªæ€•ä¼ å…¥çš„æ¥æ”¶å™¨å’Œè¿‡æ»¤å™¨æ˜¯ç›¸åŒçš„ï¼Œåœ¨å‘é€å¹¿æ’­æ—¶ä¹Ÿä¼šå›è°ƒæ¥æ”¶å™¨å¤šæ¬¡ //è§£æè¿‡æ»¤å™¨è¦ç›‘å¬çš„äº‹ä»¶(Action) for (int i = 0; i &lt; filter.countActions(); i++) { String action = filter.getAction(i); //2. è·å–äº‹ä»¶(Action)ç»‘å®šçš„è®¢é˜…è€…é›†åˆï¼Œç›®çš„æ˜¯ç»™è¿™ä¸ªäº‹ä»¶å¢åŠ ä¸€ä¸ªè®¢é˜…è€… ArrayList&lt;ReceiverRecord&gt; entries = mActions.get(action); if (entries == null) { entries = new ArrayList&lt;&gt;(1); mActions.put(action, entries); } entries.add(entry); } } } æ³¨å†Œå¹¿æ’­çš„å…³é”®æ­¥éª¤æ³¨é‡Šéƒ½å·²ç»æ ‡å¥½äº†ï¼Œæ€»ç»“ä¸€ä¸‹åœ¨registerReceiver()æ–¹æ³•ä¸­ä¸€å…±å®Œæˆäº†ä¸¤ä»¶äº‹ï¼š å‘è®¢é˜…è€…é›†åˆæ·»åŠ ä¸€æ¡æ•°æ®ï¼Œå¢åŠ ä¸€ä¸ªè®¢é˜…è€… éå†è®¢é˜…è€…è¦è®¢é˜…çš„äº‹ä»¶é›†åˆï¼ŒæŠŠå½“å‰çš„è®¢é˜…è€…ç»‘å®šåˆ°è®¢é˜…çš„äº‹ä»¶ä¸Šå» è¿™é‡Œçš„è®¢é˜…è€…æŒ‡çš„æ˜¯å¹¿æ’­æ¥æ”¶å™¨(BroadcastReceiver)ï¼Œäº‹ä»¶é›†åˆæŒ‡çš„æ˜¯å¹¿æ’­æ¥æ”¶å™¨çš„è¿‡æ»¤å™¨(IntentFilter)åŒ…å«çš„actions åœ¨æ—¥å¸¸å¼€å‘ä¸­è°ƒç”¨registerReceiver()æ–¹æ³•æ³¨å†Œå¹¿æ’­æ—¶ï¼Œæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œæˆ‘ä»¬å›å¤´çœ‹æ³¨é‡Šæ ‡æ³¨point 1ã€point 2çš„åœ°æ–¹ä¼šå‘ç°ï¼Œä¸ç®¡ä¼ å…¥çš„å¹¿æ’­æ¥æ”¶å™¨å’Œè¿‡æ»¤å™¨æ˜¯å¦å·²ç»å­˜åœ¨è®¢é˜…è€…é›†åˆä¸­ï¼Œåœ¨point 1çš„ä½ç½®æ€»ä¼šé‡æ–°åˆ›å»ºReceiverRecordæ¥æè¿°å¹¿æ’­æ¥æ”¶å™¨å’Œè¿‡æ»¤å™¨ ä»€ä¹ˆæ„æ€å‘¢ å½“ä½ åœ¨æ³¨å†Œå¹¿æ’­æ—¶å°æ‰‹ä¸€æŠ–ï¼Œä¸å°å¿ƒæŒ‰äº†Ctrl+Då¤åˆ¶äº†ä¸€è¡Œ private BroadcastReceiver receiver = new BroadcastReceiver() { @Override public void onReceive(Context context, Intent intent) { //do something * æ‰‹æŠ–æ¬¡æ•° } }; private IntentFilter filter = new IntentFilter(); public void test(){ LocalBroadcastManager.getInstance(this).registerReceiver(receiver,filter); LocalBroadcastManager.getInstance(this).registerReceiver(receiver,filter);//ä¸å°å¿ƒæ‰‹æŠ–å‡ºæ¥çš„ } é‚£ä¹ˆå½“äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå¹¿æ’­æ¥æ”¶å™¨ä¼šæ”¶åˆ°å¤šä¸ªå›è°ƒï¼Œæ‰‹æŠ–å¤šå°‘æ¬¡å°±ä¼šæ”¶åˆ°å¤šå°‘æ¬¡~ 4. unregisterReceiver()ï¼šè§£é™¤æ³¨å†Œ public void unregisterReceiver(@NonNull BroadcastReceiver receiver) { synchronized (mReceivers) { //1. è·å–è®¢é˜…è€…ç»‘å®šçš„è¿‡æ»¤å™¨é›†åˆï¼Œå¹¶å°†å½“å‰è®¢é˜…è€…ä»è®¢é˜…è€…é›†åˆä¸­åˆ é™¤ final ArrayList&lt;ReceiverRecord&gt; filters = mReceivers.remove(receiver); if (filters == null) { return; } for (int i = filters.size() - 1; i &gt;= 0; i--) { final ReceiverRecord filter = filters.get(i); filter.dead = true;//å®£å‘Šå½“å‰å¹¿æ’­æ¥æ”¶å™¨æ­»äº¡ //2. éå†å½“å‰è®¢é˜…è€…è®¢é˜…çš„äº‹ä»¶é›†åˆï¼Œå†å°†å®ƒä»æ¯ä¸ªäº‹ä»¶ç»‘å®šçš„è®¢é˜…è€…é›†åˆä¸­åˆ é™¤ for (int j = 0; j &lt; filter.filter.countActions(); j++) { final String action = filter.filter.getAction(j); //æ‰¾åˆ°è¿™ä¸ªäº‹ä»¶ç»‘å®šçš„æ‰€æœ‰è®¢é˜…è€… final ArrayList&lt;ReceiverRecord&gt; receivers = mActions.get(action); if (receivers != null) { //è¿™é‡Œçš„å€’åºéå†åº”è¯¥æ˜¯Googleçš„å°ä¼˜åŒ–ï¼Œé€šå¸¸æœ€åæ³¨å†Œçš„å¹¿æ’­éƒ½ä¼šè¢«ä¼˜å…ˆåˆ é™¤ï¼Œå› ä¸ºå½“å‰Activityè¢«killè§£é™¤æ³¨å†Œåå°±è¿”å›ä¸Šä¸€çº§é¡µé¢äº† for (int k = receivers.size() - 1; k &gt;= 0; k--) { final ReceiverRecord rec = receivers.get(k); if (rec.receiver == receiver) { rec.dead = true;//æˆ‘è§‰å¾—è¿™ä¸€æ­¥å¤šä½™äº†ï¼Œå› ä¸ºè¿™ä¸ªè®¢é˜…è€…åœ¨æ–¹æ³•å…¥å£æ—¶å°±å·²ç»å®£å‘Šæ­»äº¡äº†ï¼Œè¿™é‡Œç›´æ¥å°†è®¢é˜…è€…åˆ é™¤å°±è¡Œäº† receivers.remove(k); } } //å®‰å…¨æ£€æŸ¥ï¼Œåˆ é™¤æ‰å½“å‰è®¢é˜…è€…åï¼Œè¿™ä¸ªäº‹ä»¶æ²¡æœ‰è®¢é˜…è€…æ„¿æ„ç›‘å¬äº†ï¼Œé‚£ä¹ˆä»äº‹ä»¶é›†åˆä¸­åˆ é™¤ if (receivers.size() &lt;= 0) { mActions.remove(action); } } } } } } åœ¨unregisterReceiver()è§£é™¤æ³¨å†Œå¹¿æ’­çš„æ–¹æ³•ä¸­ï¼ŒåŒæ ·ä¹Ÿæ˜¯åšäº†ä¸¤ä»¶äº‹ï¼š æŠŠè®¢é˜…è€…ä»è®¢é˜…è€…é›†åˆä¸­åˆ é™¤ éå†å…¨å±€çš„äº‹ä»¶é›†åˆ(mActions)ï¼ŒæŠŠè®¢é˜…è€…ä»ç»‘å®šçš„äº‹ä»¶é›†åˆä¸­åˆ é™¤ è¿™é‡Œå’Œå¹¿æ’­çš„æ³¨å†Œæµç¨‹æ˜¯ä¸€æ ·çš„ï¼Œæ— éä¸€ä¸ªæ˜¯å¢ï¼Œä¸€ä¸ªæ˜¯åˆ ï¼Œæ²¡ä»€ä¹ˆéœ€è¦ç‰¹åˆ«æ³¨æ„çš„åœ°æ–¹ 5. sendBroadcast()ï¼šå‘é€å¹¿æ’­ public boolean sendBroadcast(@NonNull Intent intent) { synchronized (mReceivers) { //åŒ¹é…è§„åˆ™è¯¦æƒ… final String action = intent.getAction(); final String type = intent.resolveTypeIfNeeded( mAppContext.getContentResolver()); final Uri data = intent.getData(); final String scheme = intent.getScheme(); final Set&lt;String&gt; categories = intent.getCategories(); //è·å–å½“å‰äº‹ä»¶çš„æ‰€æœ‰è®¢é˜…è€…ä»¬ ArrayList&lt;ReceiverRecord&gt; entries = mActions.get(intent.getAction()); if (entries != null) { //receiversé›†åˆé‡Œé¢ä¿å­˜çš„æ˜¯ï¼Œä¸€åœˆéå†åŒ¹é…ä¸‹æ¥ï¼Œç¬¦åˆè§„åˆ™çš„è®¢é˜…è€…ä»¬ ArrayList&lt;ReceiverRecord&gt; receivers = null; for (int i = 0; i &lt; entries.size(); i++) { ReceiverRecord receiver = entries.get(i); //point 1 if (receiver.broadcasting) { continue; } //è§„åˆ™åŒ¹é…è¿‡ç¨‹ int match = receiver.filter.match(action, type, scheme, data, categories, &quot;LocalBroadcastManager&quot;); if (match &gt;= 0) { if (receivers == null) { receivers = new ArrayList&lt;&gt;(); } receivers.add(receiver); //point 2 receiver.broadcasting = true; } } if (receivers != null) { //point 3 for (int i = 0; i &lt; receivers.size(); i++) { receivers.get(i).broadcasting = false; } //å°†è®¢é˜…è€…ä»¬æ·»åŠ åˆ°å¾…æ‰§è¡Œçš„ä»»åŠ¡é›†åˆä¸­ mPendingBroadcasts.add(new BroadcastRecord(intent, receivers)); //point 4 é˜²æ­¢é‡å¤å‘æ¶ˆæ¯ï¼Œä»£ä»·æ˜¯è¦éå†æ¶ˆæ¯é˜Ÿåˆ—é‡Œæ‰€æœ‰æ¶ˆæ¯ ummmm.. if (!mHandler.hasMessages(MSG_EXEC_PENDING_BROADCASTS)) { mHandler.sendEmptyMessage(MSG_EXEC_PENDING_BROADCASTS); } return true; } } } return false; } å‘é€å¹¿æ’­çš„æ–¹æ³•ä¸­å°±åªåšäº†ä¸€ä»¶äº‹ï¼šä»è®¢é˜…äº‹ä»¶é›†åˆ(mActions)ä¸­æ‰¾åˆ°ç¬¦åˆintentæ¡ä»¶çš„è®¢é˜…è€…ä»¬ï¼Œå¹¶å°†å®ƒä»¬æ”¾å…¥å¾…æ‰§è¡Œé›†åˆ(mPendingBroadcasts) æ³¨æ„å“¦ï¼Œè™½ç„¶æ–¹æ³•åç§°å«åšå‘é€å¹¿æ’­ï¼Œä½†æ˜¯å…¶å®é‡Œé¢å¹¶æ²¡æœ‰å‘é€çš„åŠ¨ä½œï¼Œåªæ˜¯æ‰¾å‡ºç¬¦åˆå‘é€è§„åˆ™çš„è®¢é˜…è€…ä»¬ä¸¢è¿›å¾…æ‰§è¡Œé›†åˆï¼Œç­‰å¾…Handleræ¥æ‰§è¡Œ è¿™é‡Œæœ‰ä¸¤ä¸ªæ§½ç‚¹è¦è¯´ä¸€ä¸‹ï¼š ä¸€æ˜¯point 1/2/3æ ‡æ³¨çš„broadcastingå˜é‡ï¼Œå‹æ ¹å°±æ²¡ç”¨åˆ°ï¼Œä¸çŸ¥é“å­˜åœ¨çš„æ„ä¹‰æ˜¯ä»€ä¹ˆ äºŒæ˜¯point 4æ ‡æ³¨çš„é˜²æ­¢é‡å¤å‘æ¶ˆæ¯çš„è®¾è®¡ï¼Œå’±åˆ›å»ºä¸€ä¸ªboolç±»å‹çš„å˜é‡æ¥æ ‡è¯†ä¸è¡Œå˜›ï¼Œä¸ºå•¥è¦æƒ³ä¸å¼€å»éå†æ¶ˆæ¯é˜Ÿåˆ—ä¸€ä¸ªä¸ªæ£€æŸ¥ 6. sendBroadcastSync()ï¼šå‘é€åŒæ­¥å¹¿æ’­ //ä»æ–¹æ³•åç§°å°±å¯ä»¥çœ‹å‡ºè¿™æ˜¯ä¸€ä¸ªåŒæ­¥æ–¹æ³•ï¼Œè°ƒç”¨è€…ä¼šé˜»å¡åˆ°æ¶ˆæ¯åˆ†å‘ç»™æ‰€æœ‰è®¢é˜…è€…æ‰ä¼šè¿”å› public void sendBroadcastSync(@NonNull Intent intent) { if (sendBroadcast(intent)) { executePendingBroadcasts(); } } sendBroadcastSync()æ–¹æ³•ä»£ç é‡ä¸å¤šï¼Œä¸€å…±åšäº†ä¸¤ä»¶äº‹ï¼š è°ƒç”¨sendBroadcast()æ–¹æ³•ï¼Œå°†ç¬¦åˆæ¡ä»¶çš„è®¢é˜…è€…æ”¾å…¥å¾…æ‰§è¡Œé›†åˆ(mPendingBroadcasts)ï¼Œç­‰å¾…æ‰§è¡Œ è°ƒç”¨executePendingBroadcasts()æ–¹æ³•ï¼Œç«‹åˆ»æ‰§è¡Œæ¶ˆæ¯åˆ†å‘ è¿™é‡Œéœ€è¦é‡ç‚¹å…³æ³¨çš„ç‚¹æ—¶ï¼šç”±äºsendBroadcastSync()æ–¹æ³•å†…éƒ¨è°ƒç”¨äº†executePendingBroadcasts()ç«‹åˆ»æ‰§è¡Œäº†æ¶ˆæ¯åˆ†å‘ï¼Œæ‰€ä»¥ï¼Œå„ä¸ªå¹¿æ’­æ¥æ”¶å™¨çš„onReceive()å‡½æ•°è¿è¡Œçš„çº¿ç¨‹ï¼Œå–å†³äºå¹¿æ’­å‘é€è€…æ‰€åœ¨çš„çº¿ç¨‹ ä»€ä¹ˆæ„æ€å‘¢ æˆ‘ä»¬çŸ¥é“ï¼Œå½“è°ƒç”¨sendBroadcast()æ–¹æ³•å‘é€å¹¿æ’­æ—¶ï¼ŒexecutePendingBroadcasts()æ–¹æ³•æœ€ç»ˆæ˜¯ç”±Handleræ¥è°ƒç”¨çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸ç®¡å¹¿æ’­æ¥æ”¶å™¨æ˜¯åœ¨å“ªä¸ªçº¿ç¨‹æ³¨å†Œçš„ï¼Œéƒ½ä¼šåˆ‡æ¢åˆ°Mainçº¿ç¨‹æ¥æ‰§è¡ŒonReceive()æ–¹æ³•ä¸­çš„ä»£ç  è€Œå½“å¹¿æ’­çš„å‘é€è€…å¯ä»¥ç›´æ¥è°ƒç”¨executePendingBroadcasts()åˆ†å‘æ¶ˆæ¯æ—¶ï¼Œæ€§è´¨å°±ä¸ä¸€æ ·äº†ï¼ï¼ï¼ public void test(){ //å­çº¿ç¨‹å‘é€åŒæ­¥å¹¿æ’­ new Thread(() -&gt; { LocalBroadcastManager.getInstance(null).sendBroadcastSync(new Intent(&quot;action&quot;)); }).start(); } å¦‚ä¸Šï¼Œå½“å‘é€è€…å¤„äºå­çº¿ç¨‹è°ƒç”¨å‘é€åŒæ­¥å¹¿æ’­æ–¹æ³•æ—¶ï¼Œå¹¿æ’­æ¥æ”¶å™¨çš„onReceive()æ–¹æ³•ä¹Ÿè¿è¡Œåœ¨è¿™ä¸ªå­çº¿ç¨‹ è¿™æ—¶å€™ï¼Œå¦‚æœåœ¨onReceive()æ–¹æ³•ä¸­æ‰§è¡Œæ“ä½œUIçš„ä»£ç ï¼Œé‚£ä½ å°†ä¼šæ”¶åˆ°å¼‚å¸¸ï¼šOnly the original thread that created a view hierarchy can touch its views. 7. executePendingBroadcasts()ï¼šæ´¾å‘å¹¿æ’­ void executePendingBroadcasts() { while (true) { //ä¿å­˜å¾…åˆ†å‘çš„è®¢é˜…è€…é›†åˆ final BroadcastRecord[] brs; synchronized (mReceivers) { final int N = mPendingBroadcasts.size(); if (N &lt;= 0) { return; } brs = new BroadcastRecord[N]; mPendingBroadcasts.toArray(brs); mPendingBroadcasts.clear(); } for (int i = 0; i &lt; brs.length; i++) { final BroadcastRecord br = brs[i]; final int nbr = br.receivers.size(); for (int j = 0; j &lt; nbr; j++) { final ReceiverRecord rec = br.receivers.get(j); if (!rec.dead) { //åˆ†å‘äº‹ä»¶ rec.receiver.onReceive(mAppContext, br.intent); } } } } } executePendingBroadcasts()çš„èŒè´£å°±æ˜¯åˆ†å‘å¹¿æ’­ï¼Œåœ¨æºç ä¸­ä¹Ÿåªæœ‰ä¸¤ä¸ªåœ°æ–¹è°ƒç”¨ ä¸€æ˜¯æ„é€ å‡½æ•°çš„Handlerï¼ŒäºŒå°±æ˜¯sendBroadcastSync()æ–¹æ³•ï¼Œä¸¤è€…è°ƒç”¨åŒºåˆ«åœ¨2.2.6å°èŠ‚å·²ç»è®²è¿‡äº†ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿° 3ã€å°ç»“ ä»‹ç»å®ŒLocalBroadcastManageræ‰€æœ‰çš„æˆå‘˜å±æ€§å’Œæˆå‘˜æ–¹æ³•åï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“æœ¬åœ°å¹¿æ’­ä½¿ç”¨çš„å‡ ä¸ªç‰¹ç‚¹ï¼š æœ¬åœ°å¹¿æ’­åŸºäºå‘å¸ƒ/è®¢é˜…æ¨¡å¼å®ç°ï¼Œé€šä¿¡èŒƒå›´åªèƒ½åœ¨å½“å‰è¿›ç¨‹ï¼Œè‹¥ç»„ä»¶åœ¨manifestæ–‡ä»¶ä¸­æŒ‡å®šè¿è¡Œåœ¨å…¶ä»–è¿›ç¨‹ï¼Œå°±æ— æ³•ä½¿ç”¨æœ¬åœ°å¹¿æ’­é€šä¿¡äº† Handlerçš„åŠ å…¥è®©æœ¬åœ°å¹¿æ’­æœ‰åˆ‡æ¢åˆ°ä¸»çº¿ç¨‹æ‰§è¡Œä»£ç çš„èƒ½åŠ›ï¼Œä¸ç®¡æ³¨å†Œå¹¿æ’­å’Œåˆ›å»ºå¹¿æ’­æ¥æ”¶å™¨çš„åŠ¨ä½œæ‰§è¡Œåœ¨å“ªä¸ªçº¿ç¨‹ï¼Œæœ€ç»ˆçš„å›è°ƒå‡½æ•°éƒ½ä¼šåˆ‡æ¢åˆ°Mainçº¿ç¨‹ LocalBroadcastManageråœ¨åˆå§‹åŒ–åï¼ŒgetInstance(context)çš„contextå‚æ•°å¯ä»¥ä¸ä¼  sendBroadcastSync()å‘é€åŒæ­¥å¹¿æ’­æœ€ç»ˆçš„å¹¿æ’­æ¥æ”¶å™¨çš„å›è°ƒå‡½æ•°æ˜¯è¿è¡Œåœ¨å¹¿æ’­å‘é€è€…çº¿ç¨‹çš„ï¼Œè¦å°å¿ƒä½¿ç”¨ ä¸‰ã€æ€»ç»“ åœ¨æœ¬ç¯‡æ–‡ç« ä¸­ç»å¸¸æŠŠå¹¿æ’­æ¥æ”¶å™¨ç§°ä¸ºè®¢é˜…è€…ï¼Œä¹‹æ‰€ä»¥è¿™æ ·ç§°å‘¼æ˜¯å› ä¸ºLocalBroadcastManagerçš„è®¾è®¡ä¸å‘å¸ƒ/è®¢é˜…æ¨¡å¼å¤ªç›¸ä¼¼äº†ï¼Œå‘ï¼Œä½ çœ‹Androidå¼€å‘è€…å®˜ç½‘ä¹Ÿæ˜¯è¿™æ ·ä»‹ç»çš„ LocalBroadcastManagerç›®å‰åœ¨å¼€å‘è€…å®˜ç½‘å·²ç»Googleå£°æ˜ä¸ºå¼ƒç”¨çŠ¶æ€ï¼ŒçŒœæµ‹å¯èƒ½å› ä¸ºä»»ä½•ç»„ä»¶éƒ½å¯ä»¥ä½¿ç”¨æœ¬åœ°å¹¿æ’­æ¥å‘é€ã€æ³¨å†Œä¸è§£é™¤æ³¨å†Œï¼Œç”šè‡³ä¸éœ€è¦åœ¨ç»„ä»¶å†…ä½¿ç”¨ï¼Œä»»æ„çº¿ç¨‹éƒ½å¯ä»¥è·å–æœ¬åœ°å¹¿æ’­çš„å®ä¾‹æ¥æ“ä½œ è‹¥APPåº”ç”¨å†…å®Œå…¨ä¾é æœ¬åœ°å¹¿æ’­æ¥é€šä¿¡ï¼Œå¯¹æ•´ä¸ªå·¥ç¨‹æ¥è¯´ï¼Œå¦‚ä½•ç®¡ç†è¿™äº›å¹¿æ’­æ¥æ”¶å™¨æ˜¯ä¸ªé—®é¢˜ï¼Œè‹¥å†å› ä¸ºç–å¿½å¤§æ„å¿˜è®°æ‰‹åŠ¨è§£é™¤ç»‘å®šï¼Œé‚£ä¹ˆè¿˜ä¼šé€ æˆå†…å­˜æ³„æ¼çš„é—®é¢˜ ä¸è¿‡ä¸ç®¡æ˜¯å¦å¼ƒç”¨ï¼ŒLocalBroadcastManagerå†…éƒ¨çš„è®¾è®¡æ€æƒ³ä¾æ—§å€¼å¾—å­¦ä¹  å…¨æ–‡å®Œ ","link":"https://yibaoshan.github.io/post/android-components-localbroadcastmanager/"},{"title":"æ¼«è°ˆè®¾è®¡æ¨¡å¼ï¼ˆä¸‰ï¼‰ï¼šè¡Œä¸ºå‹æ¨¡å¼","content":" ç‚¹å‡»è·³è½¬åˆ°æ˜é‡‘é˜…è¯» ä¸€ã€å‰è¨€ åœ¨æ¼«è°ˆè®¾è®¡æ¨¡å¼(ä¸€)ã€(äºŒ)ä¸­åˆ†åˆ«ä»‹ç»äº†åˆ›å»ºå‹æ¨¡å¼å’Œç»“æ„å‹æ¨¡å¼ï¼Œæ¯ç§ç±»å‹çš„è®¾è®¡æ¨¡å¼ä¾§é‡ç‚¹ä¸åŒ åˆ›å»ºå‹æ¨¡å¼å…³æ³¨çš„æ˜¯å¦‚ä½•åˆ›å»ºå¯¹è±¡ï¼Œä¸ºå·¥ç¨‹å¸ˆæä¾›æœåŠ¡ ç»“æ„å‹æ¨¡å¼å…³æ³¨çš„æ˜¯å¦‚ä½•æ ¹æ®ä¸šåŠ¡è§£è€¦å„ä¸ªæ¨¡å—/ç±»ï¼Œæœ€åé€šè¿‡ç»„åˆ/å…³è”çš„æ–¹å¼åœ¨ä¸€èµ·å·¥ä½œï¼ŒæœåŠ¡äºä¸šåŠ¡ ä»Šå¤©è¦ä»‹ç»çš„æ˜¯è®¾è®¡æ¨¡å¼ä¸“é¢˜ä¸­çš„æœ€åä¸€ç§ç±»å‹ï¼šè¡Œä¸ºå‹æ¨¡å¼(Behavioral Pattern) è¡Œä¸ºå‹æ¨¡å¼å…³æ³¨çš„æ˜¯ç±»æˆ–å¯¹è±¡çš„èŒè´£åˆ†é…ï¼ŒåŒæ ·ä¹Ÿæ˜¯ä¸ºä¸šåŠ¡æä¾›æœåŠ¡ï¼›å’Œç»“æ„å‹æ¨¡å¼ç›¸æ¯”è¾ƒï¼Œè¡Œä¸ºå‹æ¨¡å¼å…³æ³¨çš„ç²’åº¦æ›´å°ï¼Œæ›´åƒæ˜¯å¯¹ç»“æ„å‹æ¨¡å¼çš„è¡¥å…… è¡Œä¸ºå‹æ¨¡å¼æœ‰11ç§ï¼Œæ•°é‡çœ‹èµ·æ¥ä¼šæ¯”å‰ä¸¤ç§ç±»å‹è¦å¤šï¼Œä¸è¿‡éšç€è¿™äº›å¹´è¯­è¨€ç‰¹æ€§å’Œå¼€å‘æ¨¡å¼çš„è¿›åŒ–ï¼Œèƒ½å¤Ÿç•™ä¸‹æ¥åœ¨é¡¹ç›®ä¸­çœŸæ­£è½åœ°çš„å°±ä¸å¤šäº†ã€‚ ç»è¿‡ç­›é€‰ï¼Œæœ¬æ–‡å°†ä¼šä»‹ç»è¡Œä¸ºå‹ä¸­çš„4ç§æ¨¡å¼ï¼š è§‚å¯Ÿè€…æ¨¡å¼(Observer) è´£ä»»é“¾æ¨¡å¼(Chain of Responsibility) ä¸­ä»‹è€…æ¨¡å¼(Mediator) ç­–ç•¥æ¨¡å¼(Strategy) ä»¥ä¸‹7ç§æ¨¡å¼ä¸åŒ…å«åœ¨æœ¬æ–‡ä¸­ï¼š å‘½ä»¤æ¨¡å¼(Command)ï¼šç®€å•çš„æŒ‡ä»¤å°è£…ï¼Œå‚è€ƒJavaå°è£…æ¦‚å¿µ è§£é‡Šå™¨æ¨¡å¼(Interpreter)ï¼šä¸ºäº†è§£å†³ä¸šåŠ¡éœ€æ±‚å¿…é¡»å­˜åœ¨çš„æ–¹æ¡ˆï¼Œä¸ªäººè®¤ä¸ºç§°ä¸ä¸Šæ˜¯è®¾è®¡æ¨¡å¼ï¼Œå‚è€ƒAndroid LayoutInflater è¿­ä»£å™¨æ¨¡å¼(Iterator)ï¼šæºäºå®¹å™¨è®¿é—®ï¼Œä½¿ç”¨åœºæ™¯å•ä¸€ï¼Œå‚è€ƒJava iteratoræ¥å£ æ¨¡æ¿æ–¹æ³•(Template Method)ï¼šè§„èŒƒæ–¹æ³•è°ƒç”¨é¡ºåºï¼Œåˆ°å¤„éƒ½æ˜¯ï¼Œå‚è€ƒAndroidç”Ÿå‘½å‘¨æœŸåŠå„ç§baseå±‚ çŠ¶æ€æ¨¡å¼(State)ï¼šä¸åŒçš„çŠ¶æ€ä¸‹æ‰§è¡Œä¸åŒçš„ç­–ç•¥ï¼Œä¸ªäººè®¤ä¸ºç­‰åŒç­–ç•¥æ¨¡å¼ è®¿é—®è€…æ¨¡å¼(Visitor)ï¼šçœ‹ä¸æ‡‚/å¤´å¤§.jpg (Â´ï½¥_ï½¥`) å¤‡å¿˜å½•æ¨¡å¼(Memento)ï¼šçº¯å±ä¸šåŠ¡éœ€æ±‚ï¼Œå‚è€ƒAndroid Canvasçš„saveå’Œrestoreæ–¹æ³• ä»¥ä¸Šè§‚ç‚¹å±äºä¸ªäººç†è§£ï¼Œè‹¥æ‚¨å‘ç°æè¿°æœ‰ä¸å‡†ç¡®ç”šè‡³å®Œå…¨é”™è¯¯çš„åœ°æ–¹ï¼Œè¯·åˆ°è¿™é‡Œè¿›è¡Œåé¦ˆï¼Œæ„Ÿè°¢ æœ€åï¼Œç”Ÿäº§è€…æ¶ˆè´¹è€…è™½ç„¶ä¸åœ¨23ç§è®¾è®¡æ¨¡å¼ä¸­ï¼Œä½†è€ƒè™‘åˆ°å®ƒçš„ä½¿ç”¨èŒƒå›´éå¸¸å¹¿æ³›ï¼Œæœ¬æ–‡å°†åœ¨æœ€åä¸€ç« ç•ªå¤–ç¯‡ä¸­ä»‹ç» ä»¥ä¸‹ï¼Œenjoyï¼š äºŒã€è¡Œä¸ºå‹æ¨¡å¼ï¼šè§‚å¯Ÿè€…æ¨¡å¼ 1ã€æ¨¡å¼ä»‹ç» è§‚å¯Ÿè€…æ¨¡å¼(Observer Pattern)é€šå¸¸æœ‰ç”±è‡³å°‘ä¸€ä¸ªå¯è¢«è§‚å¯Ÿçš„å¯¹è±¡å’Œå¤šä¸ªè§‚å¯Ÿè¿™ä¸ªå¯¹è±¡çš„è§‚å¯Ÿè€…ç»„æˆï¼Œå½“è¢«è§‚å¯Ÿè€…çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¼šé€šçŸ¥è¿™äº›è§‚å¯Ÿè€… è¿˜æœ‰ä¸€ç§åšæ³•æ˜¯å¢åŠ ä¸€ä¸ªä¸­ä»‹è§’è‰²ï¼Œä¹Ÿå«å‘å¸ƒè®¢é˜…ä¸­å¿ƒï¼ŒæŠŠè¢«è§‚å¯Ÿè€…ä¸­çš„è®¢é˜…å’Œé€šçŸ¥çš„é€»è¾‘æŠ½ç¦»å¤„ç†æ”¾åœ¨å‘å¸ƒè®¢é˜…ä¸­å¿ƒï¼Œç±»ä¼¼äºAndroid EventBusï¼Œè¿™ç§åšæ³•è¢«å«åšå‘å¸ƒ/è®¢é˜…æ¨¡å¼(Publish-Subscribe Design Pattern) ä¸ºäº†æ–¹ä¾¿è®°å¿†ï¼Œæœ¬ç« ä¼šæŠŠä¸¤è€…åŒºåˆ†å¼€æ¥ï¼Œä¸¤ä¸ªè§’è‰²çš„å«è§‚å¯Ÿè€…æ¨¡å¼ï¼Œä¸‰ä¸ªè§’è‰²çš„å«åšå‘å¸ƒ/è®¢é˜…æ¨¡å¼ æ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡ç±»å›¾æ¥çœ‹ä¸€çœ‹ä¸¤è€…ä¹‹é—´çš„åŒºåˆ« è§‚å¯Ÿè€…æ¨¡å¼ï¼š å¦‚å›¾æ‰€ç¤ºï¼Œè§‚å¯Ÿè€…æ¨¡å¼ä¸€èˆ¬ç”±è‡³å°‘ä¸€ä¸ªå¯è¢«è§‚å¯Ÿçš„å¯¹è±¡(ç¤ºä¾‹ä¸­çš„LiveData) ï¼Œå’Œå¤šä¸ªè§‚å¯Ÿè¿™ä¸ªå¯¹è±¡çš„è§‚å¯Ÿè€…(ç¤ºä¾‹ä¸­çš„LiveDataObserver)ç»„æˆå»è§‚å¯Ÿã€‚äºŒè€…çš„å…³ç³»æ˜¯é€šè¿‡è¢«è§‚å¯Ÿè€…æ¥å»ºç«‹çš„ï¼Œæ‰€ä»¥åœ¨è¢«è§‚å¯Ÿè€…ä¸­ï¼Œè‡³å°‘è¦æœ‰ä¸‰ä¸ªæ–¹æ³•ï¼šæ·»åŠ è§‚å¯Ÿè€…ã€åˆ é™¤è§‚å¯Ÿè€…ã€é€šçŸ¥æ¶ˆæ¯ã€‚ å½“è¢«è§‚å¯Ÿè€…å°†æŸä¸ªè§‚å¯Ÿè€…æ·»åŠ åˆ°è‡ªå·±çš„è§‚å¯Ÿè€…åˆ—è¡¨(observers)åï¼Œè§‚å¯Ÿè€…ä¸è¢«è§‚å¯Ÿè€…çš„å…³è”å°±å»ºç«‹èµ·æ¥äº†ã€‚æ­¤ååªè¦è¢«è§‚å¯Ÿè€…åœ¨æŸç§æ—¶æœºè§¦å‘é€šçŸ¥è§‚å¯Ÿè€…æ–¹æ³•æ—¶ï¼Œè§‚å¯Ÿè€…å³å¯æ¥æ”¶åˆ°æ¥è‡ªè¢«è§‚å¯Ÿè€…çš„æ¶ˆæ¯ã€‚ å‘å¸ƒ/è®¢é˜…æ¨¡å¼ï¼š å¦‚å›¾æ‰€ç¤ºï¼Œå‘å¸ƒ/è®¢é˜…æ¨¡å¼æ˜¯å°†åŸå…ˆåœ¨è¢«è§‚å¯Ÿè€…ä¸­çš„æ·»åŠ ã€åˆ é™¤ã€é€šçŸ¥çš„é€»è¾‘æŠ½ç¦»å‡ºæ¥ï¼Œæ”¾åœ¨å‘å¸ƒè®¢é˜…ä¸­å¿ƒï¼›è§‚å¯Ÿè€…å’Œè¢«è§‚å¯Ÿè€…ä¹‹é—´ä¸ç›´æ¥è¿›è¡Œé€šè®¯ï¼Œè€Œæ˜¯å‘å¸ƒè€…å°†è¦å‘å¸ƒçš„æ¶ˆæ¯äº¤ç”±å‘å¸ƒè®¢é˜…ä¸­å¿ƒç®¡ç†ï¼Œè®¢é˜…è€…ä¹Ÿæ˜¯æ ¹æ®è‡ªå·±çš„æƒ…å†µï¼ŒæŒ‰éœ€è®¢é˜…å‘å¸ƒè®¢é˜…ä¸­å¿ƒä¸­çš„æ¶ˆæ¯ã€‚ è®²å®Œäº†ä¸¤è€…çš„åŒºåˆ«åï¼Œæˆ‘ä»¬é€šè¿‡ä¸¤ä¸ªç®€å•çš„ä»£ç ç¤ºä¾‹æ¥åˆ†åˆ«å®ç°ä¸€ä¸‹è§‚å¯Ÿè€…æ¨¡å¼å’Œå‘å¸ƒ/è®¢é˜…æ¨¡å¼ï¼š 2ã€ä»£ç ç¤ºä¾‹ è§‚å¯Ÿè€…æ¨¡å¼ï¼š //å®šä¹‰é€šçŸ¥æ–¹æ³•åŠå€¼ç±»å‹ public interface Observer&lt;T&gt; { void onChanged(T t); } //è¢«è§‚å¯Ÿè€… public class LiveData&lt;T&gt; { private final List&lt;Observer&lt;T&gt;&gt; observers = new LinkedList&lt;&gt;(); //æ·»åŠ è§‚å¯Ÿè€… public void addObserver(Observer&lt;T&gt; observer) { observers.add(observer); } //åˆ é™¤è§‚å¯Ÿè€… public void remove(Observer&lt;T&gt; observer) { observers.remove(observer); } //é€šçŸ¥æ¶ˆæ¯ public void setValue(T t) { for (Observer&lt;T&gt; observer : observers) observer.onChanged(t); } } //è§‚å¯Ÿè€… public class LiveDataObserver implements Observer&lt;String&gt;{ @Override public void onChanged(String s) { System.out.println(&quot;received message:&quot;+s); } } //æµ‹è¯•ä»£ç  public class Test { @org.junit.Test public void main() { LiveData&lt;String&gt; liveData = new LiveData&lt;&gt;(); liveData.addObserver(new LiveDataObserver()); liveData.setValue(&quot;404&quot;); } } æ‰“å°ç»“æœï¼š received message:404 ä»¥Android LiveDataä¸ºä¾‹ï¼Œåœ¨LiveDataä¸­æä¾›æ·»åŠ /åˆ é™¤è§‚å¯Ÿè€…ç­‰ä¸€ç³»åˆ—æ–¹æ³•ï¼Œå½“è°ƒç”¨setValueæ”¹å˜çŠ¶æ€æ—¶å°±ä¼šå»é€šçŸ¥ä¿å­˜åœ¨è§‚å¯Ÿè€…åˆ—è¡¨(observers)å„ä¸ªè§‚å¯Ÿè€… å‘å¸ƒ/è®¢é˜…æ¨¡å¼ï¼š //å®šä¹‰é€šçŸ¥æ–¹æ³•åŠå€¼ç±»å‹ public interface BroadcastReceiver { void onReceive(Object obj); } //æ¶ˆæ¯è®¢é˜…è€… public class LoginBroadcastReceiver implements BroadcastReceiver { private String pageName; public LoginBroadcastReceiver(String pageName) { this.pageName = pageName; } @Override public void onReceive(Object obj) { System.out.println(pageName+&quot; : &quot;+obj); } } //å‘å¸ƒè®¢é˜…ä¸­å¿ƒ public class LocalBroadcastManager { private static final List&lt;BroadcastReceiver&gt; broadcasts = new LinkedList&lt;&gt;(); public static void sendBroadcast(Object obj) { for (BroadcastReceiver receiver : broadcasts) receiver.onReceive(obj); } public static void register(BroadcastReceiver broadcastReceiver) { broadcasts.add(broadcastReceiver); } public static void unregister(BroadcastReceiver broadcastReceiver) { broadcasts.remove(broadcastReceiver); } } //æ¶ˆæ¯å‘å¸ƒè€… public class LoginPage { private HashMap&lt;String, String&gt; dp; public LoginPage() { dp = new HashMap&lt;&gt;(); dp.put(&quot;admin&quot;, &quot;admin&quot;); } public void login(String name, String pwd) { if (dp.containsKey(name)) { if (dp.get(name).equals(pwd)) LocalBroadcastManager.sendBroadcast(&quot;successful login&quot;); else LocalBroadcastManager.sendBroadcast(&quot;login failed, access denied&quot;); } else { LocalBroadcastManager.sendBroadcast(&quot;login failed, user does not exist&quot;); } } } //æµ‹è¯•ä»£ç  public class Test { @org.junit.Test public void main() { register(); LoginPage loginPage = new LoginPage(); loginPage.login(&quot;admin&quot;,&quot;admin&quot;); } private void register(){ LoginBroadcastReceiver mainReceiver = new LoginBroadcastReceiver(&quot;ä¸»é¡µ&quot;); LoginBroadcastReceiver basketReceiver = new LoginBroadcastReceiver(&quot;è´­ç‰©è½¦&quot;); LoginBroadcastReceiver UCReceiver = new LoginBroadcastReceiver(&quot;ç”¨æˆ·ä¸­å¿ƒ&quot;); LocalBroadcastManager.register(mainReceiver); LocalBroadcastManager.register(basketReceiver); LocalBroadcastManager.register(UCReceiver); } } æ‰“å°ç»“æœï¼š ä¸»é¡µ : successful login è´­ç‰©è½¦ : successful login ç”¨æˆ·ä¸­å¿ƒ : successful login åŒæ ·çš„ï¼Œåœ¨å‘å¸ƒè®¢é˜…ä¸­å¿ƒLocalBroadcastManagerä¸­ä¹Ÿæä¾›æ·»åŠ /åˆ é™¤ç­‰ä¸€ç³»åˆ—æ–¹æ³•ï¼Œå’Œè§‚å¯Ÿè€…ç›¸æ¯”è¾ƒæœ‰ä¸€ç‚¹ä¸åŒçš„æ˜¯ï¼šä»»æ„ä¸€ä¸ªæ¶ˆæ¯å‘å¸ƒè€…éƒ½å¯ä»¥é€šè¿‡å‘å¸ƒè®¢é˜…ä¸­å¿ƒæ¥å‘å¸ƒæ¶ˆæ¯ 3ã€æºç é”šç‚¹ åœ¨Androidæºç ä¸­ï¼Œå¤§éƒ¨åˆ†çš„äº‹ä»¶ç›‘å¬éƒ½æ˜¯ä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼ï¼Œæ‰€ä»¥æˆ‘ä»¬éšä¾¿æŒ‘ä¸€ä¸ªè®°ä½å°±è¡Œäº†ï¼Œæ¯”å¦‚OnClickListener å‘å¸ƒ/è®¢é˜…æ¨¡å¼æœ‰ç»å…¸çš„Android EventBusï¼Œå¦‚æœåœ¨ä»£ç ä¸­å‘ç°æœ‰watchã€watcherã€observeã€observerã€listenã€listenerã€dispatchã€onã€eventã€registerè¿™ç±»å•è¯å‡ºç°çš„åœ°æ–¹ï¼Œå¾ˆæœ‰å¯èƒ½æ˜¯åœ¨ä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼æˆ–å‘å¸ƒè®¢é˜…çš„æ€æƒ³ 4ã€å°ç»“ 2.2çš„ä»£ç ç¤ºä¾‹å®ç°äº†è§‚å¯Ÿè€…å’Œå‘å¸ƒ/è®¢é˜…çš„ç®€åŒ–ç‰ˆï¼Œåœ¨å®é™…åº”ç”¨ä¸­ï¼Œå¯¹äºä»¥ä¸ŠäºŒè€…çš„å®ç°å¯èƒ½ä¼šæ›´åŠ çš„å¤æ‚ï¼Œæ‰€ä»¥åªéœ€ç†è§£ä¸¤ç§æ¨¡å¼çš„è®¾è®¡æ€æƒ³å³å¯ï¼Œæˆ‘ä»¬æ¥ç®€å•å›é¡¾ä¸€ä¸‹ï¼š è§‚å¯Ÿè€…æ¨¡å¼ç”±è§‚å¯Ÿè€…å’Œè¢«è§‚å¯Ÿè€…ä¸¤ä¸ªè§’è‰²ç»„æˆï¼Œä¸€æ—¦å‘ç”Ÿè¢«è§‚å¯Ÿè€…çš„çŠ¶æ€/æ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œè¢«è§‚å¯Ÿè€…å°±ä¼šé€šçŸ¥åœ¨è§‚å¯Ÿè€…åˆ—è¡¨ä¸­çš„å„ä¸ªè§‚å¯Ÿè€… å‘å¸ƒ/è®¢é˜…æ¨¡å¼æ˜¯åœ¨è§‚å¯Ÿè€…æ¨¡å¼çš„åŸºç¡€ä¸Šå¢åŠ ä¸€ä¸ªå‘å¸ƒè®¢é˜…è§’è‰²ï¼ŒåŠ å…¥è¿™ä¸ªè§’è‰²çš„æœ€é‡è¦ä½œç”¨å°±æ˜¯è§£è€¦ï¼Œå°†è¢«è§‚å¯Ÿè€…å’Œè§‚å¯Ÿè€…åˆ†ç¦»ï¼Œä½¿å¾—å®ƒä»¬ä¹‹é—´çš„ä¾èµ–æ€§æ›´å°ï¼Œå‘å¸ƒè€…çš„å‘å¸ƒåŠ¨ä½œå’Œè®¢é˜…è€…çš„è®¢é˜…åŠ¨ä½œç›¸äº’ç‹¬ç«‹ï¼Œæ— éœ€å…³æ³¨å¯¹æ–¹ï¼Œæ¶ˆæ¯æ´¾å‘ç”±å‘å¸ƒè®¢é˜…ä¸­å¿ƒè´Ÿè´£ å°ç»“å®Œ ä¸‰ã€è¡Œä¸ºå‹æ¨¡å¼ï¼šè´£ä»»é“¾æ¨¡å¼ 1ã€æ¨¡å¼ä»‹ç» è´£ä»»é“¾æ¨¡å¼(Chain Of Responsibility Design Pattern)ï¼šå°†è¯·æ±‚çš„å‘é€å’Œæ¥æ”¶è§£è€¦ï¼Œè®©å¤šä¸ªæ¥æ”¶å¯¹è±¡éƒ½æœ‰æœºä¼šå¤„ç†è¿™ä¸ªè¯·æ±‚ã€‚å°†è¿™äº›æ¥æ”¶å¯¹è±¡ä¸²æˆä¸€æ¡é“¾ï¼Œå¹¶æ²¿ç€è¿™æ¡é“¾ä¼ é€’è¿™ä¸ªè¯·æ±‚ï¼Œç›´åˆ°é“¾ä¸Šçš„æŸä¸ªæ¥æ”¶å¯¹è±¡èƒ½å¤Ÿå¤„ç†å®ƒä¸ºæ­¢ã€‚ æ ¹æ®ä»¥ä¸ŠGoFå¯¹è´£ä»»é“¾æ¨¡å¼çš„å®šä¹‰ï¼Œä¸€æ—¦æŸä¸ªå¤„ç†å™¨èƒ½å¤„ç†è¿™ä¸ªè¯·æ±‚ï¼Œå°±ä¸ä¼šç»§ç»­å°†è¯·æ±‚ä¼ é€’ç»™åç»­çš„å¤„ç†å™¨äº†ï¼Œäº‹å®ä¸Šï¼Œåœ¨å®é™…çš„å¼€å‘ä¸­ä¼šæœ‰ä¸å…è®¸è¯·æ±‚ä¸­æ–­çš„æƒ…å†µï¼Œæ¯ä¸ªå¤„ç†å™¨å¤„ç†å®Œæˆåéœ€è¦ç»§ç»­å‘ä¸‹ä¼ é€’ï¼Œè¿™ä¸ªè¯·æ±‚æœ€ç»ˆè¢«æ‰€æœ‰çš„å¤„ç†å™¨éƒ½å¤„ç†ä¸€éï¼Œæ‰€ä»¥è´£ä»»é“¾æ¨¡å¼çš„å®ç°å¤§ä½“ä¸Šå¯ä»¥åˆ†æˆä¸¤ç§ï¼š å…è®¸ä¸­æ–­è¯·æ±‚ï¼šAndroidäº‹ä»¶åˆ†å‘æœºåˆ¶ã€Androidæœ‰åºå¹¿æ’­ ä¸ä¸­æ–­è¯·æ±‚ï¼šAndroid OKhttp æˆ‘ä»¬æ¥ç€æ¥çœ‹è´£ä»»é“¾æ¨¡å¼çš„è§’è‰²åˆ†é…ï¼Œåœ¨ä¸€ä¸ªå®Œæ•´çš„è´£ä»»é“¾æ¨¡å¼ä¸­ï¼Œè‡³å°‘è¦åŒ…å«ä¸¤ä¸ªè§’è‰²ï¼š Handlerï¼šæŠ½è±¡å¤„ç†è€…è§’è‰²ï¼Œå£°æ˜ä¸€ä¸ªè¯·æ±‚å¤„ç†çš„æ–¹æ³•ï¼Œå¹¶åœ¨å…¶ä¸­ä¿æŒä¸€ä¸ªå¯¹ä¸‹ä¸€ä¸ªå¤„ç†èŠ‚ç‚¹Handlerå¯¹è±¡çš„å¼•ç”¨ ConcreteHandlerï¼šå…·ä½“å¤„ç†è€…è§’è‰²ï¼Œå¯¹è¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œå¦‚æœä¸èƒ½å¤„ç†åˆ™å°†è¯¥è¯·æ±‚è½¬å‘ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸Šçš„å¤„ç†å¯¹è±¡ è´£ä»»é“¾æ¨¡å¼UMLç±»å›¾ï¼š 2ã€ä»£ç ç¤ºä¾‹ //æŠ½è±¡å¤„ç†è€… public abstract class Handler { protected Handler next; public abstract void handleRequest(String msg); } //å…·ä½“çš„å¤„ç†è€…1 public class ConcreteHandler1 extends Handler { @Override public void handleRequest(String msg) { if (msg.equals(&quot;ConcreteHandler1&quot;)) System.out.println(&quot;ConcreteHandler1 handled&quot;); else if (next != null) next.handleRequest(msg); } } //å…·ä½“çš„å¤„ç†è€…2 public class ConcreteHandler2 extends Handler { @Override public void handleRequest(String msg) { if (msg.equals(&quot;ConcreteHandler2&quot;)) System.out.println(&quot;ConcreteHandler2 handled&quot;); else if (next != null) next.handleRequest(msg); } } //æµ‹è¯•ç±» public class Test { public void main() { ConcreteHandler1 handler1 = new ConcreteHandler1(); ConcreteHandler2 handler2 = new ConcreteHandler2(); handler1.next = handler2; handler2.next = handler1; handler1.handleRequest(&quot;ConcreteHandler2&quot;); } } æ‰“å°ç»“æœ ConcreteHandler2 handled 3ã€æºç é”šç‚¹ è´£ä»»é“¾æ¨¡å¼å¤šä½¿ç”¨äºæ¡†æ¶çš„è®¾è®¡ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è´£ä»»é“¾æ¨¡å¼æ¥æä¾›æ¡†æ¶çš„æ‰©å±•ç‚¹ï¼Œè¿™æ ·å°±èƒ½å¤Ÿè®©ä½¿ç”¨è€…åœ¨ä¸ä¿®æ”¹æ¡†æ¶æºç çš„æƒ…å†µä¸‹ï¼Œå¤ç”¨å’Œæ‰©å±•æ¡†æ¶çš„åŠŸèƒ½ï¼Œä»¥Android OkHttpä¸¾ä¾‹ï¼š æˆ‘ä»¬çŸ¥é“ï¼ŒOkHttpä½¿ç”¨æ–¹æ³•æ˜¯é€šè¿‡OkHttpClientçš„newCallæ–¹æ³•åˆ›å»ºäº†ä¸€ä¸ªCallå¯¹è±¡ï¼Œå¹¶è°ƒç”¨executeæ–¹æ³•å‘èµ·åŒæ­¥è¯·æ±‚æˆ–è€…è°ƒç”¨enqueueæ–¹æ³•å‘èµ·å¼‚æ­¥è¯·æ±‚ è¿™å…¶ä¸­ï¼Œæ¯ä¸€ä¸ªCallå¯¹è±¡å°±ä»£è¡¨ä¸€ä¸ªç½‘ç»œè¯·æ±‚ï¼Œå®ƒçš„å®ç°ç±»åªæœ‰ä¸€ä¸ªRealCallï¼š package okhttp3; //https://github.com/square/okhttp //OkHttpä»4.0è½¬ä¸ºKotlinå®ç°ï¼Œå¯¹Kotlinä»£ç æ¯”è¾ƒåƒåŠ›çš„åŒå­¦å¯ä»¥å°†åˆ†æ”¯åˆ‡æ¢åˆ°okhttp_3.14.x final class RealCall implements Call { //1. è°ƒç”¨executeå‘èµ·è¯·æ±‚ @Override public Response execute() throws IOException { //... try { client.dispatcher().executed(this); return getResponseWithInterceptorChain(); } finally { client.dispatcher().finished(this); } } //2. è·å–å“åº”æŠ¥æ–‡ï¼ŒåŸºäºè´£ä»»é“¾æ¨¡å¼ Response getResponseWithInterceptorChain() throws IOException { // Build a full stack of interceptors. List&lt;Interceptor&gt; interceptors = new ArrayList&lt;&gt;(); interceptors.addAll(client.interceptors()); interceptors.add(new RetryAndFollowUpInterceptor(client)); interceptors.add(new BridgeInterceptor(client.cookieJar())); //... //æœ€ç»ˆè°ƒç”¨å‘èµ· interceptors.add(new CallServerInterceptor(forWebSocket)); Interceptor.Chain chain = new RealInterceptorChain(interceptors, transmitter, null, 0, originalRequest, this, client.connectTimeoutMillis(), client.readTimeoutMillis(), client.writeTimeoutMillis()); try { Response response = chain.proceed(originalRequest); return response; } catch (IOException e) { //... } } } getResponseWithInterceptorChain()ä¸­çš„ä»£ç ä¸æ˜¯å¾ˆå¤æ‚ï¼Œå°±æ˜¯å°†ç”¨æˆ·ä¼ å…¥çš„æ‹¦æˆªå™¨æ”¶é›†èµ·æ¥å†åŠ ä¸Šé»˜è®¤çš„ä¸€äº›ç¼“å­˜æ‹¦æˆªå™¨ã€è¿æ¥æ‹¦æˆªå™¨ç­‰ï¼Œç„¶åç»„è£…æˆä¸€ä¸ªRealInterceptorChainç±»ï¼Œå†è°ƒç”¨å…¶proceedæ–¹æ³•ï¼Œå¾—åˆ°å“åº”æŠ¥æ–‡response åœ¨proceedæ–¹æ³•ä¸­ï¼Œä¼šä¸æ–­çš„æŸ¥æ‰¾ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œç„¶åå†è°ƒç”¨æ‹¦æˆªå™¨çš„intercept()æ–¹æ³• package okhttp3.internal.http; public final class RealInterceptorChain implements Interceptor.Chain { public Response proceed(Request request, Transmitter transmitter, Exchange exchange) throws IOException { // Call the next interceptor in the chain. RealInterceptorChain next = new RealInterceptorChain(interceptors, transmitter, exchange, index + 1, request, call, connectTimeout, readTimeout, writeTimeout); //æ‰¾åˆ°ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨ Interceptor interceptor = interceptors.get(index); Response response = interceptor.intercept(next); return response; } } æœ€ååœ¨interceptæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¯¹è¯·æ±‚æŠ¥æ–‡å’Œå“åº”æŠ¥æ–‡åšå¤„ç† public final class Interceptor implements Interceptor { @Override public Response intercept(Chain chain) throws IOException { //å¤„ç†requestè¯·æ±‚ï¼ŒæŠ¥æ–‡åŠ å¯†ä¹‹ç±»å°±æ˜¯åœ¨è¿™ä¸€æ­¥ Request request = chain.request(); //å¤„ç†è¿”å›ç»“æœï¼Œæ¯”å¦‚ç»Ÿä¸€æŠ¥é”™æ‹¦æˆª Response response = chain.proceed(request); return response; } } è‡³æ­¤ï¼Œæ•´ä¸ªè°ƒç”¨é“¾è·¯å°±ç»“æŸäº†ï¼Œæœ€åæˆ‘ä»¬ç”¨ä¸€å¼ å›¾æ¥æ€»ç»“æ‹¦æˆªå™¨è´£ä»»é“¾ï¼š 4ã€å°ç»“ è´£ä»»é“¾æ¨¡å¼é€šå¸¸ç”±é“¾å¼ç»“æ„ç»„æˆï¼Œå¯¹äºé“¾å¼ç»“æ„æ¥è¯´ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½å¯ä»¥è¢«æ‹†å¼€å†è¿æ¥(ä¹Ÿå«å¯æ’æ‹”)ï¼Œå› æ­¤ï¼Œè´£ä»»é“¾æ¨¡å¼ç”Ÿæ¥å°±å…·æœ‰å¾ˆå¥½çš„çµæ´»æ€§ æˆ‘ä»¬å¯ä»¥æŠŠé“¾ä¸Šçš„æ¯ä¸€ä¸ªèŠ‚ç‚¹çœ‹ä½œæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä¸åŒçš„å¯¹è±¡æ‹¥æœ‰ä¸åŒçš„å¤„ç†é€»è¾‘ï¼›å°†ä¸€ä¸ªè¯·æ±‚ä»é“¾å¼çš„é¦–ç«¯å‘å‡ºï¼Œæ²¿ç€é“¾çš„è·¯å¾„ä¾æ¬¡ä¼ é€’ï¼Œæ¯ä¸€ä¸ªæ³¨å†Œåˆ°é“¾ä¸Šçš„å¤„ç†è€…å¯ä»¥é€‰æ‹©è¦ä¸è¦æ¶ˆè´¹å½“å‰çš„è¯·æ±‚ï¼Œå½“å‰èŠ‚ç‚¹å¤„ç†å®Œæˆåï¼Œå¯ä»¥å†æ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©è¦ä¸è¦å‘ä¸‹ä¼ é€’ï¼Œç›´åˆ°æœ€åä¸€ä¸ªå¤„ç†è€…å¤„ç†å®Œæˆæˆ–è€…æŸä¸ªèŠ‚ç‚¹ç»ˆæ­¢ä¼ é€’ å°èŠ‚å®Œ å››ã€è¡Œä¸ºå‹æ¨¡å¼ï¼šä¸­ä»‹è€…æ¨¡å¼ 1ã€æ¨¡å¼ä»‹ç» ä¸­ä»‹è€…æ¨¡å¼(Mediator)å®šä¹‰äº†ä¸€ä¸ªå•ç‹¬çš„ä¸­ä»‹å¯¹è±¡ï¼Œæ¥å°è£…ä¸€ç»„å¯¹è±¡ä¹‹é—´çš„äº¤äº’ï¼›å°†è¿™ç»„å¯¹è±¡ä¹‹é—´çš„äº¤äº’å§”æ´¾ç»™ä¸ä¸­ä»‹å¯¹è±¡äº¤äº’ï¼Œæ¥é¿å…å¯¹è±¡ä¹‹é—´çš„ç›´æ¥äº¤äº’ã€‚ å½“å¯¹è±¡ä¹‹é—´çš„äº¤äº’æ“ä½œå¾ˆå¤šä¸”æ¯ä¸ªå¯¹è±¡çš„è¡Œä¸ºæ“ä½œéƒ½ä¾èµ–å½¼æ­¤æ—¶ï¼Œä¸ºé˜²æ­¢åœ¨ä¿®æ”¹ä¸€ä¸ªå¯¹è±¡çš„è¡Œä¸ºæ—¶ï¼ŒåŒæ—¶æ¶‰åŠä¿®æ”¹å¾ˆå¤šå…¶ä»–å¯¹è±¡çš„è¡Œä¸ºï¼Œå¯é‡‡ç”¨ä¸­ä»‹è€…æ¨¡å¼ï¼Œæ¥è§£å†³ç´§è€¦åˆé—®é¢˜ã€‚ ä¸¾ä¸ªä¾‹å­æ¥è§£é‡Šä¸€ä¸‹ï¼šåœ¨å®¢æˆ·ç«¯ç”µå•†é¦–é¡µå¼€å‘æ€»ï¼Œè¦æ±‚bannerè½®æ’­åˆ‡æ¢çš„åŒæ—¶è¦ä¿®æ”¹èƒŒæ™¯å›¾ï¼Œè¿˜è¦æ³¨æ„è‰²å€¼æ¥åŠ¨æ€æ”¹å˜çŠ¶æ€æ é¢œè‰²æ·±æµ…ï¼Œä¸‹æ‹‰å±•ç¤ºäºŒæ¥¼å’Œå·¦å³æ»‘åŠ¨åˆ‡æ¢tabæ—¶è¦æ¸å˜é€æ˜åº¦ï¼Œæµè§ˆå•†å“æ—¶çŠ¶æ€æ è¦å¤åŸåŒæ—¶banneråœæ­¢æ»šåŠ¨ï¼Œå¯¹äºå®¢æˆ·ç«¯å¼€å‘æ¥è¯´ï¼Œå½“ä¸€ä¸ªé¡µé¢çš„æ§ä»¶æ”¹å˜éœ€è¦åŒæ­¥ç»™å…¶ä»–è‹¥å¹²ä¸ªæ§ä»¶æ—¶ï¼Œå…¶å®ƒæ§ä»¶çŠ¶æ€æ”¹å˜ä¹Ÿéœ€è¦äº’ç›¸ä¹‹é—´åŒæ­¥æ—¶ï¼Œè¿™ä»£ç é€»è¾‘å†™èµ·æ¥ç®€ç›´è¦çˆ†ç‚¸ è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±éœ€è¦å¼•å…¥ä¸€ä¸ªä¸­é—´äººï¼ŒæŠŠæ¯ä¸ªæ§ä»¶çŠ¶æ€æ”¹å˜éƒ½äº¤ç»™åŒä¸€äººå¤„ç†ï¼Œæ¯ä¸ªæ§ä»¶æ§åˆ¶æƒä¹Ÿäº¤ç”±ä¸­é—´äºº åŠ å…¥äº†ä¸­ä»‹è€…ä¹‹åçš„é€»è¾‘å›¾ï¼š æœ‰äº†ä¸­ä»‹è€…ä¹‹åï¼Œç å»äº†å„ä¸ªç±»ä¹‹é—´çš„ç›´æ¥è”ç³»ï¼Œå°†æ‚ä¹±æ— ç« çš„é€»è¾‘å…³ç³»æ”¹ä¸ºæ˜ŸçŠ¶çš„é€»è¾‘å…³ç³»ï¼Œè‡ªå·±çš„çŠ¶æ€æ§åˆ¶å’ŒçŠ¶æ€æ”¹å˜å…¨éƒ¨äº¤ç”±ä¸­ä»‹è€…æ¥å¤„ç†ï¼Œå¤§å¤§å‡å°‘å„ä¸ªç±»çš„é€»è¾‘å¤„ç† 2ã€å°ç»“ ä¸­ä»‹è€…æ¨¡å¼ä»æŸç§è§’åº¦æ¥è¯´åƒæ˜¯ç®—æ³•é‡Œé¢çš„è´ªå¿ƒç­–ç•¥ï¼Œå›é¡¾4.1ä¸­çš„ä¾‹å­ï¼Œå½“ä¸€ä¸ªé¡µé¢çš„æ§ä»¶æ”¹å˜éœ€è¦åŒæ­¥ç»™å…¶ä»–è‹¥å¹²ä¸ªæ§ä»¶æ—¶ï¼Œå•å•ç»´æŠ¤æ§ä»¶é€šä¿¡ä¸€é¡¹å°±å·²ç»å¾ˆéº»çƒ¦äº†ï¼Œè¿™æ—¶å€™ä¼šè‡ªç„¶è€Œç„¶çš„é€‰æ‹©æœ€ä¼˜è§£ï¼Œå³å¼•å…¥ä¸­é—´å±‚ç„¶åå°†æ¯ä¸ªæ§ä»¶çŠ¶æ€æ”¹å˜éƒ½äº¤ç»™å®ƒæ¥å¤„ç†ï¼Œæ­£å› ä¸ºå¦‚æ­¤ï¼Œåœ¨å®¢æˆ·ç«¯å¼€å‘ä¸­ï¼Œä¸­ä»‹è€…æ¨¡å¼å¸¸å¸¸ä¸è§‚å¯Ÿè€…æ¨¡å¼åŒæ—¶å‡ºç° å°èŠ‚å®Œ äº”ã€è¡Œä¸ºå‹æ¨¡å¼ï¼šç­–ç•¥æ¨¡å¼ 1ã€æ¨¡å¼å®šä¹‰ ç­–ç•¥æ¨¡å¼ï¼Œè‹±æ–‡å…¨ç§°æ˜¯ Strategy Design Patternï¼Œåœ¨ GoF çš„ã€Šè®¾è®¡æ¨¡å¼ã€‹ä¸€ä¹¦ä¸­ï¼Œå®ƒæ˜¯è¿™æ ·å®šä¹‰çš„ï¼š Define a family of algorithms, encapsulate each one, and make them interchangeable. Strategy lets the algorithm vary independently from clients that use it. å®šä¹‰ä¸€ç³»åˆ—ç®—æ³•ï¼Œå°†æ¯ä¸ªç®—æ³•åˆ†åˆ«å°è£…èµ·æ¥ï¼Œå¹¶ä½¿å®ƒä»¬å¯äº’æ¢ï¼›ç­–ç•¥æ¨¡å¼å¯ä»¥ä½¿ç®—æ³•çš„å˜åŒ–ç‹¬ç«‹äºä½¿ç”¨å®ƒä»¬çš„å®¢æˆ·ç«¯ GoFä¸­è¿˜æåˆ°ï¼Œåœ¨ç­–ç•¥æ¨¡å¼ä¸­ï¼Œåº”å½“ç”±å®¢æˆ·ç«¯è‡ªå·±å†³å®šåœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä½¿ç”¨ä»€ä¹ˆå…·ä½“ç­–ç•¥è§’è‰²ï¼Œç­–ç•¥æ¨¡å¼ä»…ä»…å°è£…ç®—æ³• åœ¨ç¿»é˜…äº†å¤§é‡ä¹¦ç±/æ–‡ç« åï¼Œç¬”è€…è®¤ä¸ºä¸Šé¢çš„è¯ä¹Ÿå¯ä»¥è¿™ä¹ˆç†è§£ï¼šåœ¨ä¸€ä¸ªç³»ç»Ÿä¸­ï¼Œä¸åŒå¯¹è±¡çš„åŒä¸€è¡Œä¸ºä¼šæœ‰ä¸åŒçš„ç»“æœï¼Œä¾¿å¯ä½¿ç”¨ç­–ç•¥æ¨¡å¼ å¬èµ·æ¥å¥½åƒå¾ˆç†Ÿæ‚‰ï¼Œå’ŒJavaè¯­è¨€ä¸­çš„å¤šæ€è§£å†³çš„åœºæ™¯æ˜¯é‡å¤çš„ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠç­–ç•¥æ¨¡å¼ç­‰åŒäºå¤šæ€çš„è¯ç†è§£èµ·æ¥å°±å®¹æ˜“å¤šäº† å°èŠ‚å®Œ å…­ã€ç•ªå¤–ç¯‡ï¼šç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ 1ã€æ¨¡å¼ä»‹ç» ç”Ÿäº§è€…/æ¶ˆè´¹è€…æ¨¡å¼è™½ç„¶ä¸åœ¨23ç§è®¾è®¡æ¨¡å¼ä¹‹åˆ—ï¼Œä½†æˆ‘è®¤ä¸ºå®ƒåœ¨è½¯ä»¶å·¥ç¨‹çš„é‡è¦æ€§ç»ä¸äºšäº23ç§è®¾è®¡æ¨¡å¼ä¸­ä»»ä½•ä¸€ç§ æ— è®ºæ˜¯Androidå®¢æˆ·ç«¯çš„Handleræœºåˆ¶ï¼Œè¿˜æ˜¯åç«¯çš„å„ç§MQæ¶ˆæ¯ä¸­é—´ä»¶ï¼Œä»–ä»¬çš„è®¾è®¡æ€æƒ³éƒ½æ˜¯åŸºäºç”Ÿäº§è€…/æ¶ˆè´¹è€…æ¨¡å¼ ç®€å•ä¸€å¥è¯æ¦‚æ‹¬ä»€ä¹ˆæ˜¯ç”Ÿäº§è€…/æ¶ˆè´¹è€…æ¨¡å¼ï¼šå¤šä¸ªè¿›ç¨‹/çº¿ç¨‹å…±äº«ä¸€ä¸ªé˜»å¡é˜Ÿåˆ—ï¼Œç”Ÿäº§è€…è´Ÿè´£pushä»»åŠ¡è¿›é˜Ÿåˆ—ï¼Œæ¶ˆè´¹è€…è´Ÿè´£å–å‡ºä»»åŠ¡å»æ‰§è¡Œ 2ã€ä»£ç ç¤ºä¾‹ æˆ‘ä»¬ç”¨ä»£ç å®ç°UMLç±»å›¾çš„æ¨¡å¼ï¼Œæ‹†åˆ†ä¸€ä¸‹ä¸Šé¢çš„å›¾ï¼Œæœ‰ä¸‰ä¸ªè§’è‰²ï¼šæ¶ˆæ¯é˜Ÿåˆ—ã€ç”Ÿäº§è€…ã€æ¶ˆè´¹è€… é¦–å…ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œä½¿ç”¨é›†åˆæ¡†æ¶ä¸­ç°æˆçš„é˜Ÿåˆ—å°±è¡Œäº†ï¼Œå¦‚ä¸‹ï¼š static final Queue&lt;String&gt; messageQueue = new ArrayDeque&lt;&gt;(); æ¥ç€è¦æœ‰è‡³å°‘ä¸€ä¸ªç”Ÿäº§è€…ï¼Œè´Ÿè´£ç”Ÿäº§æ¶ˆæ¯ï¼Œç¤ºä¾‹è¿™é‡Œçš„ç”Ÿäº§è€…æ˜¯Java Scannerï¼Œè´Ÿè´£ä¸æ–­è·å–æ§åˆ¶å°è¾“å…¥çš„æ¶ˆæ¯ï¼Œç„¶åæ·»åŠ åˆ°æ¶ˆæ¯é˜Ÿåˆ—å½“ä¸­ final static class ProducerThread extends Thread { @Override public void run() { Scanner scanner = new Scanner(System.in); System.out.println(&quot;please input:&quot;); //ç”Ÿäº§è€…çº¿ç¨‹è·å–æ§åˆ¶å°æ¶ˆæ¯ while (true) { String line = scanner.next(); if (line.equals(&quot;exit&quot;)) break; //è·å–åˆ°æ¶ˆæ¯åæ·»åŠ åˆ°å…±äº«çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼ŒåŒæ—¶å”¤é†’å¯èƒ½æ­£åœ¨ç­‰å¾…çš„æ¶ˆè´¹è€…çº¿ç¨‹ synchronized (messageQueue) { messageQueue.add(line); messageQueue.notify(); } } } } æ¥ç€è¦æœ‰ä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œè´Ÿè´£æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ final static class ConsumerThread extends Thread { public ConsumerThread(String name) { super(name); } @Override public void run() { synchronized (messageQueue) { //æ¶ˆè´¹è€…ä¸€ç›´ä¸åœçš„ä»å…±äº«æ¶ˆæ¯é˜Ÿåˆ—å–æ¶ˆæ¯ while (true) { if (messageQueue.isEmpty()) { messageQueue.wait();// æ²¡æœ‰æ¶ˆæ¯åˆ™é˜»å¡ï¼Œç­‰å¾…å”¤é†’ } // è¢«å”¤é†’åä¼šæ‰§è¡Œè¯¥æ–¹æ³• execute(messageQueue.poll()); } } } private void execute(String msg) { //do something System.out.println(getName() + &quot; take msg:&quot; + msg); } } å¥½äº†ï¼Œä¸‰ä¸ªè§’è‰²éƒ½å·²ç»æœ‰äº†ï¼Œä¸‹é¢æˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹ public static void main(String[] args) { ProducerThread producerThread = new ProducerThread(); producerThread.start();//å¯åŠ¨ç”Ÿäº§è€…çº¿ç¨‹ ConsumerThread consumerThread1 = new ConsumerThread(&quot;æ¶ˆè´¹è€…1å·&quot;); ConsumerThread consumerThread2 = new ConsumerThread(&quot;æ¶ˆè´¹è€…2å·&quot;); //å¯åŠ¨æ¶ˆè´¹è€…çº¿ç¨‹ consumerThread1.start(); consumerThread2.start(); } æ‰“å°ç»“æœ please input: 1 æ¶ˆè´¹è€…1å· take msg:1 2 æ¶ˆè´¹è€…2å· take msg:2 3ã€æºç é”šç‚¹ ç¬”è€…æ˜¯Androidå·¥ç¨‹å¸ˆï¼Œæ‰€ä»¥æœ¬ç« èŠ‚æˆ‘ä»¬æ¥æ¢è®¨ä¸€ä¸‹Android Handleræœºåˆ¶çš„è®¾è®¡ æˆ‘ä»¬çŸ¥é“ï¼ŒAndorid Handleræœºåˆ¶ç”±Handlerã€Looperã€Messageå’ŒMessageQueueè¿™4ä¸ªç±»ç»„æˆï¼Œä»–ä»¬çš„èŒè´£åˆ†å·¥å’Œ6.2ä¸­çš„ä»£ç ç¤ºä¾‹æ²¡ä»€ä¹ˆåŒºåˆ«ï¼š Handlerï¼šæ¶ˆæ¯ç”Ÿäº§è€… åªè¦æ˜¯åœ¨MainLooperæ‰€åœ¨çº¿ç¨‹åˆ›å»ºçš„Handlerå°±ä¼šæŒæœ‰å…±äº«æ¶ˆæ¯é˜Ÿåˆ—MessageQueueï¼Œåœ¨ä»»æ„çº¿ç¨‹ä¸­è°ƒç”¨è¯¥Handlerçš„sendMessageå‘é€çš„æ¶ˆæ¯éƒ½ä¼šè¢«æ·»åŠ åˆ°å…±äº«æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œå…±äº«æ¶ˆæ¯é˜Ÿåˆ—ç”±Javaçš„çº¿ç¨‹å±€éƒ¨å­˜å‚¨æœºåˆ¶(ThreadLocal)ä¿è¯å”¯ä¸€æ€§ Looperï¼šæ¶ˆæ¯çš„æ¶ˆè´¹è€… loop()æ–¹æ³•ä¸­ä¼šä¸€ç›´è½®è¯¢æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®ƒçš„ä»»åŠ¡å°±æ˜¯å–æ¶ˆæ¯ã€å–æ¶ˆæ¯å’Œå–æ¶ˆæ¯ï¼Œå–åˆ°æ¶ˆæ¯åå°±åˆ†å‘æ¶ˆæ¯ã€åˆ†å‘æ¶ˆæ¯å’Œåˆ†å‘æ¶ˆæ¯ MessageQueueï¼šå…±äº«çš„æ¶ˆæ¯é˜Ÿåˆ— åœ¨next()æ–¹æ³•ä¸­ï¼Œè‹¥æ¶ˆæ¯é˜Ÿåˆ—ä¸ºç©ºåˆ™ä¼šé˜»å¡ç­‰å¾…ï¼Œå‚è€ƒ6.2ç¤ºä¾‹ä¸­æ¶ˆæ¯é˜Ÿåˆ—ä¸ºç©ºæ—¶å°±æŒ‚èµ·å½“å‰çº¿ç¨‹ï¼ŒçŸ¥é“è¢«å”¤é†’ Messageï¼šä¸é…æ‹¥æœ‰å§“åï¼Œåªæ˜¯ä¸ªæ¶ˆæ¯å¯¹è±¡ è¿™é‡Œæ³¨æ„ä¸€ç‚¹ï¼Œåœ¨Handleræœºåˆ¶ä¸­ï¼ŒLooperçš„è§’è‰²è™½ç„¶æ˜¯æ¶ˆè´¹è€…ï¼Œä½†æ˜¯å®ƒåªè´Ÿè´£ä»æ¶ˆæ¯é˜Ÿåˆ—å–æ¶ˆæ¯ï¼Œä¸è´Ÿè´£å¤„ç†ã€‚loop()æ–¹æ³•ä¸­æ¯æ¬¡å–åˆ°æ¶ˆæ¯å°±äº¤ç»™æ¶ˆæ¯æ‰€å±çš„Handlerç±»å¤„ç† æ­¤å°èŠ‚æ¶‰åŠåˆ°çš„ä»£ç åœ¨è¿™é‡Œ 4ã€å°ç»“ ç”Ÿäº§è€…/æ¶ˆè´¹è€…æ¨¡å¼è§£è€¦äº†ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…ä¹‹é—´çš„ç›´æ¥è”ç³»ï¼Œè€Œä¸”ç”±äºå…±äº«æ¶ˆæ¯é˜Ÿåˆ—çš„å­˜åœ¨ï¼Œå¤§å¤šåº”ç”¨åœ¨å„å¤§å¤šçº¿ç¨‹å¼‚æ­¥åä½œå½“ä¸­ åœ¨åç«¯å¼€å‘ä¸­ï¼Œå…±äº«æ¶ˆæ¯é˜Ÿåˆ—æœ¬èº«å°±æ˜¯ä¸ªç¼“å†²åŒºï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è°ƒæ•´ç¼“å†²åŒºçš„å¤§å°æ¥åº”å¯¹é«˜å¹¶å‘æ—¶è¯·æ±‚æ•°é‡å¤ªå¤§æœåŠ¡å™¨åº”ä»˜ä¸è¿‡æ¥ç­‰ç±»ä¼¼åœºæ™¯ åœ¨Androidæˆ–å…¶ä»–åŒ…å«ç”¨æˆ·ç•Œé¢çš„æ“ä½œç³»ç»Ÿä¸­ï¼Œå…±äº«æ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥ä¿è¯æ‰€æœ‰æ›´æ–°ç•Œé¢çš„æ“ä½œéƒ½åªåœ¨UIçº¿ç¨‹è¿›è¡Œ å°ç»“å®Œ ä¸ƒã€æ€»ç»“ è‡³æ­¤ï¼Œè¡Œä¸ºå‹æ¨¡å¼å·²ç»å…¨éƒ¨ä»‹ç»å®Œäº†ï¼Œæˆ‘ä»¬æ¥ç®€å•å›é¡¾ä¸€ä¸‹ï¼š è§‚å¯Ÿè€…æ¨¡å¼(Observer)ï¼šæŒæœ‰å›è°ƒåˆ—è¡¨ è´£ä»»é“¾æ¨¡å¼(Chain of Responsibility)ï¼šOkHttp ä¸­ä»‹è€…æ¨¡å¼(Mediator)ï¼šæ˜ŸçŠ¶è¿æ¥å›¾ ç­–ç•¥æ¨¡å¼(Strategy)ï¼šJavaå¤šæ€ å‘½ä»¤æ¨¡å¼(Command)ï¼šJavaå°è£… è§£é‡Šå™¨æ¨¡å¼(Interpreter)ï¼šAndroid LayoutInflater è¿­ä»£å™¨æ¨¡å¼(Iterator)ï¼šJava iteratoræ¥å£ æ¨¡æ¿æ–¹æ³•(Template Method)ï¼šAndroidç”Ÿå‘½å‘¨æœŸåŠå„ç§baseå±‚ çŠ¶æ€æ¨¡å¼(State)ï¼šè¿ªè¿¦å¥¥ç‰¹æ›¼åŠ›é‡/é€Ÿåº¦å½¢æ€ï¼Œç­‰åŒç­–ç•¥æ¨¡å¼ è®¿é—®è€…æ¨¡å¼(Visitor)ï¼šå—¯~çœ‹ä¸æ‡‚/å¤´å¤§.jpg (Â´ï½¥_ï½¥`) å¤‡å¿˜å½•æ¨¡å¼(Memento)ï¼šAndroid Canvas(save/restore) è¡Œä¸ºå‹æ¨¡å¼çš„æ•°é‡çœ‹èµ·æ¥æ¯”è¾ƒå¤šï¼Œä½†æ¯•ç«Ÿ20å¤šå¹´è¿‡å»äº†ï¼Œä»¥å‰çš„æ¨¡å¼æˆ–ä¸é€‚ç”¨å½“å‰ç¯å¢ƒï¼Œæˆ–ç›´æ¥è¢«èå…¥è¯­è¨€/å¼€å‘æ¨¡å¼ä¸­ï¼Œä»¥æœ¬ç« è¡Œä¸ºå‹æ¨¡å¼æ¥ä¸¾ä¾‹ï¼š æœ‰ä¸ºäº†ä¸šåŠ¡éœ€æ±‚å¿…é¡»è¿™ä¹ˆè®¾è®¡çš„ï¼Œä¾‹å¦‚ï¼šè§£é‡Šå™¨æ¨¡å¼ã€å¤‡å¿˜å½• æœ‰è¢«èå…¥è¯­è¨€ç‰¹æ€§çš„ï¼šå‘½ä»¤æ¨¡å¼(Javaå°è£…)ã€ç­–ç•¥æ¨¡å¼(Javaå¤šæ€) æœ‰æ˜¯äººéƒ½ä¼šé€‰æ‹©æœ€ä¼˜è§£çš„ï¼šä¸­ä»‹è€…æ¨¡å¼ è¿˜æœ‰æˆ‘è®¤ä¸ºé›·åŒçš„ï¼ŒçŠ¶æ€æ¨¡å¼å’Œç­–ç•¥æ¨¡å¼ï¼Œåœ¨å®é™…å¼€å‘ä¸­ï¼Œä¸ç®¡æ˜¯ä»å®ç°è§’åº¦è¿˜æ˜¯è§£å†³é—®é¢˜çš„åœºæ™¯æ¥çœ‹æˆ‘ä¸è®¤ä¸ºå®ƒä»¬ä¸¤è€…æœ‰ä»€ä¹ˆåŒºåˆ« æœ‰ç”¨çš„å‡ ç§è¡Œä¸ºå‹æ¨¡å¼ä¸­ï¼Œå¦‚è§‚å¯Ÿè€…æ¨¡å¼ã€è´£ä»»é“¾æ¨¡å¼ä¸»è¦æ˜¯è§£å†³å¯¹è±¡ä¸å¯¹è±¡ä¹‹é—´èŒè´£åˆ†é…çš„é—®é¢˜ å…«ã€å‚è€ƒèµ„æ–™ å›¾è¯´è®¾è®¡æ¨¡å¼ refactoringguru.cn æå®¢æ—¶é—´ï¼šè®¾è®¡æ¨¡å¼ä¹‹ç¾-ç‹äº‰ ã€Šè®¾è®¡æ¨¡å¼ï¼šå¯å¤ç”¨é¢å‘å¯¹è±¡è½¯ä»¶çš„åŸºç¡€ã€‹ ã€ŠAndroid æºç è®¾è®¡æ¨¡å¼è§£æä¸å®æˆ˜ã€‹-ä½•çº¢è¾‰ / å…³çˆ±æ°‘ ã€Šæ·±å…¥æµ…å‡ºè®¾è®¡æ¨¡å¼-LeetCodeã€‹ ã€ŠHead First è®¾è®¡æ¨¡å¼ã€‹ jimuzzï¼šä»è®¾è®¡æ¨¡å¼è§’åº¦çœ‹OkHttpæºç  ","link":"https://yibaoshan.github.io/post/design-pattern-behavioral/"},{"title":"æ¼«è°ˆè®¾è®¡æ¨¡å¼ï¼ˆäºŒï¼‰ï¼šç»“æ„å‹æ¨¡å¼","content":" ç‚¹å‡»è·³è½¬åˆ°æ˜é‡‘é˜…è¯» ä¸€ã€å‰è¨€ ç»“æ„å‹æ¨¡å¼(Structural Pattern)æè¿°å¦‚ä½•å°†ç±»æˆ–è€…å¯¹è±¡ç»“åˆåœ¨ä¸€èµ·å½¢æˆæ›´å¤§çš„ç»“æ„ï¼Œå°±åƒæ­ç§¯æœ¨ï¼Œå¯ä»¥é€šè¿‡ç®€å•çš„ç»„åˆå½¢æˆå¤æ‚çš„ã€åŠŸèƒ½æ›´ä¸ºå¼ºå¤§çš„ç»“æ„ã€‚ ç»“æ„å‹æ¨¡å¼çš„å®ç°å¯ä»¥åˆ†ä¸ºä¸¤ç§ï¼Œç±»ç»“æ„å‹æ¨¡å¼å’Œå¯¹è±¡ç»“æ„å‹æ¨¡å¼ï¼Œå…¶ä¸­ï¼š ç±»ç»“æ„å‹æ¨¡å¼å…³å¿ƒç±»çš„ç»„åˆï¼Œç”±å¤šä¸ªç±»å¯ä»¥ç»„åˆæˆä¸€ä¸ªæ›´å¤§çš„ç³»ç»Ÿï¼Œåœ¨ç±»ç»“æ„å‹æ¨¡å¼ä¸­ä¸€èˆ¬åªå­˜åœ¨ç»§æ‰¿å…³ç³»å’Œæ¥å£å®ç°å…³ç³»ã€‚ å¯¹è±¡ç»“æ„å‹æ¨¡å¼å…³å¿ƒç±»ä¸å¯¹è±¡çš„ç»„åˆï¼Œé€šè¿‡å…³è”å…³ç³»ä½¿å¾—åœ¨ä¸€ä¸ªç±»ä¸­å®šä¹‰å¦ä¸€ä¸ªç±»çš„å®ä¾‹å¯¹è±¡ï¼Œç„¶åé€šè¿‡è¯¥å¯¹è±¡è°ƒç”¨å…¶æ–¹æ³•ã€‚æ ¹æ®â€œåˆæˆå¤ç”¨åŸåˆ™â€ï¼Œåœ¨ç³»ç»Ÿä¸­å°½é‡ä½¿ç”¨å…³è”å…³ç³»æ¥æ›¿ä»£ç»§æ‰¿å…³ç³»ï¼Œå› æ­¤å¤§éƒ¨åˆ†ç»“æ„å‹æ¨¡å¼éƒ½æ˜¯å¯¹è±¡ç»“æ„å‹æ¨¡å¼ã€‚ æœ¬æ–‡å°†ä¼šä»‹ç»å‡ ç§å¸¸è§çš„ç»“æ„å‹æ¨¡å¼ï¼Œä»–ä»¬åˆ†åˆ«æ˜¯ï¼š äº«å…ƒæ¨¡å¼(Flyweight) ä»£ç†æ¨¡å¼(Proxy) è£…é¥°æ¨¡å¼(Decorator) é€‚é…å™¨æ¨¡å¼(Adapter) æ¡¥æ¥æ¨¡å¼(Bridge) å¤–è§‚æ¨¡å¼(Facade) åŒæ—¶ï¼Œä¸ºäº†æ›´åŠ æ–¹ä¾¿çš„ç†è§£ç»“æ„å‹æ¨¡å¼çš„è®¾è®¡æ€æƒ³ï¼Œæœ¬æ–‡å°†åŠ å…¥ä¸€ä¸ªé¡¹ç›®é˜¶æ®µçš„æ¦‚å¿µï¼š å¼€å‘ä¸­ï¼Œä¹ŸåŒ…å«å¼€å‘å‰æœŸï¼Œä¸€èˆ¬æ˜¯ä»£ç æœªå‘å¸ƒå¯ä»¥éšæ„æ›´æ”¹çš„é˜¶æ®µ å¼€å‘å®Œæˆï¼Œå·²å‘å¸ƒ/å°è£…å®Œæˆï¼Œæˆ–æ˜¯æ²¡æœ‰æºç ï¼Œåªèƒ½è¡¥æ•‘çš„é˜¶æ®µ ä¸åŒçš„å¼€å‘é˜¶æ®µæ‰€èƒ½é€‚ç”¨çš„è®¾è®¡æ¨¡å¼ä¹Ÿä¸åŒï¼Œåœ¨ç†è§£è®¾è®¡è€…çš„æ„å›¾æ—¶ï¼Œè¿™ä¸€ç‚¹å°¤å…¶é‡è¦ å¦å¤–ï¼Œæœ¬ç¯‡æ–‡ç« æ˜¯ç¬”è€…ä¸ªäººå¯¹ç»“æ„å‹æ¨¡å¼çš„ç†è§£ï¼Œç”±äºç»“æ„å‹æ¨¡å¼çš„æ¦‚å¿µæœ‰äº›æŠ½è±¡(ç›¸è¾ƒäºåˆ›å»ºå‹æ¨¡å¼)ï¼Œæ¯ä¸ªäººçš„ç†è§£ä¹Ÿä¸å°½ç›¸åŒï¼Œå› æ­¤ï¼Œè‹¥æ‚¨å‘ç°ç¬”è€…çš„æè¿°æœ‰ä¸å‡†ç¡®ç”šè‡³å®Œå…¨é”™è¯¯çš„åœ°æ–¹ï¼Œè¯·åˆ°è¿™é‡Œè¿›è¡Œåé¦ˆï¼Œæ„Ÿè°¢ äºŒã€ç»“æ„å‹æ¨¡å¼ï¼šäº«å…ƒæ¨¡å¼ 1ã€æ¨¡å¼å®šä¹‰ äº«å…ƒæ¨¡å¼(åˆç§°è‡é‡æ¨¡å¼)æ˜¯å¯¹è±¡æ± çš„ä¸€ç§å®ç°ï¼Œå®ƒçš„è‹±æ–‡åç§°å«åšFlyweightï¼Œä»£è¡¨è½»é‡çº§çš„æ„æ€ã€‚ äº«å…ƒæ¨¡å¼ç”¨æ¥å°½å¯èƒ½å‡å°‘å†…å­˜ä½¿ç”¨é‡ï¼Œå®ƒé€‚åˆç”¨äºå¯èƒ½å­˜åœ¨å¤§é‡é‡å¤å¯¹è±¡çš„åœºæ™¯ï¼Œæ¥ç¼“å­˜å¯å…±äº«çš„å¯¹è±¡ï¼Œè¾¾åˆ°å¯¹è±¡å…±äº«ã€é¿å…åˆ›å»ºè¿‡å¤šå¯¹è±¡çš„æ•ˆæœï¼Œè¿™æ ·ä¸€æ¥å°±å¯ä»¥æå‡æ€§èƒ½ï¼Œæ˜¯å…¸å‹çš„ä»¥ç©ºé—´æ¢æ—¶é—´çš„è®¾è®¡æ¨¡å¼ã€‚ äº«å…ƒæ¨¡å¼çš„è®¾è®¡æ€æƒ³æ¯”è¾ƒç®€å•ï¼Œå…³äºäº«å…ƒæ¨¡å¼æœ‰äº‰è®®çš„ä¸€ç‚¹æ˜¯ï¼šäº«å…ƒæ¨¡å¼æ˜¯å¦åªæ˜¯å¯¹è±¡æ± çš„ä¸€ç§å®ç°ï¼Œå¦‚æœæ˜¯ï¼Œé‚£ä¹ˆåŸæ–‡ä¸­æåˆ°çš„éœ€è¦å…³æ³¨å¯¹è±¡çš„å†…éƒ¨çŠ¶æ€å’Œå¤–éƒ¨çŠ¶æ€æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ æ¢å¥è¯è¯´ï¼Œäº«å…ƒæ¨¡å¼å’Œæ± åŒ–æŠ€æœ¯ä¹‹é—´æ˜¯å¦å¯ä»¥ç›´æ¥åˆ’ç­‰å·ï¼Ÿ è¦æ¢è®¨è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ã€Šè®¾è®¡æ¨¡å¼ã€‹ä¸€ä¹¦ä¸­å¯¹äº«å…ƒæ¨¡å¼çš„å®šä¹‰ï¼š A flyweight is a shared object that can be used in multiple contexts simultaneously. The flyweight acts as an independent object in each contextâ€”it's indistinguishable from an instance of the object that's not shared. Flyweights cannot make assumptions about the context in which they operate. The key concept here is the distinction between intrinsic and extrinsic state. Intrinsic state is stored in the flyweight; it consists of information that's independent of the flyweight's context, thereby making it sharable. Extrinsic state depends on and varies with the flyweight's context and therefore can't be shared. Client objects are responsible for passing extrinsic state to the flyweight when it needs it. â€”ã€ŠDesign Patterns: Elements of Reusable Object-Oriented Softwareã€‹ flyweightæ˜¯ä¸€ä¸ªå…±äº«å¯¹è±¡ï¼Œå®ƒå¯ä»¥åŒæ—¶åœ¨å¤šä¸ªåœºæ™¯(context)ä¸­ä½¿ç”¨ï¼Œå¹¶ä¸”åœ¨æ¯ä¸ªåœºæ™¯ä¸­flyweightéƒ½å¯ä»¥ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„å¯¹è±¡â€”è¿™ä¸€ç‚¹ä¸éå…±äº«å¯¹è±¡çš„å®ä¾‹æ²¡æœ‰åŒºåˆ«ã€‚flyweightä¸èƒ½å¯¹å®ƒæ‰€è¿è¡Œçš„åœºæ™¯åšå‡ºä»»ä½•å‡è®¾ï¼Œè¿™é‡Œçš„å…³é”®æ¦‚å¿µæ˜¯å†…éƒ¨çŠ¶æ€å’Œå¤–éƒ¨çŠ¶æ€ä¹‹é—´çš„åŒºåˆ«ã€‚å†…éƒ¨çŠ¶æ€å­˜å‚¨äºflyweightä¸­ï¼Œå®ƒåŒ…å«äº†ç‹¬ç«‹äºflyweightåœºæ™¯çš„ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯ä½¿å¾—flyweightå¯ä»¥è¢«å…±äº«ã€‚è€Œå¤–éƒ¨çŠ¶æ€å–å†³äºflyweightåœºæ™¯ï¼Œå¹¶æ ¹æ®åœºæ™¯è€Œå˜åŒ–ï¼Œå› æ­¤ä¸å¯å…±äº«ã€‚ç”¨æˆ·å¯¹è±¡è´Ÿè´£åœ¨å¿…è¦çš„æ—¶å€™å°†å¤–éƒ¨çŠ¶æ€ä¼ é€’ç»™flyweightã€‚ â€”ã€Šè®¾è®¡æ¨¡å¼ï¼šå¯å¤ç”¨é¢å‘å¯¹è±¡è½¯ä»¶çš„åŸºç¡€ã€‹æœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾ ä»è¿™æ®µè¯çš„æè¿°å¯ä»¥çœ‹å‡ºï¼Œä½œè€…å¼ºè°ƒäº«å…ƒæ¨¡å¼çš„ç‰¹ç‚¹ä¹‹ä¸€æ˜¯å¯¹è±¡çš„å†…éƒ¨çŠ¶æ€å¯å˜ã€å¤–éƒ¨çŠ¶æ€ä¸å¯å˜ä¸”ä¸å¯è¢«å…±äº«ã€‚é‚£ä¹ˆä»€ä¹ˆæ˜¯å¯¹è±¡çš„å†…éƒ¨çŠ¶æ€å’Œå¤–éƒ¨çŠ¶æ€ï¼Ÿä¸‹é¢æˆ‘ä»¬ä¸€èµ·æ¥é€šè¿‡2.2ä¸­çš„ä»£ç ç¤ºä¾‹çœ‹ä¸€çœ‹èƒ½å¦æ‰¾å‡ºç­”æ¡ˆ 2ã€ä»£ç ç¤ºä¾‹ /*å›½å®¶ç±»*/ public class Country { private String countryName;//å›½å®¶åç§° private String countryArea;//å›½åœŸé¢ç§¯ //more.. public static Country query(String country){ //é€šè¿‡keyæŸ¥è¯¢å†…å­˜/æ•°æ®åº“ç­‰ä¿å­˜çš„å›½å®¶å¯¹è±¡ } } /*ç”¨æˆ·ä¿¡æ¯ç±»*/ public class UserInfo { public Integer age;//ç”¨æˆ·å¹´é¾„ public String nickname;//æ˜µç§° public Country country;//å›½å®¶ //more.. public static UserInfo obtain(){ //å†…éƒ¨ç»´æŠ¤ä¸€ä¸ªå¯¹è±¡ç¼“å­˜æ±  } } /*æµ‹è¯•ç±»*/ public class Test { @org.junit.Test public void main() { UserInfo sanZ = UserInfo.obtain(18, &quot;å¼ ä¸‰&quot;, Country.query(&quot;ä¸­å›½&quot;)); UserInfo siL = UserInfo.obtain(18, &quot;æå››&quot;, Country.query(&quot;ä¸­å›½&quot;)); //ç§»æ°‘åˆ°æ–°åŠ å¡å…»è€ siL.country = Country.query(&quot;æ–°åŠ å¡&quot;); } } ä»£ç ç¤ºä¾‹ä¸­åªæœ‰ä¸¤ä¸ªç±»ï¼Œç”¨æˆ·ä¿¡æ¯ç±»å’Œå›½å®¶ç±»ï¼Œåœ¨ç”¨æˆ·ä¿¡æ¯ç±»çš„å†…éƒ¨çŠ¶æ€ä¸­ï¼Œæœ‰ä¸€ä¸ªcountryå±æ€§ï¼Œcountryå±æ€§å¯¹åº”çš„å›½å®¶ç±»ä¸­å†…éƒ¨ç»´æŠ¤ä¸€ç»„æ•°æ®ï¼Œä¸å…¬å¼€set()æ–¹æ³•ã€‚å½“æŸä¸€ä¸ªç”¨æˆ·æ›´æ”¹è‡ªèº«çš„countryå±æ€§æ—¶ï¼Œåªèƒ½é€šè¿‡å›½å®¶åç§°é‡æ–°æŸ¥è¯¢å›½å®¶å¯¹è±¡ï¼Œè¿™å°±æ˜¯æ‰€è°“äº«å…ƒå¯¹è±¡å†…éƒ¨å±æ€§æ›´æ”¹æ—¶ä¸å½±å“å…¶å¤–éƒ¨çŠ¶æ€çš„å«ä¹‰ï¼› æ€»ç»“ä¸€ä¸‹ï¼Œäº«å…ƒå¯¹è±¡æŒ‡çš„æ˜¯å¯ä»¥è¢«å…±äº«çš„å¯¹è±¡ï¼Œåœ¨2.2çš„ç¤ºä¾‹ä»£ç ä¸­ï¼Œç”¨æˆ·ä¿¡æ¯ç±»å°±æ˜¯äº«å…ƒå¯¹è±¡ã€‚ç”±äºäº«å…ƒå¯¹è±¡å¯ä»¥è¢«å…±äº«ï¼Œå…¶å†…éƒ¨å±æ€§(å§“åã€å¹´é¾„ã€å›½å®¶ç­‰)å¯ä»¥è¢«é‡æ–°èµ‹å€¼ï¼Œè¿™è¢«å«åšå¯¹è±¡çš„å†…éƒ¨çŠ¶æ€ï¼›å›½å®¶ç±»æ˜¯ç‹¬ç«‹çš„ä¸€ä¸ªç»„ç»‡ï¼Œä¸ç®¡ç”¨æˆ·ä¿¡æ¯ç±»ä¸­çš„countryå±æ€§å¦‚ä½•æ›´æ”¹éƒ½ä¸ä¼šå½±å“åˆ°å›½å®¶ç±»ä¸­çš„å†…éƒ¨æ•°æ®ï¼Œå›½å®¶ç±»å°±è¢«ç§°ä¸ºäº«å…ƒå¯¹è±¡ç±»çš„å¤–éƒ¨çŠ¶æ€ 3ã€æºç é”šç‚¹ åœ¨çœ‹è¿‡äº†2.2å°èŠ‚çš„ç¤ºä¾‹ä¹‹åï¼Œæˆ‘ä»¬å†å›è¿‡å¤´æ¥çœ‹çœ‹Android Messageçš„å®ç° /*ä¼ªä»£ç */ public class Message { private String val; private Message next; private static Message root; private static int size = 0; private static final int MAX_SIZE = 10; public static Message obtain() { if (root != null) { //è·å–é“¾è¡¨è¡¨å¤´çš„å¯¹è±¡ Message temp = root; root = temp.next; temp.next = null; size--; return temp; } return new Message(); } public String getVal() { return val; } public void setVal(String val) { this.val = val; } public void recycle() { //å›æ”¶å¯¹è±¡ï¼Œå°†å±æ€§å†…å®¹æ¸…ç©º this.val = null; //è‹¥ç¼“å­˜æ± è¿˜æ²¡æ»¡ï¼Œå°†è¯¥å¯¹è±¡ä¿å­˜è‡³é“¾è¡¨è¡¨å¤´ä½ç½® if (size &lt; MAX_SIZE) { next = root; root = this; size++; } } } ä»ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒMessageç”¨é“¾è¡¨å®ç°äº†ä¸ªå¤ç”¨æ± ï¼Œå›åˆ°2.1ä¸­çš„ç–‘é—®ï¼ŒAndroid Messageçš„é“¾è¡¨å¤ç”¨æ± çš„è®¾è®¡æ€æƒ³æ˜¯èƒ½è¢«ç§°ä¸ºäº«å…ƒæ¨¡å¼å—ï¼Ÿç¬”è€…è®¤ä¸ºæ˜¯å¯ä»¥çš„ï¼Œåªä¸è¿‡Messageæ²¡æœ‰å¤–éƒ¨çŠ¶æ€ç½¢äº† é™¤äº†Android Messageå¤–ï¼ŒJavaä¸­è¿˜æœ‰Stringå¸¸é‡æ± ï¼Œintï¼Œfloatç­‰åŸºç¡€ç±»å‹çš„åŒ…è£…ç±»å‹ä¹Ÿéƒ½ä½¿ç”¨äº†äº«å…ƒæ¨¡å¼ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥è‡ªè¡Œæœç´¢äº†è§£ 4ã€å°ç»“ æ€»ç»“ä¸€ä¸‹ï¼Œäº«å…ƒæ¨¡å¼çš„è®¾è®¡æ€æƒ³æ˜¯é€šè¿‡å¤ç”¨å¯¹è±¡ï¼Œä»¥è¾¾åˆ°èŠ‚çœå†…å­˜çš„ç›®çš„ï¼Œäº«å…ƒæ¨¡å¼é€‚åˆåœ¨ä»¥ä¸‹çš„åœºæ™¯ä¸­ä½¿ç”¨ï¼š ç³»ç»Ÿä¸­å­˜åœ¨å¤§é‡çš„ç›¸ä¼¼å¯¹è±¡ï¼Œå¯ä»¥æŠ½ç¦»ä¸ºå¤–éƒ¨å¯¹è±¡ï¼Œä¾‹å¦‚2.2ä¸­çš„å›½å®¶å¯¹è±¡ éœ€è¦ç¼“å†²æ± çš„åœºæ™¯ï¼Œä¾‹å¦‚Android Messageå¯¹è±¡ï¼ŒJavaåŸºæœ¬ç±»å‹çš„åŒ…è£…ç±» æœ‰äº›ä¹¦ç±/èµ„æ–™å°†äº«å…ƒæ¨¡å¼ç¿»è¯‘ä¸ºè‡é‡æ¨¡å¼ï¼Œè¿™ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œäº«å…ƒæ¨¡å¼å’Œè‡é‡æ¨¡å¼æ˜¯åŒä¸€ä¸ª æ­¤å°èŠ‚æ¶‰åŠåˆ°çš„ä»£ç åœ¨è¿™é‡Œ ä¸‰ã€ç»“æ„å‹æ¨¡å¼ï¼šä»£ç†æ¨¡å¼ 1ã€æ¨¡å¼å®šä¹‰ ä»£ç†æ¨¡å¼æ˜¯æŒ‡åœ¨ä¸æ”¹ç‰ˆåŸå§‹ç±»çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡æ–°å¢ä»£ç†ç±»çš„æ–¹å¼ï¼Œæ¥ç»™åŸå§‹ç±»åŠ å…¥æ–°çš„åŠŸèƒ½ ä»£ç†æ¨¡å¼å®ç°çš„åœºæ™¯åˆ†ä¸ºä¸¤ç§ï¼Œå¤–éƒ¨ç±»å’Œå†…éƒ¨ç±»ã€‚ å¤–éƒ¨ç±»ä¸€èˆ¬æ˜¯åœ¨åŸå§‹ç±»æ— æ³•è¿›è¡Œæ›´æ”¹çš„æƒ…å†µä½¿ç”¨ï¼Œä»¥3.2ä¸­çš„æ–¹æ³•è€—æ—¶ç»Ÿè®¡ä¸¾ä¾‹æ¥è¯´ï¼Œè¦ç»Ÿè®¡Stackæ¯ä¸ªæ–¹æ³•çš„è€—æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºStackProxyç±»ç»§æ‰¿è‡ªStackç±»ï¼Œç„¶ååœ¨StackProxyä¸­è°ƒç”¨Stackçš„æ–¹æ³•åŒæ—¶åŠ å…¥è€—æ—¶ç»Ÿè®¡çš„ä»£ç ã€‚ å†…éƒ¨ç±»æŒ‡çš„æ˜¯åŸå§‹ç±»ä»£ç å¯ä»¥æ›´æ”¹çš„æƒ…å†µï¼Œé€šå¸¸ä¼šæŠ½è±¡å‡ºç»Ÿä¸€çš„æ¥å£ï¼Œå®ç°ç±»å’Œä»£ç†ç±»éƒ½å®ç°è¯¥æ¥å£ï¼Œåœ¨ä»£ç†ç±»ä¸­æ·»åŠ é€»è¾‘ä»£ç ï¼›è¿˜æ˜¯ä»¥Stackè€—æ—¶ç»Ÿè®¡ä¸ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥æŠ½è±¡å‡ºIStackç±»ï¼Œåˆ›å»ºStackç±»å®ç°IStackæ¥å£ä»¥å®ŒæˆåŠŸèƒ½ï¼Œåˆ›å»ºStackProxyç±»åŒæ ·å®ç°IStackæ¥å£ä»¥å®Œæˆè€—æ—¶ç»Ÿè®¡é€»è¾‘ï¼› ä»£ç†æ¨¡å¼çš„åŸç†å’Œä»£ç å®ç°éƒ½ä¸éš¾æŒæ¡ï¼Œæ¥ä¸‹æ¥ä¸€èµ·æ¥çœ‹3.2ä¸­çš„ä»£ç ç¤ºä¾‹ 2ã€ä»£ç ç¤ºä¾‹ 2.1 å†…éƒ¨ç±»çš„å®ç° /*ç»Ÿä¸€æ¥å£ç±»*/ public interface IStack { void push(int val); int pop(); } /*å®ç°ç±»*/ public class Stack implements IStack { private Node root; private int size = 0; @Override public void push(int val) { root = new Node(val, root); size++; } @Override public int pop() { if (root != null) { Node temp = root; root = root.next; size--; return temp.val; } throw new EmptyStackException(); } private static final class Node { int val; Node next; public Node(int val, Node next) { this.val = val; this.next = next; } } } /*ä»£ç†ç±»*/ public class StackProxy implements IStack { private final IStack stack; public StackProxy(IStack stack) { this.stack = stack; } @Override public void push(int val) { long start = System.currentTimeMillis(); stack.push(val); System.err.println(&quot;push:&quot; + (System.currentTimeMillis() - start)); } @Override public int pop() { long start = System.currentTimeMillis(); int res = stack.pop(); System.err.println(&quot;pop:&quot; + (System.currentTimeMillis() - start)); return res; } } /*ä½¿ç”¨ç¤ºä¾‹*/ public class Test { @org.junit.Test public void main() { IStack stack = new StackProxy(new Stack()); } } éœ€æ±‚æ˜¯ç»Ÿè®¡Stackä¸­æ’å…¥å’Œå¼¹å‡ºçš„æ–¹æ³•è€—æ—¶ï¼Œå€˜è‹¥ä¸Šè¿°è§’è‰²åªæœ‰Stackä¸€ä¸ªï¼Œé‚£ä¹ˆç»Ÿè®¡è€—æ—¶å°±éœ€è¦è€¦åˆåœ¨ä¸šåŠ¡ä»£ç ä¹‹ä¸­ï¼Œè¿èƒŒäº†å•ä¸€èŒè´£åŸåˆ™ã€‚è¿™æ—¶å€™æˆ‘ä»¬å°±å¯ä»¥å¼•å…¥ä»£ç†æ¨¡å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°†Stackç±»åˆ†æˆä¸‰ä¸ªè§’è‰²(ç»Ÿä¸€æ¥å£ã€å®ç°ç±»ã€ä»£ç†ç±»)ï¼Œå°†ç»Ÿè®¡é€»è¾‘å’Œå®é™…ä¸šåŠ¡è§£è€¦ï¼Œä¿æŒå®ç°ç±»çš„èŒè´£å•ä¸€ï¼Œé€šè¿‡å®ç°æŠ½è±¡æ¥å£æ¥å®Œæˆä»£ç†å·¥ä½œçš„è¢«ç§°ä¸ºä»£ç†æ¨¡å¼çš„å†…éƒ¨ç±»å®ç° 2.2 å¤–éƒ¨ç±»çš„å®ç° /*ä»£ç†ç±»*/ public class StackProxy&lt;E&gt; extends java.util.Stack&lt;E&gt; { @Override public E push(E item) { long start = System.currentTimeMillis(); E push = super.push(item); System.err.println(&quot;push:&quot; + (System.currentTimeMillis() - start)); return push; } @Override public synchronized E pop() { long start = System.currentTimeMillis(); E pop = super.pop(); System.err.println(&quot;pop:&quot; + (System.currentTimeMillis() - start)); return pop; } } /*ä½¿ç”¨ç¤ºä¾‹*/ public class Test { @org.junit.Test public void main() { Stack&lt;Integer&gt; stack = new StackProxy&lt;&gt;(); } } æ¥ç€ä¸Šé¢è€—æ—¶ç»Ÿè®¡çš„éœ€æ±‚ï¼Œåœ¨æ­¤ç¤ºä¾‹ä¸­ï¼ŒStackç±»æ˜¯æ¥è‡ªjava.utilåŒ…ï¼Œå†…éƒ¨ä»£ç ä¸å¯ä»¥è¿›è¡Œæ›´æ”¹ã€‚è¿™ç§æƒ…å†µä¾¿åªæœ‰åˆ›å»ºStackProxyç»§æ‰¿java.util.Stackç±»ï¼Œå†å¯¹æ¯ä¸ªæ–¹æ³•éƒ½åŠ å…¥è€—æ—¶ç»Ÿè®¡çš„ä»£ç æ¥å®Œæˆéœ€æ±‚ï¼Œè¿™ç§æ–¹å¼è¢«ç§°ä¸ºä»£ç†æ¨¡å¼çš„å¤–éƒ¨ç±»å®ç° 3ã€åŠ¨æ€ä»£ç† åœ¨2.1å’Œ2.2å°èŠ‚ä¸­æˆ‘ä»¬å‘ç°ï¼Œåœ¨æ¯ä¸ªæ–¹æ³•ä¸­ï¼Œè€—æ—¶ç»Ÿè®¡çš„é€»è¾‘ä»£ç æ˜¯ç±»ä¼¼çš„ï¼Œæ ¹æ®èƒ½è‡ªåŠ¨ç»ä¸æ‰‹åŠ¨çš„å¼€å‘åŸåˆ™ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨åŠ¨æ€ä»£ç†æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè¿™ä¹Ÿæ˜¯å®é™…å¼€å‘ä¸­ç»å¸¸ä½¿ç”¨çš„ã€‚æ‰€è°“åŠ¨æ€ä»£ç†ï¼ˆDynamic Proxyï¼‰ï¼Œå°±æ˜¯æˆ‘ä»¬ä¸äº‹å…ˆä¸ºæ¯ä¸ªåŸå§‹ç±»ç¼–å†™ä»£ç†ç±»ï¼Œè€Œæ˜¯åœ¨è¿è¡Œçš„æ—¶å€™ï¼ŒåŠ¨æ€åœ°åˆ›å»ºåŸå§‹ç±»å¯¹åº”çš„ä»£ç†ç±»ï¼Œç„¶ååœ¨ç³»ç»Ÿä¸­ç”¨ä»£ç†ç±»æ›¿æ¢æ‰åŸå§‹ç±»ã€‚ å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯ Java è¯­è¨€ï¼Œå®ç°åŠ¨æ€ä»£ç†å°±æ˜¯ä»¶å¾ˆç®€å•çš„äº‹æƒ…ï¼Œå› ä¸º Java è¯­è¨€æœ¬èº«å°±å·²ç»æä¾›äº†åŠ¨æ€ä»£ç†çš„è¯­æ³•ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹å¦‚ä½•ç”¨Javaçš„åŠ¨æ€ä»£ç†æ¥å®ç°ä¸Šä¸€å°èŠ‚çš„åŠŸèƒ½ï¼š /*åŠ¨æ€ä»£ç†ç±»*/ public class StackDynamicProxy { public Object createProxy(Object proxyObject) { Class[] interfaces = proxyObject.getClass().getInterfaces(); DynamicProxyHandler handler = new DynamicProxyHandler(proxyObject); return Proxy.newProxyInstance(proxyObject.getClass().getClassLoader(), interfaces, handler); } private static class DynamicProxyHandler implements InvocationHandler { private final Object proxyObject; public DynamicProxyHandler(Object proxyObject) { this.proxyObject = proxyObject; } @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable { long start = System.currentTimeMillis(); Object result = method.invoke(proxyObject, args); System.err.println(method.getName() + &quot;:&quot; + (System.currentTimeMillis() - start)); return result; } } } /*ä½¿ç”¨ç¤ºä¾‹*/ public class Test { @org.junit.Test public void main() { StackDynamicProxy proxy = new StackDynamicProxy(); IStack stack = (IStack) proxy.createProxy(new Stack()); } } 4ã€æºç é”šç‚¹ ä»£ç†æ¨¡å¼åœ¨Androidæºç ä¸­çš„åº”ç”¨ï¼Œé™¤äº†æœ‰ç»å…¸çš„retrofitå¤–ï¼ŒAndroid Hookã€æ’ä»¶åŒ–ä¹Ÿéƒ½ä½¿ç”¨äº†ä»£ç†æ¨¡å¼ï¼Œç¬”è€…è¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹æ’ä»¶åŒ–æ˜¯å¦‚ä½•ä½¿ç”¨ä»£ç†æ¨¡å¼åšåˆ°æ›¿æ¢Activityçš„ï¼š åœ¨è°ƒç”¨context.startActivity()æ–¹æ³•å¯åŠ¨Activityæ—¶ï¼Œæœ€ç»ˆæ˜¯ç”±Instrumentationç±»è´Ÿè´£åˆ›å»ºActivityå¯¹è±¡çš„ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä»£ç†ç±»æ¥æ›¿æ¢æ‰ç³»ç»Ÿçš„Instrumentationå¯¹è±¡ï¼Œåœ¨ç›‘æ§åˆ°å¯åŠ¨çš„æ˜¯AndroidManifestä¸­å ä½Activityæ—¶ï¼Œæ›¿æ¢æˆæ’ä»¶ä¸­çš„ç›®æ ‡Activityï¼Œå¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š åˆ›å»ºInstrumentationçš„ä»£ç†ç±»InstrumentationProxy public class InstrumentationProxy extends Instrumentation { private final Instrumentation instrumentation; public InstrumentationProxy(Instrumentation instrumentation) { this.instrumentation = instrumentation; } } Hookç³»ç»Ÿçš„Instrumentation //1. è·å–è¿›ç¨‹ä¸­ActivityThreadçš„å¯¹è±¡ Class&lt;?&gt; classes = Class.forName(&quot;android.app.ActivityThread&quot;); Method activityThread = classes.getDeclaredMethod(&quot;currentActivityThread&quot;); activityThread.setAccessible(true); Object currentThread = activityThread.invoke(null); Field instrumentationField = classes.getDeclaredField(&quot;mInstrumentation&quot;); instrumentationField.setAccessible(true); Instrumentation instrumentationInfo = (Instrumentation) instrumentationField.get(currentThread); //2. åˆ›å»ºä»£ç†å¯¹è±¡ï¼Œå°†mInstrumentationå®ä¾‹ä¿å­˜åˆ°ä»£ç†å¯¹è±¡ä¸­ InstrumentationProxy proxy = new InstrumentationProxy(instrumentationInfo); //3. å°†ç³»ç»ŸmInstrumentationç¤ºä¾‹æ›¿æ¢ä¸ºä»£ç†å¯¹è±¡ instrumentationField.set(currentThread, proxy); ä»£ç†ç±»ä¸­é‡å†™execStartActivityæ–¹æ³• public ActivityResult execStartActivity(Context who, IBinder contextThread, IBinder token, Activity target, Intent intent, int requestCode, Bundle options) { //... ComponentName componentName = intent.getComponent(); String packageName = componentName.getPackageName(); String classname = componentName.getClassName(); if (classname.equals(&quot;TargetActivity&quot;)) { //åˆ¤æ–­æ˜¯å¦ä¸ºç›®æ ‡Activity intent.setClassName(who, ProxyActivity.class.getCanonicalName()); // æ›¿æ¢ä¸ºå ä½çš„Activityå¯åŠ¨ } //... } ä»£ç†ç±»ä¸­é‡å†™newActivityæ–¹æ³•ï¼Œåˆ›å»ºçœŸæ­£å¯åŠ¨çš„Activity public Activity newActivity(ClassLoader cl, String className, Intent intent) { //... String classnameIntent = intent.getStringExtra(ACTIVITY_RAW); String packageName = intent.getComponent().getPackageName(); // è·å–Intentä¸­ä¿å­˜çš„çœŸæ­£ActivityåŒ…åã€ç±»å if (className.equals(ProxyActivity.class.getCanonicalName())) { ComponentName componentName = new ComponentName(packageName, classnameIntent); // æ›¿æ¢çœŸå®Activityçš„åŒ…åå’Œç±»å intent.setComponent(componentName); className = classnameIntent; } //... } Hook Instrumentationå®ç°Activityæ’ä»¶åŒ–å¯åŠ¨å°ç»“ï¼š Hookç³»ç»Ÿçš„Instrumentationå¯¹è±¡ï¼Œè®¾ç½®åˆ›å»ºçš„ä»£ç†ç±» åœ¨ä»£ç†ç±»ä¸­ä¿®æ”¹å¯åŠ¨Activityçš„Intentï¼Œå°†å¯åŠ¨çš„ç›®æ ‡Activityæ›¿æ¢ä¸ºå ä½Activityï¼Œä»è€Œé¿å…æ³¨å†Œæ¸…å•çš„æ£€æŸ¥ åœ¨ä»£ç†ç±»ä¸­é‡å†™newActivity()å°†å¯åŠ¨çš„æ´»åŠ¨æ¢å›çœŸå®ç›®æ ‡ï¼Œç„¶åç»§ç»­æ‰§è¡ŒåŸæœ‰é€»è¾‘ Androidæä¾›çš„AIDLè·¨è¿›ç¨‹é€šä¿¡åŒæ ·ä¹Ÿç”¨åˆ°äº†ä»£ç†æ¨¡å¼ï¼ŒClientç«¯è°ƒç”¨asInterface()ä¿å­˜çš„interfaceå¯¹è±¡å…¶å®å°±æ˜¯Serverç«¯çš„ä»£ç†ï¼Œè¿™é‡Œæœ‰ç¬”è€…å®ç°çš„ä¸€ä¸ªå°Demoï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥ç‚¹å‡»æŸ¥çœ‹ 5ã€å°ç»“ æœ€åæˆ‘ä»¬å†æ¥å¤ä¹ ä¸€ä¸‹ä»£ç†æ¨¡å¼çš„å®šä¹‰ï¼šåœ¨ä¸æ”¹ç‰ˆåŸå§‹ç±»çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡æ–°å¢ä»£ç†ç±»çš„æ–¹å¼ï¼Œæ¥ç»™åŸå§‹ç±»åŠ å…¥æ–°çš„åŠŸèƒ½ å®ç°æ–¹å¼åˆ†ä¸ºå†…éƒ¨ç±»å’Œå¤–éƒ¨ç±»ï¼Œå†…éƒ¨ç±»ä½¿ç”¨æ¥å£æˆ–æŠ½è±¡ç±»ï¼Œå¤–éƒ¨ç±»ä½¿ç”¨ç»§æ‰¿å®ç° ä»£ç†æ¨¡å¼åœ¨å¹³æ—¶çš„å¼€å‘ç»å¸¸è¢«ç”¨åˆ°ï¼Œå¸¸ç”¨åœ¨ä¸šåŠ¡ç³»ç»Ÿä¸­å¼€å‘ä¸€äº›éåŠŸèƒ½æ€§éœ€æ±‚ï¼Œæ¯”å¦‚ï¼šç›‘æ§ã€ç»Ÿè®¡ã€æ—¥å¿—ã€‚æˆ‘ä»¬å°†è¿™äº›é™„åŠ åŠŸèƒ½ä¸ä¸šåŠ¡åŠŸèƒ½è§£è€¦ï¼Œæ”¾åˆ°ä»£ç†ç±»ç»Ÿä¸€å¤„ç†ï¼Œè®©å¼€å‘äººå‘˜åªéœ€è¦å…³æ³¨ä¸šåŠ¡æ–¹é¢çš„å¼€å‘ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œä»£ç†æ¨¡å¼åœ¨è·¨è¿›ç¨‹é€šä¿¡ã€æ’ä»¶åŒ–ç­‰åœºæ™¯ä¸­ä¹Ÿæœ‰ä½¿ç”¨ æ­¤å°èŠ‚æ¶‰åŠåˆ°çš„ä»£ç åœ¨è¿™é‡Œ å››ã€ç»“æ„å‹æ¨¡å¼ï¼šè£…é¥°è€…æ¨¡å¼ 1ã€æ¨¡å¼å®šä¹‰ ä»ä»£ç ç»“æ„ä¸Šæ¥çœ‹ï¼Œè£…é¥°æ¨¡å¼å’Œä»£ç†æ¨¡å¼(å†…éƒ¨ç±»å®ç°)ä¸¤è€…é—´éå¸¸ç›¸ä¼¼ï¼Œä»ç»“æ„æ¥çœ‹å®ƒä¿©ä¸èƒ½è¯´æ˜¯æ¯«æ— å…³ç³»ï¼Œåªèƒ½è¯´æ˜¯ä¸€æ¨¡ä¸€æ ·ï¼›å›é¡¾ä¸Šä¸€å°èŠ‚å¯¹ä»£ç†æ¨¡å¼çš„å®šä¹‰ï¼šä»£ç†æ¨¡å¼æ˜¯æŒ‡åœ¨ä¸æ”¹å˜åŸå§‹ç±»çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡æ–°å¢ä»£ç†ç±»çš„æ–¹å¼ï¼Œæ¥ç»™åŸå§‹ç±»åŠ å…¥æ–°çš„åŠŸèƒ½ è¿™å¥è¯åŠ¨åŠ¨ä¿©å­—å°±æ˜¯è£…é¥°æ¨¡å¼ï¼šè£…é¥°æ¨¡å¼æ˜¯æŒ‡åœ¨ä¸æ”¹å˜åŸå§‹ç±»çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡æ–°å¢è£…é¥°ç±»çš„æ–¹å¼ï¼ŒåŠ å¼ºåŸå§‹ç±»çš„å±æ€§ã€‚ è™½ç„¶è£…é¥°æ¨¡å¼å’Œä»£ç†æ¨¡å¼ç»“æ„éå¸¸ç›¸ä¼¼ï¼Œä½†é€‚ç”¨åœºæ™¯ä¸­å´å¤ªä¸ä¸€æ ·ï¼›è£…é¥°æ¨¡å¼åœ¨æ—¥å¸¸å¼€å‘ä¸­ä¸»è¦è§£å†³ç»§æ‰¿è¿‡äºå¤æ‚çš„é—®é¢˜ï¼Œé€šè¿‡ç»„åˆæ¥æ›¿ä»£ç»§æ‰¿ï¼Œä¹Ÿå°±æ˜¯è¯´è£…é¥°æ¨¡å¼æ˜¯ç»§æ‰¿å…³ç³»çš„ä¸€ç§æ›¿ä»£æ–¹æ¡ˆä¹‹ä¸€ ä¸€èˆ¬æœ‰ä¸¤ç§æ–¹å¼å¯ä»¥å®ç°ç»™ä¸€ä¸ªç±»æˆ–å¯¹è±¡å¢åŠ è¡Œä¸ºï¼š ç»§æ‰¿ï¼šç»§æ‰¿ä¸€ä¸ªç°æœ‰ç±»å¯ä»¥ä½¿å¾—å­ç±»åœ¨æ‹¥æœ‰è‡ªèº«æ–¹æ³•çš„åŒæ—¶è¿˜æ‹¥æœ‰çˆ¶ç±»çš„æ–¹æ³•ï¼Œç›¸å½“äºç»™çˆ¶ç±»å¢åŠ è¡Œä¸º å…³è”ï¼šå°†ä¸€ä¸ªç±»çš„å¯¹è±¡åµŒå…¥å¦ä¸€ä¸ªå¯¹è±¡ä¸­ï¼Œç”±å¦ä¸€ä¸ªå¯¹è±¡æ¥å†³å®šæ˜¯å¦è°ƒç”¨åµŒå…¥å¯¹è±¡çš„è¡Œä¸ºä»¥ä¾¿æ‰©å±•è‡ªå·±çš„è¡Œä¸º æ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡4.2ç¤ºä¾‹ä»£ç æ¨¡æ‹Ÿçš„åº”ç”¨åœºæ™¯æ¥è§£é‡Šä¸ºä»€ä¹ˆè¯´è£…é¥°æ¨¡å¼æ˜¯ç»§æ‰¿å…³ç³»çš„æ›¿ä»£æ–¹æ¡ˆï¼š 2ã€ä»£ç ç¤ºä¾‹ /*è¡£æœ-æ¥å£ç±»*/ public interface IClothes { int getWarmValue(); } /*è¡£æœ-å¤§è¡£ç±»*/ public class Coat implements IClothes { private final IClothes clothes; public Coat(IClothes clothes) { this.clothes = clothes; } @Override public int getWarmValue() { return clothes.getWarmValue() + 50; } } /*è¡£æœ-è£¤å­ç±»*/ public class Pants implements IClothes { private final IClothes clothes; public Pants(IClothes clothes) { this.clothes = clothes; } @Override public int getWarmValue() { return clothes.getWarmValue() + 50; } } /*è¡£æœ-è¡¬è¡«ç±»*/ public class Shirt implements IClothes { private final IClothes clothes; public Shirt(IClothes clothes) { this.clothes = clothes; } @Override public int getWarmValue() { return clothes.getWarmValue() + 30; } } /*ä½¿ç”¨ç¤ºä¾‹*/ public class Test { @Test public void main() { IClothes bob = new Bob(); //åœ¨æµ´å®¤æ´—æ¾¡ System.out.println(&quot;ä»€ä¹ˆéƒ½æ²¡ç©¿æ—¶çš„ä¿æš–å€¼ï¼š&quot; + bob.getWarmValue()); bob = new Shirt(bob); //ç©¿å¥½è¡£æœåœ¨å®¶ System.out.println(&quot;ç©¿äº†ä»¶è¡¬è¡«æ—¶çš„ä¿æš–å€¼ï¼š&quot; + bob.getWarmValue()); bob = new Pants(bob); System.out.println(&quot;åˆç©¿äº†æ¡è£¤å­æ—¶çš„ä¿æš–å€¼ï¼š&quot; + bob.getWarmValue()); //å‡ºé—¨çº¦æœ‹å‹ bob = new Coat(bob); System.out.println(&quot;åˆç©¿äº†ä»¶å¤–å¥—æ—¶çš„ä¿æš–å€¼ï¼š&quot; + bob.getWarmValue()); } private class Bob implements IClothes { @Override public int getWarmValue() { return 0; } } } æ‰“å°ç»“æœ ä»€ä¹ˆéƒ½æ²¡ç©¿æ—¶çš„ä¿æš–å€¼ï¼š0 ç©¿äº†ä»¶è¡¬è¡«æ—¶çš„ä¿æš–å€¼ï¼š30 åˆç©¿äº†æ¡è£¤å­æ—¶çš„ä¿æš–å€¼ï¼š80 åˆç©¿äº†ä»¶å¤–å¥—æ—¶çš„ä¿æš–å€¼ï¼š130 åœ¨è¯¥ç¤ºä¾‹ä¸­ï¼Œè¡¬è¡«ã€è£¤å­ã€å¤–å¥—ç­‰è¡£ç‰©åˆ†åˆ«å®ç°äº†IClothesæ¥å£ï¼Œä¸åŒçš„è¡£ç‰©ä¿æš–ç¨‹åº¦ä¹Ÿä¸ä¸€æ ·ï¼Œä¹Ÿå°±æ˜¯æ¯ä»¶è¡£æœå¢å¼ºçš„å±æ€§å€¼éƒ½ä¸ä¸€æ ·ï¼›åœ¨ä¸åŒåœºæ™¯çš„è¡£æœæ­é…ä¹Ÿä¸åŒï¼Œè‹¥æœ¬ä¾‹ä¸é€‚ç”¨è£…é¥°æ¨¡å¼è€Œæ˜¯ä½¿ç”¨ç»§æ‰¿çš„è¯ï¼Œå„ç§å„æ ·çš„æ’åˆ—ç»„åˆå¯èƒ½ä¼šèº²åˆ°çˆ†ç‚¸ï¼›ä½¿ç”¨äº†è£…é¥°æ¨¡å¼å°±åªéœ€è¦ä¸ºæ¯ä»¶è¡£æœç”Ÿæˆä¸€ä¸ªè£…é¥°ç±»å³å¯ï¼Œæ‰€ä»¥å°±å¢åŠ å¯¹è±¡åŠŸèƒ½æ¥è¯´ï¼Œè£…é¥°æ¨¡å¼æ¯”ç”Ÿæˆå­ç±»å®ç°æ›´ä¸ºçµæ´»ã€‚ 3ã€æºç é”šç‚¹ åœ¨æå®¢æ—¶é—´ï¼šè®¾è®¡æ¨¡å¼ä¹‹ç¾ä¸­ç‹äº‰è€å¸ˆæåˆ°äº†Java I/O ç±»çš„è®¾è®¡ä¸­ä½¿ç”¨äº†è£…é¥°æ¨¡å¼ï¼Œæ— å¥ˆç¬”è€…æ°´å¹³æœ‰é™ï¼Œæ— æ³•å°†ç‹äº‰è€å¸ˆçš„æ€æƒ³ä»¥è‡ªå·±çš„è¯­è¨€é‡æ–°è¡¨è¿°ï¼›ç¬”è€…å¹³æ—¶è¯»/å†™æ–‡ä»¶éƒ½æ˜¯é€šè¿‡é¡¹ç›®ä¸­å°è£…çš„å·¥å…·ç±»æ¥æ“ä½œï¼ŒJava I/Oå¦‚ä½•è®¾è®¡çš„ç¬”è€…ç¡®å®ä¸æ˜¯å¾ˆæ¸…æ¥šï¼Œå…³äºJava I/Oç±»çš„ä½¿ç”¨ä»¥åŠç”¨åˆ°å“ªäº›è®¾è®¡æ¨¡å¼ç¬”è€…ä¼šå•ç‹¬å†™ä¸€ç¯‡æ–‡ç« æ¥ä»‹ç»ï¼Œå¯¹æ­¤æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªè¡Œæœç´¢å…¶ä»–èµ„æ–™é˜…è¯» é™¤äº†Java I/Oå¤–ï¼Œè®¸å¤šæ–‡ç« æåˆ°Android Contextä¹Ÿæ˜¯è£…é¥°è€…æ¨¡å¼ï¼Œå…³äºè¿™ä¸€ç‚¹ç¬”è€…å€’æ˜¯æœ‰ä¸åŒçš„çœ‹æ³• å›¾ç‰‡æ¥æºï¼šè‡ªå·±ç”»çš„ ä»ç±»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒApplicationã€Serviceã€Activityéƒ½ç»§æ‰¿è‡ªContextWrapperï¼›è™½ç„¶ContextWrapperå’ŒContextImpléƒ½æ˜¯Contextçš„å®ç°ç±»ï¼Œä½†åœ¨ContextWrapperä¸­ï¼Œæ‰€æœ‰çš„æ–¹æ³•å…¶å®éƒ½å§”æ‰˜ç»™mBase(ä¹Ÿå°±æ˜¯ContextImpl)æ¥å®ç°ï¼›æ‰€ä»¥ï¼ŒåŸºäºç°åœ¨Contextçš„ç»“æ„ï¼Œç¬”è€…è®¤ä¸ºContextè¯´æ˜¯ä»£ç†æ¨¡å¼å¯èƒ½æ›´ä¸ºè´´åˆ‡ ä½†æ˜¯ï¼Œæˆ‘ä»¬æŠŠåœºæ™¯ç¨å¾®æ”¹åŠ¨ä¸€ä¸‹ï¼Œå‡è®¾ç°åœ¨æ–°å¢ContextImpl2è§’è‰²ï¼Œå¢åŠ çš„ç›®çš„æ˜¯ä¸ºäº†ä½¿åœ¨Applicationå’Œåœ¨Activityæ‰€èƒ½è·å–æƒé™ä¸åŒï¼ŒContextImpl2çš„æƒé™æ›´ä¸ºå¼ºå¤§ï¼Œè¿™æ ·åšå°±æ›´ç¬¦åˆè£…é¥°æ¨¡å¼çš„è®¾å®š å›¾ç‰‡æ¥æºï¼šè‡ªå·±ç”»çš„ 4ã€å°ç»“ è£…é¥°æ¨¡å¼æ¥å®ç°æ‰©å±•æ¯”ç»§æ‰¿æ›´åŠ çµæ´»ï¼Œè£…é¥°æ¨¡å¼å’Œä»£ç†æ¨¡å¼å†…éƒ¨ç±»å®ç°)æä¸ºç›¸ä¼¼ï¼Œä½†å®ƒä»¬æ‰€é€‚ç”¨çš„åœºæ™¯ä¸ä¸€æ ·ï¼›å½“çœ‹åˆ°ç±»ä¼¼çš„ä»£ç ç»“æ„æ—¶ï¼Œéœ€è¦è”ç³»ä¸Šä¸‹æ–‡æ‰èƒ½åˆ¤æ–­å‡ºè®¾è®¡è€…çš„æ„å›¾ï¼›å¦å¤–ï¼Œè£…é¥°æ¨¡å¼å’Œä»£ç†æ¨¡å¼åœ¨é¡¹ç›®ä¸­æ‰€é€‚ç”¨é˜¶æ®µä¹Ÿä¸ç›¸åŒï¼Œä»£ç†æ¨¡å¼åœ¨ä»»ä½•é˜¶æ®µéƒ½å¯ä»¥ä½¿ç”¨ï¼Œè€Œè£…é¥°æ¨¡å¼é€šå¸¸åœ¨é¡¹ç›®å‰æœŸè®¾è®¡é˜¶æ®µå°±åº”è¯¥è€ƒè™‘åˆ°ã€‚ æ­¤å°èŠ‚æ¶‰åŠåˆ°çš„ä»£ç åœ¨è¿™é‡Œ äº”ã€ç»“æ„å‹æ¨¡å¼ï¼šé€‚é…å™¨æ¨¡å¼ 1ã€æ¨¡å¼å®šä¹‰ é€‚é…å™¨æ¨¡å¼çš„å®šä¹‰æ˜¯å°†ä¸å…¼å®¹çš„æ¥å£è½¬æ¢ä¸ºå¯å…¼å®¹çš„æ¥å£ï¼Œè®©åŸæœ¬ç”±äºæ¥å£ä¸å…¼å®¹è€Œä¸èƒ½ä¸€èµ·å·¥ä½œçš„ç±»å¯ä»¥ä¸€èµ·å·¥ä½œ é€‚é…å™¨æ¨¡å¼æœ‰ä¸¤ç§å®ç°æ–¹å¼ï¼šç±»é€‚é…å™¨å’Œå¯¹è±¡é€‚é…å™¨ï¼›å…¶ä¸­ï¼Œç±»é€‚é…å™¨ä½¿ç”¨ç»§æ‰¿å…³ç³»æ¥å®ç°ï¼Œå¯¹è±¡é€‚é…å™¨ä½¿ç”¨ç»„åˆå…³ç³»æ¥å®ç°ï¼Œä¸¤è€…çš„åŒºåˆ«å¯ä»¥åœ¨è¿™é‡ŒæŸ¥çœ‹ åœ¨å®é™…å¼€å‘ä¸­ï¼Œé€‚é…å™¨æ¨¡å¼å¾€å¾€å……å½“é—ç•™é—®é¢˜çš„å®ç°è½¬æ¢å™¨ï¼Œé€šå¸¸åœ¨é¡¹ç›®åæœŸä»£ç æ›´æ”¹ä»£ä»·å¾ˆé«˜ï¼Œæˆ–è€…æŸä¸ªåŠŸèƒ½ä¾èµ–ç¬¬ä¸‰æ–¹æ¥å®ç°çš„æƒ…å†µä¸‹ä½¿ç”¨ï¼Œä¸¾ä¸ªæ —å­ï¼š å‡è®¾æˆ‘ä»¬åœ¨ä¸€ä¸ªAndroidé¡¹ç›®ä¸­é›†æˆäº†é˜¿é‡Œæ”¯ä»˜SDKï¼Œåœ¨è°ƒç”¨ç™»å½•æ–¹æ³•æ—¶éœ€è¦ä¼ å…¥é«˜å¾·åœ°å›¾æä¾›çš„ä½ç½®ä¿¡æ¯ï¼Œä½†æ˜¯æ—©æœŸé¡¹ç›®ä¸­å·²ç»æ¥å…¥è…¾è®¯åœ°å›¾ï¼Œè…¾è®¯åœ°å›¾èƒ½å¤Ÿæä¾›é˜¿é‡Œæ”¯ä»˜æ‰€éœ€çš„ä½ç½®ä¿¡æ¯ï¼Œåªæ˜¯å…¥å‚ç±»å‹ä¸åŒæ¥å£ä¸å…¼å®¹ã€‚è¿™ç§åœºæ™¯æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨é€‚é…å™¨æ¨¡å¼ï¼Œå®šä¹‰ä¸€ä¸ªåŒ…è£…ç±»ï¼ŒæŠŠè…¾è®¯åœ°å›¾æä¾›çš„ä½ç½®ä¿¡æ¯è½¬æ¢æˆé˜¿é‡Œæ”¯ä»˜éœ€è¦çš„ç±»å‹ï¼Œè¿™ä¸ªåŒ…è£…ç±»æŒ‡çš„å°±æ˜¯é€‚é…å™¨(Adapter) 2ã€ä»£ç ç¤ºä¾‹ /*é˜¿é‡Œæ”¯ä»˜SDK*/ public class AliPay { /*ç™»å½•æ–¹æ³•éœ€è¦ä¼ å…¥ä½ç½®ä¿¡æ¯*/ public boolean login(String id, String pwd, IAMap.AMapParams location) { return res; } /*é«˜å¾·åœ°å›¾æ¥å£*/ public interface IAMap { AMapParams getAMapParams(); class AMapParams { public float aMapLongitude;//ç»åº¦ public float aMapLatitude;//çº¬åº¦ } } } /*è…¾è®¯åœ°å›¾SDK*/ public class TencentMap { private final TencentMapParams params; public TencentMap() { params = new TencentMapParams(); params.tencentMapLongitude = new Random().nextFloat(); params.tencentMapLatitude = new Random().nextFloat(); } /*æä¾›è…¾è®¯åœ°å›¾çš„ä½ç½®ä¿¡æ¯*/ public TencentMapParams getTencentMapParams() { return params; } public static class TencentMapParams { public float tencentMapLongitude;//ç»åº¦ public float tencentMapLatitude;//çº¬åº¦ } } /*é€‚é…å™¨ï¼Œä½¿ç”¨ç»§æ‰¿å®ç°ï¼Œä¹Ÿå¯ä»¥æ”¹ä¸ºä½¿ç”¨å¯¹è±¡å®ç°*/ public class Adapter extends TencentMap implements IAMap { @Override public AMapParams getAMapParams() { //å°†è…¾è®¯åœ°å›¾æä¾›çš„ä½ç½®ä¿¡æ¯è½¬ä¸ºé«˜å¾·çš„ä½ç½®ä¿¡æ¯ AMapParams aMapParams = new AMapParams(); TencentMapParams tencentMapParams = this.getTencentMapParams(); aMapParams.aMapLongitude = tencentMapParams.tencentMapLongitude; aMapParams.aMapLatitude = tencentMapParams.tencentMapLatitude; return aMapParams; } } /*ä½¿ç”¨ç¤ºä¾‹*/ public class Test { @Test public void main() { Adapter adapter = new Adapter(); AliPay aliPay = new AliPay(); aliPay.login(&quot;admin&quot;, &quot;admin&quot;, adapter.getAMapParams()); } } ä»£ç ç¤ºä¾‹ä¸­æœ‰ä¸‰ä¸ªè§’è‰²ï¼Œé˜¿é‡Œæ”¯ä»˜SDKã€è…¾è®¯åœ°å›¾SDKã€é€‚é…å™¨Adapterï¼Œå…¶ä¸­é€‚é…å™¨çš„ä½œç”¨å°±æ˜¯å°†è…¾è®¯åœ°å›¾æä¾›çš„ä½ç½®ä¿¡æ¯è½¬æ¢æˆé˜¿é‡Œæ”¯ä»˜æƒ³è¦åŸºäºçš„é«˜å¾·åœ°å›¾æ¥å£çš„ä½ç½®ä¿¡æ¯ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„ä¸å…¼å®¹çš„æ¥å£è½¬æ¢ä¸ºå¯å…¼å®¹çš„æ¥å£ 3ã€æºç é”šç‚¹ åœ¨Androidé¢†åŸŸçš„å¤§å¤šæ•°åšå®¢ä¸­ï¼Œæ€»æ˜¯ä»¥RecyclerView.Adapterä¸ºä¾‹æ¥è®²è§£é€‚é…å™¨æ¨¡å¼ï¼Œè¿™ä¸€ç‚¹ç¬”è€…è®¤ä¸ºå¯èƒ½ä¸æ˜¯å¾ˆæ°å½“ï¼Œåœ¨æŸ¥çœ‹äº†éƒ¨åˆ†RecyclerViewæºç å’Œè®²è§£è®¾è®¡æ¨¡å¼çš„ä¹¦ç±ä¹‹åï¼Œç¬”è€…è®¤ä¸ºRecyclerViewçš„Adapterè™½ç„¶åå­—å«é€‚é…å™¨ï¼Œä½†å®ƒå®Œæˆçš„å·¥ä½œè¯´æ˜¯æ¡¥æ¥æ¨¡å¼å¯èƒ½æ›´é€‚åˆä¸€äº› å…³äºé€‚é…å™¨æ¨¡å¼çš„æºç ç¤ºä¾‹ç¬”è€…æš‚æ—¶æ²¡æœ‰æ‰¾åˆ°ï¼Œè‹¥æ‚¨å‘ç°é€‚é…å™¨æ¨¡å¼çš„æºç åº”ç”¨ï¼Œè¯·åˆ°è¿™é‡Œå‘Šè¯‰æˆ‘ï¼Œæ„Ÿè°¢ 4ã€å°ç»“ æ€»ç»“ä¸€ä¸‹ï¼Œé€‚é…å™¨æ¨¡å¼å¯ä»¥ç®€å•ç†è§£æˆè½¬æ¢å™¨ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹æ˜¯ä½œä¸ºä¸€ç§è¡¥å¿æœºåˆ¶ï¼Œç”¨æ¥è¡¥æ•‘è®¾è®¡ä¸Šçš„ç¼ºé™·ï¼Œæˆ–è€…åƒ5.2ä»£ç ç¤ºä¾‹ä¸­æºç æ— æ³•æ›´æ”¹çš„æƒ…å†µï¼›ä½¿ç”¨è¿™ç§æ¨¡å¼ç®—æ˜¯â€œæ— å¥ˆä¹‹ä¸¾â€ï¼Œå¦‚æœåœ¨è®¾è®¡åˆæœŸï¼Œæˆ‘ä»¬å°±èƒ½åè°ƒè§„é¿æ‰æ¥å£ä¸å…¼å®¹çš„é—®é¢˜ï¼Œé‚£è¿™ç§æ¨¡å¼å°±æ²¡æœ‰åº”ç”¨çš„æœºä¼šäº† æ­¤å°èŠ‚æ¶‰åŠåˆ°çš„ä»£ç åœ¨è¿™é‡Œ å…­ã€ç»“æ„å‹æ¨¡å¼ï¼šæ¡¥æ¥æ¨¡å¼ 1ã€æ¨¡å¼å®šä¹‰ æ¡¥æ¥æ¨¡å¼çš„å®šä¹‰æ¯”è¾ƒç®€å•ï¼šå°†æŠ½è±¡éƒ¨åˆ†ä¸å®ƒçš„å®ç°éƒ¨åˆ†åˆ†ç¦»ï¼Œä½¿å®ƒä»¬éƒ½å¯ä»¥ç‹¬ç«‹åœ°å˜åŒ–ã€‚ ç”±äºæ¡¥æ¥æ¨¡å¼çš„å®šä¹‰æ¯”è¾ƒç®€çŸ­ï¼Œæ‰€ä»¥ç½‘ä¸Šå…³äºæ¡¥æ¥æ¨¡å¼çš„äº‰è®®æ¯”è¾ƒå¤šï¼Œä¸ç®¡æ˜¯åœ¨ä¸­æ–‡ç½‘ç«™è¿˜æ˜¯è‹±æ–‡ç½‘ç«™ï¼›å­˜åœ¨äº‰è®®çš„åœ°æ–¹åœ¨äºï¼Œæ¡¥æ¥æ¨¡å¼æ˜¯GoFå®šä¹‰çš„çš„å°†å®ç°ä¸æŠ½è±¡åˆ†ç¦»ï¼Œè¿˜æ˜¯ä¸€ä¸ªç±»å­˜åœ¨ä¸¤ä¸ª(æˆ–å¤šä¸ª)ç‹¬ç«‹å˜åŒ–çš„ç»´åº¦ï¼Œå¯ä»¥é€šè¿‡ç»„åˆçš„æ–¹å¼ï¼Œè®©è¿™ä¸¤ä¸ª(æˆ–å¤šä¸ª)ç»´åº¦å¯ä»¥ç‹¬ç«‹è¿›è¡Œæ‰©å±•ï¼›è‹¥æ˜¯åè€…ï¼Œé‚£ä¹ˆå®ƒå’Œç­–ç•¥æ¨¡å¼çš„åŒºåˆ«æ˜¯ä»€ä¹ˆ ç›®å‰å…³äºæ¡¥æ¥æ¨¡å¼è¿˜æ²¡æœ‰å®šè®ºï¼Œæ‰€ä»¥æœ¬ç¯‡æ–‡ç« æ ¹æ®GoFçš„åŸæ–‡å®šä¹‰æ¥å±•å¼€ã€‚ç¬”è€…ä¸ªäººä¼šå°†æ¡¥æ¥æ¨¡å¼ç­‰åŒäºä¾èµ–å€’ç½®åŸåˆ™çš„å®ç°ï¼ŒåŒ…æ‹¬ä¸Šæ–‡æåˆ°çš„æ¡¥æ¥æ¨¡å¼ä»¥åŠæ¥ä¸‹æ¥çš„ä»£ç ç¤ºä¾‹éƒ½åŸºäºæ­¤ï¼Œè‹¥å’Œæ‚¨ç†è§£çš„æœ‰åå·®ï¼Œå¯ä»¥è·³è¿‡æ­¤ç« èŠ‚ 2ã€ä»£ç ç¤ºä¾‹ public interface IImageLoader { void loadUrlIntoImageView(ImageView view, String url); } public class ImageLoader implements IImageLoader { @Override public void loadUrlIntoImageView(ImageView view, String url) { //do something.. } } ä¸Šé¢çš„ä¾‹å­æ¯”è¾ƒç®€å•ï¼Œä½†å¤§å¤šæ•°æ¡¥æ¥æ¨¡å¼çš„å®ç°ä¹Ÿéƒ½æ˜¯åœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œæ‰©å±•ï¼Œå¢åŠ æ›´å¤šçš„ç±»å’Œæ›´å¤šçš„æ–¹æ³• 3ã€å°ç»“ æ¡¥æ¥æ¨¡å¼åœ¨å®é™…å¼€å‘ä¸­ä½¿ç”¨çš„æ¯”è¾ƒå¤šï¼Œå¤šæ•°Androidé¡¹ç›®éƒ½ä¼šä½¿ç”¨æ¡¥æ¥æ¨¡å¼æ¥éš”ç¦»ç¬¬ä¸‰æ–¹åº“ï¼Œä»¥å›¾ç‰‡åŠ è½½æ¡†æ¶ä¸¾ä¾‹ï¼Œå…¶ä¸­ï¼Œå®šä¹‰å±æ€§è¡Œä¸ºçš„æŠ½è±¡å±‚æ”¾åœ¨Baseæ¨¡å—ï¼Œè€Œå®ç°æ–¹ä¸€èˆ¬æ”¾åœ¨Businessæˆ–APPå±‚ æ­¤å°èŠ‚å­˜åœ¨äº‰è®®ï¼Œç¬”è€…å¦æä¾›å…¶ä»–çš„èµ„æ–™ä¾›æ‚¨å‚è€ƒï¼šæ¡¥æ¥æ¨¡å¼ã€æ¡¥æ¥æ¨¡å¼2ã€Bridge Patternã€Bridge Design Pattern in Java ä¸ƒã€ç»“æ„å‹æ¨¡å¼ï¼šå¤–è§‚æ¨¡å¼ 1ã€æ¨¡å¼å®šä¹‰ å¤–è§‚æ¨¡å¼æ˜¯æŒ‡ç»™ä¸€ä¸ªå¤æ‚çš„ç³»ç»Ÿæä¾›ä¸€ä¸ªç»Ÿä¸€çš„å¤–è§‚(æ¥å£)ï¼Œæ–¹ä¾¿è°ƒç”¨è€…ä½¿ç”¨ï¼Œä¸ä¼šæ”¹å˜ä»»ä½•æ¥å£ ä»¥å•†å“ä¸‹å•ä¸ºä¾‹ï¼Œå½“æœåŠ¡ç«¯æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„ä¸‹å•è¯·æ±‚æ—¶ï¼Œéœ€è¦æ£€æŸ¥ç”¨æˆ·èº«ä»½ï¼Œå•†å“åº“å­˜ã€ä»·æ ¼ã€é‚®è´¹ã€ä¼˜æƒ åˆ¸ç­‰ä¿¡æ¯ï¼Œå¤–è§‚æ¨¡å¼ä»å¾ˆå¤§ç¨‹åº¦ä¸Šæé«˜äº†å®¢æˆ·ç«¯ä½¿ç”¨çš„ä¾¿æ·æ€§ï¼Œä½¿å¾—å®¢æˆ·ç«¯æ— é¡»å…³å¿ƒå­ç³»ç»Ÿçš„å·¥ä½œç»†èŠ‚ï¼Œé€šè¿‡å¤–è§‚è§’è‰²å³å¯è°ƒç”¨ç›¸å…³åŠŸèƒ½ ä»å¤–è§‚æ¨¡å¼çš„èŒèƒ½æ¥çœ‹ï¼Œç¬”è€…è®¤ä¸ºå¯èƒ½å«åšå°è£…æ¨¡å¼æ›´åˆé€‚ï¼Œå› ä¸ºå¤–è§‚æ¨¡å¼è²Œä¼¼ä¹Ÿåªè§£å†³äº†å¯¹å¤–å…¬å¼€æ–¹æ³•å±æ€§çš„é—®é¢˜ï¼Œç”šè‡³éƒ½ä¸èƒ½è¢«ç§°ä¸ºè®¾è®¡æ¨¡å¼ å…«ã€æ€»ç»“ æœ¬æ–‡ä»‹ç»äº†7å¤§ç»“æ„å‹æ¨¡å¼ä¸­çš„6ç§æ¨¡å¼ï¼Œå…¶ä¸­ï¼Œé™¤äº†äº«å…ƒæ¨¡å¼å’Œå¤–è§‚æ¨¡å¼ç›¸å¯¹ç‹¬ç«‹ä¹‹å¤–ï¼Œå…¶ä»–4ç§è®¾è®¡æ¨¡å¼ï¼šä»£ç†ã€è£…é¥°è€…ã€é€‚é…å™¨ã€æ¡¥æ¥ï¼Œå®ƒä»¬ä¹‹é—´çš„ä»£ç ç»“æ„éå¸¸ç›¸ä¼¼ã€‚ç¬¼ç»Ÿæ¥è¯´ï¼Œå®ƒä»¬éƒ½å¯ä»¥ç§°ä¸ºWrapperæ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡Wrapperç±»äºŒæ¬¡å°è£…åŸå§‹ç±»ã€‚ å°½ç®¡ä»£ç ç»“æ„ç›¸ä¼¼ï¼Œä½†è¿™4ç§è®¾è®¡æ¨¡å¼çš„ç”¨æ„å®Œå…¨ä¸åŒï¼Œä¹Ÿå°±æ˜¯è¯´è¦è§£å†³çš„é—®é¢˜ã€åº”ç”¨åœºæ™¯ã€é€‚ç”¨çš„é¡¹ç›®é˜¶æ®µä¸åŒï¼Œè¿™ä¹Ÿæ˜¯å®ƒä»¬çš„ä¸»è¦åŒºåˆ« ä»£ç†æ¨¡å¼ï¼šä»£ç†æ¨¡å¼åœ¨ä¸æ”¹å˜åŸå§‹ç±»æ¥å£çš„æ¡ä»¶ä¸‹ï¼Œä¸ºåŸå§‹ç±»å®šä¹‰ä¸€ä¸ªä»£ç†ç±»ï¼Œä¸»è¦ç›®çš„æ˜¯æ§åˆ¶è®¿é—®ï¼Œè€ŒéåŠ å¼ºåŠŸèƒ½ï¼Œè¿™æ˜¯å®ƒè·Ÿè£…é¥°å™¨æ¨¡å¼æœ€å¤§çš„ä¸åŒã€‚ è£…é¥°å™¨æ¨¡å¼ï¼šè£…é¥°è€…æ¨¡å¼åŒæ ·åœ¨ä¸æ”¹å˜åŸå§‹ç±»æ¥å£çš„æƒ…å†µä¸‹ï¼Œå¯¹åŸå§‹ç±»åŠŸèƒ½è¿›è¡Œå¢å¼ºï¼Œå¹¶ä¸”æ”¯æŒå¤šä¸ªè£…é¥°å™¨çš„åµŒå¥—ä½¿ç”¨ã€‚ é€‚é…å™¨æ¨¡å¼ï¼šé€‚é…å™¨æ¨¡å¼æ˜¯ä¸€ç§äº‹åçš„è¡¥æ•‘ç­–ç•¥ã€‚é€‚é…å™¨æä¾›è·ŸåŸå§‹ç±»ä¸åŒçš„æ¥å£ï¼Œè€Œä»£ç†æ¨¡å¼ã€è£…é¥°å™¨æ¨¡å¼æä¾›çš„éƒ½æ˜¯è·ŸåŸå§‹ç±»ç›¸åŒçš„æ¥å£ã€‚ æ¡¥æ¥æ¨¡å¼ï¼šæ¡¥æ¥æ¨¡å¼çš„ç›®çš„æ˜¯å°†æ¥å£éƒ¨åˆ†å’Œå®ç°éƒ¨åˆ†åˆ†ç¦»ï¼Œä»è€Œè®©å®ƒä»¬å¯ä»¥è¾ƒä¸ºå®¹æ˜“ã€ä¹Ÿç›¸å¯¹ç‹¬ç«‹åœ°åŠ ä»¥æ”¹å˜ã€‚ åŒºåˆ«ç»“è®ºæ¥æºï¼šæå®¢æ—¶é—´ï¼šè®¾è®¡æ¨¡å¼ä¹‹ç¾-ç‹äº‰ Stack Overflowæœ‰å…³äºä»£ç†ã€é€‚é…ã€é€‚é…å™¨ã€æ¡¥æ¥è¿™4ç§æ¨¡å¼æœ‰ä»€ä¹ˆä¸åŒçš„è®¨è®ºè¯é¢˜ï¼Œå¯ä»¥ç‚¹å‡»ä¸‹é¢çš„é“¾æ¥è¿›è¡ŒæŸ¥çœ‹ https://stackoverflow.com/questions/350404/how-do-the-proxy-decorator-adapter-and-bridge-patterns-differ/350471#350471 ç»„åˆæ¨¡å¼ä¸åŒ…å«åœ¨æœ¬æ–‡ä¸­ï¼Œæƒ³è¦äº†è§£æ›´å¤šçš„å¯ä»¥ç‚¹å‡»è¿™é‡Œ å…¨æ–‡å®Œ å†æ¬¡è¯´æ˜ï¼šä»¥ä¸Šæ˜¯ç¬”è€…ä¸ªäººå¯¹ç»“æ„å‹æ¨¡å¼çš„ç†è§£ï¼Œç”±äºç»“æ„å‹æ¨¡å¼çš„æ¦‚å¿µæœ‰äº›æŠ½è±¡(ç›¸è¾ƒäºåˆ›å»ºå‹æ¨¡å¼)ï¼Œæ¯ä¸ªäººçš„ç†è§£ä¹Ÿä¸å°½ç›¸åŒ è‹¥æ‚¨å‘ç°ç¬”è€…çš„æè¿°æœ‰ä¸å‡†ç¡®ç”šè‡³å®Œå…¨é”™è¯¯çš„åœ°æ–¹ï¼Œè¯·åˆ°è¿™é‡Œè¿›è¡Œåé¦ˆï¼Œæ„Ÿè°¢ ä¹ã€å‚è€ƒèµ„æ–™ å›¾è¯´è®¾è®¡æ¨¡å¼ refactoringguru.cn æå®¢æ—¶é—´ï¼šè®¾è®¡æ¨¡å¼ä¹‹ç¾-ç‹äº‰ ã€Šè®¾è®¡æ¨¡å¼ï¼šå¯å¤ç”¨é¢å‘å¯¹è±¡è½¯ä»¶çš„åŸºç¡€ã€‹ ã€ŠAndroid æºç è®¾è®¡æ¨¡å¼è§£æä¸å®æˆ˜ã€‹-ä½•çº¢è¾‰ / å…³çˆ±æ°‘ ã€Šæ·±å…¥æµ…å‡ºè®¾è®¡æ¨¡å¼-LeetCodeã€‹ ã€ŠHead First è®¾è®¡æ¨¡å¼ã€‹ Androidæ’ä»¶åŒ–â€”é«˜æ‰‹å¿…å¤‡çš„HookæŠ€æœ¯ ","link":"https://yibaoshan.github.io/post/design-pattern-structural/"},{"title":"æ¼«è°ˆè®¾è®¡æ¨¡å¼ï¼ˆä¸€ï¼‰ï¼šåˆ›å»ºå‹æ¨¡å¼","content":" ç‚¹å‡»è·³è½¬åˆ°æ˜é‡‘é˜…è¯» ä¸€ã€å‰è¨€ åˆ›å»ºå‹æ¨¡å¼å¯¹ç±»çš„å®ä¾‹åŒ–è¿‡ç¨‹è¿›è¡Œäº†æŠ½è±¡ï¼Œèƒ½å¤Ÿå°†è½¯ä»¶æ¨¡å—ä¸­å¯¹è±¡çš„åˆ›å»ºå’Œå¯¹è±¡çš„ä½¿ç”¨åˆ†ç¦»ã€‚ ä¸ºäº†ä½¿è½¯ä»¶çš„ç»“æ„æ›´åŠ æ¸…æ™°ï¼Œå¤–ç•Œå¯¹äºè¿™äº›å¯¹è±¡åªéœ€è¦çŸ¥é“å®ƒä»¬å…±åŒçš„æ¥å£ï¼Œè€Œä¸æ¸…æ¥šå…¶å…·ä½“çš„å®ç°ç»†èŠ‚ï¼Œä½¿æ•´ä¸ªç³»ç»Ÿçš„è®¾è®¡æ›´åŠ ç¬¦åˆå•ä¸€èŒè´£åŸåˆ™ã€‚ ç®€å•æ¥è®²ï¼Œç›¸è¾ƒäºå¦å¤–ä¸¤ç§ç±»å‹(ç»“æ„å‹å’Œè¡Œä¸ºå‹)ï¼Œåˆ›å»ºå‹æ¨¡å¼çš„ä¾§é‡ç‚¹åœ¨äºå¦‚ä½•åˆ›å»ºå¯¹è±¡ æœ¬æ–‡ä¼šç®€å•ä»‹ç»å‡ ç§å¸¸è§çš„åˆ›å»ºå‹æ¨¡å¼ï¼š å•ä¾‹æ¨¡å¼ å·¥å‚æ¨¡å¼ å»ºé€ è€…æ¨¡å¼ æ³¨æ„ï¼ŒåŸå‹æ¨¡å¼ä¸åŒ…å«åœ¨æœ¬æ–‡ä¸­ï¼Œæƒ³è¦äº†è§£æ›´å¤šçš„å¯ä»¥è‡ªè¡Œå†²æµªæœç´¢ äºŒã€åˆ›å»ºå‹æ¨¡å¼ï¼šå•ä¾‹æ¨¡å¼ 1ã€æ¨¡å¼å®šä¹‰ å•ä¾‹æ¨¡å¼çš„ç›®çš„æ˜¯ä¿è¯ä¸€ä¸ªç±»ä»…æœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶æä¾›ä¸€ä¸ªè®¿é—®å®ƒçš„å…¨å±€è®¿é—®ç‚¹ã€‚ å•ä¾‹ç±»æ‹¥æœ‰ä¸€ä¸ªç§æœ‰æ„é€ å‡½æ•°ï¼Œç¡®ä¿ç”¨æˆ·æ— æ³•é€šè¿‡newå…³é”®å­—ç›´æ¥å®ä¾‹åŒ–å®ƒã€‚ é™¤æ­¤ä¹‹å¤–ï¼Œè¯¥æ¨¡å¼ä¸­åŒ…å«ä¸€ä¸ªé™æ€ç§æœ‰æˆå‘˜å˜é‡ä¸é™æ€å…¬æœ‰çš„å·¥å‚æ–¹æ³•ã€‚ è¯¥å·¥å‚æ–¹æ³•è´Ÿè´£æ£€éªŒå®ä¾‹çš„å­˜åœ¨æ€§å¹¶å®ä¾‹åŒ–è‡ªå·±ï¼Œç„¶åå­˜å‚¨åœ¨é™æ€æˆå‘˜å˜é‡ä¸­ï¼Œä»¥ç¡®ä¿åªæœ‰ä¸€ä¸ªå®ä¾‹è¢«åˆ›å»ºã€‚ å›¾ç‰‡æ¥æºï¼šè‡ªå·±ç”»çš„ 2ã€ä½¿ç”¨æ–¹æ³• å•ä¾‹ä½¿ç”¨æ–¹æ³•ç®€å•ï¼Œç†è§£èµ·æ¥ä¹Ÿæ¯”è¾ƒå®¹æ˜“ï¼Œç¬”è€…è¿™é‡Œå°±ç›´æ¥å¼€é—¨è§å±±ï¼Œä»‹ç»å››ç§å¸¸è§çš„ä½¿ç”¨æ–¹å¼ 2.1 é¥¿æ±‰å¼ public class Singleton1 { private static final Singleton1 instance = new Singleton1(); public Singleton1() { } public static Singleton1 getInstance() { return instance; } public void doSomething() { //doSomething } } é¥¿æ±‰å¼æ˜¯å¸¸è§ä½¿ç”¨æ–¹æ³•ä¸­æœ€ç®€å•çš„ä¸€ç§ï¼ŒJVMç±»åŠ è½½æœºåˆ¶å¾—ä»¥ä¿è¯ç±»åŠ è½½è¿‡ç¨‹ä¸­æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä½¿ç”¨ä¹Ÿæ˜¯æ²¡é—®é¢˜çš„ é¥¿æ±‰å¼å•ä¾‹æ¨¡å¼å”¯ä¸€çš„é—®é¢˜å¯èƒ½å°±æ˜¯ï¼šå¹¶éæ‡’åŠ è½½ï¼Œåªè¦å•ä¾‹ç±»è¢«è™šæ‹ŸæœºåŠ è½½ï¼Œå°±å¿…ç„¶ä¼šåˆ›å»ºinstanceå®ä¾‹ã€‚æ­¤æ—¶ï¼Œè‹¥æ˜¯è¢«æå‰åˆå§‹åŒ–çš„ç¤ºä¾‹å·¥ç¨‹ä¸­ç”¨ä¸åˆ°ï¼Œé‚£çš„ç¡®æ˜¯ç™½ç™½æ¶ˆè€—äº†åˆå§‹åŒ–çš„æ—¶é—´å’Œå†…å­˜ç©ºé—´ ä¸è¿‡è€ƒè™‘åˆ°å•ä¾‹æ¨¡å¼çš„ä½¿ç”¨åœºæ™¯ï¼Œç¬”è€…è®¤ä¸ºå¤§å¤šæ•°æƒ…å†µä¸‹ä½¿ç”¨é¥¿æ±‰å¼å¹¶ä¸ä¼šç»™é¡¹ç›®å¸¦æ¥å¤šä½™çš„è´Ÿæ‹…ã€‚ 2.2 æ‡’æ±‰å¼ï¼šé™æ€å†…éƒ¨ç±» public class Singleton2 { private Singleton2() { } public static Singleton2 getInstance() { return SingletonHolder.instance; } private static class SingletonHolder { private static final Singleton2 instance = new Singleton2(); } public void doSomething() { //doSomething } } å’Œ2.1çš„ä»£ç ç¤ºä¾‹ç›¸åŒï¼Œé™æ€å†…éƒ¨ç±»åŒæ ·ç”±JVMç±»åŠ è½½æœºåˆ¶ä¿è¯äº†å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„å®‰å…¨æ€§ï¼›åŒæ—¶ï¼Œç”±äºæ²¡æœ‰åœ¨å±€éƒ¨å˜é‡ä¸­å£°æ˜ï¼Œæ‰€ä»¥å°±ç®—å› ä¸ºéä¸»è§‚å› ç´ å¯¼è‡´å•ä¾‹ç±»è¢«è™šæ‹ŸæœºåŠ è½½ï¼Œä¹Ÿæ— éœ€æ‹…å¿ƒåˆ›å»ºäº†æš‚æ—¶ç”¨ä¸åˆ°çš„å¯¹è±¡å¯¼è‡´å ç”¨å†…å­˜ã€‚ é™æ€å†…éƒ¨ç±»çš„å•ä¾‹æ¨¡å¼æ—¢èƒ½ä¿è¯å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„å®‰å…¨åˆå®ç°äº†æ‡’åŠ è½½ï¼Œä»£ç å†™èµ·æ¥æ¯”è¾ƒæ–¹ä¾¿ï¼Œè¿™ä¹Ÿæ˜¯ç¬”è€…ä¸ªäººæ¯”è¾ƒå–œæ¬¢ç”¨çš„ä¸€ç§æ–¹å¼ 2.3 æ‡’æ±‰å¼ï¼šåŒé‡æ ¡éªŒé”DCL public class Singleton3 { private volatile static Singleton3 instance; private Singleton3() { } public static Singleton3 getInstance() { if (instance == null) { synchronized (Singleton3.class) { if (instance == null) { instance = new Singleton3(); } } } return instance; } public void doSomething() { //doSomething } } DCL(DoubleCheckLock)åŒé‡æ ¡éªŒé”å¯èƒ½æ˜¯æ‰€æœ‰å•ä¾‹æ¨¡å¼ä¸­ä¼ æ’­æœ€å¹¿çš„æ–¹å¼äº†ï¼Œè¿™ä¹Ÿæ˜¯ç¬”è€…åœ¨å·¥ä½œæ—©æœŸæ¥è§¦æœ€å¤šçš„å•ä¾‹æ¨¡å¼ï¼›DCLåŒé‡æ£€éªŒé”çš„æ–¹å¼æŠŠçº¿ç¨‹å®‰å…¨å’Œæ‡’åŠ è½½éƒ½è€ƒè™‘åˆ°äº†ï¼Œå¹¶ä¸”æ¶‰åŠåˆ°Javaå¹¶å‘ç¼–ç¨‹ä¸­ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„å…³é”®å­—ï¼švolatileå’Œsynchronizedï¼Œç›¸è¾ƒäºä¸Šé¢çš„ä¸¤ç§ç¤ºä¾‹ï¼ŒDCLå¯ä»¥æ‹å‡ºæ¥çš„ç‚¹æ¯”è¾ƒå¤šï¼Œç¬”è€…çŒœæµ‹å¯èƒ½è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆDCLä¼ æ’­è¿™ä¹ˆå¹¿çš„åŸå›  åœ¨å®é™…çš„é¡¹ç›®å¼€å‘ä¸­å¦‚æœä¸è§‰å¾—ä½¿ç”¨æ­¥éª¤è¾ƒä¸ºç¹çï¼Œä»£ç é‡å¯ä»¥æ¥å—çš„è¯ï¼ŒDCLä¹Ÿæ˜¯æ¯”è¾ƒæ¨èçš„ä¸€ç§ä½¿ç”¨æ–¹å¼ æ³¨ï¼šå…³äºDCLåŒé‡æ ¡éªŒé”è¦ä¸è¦åŠ volatileå…³é”®å­—å–å†³äºJavaç‰ˆæœ¬ï¼Œåœ¨jdk8ä¸­å·²ç»ç¡®ä¿newã€åˆå§‹åŒ–ä¸ºåŸå­æ€§æ“ä½œï¼Œä¸ä¼šå‡ºç°JITå¯¼è‡´æŒ‡ä»¤é‡æ’çš„æƒ…å†µï¼Œæƒ³äº†è§£æ›´å¤šçš„æœ‹å‹è¯·ç‚¹å‡»[è¿™é‡Œ] 2.4 æšä¸¾ç±» public enum Singleton4 { getInstance(); public void doSomething() { //doSomething } } Java1.5ä»¥åï¼Œå•ä¾‹æ¨¡å¼çš„å®ç°æ–¹å¼ç»ˆäºè¿æ¥çš„æ–°é¢å­”ï¼šæšä¸¾ç±»å•ä¾‹ï¼Œè¿™ä¹Ÿæ˜¯ã€ŠEffective Javaã€‹ä½œè€…Joshua åŠ›èçš„ä¸€ç§ä½¿ç”¨æ–¹å¼ æšä¸¾ç±»æ˜¯æ²¡æœ‰æ„é€ æ–¹æ³•çš„ï¼Œæšä¸¾ç±»çš„åˆ›å»ºå®Œå…¨ç”±JVMå†…éƒ¨å®ç°ï¼Œä¸å¯¹å¤–å¼€æ”¾ã€‚è¿™æ ·çš„ç‰¹æ€§ä¹Ÿä½¿å¾—æˆ‘ä»¬ä¸èƒ½ä½¿ç”¨newçš„æ–¹å¼æ¥åˆ›å»ºæšä¸¾å¯¹è±¡ï¼Œå¯¹åº”çš„ç¼ºç‚¹å°±æ˜¯æšä¸¾ç±»çš„å•ä¾‹æ¨¡å¼ä¸æ˜¯æ‡’åŠ è½½çš„ æšä¸¾ç±»å•ä¾‹é™¤äº†èƒ½ä¿è¯çº¿ç¨‹å®‰å…¨å¤–ï¼Œè¿˜åŠ å…¥äº†æ–°åŠŸèƒ½ï¼šé˜²æ­¢å•ä¾‹æ¨¡å¼è¢«ç ´åï¼ŒåŸå› æœ‰ä¸¤ç‚¹ï¼š æšä¸¾ç±»æ— æ³•è¢«åå°„åˆ›å»º å¼ºè¡Œä½¿ç”¨åå°„åˆ›å»ºä¼šæ”¶åˆ°é”™è¯¯ï¼šjava.lang.IllegalArgumentException: Cannot reflectively create enum objects æšä¸¾ç±»ä¸èƒ½è¢«ååºåˆ—åŒ– åºåˆ—åŒ–çš„æ—¶å€™ï¼Œä»…ä»…æ˜¯å°†æšä¸¾å¯¹è±¡çš„nameå±æ€§è¾“å‡ºåˆ°ç»“æœä¸­ï¼Œååºåˆ—åŒ–çš„æ—¶å€™åˆ™æ˜¯é€šè¿‡java.lang.Enumçš„valueOfæ–¹æ³•æ¥æ ¹æ®åå­—æŸ¥æ‰¾æšä¸¾å¯¹è±¡ã€‚ åŒæ—¶ï¼Œç¼–è¯‘å™¨æ˜¯ä¸å…è®¸ä»»ä½•å¯¹è¿™ç§åºåˆ—åŒ–æœºåˆ¶çš„å®šåˆ¶çš„ï¼Œå› æ­¤ç¦ç”¨äº†writeObjectã€readObjectã€readObjectNoDataã€writeReplaceå’ŒreadResolveç­‰æ–¹æ³•ã€‚ æœ€åï¼Œå…³äºæšä¸¾ç±»è¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼šæšä¸¾ç±»ä¸èƒ½ç»§æ‰¿ä»»ä½•ç±»ï¼Œæšä¸¾ç±»åœ¨ç¼–è¯‘åä¼šç»§æ‰¿è‡ªjava.lang.Enumï¼Œç”±äºJavaå•ç»§æ‰¿çš„ç‰¹æ€§å¯¼è‡´æšä¸¾ç±»ä¸èƒ½å†ç»§æ‰¿ä»»ä½•å…¶ä»–ç±»ï¼Œä½†æ˜¯æšä¸¾ç±»å¯ä»¥å®ç°æ¥å£ 3ã€ç ´åå•ä¾‹æ¨¡å¼åŠé˜²æ­¢ç ´åå•ä¾‹ æ­£å¦‚2.4å°èŠ‚ä¸­æåˆ°çš„ï¼Œé™¤äº†æšä¸¾ç±»å•ä¾‹å¤–ï¼Œå…¶ä»–çš„ä¸‰ç§å•ä¾‹æ¨¡å¼éƒ½å¯ä»¥é€šè¿‡ä½¿ç”¨åå°„æ¥ç ´ååœ¨è¿›ç¨‹ä¸­çš„å”¯ä¸€æ€§ å•ä¾‹ç±»ç”±äºè‡ªèº«çš„ç‰¹æ®Šæ€§å¯¼è‡´æ— æ³•è¢«åå°„å’Œååºåˆ—åŒ–åˆ›å»ºï¼Œæ‰€ä»¥å¯¹è±¡çš„å”¯ä¸€æ€§æš‚æ—¶æ— æ³•è¢«ç ´åï¼Œä½†æ˜¯å¯ä»¥ä¿®æ”¹æšä¸¾ç±»çš„å€¼ ç¬”è€…è¿™é‡Œå†™äº†ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ä»£ç æ¥ç ´åå•ä¾‹ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹ä¹Ÿå¯ä»¥è‡ªå·±åœ¨å•å…ƒæµ‹è¯•ä¸­è¯•ä¸€è¯• @Test public void main() { testSingleton1(); testSingleton2(); testSingleton3(); } /*1.æ¶æ±‰æ¨¡å¼*/ private static void testSingleton1() { Object fromInstance = Singleton1.getInstance(); Object fromReflect = createClassWithReflect(Singleton1.class); System.out.println(fromInstance.equals(fromReflect)); } /*2.æ‡’æ±‰æ¨¡å¼-é™æ€å†…éƒ¨ç±»*/ private static void testSingleton2() { Object fromInstance = Singleton2.getInstance(); Object fromReflect = createClassWithReflect(Singleton2.class); System.out.println(fromInstance.equals(fromReflect)); } /*3.æ‡’æ±‰æ¨¡å¼-DoubleCheckLock*/ private static void testSingleton3() { Object fromInstance = Singleton3.getInstance(); Object fromReflect = createClassWithReflect(Singleton3.class); System.out.println(fromInstance.equals(fromReflect)); } private static &lt;T&gt; T createClassWithReflect(Class&lt;T&gt; clz) { Constructor&lt;?&gt; constructor = clz.getDeclaredConstructor(); constructor.setAccessible(true); return (T) constructor.newInstance(); } æ‰“å°ç»“æœ false false false ä»æ‰“å°ç»“æœå¯ä»¥çœ‹å‡ºï¼Œé™¤æšä¸¾ç±»å¤–çš„ä¸‰ç§å®ç°æ–¹å¼å…¨éƒ¨æ²¦é™·ï¼Œéƒ½å¯ä»¥é€šè¿‡åå°„æ¥åˆ›å»ºä¸åŒçš„å®ä¾‹å¯¹è±¡æ¥ç ´åå•ä¾‹æ¨¡å¼çš„å”¯ä¸€æ€§ åå°„åˆ›å»ºæšä¸¾ç±»ä¼šå—åˆ°æŠ¥é”™ä¿¡æ¯ï¼šjava.lang.IllegalArgumentException: Cannot reflectively create enum objectsï¼Œç¬”è€…è¿™é‡Œå°±ä¸å±•ç¤ºäº†ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·±åŠ¨æ‰‹è¯•ä¸€è¯• æœ€åæä¸€å¥ï¼Œç½‘ä¸Šå…¶ä»–æ–‡ç« æåˆ°äº†ä½¿ç”¨cloneæ–¹æ³•æ¥ç ´åå•ä¾‹ï¼Œç¬”è€…è®¤ä¸ºè¿™ç‚¹ä¸æˆç«‹ï¼Œå› ä¸ºä¸é‡å†™clone()æ–¹æ³•å¹¶ä¸”ä¸å°†è®¿é—®ä¿®é¥°ç¬¦æ”¹ä¸ºpublicï¼Œä½¿ç”¨è€…æ˜¯æ— æ³•è°ƒç”¨cloneæ–¹æ³•æ¥åˆ›å»ºæ–°çš„å®ä¾‹å¯¹è±¡çš„ 4ã€å°ç»“ è‡³æ­¤ï¼Œå‡ ç§å¸¸è§çš„å•ä¾‹æ¨¡å¼å®ç°æ–¹å¼éƒ½ä»‹ç»å®Œäº†ï¼Œç®€å•æ€»ç»“ä¸‹ï¼šä¸Šè¿°å‡ ç§å®ç°æ–¹å¼éƒ½å¯ä»¥åœ¨ä¿è¯å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å®‰å…¨æ€§ï¼›é™¤äº†æšä¸¾å•ä¾‹ä¹‹å¤–ï¼Œå…¶ä»–å‡ ç§æ–¹å¼çš„å•ä¾‹æ¨¡å¼éƒ½å¯ä»¥è¢«ç ´å æ­¤å°èŠ‚æ¶‰åŠåˆ°çš„ä»£ç åœ¨è¿™é‡Œ ä¸‰ã€åˆ›å»ºå‹æ¨¡å¼ï¼šå·¥å‚æ–¹æ³• 1ã€æ¨¡å¼å®šä¹‰ å·¥å‚æ–¹æ³•æ¨¡å¼åˆç§°ä¸ºå·¥å‚æ¨¡å¼ï¼Œåœ¨å·¥å‚æ–¹æ³•æ¨¡å¼ä¸­ï¼Œå·¥å‚çˆ¶ç±»è´Ÿè´£å®šä¹‰åˆ›å»ºäº§å“å¯¹è±¡çš„å…¬å…±æ¥å£ï¼Œè€Œå·¥å‚å­ç±»åˆ™è´Ÿè´£ç”Ÿæˆå…·ä½“çš„äº§å“å¯¹è±¡ï¼Œè¿™æ ·åšçš„ç›®çš„æ˜¯å°†äº§å“ç±»çš„å®ä¾‹åŒ–æ“ä½œå»¶è¿Ÿåˆ°å·¥å‚å­ç±»ä¸­å®Œæˆï¼Œå³é€šè¿‡å·¥å‚å­ç±»æ¥ç¡®å®šç©¶ç«Ÿåº”è¯¥å®ä¾‹åŒ–å“ªä¸€ä¸ªå…·ä½“äº§å“ç±»ã€‚ å·¥å‚æ–¹æ³•æ¨¡å¼åŒ…å«å››ä¸ªè§’è‰²ï¼š æŠ½è±¡äº§å“æ˜¯å®šä¹‰äº§å“çš„æ¥å£ï¼Œæ˜¯å·¥å‚æ–¹æ³•æ¨¡å¼æ‰€åˆ›å»ºå¯¹è±¡çš„è¶…ç±»å‹ï¼Œå³äº§å“å¯¹è±¡çš„å…±åŒçˆ¶ç±»æˆ–æ¥å£ï¼› å…·ä½“äº§å“å®ç°äº†æŠ½è±¡äº§å“æ¥å£ï¼ŒæŸç§ç±»å‹çš„å…·ä½“äº§å“ç”±ä¸“é—¨çš„å…·ä½“å·¥å‚åˆ›å»ºï¼Œå®ƒä»¬ä¹‹é—´å¾€å¾€ä¸€ä¸€å¯¹åº”ï¼› æŠ½è±¡å·¥å‚ä¸­å£°æ˜äº†å·¥å‚æ–¹æ³•ï¼Œç”¨äºè¿”å›ä¸€ä¸ªäº§å“ï¼Œå®ƒæ˜¯å·¥å‚æ–¹æ³•æ¨¡å¼çš„æ ¸å¿ƒï¼Œä»»ä½•åœ¨æ¨¡å¼ä¸­åˆ›å»ºå¯¹è±¡çš„å·¥å‚ç±»éƒ½å¿…é¡»å®ç°è¯¥æ¥å£ï¼› å…·ä½“å·¥å‚æ˜¯æŠ½è±¡å·¥å‚ç±»çš„å­ç±»ï¼Œå®ç°äº†æŠ½è±¡å·¥å‚ä¸­å®šä¹‰çš„å·¥å‚æ–¹æ³•ï¼Œå¹¶å¯ç”±å®¢æˆ·è°ƒç”¨ï¼Œè¿”å›ä¸€ä¸ªå…·ä½“äº§å“ç±»çš„å®ä¾‹ã€‚ å›¾ç‰‡æ¥æºï¼šè‡ªå·±ç”»çš„ 2ã€ä»£ç ç¤ºä¾‹ è§’è‰²1ï¼šæŠ½è±¡äº§å“ç±» public abstract class AbstractProduct { public abstract String getName(); } è§’è‰²2ï¼šäº§å“å®ç°ç±» public class ProductA extends AbstractProduct { @Override public String getName() { return &quot;A&quot;; } } public class ProductB extends AbstractProduct { @Override public String getName() { return &quot;B&quot;; } } è§’è‰²3ï¼šæŠ½è±¡å·¥å‚ç±» public abstract class AbstractFactory { public abstract AbstractProduct createProduct(); } è§’è‰²4ï¼šå·¥å‚å®ç°ç±» public class ProductAFactory extends AbstractFactory { @Override public AbstractProduct createProduct() { return new ProductA(); } } public class ProductBFactory extends AbstractFactory { @Override public AbstractProduct createProduct() { return new ProductB(); } } å·¥å‚æ–¹æ³•ä½¿ç”¨ç¤ºä¾‹ @Test public void main() { AbstractFactory factoryA = new ProductAFactory(); AbstractFactory factoryB = new ProductBFactory(); AbstractProduct productA = factoryA.createProduct(); AbstractProduct productB = factoryB.createProduct(); System.out.println(&quot;å·¥å‚Aç”Ÿäº§çš„äº§å“åç§°ï¼š&quot; + productA.getName()); System.out.println(&quot;å·¥å‚Bç”Ÿäº§çš„äº§å“åç§°ï¼š&quot; + productB.getName()); } æ‰“å°ç»“æœ å·¥å‚Aç”Ÿäº§çš„äº§å“åç§°ï¼šA å·¥å‚Bç”Ÿäº§çš„äº§å“åç§°ï¼šB 3ã€æºç é”šç‚¹ ä»æœ¬å°èŠ‚å¼€å§‹ï¼Œç¬”è€…å°†ä¼šå¯¹æ¯ç§è®¾è®¡æ¨¡å¼éƒ½ä»¥Java/Androidæºç ä¸¾ä¾‹è¯´æ˜ï¼Œç”¨é”šç‚¹è®°å¿†æ³•æ¥è¾…åŠ©è®°å¿†ï¼›æ¯”å¦‚æèµ·å»ºé€ è€…æ¨¡å¼å°±åƒåˆ°Android AlertDialogï¼Œæåˆ°è§‚å¯Ÿè€…æ¨¡å¼å°±æƒ³åˆ°OnClickListenerä¸€æ · å·¥å‚æ¨¡å¼åœ¨æºç ä¸­çš„æç°ï¼Œæˆ‘ä»¬å¯ä»¥è®°ä½Javaå®¹å™¨ç±»çš„è¿­ä»£å™¨ï¼šIterator ä¸ºäº†åŠ æ·±è®°å¿†ï¼Œæˆ‘ä»¬è¿™é‡Œç®€å•å‰–æä½¿ç”¨å·¥å‚æ–¹æ³•è¿­ä»£å™¨çš„è§’è‰²åˆ†å·¥ï¼š æŠ½è±¡å·¥å‚ Iterable å·¥å‚å®ç° ArrayList HashMap æŠ½è±¡äº§å“ Iterator äº§å“å®ç°(jdk1.8) ArrayListä¸­çš„Itrç±» HashMapä¸­çš„EntryIterator/KeyIterator/ValueIteratorç±» ä»ä¸Šé¢çš„ç»“æ„æ¥çœ‹ï¼ŒArrayListå’ŒHashMapä¸­çš„iteratoræ–¹æ³•å…¶å®å°±ç›¸å½“äºä¸€ä¸ªå·¥å‚æ–¹æ³•ï¼Œä¸“ä¸ºnewå¯¹è±¡è€Œç”Ÿï¼Œè¿™é‡Œiteratoræ–¹æ³•æ˜¯æ„é€ å¹¶è¿”å›ä¸€ä¸ªå…·ä½“çš„è¿­ä»£å™¨ 4ã€å°ç»“ å·¥å‚æ–¹æ³•æ¨¡å¼çš„ä¸»è¦ä¼˜ç‚¹æ˜¯å¢åŠ æ–°çš„äº§å“ç±»æ—¶æ— é¡»ä¿®æ”¹ç°æœ‰ç³»ç»Ÿï¼Œå¹¶å°è£…äº†äº§å“å¯¹è±¡çš„åˆ›å»ºç»†èŠ‚ï¼Œç³»ç»Ÿå…·æœ‰è‰¯å¥½çš„çµæ´»æ€§å’Œå¯æ‰©å±•æ€§ï¼›å…¶ç¼ºç‚¹åœ¨äºå¢åŠ æ–°äº§å“çš„åŒæ—¶éœ€è¦å¢åŠ æ–°çš„å·¥å‚ï¼Œå¯¼è‡´ç³»ç»Ÿç±»çš„ä¸ªæ•°æˆå¯¹å¢åŠ ï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šå¢åŠ äº†ç³»ç»Ÿçš„å¤æ‚æ€§ ç¬”è€…è¿™é‡Œæ²¡æœ‰æåˆ°ç®€å•å·¥å‚ï¼Œå®é™…ä¸Šï¼Œå½“æŠŠå·¥å‚æ–¹æ³•çš„æŠ½è±¡å·¥å‚ç±»åˆ é™¤æ‰ï¼Œå°±æ˜¯ç®€å•å·¥å‚æ¨¡å¼äº†ï¼Œæ‰€ä»¥å¯ä»¥æŠŠç®€å•å·¥å‚ç†è§£ä¸ºå·¥å‚æ–¹æ³•çš„ç®€åŒ–ç‰ˆæœ¬ï¼›ç¬”è€…è¿™é‡Œæ²¡æœ‰ç»™å‡ºç¤ºä¾‹ï¼Œæƒ³è¦äº†è§£æ›´å¤šçš„å¯ä»¥å»çœ‹é˜¿é‡Œå·´å·´æ·˜ç³»æŠ€æœ¯åœ¨çŸ¥ä¹ä¸Šçš„å›ç­”ï¼šç®€å•å·¥å‚æ¨¡å¼ã€å·¥å‚æ–¹æ³•æ¨¡å¼å’ŒæŠ½è±¡å·¥å‚æ¨¡å¼æœ‰ä½•åŒºåˆ« æ­¤å°èŠ‚æ¶‰åŠåˆ°çš„ä»£ç åœ¨è¿™é‡Œ å››ã€åˆ›å»ºå‹æ¨¡å¼ï¼šæŠ½è±¡å·¥å‚ 1ã€æ¨¡å¼å®šä¹‰ æŠ½è±¡å·¥å‚æ¨¡å¼æ˜¯æ‰€æœ‰å½¢å¼çš„å·¥å‚æ¨¡å¼ä¸­æœ€ä¸ºæŠ½è±¡å’Œæœ€å…·ä¸€èˆ¬æ€§çš„ä¸€ç§å½¢æ€ã€‚æŠ½è±¡å·¥å‚æ¨¡å¼ä¸å·¥å‚æ–¹æ³•æ¨¡å¼æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼Œå·¥å‚æ–¹æ³•æ¨¡å¼é’ˆå¯¹çš„æ˜¯ä¸€ä¸ªäº§å“ç­‰çº§ç»“æ„ï¼Œè€ŒæŠ½è±¡å·¥å‚æ¨¡å¼åˆ™éœ€è¦é¢å¯¹å¤šä¸ªäº§å“ç­‰çº§ç»“æ„ æŠ½è±¡å·¥å‚æ¨¡å¼åŒæ ·åŒ…å«å››ä¸ªè§’è‰²ï¼š æŠ½è±¡å·¥å‚ç”¨äºå£°æ˜ç”ŸæˆæŠ½è±¡äº§å“çš„æ–¹æ³•ï¼› å…·ä½“å·¥å‚å®ç°äº†æŠ½è±¡å·¥å‚å£°æ˜çš„ç”ŸæˆæŠ½è±¡äº§å“çš„æ–¹æ³•ï¼Œç”Ÿæˆä¸€ç»„å…·ä½“äº§å“ï¼Œè¿™äº›äº§å“æ„æˆäº†ä¸€ä¸ªäº§å“æ—ï¼Œæ¯ä¸€ä¸ªäº§å“éƒ½ä½äºæŸä¸ªäº§å“ç­‰çº§ç»“æ„ä¸­ï¼› æŠ½è±¡äº§å“ä¸ºæ¯ç§äº§å“å£°æ˜æ¥å£ï¼Œåœ¨æŠ½è±¡äº§å“ä¸­å®šä¹‰äº†äº§å“çš„æŠ½è±¡ä¸šåŠ¡æ–¹æ³•ï¼› å…·ä½“äº§å“å®šä¹‰å…·ä½“å·¥å‚ç”Ÿäº§çš„å…·ä½“äº§å“å¯¹è±¡ï¼Œå®ç°æŠ½è±¡äº§å“æ¥å£ä¸­å®šä¹‰çš„ä¸šåŠ¡æ–¹æ³•ã€‚ è™½ç„¶æŠ½è±¡å·¥å‚çš„è§’è‰²æ•°é‡å’Œå·¥å‚æ–¹æ³•ç›¸åŒï¼Œéƒ½æ˜¯4ä¸ªï¼Œä½†ç”±äºæ¯ä¸ªè§’è‰²ä¸‹è¿˜æœ‰å…¶ä»–è§’è‰²ï¼Œç†è§£èµ·æ¥å°±ä¼šç¨å¾®æœ‰ç‚¹è´¹åŠ²ï¼Œè¿™ä¸€ç‚¹ä¹Ÿå¯ä»¥ä»æŠ½è±¡å·¥å‚å’Œå·¥å‚æ–¹æ³•çš„UMLç±»å›¾çœ‹å‡ºæ¥åŒºåˆ«ï¼ŒæŠ½è±¡å·¥å‚æ˜æ˜¾æ›´å¤æ‚ä¸€äº› ç”±äºæŠ½è±¡å·¥å‚ç¨å¾®æœ‰ç‚¹å¤æ‚ï¼Œä¸èƒ½å†ç”¨ä¸Šé¢çš„ProductAã€FactoryBç­‰æ— å®é™…æ„ä¹‰çš„ç±»åæ¥ä¸¾ä¾‹ï¼Œä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œç¬”è€…è¿™é‡Œä½¿ç”¨æ‰‹æœºç»„è£…å‚æ¥åšç±»æ¯”ï¼Œä»–ä»¬çš„è§’è‰²åˆ†å·¥å¦‚ä¸‹ï¼š æŠ½è±¡äº§å“ ç”µæ± ç»„è£…å‚ å±å¹•ç»„è£…å‚ å…·ä½“äº§å“å®ç° ç”µæ±  æ¯”äºšè¿ªç”µæ± ä¾›åº”å•† å¾·èµ›ç”µæ± ä¾›åº”å•† å±å¹• äº¬ä¸œæ–¹å±å¹•ä¾›åº”å•† LGå±å¹•ä¾›åº”å•† æŠ½è±¡å·¥å‚ æ‰‹æœºç»„è£…å‚ å…·ä½“å·¥å‚å®ç° åä¸ºP50çš„ç»„è£…å‚ å°ç±³10çš„ç»„è£…å‚ æœ‰äº†ä¸Šé¢çš„è§’è‰²åˆ†å·¥ç»“æ„ï¼Œåœ¨ä¸‹é¢ä»£ç ç¤ºä¾‹æˆ‘ä»¬å°±ç›´æ¥å¯¹å·å…¥åº§ï¼Œè¿™æ ·çš„æ–¹å¼å¯èƒ½ä¼šæ–¹ä¾¿ç†è§£ å›¾ç‰‡æ¥æºï¼šè‡ªå·±ç”»çš„ 2ã€ä»£ç ç¤ºä¾‹ è§’è‰²1-1ï¼šæŠ½è±¡äº§å“ç±»-ç”µæ±  public abstract class AbstractProductBattery { public AbstractProductBattery() { createBattery(); } public abstract String getBatteryName(); protected abstract void createBattery(); } è§’è‰²1-2ï¼šæŠ½è±¡äº§å“ç±»-å±å¹• public abstract class AbstractProductScreen { public AbstractProductScreen() { createScreen(); } public abstract String getScreenName(); protected abstract void createScreen(); } è§’è‰²2-1-1ï¼šäº§å“å®ç°ç±»-ç”µæ± -æ¯”äºšè¿ª public class BYDBattery extends AbstractProductBattery { @Override public String getBatteryName() { return &quot;æ¯”äºšè¿ª(BYD)&quot;; } @Override protected void createBattery() { System.out.println(&quot;åŠ ç­åŠ ç‚¹ç”Ÿäº§æ¯”äºšè¿ªç”µæ± ä¸­...&quot;); } } è§’è‰²2-1-2ï¼šäº§å“å®ç°ç±»-ç”µæ± -å¾·èµ› public class DesayBattery extends AbstractProductBattery { @Override public String getBatteryName() { return &quot;å¾·èµ›(Desay)&quot;; } @Override protected void createBattery() { System.out.println(&quot;åŠ ç­åŠ ç‚¹ç”Ÿäº§å¾·èµ›ç”µæ± ä¸­...&quot;); } } è§’è‰²2-2-1ï¼šäº§å“å®ç°ç±»-å±å¹•-äº¬ä¸œæ–¹ public class BOEScreen extends AbstractProductScreen { @Override public String getScreenName() { return &quot;äº¬ä¸œæ–¹(BOE)&quot;; } @Override protected void createScreen() { System.out.println(&quot;åŠ ç­åŠ ç‚¹ç”Ÿäº§äº¬ä¸œæ–¹å±å¹•ä¸­...&quot;); } } è§’è‰²2-2-2ï¼šäº§å“å®ç°ç±»-å±å¹•-LG public class LGScreen extends AbstractProductScreen { @Override public String getScreenName() { return &quot;LG&quot;; } @Override protected void createScreen() { System.out.println(&quot;åŠ ç­åŠ ç‚¹ç”Ÿäº§LGå±å¹•ä¸­...&quot;); } } è§’è‰²3ï¼šæŠ½è±¡å·¥å‚ç±» public abstract class AbstractPhoneFactory { protected String brand;//å·¥å‚ç”Ÿäº§çš„æ‰‹æœºå“ç‰Œ protected String model;//å·¥å‚ç”Ÿäº§çš„æ‰‹æœºå‹å· protected AbstractProductScreen phoneScreen;//æ‰‹æœºä½¿ç”¨çš„å±å¹• protected AbstractProductBattery phoneBattery;//ä½¿ç”¨çš„ç”µæ±  public AbstractPhoneFactory(String brand, String model) { this.brand = brand; this.model = model; this.phoneScreen = createPhoneScreen(); this.phoneBattery = createPhoneBattery(); } public String getBrand() { return brand; } public String getModel() { return model; } public AbstractProductScreen getPhoneScreen() { return phoneScreen; } public AbstractProductBattery getPhoneBattery() { return phoneBattery; } protected abstract AbstractProductScreen createPhoneScreen(); protected abstract AbstractProductBattery createPhoneBattery(); } è§’è‰²4-1ï¼šå·¥å‚å®ç°ç±»-åä¸º public class HuaWeiPhoneFactory extends AbstractPhoneFactory { public HuaWeiPhoneFactory() { super(&quot;åä¸º(HuaWei)&quot;, &quot;P50&quot;); } @Override protected AbstractProductScreen createPhoneScreen() { return new LGScreen();//Lgå±å¹• } @Override protected AbstractProductBattery createPhoneBattery() { return new DesayBattery();//å¾·èµ›çš„ç”µæ±  } } è§’è‰²4-2ï¼šå·¥å‚å®ç°ç±»-å°ç±³ public class XiaoMiPhoneFactory extends AbstractPhoneFactory { public XiaoMiPhoneFactory() { super(&quot;å°ç±³(XiaoMi)&quot;, &quot;10&quot;); } @Override protected AbstractProductScreen createPhoneScreen() { return new BOEScreen();//äº¬ä¸œæ–¹çš„å±å¹• } @Override protected AbstractProductBattery createPhoneBattery() { return new DesayBattery();//å¾·èµ›ç”µæ±  } } æŠ½è±¡å·¥å‚ä½¿ç”¨ç¤ºä¾‹ public void main() { AbstractPhoneFactory phoneFactory1 = new HuaWeiPhoneFactory(); AbstractPhoneFactory phoneFactory2 = new XiaoMiPhoneFactory(); print(phoneFactory1); print(phoneFactory2); } private void print(AbstractPhoneFactory phoneFactory) { System.out.println(&quot;äº§çº¿å“ç‰Œï¼š&quot; + phoneFactory.getBrand() + &quot;,ç”Ÿäº§å‹å·ï¼š&quot; + phoneFactory.getModel() + &quot;,ç”µæ± å‚å•†ï¼š&quot; + phoneFactory.getPhoneBattery().getBatteryName() + &quot;,å±å¹•å‚å•†ï¼š&quot; + phoneFactory.getPhoneScreen().getScreenName()); } æ‰“å°ç»“æœ äº§çº¿å“ç‰Œï¼šåä¸º(HuaWei),ç”Ÿäº§å‹å·ï¼šP50,ç”µæ± å‚å•†ï¼šå¾·èµ›(Desay),å±å¹•å‚å•†ï¼šLG äº§çº¿å“ç‰Œï¼šå°ç±³(XiaoMi),ç”Ÿäº§å‹å·ï¼š10,ç”µæ± å‚å•†ï¼šå¾·èµ›(Desay),å±å¹•å‚å•†ï¼šäº¬ä¸œæ–¹(BOE) ä»æ‰“å°ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œå°ç±³å’Œåä¸ºéƒ½æ˜¯ç”¨å¾·èµ›çš„ç”µæ± ï¼Œä½†å±å¹•ä¾›åº”å•†ç”¨çš„ä¸æ˜¯åŒä¸€å®¶ è‹¥æˆ‘ä»¬æƒ³å¢åŠ ä¸€ä¸ªäº§å“çº¿ï¼Œåªéœ€è¦æƒ³å°ç±³å’Œåä¸ºå·¥å‚ä¸€æ ·ï¼Œç»§æ‰¿/å®ç°AbstractPhoneFactoryæŠ½è±¡å·¥å‚ç±»å³å¯ï¼Œæ¯ä¸ªé›¶ä»¶æ¥è‡ªå“ªä¸ªä¾›åº”å•†å¯ä»¥éšä¾¿é€‰æ‹©ï¼›ç›¸åŒçš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å¢åŠ ä¾›åº”å•†æ¥ä¸°å¯Œæˆ‘ä»¬çš„äº§å“ï¼Œè¿™å°±æ˜¯æŠ½è±¡å·¥å‚æ¨¡å¼å¸¦æ¥çš„å¥½å¤„ 3ã€æºç é”šç‚¹ æŠ½è±¡å·¥å‚æ–¹æ³•æ¨¡å¼åœ¨Androidæºç ä¸­çš„å®ç°ç›¸å¯¹æ¥è¯´æ˜¯æ¯”è¾ƒå°‘çš„ï¼Œåœ¨ã€ŠAndroid æºç è®¾è®¡æ¨¡å¼è§£æä¸å®æˆ˜ã€‹ä¸€ä¹¦ä¸­æåˆ°æ˜¯Androidåº•å±‚å¯¹MediaPlayerçš„åˆ›å»ºæ˜¯å¯ä»¥çœ‹ä½œä¸ºæŠ½è±¡å·¥å‚ï¼Œè¿™ä¸€å—ä»£ç ç¬”è€…ä¸ç†Ÿæ‚‰ï¼Œä¸ºäº†é˜²æ­¢è¯¯äººå­å¼Ÿï¼ŒæŠ½è±¡å·¥å‚æ¨¡å¼çš„æºç è¿™é‡Œç¬”è€…å°±ä¸å†ä¸¾ä¾‹ï¼Œå¯¹æŠ½è±¡å·¥å‚æºç ä½“ç°æ„Ÿå…´è¶£çš„å¯ä»¥è‡ªè¡ŒæŸ¥æ‰¾å…¶ä»–èµ„æ–™ 4ã€å°ç»“ æŠ½è±¡å·¥å‚æ¨¡å¼çš„ä¸»è¦ä¼˜ç‚¹æ˜¯éš”ç¦»äº†å…·ä½“ç±»çš„ç”Ÿæˆï¼Œä½¿å¾—å®¢æˆ·å¹¶ä¸éœ€è¦çŸ¥é“ä»€ä¹ˆè¢«åˆ›å»ºï¼Œè€Œä¸”æ¯æ¬¡å¯ä»¥é€šè¿‡å…·ä½“å·¥å‚ç±»åˆ›å»ºä¸€ä¸ªäº§å“æ—ä¸­çš„å¤šä¸ªå¯¹è±¡ï¼Œå¢åŠ æˆ–è€…æ›¿æ¢äº§å“æ—æ¯”è¾ƒæ–¹ä¾¿ï¼Œå¢åŠ æ–°çš„å…·ä½“å·¥å‚å’Œäº§å“æ—å¾ˆæ–¹ä¾¿ï¼›ä¸»è¦ç¼ºç‚¹åœ¨äºå¢åŠ æ–°çš„äº§å“ç­‰çº§ç»“æ„å¾ˆå¤æ‚ï¼Œéœ€è¦ä¿®æ”¹æŠ½è±¡å·¥å‚å’Œæ‰€æœ‰çš„å…·ä½“å·¥å‚ç±»ï¼Œå¯¹â€œå¼€é—­åŸåˆ™â€çš„æ”¯æŒå‘ˆç°å€¾æ–œæ€§ã€‚ ç¬”è€…ä¸ªäººæ€»ç»“çš„æŠ½è±¡å·¥å‚å’Œå·¥å‚æ–¹æ³•ä¸åŒç‚¹ï¼šæŠ½è±¡å·¥å‚æ¨¡å¼æ‹¥æœ‰å¤šä¸ªæŠ½è±¡äº§å“ç±»ï¼Œä¹Ÿå°±æ˜¯æœ¬ç¤ºä¾‹çš„ç”µæ± æŠ½è±¡ç±»å’Œå±å¹•æŠ½è±¡ç±» æŠ½è±¡å·¥å‚æ¨¡å¼é€‚ç”¨æƒ…å†µåŒ…æ‹¬ï¼šä¸€ä¸ªç³»ç»Ÿä¸åº”å½“ä¾èµ–äºäº§å“ç±»å®ä¾‹å¦‚ä½•è¢«åˆ›å»ºã€ç»„åˆå’Œè¡¨è¾¾çš„ç»†èŠ‚ï¼›ç³»ç»Ÿä¸­æœ‰å¤šäºä¸€ä¸ªçš„äº§å“æ—ï¼Œè€Œæ¯æ¬¡åªä½¿ç”¨å…¶ä¸­æŸä¸€äº§å“æ—ï¼›å±äºåŒä¸€ä¸ªäº§å“æ—çš„äº§å“å°†åœ¨ä¸€èµ·ä½¿ç”¨ï¼›ç³»ç»Ÿæä¾›ä¸€ä¸ªäº§å“ç±»çš„åº“ï¼Œæ‰€æœ‰çš„äº§å“ä»¥åŒæ ·çš„æ¥å£å‡ºç°ï¼Œä»è€Œä½¿å®¢æˆ·ç«¯ä¸ä¾èµ–äºå…·ä½“å®ç°ã€‚ æ­¤å°èŠ‚æ¶‰åŠåˆ°çš„ä»£ç åœ¨è¿™é‡Œ äº”ã€åˆ›å»ºå‹æ¨¡å¼ï¼šå»ºé€ è€…æ¨¡å¼ 1ã€æ¨¡å¼å®šä¹‰ å»ºé€ è€…æ¨¡å¼å°†ä¸€ä¸ªå¤æ‚å¯¹è±¡çš„æ„å»ºä¸å®ƒçš„è¡¨ç¤ºåˆ†ç¦»ï¼Œä½¿å¾—åŒæ ·çš„æ„å»ºè¿‡ç¨‹å¯ä»¥åˆ›å»ºä¸åŒçš„è¡¨ç¤ºã€‚å»ºé€ è€…æ¨¡å¼æ˜¯ä¸€æ­¥ä¸€æ­¥åˆ›å»ºä¸€ä¸ªå¤æ‚çš„å¯¹è±¡ï¼Œå®ƒå…è®¸ç”¨æˆ·åªé€šè¿‡æŒ‡å®šå¤æ‚å¯¹è±¡çš„ç±»å‹å’Œå†…å®¹å°±å¯ä»¥æ„å»ºå®ƒä»¬ï¼Œç”¨æˆ·ä¸éœ€è¦çŸ¥é“å†…éƒ¨çš„å…·ä½“æ„å»ºç»†èŠ‚ ä¸‹é¢æˆ‘ä»¬ä»¥Androidä¸­åˆ›å»ºä¸€ä¸ªå¼¹çª—ç±»æ¥ä¸¾ä¾‹ï¼Œè¯¥ç±»æœ‰ä»¥ä¸‹å‡ ä¸ªç‰¹æ€§ï¼š å¼¹çª—ç±»æœ‰å·¦å³ä¸¤ä¸ªæŒ‰é’®ï¼Œæ ‡é¢˜å’Œå†…å®¹å…±å››ä¸ªå±æ€§ï¼Œå¼¹çª—ç±»æä¾›Builderç±»æ¥ç»„è£…è‡ªå·± ä¸€æ—¦å¼¹çª—è¢«åˆ›å»ºï¼Œå·¦å³ä¸¤ä¸ªæŒ‰é’®æ–‡å­—ä¸å¸Œæœ›è¢«æ›´æ”¹ï¼Œä¹Ÿå°±è¯´Dialogæœ¬èº«ä¸æä¾›ä¿®æ”¹å·¦å³æŒ‰é’®çš„æ–¹æ³• Builderæä¾›ä¸åŒçš„åˆ›å»ºæ–¹æ³•ï¼Œæ¯”å¦‚ï¼šåˆ›å»ºå·¦å³ä¸¤ä¸ªæŒ‰é’®çš„å¼¹çª—ã€åªæœ‰ç¡®è®¤æŒ‰é’®çš„å¼¹çª—ï¼Œåˆ›å»ºè¿‡ç¨‹ç”±Builderæ¥ç®¡ç† å»ºé€ è€…æ¨¡å¼ç†è§£èµ·æ¥ä¹Ÿæ¯”è¾ƒå®¹æ˜“ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥åº·åº·5.2ä¸­çš„ä»£ç ç¤ºä¾‹ 2ã€ä»£ç ç¤ºä¾‹ public class CommonDialog { private Params mParams; private CommonDialog(Params params) { this.mParams = params; } public void setTitleText(String title) { mParams.titleText = title; } public void setMessageText(String message) { mParams.messageText = message; } public void show() { //set view... } public static class Builder { protected Params mParams = new Params(); public Builder setTitleText(String title) { mParams.titleText = title; return this; } public Builder setMessageText(String message) { mParams.messageText = message; return this; } public Builder setConfirmText(String confirm) { mParams.confirmText = confirm; return this; } public Builder setCancelText(String cancel) { mParams.cancelText = cancel; return this; } public CommonDialog create() { //create normal dialog logic return new CommonDialog(mParams); } public CommonDialog createOnlyConfirm() { //create only have confirm btn dialog logic mParams.cancelText = null; return new CommonDialog(mParams); } } private static class Params { /*public to anyone*/ private String titleText; private String messageText; /*private field , runtime not change*/ private String confirmText; private String cancelText; } } å»ºé€ è€…æ¨¡å¼ä½¿ç”¨ç¤ºä¾‹ public void main() { CommonDialog.Builder builder = new CommonDialog.Builder(); builder.setMessageText(&quot;will you marry me&quot;); builder.setConfirmText(&quot;yes&quot;); builder.setCancelText(&quot;no&quot;); CommonDialog normalDialog = builder.create();//åˆ›å»ºæ™®é€šå¯¹è¯æ¡† normalDialog.show(); builder.setMessageText(&quot;are you free now?&quot;); builder.setConfirmText(&quot;yes&quot;); CommonDialog onlyConfirmDialog = builder.createOnlyConfirm();//åˆ›å»ºåªæœ‰ç¡®è®¤æŒ‰é’®çš„å¯¹è¯æ¡† onlyConfirmDialog.show(); onlyConfirmDialog.setMessageText(&quot;Let's go to the movies?&quot;); onlyConfirmDialog.show(); } çœ‹ä½¿ç”¨ç¤ºä¾‹å°±èƒ½æ˜ç™½ï¼Œå½“åœ¨åˆ›å»ºDialogè¿‡ç¨‹ä¸­ï¼Œå¯ä»¥éšæ„çš„æ›´æ”¹ä»»ä½•å±æ€§ï¼›ä¸€æ—¦åˆ›å»ºäº†Dialogå®ä¾‹å¯¹è±¡ï¼Œå¯ä¿®æ”¹çš„å±æ€§å°±ä¸å¤šäº†ã€‚åŸºäºæ­¤ï¼Œç¬”è€…æ€»ç»“ä¸€ä¸‹Builderæ¨¡å¼ä¸¤å¤§ç‰¹ç‚¹ï¼šé™åˆ¶ã€å°è£… 3ã€æºç é”šç‚¹ å»ºé€ è€…æ¨¡å¼åœ¨Androidæºç ä¸­çš„å®ç°ï¼šAlertDialog 4ã€å°ç»“ å»ºé€ è€…æ¨¡å¼çš„ä¸»è¦ä¼˜ç‚¹åœ¨äºå®¢æˆ·ç«¯ä¸å¿…çŸ¥é“äº§å“å†…éƒ¨ç»„æˆçš„ç»†èŠ‚ï¼Œå°†äº§å“æœ¬èº«ä¸äº§å“çš„åˆ›å»ºè¿‡ç¨‹è§£è€¦ï¼Œä½¿å¾—ç›¸åŒçš„åˆ›å»ºè¿‡ç¨‹å¯ä»¥åˆ›å»ºä¸åŒçš„äº§å“å¯¹è±¡ï¼Œæ¯ä¸€ä¸ªå…·ä½“å»ºé€ è€…éƒ½ç›¸å¯¹ç‹¬ç«‹ï¼Œè€Œä¸å…¶ä»–çš„å…·ä½“å»ºé€ è€…æ— å…³ï¼Œå› æ­¤å¯ä»¥å¾ˆæ–¹ä¾¿åœ°æ›¿æ¢å…·ä½“å»ºé€ è€…æˆ–å¢åŠ æ–°çš„å…·ä½“å»ºé€ è€…ï¼Œç¬¦åˆâ€œå¼€é—­åŸåˆ™â€ï¼Œè¿˜å¯ä»¥æ›´åŠ ç²¾ç»†åœ°æ§åˆ¶äº§å“çš„åˆ›å»ºè¿‡ç¨‹ å½“ç„¶ï¼Œå»ºé€ è€…æ¨¡å¼ä¹Ÿæ˜¯æœ‰ç¼ºç‚¹çš„ï¼Œå…¶ä¸»è¦ç¼ºç‚¹åœ¨äºç”±äºå»ºé€ è€…æ¨¡å¼æ‰€åˆ›å»ºçš„äº§å“ä¸€èˆ¬å…·æœ‰è¾ƒå¤šçš„å…±åŒç‚¹ï¼Œå…¶ç»„æˆéƒ¨åˆ†ç›¸ä¼¼ï¼Œå› æ­¤å…¶ä½¿ç”¨èŒƒå›´å—åˆ°ä¸€å®šçš„é™åˆ¶ï¼Œç›¸å¯¹åº”çš„ä»£ç é‡ä¹Ÿä¼šå¢åŠ ä¸å°‘ï¼›å¦‚æœäº§å“çš„å†…éƒ¨å˜åŒ–å¤æ‚ï¼Œå¯èƒ½ä¼šå¯¼è‡´éœ€è¦å®šä¹‰å¾ˆå¤šå…·ä½“å»ºé€ è€…ç±»æ¥å®ç°è¿™ç§å˜åŒ–ï¼Œå¯¼è‡´ç³»ç»Ÿå˜å¾—å¾ˆåºå¤§ã€‚ å»ºé€ è€…æ¨¡å¼é€‚ç”¨æƒ…å†µåŒ…æ‹¬ï¼š éœ€è¦ç”Ÿæˆçš„äº§å“å¯¹è±¡æœ‰å¤æ‚çš„å†…éƒ¨ç»“æ„ï¼Œè¿™äº›äº§å“å¯¹è±¡é€šå¸¸åŒ…å«å¤šä¸ªæˆå‘˜å±æ€§ï¼› éœ€è¦ç”Ÿæˆçš„äº§å“å¯¹è±¡çš„å±æ€§ç›¸äº’ä¾èµ–ï¼Œéœ€è¦æŒ‡å®šå…¶ç”Ÿæˆé¡ºåºï¼› å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹ç‹¬ç«‹äºåˆ›å»ºè¯¥å¯¹è±¡çš„ç±»ï¼› éš”ç¦»å¤æ‚å¯¹è±¡çš„åˆ›å»ºå’Œä½¿ç”¨ï¼Œå¹¶ä½¿å¾—ç›¸åŒçš„åˆ›å»ºè¿‡ç¨‹å¯ä»¥åˆ›å»ºä¸åŒç±»å‹çš„äº§å“ã€‚ æ­¤å°èŠ‚æ¶‰åŠåˆ°çš„ä»£ç åœ¨è¿™é‡Œ å…­ã€æ€»ç»“ æœ¬æ–‡ä»‹ç»äº†å¸¸è§çš„å‡ ç§åˆ›å»ºå‹è®¾è®¡æ¨¡å¼ï¼Œç®€å•æ€»ç»“ä¸€ä¸‹ï¼š å•ä¾‹æ¨¡å¼ï¼šä¿è¯ä¸€ä¸ªç±»ä»…æœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¸¸è§å®ç°æ–¹å¼æœ‰ é¥¿æ±‰å¼ï¼šè‹¥è¢«æå‰åŠ è½½ä¼šå ç”¨å†…å­˜ æ‡’æ±‰å¼-é™æ€å†…éƒ¨ç±» æ‡’æ±‰å¼-åŒé‡æ ¡éªŒé”DCL æšä¸¾ç±»å•ä¾‹ï¼šç”±è™šæ‹Ÿæœºåˆå§‹åŒ–ï¼Œé˜²æ­¢ç ´åå”¯ä¸€æ€§ å·¥å‚æ–¹æ³•æ¨¡å¼ï¼Œé€šè¿‡å·¥å‚å­ç±»æ¥ç¡®å®šç©¶ç«Ÿåº”è¯¥å®ä¾‹åŒ–å“ªä¸€ä¸ªå…·ä½“äº§å“ç±» ç®€å•å·¥å‚ï¼šå·¥å‚æ–¹æ³•çš„ç®€åŒ–æ¨¡å¼ æŠ½è±¡å·¥å‚æ¨¡å¼ï¼šæä¾›ä¸€ä¸ªåˆ›å»ºä¸€ç³»åˆ—ç›¸å…³æˆ–ç›¸äº’ä¾èµ–å¯¹è±¡çš„æ¥å£ï¼Œè€Œæ— é¡»æŒ‡å®šå®ƒä»¬å…·ä½“çš„ç±» å»ºé€ è€…æ¨¡å¼ï¼šå°†å¤æ‚å¯¹è±¡çš„æ„é€ ä¸å®ƒçš„è¡¨ç¤ºåˆ†å¼€ï¼Œè¿™æ ·å¯ä»¥åœ¨ç›¸åŒçš„æ„é€ è¿‡ç¨‹ä¸­åˆ›å»ºä¸åŒçš„è¡¨ç¤ºå½¢å¼ã€‚ ç”±äºç¬”è€…æ°´å¹³æœ‰é™ï¼Œæ–‡ä¸­éš¾å…ä¼šå‡ºç°é—æ¼ç”šè‡³é”™è¯¯çš„åœ°æ–¹ï¼Œè‹¥æ‚¨å‘ç°ä»»ä½•é—®é¢˜æˆ–è€…æœ‰ä»»ä½•å»ºè®®è¯·åœ¨è¿™é‡Œæäº¤Issueï¼Œæ„Ÿè°¢ å…¨æ–‡å®Œ ä¸ƒã€å‚è€ƒèµ„æ–™ å›¾è¯´è®¾è®¡æ¨¡å¼ ã€ŠAndroid æºç è®¾è®¡æ¨¡å¼è§£æä¸å®æˆ˜ã€‹-ä½•çº¢è¾‰ / å…³çˆ±æ°‘ çŸ¥ä¹ï¼šç®€å•å·¥å‚æ¨¡å¼ã€å·¥å‚æ–¹æ³•æ¨¡å¼å’ŒæŠ½è±¡å·¥å‚æ¨¡å¼æœ‰ä½•åŒºåˆ« ","link":"https://yibaoshan.github.io/post/design-pattern-creational/"},{"title":"Hello","content":"ğŸ‘ æ¬¢è¿æ¥åˆ°æˆ‘çš„åšå®¢ è¿™æ˜¯æˆ‘ç¬¬ä¸€ä¸ªé™æ€åšå®¢ï¼Œä¸»è¦ç”¨å®ƒæ¥è®°å½•è‡ªå·±çš„æˆé•¿ï¼ŒåŒæ—¶ä¹Ÿä¼šåˆ†äº«ä¸€äº›æˆ‘çš„ç”Ÿæ´» åšä¸»åæ ‡æ­å·ï¼ŒåŒé±¼åº§ï¼ŒENTJï¼Œçˆ±å¥½çƒ¹é¥ªã€æ‘„å½±ï¼Œä¹äºæ¥å—æ–°é²œäº‹ç‰©ï¼Œæ¬¢è¿æ‰«ç é¢åŸº (*â–½*)ï¼ˆäºŒç»´ç åœ¨æ–‡ç« åº•éƒ¨ï¼‰ ä¸€ã€æˆ‘çš„ä¹¦å• è®¡ç®—æœºç±» ã€Šå‰‘æŒ‡Offerã€‹- ä½•æµ·æ¶› âœ… ã€Šæ±‡ç¼–è¯­è¨€ï¼ˆç¬¬4ç‰ˆï¼‰ã€‹- ç‹çˆ½ âœ… ã€ŠLinuxå†…æ ¸å®Œå…¨æ³¨é‡Šã€‹- èµµç‚¯ â³ ã€ŠLinuxå†…æ ¸å®Œå…¨å‰–æã€‹- èµµç‚¯ â³ ã€ŠAndroid å¼€å‘é«˜æ‰‹è¯¾ã€‹- å¼ ç»æ–‡ âœ… ã€ŠAndroidå¼€å‘è‰ºæœ¯æ¢ç´¢ã€‹- ä»»ç‰åˆš âœ… ã€Šæ·±å…¥ç†è§£ Android : å·Iã€‹- é‚“å‡¡å¹³ âœ… ã€Šæ·±å…¥ç†è§£ Android : å·IIã€‹- é‚“å‡¡å¹³ âœ… ã€Šæ·±å…¥ç†è§£ Android : å·IIIã€‹- å¼ å¤§ä¼Ÿ âœ… ã€Šç©¿è¶Šè®¡ç®—æœºçš„è¿·é›¾ï¼ˆç¬¬2ç‰ˆï¼‰ã€‹- æå¿  âœ… ã€ŠAndroidç³»ç»Ÿæºä»£ç æƒ…æ™¯åˆ†æã€‹- ç½—å‡é˜³ âœ… ã€Šæ·±å…¥ç†è§£Androidå†…æ ¸è®¾è®¡æ€æƒ³ã€‹- æ—å­¦æ£® âœ… ã€ŠJavaç¼–ç¨‹æ€æƒ³ï¼ˆç¬¬4ç‰ˆï¼‰ã€‹- [ç¾] Bruce Eckel âœ… ã€Šæ·±å…¥ç†è§£ Android : Javaè™šæ‹ŸæœºARTã€‹- é‚“å‡¡å¹³ âœ… ã€ŠAndroid æºç è®¾è®¡æ¨¡å¼è§£æä¸å®æˆ˜ã€‹- ä½•çº¢è¾‰ / å…³çˆ±æ°‘ âœ… ã€Šæ·±å…¥ç†è§£Linuxç½‘ç»œï¼š ä¿®ç‚¼åº•å±‚å†…åŠŸï¼ŒæŒæ¡é«˜æ€§èƒ½åŸç†ã€‹- å¼ å½¦é£ â³ ç¤¾ä¼šç§‘å­¦ç±» ã€Šè¯¦è°ˆï¼šå·¦æ™–ã€‹- æç¿” âœ… ã€Šäººé—´ä¿®ç‚¼æŒ‡å—ã€‹- åŠä½›ä»™äºº âœ… ã€Šé‡‘å­—å¡”åŸç†ã€‹- [ç¾]èŠ­èŠ­æ‹‰â€¢æ˜æ‰˜ â³ ã€Šç–¯äººè¯´ï¼šç²¾ç¥ç—…é™¢åŒ»ç”Ÿæ‰‹è®° ã€‹- ç©†æˆˆ âœ… ã€Šç»æµå­¦åŸç†(ç¬¬7ç‰ˆ)ã€‹- æ›¼æ˜† (N.Gregory Mankiw) âœ… äºŒã€æŠ€æœ¯æ–‡ç«  Android å›¾å½¢ç³»ç»Ÿ Androidå›¾å½¢ç³»ç»Ÿï¼ˆä¸€ï¼‰ç¡¬ä»¶ç¯‡ï¼šLCDå’ŒOLEDæ€ä¹ˆé€‰ï¼Ÿ Androidå›¾å½¢ç³»ç»Ÿï¼ˆäºŒï¼‰é©±åŠ¨ç¯‡ï¼šå‚ç›´åŒæ­¥åˆ°åº•è¦ä¸è¦å¼€ï¼Ÿ Androidå›¾å½¢ç³»ç»Ÿï¼ˆä¸‰ï¼‰ç³»ç»Ÿç¯‡ï¼šæ¸²æŸ“/åˆæˆçš„åº•å±‚åŸç†æµ…æ Androidå›¾å½¢ç³»ç»Ÿï¼ˆå››ï¼‰åº”ç”¨ç¯‡ï¼šè‡ªå®šä¹‰View/ViewGroupè¯¦è§£ Androidå›¾å½¢ç³»ç»Ÿï¼ˆäº”ï¼‰ç•ªå¤–ç¯‡ï¼šè§¦æ‘¸äº‹ä»¶è¯¦è§£ Android ç³»ç»Ÿç»„ä»¶ Androidç»„ä»¶ç³»åˆ—ï¼šHandleræœºåˆ¶è¯¦è§£ Androidç»„ä»¶ç³»åˆ—ï¼šå†è°ˆHandleræœºåˆ¶ï¼ˆNativeç¯‡ï¼‰ Androidç»„ä»¶ç³»åˆ—ï¼šLocalBroadcastManageræºç è§£æ Android è®¾è®¡æ¨¡å¼ ä»Androidæºç è§’åº¦è°ˆè®¾è®¡æ¨¡å¼ï¼ˆä¸€ï¼‰ï¼šåˆ›å»ºå‹æ¨¡å¼ ä»Androidæºç è§’åº¦è°ˆè®¾è®¡æ¨¡å¼ï¼ˆäºŒï¼‰ï¼šç»“æ„å‹æ¨¡å¼ ä»Androidæºç è§’åº¦è°ˆè®¾è®¡æ¨¡å¼ï¼ˆä¸‰ï¼‰ï¼šè¡Œä¸ºå‹æ¨¡å¼ é—²èŠç³»åˆ— ä¸ºä»€ä¹ˆä¼šå‘ç”Ÿ Fragment not attached to Activity å¼‚å¸¸ï¼Ÿ è¯»ä¹¦ç¬”è®°ï¼šç©¿è¶Šè®¡ç®—æœºçš„è¿·é›¾ï¼ˆä¸Šï¼‰ è¯»ä¹¦ç¬”è®°ï¼šç©¿è¶Šè®¡ç®—æœºçš„è¿·é›¾ï¼ˆä¸‹ï¼‰ è¯»ä¹¦ç¬”è®°ï¼šåå¤©å­¦ä¼š51å•ç‰‡æœº å…¶ä»–(å·¥å…·/æ•ˆç‡) ç»™é©¬æ€»ï¼šæ–è®¯K2-è€æ¯›å­å›ºä»¶ç¿»å¢™æ•™ç¨‹ ä¸‰ã€å·¥ä½œå’Œç”Ÿæ´» ä¸ªäººæˆé•¿ä¸æ€è€ƒ åŒæœˆè®°å½•ï¼ˆ2023ï¼‰ æ˜“ä¿å±± 2023.1~2 åŒæœˆè®°å½• æ˜“ä¿å±± 2023.3~4 åŒæœˆè®°å½• æ˜“ä¿å±± 2023.5~6 åŒæœˆè®°å½• æ˜“ä¿å±± 2023.7~8 åŒæœˆè®°å½• æ˜“ä¿å±± 2023.9~10 åŒæœˆè®°å½• æ˜“ä¿å±± 2023.11~12 åŒæœˆè®°å½• æœ¬ç«™ä¸»é¢˜ä¸æ”¯æŒç›®å½•åŠŸèƒ½ï¼ŒæŠ€æœ¯æ–‡ç« å»ºè®®è·³è½¬åˆ° ç¨€åœŸæ˜é‡‘ é˜…è¯»ã€‚ æœ¬ç«™ä½¿ç”¨ GitHub Pages æ­å»ºï¼Œå¶å°”ä¼šå­˜åœ¨æ— æ³•è®¿é—®æˆ–åŠ è½½æ—¶é—´è¿‡é•¿çš„æƒ…å†µï¼Œè¯·è€å¿ƒç­‰å¾…(â•¹â–½â•¹)ã€‚ ","link":"https://yibaoshan.github.io/post/hello/"}]}