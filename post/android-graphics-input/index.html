<html>
<head>
    <meta charset="utf-8" />
<meta name="description" content="" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<title>Androidå›¾å½¢ç³»ç»Ÿï¼ˆäº”ï¼‰ç•ªå¤–ç¯‡ï¼šè§¦æ‘¸äº‹ä»¶è¯¦è§£ | æ˜“ä¿å±±</title>

<link rel="shortcut icon" href="https://yibaoshan.github.io//favicon.ico?v=1699367045276">

<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://yibaoshan.github.io//styles/main.css">
<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css"> -->

<script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets/highlight.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/9.12.0/languages/dockerfile.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/9.12.0/languages//dart.min.js"></script>

<!-- <script src="https://cdn.jsdelivr.net/npm/moment@2.27.0/moment.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.min.js"></script> -->
<!-- DEMO JS -->
<!--<script src="media/scripts/index.js"></script>-->


<script async src="https://www.googletagmanager.com/gtag/js?id=G-JR8EKM67KY"></script>
<script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', 'G-JR8EKM67KY');
</script>


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.css">
    
        <script src="https://cdn.jsdelivr.net/npm/mermaid@9.1.1/dist/mermaid.min.js"></script>
        <script>mermaid.initialize({startOnLoad:true});</script> 
    
</head>
<body>
<div class="main gt-bg-theme-color-first">
    <nav class="navbar navbar-expand-lg">
    <a class="navbar-brand" href="/">
        <img class="user-avatar" src="/images/avatar.png" alt="å¤´åƒ">
        <div class="site-name gt-c-content-color-first">
            æ˜“ä¿å±±
        </div>
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation" id="changeNavbar">
        <i class="fas fa-bars gt-c-content-color-first" style="font-size: 18px"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <div class="navbar-nav mr-auto" style="text-align: center">
            
            <div class="nav-item">
                
                <a href="/" class="menu gt-a-link">
                    é¦–é¡µ
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/archives" class="menu gt-a-link">
                    å½’æ¡£
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/tags" class="menu gt-a-link">
                    æ ‡ç­¾
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/post/about" class="menu gt-a-link">
                    å…³äº
                </a>
                
            </div>
            
        </div>
        <div style="text-align: center">
            <form id="gridea-search-form" style="position: relative" data-update="1699367045276"
                action="/search/">
                <input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="æœç´¢æ–‡ç« " />
                <i class="fas fa-search gt-c-content-color-first" style="position: absolute; top: 9px; left: 10px;"></i>
            </form>
        </div>
    </div>
</nav>
<script>
    /* ç§»åŠ¨ç«¯å¯¼èˆªæ å±•å¼€/æ”¶èµ·åˆ‡æ¢ */
    document.getElementById('changeNavbar').onclick = () => {
        var element = document.getElementById('navbarSupportedContent');
        if (element.style.display === 'none' || element.style.display === '') {
            element.style.display = 'block';
        } else {
            element.style.display = 'none';
        }
    }
</script>

    <div class="post-container">
        <div class="post-detail gt-bg-theme-color-second">
            <article class="gt-post-content">
                <h2 class="post-title">
                    Androidå›¾å½¢ç³»ç»Ÿï¼ˆäº”ï¼‰ç•ªå¤–ç¯‡ï¼šè§¦æ‘¸äº‹ä»¶è¯¦è§£
                </h2>
                <div class="post-info">
                    <time class="post-time gt-c-content-color-first">
                        Â· 2022-11-29 Â·
                    </time>
                    
                        <a href="https://yibaoshan.github.io/tag/Android-Graphics/" class="post-tags">
                            # Androidå›¾å½¢ç³»ç»Ÿ
                        </a>
                    
                </div>
                <div class="post-content">
                    <blockquote>
<p><em><a href="https://juejin.cn/post/7171130176158302245">ç‚¹å‡»è·³è½¬åˆ°æ˜é‡‘é˜…è¯»</a></em></p>
</blockquote>
<p>Android æ˜¯ä¸€ä¸ªæœ‰ç”¨æˆ·ç•Œé¢ï¼ˆ<em>GUI</em>ï¼‰çš„æ“ä½œç³»ç»Ÿï¼Œåœ¨å®ƒè¯ç”Ÿä¹‹åˆï¼Œå°±æ˜¯ä¸ºå¸¦æœ‰è§¦æ‘¸å±çš„æ‰‹æŒè®¾å¤‡å‡†å¤‡çš„ã€‚ä½œä¸ºæä¾›ç»™ç”¨æˆ·æœ€é‡è¦çš„äº¤äº’æ–¹å¼ä¹‹ä¸€ï¼Œäº†è§£è§¦æ‘¸ç³»ç»Ÿæ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼Œå¯¹äºå®é™…çš„é¡¹ç›®å¼€å‘æœ‰ç€éå¸¸å¤§çš„å¸®åŠ©</p>
<p>æœ¬ç¯‡æ˜¯å›¾å½¢ç³»åˆ—çš„ç¬¬äº”ç¯‡æ–‡ç« ï¼Œåœ¨ä¹‹å‰çš„å‡ ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬åˆ†åˆ«äº†è§£äº† Android ç³»ç»Ÿ<a href="https://juejin.cn/post/7132777622487957517">[æ¸²æŸ“/åˆæˆçš„åº•å±‚åŸç†]</a>å’Œ<a href="https://juejin.cn/post/7140332948485570596">[è‡ªå®šä¹‰ View / ViewGroup çš„æµç¨‹]</a></p>
<p>ä»Šå¤©æˆ‘ä»¬æ¥èŠèŠå›¾å½¢ç³»ç»Ÿä¸­ï¼Œå¦ä¸€ä¸ªè€ç”Ÿå¸¸è°ˆçš„è¯é¢˜ï¼š<strong>äº‹ä»¶åˆ†å‘</strong></p>
<p>å’Œä»¥å¾€ç›¸æ¯”ï¼Œä»Šå¤©çš„æ–‡ç« ä¼šç¨å¾®æœ‰é‚£ä¹ˆä¸€ç‚¹ç‚¹ä¸ä¸€æ ·</p>
<p>æˆ‘ä»¬ä¼šä»è®¤è¯†ç¡¬ä»¶é©±åŠ¨å¼€å§‹ï¼Œè‡ªåº•å‘ä¸Šï¼Œä¸€æ­¥æ­¥çš„æ¥äº†è§£ï¼Œäº‹ä»¶æ˜¯æ€ä¹ˆåˆ°è¾¾çš„ç³»ç»Ÿå†…æ ¸ï¼Œå†…æ ¸åˆæ˜¯æ€ä¹ˆä¼ é€’åˆ°åº”ç”¨ï¼Œä»¥åŠåº”ç”¨æœ€ç»ˆæ˜¯å¦‚ä½•æ¶ˆè´¹æ‰äº‹ä»¶çš„</p>
<p>åºŸè¯ä¸å¤šè¯´ï¼Œæˆ‘ä»¬ç›´æ¥è¿›å…¥æ­£é¢˜ï¼Œlet's go</p>
<blockquote>
<p><em>å‰æ’æé†’ï¼šå…¨æ–‡ 1.5w å­—ï¼Œå»ºè®®é˜…è¯»æ—¶é•¿ 30 åˆ†é’Ÿ</em></p>
</blockquote>
<figure data-type="image" tabindex="1"><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/be3079e548ac414c883c88b64ae38ca6~tplv-k3u1fbpfcp-watermark.image?" alt="android_graphic_v5_overview.png" loading="lazy"></figure>
<h1 id="ä¸€-è§¦æ‘¸äº‹ä»¶çš„èµ·æºlinux-kernel">ä¸€ã€è§¦æ‘¸äº‹ä»¶çš„èµ·æºï¼ˆLinux Kernelï¼‰</h1>
<p>Android è¾“å…¥äº‹ä»¶çš„ç±»å‹ï¼Œå’Œåˆ†å‘çš„æµç¨‹éƒ½æ¯”è¾ƒå¤æ‚ï¼Œé™¤äº†è§¦æ‘¸äº‹ä»¶å¤–ï¼Œç³»ç»Ÿè¿˜æœ‰æ¥è‡ª<code>é¼ æ ‡</code>ã€<code>é”®ç›˜</code>ã€<code>éŸ³é‡é”®</code>ã€<code>ç”µæºé”®</code>ç­‰å…¶ä»– Input è®¾å¤‡çš„äº‹ä»¶éœ€è¦å¤„ç†</p>
<p>æˆ‘ä»¬æ—¥å¸¸å¼€å‘æ¥è§¦æ¯”è¾ƒå¤šçš„æ˜¯ â€˜è§¦æ‘¸äº‹ä»¶â€™ï¼Œå› æ­¤ï¼Œæœ¬æ–‡ä¸»è¦è®¨è®ºçš„æ˜¯ â€˜è§¦æ‘¸äº‹ä»¶â€™ çš„åˆ†å‘æµç¨‹ï¼Œå…¶ä»–ç±»å‹çš„è¾“å…¥äº‹ä»¶é¡ºå¸¦ä¼šæä¸€å˜´ï¼Œä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹</p>
<p>æœ¬æ–‡ä¸€å…±åˆ†ä¸ºä¸‰å¤§éƒ¨åˆ†ï¼š</p>
<p>ç¬¬ä¸€éƒ¨åˆ†ä»‹ç» â€˜<code>è§¦æ‘¸äº‹ä»¶çš„èµ·æº</code>â€™ ï¼Œä¸»è¦è®²çš„æ˜¯é©±åŠ¨ä¸ŠæŠ¥åŸå§‹äº‹ä»¶ï¼Œå†…æ ¸è§£æåŸå§‹äº‹ä»¶å¹¶ä¿å­˜åˆ°è®¾å¤‡æ–‡ä»¶ä¸­ï¼Œä»¥ä¾› Framework è¯»å–åˆ†å‘</p>
<p>ç¬¬äºŒéƒ¨åˆ†ä»‹ç» â€˜<code>è§¦æ‘¸äº‹ä»¶çš„ä¼ é€’</code>â€™ ï¼Œä¸»è¦è®²çš„æ˜¯ InputManagerService æ€ä¹ˆæŠŠäº‹ä»¶ä¼ é€’åˆ°åº”ç”¨è¿›ç¨‹ï¼Œå¹¶åˆ†å‘ç»™ç›®æ ‡ Window</p>
<p>ç¬¬ä¸‰éƒ¨åˆ†ä»‹ç» â€˜<code>è§¦æ‘¸äº‹ä»¶çš„æ¶ˆè´¹</code>â€™ ï¼Œè¿™æ˜¯æˆ‘ä»¬åº”ç”¨å¼€å‘è€…æœ€ç†Ÿæ‚‰çš„äº‹ä»¶åˆ†å‘/æ‹¦æˆªçš„è¿‡ç¨‹ï¼Œä¸»è¦è®²çš„æ˜¯ ViewGroup / View çš„å‡ ä¸ªå…³é”®æ–¹æ³•ä»¥åŠä½¿ç”¨åœºæ™¯</p>
<p>åœ¨æ–‡ç« çš„å¼€å¤´ï¼Œæˆ‘ä»¬å…ˆæ¥èŠèŠç¬¬ä¸€éƒ¨åˆ†çš„å†…å®¹ï¼Œè§¦æ‘¸äº‹ä»¶çš„èµ·æº</p>
<h2 id="ä»ç¡¬ä»¶åˆ°å†…æ ¸">ä»ç¡¬ä»¶åˆ°å†…æ ¸</h2>
<p>åœ¨<a href="https://mp.weixin.qq.com/s/JeGPyknzc0G_TCQNHZD3AQ">ã€Šå½“æˆ‘ä»¬ç‚¹å‡»â€œå¾®ä¿¡â€åº”ç”¨åï¼Œå®ƒæ˜¯æ€ä¹ˆæ˜¾ç¤ºå‡ºæ¥çš„ï¼Ÿã€‹</a>è¿™ç¯‡æ–‡ç« ä¸­ï¼Œä¸ºäº†ææ¸…æ¥š Android è®¾å¤‡çš„ç»˜å›¾ç¡¬ä»¶æ˜¯ä»€ä¹ˆï¼Œæˆ‘ä»¬æ‹†äº†ä¸€å° å°ç±³11 æ‰‹æœº</p>
<p>ä»Šå¤©ï¼Œæˆ‘ä»¬ç»§ç»­æ¥æ‹†å°ç±³</p>
<figure data-type="image" tabindex="2"><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/16fb8b07a3be49dc93c21796f2859b2b~tplv-k3u1fbpfcp-watermark.image?" alt="android_graphic_v5_mi10.png" loading="lazy"></figure>
<p><em>å›¾ç‰‡æ¥æºï¼š<a href="https://www.laoyaoba.com/n/748691">ã€é›†å¾®æ‹†è¯„ã€‘å°ç±³10æ‹†è§£ï¼šå†…éƒ¨å¸ƒå±€ä¸iPhoneç›¸ä¼¼ï¼Œ1äº¿åƒç´ ä¸»æ‘„å¸ç›</a></em></p>
<p>å¦‚ä¸Šå›¾ï¼Œè¿™æ˜¯æ‹†è§£å å°ç±³10 çš„å†…éƒ¨å¸ƒå±€ï¼Œå›¾ä¸­å·¦è¾¹é»„è‰²ç®­å¤´æ‰€æŒ‡çš„éƒ¨åˆ†ï¼Œæ˜¯è§¦æ‘¸å±çš„<code>è§¦æ§èŠ¯ç‰‡</code></p>
<p>ç±³10 <code>è§¦æ§èŠ¯ç‰‡</code>ä½¿ç”¨çš„æ˜¯ï¼Œæ¥è‡ªæ„æ³•åŠå¯¼ä½“çš„ &quot;<code>FJABH</code>&quot;ï¼Œè¿™å—èŠ¯ç‰‡æ˜¯ç”¨æ¥å¹²å˜›çš„å‘¢ï¼Ÿ</p>
<p>ç”¨æ¥å’Œ CPU è¿›è¡Œé€šä¿¡çš„</p>
<figure data-type="image" tabindex="3"><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e1fcf2e034e142e9a1c5ea0755214a6a~tplv-k3u1fbpfcp-watermark.image?" alt="android_graphic_v5_ic_touch.png" loading="lazy"></figure>
<p><em>å›¾ç‰‡æ˜¯é‡ç»˜ç‰ˆï¼Œå‚è€ƒè‡ªï¼šhttps://blog.csdn.net/qq_39797956/article/details/118863217</em></p>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œå½“æˆ‘ä»¬æŒ‰ä¸‹è§¦æ‘¸å±åï¼Œå±å¹•çš„ç”µå‹/ç”µæµå¤§å°ä¼šå‘ç”Ÿå˜åŒ–ï¼ˆ<em>ä¸å±•å¼€è®¨è®ºè§¦æ‘¸å±å·¥ä½œåŸç†</em>ï¼‰</p>
<p>å˜åŒ–çš„ç”µå‹/ç”µæµä¼šè¢«å›¾ä¸­é—´çš„<code>è§¦æ§ IC </code>æ•è·ï¼Œæ¥ç€è®¡ç®—å‡ºè§¦æ‘¸ä½ç½®çš„åæ ‡å€¼ï¼Œé€šè¿‡<code>IÂ²C</code>æ€»çº¿ï¼ˆ<em>å¦‚ä¸Šå›¾</em>ï¼‰å‘é€åˆ°ä¸»æ¿ä¸Šçš„ CPU</p>
<p><a href="https://elixir.bootlin.com/linux/v4.4.1/source/drivers/i2c"> IÂ²C </a>æ˜¯ç¡¬ä»¶ä¹‹é—´å¸¸ç”¨çš„ä¸€ç§é€šä¿¡åè®®ï¼Œå®ƒè§„å®šäº†ä»€ä¹ˆè¡¨ç¤ºèµ·å§‹ã€åœæ­¢ã€åº”ç­”å’Œéåº”ç­”ç­‰ä¸€ç³»åˆ—ä¿¡å·</p>
<p>å½“ç„¶ï¼Œä½œä¸ºåº”ç”¨å¼€å‘ï¼Œæˆ‘ä»¬æ— éœ€å…³å¿ƒä»–ä»¬çš„é€šä¿¡ç»†èŠ‚</p>
<p>æˆ‘ä»¬åªéœ€è¦çŸ¥é“ï¼š &quot;<strong>ä¸€æ—¦è§¦æ‘¸å±çš„ä¿¡å·å‘ç”Ÿå˜åŒ–ï¼Œ<code>è§¦æ§èŠ¯ç‰‡</code>å°±èƒ½é€šè¿‡ <code>IÂ²C</code> æ€»çº¿é€šçŸ¥åˆ° CPU</strong> &quot;ã€‚äº†è§£è¿™ä¸€ç‚¹å°±å¤Ÿäº†</p>
<p>å¥½äº†ï¼Œç°åœ¨è§¦æ‘¸ä¿¡å·å·²ç»èƒ½è¢« CPU è¯»å–äº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ CPU ï¼Œä¹Ÿå°±æ˜¯æ“ä½œç³»ç»Ÿå¦‚ä½•å¤„ç†è§¦æ‘¸ä¿¡å·</p>
<h2 id="å†…æ ¸åˆ›å»ºè®¾å¤‡æ–‡ä»¶">å†…æ ¸åˆ›å»ºè®¾å¤‡æ–‡ä»¶</h2>
<p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒGoogle ä½¿ç”¨ Linux ä½œä¸º Android ç³»ç»Ÿçš„å†…æ ¸ï¼Œç®¡ç†ç€ä¸»æ¿ä¸Šçš„ <code>å†…å­˜</code>ã€<code>ç½‘å¡</code>ã€<code>ç¡¬ç›˜</code> ç­‰ç¡¬ä»¶è®¾å¤‡ï¼Œå…¶ä¸­ä¹ŸåŒ…æ‹¬ <code>CPU</code></p>
<p>åœ¨ä¸Šä¸€å°èŠ‚ä¸­ï¼Œè§¦æ‘¸å±å·²ç»å’Œ CPU å»ºç«‹äº†é€šä¿¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ“ä½œç³»ç»Ÿå¯ä»¥è¯»å–è§¦æ‘¸å±å‘é€è¿‡æ¥çš„ä¿¡å·äº†</p>
<p>æ¥ä¸‹æ¥çš„å·¥ä½œé‡ç‚¹åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œ<strong>ä¸€æ˜¯åˆ¶å®šè§¦æ‘¸å±å…·ä½“çš„ä¸ŠæŠ¥è§„åˆ™ï¼›äºŒæ˜¯æƒ³åŠæ³•æŠŠè®¾å¤‡å‘ç”Ÿçš„äº‹ä»¶æŠ¥å‘Šç»™åº”ç”¨ç¨‹åº</strong></p>
<p>å…ˆæ¥çœ‹è®¾å¤‡çš„ä¸ŠæŠ¥è§„åˆ™ï¼Œæˆ‘ä»¬ä»¥é”®ç›˜äº‹ä»¶ä¸¾ä¾‹ï¼ŒåŒæ ·éƒ½æ˜¯æŒ‰ä¸‹ '<code>A</code>' æŒ‰é”®</p>
<blockquote>
<p><em><code>è¾¾å°”ä¼˜</code></em> é”®ç›˜ä¸ŠæŠ¥çš„æ˜¯ï¼š<code>0010</code></p>
<p><em><code>ç½—æŠ€</code></em> é”®ç›˜ä¸ŠæŠ¥çš„æ˜¯ï¼š<code>0001</code></p>
</blockquote>
<p>åŒä¸€ä¸ªæŒ‰é”®äº‹ä»¶ï¼Œä¸¤ä¸ªé”®ç›˜å‚å•†ä¸ŠæŠ¥çš„æŒ‰é”®å€¼å´ä¸ç›¸åŒï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸è¡Œçš„ã€‚</p>
<p>æ‰€ä»¥ï¼Œåªæœ‰ä¸Šä¸€å°èŠ‚çš„é€šä¿¡è§„åˆ™ï¼ˆ<em>IÂ²C</em>ï¼‰è¿˜ä¸å¤Ÿï¼Œæˆ‘ä»¬è¿˜éœ€è¦åˆ¶å®šä¸€ä¸ªå†…å®¹è§„åˆ™ï¼Œæ¥è§„èŒƒå„ä¸ªå‚å®¶å‘é€çš„æ•°æ®å†…å®¹</p>
<p>è¯´åˆ°è¾“å…¥è§„èŒƒï¼Œè¿™å°±ä¸èƒ½ä¸æ Linux çš„ Input å­ç³»ç»Ÿäº†</p>
<p>åœ¨ 2001 å¹´å‘å¸ƒçš„ <a href="https://elixir.bootlin.com/linux/2.4.0/source/drivers/input"><em>[2.4.0</em>]</a> ç‰ˆæœ¬ï¼ŒLinux é¦–æ¬¡åŠ å…¥äº† Input å­ç³»ç»Ÿçš„ä»£ç ï¼Œä¸ºçš„å°±æ˜¯å°†è¾“å…¥è®¾å¤‡çš„å…±æ€§æŠ½è±¡å‡ºæ¥ï¼Œåˆ¶å®šç»Ÿä¸€çš„è¾“å…¥è§„åˆ™</p>
<p>é¦–å‘ç‰ˆæœ¬åªæ”¯æŒ <code>æ‰‹æŸ„</code>ã€<code>é¼ æ ‡</code> å’Œ <code>é”®ç›˜</code> è¿™ä¸‰ç§ç¡¬ä»¶ï¼Œåœ¨éšå 2002 å¹´å‘å¸ƒçš„ <a href="https://elixir.bootlin.com/linux/v2.5.25/source/drivers/input"><em>[2.5.25</em>]</a> ç‰ˆæœ¬ä¸­ï¼ŒåŠ å…¥äº†å¯¹ <code>è§¦æ‘¸å±</code> çš„æ”¯æŒ</p>
<p>è¿™æ ·ä¸€æ¥ï¼Œå‚å•†åªéœ€è¦æŒ‰ç…§ Linux åˆ¶å®šçš„è§„èŒƒï¼Œæ¥ä¸ŠæŠ¥<code>æŒ‰é”®å€¼</code>ã€<code>å±å¹•åæ ‡</code>ç­‰ä¿¡æ¯å³å¯ï¼Œä¸ŠæŠ¥è§„åˆ™çš„é—®é¢˜å°±è§£å†³äº†</p>
<p>é™¤äº†è§„èŒƒè¾“å…¥å†…å®¹ï¼ŒInput å­ç³»ç»Ÿè¿˜ä¸ºåº”ç”¨ç¨‹åºæä¾›äº† <code>æ“ä½œ/è¯»å–</code> è¾“å…¥è®¾å¤‡çš„æ¥å£ï¼Œæ¥çœ‹æ¡†æ¶å›¾ï¼š</p>
<figure data-type="image" tabindex="4"><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c0b059bcf09b4b8d9af8ebdd5468968d~tplv-k3u1fbpfcp-watermark.image?" alt="android_graphic_v5_linux_input_system.png" loading="lazy"></figure>
<p><em>å›¾ç‰‡æ¥æºï¼šè‡ªå·±ç”»çš„</em></p>
<p>å¦‚å›¾ï¼ŒInput å­ç³»ç»Ÿåˆ†ä¸ºä¸‰å±‚ï¼š</p>
<ul>
<li>
<p><strong>æœ€ä¸‹å±‚ï¼šè¾“å…¥è®¾å¤‡é©±åŠ¨å±‚ï¼Œ<code>drivers/input/xxx</code>ï¼Œè¿™é‡Œå°±æ˜¯å„å¤§å‚å•†éœ€è¦éµå¾ªçš„åè®®è§„èŒƒï¼Œå‘å†…æ ¸å±‚æŠ¥å‘Šè¾“å…¥çš„å†…å®¹</strong></p>
</li>
<li>
<p><strong>ä¸­é—´å±‚ï¼šè¾“å…¥æ ¸å¿ƒå±‚ï¼Œ<code>input.c</code> å±äºè¿™ä¸€å±‚ã€‚è¿™æ˜¯ Linux æ ¸å¿ƒé€»è¾‘ï¼Œç”¨æ¥ç®¡ç†è®¾å¤‡æ·»åŠ ã€å¸è½½ç­‰æ“ä½œï¼Œäº‹ä»¶æä¾›ç»™åº”ç”¨å‰çš„å‡†å¤‡å·¥ä½œ</strong></p>
</li>
<li>
<p><strong>æœ€ä¸Šå±‚ï¼šè¾“å…¥äº‹ä»¶é©±åŠ¨å±‚ï¼Œåˆ°è¿™é‡Œç¡¬ä»¶é©±åŠ¨å·²ç»æŠ½è±¡ä¸ºè®¾å¤‡æ–‡ä»¶äº†ï¼Œå¯¹åº” <code>/dev/input/xxx</code> ï¼Œç¡¬ä»¶é©±åŠ¨å‘é€çš„æ•°æ®å°±ä¿å­˜åœ¨è¯¥è·¯å¾„ä¸‹çš„å„ä¸ªè®¾å¤‡æ–‡ä»¶ä¸­ï¼Œç­‰å¾…åº”ç”¨è¯»å–</strong></p>
</li>
</ul>
<p>æœ€ä¸‹é¢çš„ Drivers å±‚ï¼Œæ˜¯ Linux å¹³å°å¯¹å„ç§è¾“å…¥è®¾å¤‡çš„è§„èŒƒï¼Œå„å¤§å‚å•†éƒ½éœ€è¦å»éµå¾ªè¯¥åè®®ï¼Œå¦åˆ™ Linux å†…æ ¸æ— æ³•è¯†åˆ«ï¼Œè®¾å¤‡ä¹Ÿå°±æ— æ³•æ­£å¸¸å·¥ä½œ</p>
<p>ç„¶åæ˜¯ä¸­é—´çš„æ ¸å¿ƒå±‚ï¼Œå®ƒæ˜¯è¾“å…¥è®¾å¤‡é©±åŠ¨çš„ç®¡ç†å±‚ï¼Œåœ¨è¾“å…¥æ¡†æ¶ä¸­èµ·ç€æ‰¿ä¸Šå¯ä¸‹çš„ä½œç”¨ï¼š<strong>å‘ä¸‹æä¾›é©±åŠ¨å±‚çš„æ¥å£ï¼Œå‘ä¸Šæä¾›äº‹ä»¶å¤„ç†å±‚çš„æ¥å£</strong></p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸€çœ¼ input.c ä¸­çš„å‡ ä¸ªå…³é”®æ–¹æ³•ï¼Œä¹Ÿå°±å¤§æ¦‚çŸ¥é“å®ƒæä¾›äº†å“ªäº›åŠŸèƒ½</p>
<pre><code class="language-c">/drivers/input/input.c
class input { //Linux input æ¡†æ¶çš„æ ¸å¿ƒå±‚ï¼Œä¸ºé©±åŠ¨å±‚æä¾›è®¾å¤‡æ³¨å†Œå’Œæ“ä½œæ¥å£

  	/* è®¾å¤‡æ³¨å†Œ */
    int input_register_device(input_dev *dev); // æ³¨å†Œä¸€ä¸ª input è®¾å¤‡åˆ°å†…æ ¸
    void input_unregister_device(input_dev *dev); // ä»å†…æ ¸æ³¨é”€æ‰ä¸€ä¸ª input è®¾å¤‡

  	/* è®¾å¤‡è¿æ¥ */
    int input_attach_handler(input_dev *dev, input_handler *handler);
  	void input_disconnect_device(input_dev *dev);
  
  	/* äº‹ä»¶ä¸ŠæŠ¥ */
  	void input_handle_event(input_dev *dev, type, code, value);
  
  	/* åº”ç”¨ç¨‹åºæ•°æ®è¯»å– */
  	int input_event_to_user(input_dev *dev, type, code, value);

}
</code></pre>
<p>ä»ä»£ç æ¥çœ‹ï¼Œæ ¸å¿ƒå±‚è´Ÿè´£ <code>è®¾å¤‡çš„æ³¨å†Œ</code>ã€<code>è®¾å¤‡çš„è¿æ¥</code>ã€<code>äº‹ä»¶ä¸ŠæŠ¥</code> å’Œ <code>æ•°æ®è¯»å–</code> è¿™å‡ ä»¶äº‹ï¼Œå…·ä½“çš„å®ç°é€»è¾‘æˆ‘ä»¬è¿™é‡Œä¸å±•å¼€è®¨è®ºï¼Œå¤ªé•¿äº†ã€‚</p>
<p>åœ¨ Input å­ç³»ç»Ÿçš„æœ€ä¸Šå±‚ï¼ˆHandlersï¼‰ï¼Œäº‹ä»¶é©±åŠ¨å±‚è´Ÿè´£çš„æ˜¯ï¼Œ<strong>ä¸ºç”¨æˆ·è®¿é—®æä¾›æ¥å£ï¼Œå°†ç¡¬ä»¶é©±åŠ¨å±‚å‘é€çš„æ¶ˆæ¯æŠ¥å‘Šç»™ç”¨æˆ·</strong></p>
<p>æˆ‘ä»¬å¯ä»¥åœ¨ <code>/dev/input/xxx</code> æ‰¾åˆ°æ‰€æœ‰å·²åŠ è½½æˆåŠŸçš„è¾“å…¥è®¾å¤‡ï¼Œå®ƒä»¬å°±æ˜¯äº‹ä»¶é©±åŠ¨å±‚åˆ›å»ºçš„è®¾å¤‡æ–‡ä»¶</p>
<figure data-type="image" tabindex="5"><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a98094cfb2004478adf3c7a4f3b67b60~tplv-k3u1fbpfcp-watermark.image?" alt="android_graphic_v5_pixel3_devices.jpg" loading="lazy"></figure>
<p><em>å›¾ç‰‡æ¥æºï¼šè‡ªå·±æˆªçš„</em></p>
<p>å¦‚å›¾æ‰€ç¤ºï¼Œæˆ‘æ‰‹é‡Œçš„ Pixel 3 åœ¨ <code>/dev/input/</code> è¿™ä¸ªè·¯å¾„ä¸‹ï¼Œå‘ç°äº†4ä¸ªè¾“å…¥è®¾å¤‡ï¼Œä» <code>event0</code> åˆ° <code>event3</code></p>
<p>æˆ‘ä»¬å¯ä»¥ç”¨ ' <code>cat /proc/bus/input/devices</code> ' å‘½ä»¤ï¼ŒæŸ¥çœ‹æ¯ä¸ªè¾“å…¥è®¾å¤‡çš„ä¿¡æ¯ï¼Œæˆ‘è¿™å°æ‰‹æœº <code>event2</code> èŠ‚ç‚¹æ˜¯è§¦æ‘¸å±çš„è®¾å¤‡æ–‡ä»¶ï¼ˆ<em>' <code>name = fts</code> ' è¡¨ç¤ºçš„è§¦æ§é©±åŠ¨å‚å•†æ˜¯ '<code>æ•¦æ³°</code>'</em>ï¼‰</p>
<p>æ¥ç€ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ç”¨ '<code>getevent</code>' å‘½ä»¤æ‰“å¼€è¿™ä¸ªè®¾å¤‡æ–‡ä»¶ï¼Œè·å–å®ƒå‘é€çš„åŸå§‹æ•°æ®</p>
<figure data-type="image" tabindex="6"><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/69f3437a220d46e29090b0cac4d5c27d~tplv-k3u1fbpfcp-watermark.image?" alt="android_graphic_v5_pixel3_getevent.GIF" loading="lazy"></figure>
<p><em>å›¾ç‰‡æ¥æºï¼šè‡ªå·±å½•çš„</em></p>
<p>ä½ çœ‹ï¼Œå½“æˆ‘ä»¬æ»‘åŠ¨å±å¹•æ—¶ï¼Œç»ˆç«¯çª—å£ä¼šä¸åœçš„æ‰“å°æ¥è‡ª <code>event2</code> çš„è§¦æ‘¸äº‹ä»¶æ¶ˆæ¯</p>
<p>å¥½ï¼Œç°åœ¨è§¦æ‘¸äº‹ä»¶å·²ç»èƒ½è¢«åº”ç”¨ç¨‹åºè¯»å–äº†ï¼Œæˆ‘ä»¬æ¥ç®€å•æ€»ç»“ä¸‹ç¬¬ä¸€éƒ¨åˆ† â€˜è§¦æ‘¸äº‹ä»¶çš„èµ·æºâ€™ çš„å†…å®¹ï¼š</p>
<p>é¦–å…ˆï¼ŒæŒ‰ä¸‹è§¦æ‘¸å±åï¼Œ<code>è§¦æ§èŠ¯ç‰‡</code>æ•è·åˆ°ç”µå‹/ç”µæµçš„å˜åŒ–ï¼Œè®¡ç®—å‡ºä½ç½®åæ ‡åï¼Œé€šè¿‡<code> IÂ²C</code> æ€»çº¿æ±‡æŠ¥ç»™ CPU</p>
<p>æ¥ç€ï¼Œæˆ‘ä»¬éœ€è¦ç»Ÿä¸€é€šä¿¡å†…å®¹çš„è§„åˆ™ï¼Œåœ¨ Linux å¹³å°ä¸‹ï¼Œè§¦æ§èŠ¯ç‰‡éœ€è¦å®ç° <code>input.c</code> åè®®ï¼Œäº‹ä»¶æŒ‰ç…§è§„å®šçš„åè®®ä¸ŠæŠ¥ç»™å†…æ ¸ç³»ç»Ÿ</p>
<p>æœ€åï¼Œç­‰åˆ°è®¾å¤‡å¼€æœºï¼Œå†…æ ¸åŠ è½½è§¦æ‘¸å±é©±åŠ¨ï¼Œå†ç„¶åæ˜¯è®¾å¤‡çš„<code>æ³¨å†Œ/è¿æ¥/ä¸ŠæŠ¥</code>çš„è¿‡ç¨‹</p>
<p>åˆ°è¿™é‡Œï¼Œå†…æ ¸å·²ç»ä¸ºæˆ‘ä»¬æ”¶é›†å¥½è§¦æ‘¸å±çš„è¾“å…¥äº‹ä»¶ï¼Œå¹¶å­˜æ”¾åœ¨äº† <code>eventX</code> è®¾å¤‡æ–‡ä»¶ä¸­ï¼ŒLinux Input å­ç³»ç»Ÿçš„ä»»åŠ¡å·²ç»å®Œæˆ</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ Android ç³»ç»Ÿçš„æ¡†æ¶å±‚ï¼ˆFrameworkï¼‰æ˜¯å¦‚ä½•å¤„ç†è§¦æ‘¸äº‹ä»¶çš„</p>
<h1 id="äºŒ-è§¦æ‘¸äº‹ä»¶çš„ä¼ é€’android-framework">äºŒã€è§¦æ‘¸äº‹ä»¶çš„ä¼ é€’ï¼ˆAndroid Frameworkï¼‰</h1>
<p>ä¸Šå›ä¹¦è¯´åˆ°ï¼Œè§¦æ‘¸å±ä¸ŠæŠ¥çš„äº‹ä»¶å·²ç»ä¿å­˜åˆ° <code>/dev/input/xxx</code> è®¾å¤‡æ–‡ä»¶ä¸­ï¼Œé‚£ä¹ˆç³»ç»Ÿæ¥ä¸‹æ¥çš„ä»»åŠ¡æ˜¯ï¼š</p>
<p>è¯»å–è§¦æ‘¸äº‹ä»¶ï¼Œå¹¶å°è£…æˆ <code>MotionEvent</code> / <code>KeyEvent</code> å¯¹è±¡ï¼Œæœ€ååˆ†å‘ç»™æ­£åœ¨è¿è¡Œçš„ APP ä½¿ç”¨</p>
<p>â€<strong>è¯»å–</strong>â€œ å’Œ â€œ<strong>åˆ†å‘</strong>â€ ï¼Œæ˜¯ Android Framework çš„ä¸»çº¿ä»»åŠ¡</p>
<p>åœ¨æ¥ä¸‹æ¥çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ä¸»è¦å›´ç»•ç€è¿™ä¸¤ä»¶äº‹å±•å¼€</p>
<blockquote>
<p>psï¼šæœ¬ç« èŠ‚çš„ '<code>äº‹ä»¶åˆ†å‘</code>' æ¢è®¨çš„æ˜¯ï¼Œå¦‚ä½•å°†è§¦æ‘¸äº‹ä»¶ä»è®¾å¤‡æ–‡ä»¶ä¼ é€’åˆ° APP è¿›ç¨‹ï¼Œå’Œ View çš„äº‹ä»¶åˆ†å‘ä¸æ˜¯ä¸€å›äº‹å„¿ï¼Œæ³¨æ„åˆ«ææ··äº†</p>
</blockquote>
<h2 id="åˆè¯†-inputmanagerservice">åˆè¯† InputManagerService</h2>
<p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œåœ¨ Framework ä¸­ï¼Œè¾“å…¥äº‹ä»¶æ˜¯ç”± InputManagerServiceï¼ˆåç»­ç®€ç§°IMSï¼‰ æ¥ç®¡ç†</p>
<p>æˆ‘ä»¬åˆçŸ¥é“ï¼ŒInputManagerService æ˜¯ Java å±‚ä»£ç ï¼Œä¸å¯èƒ½ç›´æ¥è°ƒç”¨åˆ° Linux å†…æ ¸å±‚çš„ Input æ¡†æ¶æ¥è·å–è¾“å…¥äº‹ä»¶</p>
<p>å› æ­¤ï¼ŒIMS å¿…ç„¶éœ€è¦ native å±‚çš„æ”¯æŒï¼Œæ‰èƒ½å®ç°å¯¹äº‹ä»¶çš„è¯»å–ä¸åˆ†å‘</p>
<p>å®é™…çš„ InputManagerService å®ç°ä¸€å…±åˆ†ä¸ºä¸‰å±‚</p>
<ol>
<li><strong>native å±‚ï¼Œè¿™æ˜¯ IMS çš„æ ¸å¿ƒå±‚ï¼Œè´Ÿè´£ <code>è¯»å–/åˆ†å‘</code> äº‹ä»¶ï¼Œ<code>EventHub.cpp</code>ã€<code>InputReader.cpp</code>ã€<code>InputDispatcher.cpp</code> ä¸‰å‘˜å¤§å°†éƒ½åœ¨è¿™</strong></li>
<li><strong>jni å±‚ï¼Œä¸»è¦æ˜¯å¯¹ natvie åšè½¬å‘ï¼Œå¦å¤–è´Ÿè´£åˆ›å»ºå¯¹è±¡å•¥çš„ï¼Œä¸æ€ä¹ˆéœ€è¦å…³æ³¨</strong></li>
<li><strong>Java å±‚ï¼Œä¸»è¦è´Ÿè´£é€šä¿¡éƒ¨åˆ†ï¼Œå’Œ WMS åŒæ­¥çª—å£æ•°æ®å•¦ï¼Œå’Œ APP è·¨è¿›ç¨‹é€šä¿¡å•¦ç­‰ç­‰</strong></li>
</ol>
<p>åœ¨è¿™å…¶ä¸­ï¼Œåªæœ‰ native å±‚ç¨å¾®æœ‰é‚£ä¹ˆä¸€ç‚¹ç‚¹å¤æ‚ï¼Œå› ä¸ºæ•°æ®çš„è¯»å–å’Œåˆ†å‘éƒ½å‘ç”Ÿåœ¨ native å±‚</p>
<p>å¥½ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥è®¤è¯† native å±‚çš„ä¸»åŠ›äººå‘˜</p>
<p>æ³¨æ„ï¼Œæˆ‘ä»¬æœ¬å°èŠ‚åªå…³æ³¨ native ä¸­å„ä¸ªè§’è‰²æœ‰å“ªäº›æ–¹æ³•åŠŸèƒ½ï¼Œåšäº†å“ªäº›äº‹æƒ…</p>
<p>è‡³äºå¯¹è±¡ä»€ä¹ˆæ—¶å€™åˆ›å»ºï¼Œè¿è¡Œåœ¨å“ªä¸ªè¿›ç¨‹ï¼Œå“ªä¸ªçº¿ç¨‹ï¼Œè¿™ä¸ªåé¢ä¼šè®²åˆ°ï¼Œä¸æ˜¯æœ¬å°èŠ‚å…³æ³¨çš„é‡ç‚¹</p>
<h3 id="1-eventhub">1ã€EventHub</h3>
<p>EventHub çš„ä½œç”¨æ˜¯ç›‘å¬ã€è¯»å– <code>/dev/input</code> ç›®å½•ä¸‹äº§ç”Ÿçš„æ–°äº‹ä»¶ï¼Œå¹¶å°è£…æˆ <code>RawEvent</code> ç»“æ„ä½“ä¾›å…¶ä»–äººä½¿ç”¨</p>
<p>æ–‡ä»¶åœ¨ frameworks/native/services/inputflinger/EventHub.cpp</p>
<p>æˆ‘ä»¬æ¥çœ‹ EventHub ä¸­çš„å…³é”®æ–¹æ³•</p>
<pre><code class="language-c++">//frameworks/native/services/inputflinger/EventHub.cpp
class EventHub {

    EventHub::EventHub(void)  {
        mEpollFd = epoll_create(EPOLL_SIZE_HINT); // åˆ›å»º epollï¼Œç”¨äºç›‘å¬è®¾å¤‡æ–‡ä»¶æ˜¯å¦æœ‰å¯è¯»äº‹ä»¶
        mINotifyFd = inotify_init(); // åˆ›å»º inotify ï¼Œç”¨äºç›‘å¬æ–‡ä»¶ç³»ç»Ÿæ˜¯å¦å˜åŒ–ï¼Œæœ‰å˜åŒ–è¯´æ˜å‘ç”Ÿè®¾å¤‡æ’æ‹”
    }

    size_t EventHub::getEvents( timeoutMillis, buffer, bufferSize) {
        //getEvents() æ˜¯ IMS çš„æ ¸å¿ƒï¼Œè¯¥æ–¹æ³•ä¸€å…±åšäº†ä¸¤ä»¶äº‹
        // 1. ç›‘å¬è®¾å¤‡æ’æ‹”åŠ¨ä½œï¼Œæ‰§è¡Œå¯¹åº”çš„è®¾å¤‡çš„æ‰“å¼€/å¸è½½æ“ä½œï¼Œå¹¶ç”Ÿæˆ RawEvent ç»“æ„é€šçŸ¥è°ƒç”¨è€…
        // 2. ç›‘å¬è¾“å…¥è®¾å¤‡æ–‡ä»¶çš„äº‹ä»¶å˜åŒ–
        //å¦‚æœæ²¡æœ‰ä»»ä½•äº‹ä»¶å‘ç”Ÿï¼Œè°ƒç”¨ epoll_wait() å‡½æ•°æ‰§è¡Œç­‰å¾…
        return event - buffer; // è¿”å›è¯»å–åˆ°çš„äº‹ä»¶æ•°é‡
    }


}
</code></pre>
<p>EventHub åœ¨åˆå§‹åŒ–æ—¶ï¼Œä¼šåˆ›å»º <code>mEpollFd</code> å’Œ <code>mINotifyFd</code> ä¸¤ä¸ª Fdï¼Œåˆ©ç”¨ <code>INotify</code> æœºåˆ¶ç›‘å¬è®¾å¤‡å¢åˆ äº‹ä»¶ï¼Œåˆ©ç”¨ <code>Epoll</code> ç›‘å¬è®¾å¤‡æ–‡ä»¶è¯»å†™çŠ¶æ€å˜åŒ–</p>
<p>ç„¶åæ˜¯ <code>getEvents()</code> æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ç”¨æ¥è·å–å½“å‰çš„è®¾å¤‡äº‹ä»¶ï¼ŒåŒ…æ‹¬è®¾å¤‡æ•°é‡å˜åŒ–ï¼Œå’Œè®¾å¤‡ä¸ŠæŠ¥çš„äº‹ä»¶ï¼Œæ˜¯ IMS è·å–æ¶ˆæ¯çš„ â€œæ ¸å¿ƒæ–¹æ³•â€</p>
<p>å¦‚æœæ²¡æœ‰ä»»ä½•äº‹ä»¶å‘ç”Ÿï¼Œ<code>getEvents()</code> ä¼šå‘ç”Ÿé˜»å¡ï¼Œç›´åˆ°æœ‰äº‹ä»¶å‘ç”Ÿæ‰è¿”å›</p>
<p>EventHub æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹å›¾</p>
<figure data-type="image" tabindex="7"><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a9ccef4f808e408aad0affcb835bf2fa~tplv-k3u1fbpfcp-watermark.image?" alt="android_graphic_v5_native_1.png" loading="lazy"></figure>
<p><em>å›¾ç‰‡æ¥æºï¼šè‡ªå·±ç”»çš„</em></p>
<h3 id="2-inputreader">2ã€InputReader</h3>
<p>ä»ç±»çš„å‘½åå°±èƒ½çœ‹å‡ºæ¥ï¼ŒInputReader çš„èŒè´£æ˜¯è¯»å–è¾“å…¥æ¶ˆæ¯</p>
<p>ä¸è¿‡ï¼Œå®ƒå¯ä¸æ˜¯åªä¼šè¯»å–äº‹ä»¶ï¼Œæ‹¿åˆ°åŸå§‹äº‹ä»¶ä»¥åï¼Œè¿˜éœ€è¦è§£æäº‹ä»¶ï¼Œæ‹†è§£ä¸º<code>æŒ‰é”®</code>ã€<code>è§¦æ‘¸å±</code>ã€<code>é¼ æ ‡</code>ç­‰ï¼Œæ ¹æ®ä¸åŒçš„è¾“å…¥ï¼Œå°è£…æˆä¸åŒçš„å¯¹è±¡ï¼Œæäº¤åˆ°æ¶ˆæ¯é˜Ÿåˆ—ç­‰å¾…åˆ†å‘</p>
<p>æ‰€ä»¥ï¼ŒåŸå§‹äº‹ä»¶çš„è§£æã€è½¬æ¢ï¼Œæœ€åç”Ÿæˆ <code>KeyEvent</code>ã€<code>MotionEvent</code> å¯¹è±¡ï¼Œæ‰æ˜¯ InputReader çš„ä¸»è¦å·¥ä½œ</p>
<pre><code class="language-c++">/frameworks/native/services/inputflinger/InputReader.cpp
class InputReader {

    class InputReaderThread : Thread { //å†…éƒ¨ç±»

        /*InputReaderThread çº¿ç¨‹å¯åŠ¨åï¼Œå¾ªç¯å°†ä¸æ–­åœ°æ‰§è¡Œ InputReader#loopOnce()å‡½æ•°*/
        bool InputReaderThread::threadLoop() {
            mReader-&gt;loopOnce();
            return true;
        }
    }

    void InputReader::loopOnce(); // æ ¸å¿ƒæ–¹æ³•ï¼Œè´Ÿè´£è¯»å–äº‹ä»¶ï¼Œè§£æäº‹ä»¶
}
</code></pre>
<p>InputReader ç±»çš„æ ¸å¿ƒæ–¹æ³•æ˜¯ <code>InputReader#loopOnce()</code> ï¼Œå®ƒè´Ÿè´£è¯»å–äº‹ä»¶å’Œè§£æäº‹ä»¶</p>
<p><code>loopOnce()</code> æ–¹æ³•è¢« InputReaderThread çº¿ç¨‹çš„ <code>threadLoop()</code> æ‰€è°ƒç”¨ï¼ŒInputReaderThread æ˜¯ InputReader çš„å†…éƒ¨çº¿ç¨‹ç±»</p>
<p>å’Œ Java ä¸åŒï¼Œåœ¨ C++ ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦å°† <code>threadLoop()</code> è¿”å›å€¼è®¾ç½®ä¸º trueï¼Œå½“ InputReaderThread çº¿ç¨‹å¯åŠ¨åï¼Œ è¯¥æ–¹æ³•å°±ä¼šè¢«å¾ªç¯è°ƒç”¨ï¼Œä¸ç”¨æ‰‹åŠ¨å†™ <code>while(true)</code></p>
<p>InputReaderThread çº¿ç¨‹å¯åŠ¨æ—¶æœºæˆ‘ä»¬åé¢ä¼šè®²åˆ°ï¼Œå…ˆå›è¿‡å¤´æ¥çœ‹ <code>InputReader#loopOnce()</code> çš„å·¥ä½œ</p>
<pre><code class="language-c++">/frameworks/native/services/inputflinger/InputReader.cpp
class InputReader {
  
    // è¯»å–äº‹ä»¶ï¼Œè§£æäº‹ä»¶
    void InputReader::loopOnce() {
        int count = mEventHub-&gt;getEvents(); // è¯»æ¶ˆæ¯ï¼Œæœ‰æ¶ˆæ¯è¿”å›ï¼Œæ²¡æ¶ˆæ¯é˜»å¡åˆ° epoll()ã€‚ç”±äºäº‹ä»¶åˆ†å‘éœ€è¦æ—¶é—´ï¼Œæ‰€ä»¥å•æ¬¡è¯»å–çš„äº‹ä»¶å¯èƒ½æ˜¯å¤šä¸ª
        if(count) processEventsLocked();//è§£æåŸå§‹äº‹ä»¶ã€æäº¤åˆ°é˜Ÿåˆ—ç­‰å¾…åˆ†å‘
    }
}
</code></pre>
<p>å…³é”®ä»£ç åªæœ‰ä¸¤è¡Œ</p>
<p>ç¬¬ä¸€è¡Œæ˜¯è°ƒç”¨äº† <code>EventHub#getEvents()</code> è·å–äº‹ä»¶ï¼Œæˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚å·²ç»ä»‹ç»è¿‡è¿™ä¸ªæ–¹æ³•äº†ï¼Œæœ‰æ¶ˆæ¯è¿”å›ï¼Œæ²¡æ¶ˆæ¯é˜»å¡åˆ° <code>epoll()</code></p>
<p>å¹¶ä¸”ï¼Œå› ä¸ºæ‰§è¡Œäº‹ä»¶åˆ†å‘éœ€è¦æ—¶é—´ï¼Œåœ¨ä¸Šä¸€æ¬¡åˆ†å‘è¿˜æ²¡æœ‰æ‰§è¡Œç»“æŸä¹‹å‰ï¼Œå¦‚æœå¤šä¸ªè®¾å¤‡éƒ½å‘ç”Ÿäº†äº‹ä»¶ï¼Œæˆ–è€…ä¸€ä¸ªè®¾å¤‡å‘é€äº†å¤šæ¬¡äº‹ä»¶ï¼Œéƒ½ä¼šé€ æˆæ•°æ®çš„ç§¯å‹ï¼Œ<code>getEvents()</code> è¿”å›çš„äº‹ä»¶æ•°é‡å¯èƒ½æ˜¯å¤šæ¡</p>
<p>ç¬¬äºŒè¡Œä»£ç  <code>processEventsLocked()</code> æ˜¯è·å–åˆ°äº‹ä»¶ä»¥åï¼Œå¯¹åŸå§‹äº‹ä»¶è¿›è¡Œè§£æï¼Œç„¶åæäº¤åˆ°é˜Ÿåˆ—ç­‰å¾…åˆ†å‘</p>
<pre><code class="language-c++">/frameworks/native/services/inputflinger/InputReader.cpp
class InputReader {

    void InputReader::processEventsLocked(rawEvents, count) {
        // éå†æ‰€æœ‰äº‹ä»¶ï¼Œè§£æã€åˆ†å‘
        for (const RawEvent* rawEvent = rawEvents; count;) {
            int32_t type = rawEvent-&gt;type; // è·å–äº‹ä»¶ç±»å‹
            switch (type){ // æºç ä¸åŒ…å«æ­¤ switch é€»è¾‘ï¼Œè¿™æ˜¯ InputDevice ä¸­çš„å†…å®¹ï¼Œä¸ºäº†æ–¹ä¾¿ç†è§£æˆ‘æ‰æ¬äº†è¿‡æ¥
                case EV_KEY; // æŒ‰é”®ç±»å‹çš„äº‹ä»¶ã€‚èƒ½å¤Ÿä¸ŠæŠ¥è¿™ç±»äº‹ä»¶çš„è®¾å¤‡æœ‰é”®ç›˜ã€é¼ æ ‡ã€æ‰‹æŸ„ã€æ‰‹å†™æ¿ç­‰ä¸€åˆ‡æ‹¥æœ‰æŒ‰é’®çš„è®¾å¤‡ï¼ˆåŒ…æ‹¬æ‰‹æœºä¸Šçš„å®ä½“æŒ‰é”®ï¼‰
                case EV_ABS; // ç»å¯¹åæ ‡ç±»å‹çš„äº‹ä»¶ã€‚è¿™ç±»äº‹ä»¶æè¿°äº†åœ¨ç©ºé—´ä¸­çš„ä¸€ä¸ªç‚¹ï¼Œè§¦æ§æ¿ã€è§¦æ‘¸å±ç­‰ä½¿ç”¨ç»å¯¹åæ ‡çš„è¾“å…¥è®¾å¤‡å¯ä»¥ä¸ŠæŠ¥è¿™ç±»äº‹ä»¶
                case EV_REL; // ç›¸å¯¹åæ ‡ç±»å‹çš„äº‹ä»¶ã€‚è¿™ç±»äº‹ä»¶æè¿°äº†äº‹ä»¶åœ¨ç©ºé—´ä¸­ç›¸å¯¹äºä¸Šæ¬¡äº‹ä»¶çš„åç§»é‡ã€‚é¼ æ ‡ã€è½¨è¿¹çƒç­‰åŸºäºæ¸¸æ ‡æŒ‡é’ˆçš„è®¾å¤‡å¯ä»¥ä¸ŠæŠ¥æ­¤ç±»äº‹ä»¶
                case EV_SW; // å¼€å…³ç±»å‹çš„äº‹ä»¶ã€‚è¿™ç±»äº‹ä»¶æè¿°äº†è‹¥å¹²å›ºå®šçŠ¶æ€ä¹‹é—´çš„åˆ‡æ¢ã€‚æ‰‹æœºä¸Šçš„é™éŸ³æ¨¡å¼å¼€å…³æŒ‰é’®ã€æ¨¡å¼åˆ‡æ¢æ‹¨ç›˜ç­‰è®¾å¤‡å¯ä»¥ä¸ŠæŠ¥æ­¤ç±»äº‹ä»¶
                ...
            }
            // æˆ‘ä»¬åªä¸“æ³¨ touch è§¦æ‘¸äº‹ä»¶
            dispatchTouches(when, policyFlags);
        }
    }

    void dispatchTouches(){
        // åˆ¤æ–­æ˜¯å¦åªæ˜¯å•æŒ‡äº‹ä»¶ï¼Œæˆ–æ˜¯å¤šæŒ‡è§¦æ‘¸ç­‰ç­‰ç­‰
        // è§£æå®Œæˆåï¼Œè°ƒç”¨ dispatchMotion() åˆ†å‘
        dispatchMotion();
    }

    void dispatchMotion(){
        // æœ€ç»ˆç”Ÿæˆ NotifyMotionArgs ç»“æ„ï¼Œäº¤ç»™ InputDispatcher æ‰§è¡Œæœ€åçš„åˆ†å‘
        NotifyMotionArgs args;
        InputDispatcher::notifyMotion(args);//æäº¤åˆ° InputDispatcher
    }

}
</code></pre>
<blockquote>
<p>psï¼šä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œæˆ‘æŠŠå…¶ä»–åˆ†æ”¯æ•´åˆåˆ°ä¸»æ–¹æ³•æ¥ï¼Œä¸­é—´è¿˜çœç•¥äº†è®¸å¤šä»£ç ã€‚æ‰€ä»¥å»ºè®®ä¸è¦å¯¹ç…§æºç çœ‹è¿™ç¯‡æ–‡ç« ï¼Œä¸ç„¶ä½ å¯èƒ½ä¼šå› ä¸ºæ‰¾ä¸åˆ°æŸä¸ªæ–¹æ³•å›æ¥éª‚æˆ‘çš„~</p>
</blockquote>
<p>è§£æäº‹ä»¶çš„ä¸šåŠ¡é€»è¾‘å‡ ä¹éƒ½æ”¾åœ¨äº† <code>processEventsLocked()</code> æ–¹æ³•</p>
<p>åœ¨ <code>processEventsLocked()</code> æ–¹æ³•ä¸­ï¼Œé¦–å…ˆéå†äº‹ä»¶é›†åˆï¼Œæ ¹æ®ä¸åŒçš„äº‹ä»¶ç±»å‹ï¼Œè°ƒç”¨ä¸åŒçš„è§£ææ–¹æ³•</p>
<p>æˆ‘ä»¬åªä¸“æ³¨ touch è§¦æ‘¸äº‹ä»¶ï¼Œä¹Ÿå°±æ˜¯ <code>dispatchTouches()</code></p>
<p>åœ¨ <code>dispatchTouches()</code> æ–¹æ³•ä¸­ï¼Œæ ¹æ®è§¦æ‘¸ç‚¹ä¿¡æ¯æ¥å†³å®šï¼Œæ˜¯å•æŒ‡è¿˜æ˜¯å¤šæŒ‡äº‹ä»¶</p>
<p>è§£æå®Œæˆåï¼Œè°ƒç”¨ <code>dispatchMotion()</code> ç”Ÿæˆ <code>NotifyMotionArgs</code> å¯¹è±¡ï¼Œé€šçŸ¥ <code>InputDispatcher#notifyMotion()</code> æ–¹æ³•</p>
<p>å½“ <code>InputDispatcher#notifyMotion()</code> æ–¹æ³•è¢«è°ƒç”¨ï¼Œä¹Ÿå°±ä»£è¡¨ç€ï¼Œä¸€æ¬¡è¯»å–äº‹ä»¶ï¼Œè§£æäº‹ä»¶çš„è¿‡ç¨‹å°±ç»“æŸäº†</p>
<p>æ¥ä¸‹æ¥å°±çœ‹äº‹ä»¶æ˜¯æ€ä¹ˆåˆ†å‘çš„äº†ï¼ŒInputReader æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹å›¾</p>
<figure data-type="image" tabindex="8"><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ed45d0d9149840debc41d52d337d16ff~tplv-k3u1fbpfcp-watermark.image?" alt="android_graphic_v5_native_2.png" loading="lazy"></figure>
<p><em>å›¾ç‰‡æ¥æºï¼šè‡ªå·±ç”»çš„</em></p>
<h3 id="3-inputdispatcher">3ã€InputDispatcher</h3>
<p>æ¥ä¸‹æ¥çš„ InputDispatcher åº”è¯¥ä¸ç”¨å†ä»‹ç»äº†ï¼Œå°±æ˜¯ç”¨æ¥åˆ†å‘è¾“å…¥äº‹ä»¶çš„</p>
<p>ä¸Šä¸€å°èŠ‚ç»“æŸæ—¶æ”¾çš„å›¾ç‰‡ï¼Œå·¦è¾¹çš„ InputReader å‘ä¸­é—´çš„ EventQueue é˜Ÿåˆ—æäº¤äº†äº‹ä»¶æ¶ˆæ¯ï¼Œæˆ‘å…ˆæ¥è§£é‡Šä¸€ä¸‹è¿™æ˜¯ä»€ä¹ˆæ—¶å€™å‘ç”Ÿçš„</p>
<pre><code class="language-c++">/frameworks/native/services/inputflinger/InputDispatcher.cpp
class InputDispatcher {

    void notifyMotion(const NotifyMotionArgs* args) {
        MotionEntry* newEntry = new MotionEntry(args);//å°è£…æˆentry
        enqueueInboundEventLocked(newEntry);//å…¥åˆ—ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç­‰å¾…åˆ†å‘è¢«æ‰§è¡Œï¼Œé€»è¾‘åœ¨ dispatchOnce()
    }

}
</code></pre>
<p>å‘ï¼Œçœ‹ä»£ç </p>
<p>ä¸Šä¸€å°èŠ‚æœ€åä¸€è¡Œè°ƒç”¨çš„ <code>InputDispatcher#notifyMotion()</code> æ–¹æ³•ï¼Œä½œç”¨å°±æ˜¯æŠŠäº‹ä»¶æ¶ˆæ¯æäº¤åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç­‰å¾…åˆ†å‘</p>
<p>å¥½ï¼Œå°¾æ”¶å®Œäº†æˆ‘ä»¬ç»§ç»­æ¥çœ‹ InputDispatcher ç±»</p>
<p>åˆ°äº† InputDispatcher è¿™é‡Œï¼ŒåŸå§‹çš„è¾“å…¥äº‹ä»¶å·²ç»è¢«å°è£…æˆ <code>Key</code> ã€<code>Motion</code> ç­‰å¯¹è±¡ï¼ŒInputDispatcher çš„ä»»åŠ¡æ˜¯ï¼šæ‰¾åˆ°åˆé€‚çš„ Windowï¼Œå¹¶æŠŠæ•°æ®ä¼ é€’è¿‡å»</p>
<pre><code class="language-c++">/frameworks/native/services/inputflinger/InputDispatcher.cpp
class InputDispatcher {

    class InputDispatcherThread : Thread {

        bool InputDispatcherThread::threadLoop() {
            mDispatcher-&gt;dispatchOnce();
            return true;
        }
    }

    void dispatchOnce() {
        if(!queue.isEmpty()) dispatchOnceInnerLocked();//æœ‰æ¶ˆæ¯å°±æ‰§è¡Œåˆ†å‘
    }

}
</code></pre>
<p>é¦–å…ˆæ¥çœ‹ InputDispatcher çš„ <code>dispatchOnce()</code> ä¸»æ–¹æ³•ï¼Œå’Œ InputReader è®¾è®¡æ€è·¯ç›¸åŒï¼ŒInputDispatcher ä¹Ÿæ˜¯å†…éƒ¨æœ‰ä¸ªçº¿ç¨‹ç±»ï¼Œç„¶åå¾ªç¯è°ƒç”¨ <code>dispatchOnce()</code> æ‰§è¡Œåˆ†å‘</p>
<p>å¦‚æœæ¶ˆæ¯é˜Ÿåˆ—ä¸­æœ‰æ¶ˆæ¯ï¼Œè°ƒç”¨ <code>dispatchOnceInnerLocked()</code> æ‰§è¡Œåˆ†å‘</p>
<pre><code class="language-c++">/frameworks/native/services/inputflinger/InputDispatcher.cpp
class InputDispatcher {

    void dispatchOnceInnerLocked() {
        mPendingEvent = queue.dequeue(); // ä»æ´¾å‘é˜Ÿåˆ—å–å‡ºä¸€ä¸ªäº‹ä»¶ï¼Œç®€ç•¥å†™æ³•
        switch (mPendingEvent-&gt;type) { // åˆ¤æ–­æ¶ˆæ¯çš„ç±»å‹ï¼šé…ç½®æ›´æ”¹ã€æ’æ‹”æ¶ˆæ¯ã€keyäº‹ä»¶ã€è§¦æ‘¸äº‹ä»¶ç­‰ç­‰
            case EventEntry::TYPE_MOTION:
                dispatchMotionLocked(); // æˆ‘ä»¬åªä¸“æ³¨ è§¦æ‘¸äº‹ä»¶
        }
    }

    void dispatchMotionLocked() {
        int32_t injectionResult = findTouchedWindowTargetsLocked(); // ä¸º Motion äº‹ä»¶å¯»æ‰¾åˆé€‚çš„ç›®æ ‡çª—å£
        if (injectionResult) dispatchEventLocked(); // å¦‚æœæˆåŠŸåœ°æ‰¾åˆ°äº†å¯ä»¥æ¥æ”¶äº‹ä»¶çš„ç›®æ ‡çª—å£ï¼Œåˆ™é€šè¿‡dispatchEventLocked()å‡½æ•°å®Œæˆå®é™…çš„æ´¾å‘å·¥ä½œ
    }

}
</code></pre>
<p>è´Ÿè´£åˆ†å‘çš„ <code>dispatchOnceInnerLocked()</code> æ–¹æ³•éœ€è¦å¤„ç†ä¸åŒè¾“å…¥ç±»å‹çš„äº‹ä»¶ï¼Œæˆ‘ä»¬è¿™é‡Œè¿˜æ˜¯åªå…³æ³¨è§¦æ‘¸æ¶ˆæ¯</p>
<p>å¦‚æœæ˜¯è§¦æ‘¸äº‹ä»¶ï¼Œé‚£ä¹ˆè§¦æ‘¸æ¶ˆæ¯çš„åˆ†å‘æ˜¯ç”± <code>dispatchMotionLocked()</code> æ–¹æ³•æ¥å®Œæˆçš„</p>
<p><code>dispatchMotionLocked()</code> è§¦æ‘¸æ¶ˆæ¯çš„åˆ†å‘ï¼Œåˆ†ä¸ºä¸¤æ­¥æ‰§è¡Œï¼š</p>
<p><strong>ç¬¬ä¸€æ­¥ï¼Œä¸º <code>Motion</code> äº‹ä»¶å¯»æ‰¾åˆé€‚çš„ç›®æ ‡çª—å£ï¼Œè¿™ä¸ªä»»åŠ¡äº¤ç»™ <code>findTouchedWindowTargetsLocked()</code> å‡½æ•°å»å®Œæˆ</strong></p>
<p><strong>ç¬¬äºŒæ­¥ï¼Œå¦‚æœæˆåŠŸåœ°æ‰¾åˆ°äº†å¯ä»¥æ¥æ”¶äº‹ä»¶çš„ç›®æ ‡çª—å£ï¼Œäº¤ç»™ <code>dispatchEventLocked()</code> å‡½æ•°å®Œæˆå®é™…çš„æ´¾å‘å·¥ä½œ</strong></p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ï¼Œ<code>findTouchedWindowTargetsLocked()</code> å’Œ <code>dispatchEventLocked()</code> è¿™ä¸¤ä¸ªæ–¹æ³•çš„å®ç°</p>
<pre><code class="language-c++">/frameworks/native/services/inputflinger/InputDispatcher.cpp
class InputDispatcher {

    int findTouchedWindowTargetsLocked(){
        size_t numWindows = mWindowHandles.size(); // è·å–çª—å£é›†åˆ
        for (size_t i = 0; i &lt; numWindows; i++);//ä»å‰å‘åéå†æ‰€æœ‰çš„windowä»¥æ‰¾å‡ºè§¦æ‘¸çš„windowï¼Œå°†æ»¡è¶³æ¡ä»¶çš„æ”¾å…¥inputTargetsï¼Œæ²¡æ‰¾åˆ°è¿”å›ç¬¬ä¸€ä¸ªå‰å°window
    }
  
  	// åˆé€‚çš„ç›®æ ‡çª—å£è¢«ç¡®å®šä¸‹æ¥ä¹‹åï¼Œä¾¿å¯ä»¥å¼€å§‹å°†å®é™…çš„äº‹ä»¶å‘é€ç»™çª—å£äº†
    void dispatchEventLocked(Vector&lt;InputTarget&gt;&amp; inputTargets) {
        InputChannel channel = inputTarget.inputChannel;//åˆ å‡è¿‡çš„æµç¨‹
        channel-&gt;sendMessage(&amp;msg);//ç»™èƒ½å¤Ÿè¢«è§¦æ‘¸çš„windowå‘é€è·¨è¿›ç¨‹æ¶ˆæ¯
    }

}
</code></pre>
<p><code>findTouchedWindowTargetsLocked()</code> æ–¹æ³•çš„ä¸»è¦é€»è¾‘ï¼Œæ˜¯æ ¹æ®çª—å£çš„ç‚¹å‡»åŒºåŸŸä¸äº‹ä»¶å‘ç”Ÿçš„åæ ‡ç‚¹é€‰å–åˆé€‚çš„ç›®æ ‡çª—å£</p>
<p>ä»£ç ç¨å¾®æœ‰ç‚¹é•¿ï¼Œè¿™é‡Œå°±ä¸å±•å¼€è®¨è®ºäº†ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥é˜…è¯»<a href="https://xianzhu21.space/developer/window_touchable_region/">ã€ŠWindow Touchable Regionã€‹</a>è¿™ç¯‡æ–‡ç« </p>
<p>å†æ¥çœ‹è´Ÿè´£åˆ†å‘çš„ <code>dispatchEventLocked()</code> æ–¹æ³•ï¼Œä»£ç å®ç°ä¹Ÿå¾ˆç®€å•ï¼Œæ ¹æ®çª—å£æŸ¥æ‰¾è¯¥çª—å£å¯¹åº”çš„ <code>channel</code> ï¼Œç„¶åé€šè¿‡ <code>channel</code> è·¨è¿›ç¨‹æŠŠäº‹ä»¶ä¼ é€’åˆ° APP</p>
<p>åˆ°è¿™é‡Œï¼ŒInputDispatcher æ‰€æœ‰çš„åˆ†å‘å·¥ä½œå°±å…¨éƒ¨ç»“æŸäº†ï¼Œæ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹å›¾</p>
<figure data-type="image" tabindex="9"><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d4f6c593f19e49758181f137ac9164e4~tplv-k3u1fbpfcp-watermark.image?" alt="android_graphic_v5_native_3.png" loading="lazy"></figure>
<p><em>å›¾ç‰‡æ¥æºï¼šè‡ªå·±ç”»çš„</em></p>
<p>å“ï¼Œ è¿˜æ²¡å®Œï¼Œå›å¤´æ¥çœ‹è´Ÿè´£åˆ†å‘è§¦æ‘¸æ¶ˆæ¯çš„ <code>InputDispatcher#dispatchMotionLocked()</code> å‡½æ•°</p>
<pre><code class="language-c++">/frameworks/native/services/inputflinger/InputDispatcher.cpp
class InputDispatcher {

    void dispatchMotionLocked() {
        int32_t injectionResult = findTouchedWindowTargetsLocked(); // ä¸º Motion äº‹ä»¶å¯»æ‰¾åˆé€‚çš„ç›®æ ‡çª—å£
        if (injectionResult) dispatchEventLocked(); // å¦‚æœæˆåŠŸåœ°æ‰¾åˆ°äº†å¯ä»¥æ¥æ”¶äº‹ä»¶çš„ç›®æ ‡çª—å£ï¼Œåˆ™é€šè¿‡dispatchEventLocked()å‡½æ•°å®Œæˆå®é™…çš„æ´¾å‘å·¥ä½œ
    }
  
    int findTouchedWindowTargetsLocked(){
        size_t numWindows = mWindowHandles.size(); // è·å–çª—å£é›†åˆ
        for (size_t i = 0; i &lt; numWindows; i++)
        ...
    }

    void dispatchEventLocked(Vector&lt;InputTarget&gt;&amp; inputTargets) {
        InputChannel channel = inputTarget.inputChannel;
        channel-&gt;sendMessage(&amp;msg);//ç»™èƒ½å¤Ÿè¢«è§¦æ‘¸çš„windowå‘é€è·¨è¿›ç¨‹æ¶ˆæ¯
    }

}
</code></pre>
<p>å†çœ‹ä¸€éæºç ï¼Œæˆ‘ä»¬æ¥æ€è€ƒä¸¤ä¸ªé—®é¢˜ ğŸ¤”</p>
<ol>
<li>
<p><strong>è´Ÿè´£æŸ¥æ‰¾çª—å£çš„ <code>findTouchedWindowTargetsLocked()</code> æ–¹æ³•ä¸­ï¼Œ<code>mWindowHandles</code> æ‰€æŒæœ‰çš„çª—å£é›†åˆï¼Œæ˜¯ä»å“ªé‡Œæ¥çš„ï¼Ÿ</strong></p>
</li>
<li>
<p><strong>è´Ÿè´£é€šä¿¡çš„ <code>dispatchEventLocked()</code> æ–¹æ³•ä¸­ï¼ŒInputChannel æ˜¯ä»€ä¹ˆï¼ŸIMS æ˜¯ä»€ä¹ˆæ—¶å€™å’Œ APP å»ºç«‹é€šä¿¡çš„ï¼Ÿ</strong></p>
</li>
</ol>
<p>å›æƒ³ä¸€ä¸‹ï¼Œåœ¨ InputDispatcher ä¹‹å‰ï¼Œä¸ç®¡æ˜¯ EventHub ï¼Œè¿˜æ˜¯ InputReader ï¼Œæˆ‘ä»¬ä¸€ç›´éƒ½æ˜¯åœ¨å’Œ Linux å†…æ ¸æ‰“äº¤é“ï¼Œè¯»å–äº‹ä»¶ã€è§£æäº‹ä»¶å•¥çš„</p>
<p>ä½†åˆ°äº† InputDispatcher è¿™é‡Œï¼Œçªç„¶å’Œåº”ç”¨ç¨‹åºäº§ç”Ÿäº†è”ç³»</p>
<p><strong><code>findTouchedWindowTargetsLocked()</code> çš„çª—å£é›†åˆä»å“ªé‡Œæ¥çš„ï¼Ÿ</strong></p>
<p><strong><code>dispatchEventLocked()</code> åˆæ˜¯å¦‚ä½•æŠŠè§¦æ‘¸äº‹ä»¶é€šçŸ¥åˆ° APP è¿›ç¨‹çš„ï¼Ÿ</strong></p>
<p>å¸¦ç€è¿™ä¸¤ä¸ªç–‘é—®ï¼Œæˆ‘ä»¬å¼€å§‹è¿›å…¥ InputManagerService çš„å¯åŠ¨æµç¨‹ç¯èŠ‚ï¼Œè¿™é‡Œé¢ä¸€å®šæœ‰æˆ‘ä»¬è¦å¯»æ‰¾çš„ç­”æ¡ˆ</p>
<h2 id="å¯åŠ¨-inputmanagerservice">å¯åŠ¨ InputManagerService</h2>
<p>æˆ‘ä»¬çŸ¥é“ï¼ŒInputManagerService ä½œä¸ºè¿è¡Œåœ¨ SystemServer è¿›ç¨‹ä¸­çš„æœåŠ¡ï¼Œå¯åŠ¨é¡ºåºæ˜¯æ’åœ¨ Zygote è¿›ç¨‹ä¹‹åçš„</p>
<p>Java è™šæ‹Ÿæœºåˆå§‹åŒ–å®Œæˆåï¼Œå†ç”± Zygote è¿›ç¨‹ fork è€Œæ¥</p>
<p>æœ¬å°èŠ‚æˆ‘ä»¬å°†è¦æ¥è·Ÿè¸ª InputManagerService çš„å¯åŠ¨æµç¨‹ï¼Œä¸­é—´ä¼šæ¶‰åŠåˆ°ä¸€äº›æ²¡é‚£ä¹ˆé‡è¦çš„ç±»ï¼ˆ<em>é‡è¦çš„éƒ½åœ¨ä¸Šé¢ä»‹ç»è¿‡äº†</em>ï¼‰</p>
<p>æ¯”å¦‚ï¼ŒåŒä¸ºåœ¨ <code>/frameworks/native/services/inputflinger</code> åŒ…ä¸‹é¢çš„ InputManager ç±»ï¼Œæˆ‘ä»¬åœ¨ä»‹ç» native å±‚æˆå‘˜çš„æ—¶å€™å°±æ²¡æœ‰å¸¦ä¸Šå®ƒ</p>
<p>å› ä¸º InputManager åªæ˜¯è´Ÿè´£ç®¡ç† <code>reader</code> å’Œ <code>dispatcher</code> çº¿ç¨‹ ï¼Œæ²¡æœ‰ä¸šåŠ¡é€»è¾‘ï¼Œä¸æ˜¯å¾ˆé‡è¦</p>
<p>åœ¨æ•´ä¸ª IMS çš„å¯åŠ¨æµç¨‹ä¸­ï¼Œæˆ‘ä»¬æ—¶åˆ»è¦è°¨è®°ï¼Œæœ¬èŠ‚çš„é‡ç‚¹æ˜¯ï¼š</p>
<ul>
<li><strong>äº†è§£ InputManagerService å¤§è‡´çš„å¯åŠ¨æµç¨‹</strong></li>
<li><strong>äº†è§£ InputDispatcher çš„çª—å£é›†åˆä»å“ªé‡Œæ¥ï¼Œä»¥åŠ IMS å¦‚ä½•å»ºç«‹è·Ÿ APP é€šä¿¡çš„ï¼Ÿ</strong></li>
</ul>
<p>ææ¸…æ¥šè¿™ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼Œ IMS å¯åŠ¨æµç¨‹è¿™ part å°±å¯ä»¥ç¿»ç¯‡äº†ï¼Œåƒä¸‡åˆ«è¢«é™·å…¥åˆ°æºç ä¸­ï¼Œå¾ˆéš¾å‡ºæ¥çš„~</p>
<h3 id="1-ims-çª—å£é›†åˆä»å“ªé‡Œæ¥">1ã€IMS çª—å£é›†åˆä»å“ªé‡Œæ¥ï¼Ÿ</h3>
<p>åœ¨å‰ä¸¤èŠ‚æˆ‘ä»¬äº†è§£åˆ°ï¼ŒInputManagerService å¯ä»¥åˆ†ä¸º nativeã€jniã€Java ä¸‰å±‚</p>
<p>è¿™ä¸‰å±‚å¤§è‡´çš„å¯åŠ¨é¡ºåºæ˜¯ï¼š<strong>å…ˆä» Java å±‚çš„åˆå§‹åŒ–å¼€å§‹ï¼Œå†è°ƒç”¨åˆ° jni å±‚ï¼Œç”± jni æ‹‰èµ· native çš„å„ä¸ªç±»ï¼Œè¿›è€Œå®Œæˆ native éƒ¨åˆ†çš„åˆå§‹åŒ–ï¼Œæœ€åè¿”å›åˆ° Java å±‚ï¼ŒIMS å¼€å§‹ä¸ºå„ä¸ª APP æä¾›æœåŠ¡</strong></p>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹ Java å±‚çš„åˆå§‹åŒ–å·¥ä½œ</p>
<pre><code class="language-java">/frameworks/base/services/java/com/android/server/SystemServer.java
class SystemServer {

    private void startOtherServices() {
        inputManager = new InputManagerService(context); // åˆ›å»º IMS å¯¹è±¡
        ...
        //å°† InputMonitor å¯¹è±¡ä¿å­˜åˆ° IMS å¯¹è±¡
        inputManager.setWindowManagerCallbacks(wm.getInputMonitor());
        inputManager.start();
    }
}
</code></pre>
<p>åœ¨ <code>SystemServer#startOtherServices()</code> å¯åŠ¨æœåŠ¡çš„æ–¹æ³•ä¸­ï¼Œé¦–å…ˆåˆ›å»ºäº† InputManagerService å¯¹è±¡</p>
<p>ç„¶åï¼Œå°† WindowManagerService ä¸­çš„ InputMonitor å¯¹è±¡ä¿å­˜åˆ° IMS ä¸­</p>
<p><strong>è¿™æ˜¯ InputMonitor ç±»æ˜¯å¹²å˜›çš„ï¼Ÿä¹‹å‰å¥½åƒæ²¡è§è¿‡</strong></p>
<p>ç®€å•æ¥è¯´ï¼Œå®ƒæ˜¯è¿æ¥ WMS å’Œ IMS çš„æ¢çº½ã€‚WMS é€šè¿‡ <code>InputMonitor.java</code> æŒæœ‰äº† IMS çš„å¼•ç”¨ï¼Œå½“çª—å£ä¿¡æ¯å‘ç”Ÿå˜åŒ–åï¼Œé€šè¿‡ <code>InputMonitor#updateInputWindowsLw()</code> æ–¹æ³•ï¼Œå°†æ–°çš„çª—å£é›†åˆæ›´æ–°åˆ° IMS ä¸­ï¼ŒIMS åˆå°†çª—å£é›†åˆåŒæ­¥åˆ° InputDispatcher</p>
<p>æˆ‘ä»¬æœ¬å°èŠ‚çš„ç›®æ ‡ä¹‹ä¸€ï¼Œæ˜¯ä¸ºäº†ææ¸…æ¥š InputDispatcher æŒæœ‰çš„çª—å£é›†åˆä»å“ªé‡Œæ¥ï¼Ÿ</p>
<p><strong>ç°åœ¨ï¼Œç­”æ¡ˆæœ‰äº†ï¼Œæ˜¯ WMS é€šè¿‡è°ƒç”¨ <code>InputMonitor#updateInputWindowsLw()</code> å‡½æ•°ï¼Œæœ€ç»ˆåŒæ­¥åˆ° InputDispatcher ç±»ä¸­</strong></p>
<p>ç®€å•è¯´ä¸€ä¸‹æŸ¥æ‰¾è¿‡ç¨‹</p>
<p>å…ˆå›åˆ° InputDispatcher æºç ï¼Œæœç´¢ <code>mWindowHandles</code> å…³é”®å­—ï¼Œå¾ˆå®¹æ˜“å°±èƒ½å‘ç°äº† <code>mWindowHandles</code> é›†åˆæ˜¯åœ¨ <code>setInputWindows()</code> å‡½æ•°ä¸­è¢«èµ‹å€¼</p>
<pre><code class="language-c++">/frameworks/native/services/inputflinger/InputDispatcher.cpp
class InputDispatcher {

    void InputDispatcher::setInputWindows(inputWindowHandles) {
        mWindowHandles = inputWindowHandles;
    }
}
</code></pre>
<p>é‚£ä¹ˆ <code>setInputWindows()</code> æ˜¯è°è°ƒç”¨çš„ï¼Ÿæ¥ç€æœç´¢ Framework ï¼Œç»“æœå¦‚å›¾</p>
<figure data-type="image" tabindex="10"><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/69e4eebfa05a4818ad2864f90ec0c89c~tplv-k3u1fbpfcp-watermark.image?" alt="android_graphic_v5_method_setInputWindows.jpg" loading="lazy"></figure>
<p><em>å›¾ç‰‡æ¥æºï¼š<a href="http://www.aospxref.com/android-7.1.2_r39/search?page-nav=android-7.1.2_r39&amp;full=setInputWindows&amp;project=frameworks">aospxref.com/android-7.1.2</a></em></p>
<p>æˆ‘ä»¬å‘ç°ï¼ŒJava å±‚çš„ IMS ä¹Ÿæœ‰ä¸€ä¸ª <code>setInputWindows()</code> æ–¹æ³•ï¼Œå¹¶é€šè¿‡ JNI æŒ‡å‘äº† native ä¸­çš„ <code>InputDispatcher#setInputWindows()</code></p>
<p><strong>æœ€ç»ˆçš„è°ƒç”¨åŠ¨ä½œå°±å‘ç”Ÿåœ¨ InputMonitor ç±»çš„ <code>updateInputWindowsLw()</code> æ–¹æ³•ä¸­ï¼</strong></p>
<p>å¥½äº†ï¼ŒInputDispatcher æŒæœ‰çš„çª—å£é›†åˆæ¥æºï¼Œè¿™ä¸ªç–‘é—®å·²ç»è§£å†³äº†ã€‚æˆ‘ä»¬ç»§ç»­æ¥è·Ÿå¯åŠ¨æµç¨‹</p>
<pre><code class="language-java">/frameworks/base/services/java/com/android/server/SystemServer.java
class SystemServer {
  
    private void startOtherServices() {
        inputManager = new InputManagerService(context);
        inputManager.start();
    }
}

/frameworks/base/services/core/java/com/android/server/input/InputManagerService.java
class InputManagerService {
    // ã€step 1.0ã€‘åˆå§‹åŒ–æµç¨‹
    public InputManagerService(Context context) {
       mPtr = nativeInit(this, mContext, mHandler.getLooper().getQueue());
       LocalServices.addService(InputManagerInternal.class, new LocalService());
    }

    // ã€step 2.0ã€‘ å¯åŠ¨æµç¨‹
    public void start() {
        nativeStart(mPtr); // è¯¦è§ ã€2.1ã€‘
        Watchdog.getInstance().addMonitor(this);
    }
}
</code></pre>
<p>åœ¨ SystemServer åˆ›å»ºå®Œ InputManagerService å¯¹è±¡åï¼Œç´§æ¥ç€å°±è°ƒç”¨äº† <code>inputManager#start()</code> å¯åŠ¨äº†æœåŠ¡</p>
<p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦æŠŠå¯åŠ¨æµç¨‹åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤æ¥çœ‹ï¼Œ<strong>ä¸€ä¸ªæ˜¯åˆå§‹åŒ–æµç¨‹åšäº†ä»€ä¹ˆï¼Œç¬¬äºŒä¸ªæ‰æ˜¯å¯åŠ¨æµç¨‹</strong></p>
<p>åœ¨ InputManagerService çš„æ„é€ å‡½æ•°ä¸­ï¼Œè°ƒç”¨äº† <code>nativeInit()</code> æ‰§è¡Œäº†åˆå§‹åŒ–å·¥ä½œï¼Œè¿™æ˜¯ä¸ª jni æ–¹æ³•ï¼Œæˆ‘ä»¬ä¸€èµ·å»çœ‹çœ‹æºç å®ç°</p>
<h3 id="2-ims-çš„åˆå§‹åŒ–å·¥ä½œ">2ã€IMS çš„åˆå§‹åŒ–å·¥ä½œ</h3>
<pre><code class="language-c++">/frameworks/base/services/core/jni/com_android_server_input_InputManagerService.cpp
class NativeInputManager {

    static jlong nativeInit(env, jclass, serviceObj, contextObj, messageQueueObj) {
        NativeInputManager* im = new NativeInputManager(contextObj, serviceObj,messageQueue-&gt;getLooper()); 
    }

    NativeInputManager::NativeInputManager(contextObj, serviceObj, looper)  {
        sp&lt;EventHub&gt; eventHub = new EventHub(); // åˆ›å»º EventHub å¯¹è±¡
        mInputManager = new InputManager(eventHub, this, this); // åˆ›å»º InputManager å¯¹è±¡
    }

}
</code></pre>
<p><code>nativeInit()</code> æ–¹æ³•ä¸­åˆ›å»ºäº† NativeInputManager å¯¹è±¡</p>
<p>åœ¨ NativeInputManager çš„æ„é€ å‡½æ•°ä¸­ï¼Œåˆåˆ›å»ºäº†ä¸¤ä¸ªæˆ‘ä»¬ç†Ÿæ‚‰çš„å¯¹è±¡ï¼Œ<code>EventHub</code> å’Œ <code>InputManager</code></p>
<p>EventHub åœ¨å‰é¢å·²ç»ä»‹ç»è¿‡äº†ï¼Œè´Ÿè´£ç›‘å¬äº‹ä»¶å˜åŒ–ï¼Œå¹¶å¯¹å¤–æä¾›è·å–äº‹ä»¶å˜åŒ–çš„æ¥å£</p>
<p>InputManager ä¹Ÿæåˆ°è¿‡ï¼Œè´Ÿè´£åˆ›å»º Reader å’Œ Dispatcher ä¸¤çº¿ç¨‹ï¼Œæ²¡ä»€ä¹ˆé€»è¾‘</p>
<pre><code class="language-c++">/frameworks/native/services/inputflinger/EventHub.cpp
class EventHub {

    EventHub::EventHub(void)  {
        mEpollFd = epoll_create(EPOLL_SIZE_HINT); // åˆ›å»º epollï¼Œç”¨äºç›‘å¬è®¾å¤‡æ–‡ä»¶æ˜¯å¦æœ‰å¯è¯»äº‹ä»¶
        mINotifyFd = inotify_init(); // åˆ›å»º inotify ï¼Œç”¨äºç›‘å¬æ–‡ä»¶ç³»ç»Ÿæ˜¯å¦å˜åŒ–ï¼Œæœ‰å˜åŒ–è¯´æ˜å‘ç”Ÿè®¾å¤‡æ’æ‹”
    }
}

/frameworks/native/services/inputflinger/InputManager.cpp
class InputManager {
  
    InputManager::InputManager(eventHub, readerPolicy, dispatcherPolicy) {
        mDispatcher = new InputDispatcher(dispatcherPolicy);
        mReader = new InputReader(eventHub, readerPolicy, mDispatcher);
        initialize(); 
    }

    void InputManager::initialize() {
        mReaderThread = new InputReaderThread(mReader); //åˆ›å»ºçº¿ç¨‹ â€œInputReaderâ€
        mDispatcherThread = new InputDispatcherThread(mDispatcher); //åˆ›å»ºçº¿ç¨‹ â€InputDispatcherâ€œ
    }

}
</code></pre>
<p>å‘ï¼Œä½ çœ‹</p>
<p>EventHub åªæ˜¯åˆ›å»ºäº† <code>mEpollFd</code> å’Œ <code>mINotifyFd</code> ä¸¤ä¸ª Fd å¯¹è±¡</p>
<p>InputManager ä¹Ÿåªæ˜¯åˆ›å»ºäº† <code>InputReader</code> å’Œ <code>InputDispatcher</code> ä¸¤ä¸ªå¯¹è±¡ï¼Œç„¶ååˆ›å»ºäº† <code>InputReaderThread</code> å’Œ <code>InputDispatcherThread</code> ä¸¤ä¸ªçº¿ç¨‹</p>
<p><strong>å¥½äº†ï¼Œç°åœ¨ IMS åº•å±‚çš„ä¸‰å‘˜å¤§å°†ï¼š<code>EventHub</code>ã€<code>InputReader</code>ã€<code>InputDispatcher</code> å…¨éƒ¨æˆåŠŸåˆ›å»ºï¼ŒIMS ç±»çš„åˆå§‹åŒ–å·¥ä½œå°±å…¨éƒ¨ç»“æŸäº†</strong></p>
<h3 id="3-ims-çš„å¯åŠ¨æµç¨‹">3ã€IMS çš„å¯åŠ¨æµç¨‹</h3>
<p>æˆ‘ä»¬æŠŠ SystemServer çš„ä»£ç å†æ‹¿å‡ºæ¥çœ‹çœ‹ï¼Œçœ‹çœ‹æ¥ä¸‹æ¥åº”è¯¥åšä»€ä¹ˆ</p>
<pre><code class="language-java">/frameworks/base/services/java/com/android/server/SystemServer.java
class SystemServer {
  
    private void startOtherServices() {
        inputManager.start();
    }
}

/frameworks/base/services/core/java/com/android/server/input/InputManagerService.java
class InputManagerService {
  
    public InputManagerService(Context context); // åˆå§‹åŒ–å·¥ä½œå·²å®Œæˆ 

    public void start() {
        nativeStart(mPtr); // å¯åŠ¨æœåŠ¡
        Watchdog.getInstance().addMonitor(this);
    }
}
</code></pre>
<p>åˆå§‹åŒ–å·¥ä½œå®Œæˆä»¥åï¼Œç´§æ¥ç€è°ƒç”¨äº† <code>start()</code> æ–¹æ³•å¯åŠ¨äº†æœåŠ¡</p>
<p><code>start()</code> å†…éƒ¨è°ƒç”¨äº† <code>nativeStart()</code> æ–¹æ³•ï¼Œè¿™åˆæ˜¯ä¸ª jni å‡½æ•°ï¼Œæˆ‘ä»¬ç»§ç»­å‘ä¸‹è·Ÿ</p>
<pre><code class="language-c++">/frameworks/base/services/core/jni/com_android_server_input_InputManagerService.cpp
class NativeInputManager {
  
    static void nativeStart(env, jclass , ptr) {
      	getInputManager()-&gt;start(); // è°ƒç”¨ InputManager çš„ start() æ–¹æ³•
    }
}

/frameworks/native/services/inputflinger/InputManager.cpp
class InputManager {
   
    status_t InputManager::start() {
        result = mDispatcherThread-&gt;run(&quot;InputDispatcher&quot;, PRIORITY_URGENT_DISPLAY); // å¯åŠ¨çº¿ç¨‹â€œInputReaderâ€
        result = mReaderThread-&gt;run(&quot;InputReader&quot;, PRIORITY_URGENT_DISPLAY); // å¯åŠ¨çº¿ç¨‹â€InputDispatcherâ€œ
        ...
        return OK;
    }
}
</code></pre>
<p><code>nativeStart()</code> å†…éƒ¨è°ƒç”¨äº† <code>InputManager#start()</code> ï¼Œå¯åŠ¨äº† <code>InputReaderThread</code> å’Œ <code>InputDispatcher</code> çº¿ç¨‹</p>
<p>è¿™ä¿©çº¿ç¨‹æˆ‘ä»¬å·²ç»è§è¿‡äº†ï¼Œå¯åŠ¨åï¼Œ<code>InputReaderThread</code> å¾ªç¯è¯»æ¶ˆæ¯ï¼Œè¯»åˆ°æ¶ˆæ¯è§£æï¼Œç”Ÿæˆ Event å¯¹è±¡ï¼Œæäº¤åˆ°äº‹ä»¶é˜Ÿåˆ—ï¼Œç­‰å¾…åˆ†å‘</p>
<p><code>InputDispatcher</code> å¾ªç¯æ´¾å‘æ¶ˆæ¯ï¼Œä¸€ç›´ä»äº‹ä»¶é˜Ÿåˆ—ä¸­å– Event æ¶ˆæ¯ï¼Œæ´¾å‘ç»™åˆé€‚çš„çª—å£</p>
<p>åˆ°è¿™é‡Œï¼Œ IMS çš„å¯åŠ¨å·¥ä½œå°±å…¨éƒ¨ç»“æŸäº†ï¼Œæ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹å›¾</p>
<figure data-type="image" tabindex="11"><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/687b6ef552ed4eaab96bbdba26e6bd5e~tplv-k3u1fbpfcp-watermark.image?" alt="android_graphic_v5_ims_process.png" loading="lazy"></figure>
<p><em>å›¾ç‰‡æ¥æºï¼šè‡ªå·±ç”»çš„</em></p>
<p>IMS å¯åŠ¨æµç¨‹ç¨å¾®æœ‰é‚£ä¹ˆä¸€ç‚¹ç‚¹é•¿ï¼Œå®Œæ•´çš„å¯åŠ¨åˆ†ææˆ‘æ”¾åœ¨äº† GitHub ï¼Œç‚¹å‡»<a href="https://github.com/yibaoshan/Blackboard/blob/master/Blog/src/main/java/com/android/blog/android/graphics/code/v5/%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B.cpp">[è¿™é‡Œ]</a>è·³è½¬æŸ¥çœ‹</p>
<h2 id="å¯åŠ¨-app-è¿›ç¨‹">å¯åŠ¨ APP è¿›ç¨‹</h2>
<p>åœ¨ä¸Šä¸€å°èŠ‚ InputManagerService çš„å¯åŠ¨æµç¨‹ä¸­ï¼Œæˆ‘ä»¬è§£å†³äº†â€œ <strong>InputDispatcher çš„çª—å£é›†åˆä»å“ªé‡Œæ¥</strong>â€ çš„é—®é¢˜</p>
<p>ç°åœ¨è¿˜å‰©ä¸‹ â€œ <strong>APP æ˜¯å¦‚ä½•å’Œ IMS å»ºç«‹é€šä¿¡çš„</strong> â€ è¿™ä¸ªé—®é¢˜è¿˜æ²¡æœ‰è§£å†³</p>
<p>ç³»ç»ŸæœåŠ¡å…¨éƒ¨å‡†å¤‡å°±ç»ªåï¼Œæ¥ä¸‹æ¥æ˜¯ APP åº”ç”¨çš„å¯åŠ¨æµç¨‹ï¼Œåœ¨è·Ÿè¸ªå¯åŠ¨åº”ç”¨è¿›ç¨‹çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¼šæ‰¾åˆ° â€œ <strong>APP æ˜¯å¦‚ä½•å’Œ IMS å»ºç«‹é€šä¿¡çš„</strong> â€ è¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆ</p>
<h3 id="1-ä¸º-activity-åˆ†é…çª—å£">1ã€ä¸º Activity åˆ†é…çª—å£</h3>
<p>APP çš„å¯åŠ¨è¿‡ç¨‹æˆ‘ä»¬åº”è¯¥éƒ½å¤šå°‘æœ‰ç‚¹äº†è§£ï¼Œå’Œ AMS é€šä¿¡æ€ä¹ˆåˆ›å»ºè¿›ç¨‹è¿™éƒ¨åˆ†æˆ‘ä»¬å°±è·³è¿‡äº†ï¼Œæœ¬ç¯‡é‡ç‚¹æ˜¯è§¦æ‘¸äº‹ä»¶ï¼Œæˆ‘ä»¬ç›´æ¥å¿«è¿›åˆ°ä¸º Activity è®¾ç½®è§†å›¾ï¼Œåˆ†é…çª—å£è¿™éƒ¨åˆ†å†…å®¹</p>
<pre><code class="language-java">/frameworks/base/core/java/android/view/ViewRootImpl.java
class ViewRootImpl {

    InputChannel mInputChannel; // ä¿å­˜çš„æ˜¯ client ç«¯çš„ socket

    void setView(View view){
        mInputChannel = new InputChannel(); // åˆ›å»ºäº†ç©ºçš„ InputChannel ï¼Œä¸‹é¢ä»£ç å°†ä¼šç”ŸæˆçœŸå®çš„ InputChannel
        Session.addToDisplay(view,mInputChannel);//å‘wmsæ·»åŠ çª—å£

        if(mInputChannel!=null) mInputEventReceiver = new WindowInputEventReceiver(mInputChannel, Looper.myLooper());
    }

}
</code></pre>
<p>æˆ‘ä»¬åœ¨ Activity è®¾ç½®çš„è§†å›¾æ–‡ä»¶ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ° <code>ViewRootImpl#setView()</code> æ–¹æ³•</p>
<p>åœ¨ <code>setView()</code> æ–¹æ³•ä¸­ï¼Œä¸€å…±æœ‰ä¸‰è¡Œå…³é”®ä»£ç </p>
<ol>
<li><strong>åˆ›å»ºäº†å±äºè¯¥è§†å›¾çš„ InputChannel ç©ºå¯¹è±¡ï¼Œå…ˆä¸ç”¨ç®¡</strong></li>
<li><strong>å‘ WMS æ·»åŠ çª—å£ï¼Œå¹¶å°†åˆšåˆšåˆ›å»ºçš„ InputChannel å¯¹è±¡ä¸€å¹¶ä¼ é€’è¿‡å»ï¼Œé‡è¦é€»è¾‘</strong></li>
<li><strong>åˆ›å»ºäº† WindowInputEventReceiver ï¼Œå°†è¯¥è§†å›¾çš„ InputChannel ä¿å­˜èµ·æ¥ï¼Œä¹Ÿä¸ç”¨ç®¡</strong></li>
</ol>
<p>åœ¨è¿™ä¸‰è¡Œä»£ç ä¸­ï¼Œç¬¬2è¡Œæ˜¯å…³é”®ä»£ç ï¼Œç¬¬1è¡Œå’Œç¬¬3è¡Œï¼Œä»¥ç°æœ‰çš„ä¿¡æ¯æ²¡åŠæ³•è§£é‡Šå®ƒä»¬å†…éƒ¨åšäº†ä»€ä¹ˆï¼Œç­‰åˆ°åé¢æœ‰æœºä¼šåœ¨ä»‹ç»</p>
<p>å¥½ï¼Œæˆ‘ä»¬æ¥çœ‹ç¬¬2è¡Œä»£ç å‘ç”Ÿäº†ä»€ä¹ˆ</p>
<pre><code class="language-java">/frameworks/base/services/core/java/com/android/server/wm/Session.java
class Session {

    void addToDisplay(InputChannel inputChannel){
        WindowManagerService.addWindow(inputChannel);
    }

}

/frameworks/base/services/core/java/com/android/server/wm/WindowManagerService.java
class WindowManagerService {

    int addWindow(InputChannel outInputChannel){
        WindowState win = new WindowState(); // é¦–æ¬¡æ·»åŠ è§†å›¾æ—¶åˆ›å»ºï¼Œç”¨äºæè¿°ä¸€ä¸ªwindow
        win.openInputChannel(outInputChannel); // åˆ›å»ºé€šä¿¡çš„å…³é”®ä»£ç ï¼Œæ‰“å¼€ä¸€å¯¹å·²è¿æ¥çš„ socket
    }

}
</code></pre>
<p><code>Session#addToDisplay()</code> æ–¹æ³•åªæ˜¯åšäº†è½¬å‘ï¼Œå®é™…åˆ›å»ºçª—å£çš„å·¥ä½œè¿˜æ˜¯ç”± <code>WindowManagerService#addWindow()</code> æ¥å®Œæˆçš„</p>
<p>åœ¨ <code>addWindow()</code> æ–¹æ³•ä¸­ï¼Œé¦–å…ˆåˆ›å»ºäº† WindowState å¯¹è±¡ï¼Œç”¨äºæè¿°è¯¥çª—å£ä¿¡æ¯</p>
<p>éšåè°ƒç”¨äº† WindowState å¯¹è±¡ä¸­çš„ <code>openInputChannel()</code> æ–¹æ³•ï¼Œå®ƒæ˜¯åˆ›å»ºé€šä¿¡çš„å…³é”®ä»£ç ï¼Œå†…éƒ¨æ˜¯åˆ›å»ºäº†ä¸€å¯¹å·²è¿æ¥çš„ <code>socket</code></p>
<p>æˆ‘ä»¬æ¥é‡ç‚¹å…³æ³¨ <code>WindowState#openInputChannel()</code> æ–¹æ³•</p>
<pre><code class="language-java">/frameworks/base/services/core/java/com/android/server/wm/WindowState.java
class WindowState {

    InputChannel mInputChannel;
    InputChannel mClientChannel;

    void openInputChannel(InputChannel outInputChannel) {
        InputChannel[] inputChannels = InputChannel.openInputChannelPair(); // è¿”å›ä¸€å¯¹å·²è¿æ¥çš„ socket
        // è¿™æ˜¯ä¸€å¯¹å·²è¿æ¥çš„ç®¡é“ï¼Œå°† socket ä¸¤ç«¯åˆ†åˆ«ä¿å­˜åˆ°æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å³å¯è¿›è¡Œé€šä¿¡
        mInputChannel = inputChannels[0]; // ä¸‹æ ‡ä¸º0çš„ä¼ é€’ç»™ IMS æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯å¯é€šè¿‡è¯¥ socket å‘çª—å£å‘é€æ¶ˆæ¯
        mClientChannel = inputChannels[1]; // ä¸‹æ ‡ä¸º1çš„å›ä¼ ç»™ client ç«¯
        // 1. Client ç«¯ InputChanenl è°ƒç”¨ transforTo() æ–¹æ³•ä¼ ç»™ ViewRootImpl çš„ mInputChannel
        mClientChannel.transferTo(outInputChannel);
        // 2. Server ç«¯ InputChannel å­˜åœ¨ WindowState çš„ mInputChannel å˜é‡
        InputManagerService.registerInputChannel(mInputChannel);
    }
}

/frameworks/native/libs/input/InputTransport.cpp
status_t InputChannel::openInputChannelPair(name,outServerChannel,outClientChannel) {
    int sockets[2] = socketpair(sockets);
    serverChannelName.append(&quot; (server)&quot;);
    outServerChannel = new InputChannel(serverChannelName, sockets[0]);
    clientChannelName.append(&quot; (client)&quot;);
    outClientChannel = new InputChannel(clientChannelName, sockets[1]);
    return OK;
}
</code></pre>
<p><code>WindowState#openInputChannel()</code> ä¸­ï¼Œé¦–å…ˆè°ƒç”¨äº† <code>InputChannel#openInputChannelPair()</code> å‡½æ•°åˆ›å»ºä¸¤ä¸ª InputChannelï¼Œå…¶å†…éƒ¨è°ƒç”¨ Linux çš„ <code>socketpair()</code> å‡½æ•°</p>
<p><code>socketpair()</code> æ˜¯ Linux æä¾›çš„ä¸€ç§è¿›ç¨‹é—´é€šä¿¡çš„æ–¹å¼ï¼Œè·Ÿ <code>pipe()</code> å‡½æ•°æ˜¯ç±»ä¼¼çš„ã€‚ä½† <code>pipe()</code> åˆ›å»ºçš„åŒ¿åç®¡é“æ˜¯åŠåŒå·¥çš„ï¼Œè€Œ <code>socketpair()</code> å¯ä»¥è®¤ä¸ºæ˜¯åˆ›å»ºä¸€ä¸ªå…¨åŒå·¥çš„ç®¡é“ï¼š</p>
<p>æˆ‘å‘æˆ‘æŒæœ‰çš„ <code>socket</code> ä¸­å†™æ•°æ®ï¼Œä½ åœ¨ä½ æŒæœ‰çš„ <code>socket</code> ä¸­èƒ½å¤Ÿè¯»åˆ°æ•°æ®ï¼Œåè¿‡æ¥ä¹Ÿä¸€æ ·ï¼Œå³ä¸¤ç«¯éƒ½å¯ä»¥å¯¹è‡ªå·±æŒæœ‰çš„ <code>socket</code> è¿›è¡Œè¯»å†™</p>
<p>åœ¨è§¦æ‘¸äº‹ä»¶çš„ä¼ é€’ä¸­ï¼ŒGoogle å›¢é˜Ÿä½¿ç”¨äº† <code>socketpair()</code> åˆ›å»ºä¸€å¯¹å·²è¿æ¥çš„ <code>socket</code> ï¼Œç”¨äº IMS å’Œ APP é—´è·¨è¿›ç¨‹é€šä¿¡</p>
<p>å…¶ä¸­ï¼ŒIMS ä¼šæŒæœ‰åä¸º <code>server</code> çš„ä¸€ç«¯ï¼ˆ<code>sockets[0]</code>ï¼‰è¿›è¡Œè¯»å†™ï¼› APP æŒæœ‰åä¸º <code>client</code> çš„ä¸€ç«¯ï¼ˆ<code>sockets[1]</code>ï¼‰è¿›è¡Œè¯»å†™</p>
<p><strong>æä¸ªé†’ï¼Œæˆ‘ä»¬ç°åœ¨çœ‹çš„ä»£ç æ˜¯ï¼šè®¾ç½® Activity è§†å›¾æ—¶ï¼Œç»è¿‡ <code>binder</code> é€šä¿¡åï¼Œè·‘åœ¨äº† <code>system_server</code> è¿›ç¨‹ä¸­çš„ WMS æœåŠ¡é‡Œ</strong></p>
<p>å› æ­¤ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥çš„ä»»åŠ¡ï¼Œæ˜¯æŠŠ <code>sockets[0]</code> çš„ <code>server</code> ç«¯ï¼Œä¼ é€’ç»™ IMS ï¼Œè®©è§¦æ‘¸äº‹ä»¶å‘ç”Ÿåï¼Œ IMS èƒ½å¤Ÿé€šçŸ¥åˆ° APP</p>
<p>ç„¶åï¼ŒæŠŠ <code>sockets[1]</code> çš„ <code>client</code> ç«¯é€šè¿‡ <code>binder</code> è·¨è¿›ç¨‹å›ä¼ ç»™ APP è¿›ç¨‹ä¿å­˜ï¼Œè®© APP èƒ½å¤Ÿæ¥æ”¶åˆ°æ¥è‡ª IMS çš„æ¶ˆæ¯</p>
<p>å¥½ï¼Œå¼€å§‹å¹²æ´»</p>
<h3 id="2-sockets1-å›ä¼ ç»™-app">2ã€sockets[1] å›ä¼ ç»™ APP</h3>
<p>æºç é‡Œæ˜¯å…ˆå°† Client çš„å›ä¼ ç»™ APP è¿›ç¨‹ï¼Œé‚£æˆ‘ä»¬å°±æŒ‰ç…§æºç çš„é¡ºåºæ¥çœ‹ï¼Œå…ˆæŠŠå±äº APP è¿›ç¨‹çš„ <code>socket</code> / <code>InputChannel</code> å›ä¼ è¿‡å»</p>
<pre><code class="language-java">/frameworks/base/services/core/java/com/android/server/wm/WindowState.java
class WindowState {

    void openInputChannel(InputChannel outInputChannel) {
        // 1. Client ç«¯ InputChanenl è°ƒç”¨ transforTo() æ–¹æ³•ä¼ ç»™ ViewRootImpl çš„ mInputChannel
        mClientChannel.transferTo(outInputChannel);
        // 2. Server ç«¯ InputChannel å­˜åœ¨ WindowState çš„ mInputChannel å˜é‡
        InputManagerService.registerInputChannel(mInputChannel);
    }
}

/frameworks/base/core/java/android/view/ViewRootImpl.java
class ViewRootImpl {

    InputChannel mInputChannel; // ä¿å­˜çš„æ˜¯ client ç«¯çš„ socket 

    void setView(View view){
        mInputChannel = new InputChannel(); // åˆ›å»ºäº†ç©ºçš„ InputChannel
      	try {
          	Session.addToDisplay(view,mInputChannel);
        } catch (RemoteException e) {
          	mInputChannel = null;
        }
        ...
        if(mInputChannel != null ) mInputEventReceiver = new InputEventReceiver(mInputChannel, Looper.myLooper()); 
    }

}
</code></pre>
<p>çœ‹ä»£ç ï¼Œ<code>Session#addToDisplay()</code> æ˜¯å°†æˆ‘ä»¬è®¾ç½®çš„è§†å›¾ï¼Œå’Œåˆšåˆšåˆ›å»ºçš„ç©ºçš„ <code>mInputChannel</code> ä¼ é€’åˆ° WindowManagerService</p>
<p>å¦‚æœ WMS æˆåŠŸæ·»åŠ äº†è§†å›¾ï¼Œæ²¡æœ‰å‘ç”Ÿå¼‚å¸¸ï¼Œè¡¨ç¤ºå±äº APP ç«¯çš„ <code>socket</code> / <code>InputChannel</code> å·²ç»åˆ›å»ºæˆåŠŸå¹¶é€šè¿‡ <code>binder</code> è·¨è¿›ç¨‹ä¼ é€’å›æ¥äº†ï¼Œæ­¤æ—¶ <code>mInputChannel</code> å˜é‡å°±ä¸æ˜¯åˆšåˆšåˆ›å»ºçš„ç©ºå¯¹è±¡äº†ï¼Œé‡Œé¢å·²ç»åŒ…å«äº† APP ç«¯çš„ <code>socket</code></p>
<p>ç›‘å¬è¿™ä¸ª <code>socket</code> ï¼Œæˆ‘ä»¬å¯ä»¥æ”¶åˆ°æ¥è‡ª IMS çš„æ¶ˆæ¯ï¼›å¾€è¿™ä¸ª <code>socket</code> å†™æ•°æ®ï¼ŒIMS ä¹Ÿå¯ä»¥æ”¶åˆ°æˆ‘ä»¬å‘é€çš„æ¶ˆæ¯ï¼Œç¾æ»‹æ»‹</p>
<p>å¦‚æœ WMS æ·»åŠ è§†å›¾å¤±è´¥äº†ï¼Œä¼šæŠ›å‡º <code>RemoteException</code> è¿œç¨‹è¿æ¥å¼‚å¸¸ï¼Œ<code>mInputChannel</code> å˜é‡å°†è¢«æ¸…ç©ºã€‚</p>
<p>æ€»ä¹‹ï¼Œåªè¦ <code>mInputChannel</code> å˜é‡ä¸ä¸ºç©ºï¼Œå°±è¡¨ç¤ºå±äº APP ç«¯çš„ <code>socket</code> å·²ç»ä¼ å›æ¥äº†ï¼Œ WMS å’Œ APP ä¸­é—´çš„ä¼ é€’è¿‡ç¨‹æˆ‘ä»¬å…ˆä¸ç®¡</p>
<p>å¥½ï¼Œç°åœ¨ APP ç«¯çš„ InputChannel å·²ç»å›ä¼ æˆåŠŸï¼Œä¸‹ä¸€æ­¥çš„ä»£ç æ˜¯åˆ›å»ºäº† <code>InputEventReceiver</code> å¯¹è±¡ï¼Œå¹¶å°† APP ç«¯çš„ InputChannel å’Œ APP ç«¯çš„ Looper ä¸€åŒä¼ é€’è¿‡å»</p>
<p>ä¸€èµ·æ¥çœ‹ InputEventReceiver çš„ä»£ç </p>
<pre><code class="language-java">/frameworks/base/core/java/android/view/InputEventReceiver.java
class InputEventReceiver {

    public InputEventReceiver(InputChannel inputChannel, Looper looper) {
        mReceiverPtr = nativeInit(new WeakReference&lt;InputEventReceiver&gt;(this),inputChannel, looper.getQueue());
    }

}
</code></pre>
<p>java å±‚çš„ InputEventReceiver åªæ˜¯ä¸ªç©ºå£³å­ï¼Œå®é™…çš„å®ç°åœ¨ native å±‚ï¼Œç»§ç»­å‘ä¸‹è·Ÿ</p>
<pre><code class="language-c++">/frameworks/base/core/jni/android_view_InputEventReceiver.cpp
class NativeInputEventReceiver {

    static jlong nativeInit(env, clazz, receiverWeak, inputChannelObj,  messageQueueObj) { // ç®€ç•¥å†™æ³•
       int fd = inputChannelObj-&gt;getFd();
       messageQueueObj-&gt;getLooper()-&gt;addFd(fd, 0, events, this, NULL);
       ...
    }

}
</code></pre>
<p>ä»£ç æˆ‘åˆåˆå¹¶è¿‡ï¼Œå…³é”®ä»£ç å°±ä¸¤è¡Œ</p>
<p><strong>ç¬¬ä¸€è¡Œæ˜¯åˆ©ç”¨ <code>inputChannelObj</code> å¯¹è±¡è·å–é‡Œé¢çš„ <code>socketfd</code></strong></p>
<p><strong>ç¬¬äºŒè¡Œæ˜¯åˆ©ç”¨ <code>messageQueueObj</code> å¯¹è±¡è·å–é‡Œé¢çš„ Looper ï¼ŒæŠŠä¸Šä¸€æ­¥æ‹¿åˆ°çš„ <code>socketfd</code> ä¸¢è¿›å»ç›‘å¬</strong></p>
<p>ä»£ç è™½ç„¶ä¸å¤šï¼Œä½†ç†è§£è¿™ä¸¤è¡Œä»£ç ï¼Œéœ€è¦å¯¹ Handler æœºåˆ¶æ¯”è¾ƒç†Ÿæ‚‰ï¼ŒåŒ…æ‹¬ native å±‚</p>
<p>æˆ‘æ¥ç®€å•è§£é‡Šä¸€ä¸‹ï¼š</p>
<p>åœ¨<a href="https://juejin.cn/post/7146239048191836190">ã€ŠAndroidç»„ä»¶ç³»åˆ—ï¼šå†è°ˆHandleræœºåˆ¶ï¼ˆNativeç¯‡ï¼‰ã€‹</a>è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬äº†è§£åˆ°ï¼š<strong>åœ¨ native å±‚åŒæ ·æ‹¥æœ‰ä¸€å¥— Looper æœºåˆ¶ã€‚è¿™å¥— Looper ä¸ä½†å¯ä»¥å¤„ç† native å±‚æ¶ˆæ¯ï¼Œè¿˜æ”¯æŒç›‘å¬ <code>è‡ªå®šä¹‰ fd</code>ï¼Œè¿™æ˜¯æœ¬å°èŠ‚çš„é‡ç‚¹</strong></p>
<p>Java å±‚çš„ MessageQueue åœ¨åˆå§‹åŒ–æ—¶ï¼Œä¼šè°ƒç”¨ <code>nativeInit()</code> æ–¹æ³•ï¼ŒåŒæ­¥åˆ›å»º naive å±‚çš„ <code>NativeMessageQueue</code> å¯¹è±¡ï¼Œå¹¶å°†è¿”å›çš„ native å¼•ç”¨ä¿å­˜åˆ° <code>mPtr</code> å˜é‡ä¸­</p>
<p>æ³¨æ„çœ‹ï¼Œæˆ‘ä»¬ç°åœ¨è·Ÿè¸ªçš„ <code>NativeInputEventReceiver</code> æ„é€ å‡½æ•°çš„å…¥å‚ï¼Œä¼ é€’è¿‡æ¥çš„å‚æ•°ä¸€ä¸ªæ˜¯ <code>InputChannel</code> ï¼Œé‡Œé¢åŒ…å«äº†å±äº APP ç«¯çš„ <code>socket</code>ï¼Œè¿˜æœ‰ä¸€ä¸ªå‚æ•°æ˜¯æ¥è‡ª Java å±‚çš„ <code>MessageQueue</code> å¯¹è±¡</p>
<p>é‚£ä¹ˆï¼Œ<code>NativeInputEventReceiver#nativeInit()</code> æ–¹æ³•é‡Œå®Œæˆçš„äº‹æƒ…æ˜¯ï¼š<strong>åˆ©ç”¨ Java MessageQueue çš„ <code>mPtr</code> å˜é‡æŒæœ‰çš„ <code>NativeMessageQueue</code> å¯¹è±¡ï¼Œæ‰¾åˆ° native Looper</strong></p>
<p><strong>ç„¶åï¼Œåˆ©ç”¨ native å±‚çš„ Looper å¯¹è±¡æ¥ç›‘å¬ä¸€åŒä¼ é€’è¿‡æ¥çš„ <code>InputChannel</code> ä¸­çš„ <code>socketfd</code> ã€‚</strong></p>
<p>è¿™ä¸€æ®µå¬èµ·æ¥å¯èƒ½ä¼šæœ‰ç‚¹ç»•ï¼Œæš‚æ—¶æ²¡ç†è§£æŸä¸ªç‚¹é—®é¢˜ä¹Ÿä¸å¤§ï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“ï¼Œåœ¨è®¾ç½®è§†å›¾çš„æ—¶å€™ï¼Œé¡ºä¾¿åˆ›å»ºäº†å’Œ IMS é€šä¿¡çš„é€šé“å°±è¡Œäº†</p>
<p>å¥½äº†ï¼ŒAPP ç«¯çš„ <code>socket</code>ï¼ˆ<em><code>sockets[1]</code></em>ï¼‰ å›ä¼ å·¥ä½œç®—æ˜¯ç»“æŸäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹æ€ä¹ˆæŠŠ <code>sockets[0]</code> ä¼ é€’ç»™ IMS</p>
<h3 id="3-sockets0-ä¼ é€’åˆ°-ims">3ã€sockets[0] ä¼ é€’åˆ° IMS</h3>
<p>IMS ç«¯çš„ <code>socket</code> æœ€ç»ˆæ˜¯ç”± InputDispatcher æ¥ä¿ç®¡ï¼Œå› ä¸ºåˆ†å‘äº‹ä»¶æ—¶ï¼Œæ˜¯ InputDispatcher ç›´æ¥ä½¿ç”¨ <code>socket</code> é€šçŸ¥ APP çš„</p>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬æœ¬å°èŠ‚çš„ç›®æ ‡æ˜¯ï¼š<strong>ææ¸…æ¥š IMS ç«¯çš„ <code>socket</code> æ˜¯å¦‚ä½•ä¼ é€’åˆ° InputDispatcher ç±»ä¸­çš„ï¼Ÿ</strong></p>
<p>IMS ä¼ é€’çš„èµ·ç‚¹ï¼Œä¾æ—§æ˜¯åœ¨ <code>WindowState#openInputChannel()</code> æ–¹æ³•ä¸­ï¼š</p>
<pre><code class="language-java">/frameworks/base/services/core/java/com/android/server/wm/WindowState.java
class WindowState {

    void openInputChannel(InputChannel outInputChannel) {
        // 1. Client ç«¯ InputChanenl è°ƒç”¨ transforTo() æ–¹æ³•ä¼ ç»™ ViewRootImpl çš„ mInputChannel
        mClientChannel.transferTo(outInputChannel);
        // 2. Server ç«¯ InputChannel å­˜åœ¨ WindowState çš„ mInputChannel å˜é‡
        InputManagerService.registerInputChannel(mInputChannel);
    }
}

/frameworks/base/services/core/java/com/android/server/input/InputManagerService.java
class InputManagerService {

    void registerInputChannel(){
        nativeRegisterInputChannel(mPtr, inputChannel, inputWindowHandle, false);
    }
}
</code></pre>
<p><code>InputManagerService#registerInputChannel()</code> åˆæ˜¯ä¸€ä¸ªç©ºå£³ï¼Œå…·ä½“å®ç°åœ¨ native ï¼Œç»§ç»­å‘ä¸‹è·Ÿ</p>
<pre><code class="language-c++">/frameworks/base/services/core/jni/com_android_server_input_InputManagerService.cpp
class NativeInputManager {

    void nativeRegisterInputChannel(){
        InputManager-&gt;getDispatcher()-&gt;registerInputChannel(inputChannel, inputWindowHandle, monitor);
    }
}

/frameworks/native/services/inputflinger/InputDispatcher.cpp
class InputDispatcher {

    status_t InputDispatcher::registerInputChannel(inputChannel,inputWindowHandle,monitor){
        // å°†ä»£è¡¨çª—å£é€šä¿¡çš„ inputChannel ï¼Œä»¥åŠä»£è¡¨çª—å£ä¿¡æ¯çš„ inputWindowHandle å°è£…æˆ Connection å¯¹è±¡
        sp&lt;Connection&gt; connection = new Connection(inputChannel, inputWindowHandle, monitor);
        mConnectionsByFd.add(fd, connection);
        ... // çœç•¥ IMS ç›‘å¬æ¥è‡ª client çš„ä»£ç ï¼Œè¿™éƒ¨åˆ†æ˜¯å¤„ç† ANR çš„é€»è¾‘
    }
}
</code></pre>
<p><code>NativeInputManager#nativeRegisterInputChannel()</code> éšæ‰‹åˆæ˜¯ä¸€ä¸ªè½¬å‘</p>
<p>åœ¨ <code>InputDispatcher#registerInputChannel()</code> æ–¹æ³•ä¸­ï¼Œç»è¿‡ä¸€ç•ªé•¿é€”è·‹æ¶‰ï¼Œæœ€ç»ˆå°† <code>socket</code> æ³¨å†Œåˆ° InputDispatcherï¼Œä¸€èµ·è¢«æ³¨å†Œè¿‡æ¥çš„è¿˜æœ‰ä»£è¡¨è¯¥çª—å£ä¿¡æ¯çš„ <code>inputWindowHandle</code></p>
<p>ä»£è¡¨çª—å£é€šä¿¡çš„ <code>inputChannel</code> ï¼Œä»¥åŠä»£è¡¨çª—å£ä¿¡æ¯çš„ <code>inputWindowHandle</code> è¢«å°è£…æˆ <code>Connection</code> å¯¹è±¡ï¼Œä¿å­˜åˆ° <code>mConnectionsByFd</code> é›†åˆä¸­</p>
<p>è‡³æ­¤ï¼ŒIMS ç«¯çš„ <code>socket</code> ä¼ é€’å·¥ä½œç»“æŸï¼ŒAPP å’Œ IMS å¯ä»¥æ„‰å¿«çš„é€šä¿¡äº†</p>
<p>æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹</p>
<figure data-type="image" tabindex="12"><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f6f49ee52fdf4f39803b382dfd0c6a22~tplv-k3u1fbpfcp-watermark.image?" alt="android_graphic_v5_wms_process.png" loading="lazy"></figure>
<p><em>å›¾ç‰‡æ¥æºï¼šè‡ªå·±ç”»çš„</em></p>
<h2 id="è§¦æ‘¸äº‹ä»¶åˆ°è¾¾-viewrootimpl">è§¦æ‘¸äº‹ä»¶åˆ°è¾¾ ViewRootImpl</h2>
<p>å¥½äº†ï¼Œä¸‡äº‹ä¿±å¤‡ï¼Œåªæ¬ ä¸œé£</p>
<p>ç°åœ¨ APP è¿›ç¨‹èµ·æ¥äº†ï¼ŒAPP å’Œ IMS ä¹ŸæˆåŠŸå»ºç«‹äº†é€šä¿¡ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æŒ‰ä¸‹å±å¹•ï¼Œçœ‹çœ‹è§¦æ‘¸äº‹ä»¶æ˜¯æ€ä¹ˆåˆ°è¾¾æˆ‘ä»¬ç†Ÿæ‚‰çš„ View çš„</p>
<pre><code class="language-c++">/frameworks/base/core/jni/android_view_InputEventReceiver.cpp
class NativeInputEventReceiver {

    static jlong nativeInit(env, clazz, receiverWeak, inputChannelObj,  messageQueueObj) { // ç®€ç•¥å†™æ³•
       int fd = inputChannelObj-&gt;getFd();
       messageQueueObj-&gt;getLooper()-&gt;addFd(fd, 0, events, this, NULL);
       ...
    }

}
</code></pre>
<p>åœ¨ä»‹ç» APP ç«¯çš„ <code>socket</code> å›ä¼ ä¸€èŠ‚ä¸­ï¼Œæœ€åä¸€æ­¥åœåœ¨äº†<code> NativeInputEventReceiver#nativeInit()</code> æ–¹æ³•ï¼Œåˆ©ç”¨ Looper ç›‘å¬äº† <code>socketfd</code></p>
<p>ç°åœ¨æˆ‘ä»¬æ¥èŠèŠï¼š<strong>å½“ <code>socketfd</code> æœ‰æ¶ˆæ¯æ—¶ï¼ŒAPP ç«¯ä¼šæ€ä¹ˆå¤„ç†ï¼Œäº‹ä»¶æ˜¯æ€ä¹ˆåˆ†å‘åˆ°æ ¹ View çš„ï¼Ÿ</strong></p>
<pre><code class="language-c++">/frameworks/base/core/jni/android_view_InputEventReceiver.cpp
class NativeInputEventReceiver {

    int NativeInputEventReceiver::handleEvent( receiveFd, events, data) {
        switch (type) { // ç®€ç•¥å†™æ³•ï¼Œè¿™æ˜¯ consumeEvents() æ–¹æ³•ä¸­çš„é€»è¾‘
            case AINPUT_EVENT_TYPE_KEY: {
                inputEventObj = factory-&gt;createKeyEvent(); // è½¬æ¢ä¸ºæŒ‰é”®ç±»å‹äº‹ä»¶ KeyEvent
            }
            case AINPUT_EVENT_TYPE_MOTION: {
                inputEventObj = factory-&gt;createMotionEvent(); // è½¬è½¬ä¸ºè§¦æ‘¸ç±»å‹äº‹ä»¶ MotionEvent
            }
        }
        env-&gt;CallVoidMethod(receiverObj.get(),dispatchInputEvent, seq, inputEventObj); // å›è°ƒåˆ° Java
    }
}
</code></pre>
<p>APP ç«¯çš„ <code>socketfd</code> å‘ç”Ÿäº‹ä»¶å˜åŒ–æ—¶ï¼ŒLooper æ ¹æ®æŒ‡å®šçš„å›è°ƒåœ°å€ï¼Œè°ƒç”¨åˆ° <code>NativeInputEventReceiver#handleEvent()</code> æ–¹æ³•</p>
<p>åœ¨ <code>NativeInputEventReceiver#handleEvent()</code> æ–¹æ³•ä¸­ï¼Œæ ¹æ®äº‹ä»¶ç±»å‹ï¼Œåˆ›å»ºä¸åŒçš„äº‹ä»¶å¯¹è±¡</p>
<p>æœ€åï¼Œåˆ©ç”¨ <code>CallVoidMethod</code> å›è°ƒ Java æ–¹æ³•ï¼Œå°†äº‹ä»¶ä¼ é€’åˆ° Java å±‚çš„ <code>InputEventReceiver#dispatchInputEvent()</code> æ–¹æ³•</p>
<pre><code class="language-java">/frameworks/base/core/java/android/view/InputEventReceiver.java
abstract class InputEventReceiver {

    // Called from native code.
    private void dispatchInputEvent(int seq, InputEvent event) {
        onInputEvent(event);
    }
}

/frameworks/base/core/java/android/view/ViewRootImpl.java
class ViewRootImpl extends InputEventReceiver {
    
    class WindowInputEventReceiver extends InputEventReceiver {

        @Override
        public void onInputEvent(InputEvent event) {
            enqueueInputEvent(event, this, 0, true);
        }
    }

    void enqueueInputEvent(InputEvent event,InputEventReceiver receiver, int flags, boolean processImmediately) {
        ...
        // æ‰§è¡Œæ¶ˆæ¯å…¥åˆ—ä»¥åï¼Œæ¥ç€è¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„æµæ°´çº¿è¿‡ç¨‹ï¼Œæˆ‘ä»¬è¿™é‡Œå…ˆä¸å…³å¿ƒï¼Œç›´æ¥æ¥çœ‹ processPointerEvent() æ–¹æ³•
        // input æ¶ˆæ¯åˆ°è¾¾ ViewRootImpl åï¼ŒGoogle ä½¿ç”¨è´£ä»»é“¾çš„æ¨¡å¼ï¼Œå°†è¾“å…¥äº‹ä»¶æ‹†åˆ†ä¸º KeyEvent å’Œ MotionEvent ä¸¤ç§ç±»å‹ï¼Œåšè¿›ä¸€æ­¥çš„å¤„ç†
        //
        if(event.getType == input) processPointerEvent(event);
        if(event.getType == key) processKeyEvent(event);
    }

    // è´£ä»»é“¾æ¨¡å¼ï¼Œæ¯ä¸ª InputStage è´Ÿè´£ä¸åŒçš„åŠŸèƒ½ï¼Œé“¾ä¸­çš„æŸä¸ª InputStage çš„ç»“æœä¼šå½±å“å¯¹ä¸‹ä¸€èŠ‚ç‚¹çš„æ‰§è¡Œï¼Œæˆ–åœæ­¢ç»§ç»­åˆ†å‘ç­‰
    // åœ¨ ViewRootImpl#setView() å‡½æ•°ä¸­æŒ‡å®šè´£ä»»é“¾çš„å‰åé¡ºåºï¼Œè¿™é‡Œä¸å±•å¼€è®¨è®ºï¼Œè¯·æŸ¥çœ‹å‚è€ƒèµ„æ–™åˆ—è¡¨ä¸­ã€Šè¿™ä¸€æ¬¡ï¼Œå¸¦ä½ å½»åº•å¼„æ‡‚ Android äº‹ä»¶åˆ†å‘æœºåˆ¶(å¤–/å†…å±‚è´£ä»»é“¾)ã€‹
    class InputStage {

        // åœ¨ ViewRootImpl ä¸­æœ‰å¥½å‡ ä¸ªåŒå processPointerEvent() æ–¹æ³•ï¼Œ eventTarget é€šå¸¸æ˜¯ ViewRootImpl ä¿å­˜çš„ DecorView å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ä¼šè°ƒç”¨åˆ° View#dispatchPointerEvent() æ–¹æ³•
        private int processPointerEvent(QueuedInputEvent q) {
            MotionEvent event = (MotionEvent)q.mEvent;
            final View eventTarget =  mView; // é€šå¸¸æ˜¯ DecorView
            boolean handled = eventTarget.dispatchPointerEvent(event);
            ...
            return handled ? FINISH_HANDLED : FORWARD;
        }

        private int processKeyEvent(QueuedInputEvent q) {
            KeyEvent event = (KeyEvent)q.mEvent;
            mView.dispatchKeyEvent(event)
            final View eventTarget =  mView; // é€šå¸¸æ˜¯ DecorView
            boolean handled = eventTarget.dispatchPointerEvent(event);
            ...
            return handled ? FINISH_HANDLED : FORWARD;
        }

    }

}
</code></pre>
<p>InputEventReceiver æ˜¯æŠ½è±¡ç±»ï¼Œåœ¨ <code>dispatchInputEvent()</code> æ–¹æ³•ä¸­å›è°ƒ <code>onInputEvent()</code> æ–¹æ³•ã€‚</p>
<p>è€Œ ViewRootImpl çš„å†…éƒ¨ç±» <code>WindowInputEventReceiver</code> å®ç°äº† InputEventReceiver ç±»ï¼Œå¹¶ä¸”åœ¨ <code>onInputEvent()</code> å†…éƒ¨åˆè°ƒç”¨äº† <code>enqueueInputEvent()</code> å…¥åˆ—è¾“å…¥æ¶ˆæ¯</p>
<p>æ‰€ä»¥ï¼Œæ¥ä¸‹æ¥çš„åˆ†å‘é€»è¾‘å…¨éƒ¨éƒ½å‘ç”Ÿåœ¨ <code>ViewRootImpl#enqueueInputEvent()</code> æ–¹æ³•ä¸­</p>
<p>èƒœåˆ©çš„æ›™å…‰å°±åœ¨å‰æ–¹ï¼Œç»§ç»­å†²</p>
<pre><code class="language-java">/frameworks/base/core/java/android/view/ViewRootImpl.java
class ViewRootImpl extends InputEventReceiver {

    void enqueueInputEvent(InputEvent event,InputEventReceiver receiver, int flags, boolean processImmediately) {
        if(event.getType == input) processPointerEvent(event);
        if(event.getType == key) processKeyEvent(event);
    }

    class InputStage {

        private int processPointerEvent(QueuedInputEvent q) {
            MotionEvent event = (MotionEvent)q.mEvent;
            final View eventTarget =  mView; // é€šå¸¸æ˜¯ DecorView
            boolean handled = eventTarget.dispatchPointerEvent(event);
            ...
            return handled ? FINISH_HANDLED : FORWARD;
        }

        private int processKeyEvent(QueuedInputEvent q);// å¤„ç† key äº‹ä»¶ï¼Œå¿½ç•¥
    }

}
</code></pre>
<p><code>input</code> æ¶ˆæ¯åˆ°è¾¾ ViewRootImpl åï¼Œå°†è¾“å…¥äº‹ä»¶æ‹†åˆ†ä¸º<code> KeyEvent</code> å’Œ <code>MotionEvent</code> ä¸¤ç§ç±»å‹ï¼Œåšè¿›ä¸€æ­¥çš„å¤„ç†</p>
<p>Google å›¢é˜Ÿä½¿ç”¨äº†<code>è´£ä»»é“¾æ¨¡å¼</code>æ¥å¤„ç†äº‹ä»¶æ¶ˆæ¯ï¼Œæ¯ä¸ª <code>InputStage</code> è´Ÿè´£ä¸åŒçš„åŠŸèƒ½ï¼Œé“¾ä¸­çš„æŸä¸ª <code>InputStage</code> çš„ç»“æœä¼šå½±å“å¯¹ä¸‹ä¸€èŠ‚ç‚¹çš„æ‰§è¡Œï¼Œæˆ–åœæ­¢åˆ†å‘ç­‰</p>
<p><code>ViewRootImpl#setView()</code> å‡½æ•°ä¸­æŒ‡å®šäº†è´£ä»»é“¾æ‰§è¡Œçš„å‰åé¡ºåºï¼Œæˆ‘ä»¬è¿™é‡Œä¸å±•å¼€è®¨è®ºï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥æŸ¥çœ‹å‚è€ƒèµ„æ–™åˆ—è¡¨ä¸­<a href="https://juejin.cn/post/6925336861137174541">ã€Šè¿™ä¸€æ¬¡ï¼Œå¸¦ä½ å½»åº•å¼„æ‡‚ Android äº‹ä»¶åˆ†å‘æœºåˆ¶(å¤–/å†…å±‚è´£ä»»é“¾)ã€‹</a></p>
<p>ä¸ºäº†çœäº‹ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹ <code>processPointerEvent()</code> å¤„ç†è§¦æ‘¸äº‹ä»¶çš„æ–¹æ³•</p>
<p>åœ¨ <code>processPointerEvent()</code> æ–¹æ³•ä¸­ï¼Œå…ˆæ˜¯å°† <code>InputEvent</code> å¼ºè½¬ä¸º <code>MotionEvent</code> ï¼Œç„¶åï¼Œè°ƒç”¨ <code>mView</code> çš„ <code>dispatchPointerEvent()</code> æ–¹æ³•æ‰§è¡Œåˆ†å‘</p>
<h2 id="è§¦æ‘¸äº‹ä»¶åˆ°è¾¾-decorview">è§¦æ‘¸äº‹ä»¶åˆ°è¾¾ DecorView</h2>
<p>äº†è§£ Window åˆ›å»ºæµç¨‹çš„æœ‹å‹è‚¯å®šçŸ¥é“ï¼Œ<code>mView</code> å°±æ˜¯ DecorView ï¼Œé‚£è¿™é‡Œå…¶å®è°ƒç”¨çš„æ˜¯ <code>DecorView#dispatchPointerEvent()</code> æ‰§è¡Œåˆ†å‘ï¼Œæ¥ç€æ¥è·Ÿè¸ª</p>
<pre><code class="language-java">/frameworks/base/core/java/android/view/View.java
class View {

    public final boolean dispatchPointerEvent(MotionEvent event) {
        if (event.isTouchEvent()) {
            return dispatchTouchEvent(event);
        } else {
            return dispatchGenericMotionEvent(event);
        }
    }
}
</code></pre>
<p>DecorView ç»§æ‰¿è‡ª <code>FrameLayout</code> ï¼ŒFrameLayout ç»§æ‰¿è‡ª <code>ViewGroup</code> ï¼ŒViewGroup ç»§æ‰¿è‡ª <code>View</code></p>
<p>View çš„ <code>dispatchPointerEvent()</code> æ˜¯ <code>final</code> å…³é”®å­—ä¿®é¥°çš„ï¼Œä¸å…è®¸å­ç±»é‡å†™</p>
<p>æ‰€ä»¥ï¼Œè°ƒç”¨ <code>DecorView#dispatchPointerEvent()</code> å®é™…çš„æ‰§è¡Œè€…æ˜¯ View</p>
<p>åœ¨ <code>View#dispatchPointerEvent()</code> æ–¹æ³•ä¸­ï¼Œé¦–å…ˆåˆ¤æ–­æ˜¯ä¸æ˜¯è§¦æ‘¸äº‹ä»¶ï¼Œé‚£è‚¯å®šæ˜¯å•Š</p>
<p>æ¥ç€è°ƒç”¨ <code>dispatchTouchEvent()</code> æ–¹æ³•æ‰§è¡Œåˆ†å‘</p>
<p><code>dispatchTouchEvent()</code> æ²¡æœ‰è¢« <code>final</code> ä¿®é¥°ï¼Œå¯ä»¥è¢«é‡å†™ï¼Œæ‰€ä»¥æˆ‘ä»¬ç°åœ¨å›åˆ° DecorView çš„ <code>dispatchTouchEvent()</code> æ–¹æ³•ä¸­</p>
<pre><code class="language-java">/frameworks/base/core/java/com/android/internal/policy/DecorView.java
class DecorView extends FrameLayout {
    
    @Override
    public boolean dispatchTouchEvent(MotionEvent ev) {
        Window.Callback cb = mWindow.getCallback(); // ç»™ Activity å’Œ Dialog æ‹¦æˆªäº‹ä»¶çš„æœºä¼š
        return cb != null ? cb.dispatchTouchEvent(ev) : super.dispatchTouchEvent(ev);
    }
}
</code></pre>
<p>åœ¨ <code>DecorView#dispatchTouchEvent()</code> æ–¹æ³•ä¸­ï¼Œå…ˆæ˜¯åˆ¤æ–­äº† <code>mWindow</code> æŒæœ‰çš„ Callback æ˜¯å¦ä¸ºç©º</p>
<p>è¿™é‡Œä¸´æ—¶è¡¥å……ä¸¤ä¸ªå°ç»†èŠ‚</p>
<ol>
<li><strong>Window.Callback æ˜¯ä¸ªæ¥å£ï¼Œè€Œ Activity å’Œ Dialog éƒ½å®ç°äº†è¿™ä¸ªæ¥å£</strong></li>
<li><strong>DecorView æŒæœ‰çš„ <code>mWindow</code> çš„èµ‹å€¼è·¯å¾„æ˜¯è¿™æ ·çš„ï¼š<code>PhoneWindow#setContentView()</code> -&gt; <code>installDecor()</code> -&gt; <code>generateDecor()</code> -&gt; <code>DecorView#setWindow()</code>ï¼Œä¸å±•å¼€è®¨è®ºäº†</strong></li>
</ol>
<p>æ¥ç€çœ‹ä»£ç ï¼Œå¦‚æœ <code>mWindow</code> çš„ Callback ä¸ä¸ºç©ºï¼Œåˆ™ä¼˜å…ˆè°ƒç”¨ Callback çš„ <code>dispatchTouchEvent()</code> å‡½æ•°æ‰§è¡Œåˆ†å‘</p>
<p>æˆ‘ä»¬ä»¥ Activity æ¥ä¸¾ä¾‹</p>
<pre><code class="language-java">/frameworks/base/core/java/android/app/Activity.java
class Activity {
    
    public boolean dispatchTouchEvent(MotionEvent ev) {
        if (getWindow().superDispatchTouchEvent(ev)) {
            return true;
        }
        return onTouchEvent(ev);
    }

    public boolean onTouchEvent(MotionEvent event) {
        ...
    }
}

/frameworks/base/core/java/com/android/internal/policy/PhoneWindow.java
class PhoneWindow {
    public boolean superDispatchTouchEvent(MotionEvent event) {
        return mDecor.superDispatchTouchEvent(event);
    }
}

/frameworks/base/core/java/com/android/internal/policy/DecorView.java
class DecorView extends FrameLayout {
    
    public boolean superDispatchTouchEvent(MotionEvent event) {
        return super.dispatchTouchEvent(event);
    }
}
</code></pre>
<p>Activity çš„ <code>dispatchTouchEvent()</code> æ–¹æ³•è¢«è°ƒç”¨åï¼Œå…ˆè°ƒç”¨äº† <code>getWindow().superDispatchTouchEvent(ev)</code> æ‰§è¡Œåˆ†å‘ï¼Œæ²¡äººå¤„ç†å†è°ƒç”¨è‡ªèº«çš„ <code>onTouchEvent() </code>æ–¹æ³•</p>
<p>è€Œ <code>getWindow().superDispatchTouchEvent()</code> æ–¹æ³•å…œå…œè½¬è½¬ä¸€åœˆï¼Œè¿˜æ˜¯è°ƒç”¨åˆ° <code>DecorView#superDispatchTouchEvent()</code> ä¸­</p>
<p>å‰é¢è¯´è¿‡äº†ï¼ŒDecorView ç»§æ‰¿è‡ª FrameLayout ï¼ŒFrameLayout æ˜¯æ²¡æœ‰é‡å†™ <code>dispatchTouchEvent()</code> æ–¹æ³•çš„ï¼ŒFrameLayout ç»§æ‰¿è‡ª ViewGroup ï¼ŒViewGroup é‡å†™äº† <code>dispatchTouchEvent()</code></p>
<p>æ‰€ä»¥ï¼Œæœ€ç»ˆæ‰§è¡Œåˆ†å‘çš„è¿˜æ˜¯ <code>ViewGroup#dispatchTouchEvent()</code> æ–¹æ³•</p>
<p><strong>åˆç€ç»•äº†ä¸€åœˆï¼ŒActivity æ˜¯å•¥ä¹Ÿæ²¡åšæ˜¯å§ï¼Ÿ</strong></p>
<p>ummmm~  æ˜¯çš„</p>
<p>ä¸è¿‡ï¼Œæˆ‘è§‰å¾—è¿™æ ·çš„è®¾è®¡æ˜¯åœ¨ç»™ <code>Activity</code> / <code>Dialog</code> æ‹¦æˆªäº‹ä»¶çš„æœºä¼šï¼Œæ¯•ç«Ÿå¦‚æœæˆ‘ä»¬åœ¨ Activity ä¸­é‡å†™äº† <code>dispatchTouchEvent()</code> æ–¹æ³•ï¼Œæ˜¯å¯ä»¥è®©æ•´æ£µ View æ ‘éƒ½æ¥æ”¶ä¸åˆ°è§¦æ‘¸äº‹ä»¶çš„</p>
<p>å¥½ï¼Œç°åœ¨è§¦æ‘¸äº‹ä»¶åˆ†å‘çš„èµ·ç‚¹åˆ°äº†æˆ‘ä»¬éå¸¸ç†Ÿæ‚‰çš„ <code>ViewGroup#dispatchTouchEvent()</code> è¿™é‡Œ</p>
<p>æ¥ä¸‹æ¥çš„ä¸€æ•´ç« ï¼Œæˆ‘ä»¬æ¥å¤ä¹  View / ViewGroup äº‹ä»¶åˆ†å‘çš„æµç¨‹</p>
<h1 id="ä¸‰-è§¦æ‘¸äº‹ä»¶çš„æ¶ˆè´¹application">ä¸‰ã€è§¦æ‘¸äº‹ä»¶çš„æ¶ˆè´¹ï¼ˆApplicationï¼‰</h1>
<p>åœ¨ä¹‹å‰çš„ä¸¤èŠ‚å†…å®¹ä¸­ï¼Œä¸€ä¸ª <code>input</code> äº‹ä»¶ä¸€è·¯ä»ç¡¬ä»¶é©±åŠ¨ï¼ŒæˆåŠŸçš„åˆ°è¾¾åº”ç”¨çš„ <code>DecorView</code></p>
<p>æˆ‘ä»¬æ¥ä¸‹æ¥çš„ä»»åŠ¡æ˜¯ï¼ŒæŠŠè¿™ä¸ªäº‹ä»¶åˆ†å‘ç»™æŸä¸ªå…·ä½“çš„ View æˆ–è€…æ˜¯ ViewGroup</p>
<p>æ­£æ–‡å¼€å§‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥èŠèŠè§¦æ‘¸äº‹ä»¶çš„æœ¬ä½“ï¼š<code>MotionEvent</code></p>
<p><code>MotionEvent</code> è¡¨ç¤ºä¸€ä¸ª<code>è§¦æ‘¸äº‹ä»¶</code>ï¼Œé‡Œé¢åŒ…å«äº†äº‹ä»¶çš„ç±»å‹ï¼Œè§¦æ‘¸çš„ä½ç½®ä¿¡æ¯ç­‰ï¼Œå¯¹åˆ†å‘è€…æ¥è¯´ï¼Œäº‹ä»¶çš„ç±»å‹éå¸¸é‡è¦ï¼Œæ¥ç®€å•è®¤è¯†ä¸€ä¸‹</p>
<ul>
<li><strong><code>ACTION_DOWN</code>ï¼š æŒ‰ä¸‹å±å¹•</strong></li>
<li><strong><code>ACTION_MOVE</code>ï¼šæ‰‹æŒ‡æ»‘åŠ¨</strong></li>
<li><strong><code>ACTION_UP</code>ï¼šæŠ¬èµ·æ‰‹æŒ‡ï¼Œç¦»å¼€å±å¹•</strong></li>
<li><strong><code>ACTION_CANCEL</code>ï¼šéæ­£å¸¸æŠ¬èµ·ï¼Œå‡ ä¹ç­‰åŒäº <code>ACTION_UP</code> ï¼Œé€šå¸¸æ˜¯çˆ¶è§†å›¾æ‹¦æˆª</strong></li>
<li><strong><code>ACTION_POINTER_DOWN</code>ï¼šå¤šæŒ‡è§¦æ‘¸ï¼Œè¡¨ç¤ºå·²ç»æœ‰ä¸€åªæ‰‹æŒ‡æŒ‰ä¸‹æ—¶ï¼Œå¦æœ‰ä¸€åªæ‰‹æŒ‡å†æ¬¡æŒ‰ä¸‹</strong></li>
<li><strong><code>ACTION_POINTER_UP</code>ï¼šå¤šæŒ‡è§¦æ‘¸ï¼Œè¡¨ç¤ºå±å¹•ä¸Šå·²ç»æœ‰å¤šä¸ªæ‰‹æŒ‡ï¼ŒæŠ¬èµ·å…¶ä¸­ä¸€åªæ‰‹æŒ‡åè§¦å‘çš„äº‹ä»¶</strong></li>
</ul>
<p>å‡ ç§å¸¸ç”¨è§¦æ‘¸çš„ç±»å‹å°±è¿™ä¹ˆå¤šï¼Œæœ€åä¸¤ç§æ˜¯å¤šæŒ‡è§¦æ‘¸çš„æƒ…å†µä¸‹æ‰ä¼šæ”¶åˆ°çš„äº‹ä»¶ç±»å‹ï¼Œæœ¬æ–‡æˆ‘ä»¬ä¸æ‰“ç®—è®¨è®ºå¤šæŒ‡è§¦æ‘¸ï¼ˆ<em>åŒ…æ‹¬ TouchTarget</em>ï¼‰ï¼Œæ‰€ä»¥åé¢ä¼šå¿½ç•¥æ‰</p>
<p>åœ¨ä¸€æ¬¡äº‹ä»¶åˆ†å‘ä¸­ï¼Œä»¥æ¯ä¸ª <code>DOWN</code> äº‹ä»¶ä¸ºå¼€å§‹ï¼Œ <code>UP</code> / <code>CANCEL</code> äº‹ä»¶ä¸ºåœæ­¢ï¼Œåœ¨ <code>DOWN</code> -&gt; <code>MOVE</code> -&gt; <code>MOVE</code> -&gt; <code>UP</code> / <code>CANCEL</code> æ•´ä¸ªè¿‡ç¨‹çœ‹åšæ˜¯ä¸€ä¸ªäº‹ä»¶åºåˆ—</p>
<h2 id="viewgroup-çš„æ¶ˆè´¹-åˆ†å‘-æ‹¦æˆªä¸æ”¾è¡Œ">ViewGroup çš„æ¶ˆè´¹ã€åˆ†å‘ã€æ‹¦æˆªä¸æ”¾è¡Œ</h2>
<p>åœ¨è¿›å…¥ ViewGroup çš„æºç ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼š<strong>ä»€ä¹ˆæ˜¯äº‹ä»¶åˆ†å‘ï¼Ÿ</strong></p>
<p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œåœ¨ Android å›¾å½¢ç³»ç»Ÿä¸­ï¼Œä¸»è¦ç»˜å›¾çš„ä»»åŠ¡æ˜¯äº¤ç»™ View å»å®Œæˆçš„ï¼ŒViewGroup æ˜¯ä½œä¸ºç®¡ç†è§†å›¾çš„å®¹å™¨ï¼Œå®ƒçš„ä»»åŠ¡æ˜¯æŒ‰ç…§ä¸€å®šçš„è§„åˆ™æ‘†æ”¾å­ Viewï¼Œè‡ªèº«åˆ™åŸºæœ¬ä¸å‚ä¸ç»˜å›¾æ“ä½œ</p>
<p>ä½†æ˜¯åœ¨è§¦æ‘¸äº‹ä»¶çš„åˆ†å‘ä¸­ï¼ŒViewGroup å¯¹è§¦æ‘¸äº‹ä»¶çš„æ€åº¦å°±å˜äº†ï¼Œå› ä¸ºå®ƒå’Œå­ View ä¸€æ ·ï¼Œéƒ½å¯èƒ½éœ€è¦å“åº”è§¦æ‘¸äº‹ä»¶</p>
<h3 id="1-viewgroup-å››ç§åœºæ™¯">1ã€ViewGroup å››ç§åœºæ™¯</h3>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œæœ‰ä¸€ä¸ªå¯ä»¥çºµå‘æ»‘åŠ¨çš„ ViewGroup ï¼Œé‡Œé¢æ‘†æ»¡äº† <code>TextView</code> ï¼Œç”¨æˆ·åœ¨æ»‘åŠ¨å±å¹•æ—¶ï¼Œè‚¯å®šæ˜¯æœŸæœ›å±•ç¤ºæ›´å¤šå†…å®¹çš„ã€‚é‚£ä¹ˆè¿™æ—¶å€™ï¼Œå°±éœ€è¦ ViewGroup å¯¹å­ View é‡æ–°å¸ƒå±€æ‘†æ”¾ï¼Œå°†éšè—åœ¨å±å¹•åº•éƒ¨çš„å­ View æ˜¾ç¤ºå‡ºæ¥</p>
<figure data-type="image" tabindex="13"><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f984d3a1b5ba4c509825bbe1269cb69e~tplv-k3u1fbpfcp-watermark.image?" alt="android_graphic_v5_viewgroup_consumed.GIF" loading="lazy"></figure>
<p><em>å›¾ç‰‡æ¥æºï¼šè‡ªå·±å½•çš„</em></p>
<p>ä¸Šé¢çš„åœºæ™¯ä¸­ï¼ŒViewGroup å¿…é¡»è¦æ‹¿åˆ°ç”¨æˆ·æ»‘åŠ¨å±å¹•çš„æ•°æ®ï¼Œæ‰èƒ½è®¡ç®—å±•ç¤ºå¤šå°‘è§†å›¾æ‰ç®—åˆé€‚</p>
<p><strong>å³ï¼ŒViewGroup éœ€è¦æ¶ˆè´¹è§¦æ‘¸äº‹ä»¶</strong></p>
<p>å†ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨ä¸€ä¸ªä¸æ”¯æŒæ»‘åŠ¨çš„ ViewGroup ä¸­ï¼Œæœ‰ä¸ªå±…ä¸­æ˜¾ç¤ºçš„ <code>Button</code> æŒ‰é’®</p>
<figure data-type="image" tabindex="14"><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/811bb5cbc6564c8da7153b768c77e7e0~tplv-k3u1fbpfcp-watermark.image?" alt="android_graphic_v5_viewgroup_dispatch.GIF" loading="lazy"></figure>
<p><em>å›¾ç‰‡æ¥æºï¼šè‡ªå·±å½•çš„</em></p>
<p>ç”¨æˆ·æŒ‰ä¸‹å±å¹•åï¼ŒViewGroup è‚¯å®šæ¯”è‡ªå·±çš„å­ View è¦ä¼˜å…ˆæ‹¿åˆ°è§¦æ‘¸äº‹ä»¶</p>
<p>è€Œ ViewGroup è‡ªèº«åˆä¸éœ€è¦è¿™ä¸ªäº‹ä»¶ï¼Œé‚£ä¹ˆï¼Œå®ƒå°±éœ€è¦æ ¹æ®è§¦æ‘¸ä½ç½®å»æŸ¥æ‰¾ï¼Œæœ‰æ²¡æœ‰å­ View éœ€è¦è¯¥äº‹ä»¶</p>
<p>ç»è¿‡è®¡ç®—ï¼Œå¦‚æœå‘ç°ç”¨æˆ·æŒ‰åäº†ï¼Œæ²¡ç‚¹åˆ° <code>Button</code> ï¼Œé‚£å°±ä¸ç®¡äº†ï¼Œ<code>dispatchTouchEvent()</code> è¿”å› false ï¼Œçˆ±è°æ¶ˆè´¹è°æ¶ˆè´¹ï¼Œåæ­£æˆ‘ä¸è¦</p>
<p>å¦‚æœå‘ç°ç”¨æˆ·æŒ‰åˆ°äº†ä¸­é—´çš„ <code>Butto</code>n ï¼Œè¿™æ—¶å€™ ViewGroup å°±éœ€è¦æŠŠè¿™ä¸ªäº‹ä»¶äº¤ç»™ <code>Button</code> ï¼Œè¯¢é—®å­ View è¦ä¸è¦æ¶ˆè´¹</p>
<p><strong>å³ï¼Œ ViewGroup éœ€è¦åˆ†å‘äº‹ä»¶</strong></p>
<p>å†å†ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨ä¸€ä¸ªæ”¯æŒçºµå‘æ»‘åŠ¨çš„ ViewGroup ä¸­ï¼Œæœ‰ä¸ªå±…ä¸­æ˜¾ç¤ºçš„ <code>Button</code> æŒ‰é’®</p>
<p>ç°åœ¨ï¼Œç”¨æˆ·æŒ‰ä¸‹äº†å±å¹•ä¸­çš„ <code>Button</code> ï¼ŒViewGroup è§‰å¾—ä¸æ˜¯æ»‘åŠ¨äº‹ä»¶ï¼Œå°±æŠŠè¿™ä¸ªäº‹ä»¶åˆ†å‘ç»™äº† <code>Button</code></p>
<p>ä½†æ˜¯ç”¨æˆ·åœ¨æŒ‰ä¸‹ <code>Button</code> åï¼Œæ¥ç€åˆå¼€å§‹æ»‘åŠ¨å±å¹•äº†</p>
<figure data-type="image" tabindex="15"><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5891488d6de04c0dbb2751b3439c0043~tplv-k3u1fbpfcp-watermark.image?" alt="android_graphic_v5_viewgroup_intercept.GIF" loading="lazy"></figure>
<p><em>å›¾ç‰‡æ¥æºï¼šè‡ªå·±å½•çš„</em></p>
<p>æ­¤æ—¶çš„ ViewGroup éœ€è¦è®¡ç®—æ»‘åŠ¨è·ç¦»ï¼Œæ‰€ä»¥æ˜¯éœ€è¦è¿™ä¸ªè§¦æ‘¸äº‹ä»¶çš„ï¼Œé‚£åªèƒ½å¯¹ä¸èµ· <code>Button</code> äº†ï¼ŒViewGroup ä¼šæŠŠæœ¬æ¥å‡†å¤‡åˆ†å‘ç»™ <code>Button</code> çš„äº‹ä»¶æ‹¦æˆªæ¶ˆè´¹æ‰</p>
<p><strong>å³ï¼ŒViewGroup éœ€è¦æ‹¦æˆªäº‹ä»¶</strong></p>
<p>å¦å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è€ƒè™‘ä¸€ç§æç«¯æƒ…å†µï¼š<strong>å¦‚æœå­ View å’Œ ViewGroup éƒ½éœ€è¦è§¦æ‘¸äº‹ä»¶ï¼Œåº”è¯¥æ€ä¹ˆå¤„ç†ï¼Ÿ</strong></p>
<p>æŒ‰æ­£å¸¸çš„æ‹¦æˆªé€»è¾‘ï¼ŒViewGroup å…ˆæ‹¿åˆ°äº‹ä»¶ï¼Œè‡ªå·±åˆæœ‰æ¶ˆè´¹çš„éœ€æ±‚ï¼Œè‚¯å®šæ˜¯ç´§ç€è‡ªå·±ç”¨</p>
<p>ä½†æ˜¯ï¼Œæ€»ä¼šæœ‰åœºæ™¯éœ€è¦å°†äº‹ä»¶ä¼˜å…ˆåˆ†å‘ç»™å­è§†å›¾ï¼Œæ¯”å¦‚ï¼š</p>
<p>åœ¨ä¸€ä¸ªæ”¯æŒçºµå‘æ»šåŠ¨çš„ ViewGroup ï¼Œå®ƒçš„ä¸¤ä¸ªå­ View åŒæ ·æ˜¯æ”¯æŒçºµå‘æ»šåŠ¨çš„ ViewGroup ï¼Œä¸¤ä¸ªå­ View åˆ†åˆ«éƒ½åŒ…å«è‹¥å¹² <code>TextView </code></p>
<p>ç°åœ¨çš„éœ€æ±‚æ˜¯ï¼š<strong>é•¿æŒ‰æŸä¸€ä¸ª <code>TextView</code> æ—¶ï¼Œå…è®¸è¯¥ <code>TextView</code> ä¸Šä¸‹è‡ªç”±æ‹–åŠ¨</strong></p>
<figure data-type="image" tabindex="16"><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/58c4029537de4245b57869bc0076e5d1~tplv-k3u1fbpfcp-watermark.image?" alt="android_graphic_v5_viewgroup_request.GIF" loading="lazy"></figure>
<p><em>å›¾ç‰‡æ¥æºï¼šè‡ªå·±å½•çš„</em></p>
<p>å½“ç”¨æˆ·é•¿æŒ‰ <code>TextView</code> ç§»åŠ¨æ—¶ï¼Œé¢„æœŸæ˜¯ç§»åŠ¨è¿™ä¸ª <code>TextView</code>ï¼Œç†è®ºä¸Šè¿™ä¸ªç§»åŠ¨äº‹ä»¶åº”è¯¥è¢« <code>TextView</code> çš„çˆ¸çˆ¸æ¶ˆè´¹æ‰ï¼Œå› ä¸ºéœ€è¦é‡æ–°å¸ƒå±€ç»˜åˆ¶ï¼›</p>
<p>ä½†å®é™…ä¸Šæ˜¯ <code>TextView</code> çš„çˆ·çˆ·æ¶ˆè´¹æ‰çš„ï¼Œå› ä¸ºçˆ·çˆ·è§‰å¾—ç”¨æˆ·æ˜¯åœ¨æ»‘åŠ¨å±å¹•ï¼Œè¦æŠŠå±å¹•ä¸‹æ–¹æ›´å¤šçš„è§†å›¾æ˜¾ç¤ºå‡ºæ¥</p>
<p><strong>ViewGroup å’Œ ViewGroup ä¸­çš„å­ View éƒ½æƒ³è¦æ¶ˆè´¹äº‹ä»¶ï¼ˆæ»‘åŠ¨å†²çªï¼‰ï¼Œè¿™æ—¶å€™è¯¥æ€ä¹ˆåŠï¼Ÿ</strong></p>
<p>å¾ˆç®€å•ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ç§æœºåˆ¶ï¼Œè®© ViewGroup çŸ¥é“å­ View ä¹Ÿéœ€è¦è¿™ä¸ªäº‹ä»¶</p>
<p>æˆ‘ä»¬æš‚ä¸”æŠŠè¿™å¥—æœºåˆ¶ç§°ä¹‹ä¸º â€œè¯·æ±‚æ”¾è¡Œâ€ å¥½äº†</p>
<p>ViewGroup ä¸ºå­ View å¼€æ”¾ä¸€ä¸ªè¯·æ±‚æ”¾è¡Œçš„æ¥å£ï¼Œå½“ ViewGroup æ”¶åˆ°æ¥è‡ªå­ View çš„æ”¾è¡Œè¯·æ±‚æ—¶ï¼Œä¼˜å…ˆå°†äº‹ä»¶åˆ†å‘ç»™å­ Viewï¼Œè¿™æ ·ï¼Œé—®é¢˜å°±è§£å†³äº†</p>
<p><strong>è§¦æ‘¸äº‹ä»¶çš„<code>æ¶ˆè´¹</code>ã€<code>æ‹¦æˆª</code>ã€<code>æ”¾è¡Œ</code>ä¸<code>åˆ†å‘</code>ï¼Œè¿™å››ç§æƒ…å†µå‡ ä¹è¦†ç›–äº† ViewGroup å¯¹è§¦æ‘¸äº‹ä»¶å¤„ç†ï¼ˆå•æŒ‡ï¼‰çš„æ‰€æœ‰åœºæ™¯</strong></p>
<p>å¥½ï¼Œç°åœ¨ ViewGroup çš„éœ€æ±‚åŸºæœ¬ä¸Šäº†è§£æ¸…æ¥šäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹æºç ä¸­ï¼Œ Google æ˜¯æ€ä¹ˆè¿›è¡Œä»£ç è®¾è®¡çš„</p>
<h3 id="2-äº‹ä»¶çš„æ”¾è¡Œå’Œæ‹¦æˆª">2ã€äº‹ä»¶çš„æ”¾è¡Œå’Œæ‹¦æˆª</h3>
<p>ç¬¬äºŒç« ç»“æŸæ—¶ï¼Œæœ€ç»ˆè°ƒç”¨åœåœ¨äº† <code>ViewGroup#dispatchTouchEvent()</code> æ–¹æ³•ï¼Œè¿™ä¹Ÿæ˜¯æ•´ä¸ª View / ViewGroup äº‹ä»¶åˆ†å‘çš„èµ·æº</p>
<pre><code class="language-java">/frameworks/base/core/java/android/view/ViewGroup.java
class ViewGroup extends View {

    public boolean dispatchTouchEvent(MotionEvent ev) {
        int actionMasked = ev.getAction() &amp; MotionEvent.ACTION_MASK;
        TouchTarget newTouchTarget = null;
        boolean intercepted;
      	boolean handled = false;
        if (actionMasked == MotionEvent.ACTION_DOWN|| mFirstTouchTarget != null) {
            // æ£€æŸ¥å­è§†å›¾æ˜¯å¦è°ƒç”¨äº† requestDisallowInterceptTouchEvent(true) è¯·æ±‚æ”¾è¡Œ
            boolean disallowIntercept = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != 0;
            if (!disallowIntercept) {
              intercepted = onInterceptTouchEvent(ev); // å­è§†å›¾æœªè¯·æ±‚æ”¾è¡Œï¼Œè¯¢é—® ViewGroup è‡ªèº«æ˜¯å¦éœ€è¦æ¶ˆè´¹
            } else {
              intercepted = false;
            }
        } else {
            intercepted = true; // å¦‚æœ mFirstTouchTarget ä¸ºç©ºï¼Œå¹¶ä¸”äº‹ä»¶ç±»å‹ä¸ä¸º DOWN ï¼Œè¡¨ç¤ºå…ˆå‰çš„äº‹ä»¶ä¹Ÿæ˜¯ ViewGroup è‡ªå·±æ¶ˆè´¹çš„ï¼Œæ— éœ€æ‰§è¡Œåˆ†å‘ï¼Œå†æ¬¡äº¤ç»™è‡ªå·±æ‰§è¡Œå³å¯
        }
        return handled;
    }

    public boolean onInterceptTouchEvent(MotionEvent ev) {
        //è¯¢é—® ViewGroup è‡ªèº«æ˜¯å¦éœ€è¦å¤„ç†äº‹ä»¶
        return false;
    }
  
    public void requestDisallowInterceptTouchEvent(boolean disallowIntercept) {
      	if (disallowIntercept) {
          	mGroupFlags |= FLAG_DISALLOW_INTERCEPT;
      	} else {
          	mGroupFlags &amp;= ~FLAG_DISALLOW_INTERCEPT;
      	}
  	}
}
</code></pre>
<p>ViewGroup çš„å‡ ç§åœºæ™¯æˆ‘ä»¬å·²ç»åœ¨ä¸Šé¢ä»‹ç»è¿‡äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å¯¹ç…§æºç è§£é‡Šçš„è¿‡ç¨‹ï¼Œæ¯”è¾ƒè½»æ¾</p>
<p>åœ¨äº‹ä»¶åˆ†å‘çš„å¼€å§‹ï¼Œå…ˆæ˜¯åˆ¤æ–­äº†äº‹ä»¶æ˜¯å¦æ˜¯ <code>DOWN</code> ç±»å‹ï¼Œæˆ–è€… <code>mFirstTouchTarget</code> å˜é‡æ˜¯å¦ä¸ä¸ºç©ºï¼ˆ<em><code>mFirstTouchTarget</code> è®°å½•çš„æ˜¯æ¶ˆè´¹ä¸Šä¸€æ¬¡ <code>DOWN</code> äº‹ä»¶çš„æ˜¯è°</em>ï¼‰</p>
<p>æ»¡è¶³æ¡ä»¶åˆ™è¿›å…¥ â€œæ£€æŸ¥æ”¾è¡Œâ€ å’Œ â€œæ£€æŸ¥æ˜¯å¦è¦æ‹¦æˆªâ€ çš„é€»è¾‘</p>
<p><code>disallowIntercept</code> ä¸º true ï¼Œè¡¨ç¤ºå­è§†å›¾æ˜¯å¦è°ƒç”¨äº† <code>requestDisallowInterceptTouchEvent(true)</code> æ–¹æ³•è¯·æ±‚æ”¾è¡Œï¼Œå°† <code>intercepted</code> æ ‡è¯†ç½®ä¸ºfalse ï¼Œå¹¶ä¸”ï¼Œæœ¬æ¬¡äº‹ä»¶å°†ä¸è¯¢é—® ViewGroup è‡ªèº«æ˜¯å¦è¦æ¶ˆè´¹</p>
<p><strong><code>ViewGroup#requestDisallowInterceptTouchEvent()</code> æ–¹æ³•å°±æ˜¯ä¹‹å‰ä»‹ç»è¿‡çš„ï¼Œå¼€æ”¾ç»™å­ View è¯·æ±‚æ”¾è¡Œçš„ä¸€å¥—æœºåˆ¶</strong></p>
<p>å¦‚æœå­è§†å›¾æ²¡æœ‰è¯·æ±‚æ”¾è¡Œï¼Œé‚£ä¹ˆè°ƒç”¨ <code>onInterceptTouchEvent()</code> è¯¢é—®è‡ªå·±è¦ä¸è¦æ‹¦æˆªæ¶ˆè´¹ï¼Œä¸éœ€è¦æ¶ˆè´¹äº‹ä»¶ä¼šç»§ç»­åˆ†å‘ï¼Œæˆ‘ä»¬åé¢ä¼šè®²åˆ°</p>
<p>å¦‚æœ <code>mFirstTouchTarget</code> ä¸ºç©ºï¼Œå¹¶ä¸”äº‹ä»¶ç±»å‹ä¸ä¸º <code>DOWN</code> ï¼Œè¡¨ç¤ºå…ˆå‰çš„äº‹ä»¶ä¹Ÿæ˜¯ ViewGroup è‡ªå·±æ¶ˆè´¹çš„ï¼Œæ— éœ€æ‰§è¡Œåˆ†å‘ï¼Œå†æ¬¡äº¤ç»™è‡ªå·±æ‰§è¡Œå³å¯ï¼Œå°† <code>intercepted</code> å˜é‡ç½®ä¸º true</p>
<p>ä¸Šé¢è¿™æ®µä»£ç è§£é‡Šå®Œäº†ï¼Œæˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹å¾—åˆ°çš„ä¿¡æ¯ï¼š</p>
<p><strong>åªè¦å­ View æ²¡æœ‰è°ƒç”¨ <code>requestDisallowInterceptTouchEvent()</code> æ–¹æ³•è¯·æ±‚æ”¾è¡Œï¼ŒViewGroup æœ‰æƒåœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œé€šè¿‡è°ƒç”¨ <code>onInterceptTouchEvent()</code> è¿”å› true çš„æ–¹å¼ï¼Œæ‹¦æˆªä»»ä¸€è§¦æ‘¸äº‹ä»¶</strong></p>
<p>æˆ‘ä»¬åœ¨ç»§æ‰¿ ViewGroup ä»¥åï¼Œé¦–å…ˆè¦é‡å†™ <code>onInterceptTouchEvent()</code> æ–¹æ³•ï¼Œç„¶åæˆ‘ä»¬æ ¹æ®è‡ªå·±çš„éœ€æ±‚ï¼Œåˆ¤æ–­è¦ä¸è¦æ¶ˆè´¹æŸä¸ªäº‹ä»¶</p>
<p>true è¡¨ç¤ºè‡ªèº«éœ€è¦æ¶ˆè´¹ï¼Œè¯¥äº‹ä»¶å°†ä¼šè¢«æ‹¦æˆªï¼Œå¹¶ä¼šåœ¨ä¸‹ä¸€æ­¥å‘é€åˆ° ViewGroup è‡ªèº«çš„ <code>onTouchEvent()</code> æ–¹æ³•ä¸­ï¼Œä¸ä¼šç»§ç»­å‘ä¸‹åˆ†å‘</p>
<p>false è¡¨ç¤ºä¸æ¶ˆè´¹ï¼Œç»§ç»­å‘ä¸‹åˆ†å‘äº‹ä»¶</p>
<p>ViewGroup çš„æ”¾è¡Œæœºåˆ¶å’Œæ‹¦æˆªå°±ç»“æŸäº†ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹ä»£ç ï¼Œä¸‹ä¸€æ­¥è¯¥æ‰§è¡Œäº‹ä»¶çš„åˆ†å‘äº†</p>
<h3 id="3-äº‹ä»¶çš„åˆ†å‘">3ã€äº‹ä»¶çš„åˆ†å‘</h3>
<p>å¦‚æœå­è§†å›¾æ²¡æœ‰è¯·æ±‚æ”¾è¡Œï¼ŒViewGroup è‡ªèº«ä¹Ÿä¸æ¶ˆè´¹ï¼Œé‚£ä¹ˆ <code>intercepted</code> æ ‡è¯†ä¸º false ï¼Œè¿›å…¥åˆ†å‘æµç¨‹</p>
<pre><code class="language-java">/frameworks/base/core/java/android/view/ViewGroup.java
class ViewGroup extends View {

    public boolean dispatchTouchEvent(MotionEvent ev) {
        ...
        // å­è§†å›¾æœªè¯·æ±‚æ”¾è¡Œï¼ŒViewGroup è‡ªèº«ä¹Ÿä¸æ¶ˆè´¹ï¼Œè¿›å…¥åˆ†å‘æµç¨‹
        if (!intercepted) {
            if (actionMasked == MotionEvent.ACTION_DOWN) {
                for (int i = mChildrenCount - 1; i &gt;= 0; i--) {
                    ...// æ£€æŸ¥å­ View æ˜¯å¦å¯è§¦æ‘¸ï¼Œæ˜¯å¦åœ¨è§¦æ‘¸åŒºåŸŸå†…ç­‰ç­‰ï¼Œè¿‡ç¨‹ç•¥
                    // æ‰¾åˆ°åˆé€‚çš„å­ View åï¼Œè°ƒç”¨ dispatchTransformedTouchEvent() æ‰§è¡Œäº‹ä»¶åˆ†å‘ï¼Œå¦‚æœè¿”å› trueï¼Œè®°å½•æœ¬æ¬¡åˆ†å‘
                    if (dispatchTransformedTouchEvent(ev, false, child, idBitsToAssign)) {
                        newTouchTarget = addTouchTarget(child, idBitsToAssign); // ç”Ÿæˆä¸€ä¸ªæ–°çš„ TouchTarget å¯¹è±¡ï¼Œç”¨äºè®°å½•æ¶ˆè´¹çš„ View
                        break;
                    }
                }
                // æ²¡æœ‰æ–°çš„éœ€è¦è§¦æ‘¸äº‹ä»¶çš„è§†å›¾ï¼Œé‚£ä¹ˆï¼ŒæŠŠé“¾è¡¨å°¾éƒ¨çš„ TouchTarget æ‹¿å‡ºæ¥ï¼Œåœ¨ä¸‹ä¸€æ­¥æŠŠäº‹ä»¶åˆ†å‘ç»™å®ƒ
                if (newTouchTarget == null &amp;&amp; mFirstTouchTarget != null) {
                    newTouchTarget = mFirstTouchTarget;
                    while (newTouchTarget.next != null) {
                        newTouchTarget = newTouchTarget.next;
                    }
                }
            }
        }
        return handled;
    }

    private boolean dispatchTransformedTouchEvent(MotionEvent event, boolean cancel,View child, int desiredPointerIdBits) {
        boolean handled;
        if (child == null) {
            handled = super.dispatchTouchEvent(event); // ViewGroup ç»§æ‰¿è‡ª View ï¼Œè¿™é‡Œè°ƒç”¨çš„æ˜¯ View#dispatchTouchEvent()
        } else {
            handled = child.dispatchTouchEvent(event);
        }
        return handled;
    }

}
</code></pre>
<p>åˆ†å‘çš„è¿‡ç¨‹æ˜¯å°†æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„å­ View éƒ½è¯¢é—®ä¸€é</p>
<p>åœ¨ä¸Šé¢è¿™æ®µä»£ç ä¸­ï¼Œä½¿ç”¨ <code>for</code> å¾ªç¯éå†æ‰€æœ‰çš„å­ View ï¼Œæ£€æŸ¥æ¯ä¸ªå­ View æ˜¯å¦åœ¨è§¦æ‘¸åŒºåŸŸï¼Œæ˜¯å¦å¯ä»¥è¢«è§¦æ‘¸ç­‰ç­‰</p>
<p>å¦‚æœæ‰¾åˆ°åˆé€‚çš„å­ View ï¼Œè°ƒç”¨ <code>dispatchTransformedTouchEvent()</code> æ‰§è¡Œåˆ†å‘ï¼Œå¹¶è®°å½•æ¶ˆè´¹çš„ç»“æœ</p>
<p>æ‰€æœ‰çš„å­ View éå†ä¸€éåï¼Œå¦‚æœå‘ç°æ²¡æœ‰æ¶ˆè´¹çš„è§†å›¾ï¼Œå¹¶ä¸”ï¼Œå½“å‰ <code>mFirstTouchTarget</code> ä¸ä¸ºç©ºï¼Œé‚£ç›´æ¥å°†ä¿ç•™ç€ä¸Šä¸€æ¬¡æ¶ˆè´¹çš„ View æœ€è¿‘çš„ä¸€ä¸ª <code>TouchTarget</code> æ‹¿å‡ºæ¥ï¼Œç­‰å¾…ä¸‹ä¸€æ­¥æ‰§è¡Œ</p>
<h3 id="4-äº‹ä»¶çš„æ¶ˆè´¹">4ã€äº‹ä»¶çš„æ¶ˆè´¹</h3>
<p>äº‹ä»¶çš„æ¶ˆè´¹ä»£ç æ¯”è¾ƒç®€å•ï¼š</p>
<pre><code class="language-java">/frameworks/base/core/java/android/view/ViewGroup.java
class ViewGroup extends View {

    public boolean dispatchTouchEvent(MotionEvent ev) {
      	...
        // è·‘åˆ°è¿™ï¼Œå¦‚æœ mFirstTouchTarget è¿˜æ˜¯ä¸ºç©º ï¼Œè¡¨ç¤ºè¿™ä¸ªäº‹ä»¶ ViewGroup è‡ªèº«è¦æ¶ˆè´¹
        if (mFirstTouchTarget == null) {
            handled = dispatchTransformedTouchEvent(ev,canceled,null,TouchTarget.ALL_POINTER_IDS);
        } else {
            TouchTarget target = mFirstTouchTarget;
            // éå† TouchTarget é“¾è¡¨ï¼Œæ‰§è¡Œäº‹ä»¶åˆ†å‘ï¼Œä»£ç æœ‰å»é‡æ“ä½œï¼Œè¢«æˆ‘åˆ äº†ï¼Œå³ä¹‹å‰åˆ†å‘è¿‡çš„æ–°æ·»åŠ çš„èŠ‚ç‚¹ï¼Œä¸å†æ‰§è¡Œåˆ†å‘
            while (target != null) {
                final TouchTarget next = target.next;
                if (dispatchTransformedTouchEvent(ev, cancelChild,target.child, target.pointerIdBits)) {
                    handled = true;
                }
                target = next;
            }
        }
        return handled;
    }

    private boolean dispatchTransformedTouchEvent(MotionEvent event, boolean cancel,View child, int desiredPointerIdBits) {
        boolean handled;
        if (child == null) {
            handled = super.dispatchTouchEvent(event); // ViewGroup ç»§æ‰¿è‡ª View ï¼Œè¿™é‡Œè°ƒç”¨çš„æ˜¯ View#dispatchTouchEvent()
        } else {
            handled = child.dispatchTouchEvent(event);
        }
        return handled;
    }

}
</code></pre>
<p>å¦‚æœ <code>mFirstTouchTarget</code> ä¸ºç©º ï¼Œè¡¨ç¤ºè¿™ä¸ªäº‹ä»¶ ViewGroup è‡ªèº«è¦æ¶ˆè´¹ï¼Œè°ƒç”¨ <code>dispatchTransformedTouchEvent()</code> æ–¹æ³•</p>
<p>åœ¨ <code>dispatchTransformedTouchEvent()</code> æ–¹æ³•ä¸­ï¼Œå¦‚æœ child å‚æ•°ä¸ºç©ºï¼Œè¡¨ç¤ºæ˜¯ ViewGroup è¦æ¶ˆè´¹ï¼Œé‚£ä¹ˆè°ƒç”¨ ViewGroup çš„çˆ¶ç±»ï¼š <code>View#dispatchTouchEvent()</code></p>
<p><code>dispatchTouchEvent()</code> æ–¹æ³•æœ€ç»ˆæŠŠäº‹ä»¶ä¼ é€’ç»™ <code>onTouchEvent()</code> ï¼Œæˆ‘ä»¬é©¬ä¸Šå°±èƒ½çœ‹åˆ° View çš„æ¶ˆè´¹æµç¨‹äº†</p>
<p>å¦‚æœ <code>mFirstTouchTarget</code> å¯¹è±¡ä¸ä¸ºç©ºï¼Œè¯´æ˜æœ‰å…¶ä»–å­ View æ¶ˆè´¹äº†äº‹ä»¶ï¼ˆå¯èƒ½æœ‰å¤šä¸ªï¼‰ï¼Œä¾æ—§è°ƒç”¨ <code>dispatchTransformedTouchEvent()</code> æ‰§è¡Œåˆ†å‘</p>
<p>å¥½äº†ï¼ŒViewGroup çš„ <code>æ¶ˆè´¹</code>ã€<code>åˆ†å‘</code>ã€<code>æ‹¦æˆª</code>ä¸<code>æ”¾è¡Œ</code>ï¼Œåˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ <code>View#dispatchTouchEvent()</code> çš„æµç¨‹</p>
<h2 id="view-çš„æ¶ˆè´¹">View çš„æ¶ˆè´¹</h2>
<p>èŠå®Œäº† ViewGroup å¯¹è§¦æ‘¸äº‹ä»¶çš„å¤„ç†ï¼Œæˆ‘ä»¬æ¥ç€æ¥èŠ View è¿™è¾¹æ˜¯æ€ä¹ˆå¤„ç†è§¦æ‘¸äº‹ä»¶çš„</p>
<p>åœ¨ä¸Šä¸€èŠ‚çš„ <code>dispatchTransformedTouchEvent()</code> æ–¹æ³•ä¸­ï¼Œæ— è®ºæ‰§è¡Œçš„æ˜¯ <code>super.dispatchTouchEvent(event)</code> æ–¹æ³•ï¼Œè¿˜æ˜¯ <code>child.dispatchTouchEvent(event)</code> æ–¹æ³•ï¼Œæœ€ç»ˆéƒ½æ˜¯è°ƒç”¨åˆ° <code>View#dispatchTouchEvent()</code> ä¸­</p>
<p><code>View#dispatchTouchEvent()</code> é€»è¾‘æ¯”è¾ƒå°‘ï¼Œé‡è¦ä»£ç åªæœ‰ä¸€å¥ï¼Œè°ƒç”¨äº† <code>onTouchEvent()</code> æ¶ˆè´¹äº‹ä»¶ï¼Œé™¤æ­¤ä¹‹å¤– View çš„äº‹ä»¶åˆ†å‘å°±æ²¡ä»€ä¹ˆå¥½èŠçš„äº†</p>
<pre><code class="language-java">//frameworks/base/core/java/android/view/View.java
class View {

    public boolean dispatchTouchEvent(MotionEvent event) {
        boolean result = onTouchEvent(event);
        return result;
    }

    public boolean onTouchEvent(MotionEvent event) {
        return false;
    }
}
</code></pre>
<p>å¥½äº†ï¼ŒView / ViewGroup çš„äº‹ä»¶åˆ†å‘åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œå½“ç„¶æˆ‘ä»¬çœ‹åˆ°çš„æ˜¯éå¸¸ç²¾ç®€çš„ç‰ˆæœ¬äº†ï¼Œåªæœ‰ä¸‰ä¸¤ä¸ªå…³é”®å‡½æ•°ï¼Œå¹¶ä¸”å‡ ä¹æ²¡æœ‰ä»»ä½•ç»†èŠ‚</p>
<p>å› ä¸º View / ViewGroup çš„äº‹ä»¶åˆ†å‘æ¯”è¾ƒç®€å•ï¼Œä¸åƒ Framework çš„é€»è¾‘ï¼Œç»•æ¥ç»•å»çš„ï¼Œäº‹ä»¶åˆ†å‘çš„é€»è¾‘å¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨å†…éƒ¨åšè·³è½¬ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹è‡ªå·±å»è·Ÿä¸€éæºç å¾ˆå¿«å°±äº†è§£æ¸…æ¥šäº†</p>
<h1 id="å››-ç»“è¯­">å››ã€ç»“è¯­</h1>
<p>æœ¬ç¯‡æ–‡ç« ç¨å¾®æœ‰ç‚¹é•¿ï¼Œä»ç¡¬ä»¶é©±åŠ¨ï¼Œç³»ç»Ÿå†…æ ¸ï¼Œåˆ° Framework éƒ½æœ‰æ¶‰åŠã€‚å…¶ä¸­ï¼Œäº†è§£ IMS çš„å®ç°åŸç†ï¼ŒAPP å’Œ IMS é€šä¿¡çš„å»ºç«‹ï¼Œä»¥åŠ ViewGroup çš„ <code>dispatchTouchEvent()</code> æ–¹æ³•çš„äº‹ä»¶æ´¾å‘é€»è¾‘ï¼Œæ˜¯æœ¬ç¯‡æ–‡ç« æ¯”è¾ƒé‡è¦çš„å†…å®¹</p>
<p>åœ¨æ–‡ç« çš„æœ€åï¼Œæˆ‘ä»¬ç”¨å¼ å¤§ä¼Ÿè€å¸ˆ<a href="https://book.douban.com/subject/26598458/">ã€Šæ·±å…¥ç†è§£Android å·IIIã€‹</a>ä¹¦ä¸­çš„ä¸€æ®µè¯ä½œä¸ºæœ¬æ–‡æ€»ç»“ï¼š</p>
<p>ç®€å•æ¥è¯´ï¼Œå†…æ ¸å°†åŸå§‹äº‹ä»¶å†™å…¥åˆ°è®¾å¤‡æ–‡ä»¶ä¸­ï¼ŒInputReader ä¸æ–­åœ°é€šè¿‡ EventHub å°†åŸå§‹äº‹ä»¶å–å‡ºæ¥ï¼Œè§£æåŠ å·¥æˆ KeyEventã€MotionEvent äº‹ä»¶ï¼Œç„¶åäº¤ç»™ InputDispatcher</p>
<p>InputDispatcher æ ¹æ® WMS æä¾›çš„çª—å£ä¿¡æ¯å°†äº‹ä»¶äº¤ç»™åˆé€‚çš„çª—å£</p>
<p>æ¥ç€ï¼Œçª—å£çš„ ViewRootImpl å¯¹è±¡å†æ²¿ç€æ§ä»¶æ ‘å°†äº‹ä»¶æ´¾å‘ç»™æ„Ÿå…´è¶£çš„æ§ä»¶ï¼Œæ§ä»¶å¯¹å…¶æ”¶åˆ°çš„äº‹ä»¶ä½œå‡ºå“åº”ï¼Œæ›´æ–°è‡ªå·±çš„ç”»é¢ã€æ‰§è¡Œç‰¹å®šçš„åŠ¨ä½œ</p>
<p>æ‰€æœ‰è¿™äº›å‚ä¸è€…ä»¥ IMS ä¸ºæ ¸å¿ƒï¼Œæ„å»ºäº† Android åºå¤§è€Œå¤æ‚çš„è¾“å…¥ä½“ç³»ã€‚</p>
<p>å¥½äº†ï¼Œæœ¬ç¯‡æ–‡ç« åˆ°è¿™é‡Œå°±å…¨éƒ¨ç»“æŸäº†ã€‚æ–‡ä¸­æåˆ°çš„ç¡¬ä»¶é©±åŠ¨å’Œç³»ç»Ÿå†…æ ¸è¿™ä¸¤å—æš‚æ—¶è¿˜ä¸æ˜¯æˆ‘æ“…é•¿çš„é¢†åŸŸï¼Œæ‰€ä»¥å¦‚æœå„ä½å¤§ä½¬å‘ç°æœ¬æ–‡æœ‰å†™çš„ä¸å¯¹çš„åœ°æ–¹ï¼Œè¿˜æœ›åŠæ—¶æŒ‡å‡ºï¼Œæˆ‘ä¼šç¬¬ä¸€æ—¶é—´æ”¹æ­£ï¼Œæ„Ÿè°¢</p>
<p>å¦å¤–ï¼Œæ¬¢è¿å„ä½å¤§ä½¬ç»™æˆ‘ç•™è¨€ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥æ¢è®¨æŠ€æœ¯é—®é¢˜</p>
<p><strong>å…¨æ–‡å®Œ</strong></p>
<h1 id="äº”-å‚è€ƒèµ„æ–™">äº”ã€å‚è€ƒèµ„æ–™</h1>
<ul>
<li><a href="https://book.douban.com/subject/26598458/">ã€Šæ·±å…¥ç†è§£Android å·III - å¼ å¤§ä¼Ÿã€‹</a></li>
<li><a href="https://rohm.eefocus.com/article/id-317">ç”µé˜»å±å·²ç»è¢«æ™ºèƒ½æ‰‹æœºæŠ›å¼ƒï¼Œè¿˜æœ‰å“ªäº›åº”ç”¨åœºæ™¯ï¼Ÿ</a></li>
<li><a href="https://blog.csdn.net/weixin_51554164/article/details/124965131">æ‰‹æœºå…¨è´´åˆå±å¹•æŠ€æœ¯è§£æ</a></li>
<li><a href="https://blog.csdn.net/qq_39797956/article/details/118863217">ã€Linuxé©±åŠ¨ã€‘I2Cå­ç³»ç»Ÿä¸è§¦æ‘¸å±é©±åŠ¨ - @hongZ</a></li>
<li><a href="https://blog.csdn.net/qq_39797956/article/details/117898095">ã€Linuxé©±åŠ¨ã€‘inputå­ç³»ç»Ÿä¸æŒ‰é”®é©±åŠ¨ - @hongZ</a></li>
<li><a href="https://blog.csdn.net/Chuangke_Andy/article/details/122181549">Linuxé©±åŠ¨å¼€å‘|inputå­ç³»ç»Ÿ - å®‰è¿ªè¥¿</a></li>
<li><a href="https://paper.seebug.org/779/">ä» 0 å¼€å§‹å­¦ Linux é©±åŠ¨å¼€å‘ - Hcamael</a></li>
<li><a href="http://huaqianlee.github.io/2017/11/23/Android/Android-Linux-input-system-analysis/">Android(Linux) è¾“å…¥å­ç³»ç»Ÿè§£æ - Andy Lee</a></li>
<li><a href="https://dqdongg.com/c/touch/android/2014/07/10/Touch-inputevent.html">Android å¦‚ä½•ä¸ŠæŠ¥ Touchevent ç»™åº”ç”¨å±‚ - è‘£åˆš</a></li>
<li><a href="https://juejin.cn/post/6925336861137174541">è¿™ä¸€æ¬¡ï¼Œå¸¦ä½ å½»åº•å¼„æ‡‚ Android äº‹ä»¶åˆ†å‘æœºåˆ¶(å¤–/å†…å±‚è´£ä»»é“¾) - ä¼¤å¿ƒçš„çŒªå¤§è‚ </a></li>
<li><a href="https://www.viseator.com/2017/09/14/android_view_event_1/">Android è§¦æ‘¸äº‹ä»¶åˆ†å‘æœºåˆ¶ï¼ˆä¸€ï¼‰ä»å†…æ ¸åˆ°åº”ç”¨ ä¸€åˆ‡çš„å¼€å§‹ - å´è¿ª</a></li>
<li><a href="https://www.viseator.com/2017/10/07/android_view_event_2/">Android è§¦æ‘¸äº‹ä»¶åˆ†å‘æœºåˆ¶ï¼ˆäºŒï¼‰åŸå§‹äº‹ä»¶æ¶ˆæ¯ä¼ é€’ä¸åˆ†å‘çš„å¼€å§‹ - å´è¿ª</a></li>
<li><a href="https://juejin.cn/post/6920883974952714247">Androidäº‹ä»¶åˆ†å‘æœºåˆ¶äºŒï¼šæ ¸å¿ƒåˆ†å‘é€»è¾‘æºç è§£æ - ä¸€åªä¿®ä»™çš„çŒ¿</a></li>
<li><a href="https://xianzhu21.space/developer/inputchannel_inputdispatcher">InputChannel and InputDispatcher in Android</a></li>
</ul>

                </div>
            </article>
        </div>

        
            <div class="next-post">
                <div class="next gt-c-content-color-first">ä¸‹ä¸€ç¯‡</div>
                <a href="https://yibaoshan.github.io/post/book-notes-computers-microcomputer-8051/" class="post-title gt-a-link">
                    è¯»ä¹¦ç¬”è®°ï¼šåå¤©å­¦ä¼š51å•ç‰‡æœº
                </a>
            </div>
        

        

        

        

        <div class="site-footer gt-c-content-color-first">
    <div class="slogan gt-c-content-color-first"></div>
    <div class="social-container">
        
            
                <a href="https://github.com/yibaoshan" target="_blank">
                    <i class="fab fa-github gt-c-content-color-first"></i>
                </a>
            
        
            
        
            
        
            
                <a href="https://www.zhihu.com/people/yibaoshan?theme=dark" target="_blank">
                    <i class="fab fa-zhihu gt-c-content-color-first"></i>
                </a>
            
        
            
        
            
        
    </div>
    <div class="footer-info">
        
    </div>
    <div>
        Theme <a href="https://github.com/imhanjie/gridea-theme-pure" target="_blank">Pure</a>, Powered by <a
                href="https://gridea.dev" target="_blank">Gridea</a> | <a href="https://yibaoshan.github.io//atom.xml" target="_blank">RSS</a>
    </div>
</div>

<script>
  hljs.highlightAll()
</script>

    </div>
</div>
</body>
</html>
